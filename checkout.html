<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide｜結帳</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#f4f6fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --brand:#2563eb; --danger:#b91c1c; --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);
      font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif}
    .wrap{max-width:980px;margin:28px auto;padding:0 18px}
    h1{margin:0 0 16px;font-size:36px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:18px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);
      border-radius:var(--radius);padding:20px}
    .plan{border:1px solid var(--line);border-radius:14px;
      padding:14px 16px;margin:10px 0;display:flex;
      justify-content:space-between;cursor:pointer}
    .plan.active{outline:2px solid rgba(37,99,235,.35)}
    .muted{color:var(--muted)}
    input{width:100%;padding:12px 14px;border-radius:12px;
      border:1px solid var(--line);font-size:16px}
    .btn{border:0;border-radius:999px;padding:12px 18px;
      font-size:16px;cursor:pointer}
    .btn.primary{background:var(--brand);color:#fff}
    .btn.ghost{background:#fff;border:1px solid var(--line)}
    .err{margin-top:14px;color:var(--danger);font-weight:600}
  </style>
</head>

<body>
<div class="wrap">
  <h1>BookWide 結帳</h1>

  <div class="grid">
    <div class="card">
      <div class="muted">選擇方案</div>

      <div class="plan active" data-plan="month">
        <div>月方案</div><div>NT$ 1,000</div>
      </div>
      <div class="plan" data-plan="half">
        <div>半年方案</div><div>NT$ 5,400</div>
      </div>
      <div class="plan" data-plan="year">
        <div>一年方案</div><div>NT$ 9,600</div>
      </div>

      <div style="margin-top:16px">
        <div class="muted">推薦碼（選填）</div>
        <input id="referralCode" placeholder="例如 62754" />
      </div>

      <div style="margin-top:18px;display:flex;gap:10px">
        <button class="btn primary" id="payBtn">前往綠界付款</button>
        <button class="btn ghost" onclick="location.reload()">重整</button>
      </div>

      <div id="err" class="err"></div>
    </div>

    <div class="card">
      <div class="muted">本次應付</div>
      <h2 id="price">NT$ 1,000</h2>
      <div class="muted">付款完成後由綠界回呼自動開通</div>
    </div>
  </div>
</div>

<script>
/* ================= Supabase 設定 ================= */

const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";

const supabase = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* ================= 狀態 ================= */

let plan = "month";
const priceMap = { month:1000, half:5400, year:9600 };

/* ================= UI ================= */

document.querySelectorAll(".plan").forEach(el=>{
  el.onclick = () => {
    document.querySelectorAll(".plan").forEach(p=>p.classList.remove("active"));
    el.classList.add("active");
    plan = el.dataset.plan;
    document.getElementById("price").innerText =
      "NT$ " + priceMap[plan].toLocaleString();
  };
});

/* ================= 付款 ================= */

document.getElementById("payBtn").onclick = async () => {
  const errBox = document.getElementById("err");
  errBox.innerText = "";

  try {
    // 1) 取得登入使用者
    const { data:{ user }, error: uErr } = await supabase.auth.getUser();
    if (uErr || !user?.id) {
      errBox.innerText = "請先登入再付款";
      return;
    }

    // 2) 取得 JWT
    const { data:{ session }, error: sErr } = await supabase.auth.getSession();
    if (sErr || !session?.access_token) {
      errBox.innerText = "登入狀態失效，請重新登入";
      return;
    }

    const referral_code =
      document.getElementById("referralCode").value.trim() || null;

    // 3) 直接用 fetch（一定帶 Authorization）
    const resp = await fetch(
      SUPABASE_URL + "/functions/v1/create-ecpay-order",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + session.access_token
        },
        body: JSON.stringify({
          user_id: user.id,
          period: plan,
          referral_code
        })
      }
    );

    const text = await resp.text();
    if (!resp.ok) {
      errBox.innerText = "付款建立失敗（" + resp.status + "）：\n" + text;
      return;
    }

    const data = JSON.parse(text);
    if (!data.html) {
      errBox.innerText = "付款建立失敗：回傳缺少 html";
      return;
    }

    // 4) 綠界自動送出
    const w = window.open("", "_self");
    w.document.write(data.html);
    w.document.close();

  } catch (e) {
    errBox.innerText = "付款建立失敗：" + (e.message || e);
  }
};
</script>

</body>
</html>
























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































