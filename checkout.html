<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide｜結帳</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#f4f6fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --brand:#2563eb; --danger:#b91c1c; --ok:#065f46;
      --radius:18px; --shadow:0 10px 30px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif}
    a{color:inherit;text-decoration:none}
    header{position:sticky;top:0;z-index:10;background:rgba(244,246,251,.92);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid var(--line)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .pill{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;display:inline-flex;gap:8px;align-items:center}
    .btn{border:0;border-radius:999px;padding:12px 18px;background:#111827;color:#fff;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--ink);border:1px solid var(--line)}
    .btn.brand{background:var(--brand)}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:1.25fr .75fr;gap:16px;margin-top:16px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    .h1{font-size:34px;margin:10px 0 4px}
    .muted{color:var(--muted)}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .k{color:var(--muted);min-width:90px}
    .v{font-weight:800}
    .plans{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .plan{border:1px solid var(--line);border-radius:14px;padding:14px 16px;background:#fff;cursor:pointer}
    .plan.active{border-color:var(--brand);box-shadow:0 0 0 3px rgba(37,99,235,.12)}
    .planTop{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .planName{font-weight:900}
    .planPrice{font-weight:900;font-size:26px;letter-spacing:.2px}
    .hr{height:1px;background:var(--line);margin:14px 0}
    .msg{margin-top:10px;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;white-space:pre-wrap;word-break:break-word}
    .msg.err{border-color:rgba(185,28,28,.25);background:rgba(185,28,28,.06);color:var(--danger)}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;color:var(--muted);font-size:12px}
    .payBoxTitle{font-weight:900;font-size:22px;margin:0 0 8px}
    .payAmount{font-weight:1000;font-size:44px;letter-spacing:.5px}
    .kv{display:grid;grid-template-columns:auto 1fr;gap:8px 10px;margin-top:12px}
    .kv .kk{color:var(--muted)}
    .kv .vv{text-align:right;font-weight:800}
    footer{padding:28px 0;color:var(--muted);text-align:center}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <a class="pill" href="/index.html">← 回首頁</a>
      <div class="pill" id="who">未登入</div>
      <a class="pill" href="/account/subscription.html">我的訂閱 →</a>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="h1">結帳</div>
  <div class="muted">付款金額以後端 create-ecpay-order 計算為準</div>

  <div class="grid">
    <!-- LEFT -->
    <section class="card">
      <div class="row">
        <div class="k">課程：</div>
        <div class="v" id="topicsText">-</div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="k">方案：</div>
        <div class="v" id="planText">-</div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="k">推薦碼：</div>
        <div class="v" id="refText">—</div>
      </div>

      <div class="hr"></div>

      <div class="plans" id="plans">
        <div class="plan" data-plan="month">
          <div class="planTop">
            <div class="planName">月方案</div>
            <div class="planPrice">NT$ 1,000</div>
          </div>
        </div>
        <div class="plan" data-plan="half">
          <div class="planTop">
            <div class="planName">半年方案</div>
            <div class="planPrice">NT$ 5,400</div>
          </div>
        </div>
        <div class="plan" data-plan="year">
          <div class="planTop">
            <div class="planName">一年方案</div>
            <div class="planPrice">NT$ 9,600</div>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <button class="btn brand" id="btnPay">綠界付款</button>
        <button class="btn secondary" id="btnLogin" style="display:none">前往登入</button>
        <a class="btn secondary" href="javascript:history.back()">返回上一頁</a>
      </div>

      <div id="msg" class="msg err" style="display:none"></div>
    </section>

    <!-- RIGHT -->
    <aside class="card">
      <div class="payBoxTitle">本次應付</div>
      <div class="payAmount" id="payText">—</div>

      <div class="hr"></div>

      <div class="muted" style="display:flex;flex-direction:column;gap:8px">
        <div>• 金額含推薦折扣（若有）</div>
        <div>• 金額會 100% 送到綠界 TotalAmount</div>
      </div>

      <div class="kv">
        <div class="kk">原價</div><div class="vv" id="origText">—</div>
        <div class="kk">折扣</div><div class="vv" id="discText">—</div>
        <div class="kk">期間</div><div class="vv" id="periodText">—</div>
      </div>
    </aside>
  </div>

  <footer>BookWide © 2025</footer>
</main>

<script>
  // ===== 固定參數（你這專案的）=====
  const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
  const FN_CREATE = `${SUPABASE_URL}/functions/v1/create-ecpay-order`;

  // 建議加上 detectSessionInUrl + persistSession，避免你現在這種「看起來沒登入」噩夢
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
  });

  const $ = (id)=>document.getElementById(id);
  const msgBox = $("msg");

  const PRICE_NT = { month: 1000, half: 5400, year: 9600 };

  function showErr(t){
    msgBox.style.display = "block";
    msgBox.textContent = t;
  }
  function hideErr(){ msgBox.style.display = "none"; msgBox.textContent=""; }

  function parseQuery(){
    const u = new URL(location.href);
    const topics = (u.searchParams.get("topics") || "")
      .split(",")
      .map(s=>decodeURIComponent(s))
      .map(s=>s.trim())
      .filter(Boolean);

    let plan = (u.searchParams.get("plan") || "month").trim().toLowerCase();
    if (plan === "monthly") plan = "month";
    if (plan === "semi") plan = "half";
    if (plan === "yearly") plan = "year";
    if (!["month","half","year"].includes(plan)) plan = "month";

    const ref = (u.searchParams.get("ref") || "").trim();
    return { topics: (topics.length ? topics : ["story","music","movie","news","pro"]), plan, ref };
  }

  function setActivePlan(plan){
    document.querySelectorAll(".plan").forEach(el=>{
      el.classList.toggle("active", el.dataset.plan === plan);
    });
    $("planText").textContent = plan==="half" ? "半年方案" : plan==="year" ? "一年方案" : "月方案";
    $("periodText").textContent = plan;

    // 右側顯示（僅 UI 參考；實際金額仍以後端為準）
    const base = PRICE_NT[plan] ?? 1000;
    const q = parseQuery();
    const hasRef = !!q.ref;
    const disc = hasRef ? Math.round(base * 0.1) : 0;
    const pay = base - disc;
    $("origText").textContent = `NT$ ${base.toLocaleString()}`;
    $("discText").textContent = disc ? `- NT$ ${disc.toLocaleString()}` : `NT$ 0`;
    $("payText").textContent = `NT$ ${pay.toLocaleString()}`;
  }

  async function refreshAuthUI(){
    const { data } = await sb.auth.getSession();
    const session = data?.session || null;
    const user = session?.user || null;

    if (user?.id){
      $("who").textContent = (user.email || "已登入") + " · " + user.id.slice(0,8);
      $("btnPay").disabled = false;
      $("btnLogin").style.display = "none";
      hideErr();
      return { user, token: session.access_token };
    }

    $("who").textContent = "未登入";
    $("btnPay").disabled = true;
    $("btnLogin").style.display = "inline-flex";
    showErr("請先登入後再付款");
    return { user: null, token: null };
  }

  function goLogin(){
    // 你首頁自己有 login 區塊就用 #login；順便帶 next 回來
    const next = encodeURIComponent(location.pathname + location.search);
    location.href = `/index.html#login?next=${next}`;
  }

  async function callCreate(payload, token){
    const res = await fetch(FN_CREATE, {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        "Authorization": token ? ("Bearer " + token) : ""
      },
      body: JSON.stringify(payload),
    });
    const json = await res.json().catch(()=> ({}));
    if (!res.ok || !json?.ok) throw new Error(json?.message || `create-ecpay-order failed (${res.status})`);
    return json;
  }

  function submitReturnedHtml(html){
    document.open();
    document.write(html);
    document.close();
  }

  (async function main(){
    const q = parseQuery();

    $("topicsText").textContent = q.topics.join(", ");
    $("refText").textContent = q.ref || "—";
    setActivePlan(q.plan);

    $("plans").addEventListener("click", (e)=>{
      const el = e.target.closest(".plan");
      if (!el) return;
      const p = el.dataset.plan;
      const u = new URL(location.href);
      u.searchParams.set("plan", p);
      history.replaceState({}, "", u.toString());
      setActivePlan(p);
    });

    $("btnLogin").addEventListener("click", goLogin);

    // 一進來就同步登入狀態（避免你看到「未登入」）
    let authState = await refreshAuthUI();

    // 登入狀態變動即時更新
    sb.auth.onAuthStateChange(async ()=>{
      authState = await refreshAuthUI();
    });

    $("btnPay").addEventListener("click", async ()=>{
      try{
        hideErr();
        $("btnPay").disabled = true;

        // 再抓一次 session，避免你剛登入但畫面還沒更新
        authState = await refreshAuthUI();
        if (!authState.user?.id) throw new Error("請先登入後再付款");

        const q2 = parseQuery();
        const payload = {
          user_id: authState.user.id,
          email: authState.user.email || "",
          period: q2.plan,            // month/half/year
          items: q2.topics,
          referral_code: q2.ref || null
        };

        const out = await callCreate(payload, authState.token);
        submitReturnedHtml(out.html);

      }catch(err){
        showErr(String(err?.message || err));
      }finally{
        $("btnPay").disabled = false;
      }
    });

  })();
</script>
</body>
</html>



























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































