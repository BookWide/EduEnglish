<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide | 結帳</title>
  <style>
    :root{--bg:#fff;--text:#111;--muted:#6b7280;--panel:#fff;--border:#e5e7eb;--btn:#111;--btnText:#fff;--chip:#111;--chipText:#fff}
    html,body{background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue","Noto Sans","Microsoft JhengHei",Arial,sans-serif;margin:0}
    .wrap{max-width:960px;margin:28px auto;padding:0 16px}
    a{color:#2563eb;text-decoration:none}
    h1{font-size:30px;margin:10px 0 18px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:20px}
    .row{display:flex;align-items:center;justify-content:space-between;padding:14px 0;border-bottom:1px solid var(--border)}
    .row:last-child{border-bottom:0}
    .muted{color:var(--muted)}
    .chip{background:var(--chip);color:var(--chipText);padding:6px 10px;border-radius:999px;font-size:12px}
    .price{min-width:90px;text-align:right}
    .total{font-size:22px;font-weight:700}
    .btn{width:100%;margin-top:18px;padding:16px 18px;background:var(--btn);color:var(--btnText);border:0;border-radius:10px;font-weight:700;cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <a href="./pricing.html" class="muted">← 返回方案與定價</a>
    <h1>訂單摘要</h1>
    <div class="card">
      <div class="row"><div class="muted">週期：</div><div id="periodLabel" class="chip">月</div></div>
      <div class="row"><div class="muted">方案：</div><div id="itemsPills"></div></div>
      <div class="row"><div class="muted">推薦碼：</div><div id="refLabel" class="muted">無推薦碼</div></div>
      <div id="lineItems"></div>
      <div class="row"><div class="muted">小計</div><div id="subtotal" class="price">$0</div></div>
      <div class="row" id="rowDiscount" style="display:none"><div class="muted">折扣</div><div id="discount" class="price">-$0</div></div>
      <div class="row"><div class="muted">稅額(0%)</div><div id="tax" class="price">$0</div></div>
      <div class="row"><div class="total">應付金額</div><div id="grand" class="total price">$0</div></div>
      <button class="btn" id="btnPay">確認付款</button>
    </div>
  </div>

  <script>
  // 與 pricing 相同的推薦碼存取
  const REF_KEY='referral_v1';
  function getRef() {
    const usp=new URLSearchParams(location.search);
    const urlRef=usp.get('ref');
    if (urlRef) {
      const d={code:urlRef,ts:Date.now(),ttl:30*24*60*60*1000};
      localStorage.setItem(REF_KEY,JSON.stringify(d));
      sessionStorage.setItem(REF_KEY,JSON.stringify(d));
      return urlRef;
    }
    try{const s=sessionStorage.getItem(REF_KEY);if(s){const o=JSON.parse(s)||{};if(o.code)return o.code;}}catch{}
    try{const s=localStorage.getItem(REF_KEY);if(!s)return'';const o=JSON.parse(s)||{};if(!o.code)return'';if((o.ts||0)+(o.ttl||0)<Date.now()){localStorage.removeItem(REF_KEY);return'';}return o.code;}catch{return'';}
  }

  const UNIT={month:200,half:960,year:1680};
  const PERIOD_TEXT={month:'月',half:'半年',year:'年'};
  const DISCOUNT=0.9; // 9折

  // DOM
  const elPeriod=document.getElementById('periodLabel');
  const elItems=document.getElementById('itemsPills');
  const elRef=document.getElementById('refLabel');
  const elLines=document.getElementById('lineItems');
  const elSub=document.getElementById('subtotal');
  const elRowDis=document.getElementById('rowDiscount');
  const elDis=document.getElementById('discount');
  const elTax=document.getElementById('tax');
  const elGrand=document.getElementById('grand');
  const btn=document.getElementById('btnPay');

  (function init(){
    const usp=new URLSearchParams(location.search);
    const items=(usp.get('items')||'').split(',').map(s=>s.trim()).filter(Boolean);
    const period=usp.get('period')||'month';
    if(!items.length){location.replace('./pricing.html');return;}
    elPeriod.textContent=PERIOD_TEXT[period]||'月';

    elItems.innerHTML='';
    items.forEach(it=>{
      const s=document.createElement('span');s.className='chip';s.style.marginLeft='6px';s.textContent=it;elItems.appendChild(s);
    });

    // 推薦碼
    const ref=getRef();
    if(ref){elRef.textContent=ref;elRef.classList.remove('muted');elRef.classList.add('chip');}
    // 列明細
    const unit=UNIT[period]??UNIT.month;
    elLines.innerHTML='';
    items.forEach(it=>{
      const row=document.createElement('div');row.className='row';
      row.innerHTML=`<div>${it}</div><div class="price">$${unit}</div>`;
      elLines.appendChild(row);
    });
    // 金額
    const subtotal=unit*items.length;
    let discount=0;
    if(ref){const after=Math.round(subtotal*DISCOUNT);discount=subtotal-after;elRowDis.style.display='';elDis.textContent=`-$${discount}`;}
    elSub.textContent=`$${subtotal}`;
    elTax.textContent='$0';
    elGrand.textContent=`$${subtotal-discount}`;

    // 付款串接（保留範例）
    btn.addEventListener('click',async()=>{
      alert('示意：確認付款（若要直接串接綠界，這裡呼叫你的 Edge Function）。');
      // const SUPABASE_URL='https://<YOUR>.supabase.co';
      // const body={items,period,subtotal,discount,total:subtotal-discount,referral_code:ref||null};
      // const r=await fetch(`${SUPABASE_URL}/functions/v1/create-ecpay-order`,{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(body)});
      // const data=await r.json();
      // if(data?.ecpay_url) location.href=data.ecpay_url; else alert('建立訂單失敗');
    });
  })();
  </script>
</body>
</html>

