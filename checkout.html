<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>訂單摘要</title>
  <style>
    :root{--text:#111;--muted:#6b7280;--border:#e5e7eb;}
    body{margin:0;background:#fff;color:var(--text);font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans TC','Microsoft JhengHei',sans-serif}
    .wrap{max-width:980px;margin:28px auto;padding:0 16px}
    a.back{display:inline-block;color:#7c3aed;text-decoration:none;margin-bottom:12px}
    h1{font-size:40px;margin:6px 0 16px}
    .card{border:1px solid var(--border);border-radius:16px;padding:16px}
    .row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)}
    .row:last-child{border-bottom:none}
    .chip{background:#111;border-radius:999px;color:#fff;padding:6px 10px;font-weight:700}
    .muted{color:var(--muted)}
    .price{min-width:90px;text-align:right}
    .btn{display:block;width:100%;background:#111;color:#fff;border:none;border-radius:12px;padding:16px 14px;margin-top:16px;font-weight:700;cursor:pointer}
    .hidden{display:none !important}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <a class="back" href="./pricing.html">← 返回方案與定價</a>
    <h1>訂單摘要</h1>

    <div class="card">
      <div class="row"><div class="muted">週期：</div><div id="periodLabel" class="chip">月</div></div>
      <div class="row"><div class="muted">方案：</div><div id="itemsChips"></div></div>
      <div class="row" id="refRow"><div class="muted">推薦碼：</div><div id="refLabel" class="muted">無</div></div>
      <div id="lineItems"></div>
      <div class="row"><div class="muted">小計</div><div id="subtotal" class="price">$0</div></div>
      <div class="row hidden" id="rowDiscount"><div class="muted">折扣</div><div id="discount" class="price">-$0</div></div>
      <div class="row"><div class="muted">稅額（0%）</div><div class="price">$0</div></div>
      <h2 style="margin:16px 0 8px">應付金額</h2>
      <div id="grand" style="font-size:28px;font-weight:800">$0</div>
      <button id="btnPay" class="btn">確認付款</button>
    </div>
  </div>

  <script type="module">
  import { supabase } from './supa.js';

  try{
    const UNIT = { month:200, half:960, year:1680 };
    const PERIOD_TEXT = { month:'月', half:'半年', year:'年' };
    const DISCOUNT_RATE = 0.9;

    // ✅ 確認使用正確專案 URL
    const BASE_URL = 'https://jeajrwpmrgczimmrflxo.supabase.co';

    const usp = new URLSearchParams(location.search);
    const items = (usp.get('items')||'').split(',').map(s=>s.trim()).filter(Boolean);
    const period = usp.get('period') || 'month';
    const refCode = (usp.get('ref')||'').trim() || null;

    const elPeriod = document.getElementById('periodLabel');
    const elItems = document.getElementById('itemsChips');
    const elRef = document.getElementById('refLabel');
    const elRefRow = document.getElementById('refRow');
    const elLineItems = document.getElementById('lineItems');
    const elSubtotal = document.getElementById('subtotal');
    const elRowDiscount = document.getElementById('rowDiscount');
    const elDiscount = document.getElementById('discount');
    const elGrand = document.getElementById('grand');
    const btnPay = document.getElementById('btnPay');

    if (!items.length){
      location.replace('./pricing.html');
      throw new Error('No items');
    }

    elPeriod.textContent = PERIOD_TEXT[period] || '月';
    elItems.innerHTML = items.map(it=>`<span class="chip">${it}</span>`).join('');
    if (refCode){
      elRef.textContent = refCode;
      elRef.classList.remove('muted');
      elRef.classList.add('chip');
    }else{
      elRefRow.classList.add('hidden');
    }

    const unit = UNIT[period] ?? 200;
    elLineItems.innerHTML = items.map(it=>(
      `<div class="row"><div>${it}</div><div class="price">$${unit}</div></div>`
    )).join('');

    const subtotal = unit * items.length;
    let discountAmt = 0;
    if (refCode){
      const grandX = Math.round(subtotal * DISCOUNT_RATE);
      discountAmt = subtotal - grandX;
      elRowDiscount.classList.remove('hidden');
      elDiscount.textContent = `-$${discountAmt}`;
    }
    const grand = subtotal - discountAmt;
    elSubtotal.textContent = `$${subtotal}`;
    elGrand.textContent = `$${grand}`;

    btnPay.addEventListener('click', async ()=>{
      try{
        if (!supabase) { alert('尚未設定 Supabase；無法付款。'); return; }
        const { data: { user }, error: userErr } = await supabase.auth.getUser();
        if (userErr || !user) { alert('請先登入帳號後再結帳'); return; }

        const { data: session } = await supabase.auth.getSession();

        const r1 = await fetch(`${BASE_URL}/functions/v1/create-order`, {
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Authorization':`Bearer ${session?.session?.access_token || ''}`
          },
          body: JSON.stringify({ items, period, ref: refCode })
        });
        const text = await r1.text();
        let d1;
        try { d1 = JSON.parse(text); } catch(e){ throw new Error(`create-order 回應非 JSON：${text.slice(0,80)}...`); }
        if (!r1.ok) throw new Error(d1.error || '建立訂單失敗');
        const orderId = d1.order.id;

        const f = document.createElement('form');
        f.method = 'POST';
        f.action = `${BASE_URL}/functions/v1/create-ecpay-order`;
        f.innerHTML = `<input type="hidden" name="order_id" value="${orderId}">`;
        document.body.appendChild(f);
        f.submit();
      }catch(err){
        alert('❌ 付款啟動失敗：' + (err.message || err));
      }
    });
  }catch(e){
    console.error(e);
    document.body.insertAdjacentHTML('beforeend',
      '<div style="color:#b91c1c;padding:12px;text-align:center">初始化失敗：'+ (e.message || e) +'</div>');
  }
  </script>
</body>
</html>







