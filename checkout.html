<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide｜結帳</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#f4f6fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --brand:#2563eb; --danger:#b91c1c; --radius:18px; --shadow:0 10px 30px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif}
    a{color:inherit;text-decoration:none}

    .wrap{max-width:1180px;margin:24px auto;padding:0 18px}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
    .pill{display:inline-flex;align-items:center;gap:10px;background:#fff;border:1px solid var(--line);border-radius:999px;padding:8px 12px}
    .btn{border:0;border-radius:999px;padding:11px 18px;font-size:16px;cursor:pointer}
    .btn.primary{background:var(--brand);color:#fff}
    .btn.ghost{background:#fff;border:1px solid var(--line);color:var(--ink)}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .grid{display:grid;grid-template-columns:1.25fr .9fr;gap:18px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px}
    h1{margin:0 0 8px;font-size:44px;letter-spacing:.4px}
    .muted{color:var(--muted)}
    .divider{height:1px;background:var(--line);margin:14px 0}

    .plans{display:flex;flex-direction:column;gap:12px;margin-top:10px}
    .plan{
      border:1px solid var(--line);border-radius:16px;padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;cursor:pointer;
      background:#fff;
    }
    .plan.active{outline:2px solid rgba(37,99,235,.32);border-color:rgba(37,99,235,.35)}
    .plan .left{display:flex;flex-direction:column;gap:2px}
    .plan .name{font-weight:800;font-size:18px}
    .plan .sub{color:var(--muted)}
    .plan .price{font-weight:900;font-size:20px}

    .field{margin-top:14px}
    input{
      width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:14px;
      font-size:16px;outline:none;
    }
    input:focus{border-color:rgba(37,99,235,.55)}
    .help{font-size:13px;color:var(--muted);margin-top:8px;line-height:1.55}

    .sumRow{display:flex;align-items:center;justify-content:space-between;margin:8px 0}
    .sumBig{font-size:40px;font-weight:900;letter-spacing:.5px}
    .err{margin-top:14px;border:1px solid rgba(185,28,28,.25);background:#fff5f5;color:var(--danger);
      padding:12px 14px;border-radius:14px;display:none;white-space:pre-wrap}
  </style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <a class="pill" href="/index.html">← 回首頁</a>
    <div class="pill">
      <span class="muted" id="loginHint">未登入</span>
      <button class="btn ghost" id="btnLogout" style="padding:8px 12px;display:none">登出</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h1>BookWide 結帳</h1>
      <div class="muted">課程：<span id="topicsText">—</span></div>

      <div class="divider"></div>

      <div style="font-weight:800">選擇方案</div>
      <div class="plans" id="plans">
        <div class="plan active" data-plan="month">
          <div class="left">
            <div class="name">月方案</div>
            <div class="sub">NT$ 1,000</div>
          </div>
          <div class="price">NT$ 1,000</div>
        </div>

        <div class="plan" data-plan="half">
          <div class="left">
            <div class="name">半年方案</div>
            <div class="sub">NT$ 5,400</div>
          </div>
          <div class="price">NT$ 5,400</div>
        </div>

        <div class="plan" data-plan="year">
          <div class="left">
            <div class="name">一年方案</div>
            <div class="sub">NT$ 9,600</div>
          </div>
          <div class="price">NT$ 9,600</div>
        </div>
      </div>

      <div class="field">
        <div style="font-weight:800;margin-bottom:8px">推薦碼（選填）</div>
        <input id="referralCode" placeholder="輸入推薦碼（例如 62754）" />
        <div class="help">
          有推薦碼：會帶入後端計算折扣與分潤（referrals 表：code → referrer_user_id）。<br/>
          付款後由 ecpay-return 回寫 orders（paid/expire_at…），subscription.html 會自動顯示。
        </div>
      </div>

      <div style="margin-top:16px;display:flex;gap:12px;align-items:center">
        <button class="btn primary" id="payBtn">前往綠界付款</button>
        <button class="btn ghost" id="resetBtn">重整</button>
      </div>

      <div class="err" id="errBox"></div>
    </div>

    <div class="card">
      <div class="muted" style="font-weight:800">本次應付</div>
      <div class="sumBig" id="sumPay">NT$ 1,000</div>

      <div class="divider"></div>

      <div class="sumRow"><div class="muted">原價</div><div id="sumBase">NT$ 1,000</div></div>
      <div class="sumRow"><div class="muted">折扣</div><div id="sumDisc">NT$ 0</div></div>
      <div class="sumRow"><div class="muted">期間</div><div id="sumPeriod">month</div></div>

      <div class="divider"></div>
      <div class="help">
        ※ 測試環境會導到 payment-stage；正式上線再切 prod MerchantID/HashKey/HashIV。<br/>
        ※ 若看到錯誤，本頁會直接顯示 Edge Function 回傳原文（不用猜）。
      </div>
    </div>
  </div>
</div>

<script>
/* ================= 固定：不要用 supabase 變數名（避免你其它共用腳本衝突） ================= */

const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================= state ================= */

let plan = "month";
const PRICE = { month: 1000, half: 5400, year: 9600 };

function $(id){ return document.getElementById(id); }
function fmt(n){ return "NT$ " + Number(n||0).toLocaleString(); }
function showErr(msg){
  const b = $("errBox");
  b.style.display = msg ? "block" : "none";
  b.textContent = msg || "";
}
function setPlan(p){
  plan = p;
  document.querySelectorAll(".plan").forEach(el=>{
    el.classList.toggle("active", el.dataset.plan === p);
  });
  $("sumPay").innerText = fmt(PRICE[p]);
  $("sumBase").innerText = fmt(PRICE[p]);
  $("sumDisc").innerText = fmt(0);
  $("sumPeriod").innerText = p;
}

/* ================= init UI from URL ================= */

(function initFromUrl(){
  const u = new URL(location.href);
  const topics = (u.searchParams.get("topics") || "").replace(/%2C/g,",");
  $("topicsText").innerText = topics || "—";

  const p = (u.searchParams.get("plan") || "month").toLowerCase();
  setPlan(["month","half","year"].includes(p) ? p : "month");
})();

document.querySelectorAll(".plan").forEach(el=>{
  el.addEventListener("click", ()=>{
    setPlan(el.dataset.plan);
  });
});

$("resetBtn").addEventListener("click", ()=>location.reload());

/* ================= auth header UI ================= */

async function refreshAuthUI(){
  const { data: { user } } = await sb.auth.getUser();
  if (user?.email){
    $("loginHint").textContent = user.email;
    $("btnLogout").style.display = "inline-flex";
  }else{
    $("loginHint").textContent = "未登入";
    $("btnLogout").style.display = "none";
  }
}
$("btnLogout").addEventListener("click", async ()=>{
  await sb.auth.signOut();
  location.href = "/index.html?denied=signin";
});
refreshAuthUI();

/* ================= PAY ================= */

$("payBtn").addEventListener("click", async ()=>{
  showErr("");
  $("payBtn").disabled = true;

  try{
    // 1) user
    const { data:{ user }, error:uErr } = await sb.auth.getUser();
    if (uErr) throw uErr;
    if (!user?.id){
      showErr("請先登入再付款（找不到登入狀態）");
      $("payBtn").disabled = false;
      return;
    }

    // 2) token
    const { data:{ session }, error:sErr } = await sb.auth.getSession();
    if (sErr) throw sErr;
    if (!session?.access_token){
      showErr("登入狀態失效（session token 不存在），請重新登入");
      $("payBtn").disabled = false;
      return;
    }

    const ref = ($("referralCode").value || "").trim();

    // 3) call create-ecpay-order (固定這支，不碰 create-order)
    const resp = await fetch(SUPABASE_URL + "/functions/v1/create-ecpay-order", {
      method: "POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":"Bearer " + session.access_token
      },
      body: JSON.stringify({
        user_id: user.id,
        period: plan,
        referral_code: ref || null
      })
    });

    const text = await resp.text();
    if (!resp.ok){
      showErr("付款建立失敗（" + resp.status + "）：\n" + text);
      $("payBtn").disabled = false;
      return;
    }

    let data;
    try{ data = JSON.parse(text); }catch(_e){
      showErr("付款建立失敗：回傳不是 JSON：\n" + text);
      $("payBtn").disabled = false;
      return;
    }

    if (!data?.html){
      showErr("付款建立失敗：回傳缺少 html 欄位：\n" + text);
      $("payBtn").disabled = false;
      return;
    }

    // 4) auto submit to ECPay
    const w = window.open("", "_self");
    w.document.write(data.html);
    w.document.close();

  }catch(e){
    showErr("付款建立失敗：" + String(e?.message || e));
    $("payBtn").disabled = false;
  }
});
</script>
</body>
</html>


























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































