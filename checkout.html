<!-- checkout.html (完整可用版) -->
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide｜結帳</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#f4f6fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --brand:#2563eb; --danger:#b91c1c; --ok:#065f46;
      --radius:18px; --shadow:0 10px 30px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif}
    a{color:inherit;text-decoration:none}
    header{position:sticky;top:0;z-index:10;background:rgba(244,246,251,.9);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid var(--line)}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .pill{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;display:inline-flex;gap:8px;align-items:center}
    .btn{border:0;border-radius:999px;padding:12px 18px;background:#111827;color:#fff;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--ink);border:1px solid var(--line)}
    .btn.brand{background:var(--brand)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    .h1{font-size:34px;margin:12px 0 4px}
    .muted{color:var(--muted)}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .k{color:var(--muted);min-width:90px}
    .v{font-weight:700}
    .plans{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .plan{border:1px solid var(--line);border-radius:14px;padding:12px 14px;background:#fff;cursor:pointer;min-width:180px}
    .plan.active{border-color:var(--brand);box-shadow:0 0 0 3px rgba(37,99,235,.12)}
    .price{font-weight:800;font-size:18px;margin-top:4px}
    .hr{height:1px;background:var(--line);margin:14px 0}
    .msg{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff}
    .msg.ok{border-color:rgba(6,95,70,.25);background:rgba(6,95,70,.06);color:var(--ok)}
    .msg.err{border-color:rgba(185,28,28,.25);background:rgba(185,28,28,.06);color:var(--danger)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;white-space:pre-wrap;word-break:break-word}
    footer{padding:30px 0;color:var(--muted);text-align:center}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <a class="pill" href="/index.html">← 回首頁</a>
        <div class="pill" id="who">未登入</div>
        <a class="pill" href="/account/subscription.html">我的訂閱 →</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="h1">結帳</div>
    <div class="muted">選擇方案後付款（支援：模擬付款 / 綠界 Stage 測試付款）。</div>

    <div class="grid">
      <section class="card">
        <div class="row">
          <div class="k">課程：</div>
          <div class="v" id="topicsText">-</div>
        </div>
        <div class="row" style="margin-top:8px">
          <div class="k">方案：</div>
          <div class="v" id="planText">-</div>
        </div>

        <div class="plans" id="plans">
          <div class="plan" data-plan="month">
            <div class="muted">月方案</div>
            <div class="price">NT$ 1,000</div>
          </div>
          <div class="plan" data-plan="semi">
            <div class="muted">半年方案</div>
            <div class="price">NT$ 5,400</div>
          </div>
          <div class="plan" data-plan="year">
            <div class="muted">一年方案</div>
            <div class="price">NT$ 9,600</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <button class="btn" id="btnMock">模擬付款並送出訂單</button>
          <button class="btn brand" id="btnEcpayStage">綠界測試付款（Stage）</button>
          <a class="btn secondary" href="javascript:history.back()">返回上一頁</a>
        </div>

        <div id="msg" class="msg" style="display:none"></div>
        <div id="debug" class="msg" style="display:none"><div class="mono" id="debugText"></div></div>
      </section>

      <section class="card">
        <div style="font-weight:800;margin-bottom:8px">付款方式</div>
        <div class="muted">
          • 模擬付款：只在系統內建立訂單、標記為已付款，方便你先把訂閱/顯示流程跑通。<br/>
          • 綠界測試付款：呼叫 Edge Function 串接綠界 Stage 測試環境，完整走付款流程。
        </div>
      </section>
    </div>

    <footer>BookWide © 2025</footer>
  </main>

<script>
  // ====== 你只要改這兩個（若專案不同） ======
  const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do"; // ✅ 請填你的 anon key
  const FN_CREATE_ECPAY_ORDER = `${SUPABASE_URL}/functions/v1/create-ecpay-order`;
  const FN_MOCK_PAY = `${SUPABASE_URL}/functions/v1/mock-pay`; // 若你沒這支，就用下面 fallback（直接不呼叫）

  // ====== init ======
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = (id)=>document.getElementById(id);
  const msgBox = $("msg");
  const dbgBox = $("debug");
  const dbgText = $("debugText");

  function showMsg(type, text){
    msgBox.style.display = "block";
    msgBox.className = "msg " + (type === "ok" ? "ok" : "err");
    msgBox.textContent = text;
  }
  function showDbg(obj){
    dbgBox.style.display = "block";
    dbgText.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
  }

  function parseQuery(){
    const u = new URL(location.href);
    const topics = (u.searchParams.get("topics") || "").split(",").map(s=>decodeURIComponent(s)).map(s=>s.trim()).filter(Boolean);
    const plan = (u.searchParams.get("plan") || "month").trim();
    return { topics, plan };
  }

  function normPlan(p){
    const s = String(p||"").toLowerCase().trim();
    if (s === "semi" || s === "half" || s === "6m") return "semi";
    if (s === "year" || s === "y" || s === "12m") return "year";
    return "month";
  }

  function planToPeriod(plan){
    // 你 Edge Function 用 month/half/year
    if (plan === "semi") return "half";
    if (plan === "year") return "year";
    return "month";
  }

  function setActivePlan(plan){
    document.querySelectorAll(".plan").forEach(el=>{
      el.classList.toggle("active", el.dataset.plan === plan);
    });
    $("planText").textContent = plan === "semi" ? "半年方案" : plan === "year" ? "一年方案" : "月方案";
  }

  async function refreshUser(){
    const { data } = await sb.auth.getUser();
    const user = data?.user;
    if (user?.id) $("who").textContent = (user.email || "已登入") + " · " + user.id.slice(0,8);
    else $("who").textContent = "未登入（請先登入再付款）";
    return user;
  }

  function buildPayload(user, topics, plan){
    return {
      buyer_id: user?.id || "",
      user_id: user?.id || "",
      items: topics,
      plan: plan,
      period: planToPeriod(plan),
      // 若你有推薦碼：把 referral_code 帶上
      referral_code: new URL(location.href).searchParams.get("ref") || ""
    };
  }

  async function callCreateEcpayOrder(payload){
    const res = await fetch(FN_CREATE_ECPAY_ORDER, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(payload),
    });
    const json = await res.json().catch(()=> ({}));
    if (!res.ok || !json?.ok) throw new Error(json?.message || "create-ecpay-order failed");
    return json;
  }


  // ====== ✅ 不經過 Supabase（避免 CORS）直接送到綠界 Stage ======
  // 目的：先讓你「按下去就會跳綠界」，不再卡 Failed to fetch。
  // 注意：這是綠界官方 Stage 測試商店代號，僅供測試。
  const ECPAY_STAGE = {
    MerchantID: "2000132",
    HashKey: "5294y06JbISpM5x9",
    HashIV: "v77hoKGq4kWxNNIS",
    Action: "https://payment-stage.ecpay.com.tw/Cashier/AioCheckOut/V5",
  };

  function amountForPlan(plan){
    if (plan === "semi") return 5400;
    if (plan === "year") return 9600;
    return 1000;
  }

  function fmtEcpayDate(d){
    const pad = (n)=> String(n).padStart(2,"0");
    return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  function ecpayEncodeURIComponent(str){
    let encoded = encodeURIComponent(str).toLowerCase();
    encoded = encoded
      .replace(/%20/g, "+")
      .replace(/%2d/g, "-")
      .replace(/%5f/g, "_")
      .replace(/%2e/g, ".")
      .replace(/%21/g, "!")
      .replace(/%2a/g, "*")
      .replace(/%28/g, "(")
      .replace(/%29/g, ")");
    return encoded;
  }

  async function sha256HexUpper(str){
    const data = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest("SHA-256", data);
    const hex = Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
    return hex.toUpperCase();
  }

  async function makeCheckMacValue(params){
    const keys = Object.keys(params).sort((a,b)=>a.localeCompare(b,"en"));
    const q = keys.map(k=>`${k}=${params[k]}`).join("&");
    const raw = `HashKey=${ECPAY_STAGE.HashKey}&${q}&HashIV=${ECPAY_STAGE.HashIV}`;
    const encoded = ecpayEncodeURIComponent(raw);
    return await sha256HexUpper(encoded);
  }

  async function goEcpayStageDirect(user, topics, plan){
    const amount = amountForPlan(plan);
    const tradeNo = ("BW" + Date.now().toString() + Math.floor(Math.random()*10000).toString().padStart(4,"0")).slice(0,20);
    const now = new Date();

    const itemName = `BookWide 訂閱 ${plan === "semi" ? "半年" : plan === "year" ? "一年" : "月"}方案 x1`;

    const params = {
      MerchantID: ECPAY_STAGE.MerchantID,
      MerchantTradeNo: tradeNo,
      MerchantTradeDate: fmtEcpayDate(now),
      PaymentType: "aio",
      TotalAmount: String(amount),
      TradeDesc: "BookWide 訂閱（Stage 測試）",
      ItemName: itemName,
      ReturnURL: "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/ecpay-return",   // 測試先回到本頁
      ClientBackURL: "https://bookwide.net/account/subscription.html",
      ChoosePayment: "ALL",
      EncryptType: "1",

      // 可選：你想帶的資訊（綠界允許 CustomField1~4）
      CustomField1: user?.id || "",
      CustomField2: plan || "",
      CustomField3: JSON.stringify(topics || []),
      CustomField4: user?.email || "",
    };

    const CheckMacValue = await makeCheckMacValue(params);

    // 建立表單並送出（不經過 fetch，不會 CORS）
    const form = document.createElement("form");
    form.method = "POST";
    form.action = ECPAY_STAGE.Action;

    const all = { ...params, CheckMacValue };
    Object.entries(all).forEach(([k,v])=>{
      const i = document.createElement("input");
      i.type = "hidden";
      i.name = k;
      i.value = String(v);
      form.appendChild(i);
    });

    document.body.appendChild(form);
    form.submit();
  }

  function submitEcpayHtml(html){
    const holder = document.createElement("div");
    holder.innerHTML = html;
    document.body.appendChild(holder);
    const form = holder.querySelector("form");
    if (!form) throw new Error("ECPay html has no form");
    form.submit();
  }

  // ====== main ======
  (async function main(){
    try{
      const q = parseQuery();
      const topics = q.topics.length ? q.topics : ["story","music","movie","news","pro"]; // fallback
      const plan = normPlan(q.plan);

      $("topicsText").textContent = topics.join(", ");
      setActivePlan(plan);

      // click plan cards
      $("plans").addEventListener("click", (e)=>{
        const el = e.target.closest(".plan");
        if (!el) return;
        const p = el.dataset.plan;
        const u = new URL(location.href);
        u.searchParams.set("plan", p);
        history.replaceState({}, "", u.toString());
        setActivePlan(p);
      });

      const user = await refreshUser();
      if (!user?.id){
        showMsg("err","你尚未登入：請先回首頁登入，再進行付款。");
        $("btnMock").disabled = true;
        $("btnEcpayStage").disabled = true;
        return;
      }

      $("btnEcpayStage").addEventListener("click", async ()=>{
        try{
          msgBox.style.display="none";
          dbgBox.style.display="none";
          $("btnEcpayStage").disabled = true;

          const q2 = parseQuery();
          const topics2 = q2.topics.length ? q2.topics : topics;
          const plan2 = normPlan(q2.plan);

          // ✅ 直接送綠界 Stage（不走 Supabase，不會 CORS）
          showDbg({ step:"direct ecpay stage", plan: plan2, topics: topics2 });
          await goEcpayStageDirect(user, topics2, plan2);
        }catch(err){
          showMsg("err", "綠界 Stage 送出失敗：" + (err?.message || err));
          showDbg(String(err?.stack || err));
        }finally{
          $("btnEcpayStage").disabled = false;
        }
      });

      $("btnMock").addEventListener("click", async ()=>{
        try{
          msgBox.style.display="none";
          dbgBox.style.display="none";
          $("btnMock").disabled = true;

          const q2 = parseQuery();
          const topics2 = q2.topics.length ? q2.topics : topics;
          const plan2 = normPlan(q2.plan);
          const payload = buildPayload(user, topics2, plan2);

          // 如果你有 mock-pay function，就打它；沒有就直接提示你
          try{
            const res = await fetch(FN_MOCK_PAY, {
              method:"POST",
              headers:{ "Content-Type":"application/json" },
              body: JSON.stringify(payload),
            });
            const json = await res.json().catch(()=> ({}));
            if (!res.ok || !json?.ok) throw new Error(json?.error || json?.message || "mock-pay failed");
            showMsg("ok","✅ 模擬付款成功，已建立訂單。現在去「我的訂閱」查看。");
            showDbg(json);
            setTimeout(()=>location.href="/account/subscription.html", 600);
          }catch(e){
            showMsg("err","你沒有 mock-pay 這支 function（或未部署）。先用「綠界測試付款」跑正式流程。");
            showDbg(String(e?.message || e));
          }
        }finally{
          $("btnMock").disabled = false;
        }
      });

    }catch(err){
      showMsg("err","頁面初始化失敗：" + (err?.message || err));
      showDbg(String(err?.stack || err));
    }
  })();
</script>
</body>
</html>



















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































