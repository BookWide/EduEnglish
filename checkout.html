<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BookWide 方案結帳</title>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Noto Sans TC", sans-serif;
      background:#f7f7f7;
      margin:0;
      padding:20px;
      color:#333;
    }
    .card {
      max-width:480px;
      margin:0 auto;
      background:#fff;
      padding:24px;
      border-radius:12px;
      box-shadow:0 2px 10px rgba(0,0,0,0.08);
    }
    h2 { margin-top:0; }
    button {
      width:100%;
      padding:14px;
      border:none;
      border-radius:8px;
      font-size:16px;
      cursor:pointer;
      color:#fff;
      background:#0066ff;
    }
    button:disabled {
      opacity:0.5;
      cursor:not-allowed;
    }
    .row { margin-bottom:14px; }
    .label { color:#777; }
    .items-box span {
      display:inline-block;
      margin-right:6px;
      padding:4px 8px;
      border-radius:6px;
      background:#eef3ff;
      color:#333;
      font-size:14px;
    }
  </style>
</head>

<body>
<div class="card">
  <h2>確認訂閱項目</h2>

  <div class="row">
    <div class="label">帳號：</div>
    <div id="email">（載入中）</div>
  </div>

  <div class="row">
    <div class="label">方案內容：</div>
    <div class="items-box" id="itemsBox"></div>
  </div>

  <div class="row">
    <div class="label">週期：</div>
    <div id="periodBox"></div>
  </div>

  <div class="row">
    <div class="label">金額：</div>
    <div id="priceBox"></div>
  </div>

  <button id="payBtn">建立訂單並訂閱</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const supabaseUrl = "https://jeajrwpmrgczimmrflxo.supabase.co";
  const supabaseKey = "YOUR_PUBLIC_ANON_KEY";  /* ← 保留你原本使用的 */
  const sb = supabase.createClient(supabaseUrl, supabaseKey);

  const emailBox = document.getElementById("email");
  const itemsBox = document.getElementById("itemsBox");
  const periodBox = document.getElementById("periodBox");
  const priceBox = document.getElementById("priceBox");
  const payBtn = document.getElementById("payBtn");

  // 讀 URL 內容
  const params = new URLSearchParams(window.location.search);
  const items = params.get("items") ? params.get("items").split(",") : [];
  const period = params.get("period") || "month";
  const price = params.get("price") || "0";

  // 顯示選擇
  items.forEach(i=>{
    const t = document.createElement("span");
    t.textContent = i;
    itemsBox.appendChild(t);
  });

  periodBox.textContent = period;
  priceBox.textContent = "NT$" + price;

  // 取得登入者
  let user = null;

  async function loadUser(){
    const { data } = await sb.auth.getUser();
    user = data.user;
    if (!user) {
      emailBox.textContent = "尚未登入";
      payBtn.disabled = true;
      return;
    }
    emailBox.textContent = user.email;
  }
  loadUser();

  // 建立訂單
  payBtn.onclick = async () => {
    if (!user) return alert("尚未登入！");

    payBtn.disabled = true;
    payBtn.textContent = "處理中…";

    const payload = {
      user_id: user.id,
      buyer_id: user.id,
      items: items,
      period: period,
      status: "paid",
      email_to: user.email   // 給 edge function 用來寄信
    };

    const res = await fetch(
      "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/create-order",
      {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify(payload)
      }
    );

    const out = await res.json();
    console.log("create-order 回傳：", out);

    if (!out.ok){
      alert("建立訂單失敗：" + out.error);
      payBtn.disabled = false;
      payBtn.textContent = "建立訂單並訂閱";
      return;
    }

    // 進入 subscription.html
    window.location.href = "subscription.html";
  };
</script>
</body>
</html>













