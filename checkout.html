<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>BookWide 結帳（模擬付款版）</title>
<style>
  :root{--fg:#000;--bg:#fff;--accent:#111;--muted:#666;}
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC","Microsoft JhengHei",sans-serif;}
  a{color:var(--accent)}
  .wrap{max-width:980px;margin:32px auto;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
  header h1{font-size:22px;margin:0}
  .card{border:1px solid #ddd;padding:16px;border-radius:8px;background:#fff;margin-bottom:16px}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .col{flex:1 1 300px}
  label{display:block;font-weight:600;margin-bottom:6px}
  .muted{color:var(--muted);font-size:14px}
  .summary{font-size:15px}
  .summary b{font-size:18px}
  button{appearance:none;border:1px solid #111;background:#111;color:#fff;padding:10px 14px;border-radius:6px;cursor:pointer}
  button.secondary{background:#fff;color:#111}
  button.ghost{background:#fff;border-color:#bbb;color:#111}
  .actions{display:flex;gap:10px;flex-wrap:wrap}
  .tag{display:inline-block;padding:2px 8px;border:1px solid #bbb;border-radius:999px;margin-right:6px}
  .invoice{background:#fff;border:1px dashed #bbb;padding:16px;border-radius:6px}
  .hr{height:1px;background:#eee;margin:12px 0}
  .ok{color:#0a7d27}
  .err{color:#b00020}
  .hide{display:none}
  @media print{
    header,.actions,#mockNote{display:none !important}
    body{background:#fff;color:#000}
    .card{border:none;padding:0;margin:0}
    .invoice{border:none}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>BookWide｜結帳（模擬付款）</h1>
    <a href="pricing.html" class="muted">← 返回方案與定價</a>
  </header>

  <div id="mockNote" class="card">
    <b>目前為「模擬付款」模式</b>
    <div class="muted">點「模擬付款成功」會直接在 <code>public.orders</code> 寫入一筆 <code>status = "paid"</code> 的訂單，付款方為 <code>mock</code>，方便不申請金流也能整體驗證流程。</div>
  </div>

  <div class="row">
    <div class="col">
      <div class="card">
        <label>訂單摘要</label>
        <div class="summary" id="orderSummary">
          <div>方案：<span id="planTag" class="tag">--</span></div>
          <div>主題：<span id="topicsTag">--</span></div>
          <div class="hr"></div>
          <div>小計：NT$ <span id="subtotal">0</span></div>
          <div>稅額（5%）：NT$ <span id="tax">0</span></div>
          <div><b>應付金額：NT$ <span id="amount">0</span></b></div>
          <div class="muted" id="refInfo"></div>
        </div>
      </div>

      <div class="card">
        <label>操作</label>
        <div class="actions">
          <button id="payOK">模擬付款成功</button>
          <button id="payFail" class="secondary">模擬付款失敗</button>
          <button id="printBtn" class="ghost" title="列印或另存 PDF 發票">列印帳單 / 另存 PDF</button>
        </div>
        <div id="msg" class="muted"></div>
      </div>
    </div>

    <div class="col">
      <div class="card invoice">
        <label>帳單預覽（列印用）</label>
        <div id="invoice">
          <div>商家：BookWide</div>
          <div>日期：<span id="invDate">--</span></div>
          <div>訂單編號：<span id="invId">--</span></div>
          <div class="hr"></div>
          <div>購買方案：<span id="invPlan">--</span></div>
          <div>主題內容：<span id="invTopics">--</span></div>
          <div class="hr"></div>
          <div>金額：NT$ <span id="invAmount">0</span></div>
          <div class="muted">付款方式：模擬（mock）</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// -------- utilities --------
const $ = (sel) => document.querySelector(sel);
function qs(key){ const u=new URL(location.href); return u.searchParams.get(key) || ""; }
function uuidv4(){
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random()*16|0, v = c === 'x' ? r : (r&0x3|0x8);
    return v.toString(16);
  });
}
function money(n){ return (Math.round(Number(n)||0)).toLocaleString('zh-TW'); }

// -------- read query --------
const plan = qs('plan') || 'month';
const topics = (qs('topics') || '').split(',').filter(Boolean);
const baseAmount = Number(qs('amount') || 0); // 小計（未稅）若你原本 amount 已含稅，可把稅率設 0
const taxRate = 0.05;
const tax = Math.round(baseAmount * taxRate);
const grand = baseAmount + tax;
const ref = qs('ref') || '';

// 填入畫面
$('#planTag').textContent = plan;
$('#topicsTag').textContent = topics.length ? topics.join('、') : '（未選擇）';
$('#subtotal').textContent = money(baseAmount);
$('#tax').textContent = money(tax);
$('#amount').textContent = money(grand);
$('#invDate').textContent = new Date().toLocaleString('zh-TW');
$('#invPlan').textContent = plan;
$('#invTopics').textContent = topics.length ? topics.join('、') : '（未選擇）';
$('#invAmount').textContent = money(grand);
if(ref){ $('#refInfo').textContent = '推薦碼：' + ref; }

// 預先生成一組本地顯示用訂單號（實際會以 DB 寫入為準）
const localOrderId = uuidv4();
$('#invId').textContent = localOrderId;

// -------- Supabase init --------
// 偵測是否已有全域 supabase（例如你的 site 已經在 <script> 中初始化過）
(async () => {
  if(typeof window.supabase === 'undefined'){
    // 後備方案：用 CDN 初始化（請替換為你的專案 URL 與 anon key）
    const url = window.SUPABASE_URL || "https://YOUR-PROJECT.supabase.co";
    const anon = window.SUPABASE_ANON_KEY || "YOUR-ANON-KEY";
    const s = document.createElement('script');
    s.src = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js";
    s.onload = () => { window.supabase = supabase.createClient(url, anon); };
    document.head.appendChild(s);
  }
})();

async function getUserId(){
  try{
    if(!window.supabase) { return null; }
    const { data: { user }, error } = await supabase.auth.getUser();
    if(error) return null;
    return user?.id || null;
  }catch(e){ return null; }
}

// -------- write to orders (mock) --------
async function writeMock(status){
  const user_id = await getUserId(); // 允許未登入也可測（就寫 null）
  const now = new Date().toISOString();
  const order = {
    id: localOrderId, // 以本地產生的 uuid 當 id，方便和發票顯示一致
    user_id,
    items: JSON.stringify([{plan, topics}]),
    amount: grand,
    currency: 'TWD',
    tax: tax,
    status, // 'paid' | 'failed'
    provider: 'mock',
    provider_order_id: 'MOCK-' + Date.now(),
    ref_code: ref || null,
    created_at: now
  };

  if(!window.supabase){
    $('#msg').innerHTML = '<span class="err">尚未載入 Supabase，用於本地預覽已略過寫入。</span>';
    return { ok:false };
  }

  try{
    const { error } = await supabase.from('orders').insert(order);
    if(error){
      $('#msg').innerHTML = '<span class="err">寫入 orders 失敗：'+ (error.message||error) +'</span>';
      return { ok:false, error };
    }
    $('#msg').innerHTML = status==='paid'
      ? '<span class="ok">✅ 已寫入 orders（paid）。</span>'
      : '<span class="err">❗ 已寫入 orders（failed）。</span>';
    return { ok:true, id: order.id };
  }catch(e){
    $('#msg').innerHTML = '<span class="err">寫入 orders 例外：'+ e +'</span>';
    return { ok:false, error:e };
  }
}

$('#payOK').addEventListener('click', async () => {
  $('#msg').textContent = '處理中…';
  const r = await writeMock('paid');
  // 寫入成功後導到「我的訂閱」
  setTimeout(()=>{ location.href = 'account/subscription.html'; }, 600);
});

$('#payFail').addEventListener('click', async () => {
  $('#msg').textContent = '處理中…';
  const r = await writeMock('failed');
  // 失敗就留在本頁，讓你重試或列印
});

$('#printBtn').addEventListener('click', () => {
  window.print();
});
</script>
</body>
</html>



