<script>
// === checkout.html · pricing calc fixed ===
// 規則：只有網址真的帶 ?ref=XXXX 才做 9 折，且顯示「推薦碼」提示列；沒帶就不折扣也不顯示。
// 另外亦會同步把 localStorage 的舊推薦碼清掉，避免殘留影響計價。

(() => {
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
  const p = new URLSearchParams(location.search);

  // 取得使用者選擇
  const plan  = (p.get('plan')   || 'story').trim();   // 方案名稱（只用於顯示）
  const term  = (p.get('term')   || 'month').trim();   // month | half | year
  const ref   = (p.get('ref')    || '').trim() || null; // 只有 URL 帶到才算數

  // 清理/儲存 ref，避免殘留
  try {
    if (ref) localStorage.setItem('ref_code', ref);
    else     localStorage.removeItem('ref_code');
  } catch (_) {}

  // 價格資料（保持你原本 200 / 主題 的邏輯）
  const PRICE = 200; // $200/主題/「月」的單價
  const TERM_MULTIPLIER = { month: 1, half: 6, year: 12 };

  // 你的頁面目前是「單一主題」結帳（依你截圖），若未來改為多主題，可改由 URL 或 DOM 統計數量
  const quantity = 1; // 單一主題
  const months   = TERM_MULTIPLIER[term] || 1;

  // 原價（不含折扣）
  const subtotal = PRICE * quantity;          // 顯示區塊內的「本期小計（單位：月）」截圖呈現單一主題
  // 折扣：只有有 ref 才給 9 折（-10%）
  const discount = ref ? Math.round(subtotal * 0.1) * -1 : 0;

  // 應付金額（你截圖裡是顯示月金額；若你想乘以月份，改為 subtotal*months + discount*months）
  const total = subtotal + discount;

  // ============ 把數字寫回畫面（以下選擇器請對應你頁面現有 DOM） ============
  // 小計
  const elSub = $('[data-price="subtotal"]') || $('#subtotal');
  if (elSub) elSub.textContent = `$${subtotal}`;

  // 折扣列（沒折扣就顯示 $0 或者直接把整列隱藏）
  const elDiscount = $('[data-price="discount"]') || $('#discount');
  if (elDiscount) {
    if (discount) {
      elDiscount.textContent = `-$${Math.abs(discount)}`;
      elDiscount.closest('.row')?.classList.remove('hidden');
    } else {
      elDiscount.textContent = '$0';
      // 若你希望「沒折扣就不顯示此列」，改成：
      // elDiscount.closest('.row')?.classList.add('hidden');
    }
  }

  // 應付金額
  const elTotal = $('[data-price="total"]') || $('#total');
  if (elTotal) elTotal.textContent = `$${total}`;

  // 額外「推薦碼」提示行：只有 ref 才插入
  if (ref) {
    const note = document.createElement('div');
    note.style.marginTop = '16px';
    note.style.fontSize = '15px';
    note.style.color = '#9fb0c9';
    note.textContent = `推薦碼：${ref}（已套用 9 折）`;
    // 插在你的頁尾小字（.footnote）前；若你的結構不同，換一個定位點
    const anchor = document.querySelector('.footnote') || elTotal?.closest('.card') || document.body;
    anchor?.parentNode?.insertBefore(note, anchor);
  }

  // 「確認付款」按鈕邏輯保留：按下後才導去綠界（如果你用別的 JS 控制，這段可不動）
  const btnPay = $('#btnPay') || $('[data-action="pay"]');
  if (btnPay) {
    btnPay.addEventListener('click', (e) => {
      e.preventDefault();
      // 這裡才去呼叫你既有的建立訂單 → 串綠界的流程
      // 例如：window.goECPay({ plan, term, total, ref });
      // 此處只示範：導向後端/或你原本 JS 函式
      if (typeof window.goECPay === 'function') {
        window.goECPay({ plan, term, total, ref });
      } else {
        console.log('simulate pay:', { plan, term, total, ref });
        alert('（示範）這裡才串綠界；測試站會看到 CheckMacValue 錯誤屬正常。');
      }
    });
  }
})();
</script>





