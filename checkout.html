<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BookWide｜結帳（整合版：模擬付款＋列印帳單）</title>
  <meta name="supabase-anon-key" content=""> <eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do>
  <style>
    :root{--fg:#111;--bg:#fff;--muted:#666;--line:#e6e6e6;--brand:#111;--ok:#0a7f2e;--bad:#b2172e}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.6 system-ui,-apple-system, BlinkMacSystemFont,Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:22px}
    header{display:flex;align-items:center;justify-content:space-between;margin:6px 0 16px}
    header a{color:var(--muted);text-decoration:none;border:1px solid var(--line);padding:6px 10px;border-radius:8px}
    h1{font-size:28px;margin:6px 0 2px}
    .badge{display:inline-block;border:1px solid #ccc;border-radius:999px;padding:1px 8px;font-size:12px;color:#444;background:#fafafa}
    main{display:grid;grid-template-columns:2.2fr 1.8fr;gap:18px}
    section,aside{background:#fff;border-radius:12px;border:1px solid var(--line);padding:16px}
    h2{margin:0 0 10px;font-size:20px}
    .row{display:flex;justify-content:space-between;gap:10px;margin:4px 0}
    .label{color:#555}
    .val{font-weight:600}
    .total{font-size:22px;font-weight:800}
    .muted{color:var(--muted)}
    .tag{display:inline-block;border:1px solid #ddd;border-radius:999px;padding:2px 8px;margin:0 6px 6px 0;background:#fff}

    .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    button{appearance:none;border:1px solid #111;background:#111;color:#fff;padding:11px 14px;border-radius:8px;cursor:pointer}
    button.ghost{background:#fff;color:#111}
    button.ok{background:var(--ok);border-color:var(--ok)}
    button.bad{background:var(--bad);border-color:var(--bad)}

    /* 只印帳單區塊 */
    @media print{
      body *{visibility:hidden !important}
      #bw-receipt, #bw-receipt *{visibility:visible !important}
      #bw-receipt{position:absolute;inset:0;margin:0;padding:0}
    }

    /* 帳單樣式 */
    #bw-receipt{font-family: system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif}
    .bw-rec{max-width:900px;margin:0 auto;padding:24px;color:#111;background:#fff}
    .bw-meta{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:6px 16px;margin:.25rem 0 1rem}
    .bw-table{width:100%;border-collapse:collapse}
    .bw-table th, .bw-table td{border:1px solid #e5e5e5;padding:.6rem .7rem}
    .bw-table thead th{background:#fafafa}
    .bw-note{color:#666;margin-top:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <a href="/EduEnglish/index.html">← 回首頁</a>
        <div style="margin-top:4px;font-size:13px;color:#666">登入帳號：<span id="user-email">（讀取中…）</span></div>
      </div>
      <div>
        <span class="badge">BookWide｜結帳模擬頁</span>
      </div>
    </header>

    <main>
      <!-- 左側：結帳資訊 -->
      <section>
        <h2>訂單資訊</h2>
        <p class="muted" id="plan-info"></p>
        <div id="topic-tags" style="margin-bottom:8px"></div>
        <div class="row"><div class="label">小計（未稅）</div><div class="val" id="sum-subtotal">NT$0</div></div>
        <div class="row"><div class="label">推薦碼折扣</div><div class="val" id="sum-discount">- NT$0</div></div>
        <div class="row"><div class="label">稅額（5%）</div><div class="val" id="sum-tax">NT$0</div></div>
        <hr />
        <div class="row"><div class="label">應付總額</div><div class="total" id="sum-total">NT$0</div></div>
        <p class="muted" style="margin-top:4px">※ 本頁目前為「模擬付款」環境，尚未串接真正信用卡金流。</p>

        <div class="actions">
          <button id="btn-mock-success" class="ok">模擬付款成功</button>
          <button id="btn-mock-fail" class="bad">模擬付款失敗</button>
          <button id="btn-print" class="ghost">列印帳單 / 存 PDF</button>
        </div>
        <p class="muted" id="status"></p>
      </section>

      <!-- 右：帳單預覽（列印專用） -->
      <aside class="card">
        <h2 class="title">帳單預覽</h2>
        <div id="bill-preview" class="muted">列印時會只輸出帳單區塊</div>
        <ul id="bill-items" style="margin:10px 0 0 18px;padding:0"></ul>
      </aside>
    </main>
  </div>

  <!-- 帳單列印專用區塊 -->
  <section id="bw-receipt" hidden>
    <div class="bw-rec">
      <h1 style="margin:0 0 10px;font-size:26px">BookWide 訂閱帳單</h1>
      <div class="bw-meta">
        <div>訂單編號：<span id="rec-order-id"></span></div>
        <div>開立時間：<span id="rec-date"></span></div>
        <div>客戶 Email：<span id="rec-email"></span></div>
        <div>付款狀態：<span id="rec-status">模擬付款</span></div>
      </div>
      <table class="bw-table">
        <thead>
          <tr>
            <th style="width:40%">項目</th>
            <th style="width:18%">方案</th>
            <th style="width:10%">數量</th>
            <th style="width:16%">單價</th>
            <th style="width:16%">小計</th>
          </tr>
        </thead>
        <tbody id="rec-items"></tbody>
        <tfoot>
          <tr>
            <th colspan="4" style="text-align:right">小計（未稅）</th>
            <td id="rec-subtotal">NT$0</td>
          </tr>
          <tr>
            <th colspan="4" style="text-align:right">折扣</th>
            <td id="rec-discount">-NT$0</td>
          </tr>
          <tr>
            <th colspan="4" style="text-align:right">稅額</th>
            <td id="rec-tax">NT$0</td>
          </tr>
          <tr>
            <th colspan="4" style="text-align:right">總計</th>
            <td id="rec-total">NT$0</td>
          </tr>
        </tfoot>
      </table>
      <p class="bw-note">※ 本帳單為 BookWide 線上訂閱模擬環境產出。正式金流串接完成後，將會改為真實訂單資料。</p>
    </div>
  </section>

  <!-- Supabase JS & 結帳腳本 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  (function(){
    // ===== Utils =====
    const $ = (q)=>document.querySelector(q);
    const money = (n)=>'NT$' + (Number(n)||0).toLocaleString('zh-TW');
    const uuid = ()=>crypto.randomUUID ? crypto.randomUUID() : ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16));
    const usp = new URLSearchParams(location.search);
    const titleMap = {story:'故事 Story', music:'音樂 Music', movie:'電影 Movie', news:'新聞 News', pro:'專業行業 Professional'};

    // ===== Params =====
    const topics = (usp.get('topics')||'').split(',').filter(Boolean);
    const plan   = usp.get('plan') || 'month';   // month|half|year
    const ref    = usp.get('ref') || '';
    const unitPrice = { month: 200, half: 960, year: 1680 }; // 每主題價格（可與 pricing.html 保持一致）
    const qty = Math.max(1, topics.length || 1);
    const subtotal = (unitPrice[plan] || 200) * qty;
    const discount = ref ? Math.round(subtotal * 0.10) : 0;      // 有推薦碼→ 10% 折扣
    const tax      = Math.round(Math.max(0, subtotal - discount) * 0.05); // 5% 稅
    const total    = Math.max(0, subtotal - discount) + tax;

    // ===== Supabase init =====
    const PROJECT_REF = "jeajrwpmrgczimmrflxo"; // 你提供的專案
    const SUPA_URL = `https://${PROJECT_REF}.supabase.co`;
    const ANON = document.querySelector('meta[name="supabase-anon-key"]')?.content || (window.SUPABASE_ANON_KEY||"");
    let sb = null;

    try { sb = supabase.createClient(SUPA_URL, ANON); } catch(e){ /* ignore for mock */ }

    async function getUser(){
      if(!sb) return null;
      try{
        const { data, error } = await sb.auth.getUser();
        if(error || !data?.user) return null;
        return data.user;
      }catch(e){
        console.warn('getUser error', e);
        return null;
      }
    }

    // ===== Summary render =====
    function renderSummary(){
      const topicsText = topics.length
        ? topics.map(t=>titleMap[t]||t).join('、')
        : '（未選擇主題，示範用）';
      $('#plan-info').textContent =
        `方案：${({month:'月繳',half:'半年',year:'年繳'})[plan]||plan}；主題數：${qty}；推薦碼：${ref||'（無）'}`;

      const tagBox = $('#topic-tags');
      tagBox.innerHTML = '';
      (topics.length ? topics : ['default']).forEach(k=>{
        const span = document.createElement('span');
        span.className='tag';
        span.textContent = titleMap[k] || k;
        tagBox.appendChild(span);
      });

      $('#sum-subtotal').textContent = money(subtotal);
      $('#sum-discount').textContent = '-' + money(discount);
      $('#sum-tax').textContent      = money(tax);
      $('#sum-total').textContent    = money(total);

      // 預覽項目
      const ul = $('#bill-items'); ul.innerHTML='';
      const list = topics.length ? topics : ['default'];
      list.forEach(k=>{
        const li = document.createElement('li');
        li.textContent = (titleMap[k]||k) + ' × 1';
        ul.appendChild(li);
      });
    }

    // 顯示使用者 Email（若有登入）
    (async ()=>{
      if(!sb) return;
      const u = await getUser();
      if(u?.email){ $('#user-email').textContent = u.email; }
    })();

    renderSummary();

    // ===== Write orders（正式結構，但目前 provider=mock） =====
    const orderId = uuid();
    async function writeOrder(status){
      if(!sb){
        $('#status').textContent = '（未載入 Supabase：以模擬流程顯示）';
        return true;
      }

      const user = await getUser();
      if (!user || !user.id) {
        $('#status').textContent = '⚠️ 需要登入後才能建立訂單，請先回首頁登入。';
        return false;
      }

      const payload = {
        id: orderId,
        user_id: user.id,
        items: (topics.length ? topics : ['default']),   // 對應 orders.items (text[])
        period: plan,                                   // month | half | year
        quantity: qty,
        unit_price_cents: (unitPrice[plan] || 200) * 100,
        subtotal_cents: subtotal * 100,
        discount_cents: discount * 100,
        tax_cents: tax * 100,
        total_cents: total * 100,
        currency: 'TWD',
        status: status,                       // 'paid' | 'failed'
        provider: 'mock',                     // ★ 未來接綠界時可改成 'ecpay'
        provider_order_id: 'MOCK-' + Date.now(),
        ref_code: ref || null,
        created_at: new Date().toISOString()
      };

      try{
        const { error } = await sb.from('orders').insert(payload);
        if(error){
          $('#status').textContent = '寫入 orders 失敗：' + (error.message||error);
          return false;
        }
        $('#status').textContent =
          status === 'paid'
            ? '✅ 模擬付款成功，已寫入 orders（paid）。'
            : '❗ 模擬付款失敗，已寫入 orders（failed）。';
        return true;
      }catch(e){
        $('#status').textContent = '寫入 orders 例外：' + e;
        return false;
      }
    }

    // ===== Print invoice =====
    function renderInvoice(){
      $('#rec-order-id').textContent = orderId;
      $('#rec-date').textContent = new Date().toLocaleString('zh-TW', { hour12:false });
      $('#rec-email').textContent = $('#user-email').textContent || '—';

      const tbody = $('#rec-items'); tbody.innerHTML='';
      const list = topics.length ? topics : ['default'];
      list.forEach(key=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="text-align:left">${titleMap[key]||key}</td>
          <td>${({month:'月繳',half:'半年',year:'年繳'})[plan]||plan}</td>
          <td>1</td>
          <td>${money(unitPrice[plan]||200)}</td>
          <td>${money(unitPrice[plan]||200)}</td>`;
        tbody.appendChild(tr);
      });
      $('#rec-subtotal').textContent = money(subtotal);
      $('#rec-discount').textContent = '-' + money(discount);
      $('#rec-tax').textContent = money(tax);
      $('#rec-total').textContent = money(total);
    }

    // ===== Events =====
    $('#btn-mock-success').addEventListener('click', async ()=>{
      $('#status').textContent = '處理中…';
      const ok = await writeOrder('paid');
      if(ok){
        setTimeout(()=>{ location.href = '/account/subscription.html'; }, 600);
      }
    });
    $('#btn-mock-fail').addEventListener('click', async ()=>{
      $('#status').textContent = '處理中…';
      await writeOrder('failed');
    });
    $('#btn-print').addEventListener('click', ()=>{
      renderInvoice();
      const sec = $('#bw-receipt'); sec.hidden = false;
      window.print();
      setTimeout(()=>{ sec.hidden = true; }, 200);
    });
  })();
  </script>
</body>
</html>








