<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BookWideï½œçµå¸³ï¼ˆæ•´åˆç‰ˆï¼šæ¨¡æ“¬ä»˜æ¬¾ï¼‹åˆ—å°å¸³å–®ï¼‰</title>

  <!-- â˜… Supabase è¨­å®šï¼šè«‹æŠŠ anon key æ›æˆä½ è‡ªå·±çš„ -->
  <meta name="supabase-url" content="https://jeajrwmprgczimmrflxo.supabase.co" />
  <meta name="supabase-anon-key" content="åœ¨é€™è£¡æ”¾ä½ çš„ SUPABASE_ANON_KEY" />

  <script type="module" src="https://esm.sh/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --fg:#111;
      --bg:#fff;
      --muted:#666;
      --line:#e6e6e6;
      --brand:#111;
      --ok:#0a7f2e;
      --bad:#b2172e;
      --accent:#2563eb;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font:16px/1.65 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
    }
    a{color:var(--accent);text-decoration:none;}
    a:hover{text-decoration:underline;}

    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:20px 16px 40px;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:20px;
      border-bottom:1px solid var(--line);
      padding-bottom:10px;
    }
    .logo{
      font-weight:700;
      letter-spacing:.05em;
      font-size:18px;
    }
    .logo span{
      font-weight:400;
      font-size:13px;
      color:var(--muted);
      margin-left:6px;
    }
    .user-info{
      text-align:right;
      font-size:13px;
      color:var(--muted);
    }
    .user-info strong{color:var(--fg);}

    .layout{
      display:grid;
      grid-template-columns: minmax(0,1.4fr) minmax(0,1.1fr);
      gap:20px;
    }
    @media (max-width:768px){
      .layout{
        grid-template-columns:1fr;
      }
    }

    .card{
      border:1px solid var(--line);
      border-radius:10px;
      padding:16px 16px 14px;
      background:#fafafa;
    }
    .card h2{
      margin:0 0 8px;
      font-size:17px;
    }
    .card h3{
      margin:16px 0 6px;
      font-size:15px;
    }
    .pair{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:14px;
      padding:4px 0;
      border-bottom:1px dotted #e5e5e5;
    }
    .pair:last-child{border-bottom:none;}
    .pair-label{color:var(--muted);}
    .pair-value{font-weight:500;}

    .pill{
      display:inline-flex;
      align-items:center;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid #ddd;
      font-size:12px;
      margin:2px 4px 2px 0;
      background:#fff;
    }

    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin:14px 0 6px;
    }
    button{
      border:none;
      border-radius:999px;
      padding:8px 16px;
      font-size:14px;
      cursor:pointer;
      background:#111;
      color:#fff;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    button.secondary{
      background:#fff;
      color:#111;
      border:1px solid var(--line);
    }
    button.outline{
      background:#fafafa;
      border:1px solid var(--line);
      color:#111;
    }
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    .status{
      font-size:13px;
      margin-top:4px;
      min-height:20px;
    }
    .status.ok{color:var(--ok);}
    .status.bad{color:var(--bad);}

    /* ç™¼ç¥¨é è¦½ */
    .invoice{
      border:1px solid var(--line);
      border-radius:10px;
      padding:14px 14px 18px;
      background:#fff;
      font-size:13px;
    }
    .invoice-header{
      display:flex;
      justify-content:space-between;
      margin-bottom:4px;
    }
    .invoice-title{
      font-weight:700;
    }
    .invoice-sub{
      font-size:11px;
      color:var(--muted);
    }
    table.invoice-table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:13px;
    }
    table.invoice-table th,
    table.invoice-table td{
      border:1px solid var(--line);
      padding:4px 6px;
      text-align:left;
    }
    table.invoice-table th{
      background:#f4f4f4;
    }
    .total-row td{
      font-weight:700;
      background:#fafafa;
    }

    .sub-box{
      margin-top:14px;
      border-top:1px dashed var(--line);
      padding-top:10px;
      font-size:13px;
    }
    .tag{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      background:#e0f2fe;
      color:#082f49;
      font-size:11px;
      margin-right:6px;
    }

    /* åˆ—å°æ™‚åªå°ç™¼ç¥¨å€å¡Š */
    @media print{
      body{background:#fff;}
      header,.card.main-card{display:none!important;}
      .invoice-card{
        border:none;
        padding:0;
      }
      .wrap{
        max-width:none;
        margin:0;
        padding:0;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">
        BookWide
        <span>EduEnglish è¨‚é–±çµå¸³</span>
      </div>
      <div class="user-info">
        <div><strong id="user-email">ï¼ˆè®€å–ä¸­â€¦ï¼‰</strong></div>
        <div id="user-id" style="font-size:11px;"></div>
        <div><a href="pricing.html">â† è¿”å›æ–¹æ¡ˆé¸æ“‡</a></div>
      </div>
    </header>

    <div class="layout">
      <!-- å·¦å´ï¼šè¨‚å–®è³‡è¨Š -->
      <section class="card main-card">
        <h2>è¨‚å–®è³‡è¨Š</h2>

        <h3>æ–¹æ¡ˆå…§å®¹</h3>
        <div class="pair">
          <div class="pair-label">æ–¹æ¡ˆåç¨±</div>
          <div class="pair-value" id="plan-label">ï¼ˆè‡ªå‹•å¸¶å…¥ï¼‰</div>
        </div>
        <div class="pair">
          <div class="pair-label">è¨ˆè²»é€±æœŸ</div>
          <div class="pair-value" id="plan-period">â€”</div>
        </div>
        <div class="pair">
          <div class="pair-label">æˆæ¬Šå…§å®¹</div>
          <div class="pair-value" id="plan-categories">â€”</div>
        </div>

        <h3>é‡‘é¡æ˜ç´°</h3>
        <div class="pair">
          <div class="pair-label">æ‡‰ä»˜é‡‘é¡ï¼ˆæ–°å°å¹£ï¼‰</div>
          <div class="pair-value">
            <span id="amount-ntd">â€”</span>
          </div>
        </div>
        <div class="pair">
          <div class="pair-label">é‡‘é¡åŸå§‹å€¼ï¼ˆåˆ†ï¼‰</div>
          <div class="pair-value">
            <span id="amount-raw">â€”</span>
          </div>
        </div>

        <h3>è¨‚é–±äººè³‡è¨Š</h3>
        <div class="pair">
          <div class="pair-label">E-mailï¼ˆç™»å…¥å¸³è™Ÿï¼‰</div>
          <div class="pair-value" id="pair-email">â€”</div>
        </div>
        <div class="pair">
          <div class="pair-label">æ¨è–¦ä»£ç¢¼</div>
          <div class="pair-value" id="ref-code">ï¼ˆç„¡ï¼‰</div>
        </div>

        <h3>ä»˜æ¬¾å‹•ä½œ</h3>
        <p style="font-size:13px;margin:4px 0 10px;color:var(--muted);">
          å…ˆç”¨ã€Œæ¨¡æ“¬ä»˜æ¬¾ã€æ¸¬è©¦æ•´å€‹æµç¨‹æ˜¯å¦æ­£å¸¸ç´€éŒ„è¨‚å–®ï¼Œå†é–‹å•Ÿç¶ ç•Œæ­£å¼ä»˜æ¬¾ã€‚
        </p>

        <div class="btn-row">
          <button id="btn-mock-pay">
            âœ… æ¨¡æ“¬ä»˜æ¬¾ï¼ˆå¯«å…¥è¨‚å–®ï¼‰
          </button>
          <button id="btn-ecpay-pay" class="secondary">
            ğŸ§¾ ç¶ ç•Œä»˜æ¬¾ï¼ˆæ­£å¼ï¼‰
          </button>
          <button id="btn-print" class="outline">
            ğŸ–¨ åˆ—å°å¸³å–®
          </button>
        </div>
        <div id="status" class="status"></div>

        <div class="sub-box" id="my-subscription" style="display:none;">
          <div class="tag">æˆ‘çš„è¨‚é–±</div>
          <div style="margin-top:4px;">
            ç›®å‰æ–¹æ¡ˆï¼š<span id="sub-plan">â€”</span><br />
            è¨‚å–®ç·¨è™Ÿï¼š<span id="sub-order-no">â€”</span><br />
            åˆ°æœŸæ—¥ï¼š<span id="sub-expire">â€”</span>
          </div>
        </div>
      </section>

      <!-- å³å´ï¼šç™¼ç¥¨/å¸³å–®é è¦½ -->
      <section class="card invoice-card">
        <h2>å¸³å–®é è¦½ï¼ˆåˆ—å°ç”¨ï¼‰</h2>
        <div class="invoice" id="invoice">
          <div class="invoice-header">
            <div>
              <div class="invoice-title">BookWide æ•™è‚²å¹³å°</div>
              <div class="invoice-sub">éæ­£å¼ç™¼ç¥¨ï¼Œåƒ…ä¾›å­¸å“¡å°å¸³ä½¿ç”¨</div>
            </div>
            <div style="text-align:right;">
              <div class="invoice-sub">é–‹ç«‹æ—¥æœŸï¼š<span id="inv-date">â€”</span></div>
              <div class="invoice-sub">è¨‚å–®ç·¨è™Ÿï¼š<span id="inv-no">å°šæœªå»ºç«‹</span></div>
            </div>
          </div>

          <div style="margin-top:10px;">
            <div class="invoice-sub">è¨‚é–±äººï¼š</div>
            <div id="inv-buyer">â€”</div>
            <div class="invoice-sub" style="margin-top:4px;">æ–¹æ¡ˆèªªæ˜ï¼š</div>
            <div id="inv-desc">â€”</div>
          </div>

          <table class="invoice-table">
            <thead>
              <tr>
                <th style="width:55%;">é …ç›®</th>
                <th style="width:15%;">æ•¸é‡</th>
                <th style="width:15%;">å–®åƒ¹</th>
                <th style="width:15%;">å°è¨ˆ</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td id="inv-item-name">EduEnglish ç·šä¸Šè¨‚é–±æ–¹æ¡ˆ</td>
                <td>1</td>
                <td id="inv-unit">â€”</td>
                <td id="inv-subtotal">â€”</td>
              </tr>
              <tr class="total-row">
                <td colspan="3">æ‡‰ä»˜ç¸½é¡</td>
                <td id="inv-total">â€”</td>
              </tr>
            </tbody>
          </table>

          <div style="margin-top:10px;" class="invoice-sub">
            â€» å¯¦éš›é‡‘æµç”±ç¬¬ä¸‰æ–¹ï¼ˆç¶ ç•Œç§‘æŠ€ ECPayï¼‰ä»£æ”¶ï¼Œæœ¬å–®ç‚ºå¹³å°ç«¯è¨‚é–±ç´€éŒ„ã€‚
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- â˜… çµå¸³é‚è¼¯ï¼šå‘¼å« create-order Edge Function -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    const supabaseUrl = document
      .querySelector('meta[name="supabase-url"]')
      .getAttribute('content')

    const supabaseAnonKey = document
      .querySelector('meta[name="supabase-anon-key"]')
      .getAttribute('content')

    const supabase = createClient(supabaseUrl, supabaseAnonKey)

    const elUserEmail = document.getElementById('user-email')
    const elUserId = document.getElementById('user-id')
    const elPairEmail = document.getElementById('pair-email')
    const elPlanLabel = document.getElementById('plan-label')
    const elPlanPeriod = document.getElementById('plan-period')
    const elPlanCats = document.getElementById('plan-categories')
    const elAmountNtd = document.getElementById('amount-ntd')
    const elAmountRaw = document.getElementById('amount-raw')
    const elRefCode = document.getElementById('ref-code')
    const elStatus = document.getElementById('status')
    const elInvDate = document.getElementById('inv-date')
    const elInvNo = document.getElementById('inv-no')
    const elInvBuyer = document.getElementById('inv-buyer')
    const elInvDesc = document.getElementById('inv-desc')
    const elInvUnit = document.getElementById('inv-unit')
    const elInvSubtotal = document.getElementById('inv-subtotal')
    const elInvTotal = document.getElementById('inv-total')
    const elSubBox = document.getElementById('my-subscription')
    const elSubPlan = document.getElementById('sub-plan')
    const elSubOrderNo = document.getElementById('sub-order-no')
    const elSubExpire = document.getElementById('sub-expire')

    const btnMock = document.getElementById('btn-mock-pay')
    const btnEcpay = document.getElementById('btn-ecpay-pay')
    const btnPrint = document.getElementById('btn-print')

    let currentUser = null
    let currentOrderNo = null

    function setStatus(msg, type = '') {
      elStatus.textContent = msg || ''
      elStatus.className = 'status' + (type ? ' ' + type : '')
    }

    function parseQuery() {
      const params = new URLSearchParams(window.location.search)

      const planId = params.get('plan') || params.get('plan_id') || 'unknown'
      const planLabel = params.get('plan_label') || 'è‡ªè¨‚æ–¹æ¡ˆ'
      const period = params.get('period') || 'â€”'
      const categories = (params.get('cats') || params.get('categories') || '')
        .split(',')
        .filter(Boolean)

      const amountRaw = Number(params.get('amount') || '0') || 0
      // å‡è¨­ amount æ˜¯ã€Œåˆ†ã€ï¼Œé¡¯ç¤ºæˆ NTD
      const ntd = (amountRaw / 100).toFixed(0)

      const refFromQuery = params.get('ref') || params.get('referral') || ''
      const refFromStorage = localStorage.getItem('bw_referral_code') || ''
      const refCode = refFromQuery || refFromStorage || ''

      // UI å¡«å€¼
      elPlanLabel.textContent = planLabel
      elPlanPeriod.textContent = period
      if (categories.length) {
        elPlanCats.innerHTML = ''
        categories.forEach(c => {
          const span = document.createElement('span')
          span.className = 'pill'
          span.textContent = c
          elPlanCats.appendChild(span)
        })
      } else {
        elPlanCats.textContent = 'â€”'
      }

      elAmountRaw.textContent = amountRaw ? amountRaw.toString() : 'â€”'
      elAmountNtd.textContent = amountRaw ? `NT$ ${ntd}` : 'â€”'

      elInvDesc.textContent = `${planLabel}ï¼ˆ${period}ï¼‰`
      elInvUnit.textContent = amountRaw ? `NT$ ${ntd}` : 'â€”'
      elInvSubtotal.textContent = amountRaw ? `NT$ ${ntd}` : 'â€”'
      elInvTotal.textContent = amountRaw ? `NT$ ${ntd}` : 'â€”'

      if (refCode) {
        elRefCode.textContent = refCode
      }

      // ç™¼ç¥¨æ—¥æœŸ
      const today = new Date()
      const d = today.getFullYear() + '-' +
        String(today.getMonth() + 1).padStart(2, '0') + '-' +
        String(today.getDate()).padStart(2, '0')
      elInvDate.textContent = d

      // å­˜èµ·ä¾†çµ¦é€å–®ä½¿ç”¨
      return {
        plan_id: planId,
        plan_label: planLabel,
        period,
        categories,
        amount_raw: amountRaw,
        amount_ntd: Number(ntd),
        referral_code: refCode
      }
    }

    const orderContext = parseQuery()

    async function initUser() {
      const { data, error } = await supabase.auth.getUser()
      if (error || !data.user) {
        elUserEmail.textContent = 'å°šæœªç™»å…¥'
        elUserId.textContent = ''
        elPairEmail.textContent = 'è«‹å…ˆç™»å…¥å¾Œå†çµå¸³'
        setStatus('å°šæœªç™»å…¥ï¼Œè«‹å…ˆå›é¦–é ç™»å…¥å†é€²å…¥çµå¸³é é¢ã€‚', 'bad')
        btnMock.disabled = true
        btnEcpay.disabled = true
        return
      }
      currentUser = data.user
      elUserEmail.textContent = currentUser.email
      elUserId.textContent = 'UIDï¼š' + currentUser.id
      elPairEmail.textContent = currentUser.email
      elInvBuyer.textContent = currentUser.email

      // å·²ç™»å…¥å°±å¯ä»¥æ“ä½œ
      btnMock.disabled = false
      btnEcpay.disabled = false
    }

    async function callCreateOrder(mode) {
      if (!currentUser) {
        setStatus('å°šæœªç™»å…¥ï¼Œç„¡æ³•å»ºç«‹è¨‚å–®ã€‚', 'bad')
        return
      }
      if (!orderContext.amount_raw) {
        setStatus('é‡‘é¡ç‚º 0ï¼Œè«‹å¾ pricing é é‡æ–°é¸æ“‡æ–¹æ¡ˆã€‚', 'bad')
        return
      }

      setStatus('å»ºç«‹è¨‚å–®ä¸­â€¦')
      btnMock.disabled = true
      btnEcpay.disabled = true

      const payload = {
        mode, // 'mock' æˆ– 'ecpay'
        amount: orderContext.amount_raw,
        currency: 'TWD',
        plan_id: orderContext.plan_id,
        plan_label: orderContext.plan_label,
        period: orderContext.period,
        categories: orderContext.categories,
        referral_code: orderContext.referral_code || null,
        buyer_id: currentUser.id,
        buyer_email: currentUser.email
      }

      try {
        const { data, error } = await supabase.functions.invoke('create-order', {
          body: payload
        })

        if (error) {
          console.error('create-order error:', error)
          setStatus('å»ºç«‹è¨‚å–®å¤±æ•—ï¼š' + (error.message || 'æœªçŸ¥éŒ¯èª¤'), 'bad')
          return
        }

        console.log('create-order result:', data)
        const orderNo = data?.order_id || data?.order_no || data?.id || '(æœªå›å‚³ç·¨è™Ÿ)'
        currentOrderNo = orderNo

        // æ›´æ–°ç™¼ç¥¨èˆ‡ã€Œæˆ‘çš„è¨‚é–±ã€å€
        elInvNo.textContent = orderNo
        elSubPlan.textContent = orderContext.plan_label + 'ï¼ˆ' + orderContext.period + 'ï¼‰'
        elSubOrderNo.textContent = orderNo
        elSubExpire.textContent = data?.expire_at || data?.paid_until || 'ç”±å¾Œç«¯æ±ºå®š'
        elSubBox.style.display = 'block'

        if (mode === 'mock') {
          setStatus('âœ… æ¨¡æ“¬ä»˜æ¬¾æˆåŠŸï¼šå·²å¯«å…¥è¨‚å–®ï¼ˆç·¨è™Ÿï¼š' + orderNo + 'ï¼‰ã€‚', 'ok')
        } else if (mode === 'ecpay') {
          if (data?.payment_url) {
            setStatus('å·²å»ºç«‹æ­£å¼è¨‚å–®ï¼Œæº–å‚™å°å‘ç¶ ç•Œä»˜æ¬¾é é¢â€¦', 'ok')
            // çœŸçš„é–‹ç¶ ç•Œå°±å°é 
            window.location.href = data.payment_url
          } else {
            setStatus('å·²å»ºç«‹æ­£å¼è¨‚å–®ï¼ˆç·¨è™Ÿï¼š' + orderNo + 'ï¼‰ï¼Œä½†å¾Œç«¯æœªå›å‚³ä»˜æ¬¾ç¶²å€ã€‚', 'ok')
          }
        }
      } catch (e) {
        console.error(e)
        setStatus('å»ºç«‹è¨‚å–®æ™‚ç™¼ç”Ÿä¾‹å¤–éŒ¯èª¤ï¼š' + e.message, 'bad')
      } finally {
        // å¦‚éœ€é˜²æ­¢é‡è¤‡é€å–®ï¼Œå¯ä»¥åœ¨æˆåŠŸä¹‹å¾Œä¸å†å•Ÿç”¨
        btnMock.disabled = false
        btnEcpay.disabled = false
      }
    }

    // ç¶å®šæŒ‰éˆ•
    btnMock.addEventListener('click', (e) => {
      e.preventDefault()
      callCreateOrder('mock')
    })

    btnEcpay.addEventListener('click', (e) => {
      e.preventDefault()
      callCreateOrder('ecpay')
    })

    btnPrint.addEventListener('click', (e) => {
      e.preventDefault()
      window.print()
    })

    // åˆå§‹åŒ–
    initUser()
  </script>
</body>
</html>












