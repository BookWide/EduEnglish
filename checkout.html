<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BookWide | 結帳</title>
  <style>
    body{background:#fff;color:#111;font-family:"Microsoft JhengHei",Arial,sans-serif;margin:0;line-height:1.6}
    .wrap{max-width:900px;margin:40px auto;padding:0 20px}
    a.back{color:#555;text-decoration:none;display:inline-block;margin-bottom:16px}
    h1{font-size:30px;margin:6px 0 18px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
    .row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid #eee}
    .muted{color:#666}
    .pill{background:#111;color:#fff;padding:6px 14px;border-radius:20px;font-size:14px;margin-left:4px}
    .pills{display:flex;gap:8px;flex-wrap:wrap}
    .price{text-align:right;min-width:80px}
    .total{font-size:22px;font-weight:700}
    .btn{width:100%;margin-top:20px;padding:16px 18px;background:#111;color:#fff;font-weight:700;border:0;border-radius:12px;cursor:pointer;font-size:18px}
    .btn:hover{opacity:0.9}
    .note{color:#666;font-size:13px;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <a class="back" href="pricing.html">← 返回方案與定價</a>
    <h1>訂單摘要</h1>
    <div class="card">
      <div class="row"><div class="muted">週期：</div><div id="period" class="pill">—</div></div>
      <div class="row"><div class="muted">方案：</div><div id="plans" class="pills"></div></div>
      <div class="row"><div class="muted">推薦碼：</div><div id="ref" class="muted">無推薦碼</div></div>
      <div id="lines"></div>
      <div class="row"><div class="muted">小計</div><div id="subtotal" class="price">$0</div></div>
      <div id="discountRow" class="row" style="display:none"><div class="muted">折扣</div><div id="discount" class="price">-$0</div></div>
      <div class="row"><div class="muted">稅額(0%)</div><div class="price">$0</div></div>
      <div class="row"><div class="total">應付金額</div><div id="grand" class="total price">$0</div></div>
      <button class="btn" id="pay">確認付款</button>
      <div class="note">示意：此處將導向綠界付款頁，正式版可呼叫 Edge Function。</div>
    </div>
  </div>
  <script>
  (function(){
    const UNIT={month:200,half:960,year:1680},PERIOD_TEXT={month:"月繳",half:"半年繳",year:"年繳"};
    const usp=new URLSearchParams(location.search);
    function refFromReferrer(){try{if(!document.referrer)return"";const u=new URL(document.referrer);return new URLSearchParams(u.search).get("ref")||"";}catch{return"";}}
    const ref=(usp.get("ref")||localStorage.getItem("referral_code")||refFromReferrer()||"").trim();
    if(ref)localStorage.setItem("referral_code",ref);
    const items=(usp.get("items")||"").split(",").filter(Boolean),period=usp.get("period")||"month";
    if(!items.length){location.replace("pricing.html");return;}
    document.getElementById("period").textContent=PERIOD_TEXT[period]||"月繳";
    const pDiv=document.getElementById("plans");
    items.forEach(i=>{const s=document.createElement("div");s.className="pill";s.textContent=i;pDiv.appendChild(s);});
    const refDiv=document.getElementById("ref");
    if(ref){refDiv.textContent=ref;refDiv.classList.remove("muted");refDiv.classList.add("pill");}
    const lines=document.getElementById("lines");lines.innerHTML="";
    const unit=UNIT[period],sub=unit*items.length;
    items.forEach(i=>{const r=document.createElement("div");r.className="row";r.innerHTML=`<div>${i}</div><div class='price'>$${unit}</div>`;lines.appendChild(r);});
    let discount=0;if(ref){discount=Math.round(sub*0.1);document.getElementById("discountRow").style.display="";document.getElementById("discount").textContent=`-$${discount}`;}
    document.getElementById("subtotal").textContent=`$${sub}`;
    document.getElementById("grand").textContent=`$${sub-discount}`;
    document.getElementById("pay").onclick=()=>alert("示意：此處導向綠界或 Supabase Function。");
  })();
  </script>
  <script>
(() => {
  // ① 吃 URL 的 ref，沒有就吃 localStorage；有就覆蓋 localStorage
  const usp = new URLSearchParams(location.search);
  const urlRef = usp.get('ref');
  if (urlRef) localStorage.setItem('referral_code', urlRef);
  const referral = urlRef || localStorage.getItem('referral_code') || '';

  // ② 顯示在畫面（依你 DOM 的 ID 修改）
  const elRefLabel = document.querySelector('#refLabel');   // 例如你顯示「推薦碼」的 span/div
  if (elRefLabel) {
    if (referral) {
      elRefLabel.textContent = referral;
      elRefLabel.classList.remove('muted');
    } else {
      elRefLabel.textContent = '無推薦碼';
      elRefLabel.classList.add('muted');
    }
  }

  // ③ 你後續如果要把 ref 帶去 Edge Function 建單也一併送出
  //    例如你在按「確認付款」時：
  async function createOrderAndGoEcpay(payload) {
    // payload 內包含 items, period, subtotal/total 等；我們把 referral_code 也加進去
    const body = { ...payload, referral_code: referral };
    const r = await fetch('<你的 SUPABASE_URL>/functions/v1/create-ecpay-order', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify(body),
    });
    const data = await r.json();
    // 記住商店訂單編號（可選）
    if (data?.merchant_trade_no) sessionStorage.setItem('order_no', data.merchant_trade_no);
    // 導去綠界
    if (data?.ecpay_url) location.href = data.ecpay_url;
    else alert('建立訂單失敗，請稍後再試。');
  }

  // 讓外部可用（如果你已有同名函式，可把上面合併進去）
  window.__createOrderAndGoEcpay = createOrderAndGoEcpay;
})();
</script>

</body>
</html>
