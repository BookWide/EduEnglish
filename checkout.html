<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BookWide ä»˜æ¬¾é é¢</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">

<meta name="supabase-anon-key" content="YOUR_SUPABASE_ANON_KEY_HERE">

<style>
  body { font-family: 'Noto Sans TC', sans-serif; background:#0b1324; color:#e6f0ff; margin:0; padding:0; }
  h1 { margin:0; padding:16px; background:#0f172a; font-size:22px; }
  .wrap { padding:20px; }
  .box {
    background:#0f172a; border:1px solid #1f2a44; border-radius:12px;
    padding:18px; margin-bottom:18px;
  }
  .tag { display:inline-block; padding:5px 10px; background:#123; border-radius:8px; margin:3px; }
  button {
    background:#14335f; border:1px solid #2c5aa3; color:white;
    padding:10px 16px; font-size:16px; border-radius:10px; cursor:pointer;
  }
  #status { margin-top:12px; font-size:15px; }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  td,th { border-bottom:1px solid #223048; padding:8px; }
</style>

</head>
<body>

<h1>çµå¸³ä¸­å¿ƒ Checkout</h1>

<div class="wrap">

  <div class="box">
    <h2>ç™»å…¥å¸³è™Ÿ</h2>
    <div>Emailï¼š<span id="user-email">ï¼ˆæœªç™»å…¥ï¼‰</span></div>
  </div>

  <div class="box">
    <h2>æ–¹æ¡ˆè³‡è¨Š</h2>
    <div id="plan-info"></div>
    <div id="topic-tags" style="margin-top:10px;"></div>
  </div>

  <div class="box">
    <h2>åƒ¹æ ¼è¨ˆç®—</h2>
    <table>
      <tr><td>å°è¨ˆï¼š</td><td id="sum-subtotal"></td></tr>
      <tr><td>æŠ˜æ‰£ï¼š</td><td id="sum-discount"></td></tr>
      <tr><td>ç¨…é‡‘ï¼ˆ5%ï¼‰ï¼š</td><td id="sum-tax"></td></tr>
      <tr><td><b>ç¸½é‡‘é¡ï¼š</b></td><td id="sum-total"></td></tr>
    </table>
  </div>

  <div class="box">
    <h2>æ¨¡æ“¬ä»˜æ¬¾</h2>
    <button id="btn-mock-success">æ¨¡æ“¬ä»˜æ¬¾æˆåŠŸï¼ˆpaidï¼‰</button>
    <button id="btn-mock-fail" style="margin-left:10px;background:#444;">æ¨¡æ“¬ä»˜æ¬¾å¤±æ•—ï¼ˆfailedï¼‰</button>
    <div id="status"></div>
  </div>

</div>

<!-- ===================== Supabase JS ====================== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
(function(){
  const $ = (q)=>document.querySelector(q);
  const money = (n)=>'NT$' + (Number(n)||0).toLocaleString('zh-TW');
  const uuid = ()=>crypto.randomUUID();

  const usp = new URLSearchParams(location.search);

  // â–Œ ä¸»é¡Œï¼ˆstory,music,movie,news,proï¼‰
  const topics = (usp.get('topics')||'').split(',').filter(Boolean);
  // â–Œ æ–¹æ¡ˆï¼ˆæœˆç¹³ / åŠå¹´ / å¹´ç¹³ï¼‰
  const plan   = usp.get('plan') || 'month';
  // â–Œ æ¨è–¦ç¢¼
  const ref    = usp.get('ref') || '';

  const titleMap = {
    story:'æ•…äº‹ Story', music:'éŸ³æ¨‚ Music', movie:'é›»å½± Movie',
    news:'æ–°è News', pro:'å°ˆæ¥­è¡Œæ¥­ Professional', default:'é è¨­æ•™æ'
  };

  const unitPrice = { month:200, half:960, year:1680 };

  const qty = Math.max(1, topics.length || 1);
  const subtotal = (unitPrice[plan]||200) * qty;
  const discount = ref ? Math.round(subtotal * 0.10) : 0;
  const tax      = Math.round((subtotal - discount) * 0.05);
  const total    = subtotal - discount + tax;

  // æ¸²æŸ“ UI
  function renderSummary(){
    $('#plan-info').textContent =
      `æ–¹æ¡ˆï¼š${({month:'æœˆç¹³',half:'åŠå¹´',year:'å¹´ç¹³'})[plan]}ï¼Œä¸»é¡Œæ•¸ï¼š${qty}ï¼Œæ¨è–¦ç¢¼ï¼š${ref||'ï¼ˆç„¡ï¼‰'}`;

    const tagBox = $('#topic-tags');
    tagBox.innerHTML = '';

    (topics.length ? topics : ['default']).forEach(k=>{
      const span = document.createElement('span');
      span.className='tag';
      span.textContent = titleMap[k] || k;
      tagBox.appendChild(span);
    });

    $('#sum-subtotal').textContent = money(subtotal);
    $('#sum-discount').textContent = '-' + money(discount);
    $('#sum-tax').textContent      = money(tax);
    $('#sum-total').textContent    = money(total);
  }
  renderSummary();

  // Supabase
  const PROJECT = "jeajrwpmrgczimmrflxo";
  const SUPA_URL = `https://${PROJECT}.supabase.co`;
  const ANON = document.querySelector('meta[name="supabase-anon-key"]').content;

  const sb = supabase.createClient(SUPA_URL, ANON);

  async function getUser(){
    const { data } = await sb.auth.getUser();
    return data?.user || null;
  }

  (async()=>{
    const u = await getUser();
    if(u?.email) $('#user-email').textContent = u.email;
  })();

  // Edge Function URL
  const EDGE_URL = `https://${PROJECT}.functions.supabase.co/create-order`;

  // å–®è™Ÿ
  const orderId = uuid();

  async function callEdge(status){
    const user = await getUser();
    if(!user){
      $('#status').textContent = 'âš ï¸ å°šæœªç™»å…¥ï¼Œç„¡æ³•å»ºç«‹è¨‚å–®';
      return false;
    }

    const payload = {
      id: orderId,
      user_id: user.id,
      buyer_id: user.id,
      items: (topics.length ? topics : ['default']),
      period: plan,
      quantity: qty,
      unit_price_cents: (unitPrice[plan] || 200) * 100,
      subtotal_cents: subtotal * 100,
      discount_cents: discount * 100,
      tax_cents: tax * 100,
      total_cents: total * 100,
      currency: 'TWD',
      status: status,                 // paid | failed
      provider: 'mock',               // ä¹‹å¾Œä¸²ç¶ ç•Œæ”¹æˆ ecpay
      provider_order_id: 'MOCK-' + Date.now(),
      ref_code: ref || null,
      created_at: new Date().toISOString()
    };

    $('#status').textContent = 'ğŸšš å»ºç«‹è¨‚å–®ä¸­â€¦ï¼ˆEdge Functionï¼‰';

    try{
      const res = await fetch(EDGE_URL, {
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'apikey':ANON,
          'Authorization':`Bearer ${ANON}`
        },
        body:JSON.stringify(payload)
      });

      const out = await res.json().catch(()=>null);

      if(!res.ok || !out?.ok){
        $('#status').textContent = 'âŒ Edge FunctionéŒ¯èª¤ï¼š' + (out?.error || res.status);
        return false;
      }

      $('#status').textContent =
        status==='paid' ? 'âœ… æ¨¡æ“¬ä»˜æ¬¾æˆåŠŸï¼ˆpaidï¼‰å·²å¯«å…¥è¨‚å–®ï¼' :
                           'â— æ¨¡æ“¬ä»˜æ¬¾å¤±æ•—ï¼ˆfailedï¼‰å·²å¯«å…¥è¨‚å–®ï¼';

      setTimeout(()=>{
        location.href = "/account/subscription.html";
      }, 800);

      return true;

    }catch(e){
      $('#status').textContent = 'âŒ å‘¼å« Edge Function ä¾‹å¤–ï¼š' + e;
      return false;
    }
  }

  // æŒ‰éˆ•äº‹ä»¶
  $('#btn-mock-success').addEventListener('click', ()=>callEdge('paid'));
  $('#btn-mock-fail').addEventListener('click', ()=>callEdge('failed'));

})();
</script>

</body>
</html>









