<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>è¨‚å–®æ‘˜è¦</title>
  <style>
    :root{--text:#111;--muted:#6b7280;--border:#e5e7eb;}
    body{margin:0;background:#fff;color:var(--text);font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans TC','Microsoft JhengHei',sans-serif}
    .wrap{max-width:980px;margin:28px auto;padding:0 16px}
    a.back{display:inline-block;color:#7c3aed;text-decoration:none;margin-bottom:12px}
    h1{font-size:40px;margin:6px 0 16px}
    .card{border:1px solid var(--border);border-radius:16px;padding:16px}
    .row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)}
    .row:last-child{border-bottom:none}
    .chip{background:#111;border-radius:999px;color:#fff;padding:6px 10px;font-weight:700}
    .muted{color:var(--muted)}
    .price{min-width:90px;text-align:right}
    .btn{display:block;width:100%;background:#111;color:#fff;border:none;border-radius:12px;padding:16px 14px;margin-top:16px;font-weight:700;cursor:pointer}
    .hidden{display:none !important}
  </style>

  <!-- Supabase JSï¼ˆä¾› ESM åŒ¯å…¥çš„ supa.js ä½¿ç”¨ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- é€é supa.js å»ºç«‹å–®ä¸€ Clientï¼Œä¸¦æ›åˆ° window ä¾›æœ¬é ä½¿ç”¨ -->
  <script type="module">
    import { supabase } from './supa.js';
    window.supabase = supabase;
  </script>
</head>
<body>
  <div class="wrap">
    <a class="back" href="./pricing.html">â† è¿”å›æ–¹æ¡ˆèˆ‡å®šåƒ¹</a>
    <h1>è¨‚å–®æ‘˜è¦</h1>

    <div class="card">
      <div class="row"><div class="muted">é€±æœŸï¼š</div><div id="periodLabel" class="chip">æœˆ</div></div>
      <div class="row"><div class="muted">æ–¹æ¡ˆï¼š</div><div id="itemsChips"></div></div>
      <div class="row" id="refRow"><div class="muted">æ¨è–¦ç¢¼ï¼š</div><div id="refLabel" class="muted">ç„¡</div></div>
      <div id="lineItems"></div>
      <div class="row"><div class="muted">å°è¨ˆ</div><div id="subtotal" class="price">$0</div></div>
      <div class="row hidden" id="rowDiscount"><div class="muted">æŠ˜æ‰£</div><div id="discount" class="price">-$0</div></div>
      <div class="row"><div class="muted">ç¨…é¡ï¼ˆ0%ï¼‰</div><div class="price">$0</div></div>
      <h2 style="margin:16px 0 8px">æ‡‰ä»˜é‡‘é¡</h2>
      <div id="grand" style="font-size:28px;font-weight:800">$0</div>
      <button id="btnPay" class="btn">ç¢ºèªä»˜æ¬¾</button>
    </div>
  </div>

  <script>
  (async function(){
    try{
      const UNIT = { month:200, half:960, year:1680 };
      const PERIOD_TEXT = { month:'æœˆ', half:'åŠå¹´', year:'å¹´' };
      const DISCOUNT_RATE = 0.9;

      // ğŸ”— æ”¹ç‚ºç›´æ¥ä½¿ç”¨ supa.js å»ºç«‹çš„ client
      const supabase = window.supabase || null;

      const usp = new URLSearchParams(location.search);
      const items = (usp.get('items')||'').split(',').map(s=>s.trim()).filter(Boolean);
      const period = usp.get('period') || 'month';
      const refCode = (usp.get('ref')||'').trim() || null;

      const elPeriod = document.getElementById('periodLabel');
      const elItems = document.getElementById('itemsChips');
      const elRef = document.getElementById('refLabel');
      const elRefRow = document.getElementById('refRow');
      const elLineItems = document.getElementById('lineItems');
      const elSubtotal = document.getElementById('subtotal');
      const elRowDiscount = document.getElementById('rowDiscount');
      const elDiscount = document.getElementById('discount');
      const elGrand = document.getElementById('grand');
      const btnPay = document.getElementById('btnPay');

      if (!items.length){
        location.replace('./pricing.html');
        return;
      }

      elPeriod.textContent = PERIOD_TEXT[period] || 'æœˆ';
      elItems.innerHTML = items.map(it=>`<span class="chip">${it}</span>`).join('');
      if (refCode){
        elRef.textContent = refCode;
        elRef.classList.remove('muted');
        elRef.classList.add('chip');
      }else{
        elRefRow.classList.add('hidden');
      }

      const unit = UNIT[period] ?? 200;
      elLineItems.innerHTML = items.map(it=>(
        `<div class="row"><div>${it}</div><div class="price">$${unit}</div></div>`
      )).join('');

      const subtotal = unit * items.length;
      let discountAmt = 0;
      if (refCode){
        const grandX = Math.round(subtotal * DISCOUNT_RATE);
        discountAmt = subtotal - grandX;
        elRowDiscount.classList.remove('hidden');
        elDiscount.textContent = `-$${discountAmt}`;
      }
      const grand = subtotal - discountAmt;
      elSubtotal.textContent = `$${subtotal}`;
      elGrand.textContent = `$${grand}`;

      btnPay.addEventListener('click', async ()=>{
        try{
          if (!supabase) { alert('å°šæœªè¨­å®š Supabaseï¼›ç„¡æ³•ä»˜æ¬¾ã€‚'); return; }
          const { data: { user }, error: userErr } = await supabase.auth.getUser();
          if (userErr || !user) { alert('è«‹å…ˆç™»å…¥å¸³è™Ÿå¾Œå†çµå¸³'); return; }

          const { data: session } = await supabase.auth.getSession();
          const r1 = await fetch('/functions/v1/create-order', {
            method:'POST',
            headers:{
              'Content-Type':'application/json',
              'Authorization':`Bearer ${session?.session?.access_token || ''}`
            },
            body: JSON.stringify({ items, period, ref: refCode })
          });
          const d1 = await r1.json();
          if (!r1.ok) throw new Error(d1.error || 'å»ºç«‹è¨‚å–®å¤±æ•—');
          const orderId = d1.order.id;

          // é€åˆ° create-ecpay-orderï¼ˆPOST form æäº¤ï¼‰
          const f = document.createElement('form');
          f.method = 'POST';
          f.action = '/functions/v1/create-ecpay-order';
          f.innerHTML = `<input type="hidden" name="order_id" value="${orderId}">`;
          document.body.appendChild(f);
          f.submit();
        }catch(err){
          alert('âŒ ä»˜æ¬¾å•Ÿå‹•å¤±æ•—ï¼š' + (err.message || err));
        }
      });
    }catch(e){
      console.error(e);
      document.body.insertAdjacentHTML('beforeend',
        '<div style="color:#b91c1c;padding:12px;text-align:center">åˆå§‹åŒ–å¤±æ•—ï¼š'+ (e.message || e) +'</div>');
    }
  })();
  </script>
</body>
</html>







