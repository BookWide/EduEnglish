<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(async function(){
  const UNIT = { month:200, half:960, year:1680 };
  const PERIOD_TEXT = { month:'月', half:'半年', year:'年' };
  const DISCOUNT_RATE = 0.9;

  // Supabase 初始化（請保留你原本的 SB_URL / SB_ANON）
  const supabase = window.supabase.createClient(window.SB_URL, window.SB_ANON);
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return alert("請先登入帳號後再結帳");

  // URL 參數
  const usp = new URLSearchParams(location.search);
  const items = (usp.get('items')||'').split(',').map(s=>s.trim()).filter(Boolean);
  const period = usp.get('period') || 'month';
  const refCode = (usp.get('ref')||'').trim() || null;

  if (!items.length){ location.replace('./pricing.html'); return; }

  // DOM
  const elPeriod = document.getElementById('periodLabel');
  const elItems = document.getElementById('itemsChips');
  const elRef = document.getElementById('refLabel');
  const elLineItems = document.getElementById('lineItems');
  const elSubtotal = document.getElementById('subtotal');
  const elRowDiscount = document.getElementById('rowDiscount');
  const elDiscount = document.getElementById('discount');
  const elGrand = document.getElementById('grand');
  const btnPay = document.getElementById('btnPay');

  // 顯示資料
  elPeriod.textContent = PERIOD_TEXT[period] || '月';
  elItems.innerHTML = items.map(it=>`<span class="chip">${it}</span>`).join('');
  if (refCode){
    elRef.textContent = refCode;
    elRef.classList.remove('muted');
    elRef.classList.add('chip');
  }

  const unit = UNIT[period] ?? 200;
  elLineItems.innerHTML = items.map(it=>(
    `<div class="row"><div>${it}</div><div class="price">$${unit}</div></div>`
  )).join('');

  const subtotal = unit * items.length;
  let discountAmt = 0;
  if (refCode){
    const grandX = Math.round(subtotal * DISCOUNT_RATE);
    discountAmt = subtotal - grandX;
    elRowDiscount.style.display = '';
    elDiscount.textContent = `-$${discountAmt}`;
  }
  const grand = subtotal - discountAmt;
  elSubtotal.textContent = `$${subtotal}`;
  elGrand.textContent = `$${grand}`;

  // === 確認付款按鈕 ===
  btnPay.addEventListener('click', async ()=>{
    btnPay.disabled = true;

    try {
      // 1️⃣ 建立訂單（create-order）
      const { data: session } = await supabase.auth.getSession();
      const res1 = await fetch('/functions/v1/create-order', {
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'Authorization':`Bearer ${session?.session?.access_token || ''}`
        },
        body: JSON.stringify({ items, period, ref: refCode })
      });
      const data1 = await res1.json();
      if (!res1.ok) throw new Error(data1.error || '建立訂單失敗');

      const orderId = data1.order.id;
      console.log('🧾 已建單', orderId);

      // 2️⃣ 呼叫 create-ecpay-order（自動導向綠界）
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/functions/v1/create-ecpay-order';
      form.innerHTML = `<input type="hidden" name="order_id" value="${orderId}">`;
      document.body.appendChild(form);
      form.submit();
    } catch(err){
      alert('❌ 付款啟動失敗：' + err.message);
      btnPay.disabled = false;
    }
  });
})();
</script>





