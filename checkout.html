<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide｜結帳</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#f4f6fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --brand:#2563eb; --danger:#b91c1c; --ok:#065f46;
      --radius:18px; --shadow:0 10px 30px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif}
    .wrap{max-width:980px;margin:22px auto;padding:0 14px}
    .bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
    .btn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:10px 14px;cursor:pointer}
    .btn.brand{background:var(--brand);border-color:var(--brand);color:#fff}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;margin-top:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1;min-width:280px}
    .title{font-size:34px;font-weight:900;margin:8px 0 10px}
    .muted{color:var(--muted)}
    .err{margin-top:12px;background:#fff0f0;border:1px solid #ffd0d0;color:var(--danger);padding:12px;border-radius:12px;white-space:pre-wrap}
    .ok{margin-top:12px;background:#f0fff6;border:1px solid #b7f0c9;color:var(--ok);padding:12px;border-radius:12px;white-space:pre-wrap}
    .kv{display:grid;grid-template-columns:120px 1fr;gap:8px;margin-top:8px}
    .kv div{padding:4px 0}
    .big{font-size:44px;font-weight:900}
    .chip{display:inline-block;padding:4px 10px;border-radius:999px;background:#111827;color:#fff;font-size:12px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="bar">
    <button class="btn" id="btnHome">← 回首頁</button>
    <div class="muted" id="who"></div>
  </div>

  <div class="card">
    <div class="title">結帳</div>
    <div class="row">
      <div class="col">
        <div class="muted">課程</div>
        <div id="topicsText" style="font-size:18px;font-weight:800;margin-top:6px">-</div>

        <div style="margin-top:12px" class="muted">推薦碼</div>
        <div style="margin-top:6px;font-weight:800" id="refText">-</div>

        <div style="margin-top:16px" class="muted">方案</div>
        <div style="margin-top:6px;font-weight:900;font-size:18px" id="planText">-</div>

        <div style="margin-top:16px" class="muted">操作</div>
        <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn brand" id="btnPay">前往綠界付款（測試環境）</button>
          <button class="btn" id="btnReload">重新載入</button>
        </div>

        <div id="msgErr" class="err" style="display:none"></div>
        <div id="msgOk" class="ok" style="display:none"></div>
      </div>

      <div class="col">
        <div class="muted">本次應付</div>
        <div class="big" id="amountText">NT$ -</div>
        <div class="card" style="box-shadow:none;border:1px solid var(--line);margin-top:12px">
          <div class="kv">
            <div class="muted">原價</div><div id="baseText">-</div>
            <div class="muted">折扣</div><div id="discText">-</div>
            <div class="muted">期間</div><div id="periodText">-</div>
            <div class="muted">訂單</div><div id="orderText">-</div>
          </div>
          <div class="muted" style="margin-top:10px;font-size:12px">
            付款成功後，綠界會以 ReturnURL 回呼 ecpay-return，系統會把 orders 設為 paid 並寫入 expire_at / profiles 到期日。<br/>
            （Email 通知：目前先把 email 寫進 orders.email_to，若你要「真的寄信」，再加一個 send-email function 即可。）
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 這裡動態塞入 form 然後 submit 到綠界 -->
  <div id="payFormMount"></div>
</div>

<script>
  // ✅ 只用 ASCII 的 headers，避免你那個 non ISO-8859-1 爆炸
  const SUPABASE_URL = 'https://jeajrwpmrgczimmrflxo.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do';

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = (id) => document.getElementById(id);
  const showErr = (t) => { $('msgErr').style.display='block'; $('msgOk').style.display='none'; $('msgErr').textContent = t; };
  const showOk  = (t) => { $('msgOk').style.display='block'; $('msgErr').style.display='none'; $('msgOk').textContent = t; };
  const clearMsg = () => { $('msgErr').style.display='none'; $('msgOk').style.display='none'; $('msgErr').textContent=''; $('msgOk').textContent=''; };

  function qs() { return new URLSearchParams(location.search); }

  function normalizePlan(plan){
    // 你網址用 monthly/half/yearly，我統一成 month/half/year
    const p = (plan||'').toLowerCase();
    if (p === 'half' || p === 'semi' || p === '6m' || p === 'halfyear') return 'half';
    if (p === 'year' || p === 'yearly' || p === '12m') return 'year';
    return 'month';
  }

  function planLabel(p){
    if (p==='half') return '半年方案';
    if (p==='year') return '一年方案';
    return '月方案';
  }

  async function loadMe(){
    const { data: { session } } = await sb.auth.getSession();
    const email = session?.user?.email || '';
    $('who').textContent = email ? (email + ' ・' + (session.user.id||'').slice(0,8)) : '尚未登入（請先登入再付款）';
    return session;
  }

  function readReferral(){
    // 推薦碼來源：?ref=xxxx 或 ?referral_code=xxxx 或 localStorage
    const p = qs();
    const ref = p.get('referral_code') || p.get('ref') || p.get('referral') || localStorage.getItem('bookwide_referral') || '';
    if (ref) localStorage.setItem('bookwide_referral', ref);
    return ref || '';
  }

  async function refreshUI(){
    clearMsg();
    const p = qs();
    const topics = (p.get('topics') || 'story,music,movie,news,pro').replace(/%2C/g, ',');
    const plan = normalizePlan(p.get('plan'));
    const ref = readReferral();

    $('topicsText').textContent = topics || '-';
    $('planText').textContent = planLabel(plan);
    $('refText').textContent = ref ? ref : '-';

    $('amountText').textContent = 'NT$ -';
    $('baseText').textContent = '-';
    $('discText').textContent = '-';
    $('periodText').textContent = plan;
    $('orderText').textContent = '-';

    await loadMe();
  }

  function buildAndSubmitEcpayForm(actionUrl, params){
    const mount = $('payFormMount');
    mount.innerHTML = '';
    const form = document.createElement('form');
    form.method = 'post';
    form.action = actionUrl;

    Object.keys(params).forEach((k)=>{
      const inp = document.createElement('input');
      inp.type = 'hidden';
      inp.name = k;
      inp.value = String(params[k] ?? '');
      form.appendChild(inp);
    });

    mount.appendChild(form);
    form.submit();
  }

  async function goPay(){
    clearMsg();

    const session = await loadMe();
    if (!session?.access_token){
      showErr('你尚未登入，請先登入再付款。');
      return;
    }

    const p = qs();
    const plan = normalizePlan(p.get('plan'));
    const referral_code = readReferral();

    try{
      // ✅ 只放 ASCII header
      const res = await fetch(`${SUPABASE_URL}/functions/v1/create-ecpay-order`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${session.access_token}`,
        },
        body: JSON.stringify({
          period: plan,
          referral_code: referral_code || null,
          // 你想帶 topics 也可以存進 orders
          topics: p.get('topics') || null,
        })
      });

      const j = await res.json().catch(()=>null);
      if (!res.ok || !j || !j.ok){
        throw new Error((j && (j.message||j.detail)) || `create-ecpay-order failed (${res.status})`);
      }

      $('amountText').textContent = `NT$ ${Number(j.pay_amount).toLocaleString('en-US')}`;
      $('baseText').textContent = `NT$ ${Number(j.base_amount).toLocaleString('en-US')}`;
      $('discText').textContent = `NT$ ${Number(j.discount_amount).toLocaleString('en-US')}`;
      $('periodText').textContent = j.period || plan;
      $('orderText').textContent = j.order_id || j.merchant_trade_no || '-';

      showOk('已建立訂單，準備跳轉到綠界（測試環境）。');

      // ✅ 直接組表單送到綠界（不在 browser 用中文 header）
      buildAndSubmitEcpayForm(j.action_url, j.params);

    }catch(e){
      showErr(String(e?.message || e));
    }
  }

  $('btnHome').onclick = ()=>location.href='/index.html';
  $('btnReload').onclick = refreshUI;
  $('btnPay').onclick = goPay;

  refreshUI();
</script>
</body>
</html>





















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































