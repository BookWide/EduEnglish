<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>訂單摘要｜確認付款</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    body{background:#f7f9fc}
    .wrap{max-width:980px;margin:40px auto;padding:0 16px}
    .card{border-radius:14px;border:1px solid #e9eef3}
    .title{font-weight:800;letter-spacing:.05em}
    .tag{display:inline-block;background:#111;color:#fff;padding:6px 14px;border-radius:999px;margin-left:8px}
    .btn-lg{border-radius:12px}
  </style>
</head>
<body>
<div class="wrap">
  <a href="./pricing.html" class="text-decoration-none">&larr; 返回方案與定價</a>
  <h1 class="my-4 title">訂單摘要</h1>

  <div id="orderCard" class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="fs-5">週期：</div>
        <div><span id="periodTag" class="tag">—</span></div>
      </div>

      <div class="mb-3">
        <div class="fs-5 mb-2">方案：</div>
        <div id="itemTags"></div>
      </div>

      <hr>

      <div id="breakdown"></div>

      <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="fs-4 fw-bold">應付金額</div>
        <div class="fs-3 fw-bolder" id="grand"></div>
      </div>

      <div class="text-center mt-4">
        <button id="btnPay" class="btn btn-dark btn-lg px-5">確認付款</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { supabase } from './supa.js';

// 你的 Supabase Project URL（如需修改，改這裡即可）
const BASE_URL = 'https://jeajrwpmrgczimmrflxo.supabase.co'; // <-- 若不同請改

// ---- 取 Query 參數 ----
const search = new URLSearchParams(location.search);
const items = (search.get('items') || '').split(',').filter(Boolean); // e.g. story,music
const period = search.get('period') || 'month'; // month | half | year

// ---- 價格表 ----
const PRICE = {
  month:  { story: 160, music: 160 },
  half:   { story: 960, music: 960 },  // 半年 (示例)
  year:   { story: 1680, music: 1680 }
};
const PERIOD_LABEL = { month:'月繳', half:'半年', year:'年繳' };

const periodTag = document.getElementById('periodTag');
periodTag.textContent = PERIOD_LABEL[period] || period;
const itemTags = document.getElementById('itemTags');
const breakdown = document.getElementById('breakdown');
const grand = document.getElementById('grand');

function currency(n){ return '$' + Number(n).toLocaleString('en-US'); }

let subtotal = 0;
itemTags.innerHTML = items.map(s => \`<span class="tag">\${s}</span>\`).join('');

breakdown.innerHTML = items.map(s => {
  const p = PRICE[period]?.[s] ?? 0;
  subtotal += p;
  return \`
    <div class="d-flex justify-content-between align-items-center py-2">
      <div class="small text-muted">\${s}</div>
      <div class="small">\${currency(p)}</div>
    </div>\`;
}).join('')
+ \`
  <div class="d-flex justify-content-between align-items-center pt-2 border-top">
    <div class="small text-muted">小計</div>
    <div class="small">\${currency(subtotal)}</div>
  </div>
  <div class="d-flex justify-content-between align-items-center">
    <div class="small text-muted">稅額 (0%)</div>
    <div class="small">\${currency(0)}</div>
  </div>\`;

grand.textContent = currency(subtotal);

// ---- 建立訂單 id（示例）----
function genOrderId(){
  const t = Date.now().toString(36);
  const r = Math.random().toString(36).slice(2,8);
  return \`ODR-\${t}-\${r}\`;
}

// ---- 送出表單（含 token！）----
document.getElementById('btnPay').addEventListener('click', async () => {
  const { data: { session } } = await supabase.auth.getSession();
  if(!session?.access_token){
    alert('請先登入後再付款');
    location.href = './login.html';
    return;
  }

  const orderId = genOrderId();

  const f = document.createElement('form');
  f.method = 'POST';
  f.action = \`\${BASE_URL}/functions/v1/create-ecpay-order\`;
  f.target = '_self';
  f.innerHTML = \`
    <input type="hidden" name="order_id" value="\${orderId}">
    <input type="hidden" name="token" value="\${session.access_token}">
  \`;
  document.body.appendChild(f);
  f.submit();
});
</script>
</body>
</html>












