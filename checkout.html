<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide｜結帳</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#f4f6fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --brand:#2563eb; --danger:#b91c1c; --ok:#065f46;
      --radius:18px; --shadow:0 10px 30px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif}
    .wrap{max-width:1100px;margin:22px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;margin:6px 0 14px}
    .btn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:10px 14px;cursor:pointer}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 12px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    h1{font-size:30px;margin:0 0 10px}
    .row{display:flex;justify-content:space-between;gap:10px;margin:8px 0;color:var(--muted)}
    .row b{color:var(--ink)}
    .plans{display:grid;gap:10px;margin-top:10px}
    .plan{border:1px solid var(--line);border-radius:14px;padding:14px;display:flex;justify-content:space-between;cursor:pointer;background:#fff}
    .plan.active{outline:2px solid rgba(37,99,235,.35);border-color:#c7d2fe}
    .big{font-size:42px;font-weight:800;margin:2px 0 8px}
    .primary{background:var(--brand);border:none;color:#fff}
    .primary:disabled{opacity:.6;cursor:not-allowed}
    .err{margin-top:12px;border:1px solid #fecaca;background:#fff1f2;color:#7f1d1d;border-radius:14px;padding:12px;white-space:pre-wrap;display:none}
    .ok{margin-top:12px;border:1px solid #bbf7d0;background:#f0fdf4;color:#14532d;border-radius:14px;padding:12px;white-space:pre-wrap;display:none}
    .hint{font-size:12px;color:var(--muted);line-height:1.6;margin-top:10px}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <button class="btn" onclick="location.href='/index.html'">← 回首頁</button>
      <div class="pill" id="who">未登入</div>
    </header>

    <div class="grid">
      <div class="card">
        <h1>結帳</h1>
        <div class="row"><span>課程</span><b id="topicsText">-</b></div>
        <div class="row"><span>推薦碼</span><b id="refText">-</b></div>

        <div class="plans" id="plans"></div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:14px">
          <button class="btn primary" id="payBtn">前往綠界付款</button>
          <button class="btn" onclick="history.back()">返回上一頁</button>
        </div>

        <div class="hint">
          • 這頁只做一件事：呼叫後端 create-ecpay-order 取得一整頁 HTML，然後自動送出到綠界。<br>
          • 付款成功後，綠界會回打你的 ecpay-return，後端才會把 orders 改 paid、寫 paid_at / expire_at。
        </div>

        <div class="ok" id="okBox"></div>
        <div class="err" id="errBox"></div>
      </div>

      <div class="card">
        <div class="row"><span>本次應付</span></div>
        <div class="big" id="amountText">NT$ -</div>
        <div class="row"><span>原價</span><b id="baseText">NT$ -</b></div>
        <div class="row"><span>折扣</span><b id="discountText">NT$ -</b></div>
        <div class="row"><span>期間</span><b id="periodText">-</b></div>
        <div class="hint">
          • 若你看到綠界錯誤 10200094：代表「正式/測試 MerchantID 與付款網址混用」，要去改 Edge Function secrets。
        </div>
      </div>
    </div>
  </div>

<script>
  // ✅ 你的 Supabase 專案（你已經貼了，我照用）
  const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ✅ 你的 create function URL
  const CREATE_URL = "https://jeajrwpmrgczimmrflxo.functions.supabase.co/create-ecpay-order";

  const PRICE = { month: 1000, half: 5400, year: 9600 };

  const qs = new URLSearchParams(location.search);
  const topics = (qs.get("topics") || "story,music,movie,news,pro").split(",").map(s=>s.trim()).filter(Boolean);
  const planFromUrl = (qs.get("plan") || "monthly").toLowerCase();
  const ref = (qs.get("ref") || qs.get("referral_code") || qs.get("code") || "").trim();

  // plan normalize
  let plan = "month";
  if (planFromUrl.includes("half") || planFromUrl.includes("semi") || planFromUrl.includes("6")) plan = "half";
  else if (planFromUrl.includes("year") || planFromUrl.includes("12")) plan = "year";
  else plan = "month";

  const who = document.getElementById("who");
  const plansEl = document.getElementById("plans");
  const payBtn = document.getElementById("payBtn");

  const amountText = document.getElementById("amountText");
  const baseText = document.getElementById("baseText");
  const discountText = document.getElementById("discountText");
  const periodText = document.getElementById("periodText");

  const okBox = document.getElementById("okBox");
  const errBox = document.getElementById("errBox");

  function showErr(msg){
    errBox.style.display="block";
    okBox.style.display="none";
    errBox.textContent = String(msg || "未知錯誤");
  }
  function showOk(msg){
    okBox.style.display="block";
    errBox.style.display="none";
    okBox.textContent = String(msg || "OK");
  }

  function render(){
    document.getElementById("topicsText").textContent = topics.join(", ");
    document.getElementById("refText").textContent = ref ? ref : "—";

    plansEl.innerHTML = "";
    const items = [
      { key:"month", label:"月方案", price: PRICE.month },
      { key:"half",  label:"半年方案", price: PRICE.half  },
      { key:"year",  label:"一年方案", price: PRICE.year  },
    ];

    for (const it of items){
      const div = document.createElement("div");
      div.className = "plan" + (it.key === plan ? " active" : "");
      div.innerHTML = `<div><b>${it.label}</b><div style="color:var(--muted)">NT$ ${it.price.toLocaleString()}</div></div>
                       <div style="font-weight:800">NT$ ${it.price.toLocaleString()}</div>`;
      div.onclick = ()=>{
        plan = it.key;
        render();
      };
      plansEl.appendChild(div);
    }

    const base = PRICE[plan] || 1000;
    const discount = ref ? Math.round(base * 0.1) : 0;   // 你目前規則：有推薦碼 9 折
    const pay = Math.max(1, base - discount);

    amountText.textContent = "NT$ " + pay.toLocaleString();
    baseText.textContent = "NT$ " + base.toLocaleString();
    discountText.textContent = "NT$ " + discount.toLocaleString();
    periodText.textContent = plan;
  }

  async function loadUser(){
    const { data } = await sb.auth.getUser();
    const email = data?.user?.email || "";
    const uid = data?.user?.id || "";
    who.textContent = email ? (email + " • " + uid.slice(0,8)) : "未登入";
    return { email, uid };
  }

  payBtn.onclick = async () => {
    errBox.style.display="none";
    okBox.style.display="none";

    payBtn.disabled = true;
    payBtn.textContent = "建立訂單中…";

    try {
      const { data: sess } = await sb.auth.getSession();
      const access_token = sess?.session?.access_token || "";

      const payload = {
        plan: plan,                 // month | half | year
        topics: topics,             // array
        referral_code: ref || null  // 放 body，絕對不要放 header（避免非 ISO-8859-1）
      };

      const headers = { "Content-Type": "application/json" };
      if (access_token) headers["Authorization"] = "Bearer " + access_token;

      const r = await fetch(CREATE_URL, {
        method: "POST",
        headers,
        body: JSON.stringify(payload)
      });

      const j = await r.json().catch(()=>null);
      if (!j || !j.ok) {
        throw new Error((j && (j.message || j.detail)) || ("create-ecpay-order failed, http=" + r.status));
      }

      showOk("已取得綠界表單，準備跳轉…");
      document.open();
      document.write(j.html);
      document.close();
    } catch (e) {
      showErr(e?.message || e);
    } finally {
      payBtn.disabled = false;
      payBtn.textContent = "前往綠界付款";
    }
  };

  (async ()=>{
    render();
    await loadUser();
  })();
</script>
</body>
</html>














































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































