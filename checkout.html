<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BookWide｜結帳</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#f4f6fb;
  --card:#fff;
  --ink:#0f172a;
  --muted:#64748b;
  --brand:#2563eb;
  --danger:#b91c1c;
  --radius:16px;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--ink);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans TC",sans-serif;
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px 20px;
  background:#fff;
  border-bottom:1px solid #e5e7eb;
}
main{
  max-width:1100px;
  margin:24px auto;
  padding:0 16px;
}
.grid{
  display:grid;
  grid-template-columns:2fr 1fr;
  gap:20px;
}
.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:20px;
}
.plan{
  border:2px solid #e5e7eb;
  border-radius:14px;
  padding:16px;
  margin-bottom:12px;
  cursor:pointer;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.plan.active{
  border-color:var(--brand);
}
.btn{
  background:var(--brand);
  color:#fff;
  border:none;
  border-radius:999px;
  padding:12px 22px;
  font-size:16px;
  cursor:pointer;
}
.btn.gray{
  background:#fff;
  color:#111;
  border:1px solid #e5e7eb;
}
.error{
  margin-top:12px;
  background:#fee2e2;
  color:var(--danger);
  padding:12px;
  border-radius:10px;
}
small{color:var(--muted)}
</style>
</head>

<body>
<header>
  <a href="/index.html">← 回首頁</a>
  <div id="userBox">未登入</div>
</header>

<main>
<h1>結帳</h1>
<small>付款金額以後端 create-ecpay-order 計算為準</small>

<div class="grid">
  <!-- 左 -->
  <div class="card">
    <p><b>課程：</b>story, music, movie, news, pro</p>
    <p><b>方案：</b><span id="periodLabel">月方案</span></p>
    <p><b>推薦碼：</b><span id="refLabel">—</span></p>

    <div id="plans">
      <div class="plan active" data-period="month">
        <div>月方案</div><div>NT$ 1,000</div>
      </div>
      <div class="plan" data-period="half">
        <div>半年方案</div><div>NT$ 5,400</div>
      </div>
      <div class="plan" data-period="year">
        <div>一年方案</div><div>NT$ 9,600</div>
      </div>
    </div>

    <button class="btn" id="payBtn">綠界付款</button>
    <button class="btn gray" onclick="history.back()">返回上一頁</button>

    <div id="errBox" class="error" style="display:none"></div>
  </div>

  <!-- 右 -->
  <div class="card">
    <h2>本次應付</h2>
    <h1 id="amountText">—</h1>
    <small>
      ・金額含推薦折扣（若有）<br/>
      ・100% 送往綠界 TotalAmount
    </small>
  </div>
</div>
</main>

<script>
/* ========= Supabase ========= */
const supabase = window.supabase.createClient(
  "YOUR_SUPABASE_URL",
  "YOUR_SUPABASE_ANON_KEY"
);

let currentUser = null;
let currentPeriod = "month";

/* ========= 讀 URL ========= */
const qs = new URLSearchParams(location.search);
const referralCode = qs.get("ref");

/* ========= UI ========= */
if (referralCode) {
  document.getElementById("refLabel").textContent = referralCode;
}

document.querySelectorAll(".plan").forEach(el=>{
  el.onclick = ()=>{
    document.querySelectorAll(".plan").forEach(p=>p.classList.remove("active"));
    el.classList.add("active");
    currentPeriod = el.dataset.period;
    document.getElementById("periodLabel").textContent =
      currentPeriod==="month"?"月方案":currentPeriod==="half"?"半年方案":"一年方案";
  };
});

/* ========= 取得使用者 ========= */
(async ()=>{
  const { data } = await supabase.auth.getUser();
  if (!data.user) {
    showError("請先登入後再付款");
    return;
  }
  currentUser = data.user;
  document.getElementById("userBox").textContent = currentUser.email;
})();

/* ========= 付款 ========= */
document.getElementById("payBtn").onclick = async ()=>{
  if (!currentUser) {
    showError("尚未登入");
    return;
  }

  try{
    const res = await fetch(
      "https://YOUR_PROJECT_ID.supabase.co/functions/v1/create-ecpay-order",
      {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization":"Bearer " + (await supabase.auth.getSession()).data.session.access_token
        },
        body:JSON.stringify({
          user_id: currentUser.id,
          email: currentUser.email,
          period: currentPeriod,
          referral_code: referralCode || null
        })
      }
    );

    const json = await res.json();
    if (!json.ok) throw json.message;

    // 寫入綠界表單並送出
    const div = document.createElement("div");
    div.innerHTML = json.html;
    document.body.appendChild(div);

  }catch(e){
    showError(String(e));
  }
};

function showError(msg){
  const box = document.getElementById("errBox");
  box.style.display="block";
  box.textContent = msg;
}
</script>
</body>
</html>





























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































