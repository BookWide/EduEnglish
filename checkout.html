<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BookWide 結帳</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;background:#f5f6fa;margin:0}
.wrap{max-width:900px;margin:40px auto;background:#fff;border-radius:16px;padding:24px}
h1{margin-top:0}
.plan{border:1px solid #ddd;border-radius:12px;padding:16px;margin-bottom:12px;cursor:pointer}
.plan.active{border-color:#2563eb;background:#eff6ff}
button{padding:12px 18px;border-radius:10px;border:0;background:#2563eb;color:#fff;font-size:16px;cursor:pointer}
input{padding:10px;border-radius:8px;border:1px solid #ccc;width:100%}
.err{color:#b91c1c;margin-top:12px}
</style>
</head>

<body>
<div class="wrap">
  <h1>BookWide 結帳</h1>

  <div class="plan active" data-period="month">月方案 NT$1,000</div>
  <div class="plan" data-period="halfyear">半年方案 NT$5,400</div>
  <div class="plan" data-period="year">一年方案 NT$9,600</div>

  <div style="margin:16px 0">
    <label>推薦碼（選填）</label>
    <input id="referral" placeholder="例如 62754">
  </div>

  <button id="payBtn">前往綠界付款</button>

  <div id="err" class="err"></div>
</div>

<script>
/* ========= Supabase 只宣告一次 ========= */
const supabase = supabase.createClient(
  "https://jeajrwpmrgczimmrflxo.supabase.co",
  "public-anon-key-放這裡"
);

/* ========= UI ========= */
let selectedPeriod = "month";
document.querySelectorAll(".plan").forEach(p=>{
  p.onclick = ()=>{
    document.querySelectorAll(".plan").forEach(x=>x.classList.remove("active"));
    p.classList.add("active");
    selectedPeriod = p.dataset.period;
  }
});

/* ========= 付款 ========= */
document.getElementById("payBtn").onclick = async ()=>{
  document.getElementById("err").innerText = "";

  const referral = document.getElementById("referral").value.trim();

  try{
    const res = await fetch(
      "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/create-ecpay-order",
      {
        method:"POST",
        headers:{
          "Content-Type":"application/json"
        },
        body:JSON.stringify({
          period: selectedPeriod,
          referral_code: referral || null
        })
      }
    );

    if(!res.ok){
      const t = await res.text();
      throw new Error(t);
    }

    const html = await res.text();

    /* Edge Function 回傳的是綠界 form */
    const div = document.createElement("div");
    div.innerHTML = html;
    document.body.appendChild(div);
    document.getElementById("ecpayForm").submit();

  }catch(e){
    document.getElementById("err").innerText = "付款建立失敗：" + e.message;
  }
};
</script>
</body>
</html>




























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































