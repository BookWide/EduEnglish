<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide｜結帳</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#f4f6fb;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --brand:#2563eb;
      --brand2:#1d4ed8;
      --danger:#b91c1c;
      --ok:#065f46;
      --shadow:0 12px 36px rgba(15,23,42,.08);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1180px;margin:28px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .title{font-size:42px;font-weight:900;letter-spacing:.3px;margin:0 0 6px}
    .sub{color:var(--muted);margin:0 0 18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card .hd{padding:16px 18px;border-bottom:1px solid var(--line)}
    .card .bd{padding:16px 18px}
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .plans{display:flex;flex-direction:column;gap:12px}
    .plan{
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
      transition:.15s;
      background:#fff;
    }
    .plan:hover{border-color:#cbd5e1}
    .plan.active{outline:3px solid rgba(37,99,235,.18);border-color:rgba(37,99,235,.45)}
    .p-left{display:flex;flex-direction:column;gap:2px}
    .p-name{font-weight:800}
    .p-note{font-size:13px;color:var(--muted)}
    .p-price{font-weight:900;font-size:20px}
    .field{display:flex;flex-direction:column;gap:8px;margin-top:14px}
    .label{font-weight:800}
    .inp{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 12px;
      font-size:16px;
      outline:none;
      background:#fff;
    }
    .inp:focus{border-color:rgba(37,99,235,.6);box-shadow:0 0 0 4px rgba(37,99,235,.12)}
    .hint{font-size:13px;color:var(--muted);line-height:1.5}
    .btns{display:flex;gap:10px;align-items:center;margin-top:14px;flex-wrap:wrap}
    .btn{
      border:0;
      border-radius:999px;
      padding:12px 16px;
      font-weight:900;
      cursor:pointer;
      transition:.15s;
      font-size:15px;
    }
    .btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff}
    .btn.primary:hover{filter:brightness(.98)}
    .btn.ghost{background:#fff;border:1px solid var(--line);color:var(--ink)}
    .btn.ghost:hover{border-color:#cbd5e1}
    .msg{
      margin-top:12px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted);
      display:none;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .msg.err{display:block;border-color:rgba(185,28,28,.25);background:rgba(185,28,28,.06);color:var(--danger)}
    .msg.ok{display:block;border-color:rgba(6,95,70,.25);background:rgba(6,95,70,.06);color:var(--ok)}
    .sumBig{font-size:44px;font-weight:950;letter-spacing:.3px;margin:0}
    .sumRow{display:flex;justify-content:space-between;gap:12px;margin:8px 0;color:var(--muted)}
    .sumRow strong{color:var(--ink)}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .tiny{font-size:12px;color:var(--muted);line-height:1.55}
    .topline{display:flex;justify-content:space-between;gap:12px;align-items:flex-end;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:999px;padding:8px 12px;background:#fff}
    .pill b{font-weight:900}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .hide{display:none}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topline">
      <div>
        <h1 class="title">BookWide 結帳</h1>
        <p class="sub">課程：<span id="topicsText" class="mono">-</span></p>
      </div>
      <div class="pill">
        <span>登入：</span>
        <b id="who" class="mono">-</b>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="hd"><b>選擇方案</b></div>
        <div class="bd">
          <div class="plans" id="plans"></div>

          <div class="field">
            <div class="label">推薦碼（選填）</div>
            <input id="ref" class="inp" placeholder="輸入推薦碼（例如 62754）" inputmode="numeric" />
            <div class="hint">
              有推薦碼：會帶入後端計算折扣與分潤（referrals 表：code → owner_id / referrer_user_id）。<br/>
              付款後由 ecpay-return 回寫 orders（paid/expire_at…），subscription.html 會自動顯示。
            </div>
          </div>

          <div class="btns">
            <button id="payBtn" class="btn primary">前往綠界付款</button>
            <button id="resetBtn" class="btn ghost">重整</button>
          </div>

          <div id="msg" class="msg"></div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="hd"><b>本次應付</b></div>
        <div class="bd">
          <p id="payBig" class="sumBig">NT$ -</p>
          <div class="hr"></div>
          <div class="sumRow"><span>原價</span><strong id="origText">NT$ -</strong></div>
          <div class="sumRow"><span>折扣</span><strong id="discText">NT$ -</strong></div>
          <div class="sumRow"><span>期間</span><strong id="periodText">-</strong></div>
          <div class="hr"></div>
          <div class="tiny">
            ※ 測試環境會導到 payment-stage；正式上線再切 prod MerchantID/HashKey/HashIV。<br/>
            ※ 若看到錯誤，本頁會直接顯示 Edge Function 回傳原文（不用猜）。
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /***************
     * 1) 必填：改成你自己的 Supabase
     ***************/
    const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
    const SUPABASE_ANON_KEY = "PASTE_YOUR_SUPABASE_ANON_KEY_HERE"; // ✅ 你一定要填
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /***************
     * 2) 設定
     ***************/
    const FN_CREATE_ORDER = `${SUPABASE_URL}/functions/v1/create-ecpay-order`;

    const PRICE = {
      month: 1000,
      halfyear: 5400,
      year: 9600
    };

    const PLAN_LABEL = {
      month: "月方案",
      halfyear: "半年方案",
      year: "一年方案"
    };

    // UI state
    let selectedPeriod = "month";
    let topics = "";
    let userEmail = "-";

    const elPlans = document.getElementById("plans");
    const elTopics = document.getElementById("topicsText");
    const elWho = document.getElementById("who");
    const elRef = document.getElementById("ref");
    const elPayBtn = document.getElementById("payBtn");
    const elReset = document.getElementById("resetBtn");

    const elMsg = document.getElementById("msg");
    const elPayBig = document.getElementById("payBig");
    const elOrig = document.getElementById("origText");
    const elDisc = document.getElementById("discText");
    const elPeriod = document.getElementById("periodText");

    function money(n){ return `NT$ ${Number(n||0).toLocaleString("zh-Hant-TW")}`; }

    function setMsg(type, text){
      elMsg.className = "msg";
      if (!text) { elMsg.style.display = "none"; elMsg.textContent = ""; return; }
      elMsg.style.display = "block";
      elMsg.textContent = text;
      if (type === "err") elMsg.classList.add("err");
      if (type === "ok") elMsg.classList.add("ok");
    }

    function parseQS(){
      const u = new URL(location.href);
      // 你原本：?topics=story%2Cmusic%2Cmovie%2Cnews%2Cpro&plan=month
      topics = (u.searchParams.get("topics") || "story,music,movie,news,pro").replaceAll("%2C", ",");
      const plan = (u.searchParams.get("plan") || "month").toLowerCase();
      if (PRICE[plan]) selectedPeriod = plan;

      // 預填 referral（可用 ?ref=45845）
      const ref = (u.searchParams.get("ref") || "").trim();
      const saved = localStorage.getItem("bookwide_referral_code") || "";
      elRef.value = ref || saved || "";
    }

    function renderPlans(){
      elPlans.innerHTML = "";
      const order = ["month","halfyear","year"];
      order.forEach(period=>{
        const div = document.createElement("div");
        div.className = "plan" + (period===selectedPeriod ? " active" : "");
        div.dataset.period = period;
        div.innerHTML = `
          <div class="p-left">
            <div class="p-name">${PLAN_LABEL[period]}</div>
            <div class="p-note">${money(PRICE[period])}</div>
          </div>
          <div class="p-price">${money(PRICE[period])}</div>
        `;
        div.onclick = ()=>{
          selectedPeriod = period;
          renderPlans();
          updateSummary(PRICE[selectedPeriod], 0, selectedPeriod);
          setMsg("", "");
        };
        elPlans.appendChild(div);
      });
    }

    function updateSummary(amountPayable, discountAmount, period){
      const base = PRICE[period] || 0;
      elPayBig.textContent = money(amountPayable);
      elOrig.textContent = money(base);
      elDisc.textContent = money(discountAmount);
      elPeriod.textContent = period;
    }

    async function ensureLogin(){
      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.access_token) {
        // 你要的話可改成導回首頁登入
        setMsg("err", "尚未登入（沒有 session）。請先登入再結帳。");
        elPayBtn.disabled = true;
        return null;
      }
      userEmail = session.user?.email || "-";
      elWho.textContent = userEmail;
      return session.access_token;
    }

    function createAndSubmitEcpayForm(ecpayUrl, params){
      const form = document.createElement("form");
      form.method = "POST";
      form.action = ecpayUrl;

      Object.entries(params || {}).forEach(([k,v])=>{
        const input = document.createElement("input");
        input.type = "hidden";
        input.name = k;
        input.value = String(v ?? "");
        form.appendChild(input);
      });

      document.body.appendChild(form);
      form.submit();
    }

    async function createOrder(){
      const jwt = await ensureLogin();
      if (!jwt) return;

      const referral_code = (elRef.value || "").trim();
      if (referral_code) localStorage.setItem("bookwide_referral_code", referral_code);
      else localStorage.removeItem("bookwide_referral_code");

      setMsg("", "");
      elPayBtn.disabled = true;
      elPayBtn.textContent = "建立付款中…";

      try{
        // ✅ 重要：不要自己塞 apikey header（會被瀏覽器 preflight 擋）
        const resp = await fetch(FN_CREATE_ORDER, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${jwt}`,
          },
          body: JSON.stringify({
            period: selectedPeriod,
            topics: topics,
            referral_code: referral_code || ""
          }),
        });

        const data = await resp.json().catch(()=> ({}));

        if (!resp.ok){
          // 直接把後端原文丟出來（你要的：不猜）
          const s = typeof data === "string" ? data : JSON.stringify(data);
          setMsg("err", `付款建立失敗（${resp.status}）：\n${s}`);
          return;
        }

        // ✅ 後端回：amount_original / discount_amount / amount_payable / referral_valid / params / ecpay_url
        const payable = Number(data.amount_payable ?? 0);
        const discount = Number(data.discount_amount ?? 0);

        updateSummary(payable, discount, selectedPeriod);

        // 先顯示一下（很短），然後立刻送到綠界
        setMsg("ok", `已建立訂單：${data.order_id}\n應付：${money(payable)}（折扣 ${money(discount)}）`);

        if (!data.ecpay_url || !data.params){
          setMsg("err", `後端缺少 ecpay_url/params：\n${JSON.stringify(data)}`);
          return;
        }

        createAndSubmitEcpayForm(data.ecpay_url, data.params);

      }catch(e){
        setMsg("err", `付款建立失敗：Failed to fetch\n${String(e?.message || e)}`);
      }finally{
        elPayBtn.disabled = false;
        elPayBtn.textContent = "前往綠界付款";
      }
    }

    // init
    (async function(){
      parseQS();
      elTopics.textContent = topics || "-";
      renderPlans();
      updateSummary(PRICE[selectedPeriod], 0, selectedPeriod);
      await ensureLogin();

      elPayBtn.onclick = (e)=>{ e.preventDefault(); createOrder(); };
      elReset.onclick = (e)=>{ e.preventDefault(); location.reload(); };
    })();
  </script>
</body>
</html>






























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































