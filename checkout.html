<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide | 結帳</title>
  <style>
    /* 簡單樣式（盡量貼合你原本深色版型） */
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --green:#22c55e; --green-900:#14532d; --pill:#1f2937; --pillText:#e5e7eb;
      --border:#1f2937;
    }
    html,body{background:var(--bg); color:var(--text); font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue","Noto Sans","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji",Arial,"Microsoft JhengHei",sans-serif; margin:0}
    .wrap{max-width:960px; margin:28px auto; padding:0 16px;}
    a.back{color:var(--muted); text-decoration:none; display:inline-block; margin-bottom:16px}
    h1{font-size:28px; margin:6px 0 18px 0}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:24px;}
    .row{display:flex; align-items:center; justify-content:space-between; padding:16px 0; border-bottom:1px solid var(--border);}
    .row:last-child{border-bottom:0}
    .muted{color:var(--muted)}
    .pills{display:flex; gap:10px; flex-wrap:wrap}
    .pill{background:var(--pill); color:var(--pillText); padding:6px 12px; border-radius:999px; font-size:14px}
    .total{font-size:22px; font-weight:700}
    .btn{width:100%; margin-top:18px; padding:18px 20px; background:var(--green); color:#001b09; font-weight:700; border:0; border-radius:12px; cursor:pointer; font-size:18px}
    .btn:active{transform:translateY(1px)}
    .note{color:var(--muted); font-size:13px; margin-top:10px}
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; background:#1f2937; color:#cbd5e1; font-size:13px; margin-left:8px}
    .price{min-width:90px; text-align:right}
  </style>
</head>
<body>
  <div class="wrap">
    <a class="back" href="./pricing.html">← 返回方案與定價</a>
    <h1>訂單摘要</h1>

    <div class="card">
      <div class="row">
        <div class="muted">週期：</div>
        <div id="periodLabel" class="pill">月</div>
      </div>

      <div class="row">
        <div class="muted">方案：</div>
        <div id="itemsPills" class="pills"></div>
      </div>

      <div class="row">
        <div class="muted">推薦碼</div>
        <div id="refLabel" class="muted">無推薦碼</div>
      </div>

      <div id="lineItems"></div>

      <div class="row">
        <div class="muted">小計</div>
        <div id="subtotal" class="price">$0</div>
      </div>

      <div id="rowDiscount" class="row" style="display:none">
        <div class="muted">折扣</div>
        <div id="discount" class="price">-$0</div>
      </div>

      <div class="row">
        <div class="muted">稅額（0%）</div>
        <div id="tax" class="price">$0</div>
      </div>

      <div class="row">
        <div class="total">應付金額</div>
        <div id="grand" class="total price">$0</div>
      </div>

      <button id="btnPay" class="btn">確認付款</button>
      <div class="note">按下「確認付款」後，會導向綠界金流頁面完成付款。</div>
    </div>
  </div>

  <!-- 內嵌腳本：計算金額 + 處理推薦碼 + 之後可接 Edge Function -->
  <script>
  (function(){
    const UNIT_PRICES = { month: 200, half: 960, year: 1680 }; // 單位：NT$
    const PERIOD_TEXT = { month: '月', half: '半年', year: '年' };
    const DISCOUNT_WITH_REF = 0.9; // 9 折

    // 讀參數
    const usp = new URLSearchParams(location.search);
    const items = (usp.get('items') || '').split(',').map(s => s.trim()).filter(Boolean);
    const period = (usp.get('period') || 'month');
    // 收下 URL 帶來的推薦碼（若有）
    const refFromUrl = usp.get('ref');
    if (refFromUrl) localStorage.setItem('referral_code', refFromUrl);
    const referral = localStorage.getItem('referral_code') || '';

    // DOM
    const elPeriod = document.getElementById('periodLabel');
    const elItemsPills = document.getElementById('itemsPills');
    const elRefLabel = document.getElementById('refLabel');
    const elLineItems = document.getElementById('lineItems');
    const elSubtotal = document.getElementById('subtotal');
    const elRowDiscount = document.getElementById('rowDiscount');
    const elDiscount = document.getElementById('discount');
    const elTax = document.getElementById('tax');
    const elGrand = document.getElementById('grand');
    const btnPay = document.getElementById('btnPay');

    // 期別顯示
    elPeriod.textContent = PERIOD_TEXT[period] || '月';

    // 方案膠囊
    elItemsPills.innerHTML = '';
    if (items.length === 0) {
      // 沒有項目就回定價
      location.replace('./pricing.html');
      return;
    }
    items.forEach(it => {
      const p = document.createElement('span');
      p.className = 'pill';
      p.textContent = it;
      elItemsPills.appendChild(p);
    });

    // 推薦碼顯示
    if (referral) {
      elRefLabel.textContent = referral;
      elRefLabel.classList.remove('muted');
      elRefLabel.classList.add('pill');
    } else {
      elRefLabel.textContent = '無推薦碼';
      elRefLabel.classList.add('muted');
    }

    // 列出每個品項行
    elLineItems.innerHTML = '';
    const unit = UNIT_PRICES[period] ?? UNIT_PRICES.month;
    items.forEach(it => {
      const row = document.createElement('div');
      row.className = 'row';
      row.innerHTML = `<div>${it}</div><div class="price">$${unit}</div>`;
      elLineItems.appendChild(row);
    });

    // 金額計算
    const subtotal = unit * items.length;
    let discountAmount = 0;
    if (referral) {
      const grandX = Math.round(subtotal * DISCOUNT_WITH_REF);
      discountAmount = subtotal - grandX;
      elRowDiscount.style.display = '';
      elDiscount.textContent = `-$${discountAmount}`;
    } else {
      elRowDiscount.style.display = 'none';
    }
    const tax = 0;           // 目前固定 0%
    const grand = subtotal - discountAmount + tax;

    // 注入金額
    elSubtotal.textContent = `$${subtotal}`;
    elTax.textContent = `$${tax}`;
    elGrand.textContent = `$${grand}`;

    // 付款（目前先提示；要我就幫你接 Edge Function）
    btnPay.addEventListener('click', async () => {
      alert('目前為示意按鈕。若要直接串接綠界，告訴我你的 Supabase 專案 URL，我幫你把呼叫 Edge Function 的程式接上。');
      // 範例（之後替換成你的專案）： 
      // const SUPABASE_URL = 'https://<YOUR_PROJECT>.supabase.co';
      // const r = await fetch(`${SUPABASE_URL}/functions/v1/create-ecpay-order`, {
      //   method: 'POST',
      //   headers: { 'content-type': 'application/json' },
      //   body: JSON.stringify({ items, period, total: grand, referral_code: referral })
      // });
      // const data = await r.json();
      // if (data?.ecpay_url) location.href = data.ecpay_url;
      // else alert('建立訂單失敗，請稍後再試。');
    });
  })();
  </script>
</body>
</html>













