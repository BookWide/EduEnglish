<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BookWide｜結帳</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--bg:#f4f6fb;--card:#fff;--ink:#0f172a;--muted:#64748b;--line:#e5e7eb;--brand:#2563eb;--r:18px}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);padding:18px 18px}
    .row{display:flex;gap:14px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .btn{appearance:none;border:0;border-radius:999px;padding:12px 16px;background:var(--brand);color:#fff;font-weight:700;cursor:pointer}
    .btn2{background:#111827}
    .pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:8px 12px;background:#fff;color:#111827}
    .muted{color:var(--muted)}
    pre{white-space:pre-wrap;background:#0b1324;color:#e6f0ff;padding:12px;border-radius:12px;overflow:auto}
    .plans{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin-top:12px}
    .plan{border:1px solid var(--line);border-radius:14px;padding:12px;cursor:pointer;background:#fff}
    .plan.active{outline:2px solid var(--brand)}
    @media (max-width:820px){.plans{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="row">
      <div>
        <div style="font-size:22px;font-weight:900">BookWide 結帳</div>
        <div class="muted" id="who">尚未登入</div>
      </div>
      <div class="row">
        <span class="pill" id="refPill">推薦碼：-</span>
        <button class="btn2 btn" id="backHome" type="button">回首頁</button>
      </div>
    </div>

    <div class="plans" id="plans">
      <div class="plan" data-period="month">
        <div style="font-weight:900">月方案</div>
        <div class="muted">NT$ 1,000</div>
      </div>
      <div class="plan" data-period="half">
        <div style="font-weight:900">半年方案</div>
        <div class="muted">NT$ 5,400</div>
      </div>
      <div class="plan" data-period="year">
        <div style="font-weight:900">一年方案</div>
        <div class="muted">NT$ 9,600</div>
      </div>
    </div>

    <div class="row" style="margin-top:14px">
      <button class="btn" id="pay" type="button">前往綠界付款</button>
      <div class="muted" id="note"></div>
    </div>

    <div style="margin-top:12px;display:none" id="debugBox">
      <pre id="log"></pre>
    </div>

    <div id="mount"></div>
  </div>
</div>

<script>
  // ====== 固定：你的專案 ======
  const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = (id)=>document.getElementById(id);
  const log = (s)=>{
    $("debugBox").style.display="block";
    $("log").textContent += s + "\n";
  };

  function normalizePlan(v){
    v = (v||"").toLowerCase();
    if (v==="monthly"||v==="month") return "month";
    if (v==="half"||v==="semi"||v==="6m"||v==="halfyear") return "half";
    if (v==="year"||v==="yearly"||v==="12m") return "year";
    return "month";
  }
  function getReferral(){
    const q = new URLSearchParams(location.search);
    const ref = q.get("ref") || q.get("referral_code") || localStorage.getItem("bookwide_referral") || "";
    if (ref) localStorage.setItem("bookwide_referral", ref);
    return ref || null;
  }
  function setActivePeriod(period){
    document.querySelectorAll(".plan").forEach(el=>{
      el.classList.toggle("active", el.dataset.period===period);
    });
    localStorage.setItem("bookwide_plan", period);
  }
  function submitEcpay(actionUrl, params){
    const mount = $("mount");
    mount.innerHTML = "";
    const form = document.createElement("form");
    form.method = "post";
    form.action = actionUrl;
    Object.keys(params).forEach(k=>{
      const inp=document.createElement("input");
      inp.type="hidden"; inp.name=k; inp.value=String(params[k]??"");
      form.appendChild(inp);
    });
    mount.appendChild(form);
    form.submit();
  }

  $("backHome").onclick = ()=>location.href="/index.html";

  // init selected plan
  const q = new URLSearchParams(location.search);
  const initPeriod = normalizePlan(q.get("plan") || localStorage.getItem("bookwide_plan") || "month");
  setActivePeriod(initPeriod);
  document.querySelectorAll(".plan").forEach(el=>{
    el.onclick = ()=>setActivePeriod(el.dataset.period);
  });

  // referral pill
  const ref = getReferral();
  $("refPill").textContent = "推薦碼：" + (ref || "-");

  // show current user
  (async ()=>{
    const { data: { session } } = await sb.auth.getSession();
    if (!session?.user) return;
    $("who").textContent = session.user.email || session.user.id;
  })();

  $("pay").onclick = async ()=>{
    $("debugBox").style.display="none";
    $("log").textContent = "";
    $("note").textContent = "";

    const { data: { session } } = await sb.auth.getSession();
    if (!session?.access_token){
      $("note").textContent = "請先登入（右上要出現 email）";
      return;
    }

    const period = localStorage.getItem("bookwide_plan") || "month";
    const referral_code = getReferral();

    log("calling create-ecpay-order...");
    const res = await fetch(`${SUPABASE_URL}/functions/v1/create-ecpay-order`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "apikey": SUPABASE_ANON_KEY,
        "Authorization": `Bearer ${session.access_token}`,
      },
      body: JSON.stringify({ period, referral_code })
    });

    const j = await res.json().catch(()=>null);
    if (!res.ok || !j?.ok){
      log("FAILED:");
      log(JSON.stringify(j, null, 2));
      $("note").textContent = "建立訂單失敗（請看下方 log）";
      return;
    }

    log("OK -> submit to ecpay");
    log("action_url=" + j.action_url);
    submitEcpay(j.action_url, j.params);
  };
</script>
</body>
</html>



















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































