<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BookWide｜結帳（整合版：模擬付款＋列印帳單）</title>

  <!-- 和 subscription.html 一樣的 Supabase 設定 -->
  <script>
    // 由你的全站注入，或在此直接指定
    window.SB_URL  = window.SB_URL  || "https://jeajrwpmrgczimmrflxo.supabase.co";
    window.SB_ANON = window.SB_ANON || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do"; // ← 用 subscription.html 裡那一串取代
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{--fg:#111;--bg:#fff;--muted:#666;--line:#e6e6e6;--ok:#0a7f2e;--bad:#b2172e}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.65 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:22px}
    header{display:flex;align-items:center;justify-content:space-between;margin:6px 0 16px}
    header a{color:var(--muted);text-decoration:none;border:1px solid var(--line);padding:6px 10px;border-radius:8px}
    h1{font-size:28px;margin:6px 0 2px}
    .badge{display:inline-block;border:1px solid #ccc;border-radius:999px;padding:1px 8px;font-size:12px;color:#444;background:#fafafa}

    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }

    .card{border:1px solid var(--line);border-radius:12px;background:#fff;padding:16px}
    .title{font-size:18px;font-weight:700;margin:0 0 10px}
    .row{display:flex;justify-content:space-between;gap:10px;margin:8px 0}
    .total{font-size:22px;font-weight:800}
    .muted{color:var(--muted)}
    .tag{display:inline-block;border:1px solid #ddd;border-radius:999px;padding:2px 8px;margin:0 6px 6px 0;background:#fff}

    .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    button{appearance:none;border:1px solid #111;background:#111;color:#fff;padding:11px 14px;border-radius:8px;cursor:pointer}
    button.ghost{background:#fff;color:#111}
    button.ok{background:var(--ok);border-color:var(--ok)}
    button.bad{background:var(--bad);border-color:var(--bad)}

    @media print{
      body *{visibility:hidden !important}
      #bw-receipt, #bw-receipt *{visibility:visible !important}
      #bw-receipt{position:absolute;inset:0;margin:0;padding:0}
    }

    #bw-receipt{font-family: system-ui, -apple-system, "Noto Sans TC","PingFang TC","Microsoft JhengHei", Arial, sans-serif}
    .bw-rec{max-width:900px;margin:0 auto;padding:24px;color:#111;background:#fff}
    .bw-meta{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:6px 16px;margin:.25rem 0 1rem}
    .bw-table{width:100%;border-collapse:collapse}
    .bw-table th,.bw-table td{border:1px solid #e5e5e5;padding:.6rem .7rem}
    .bw-table thead th{background:#fafafa}
    .bw-note{color:#666;margin-top:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <a href="./pricing.html">← 返回方案與定價</a>
      <span class="badge">模擬付款模式（不連線金流）</span>
    </header>

    <h1>結帳</h1>
    <p class="muted">帳號：<span id="user-email">未登入</span></p>

    <div class="grid">
      <section class="card">
        <h2 class="title">訂單摘要</h2>
        <div class="row"><span>方案</span><b id="sum-plan">—</b></div>
        <div class="row" style="align-items:center">
          <span>主題</span>
          <span id="sum-topics" style="text-align:right"></span>
        </div>
        <div class="row"><span>小計</span><b id="sum-subtotal">NT$0</b></div>
        <div class="row"><span>推薦折扣（10%）</span><b id="sum-discount">NT$0</b></div>
        <div class="row"><span>稅額（5%）</span><b id="sum-tax">NT$0</b></div>
        <div class="row total"><span>應付金額</span><span id="sum-total">NT$0</span></div>

        <div class="actions">
          <button id="btn-success" class="ok">模擬付款成功</button>
          <button id="btn-fail" class="bad">模擬付款失敗</button>
          <button id="btn-print" class="ghost">列印帳單 / 存 PDF</button>
        </div>
        <p class="muted" id="status"></p>
      </section>

      <aside class="card">
        <h2 class="title">帳單預覽</h2>
        <div class="muted">列印時會只輸出帳單區塊</div>
        <ul id="bill-items" style="margin:10px 0 0 18px;padding:0"></ul>
      </aside>
    </div>
  </div>

  <!-- 列印帳單模板（平時隱藏） -->
  <section id="bw-receipt" hidden>
    <div class="bw-rec">
      <h2>BookWide 訂購帳單</h2>
      <div class="bw-meta">
        <div>訂單編號：<span id="rec-order-id"></span></div>
        <div>訂購日期：<span id="rec-date"></span></div>
        <div>付款方式：<span id="rec-paymethod">mock</span></div>
        <div>帳號 Email：<span id="rec-email">—</span></div>
      </div>
      <table class="bw-table" aria-label="品項明細">
        <thead>
          <tr><th style="text-align:left">品項</th><th>方案</th><th>數量</th><th>單價</th><th>小計</th></tr>
        </thead>
        <tbody id="rec-items"></tbody>
        <tfoot>
          <tr><td colspan="4" style="text-align:right">小計</td><td id="rec-subtotal"></td></tr>
          <tr><td colspan="4" style="text-align:right">折扣</td><td id="rec-discount"></td></tr>
          <tr><td colspan="4" style="text-align:right">稅額 (5%)</td><td id="rec-tax"></td></tr>
          <tr><td colspan="4" style="text-align:right;font-weight:700">總計</td><td id="rec-total" style="font-weight:700"></td></tr>
        </tfoot>
      </table>
      <p class="bw-note">※ 本單供個人留存；實際付款以金流完成為準。</p>
    </div>
  </section>

  <script>
  (function(){
    const supabase = window.supabase.createClient(window.SB_URL, window.SB_ANON);

    const $ = (q)=>document.querySelector(q);
    const money = (n)=>'NT$' + (Number(n)||0).toLocaleString('zh-TW');
    const uuid = ()=>crypto.randomUUID ? crypto.randomUUID() :
      'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
        const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16)
      });

    const usp = new URLSearchParams(location.search);
    const titleMap = {
      story:'故事 Story', music:'音樂 Music', movie:'電影 Movie',
      news:'新聞 News', pro:'專業行業 Professional'
    };

    const topics = (usp.get('topics')||usp.get('items')||'').split(',').filter(Boolean);
    const plan   = usp.get('plan') || usp.get('period') || 'month';
    const ref    = usp.get('ref') || usp.get('ref_code') || '';

    const unitPriceNT = { month:200, half:960, year:1680 };
    const qty = Math.max(1, topics.length || 1);
    const subtotal = (unitPriceNT[plan] || 200) * qty;
    const discount = ref ? Math.round(subtotal * 0.10) : 0;
    const tax      = Math.round(Math.max(0, subtotal - discount) * 0.05);
    const total    = Math.max(0, subtotal - discount) + tax;

    const subtotalCents = subtotal * 100;
    const discountCents = discount * 100;
    const totalCents    = total * 100;
    const unitPriceCents = (unitPriceNT[plan] || 200) * 100;

    const orderId = uuid();

    async function getUser(){
      try{
        const { data, error } = await supabase.auth.getUser();
        if(error){ console.warn('getUser error', error); return null; }
        return data?.user || null;
      }catch(e){
        console.error(e);
        return null;
      }
    }

    // 顯示登入 email
    (async ()=>{
      const u = await getUser();
      if(u?.email) $('#user-email').textContent = u.email;
    })();

    // 顯示摘要 / 預覽
    function renderSummary(){
      $('#sum-plan').textContent = ({month:'月繳',half:'半年',year:'年繳'})[plan] || plan;
      if (topics.length){
        $('#sum-topics').innerHTML = topics.map(t=>`<span class="tag">${titleMap[t]||t}</span>`).join('');
      }else{
        $('#sum-topics').textContent = '（未選擇主題，預設 1 主題）';
      }
      $('#sum-subtotal').textContent = money(subtotal);
      $('#sum-discount').textContent = '-' + money(discount);
      $('#sum-tax').textContent      = money(tax);
      $('#sum-total').textContent    = money(total);

      const ul = $('#bill-items'); ul.innerHTML = '';
      const list = topics.length ? topics : ['story'];
      list.forEach(k=>{
        const li = document.createElement('li');
        li.textContent = (titleMap[k]||k) + ' × 1';
        ul.appendChild(li);
      });
    }
    renderSummary();

    // 計算「新的到期日」：如果原本還沒到期，從原到期往後加；不然從今天算
    async function calcNewExpire(userId){
      const monthsMap = { month:1, half:6, year:12 };
      const addMonths = monthsMap[plan] || 1;

      let base = new Date();
      try{
        const { data: prof } = await supabase
          .from('profiles')
          .select('expires_at')
          .eq('id', userId)
          .maybeSingle();
        if (prof?.expires_at){
          const old = new Date(prof.expires_at);
          if (old > base) base = old;
        }
      }catch(e){
        console.warn('fetch profile for expire failed', e);
      }
      base.setMonth(base.getMonth() + addMonths);
      return base.toISOString();
    }

    async function writeOrder(status){
      const user = await getUser();
      if(!user){
        $('#status').textContent = '請先登入後再結帳。';
        return false;
      }

      const nowISO    = new Date().toISOString();
      const expireISO = status === 'paid' ? await calcNewExpire(user.id) : null;
      const itemsArr  = topics.length ? topics : ['story'];
      const emailTo   = user.email || null;

      const payload = {
        id: orderId,
        user_id: user.id,
        buyer_id: user.id,
        items: itemsArr,
        period: plan,
        unit_price: unitPriceCents,
        quantity: qty,
        subtotal: subtotal,
        discount: discount,
        total: total,
        subtotal_cents: subtotalCents,
        discount_cents: discountCents,
        commission_cents: 0,
        total_cents: totalCents,
        ref_code: ref || null,
        referral_code: ref || null,
        status: status,
        paid_at: status === 'paid' ? nowISO : null,
        expire_at: expireISO,
        created_at: nowISO,
        email_to: emailTo
      };

      try{
        const { error } = await supabase.from('orders').insert(payload);
        if(error){
          $('#status').textContent = '寫入 orders 失敗：' + (error.message||error);
          return false;
        }

        // 付款成功時，同步更新 profiles.expires_at / plan_name，讓 admin 及提醒系統使用
        if (status === 'paid' && expireISO){
          const itemsLabel = itemsArr.join(', ');
          const planLabel  = `${itemsLabel} / ${plan}`;
          await supabase.from('profiles')
            .update({
              expires_at: expireISO,
              plan_name: planLabel,
              plan: plan
            })
            .eq('id', user.id);
        }

        $('#status').textContent = (status==='paid')
          ? '✅ 已寫入訂單（paid），即將跳轉到「我的訂閱」。'
          : '❗ 已寫入訂單（failed）。';
        return true;
      }catch(e){
        $('#status').textContent = '寫入 orders 例外：' + e;
        return false;
      }
    }

    function renderInvoice(){
      $('#rec-order-id').textContent = orderId;
      $('#rec-date').textContent     = new Date().toLocaleString('zh-TW',{hour12:false});
      $('#rec-email').textContent    = $('#user-email').textContent || '—';

      const tbody = $('#rec-items'); tbody.innerHTML = '';
      const list = topics.length ? topics : ['story'];
      list.forEach(key=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="text-align:left">${titleMap[key]||key}</td>
          <td>${({month:'月繳',half:'半年',year:'年繳'})[plan]||plan}</td>
          <td>1</td>
          <td>${money(unitPriceNT[plan]||200)}</td>
          <td>${money(unitPriceNT[plan]||200)}</td>`;
        tbody.appendChild(tr);
      });
      $('#rec-subtotal').textContent = money(subtotal);
      $('#rec-discount').textContent = '-' + money(discount);
      $('#rec-tax').textContent      = money(tax);
      $('#rec-total').textContent    = money(total);
    }

    // === 事件 ===
    $('#btn-success').addEventListener('click', async ()=>{
      $('#status').textContent = '處理中…';
      const ok = await writeOrder('paid');
      if (ok){
        setTimeout(()=>{ location.href = '/account/subscription.html'; }, 800);
      }
    });
    $('#btn-fail').addEventListener('click', async ()=>{
      $('#status').textContent = '處理中…';
      await writeOrder('failed');
    });
    $('#btn-print').addEventListener('click', ()=>{
      renderInvoice();
      const sec = $('#bw-receipt'); sec.hidden = false;
      window.print();
      setTimeout(()=>{ sec.hidden = true; }, 200);
    });
  })();
  </script>
</body>
</html>











