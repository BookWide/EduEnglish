<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(async function(){
  const UNIT = { month:200, half:960, year:1680 };
  const PERIOD_TEXT = { month:'æœˆ', half:'åŠå¹´', year:'å¹´' };
  const DISCOUNT_RATE = 0.9;

  // Supabase åˆå§‹åŒ–ï¼ˆè«‹ä¿ç•™ä½ åŸæœ¬çš„ SB_URL / SB_ANONï¼‰
  const supabase = window.supabase.createClient(window.SB_URL, window.SB_ANON);
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return alert("è«‹å…ˆç™»å…¥å¸³è™Ÿå¾Œå†çµå¸³");

  // URL åƒæ•¸
  const usp = new URLSearchParams(location.search);
  const items = (usp.get('items')||'').split(',').map(s=>s.trim()).filter(Boolean);
  const period = usp.get('period') || 'month';
  const refCode = (usp.get('ref')||'').trim() || null;

  if (!items.length){ location.replace('./pricing.html'); return; }

  // DOM
  const elPeriod = document.getElementById('periodLabel');
  const elItems = document.getElementById('itemsChips');
  const elRef = document.getElementById('refLabel');
  const elLineItems = document.getElementById('lineItems');
  const elSubtotal = document.getElementById('subtotal');
  const elRowDiscount = document.getElementById('rowDiscount');
  const elDiscount = document.getElementById('discount');
  const elGrand = document.getElementById('grand');
  const btnPay = document.getElementById('btnPay');

  // é¡¯ç¤ºè³‡æ–™
  elPeriod.textContent = PERIOD_TEXT[period] || 'æœˆ';
  elItems.innerHTML = items.map(it=>`<span class="chip">${it}</span>`).join('');
  if (refCode){
    elRef.textContent = refCode;
    elRef.classList.remove('muted');
    elRef.classList.add('chip');
  }

  const unit = UNIT[period] ?? 200;
  elLineItems.innerHTML = items.map(it=>(
    `<div class="row"><div>${it}</div><div class="price">$${unit}</div></div>`
  )).join('');

  const subtotal = unit * items.length;
  let discountAmt = 0;
  if (refCode){
    const grandX = Math.round(subtotal * DISCOUNT_RATE);
    discountAmt = subtotal - grandX;
    elRowDiscount.style.display = '';
    elDiscount.textContent = `-$${discountAmt}`;
  }
  const grand = subtotal - discountAmt;
  elSubtotal.textContent = `$${subtotal}`;
  elGrand.textContent = `$${grand}`;

  // === ç¢ºèªä»˜æ¬¾æŒ‰éˆ• ===
  btnPay.addEventListener('click', async ()=>{
    btnPay.disabled = true;

    try {
      // 1ï¸âƒ£ å»ºç«‹è¨‚å–®ï¼ˆcreate-orderï¼‰
      const { data: session } = await supabase.auth.getSession();
      const res1 = await fetch('/functions/v1/create-order', {
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'Authorization':`Bearer ${session?.session?.access_token || ''}`
        },
        body: JSON.stringify({ items, period, ref: refCode })
      });
      const data1 = await res1.json();
      if (!res1.ok) throw new Error(data1.error || 'å»ºç«‹è¨‚å–®å¤±æ•—');

      const orderId = data1.order.id;
      console.log('ğŸ§¾ å·²å»ºå–®', orderId);

      // 2ï¸âƒ£ å‘¼å« create-ecpay-orderï¼ˆè‡ªå‹•å°å‘ç¶ ç•Œï¼‰
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/functions/v1/create-ecpay-order';
      form.innerHTML = `<input type="hidden" name="order_id" value="${orderId}">`;
      document.body.appendChild(form);
      form.submit();
    } catch(err){
      alert('âŒ ä»˜æ¬¾å•Ÿå‹•å¤±æ•—ï¼š' + err.message);
      btnPay.disabled = false;
    }
  });
})();
</script>





