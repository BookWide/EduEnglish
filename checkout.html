<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>BookWide 訂閱結帳</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{
      --bg:#0b1324;
      --panel:#0f172a;
      --border:#1f2a44;
      --ink:#e6f0ff;
      --muted:#9fb0c9;
      --accent:#3c7cff;
      --danger:#f97373;
      --ok:#22c55e;
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Noto Sans TC",sans-serif;
      background:var(--bg);
      color:var(--ink);
    }
    body{
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:24px 12px 48px;
    }
    .shell{
      width:100%;
      max-width:960px;
      background:var(--panel);
      border-radius:18px;
      border:1px solid var(--border);
      box-shadow:0 18px 40px rgba(0,0,0,.45);
      overflow:hidden;
    }
    header{
      padding:14px 20px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:16px;
    }
    header h1{
      margin:0;
      font-size:18px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    header h1 span.logo{
      width:26px;
      height:26px;
      border-radius:9px;
      background:linear-gradient(135deg,#3c7cff,#4ade80);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      font-size:15px;
    }
    header .right{
      font-size:13px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    header .right .pill{
      border-radius:999px;
      border:1px solid var(--border);
      padding:3px 9px;
      font-size:12px;
    }
    main{
      display:flex;
      flex-wrap:wrap;
    }
    .col{
      padding:18px 20px 22px;
    }
    .left{
      flex:0 0 55%;
      border-right:1px solid var(--border);
      min-width:260px;
    }
    .right{
      flex:1;
      min-width:260px;
    }
    .sec-title{
      font-size:15px;
      font-weight:600;
      margin-bottom:10px;
    }
    .muted{
      color:var(--muted);
      font-size:13px;
    }
    .plan-tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:12px;
      margin-top:4px;
    }
    .plan-tag span.dot{
      width:8px;
      height:8px;
      border-radius:999px;
      background:var(--accent);
    }
    .list{
      margin-top:14px;
      font-size:14px;
    }
    .list-row{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
      padding:6px 0;
    }
    .list-row .label{
      color:var(--muted);
      font-size:13px;
    }
    .list-row .value{
      text-align:right;
    }
    .list-row .value strong{
      font-weight:600;
    }
    hr.sep{
      border:none;
      border-top:1px dashed var(--border);
      margin:14px 0;
    }
    .price{
      font-size:18px;
      font-weight:600;
    }
    .tax-note{
      font-size:12px;
      color:var(--muted);
      margin-top:3px;
    }
    .btn-row{
      display:flex;
      gap:8px;
      margin-top:16px;
      flex-wrap:wrap;
    }
    button{
      border:none;
      cursor:pointer;
      font:inherit;
    }
    .btn-primary{
      background:var(--accent);
      color:#fff;
      padding:9px 16px;
      border-radius:10px;
      font-size:14px;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn-primary:disabled{
      opacity:.6;
      cursor:default;
    }
    .btn-ghost{
      background:transparent;
      color:var(--muted);
      padding:8px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      font-size:13px;
    }
    .status-line{
      margin-top:12px;
      font-size:13px;
      color:var(--muted);
      min-height:17px;
    }
    .status-line.ok{color:var(--ok);}
    .status-line.err{color:var(--danger);}
    .invoice-card{
      border-radius:14px;
      border:1px solid var(--border);
      padding:14px 13px 12px;
      background:rgba(15,23,42,.88);
      font-size:13px;
    }
    .invoice-row{
      display:flex;
      justify-content:space-between;
      margin:3px 0;
      gap:8px;
    }
    .invoice-row .l{color:var(--muted);}
    .invoice-row .r{text-align:right;}
    .invoice-row.total{
      margin-top:10px;
      padding-top:10px;
      border-top:1px dashed var(--border);
      font-weight:600;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(15,23,42,.95);
      margin-top:6px;
    }
    .badge .dot{
      width:7px;
      height:7px;
      border-radius:999px;
      background:var(--ok);
    }
    .small{
      font-size:12px;
      color:var(--muted);
    }
    .mock-box{
      margin-top:12px;
      padding:8px 10px;
      border-radius:10px;
      background:rgba(15,23,42,.8);
      border:1px dashed var(--border);
      font-size:12px;
      color:var(--muted);
    }
    .mock-box button{
      margin-top:5px;
      margin-right:6px;
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--ink);
    }
    footer{
      padding:10px 18px 14px;
      border-top:1px solid var(--border);
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
    }
    a{
      color:var(--accent);
      text-decoration:none;
    }
    @media (max-width:768px){
      header{
        flex-direction:column;
        align-items:flex-start;
      }
      .left{
        flex:1 1 100%;
        border-right:none;
        border-bottom:1px solid var(--border);
      }
      .right{
        flex:1 1 100%;
      }
      body{
        padding:12px 8px 28px;
      }
      .shell{
        border-radius:14px;
      }
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <h1>
        <span class="logo">B</span>
        <span>BookWide 訂閱結帳</span>
      </h1>
      <div class="right">
        <span id="userEmail" class="pill">尚未登入</span>
        <span class="pill">安全加密傳輸</span>
      </div>
    </header>
    <main>
      <section class="col left">
        <div class="sec-title">方案確認</div>
        <div class="muted" id="planSummary">載入中...</div>
        <div class="plan-tag">
          <span class="dot"></span>
          <span id="planLabel">方案資訊</span>
        </div>

        <div class="list" id="priceBox">
          <div class="list-row">
            <div class="label">訂閱週期</div>
            <div class="value"><span id="periodLabel">month</span></div>
          </div>
          <div class="list-row">
            <div class="label">內容類別</div>
            <div class="value"><span id="topicLabel">story</span></div>
          </div>
          <hr class="sep">
          <div class="list-row">
            <div class="label">小計</div>
            <div class="value"><span id="subtotalLabel">-</span></div>
          </div>
          <div class="list-row">
            <div class="label">稅額</div>
            <div class="value"><span id="taxLabel">-</span></div>
          </div>
          <div class="list-row">
            <div class="label"><strong>總金額</strong></div>
            <div class="value"><strong class="price" id="totalLabel">-</strong></div>
          </div>
          <div class="tax-note" id="taxNote"></div>
        </div>

        <div class="btn-row">
          <button id="btnPay" class="btn-primary">
            <span>前往付款 / 模擬付款</span>
          </button>
          <button id="btnBack" class="btn-ghost" type="button">返回方案選擇</button>
        </div>
        <div id="status" class="status-line"></div>

        <div class="mock-box">
          <div>目前尚未接上正式綠界金流，按下「前往付款 / 模擬付款」會直接執行 <code>mock paid</code> 流程。</div>
          <button id="btn-mock-success" type="button">模擬付款成功（paid）</button>
          <button id="btn-mock-fail" type="button">模擬付款失敗（failed）</button>
        </div>
      </section>

      <section class="col right">
        <div class="sec-title">訂單摘要 / 發票</div>
        <div id="invoiceCard" class="invoice-card">
          <div class="invoice-row">
            <div class="l">訂單編號</div>
            <div class="r" id="invId">尚未建立</div>
          </div>
          <div class="invoice-row">
            <div class="l">帳號</div>
            <div class="r" id="invEmail">-</div>
          </div>
          <div class="invoice-row">
            <div class="l">方案</div>
            <div class="r" id="invPlan">-</div>
          </div>
          <div class="invoice-row">
            <div class="l">週期</div>
            <div class="r" id="invPeriod">-</div>
          </div>
          <div class="invoice-row total">
            <div class="l">總金額</div>
            <div class="r" id="invTotal">-</div>
          </div>
          <div class="badge" id="orderBadge" style="display:none;">
            <span class="dot"></span>
            <span id="badgeText">訂單已建立</span>
          </div>
          <div class="small" style="margin-top:8px;">
            建議截圖或列印本頁，做為訂閱成功紀錄。正式發票及收據將由會計系統另行提供。
          </div>
        </div>
      </section>
    </main>
    <footer>
      <span>BookWide © 2025</span>
      <span>如有訂閱或付款問題，請來信 <a href="mailto:support@bookwide.net">support@bookwide.net</a></span>
    </footer>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const $ = (sel)=>document.querySelector(sel);
    const urlParams = new URLSearchParams(location.search);
    let sb = null;
    let user = null;

    // 從 query 讀取方案資訊
    let plan = urlParams.get("period") || "month";
    let topicsParam = urlParams.get("topics") || "story";
    let topics = topicsParam.split(",").map(x=>x.trim()).filter(Boolean);

    let subtotal = 0;
    let tax = 0;
    let total = 0;

    const priceTable = {
      month: 1000,
      halfyear: 5400,
      year: 9600
    };

    function formatNT(n){
      return "NT$" + n.toLocaleString("zh-TW");
    }

    async function initSupabase(){
      const url = "https://jeajrwpmrgczimmrflxo.supabase.co";
      const anon = "公開 anon key 已省略，實際請填入你專案的 anon key";
      try{
        sb = createClient(url, anon);
      }catch(e){
        console.error("createClient error", e);
        sb = null;
      }
    }

    async function getUser(){
      if(!sb) return null;
      if(user) return user;
      const { data, error } = await sb.auth.getUser();
      if(error){
        console.error("auth.getUser error", error);
        return null;
      }
      user = data.user || null;
      return user;
    }

    function pickPrice(){
      const base = priceTable[plan] || priceTable.month;
      subtotal = base;
      tax = 0;
      total = subtotal + tax;
    }

    function renderUI(){
      const topicLabel = topics.join("、") || "story";
      $("#topicLabel").textContent = topicLabel;
      $("#periodLabel").textContent = plan;
      $("#planLabel").textContent = `BookWide · ${plan}`;
      $("#planSummary").textContent = `您選擇了「${topicLabel}」主題，週期為 ${plan}。`;
      $("#subtotalLabel").textContent = formatNT(subtotal);
      $("#taxLabel").textContent = tax ? formatNT(tax) : "NT$0";
      $("#totalLabel").textContent = formatNT(total);
      $("#invPlan").textContent = topicLabel;
      $("#invPeriod").textContent = plan;
      $("#invTotal").textContent = formatNT(total);
      $("#taxNote").textContent = "目前僅示意金額，實際金額以後端為準。";
    }

    function uuid4(){
      return crypto.randomUUID ? crypto.randomUUID() :
        "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,c=>{
          const r=Math.random()*16|0,v=c==="x"?r:(r&0x3|0x8);
          return v.toString(16);
        });
    }

    function renderInvoice(orderId){
      $("#invId").textContent = orderId;
      $("#orderBadge").style.display = "inline-flex";
      $("#badgeText").textContent = "訂單已建立";
    }

    async function writeOrder(status){
      if(!sb){ $("#status").textContent = "（未載入 Supabase：以 mock 流程顯示）"; return true; }

      const u = await getUser();
      if(!u || !u.id){
        $("#status").textContent = "找不到登入使用者（user_id），無法寫入 orders";
        return false;
      }

      const items = (Array.isArray(topics) && topics.length) ? topics : ["story"];
      const period = plan || "month";
      const totalCents = Math.round((total || 0) * 100);
      const taxCents = Math.round((tax || 0) * 100);

      const payload = {
        user_id: u.id,
        buyer_id: u.id,
        items,
        period,
        status,
        currency: "TWD",
        unit_price_cents: totalCents,
        quantity: 1,
        subtotal_cents: totalCents,
        discount_cents: 0,
        tax_cents: taxCents,
        total_cents: totalCents + taxCents,
        email_to: u.email || null,
      };

      try{
        const resp = await fetch("https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/create-order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const result = await resp.json().catch(() => null);

        if(!resp.ok || !result?.ok){
          const msg = result?.error || (resp.status + " " + resp.statusText);
          $("#status").textContent = "寫入 orders 失敗：" + msg;
          return false;
        }

        $("#status").textContent = status === "paid"
          ? "✅ 已建立訂單並寫入 orders（paid），並已嘗試寄出 Email。"
          : "❗ 已建立訂單並寫入 orders（failed）。";
        return true;
      }catch(e){
        console.error("create-order error", e);
        $("#status").textContent = "寫入 orders 例外：" + e;
        return false;
      }
    }

    // ===== Print invoice =====
    function setStatus(msg, type="info"){
      const el = $("#status");
      el.textContent = msg;
      el.classList.remove("ok","err");
      if(type==="ok") el.classList.add("ok");
      if(type==="err") el.classList.add("err");
    }

    async function handleMock(status){
      setStatus("處理中...");
      const ok = await writeOrder(status);
      if(!ok){
        setStatus("寫入訂單失敗，請稍後再試。", "err");
        return;
      }
      const orderId = uuid4();
      renderInvoice(orderId);
      setStatus(status==="paid" ? "模擬付款成功，訂單已建立。" : "模擬付款失敗（仍寫入一筆 failed 訂單紀錄）。","ok");
    }

    async function main(){
      await initSupabase();
      pickPrice();
      renderUI();

      const u = await getUser();
      if(u){
        $("#userEmail").textContent = u.email || u.id;
        $("#invEmail").textContent = u.email || "-";
      }else{
        $("#userEmail").textContent = "尚未登入（請先從首頁登入）";
      }

      $("#btnBack").addEventListener("click", ()=>{
        location.href = "pricing.html";
      });

      $("#btn-mock-success").addEventListener("click", ()=>handleMock("paid"));
      $("#btn-mock-fail").addEventListener("click", ()=>handleMock("failed"));

      $("#btnPay").addEventListener("click", ()=>handleMock("paid"));
    }

    main();
  </script>
</body>
</html>













