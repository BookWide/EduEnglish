<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BookWide｜結帳</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#f4f6fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
  --brand:#2563eb; --danger:#b91c1c;
  --radius:18px;
}
*{box-sizing:border-box}
body{
  margin:0;background:var(--bg);color:var(--ink);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans TC","Microsoft JhengHei",sans-serif
}
.wrap{max-width:1100px;margin:auto;padding:24px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
.pill{padding:8px 14px;border:1px solid var(--line);border-radius:999px;background:#fff}
.card{background:#fff;border-radius:var(--radius);padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
.grid{display:grid;grid-template-columns:1.2fr .8fr;gap:24px}
.plan{border:1px solid var(--line);border-radius:14px;padding:16px;cursor:pointer}
.plan.active{border-color:var(--brand);box-shadow:0 0 0 3px rgba(37,99,235,.15)}
.btn{padding:14px 22px;border-radius:999px;border:none;cursor:pointer}
.btn.primary{background:var(--brand);color:#fff}
.btn.secondary{background:#fff;border:1px solid var(--line)}
.msg{margin-top:12px;padding:12px;border-radius:12px}
.msg.err{background:#fee2e2;color:var(--danger)}
.small{font-size:13px;color:var(--muted)}
.price{font-size:22px;font-weight:800}
hr{border:none;border-top:1px solid var(--line);margin:16px 0}
</style>
</head>

<body>
<div class="wrap">

<header>
  <a class="pill" href="/index.html">← 回首頁</a>
  <div id="who" class="pill">未登入</div>
  <a class="pill" href="/account/subscription.html">我的訂閱 →</a>
</header>

<h1>結帳</h1>
<p class="small">付款金額以後端 create-ecpay-order 計算為準</p>

<div class="grid">
  <!-- LEFT -->
  <div class="card">
    <div><b>課程</b>：<span id="topicsText"></span></div>
    <div style="margin-top:6px"><b>方案</b>：<span id="planText"></span></div>
    <div style="margin-top:6px"><b>推薦碼</b>：<span id="refText">—</span></div>

    <hr>

    <div id="plans">
      <div class="plan" data-plan="month">
        <div>月方案</div>
        <div class="price">NT$ 1,000</div>
      </div>
      <div class="plan" data-plan="half">
        <div>半年方案</div>
        <div class="price">NT$ 5,400</div>
      </div>
      <div class="plan" data-plan="year">
        <div>一年方案</div>
        <div class="price">NT$ 9,600</div>
      </div>
    </div>

    <hr>

    <button id="btnPay" class="btn primary">綠界付款</button>
    <button onclick="history.back()" class="btn secondary">返回上一頁</button>

    <div id="msg" style="display:none" class="msg err"></div>
  </div>

  <!-- RIGHT -->
  <div class="card">
    <h2>本次應付</h2>
    <div id="payText" class="price">—</div>
    <hr>
    <div class="small">
      • 金額含推薦折扣（若有）<br>
      • 金額會 100% 送到綠界 TotalAmount
    </div>
  </div>
</div>

</div>

<script>
/* ===== Supabase ===== */
const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
const SUPABASE_ANON_KEY = "⚠️你的 anon key";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== Edge Function ===== */
const FN_CREATE = `${SUPABASE_URL}/functions/v1/create-ecpay-order`;

const $ = id => document.getElementById(id);

/* ===== Query ===== */
const q = new URL(location.href).searchParams;
const topics = (q.get("topics") || "").split(",").filter(Boolean);
const ref = q.get("ref");
let plan = q.get("plan") || "month";

/* ===== UI ===== */
$("topicsText").textContent = topics.join(", ");
$("refText").textContent = ref || "—";

function setPlan(p){
  plan = p;
  $("planText").textContent =
    p==="half"?"半年方案":p==="year"?"一年方案":"月方案";
  document.querySelectorAll(".plan").forEach(el=>{
    el.classList.toggle("active", el.dataset.plan===p);
  });
}
setPlan(plan);

$("plans").onclick = e=>{
  const el = e.target.closest(".plan");
  if(!el) return;
  setPlan(el.dataset.plan);
};

/* ===== Auth ===== */
let currentUser = null;

(async ()=>{
  const { data } = await sb.auth.getUser();
  currentUser = data.user;
  if(!currentUser){
    $("who").textContent="未登入";
    $("btnPay").disabled=true;
    $("msg").style.display="block";
    $("msg").textContent="請先登入後再付款";
  }else{
    $("who").textContent=currentUser.email;
  }
})();

/* ===== Pay ===== */
$("btnPay").onclick = async ()=>{
  try{
    $("msg").style.display="none";

    const payload = {
      user_id: currentUser.id,
      email: currentUser.email,
      period: plan,
      items: topics,
      referral_code: ref || null,
    };

    const res = await fetch(FN_CREATE,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":"Bearer " + (await sb.auth.getSession()).data.session.access_token
      },
      body:JSON.stringify(payload)
    });

    const out = await res.json();
    if(!res.ok || !out.ok) throw new Error(out.message || "create order failed");

    document.open();
    document.write(out.html);
    document.close();

  }catch(err){
    $("msg").style.display="block";
    $("msg").textContent=String(err);
  }
};
</script>
</body>
</html>
































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































