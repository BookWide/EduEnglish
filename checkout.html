<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  // ---- Supabase 設定 ----
  const SUPABASE_URL = 'https://jeajrwpmrgczimmrflxo.supabase.co';
  const SUPABASE_ANON_KEY =
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do';

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ========= 1. 讀取 URL 參數，統一格式 =========
  const params = new URLSearchParams(location.search);

  // topics / items → items[]
  const rawItemsParam = (params.get('items') || params.get('topics') || '').trim();
  const items = rawItemsParam
    ? rawItemsParam.split(',').map(s => s.trim()).filter(Boolean)
    : ['story']; // 沒帶就預設故事

  // plan / period → period（month / half / year）
  let period = (params.get('period') || params.get('plan') || 'month').trim();
  if (period === 'monthly') period = 'month';
  if (['halfyear', 'half-year', '6m'].includes(period)) period = 'half';
  if (['yearly', '12m'].includes(period)) period = 'year';

  // 每個主題的價格（你要改價只改這裡就好）
  function pricePerTopic(p) {
    switch (p) {
      case 'month': return 200;   // 月繳 200
      case 'half':  return 960;   // 半年 960
      case 'year':  return 1680;  // 年繳 1680
      default:      return 0;
    }
  }

  // amount：如果 URL 有帶就用 URL，沒有就用「主題數 × 單價」計算
  let amount = Number(params.get('amount') || '0');
  if (!amount || isNaN(amount)) {
    amount = pricePerTopic(period) * items.length;
  }

  // 推薦碼（可有可無）
  const refCode = (params.get('ref') || params.get('referral') || '').trim();

  // ========= 2. 顯示在畫面上 =========
  const itemsPillsEl = document.getElementById('itemsPills');
  const periodTextEl = document.getElementById('periodText');
  const priceTextEl = document.getElementById('priceText');
  const refTagEl = document.getElementById('refTag');

  function zhItemName(key) {
    switch (key) {
      case 'story': return '故事 Story';
      case 'music': return '音樂 Music';
      case 'movie': return '電影 Movie';
      case 'news':  return '新聞 News';
      case 'pro':   return '職場 Pro';
      default:      return key;
    }
  }

  function zhPeriod(p) {
    switch (p) {
      case 'month': return '月方案';
      case 'half':  return '半年方案';
      case 'year':  return '一年方案';
      default:      return p;
    }
  }

  items.forEach(k => {
    const pill = document.createElement('span');
    pill.className = 'pill';
    pill.textContent = zhItemName(k);
    itemsPillsEl.appendChild(pill);
  });

  periodTextEl.textContent = '方案期間：' + zhPeriod(period);
  priceTextEl.textContent = isNaN(amount) ? '—' : amount.toLocaleString() + ' 元';

  if (refCode) {
    refTagEl.style.display = 'inline-block';
    refTagEl.textContent = '推薦碼：' + refCode;
  }

  // ========= 3. 讀取登入使用者 =========
  const userEmailEl = document.getElementById('userEmail');
  const userHintEl = document.getElementById('userHint');
  const loginWarnEl = document.getElementById('loginWarn');
  const payBtn = document.getElementById('payBtn');
  const statusBox = document.getElementById('statusBox');

  let currentUser = null;

  async function loadUser() {
    const { data, error } = await supabase.auth.getUser();

    if (error || !data?.user) {
      currentUser = null;
      userEmailEl.textContent = '尚未登入';
      userHintEl.textContent = '請先登入後再結帳';
      loginWarnEl.style.display = 'block';
      payBtn.disabled = true;
      return;
    }

    currentUser = data.user;
    userEmailEl.textContent = currentUser.email || '(無 email)';
    userHintEl.textContent = '已登入，請確認下方方案再送出訂單';
    loginWarnEl.style.display = 'none';
    payBtn.disabled = false;
  }

  loadUser();

  // ========= 4. 按下「模擬付款並送出訂單」 =========
  async function handleMockPay() {
    if (!currentUser) {
      alert('請先登入後再結帳。');
      return;
    }

    statusBox.textContent = '正在建立訂單與寄出 Email…';
    statusBox.className = 'status';
    payBtn.disabled = true;

    const note = document.getElementById('noteInput').value.trim();

    const payload = {
      user_id: currentUser.id,
      email: currentUser.email,
      items,
      period,
      amount,            // ✅ 用剛才算好的金額
      referral_code: refCode || null,
      note: note || null,
      mock: true         // 告訴 Edge Function：這是模擬付款
    };

    try {
      const res = await fetch(
        'https://jeajrwpmrgczimmrflxo.functions.supabase.co/create-order',
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          },
          body: JSON.stringify(payload)
        }
      );

      const data = await res.json().catch(() => null);

      if (!res.ok) {
        console.error('create-order error', data || res.statusText);
        throw new Error(data?.message || `Edge Function 錯誤：${res.status}`);
      }

      statusBox.textContent = '✅ 訂單建立成功，Email 已寄出，準備前往訂閱狀態頁…';
      statusBox.className = 'status ok';

      // 1.2 秒後轉到訂閱頁
      setTimeout(() => {
        const qs = new URLSearchParams({
          items: items.join(','),
          period,
          amount: String(amount),
          ref: refCode || ''
        });
        window.location.href = 'account/subscription.html?' + qs.toString();
      }, 1200);

    } catch (err) {
      console.error(err);
      statusBox.textContent = '❌ 建立訂單或寄信失敗：' + err.message;
      statusBox.className = 'status bad';
      payBtn.disabled = false;
    }
  }

  payBtn.addEventListener('click', handleMockPay);
</script>

















































