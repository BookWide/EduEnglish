<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>BookWide｜結帳</title>
  <style>
    :root{--bg:#0b1324;--panel:#0f172a;--border:#1f2a44;--ink:#e6efff;--muted:#9fb0c9;--accent:#22c55e}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,"Noto Sans TC"}
    .wrap{max-width:980px;margin:0 auto;padding:20px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px}
    h1{font-size:20px;margin:0 0 14px}
    .row{display:flex;justify-content:space-between;align-items:center;border-top:1px solid #14233d;padding:10px 0}
    .row:first-of-type{border-top:0}
    .muted{color:var(--muted)}
    .btn{display:inline-block;background:var(--accent);color:#001b0a;border:0;border-radius:12px;padding:12px 18px;font-weight:800;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .note{margin-top:10px;color:#9fb0c9}
    .hidden{display:none !important}
    .price{font-variant-numeric: tabular-nums}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>訂單摘要</h1>
    <div id="summary" class="card">
      <div class="row"><div>方案：<span id="planTags" class="muted">—</span></div><div>週期：<span id="termTag" class="muted">—</span></div></div>
      <div id="lines"></div>
      <div class="row"><div>小計</div><div id="subtotal" class="price">$0</div></div>
      <div class="row" id="discountRow" hidden><div>折扣</div><div id="discount" class="price">-$0</div></div>
      <div class="row"><div>稅額（0%）</div><div class="price">$0</div></div>
      <div class="row" style="font-weight:900;font-size:18px"><div>應付金額</div><div id="total" class="price">$0</div></div>
      <div id="refNote" class="note hidden"></div>
      <div style="margin-top:14px"><button id="btnPay" class="btn" type="button">確認付款</button></div>
      <div class="note">※ 按下確認付款後才會串接綠界。</div>
    </div>
  </div>

  <!-- 主邏輯（defer + cache bust） -->
  <script defer>
  (function(){
    const $ = (s, r=document)=>r.querySelector(s);

    // 讀參數
    const qs   = new URLSearchParams(location.search);
    const itemsParam = (qs.get('items')||'').trim();     // e.g. "story,music"
    const period     = (qs.get('period')||'month').trim(); // month | half | year
    const ref        = (qs.get('ref')||'').trim();       // 只有 URL 帶才算

    // 版面填入「方案」與「週期」
    const termMap = { month:'月', half:'半年', year:'年' };
    const itemNames = (itemsParam? itemsParam.split(','):[]).map(x=>x.trim()).filter(Boolean);
    $('#planTags').textContent = itemNames.length ? itemNames.join('、') : '—';
    $('#termTag').textContent  = termMap[period] || '月';

    // 安全處理推薦碼：有帶就存，沒帶就清
    try {
      if (ref) localStorage.setItem('ref_code', ref);
      else localStorage.removeItem('ref_code');
    } catch(_) {}

    // 價格（每主題 200 / 月）
    const PRICE = 200;
    const qty   = Math.max(1, itemNames.length || 1); // 至少 1 個主題
    const subtotal = PRICE * qty;
    const discount = ref ? Math.round(subtotal * 0.1) * -1 : 0; // 9 折
    const total    = subtotal + discount;

    // 顯示每個主題一行（純顯示用）
    const lines = $('#lines');
    lines.innerHTML = '';
    itemNames.forEach(name=>{
      const row = document.createElement('div');
      row.className='row';
      row.innerHTML = `<div>${name}</div><div class="price">$${PRICE}</div>`;
      lines.appendChild(row);
    });

    // 沒指定 items（例如只有單一方案）也要顯示一行
    if (!itemNames.length){
      const row = document.createElement('div');
      row.className='row';
      row.innerHTML = `<div>單一主題</div><div class="price">$${PRICE}</div>`;
      lines.appendChild(row);
    }

    // 小計 / 折扣 / 總計
    $('#subtotal').textContent = `$${subtotal}`;
    if (discount){
      $('#discount').textContent = `-$${Math.abs(discount)}`;
      $('#discountRow').hidden = false;
      $('#refNote').classList.remove('hidden');
      $('#refNote').textContent = `推薦碼：${ref}（已套用 9 折）`;
    }else{
      $('#discountRow').hidden = true;
      $('#refNote').classList.add('hidden');
      $('#refNote').textContent = '';
    }
    $('#total').textContent = `$${total}`;

    // 「確認付款」之後再串綠界
    $('#btnPay').addEventListener('click', (e)=>{
      e.preventDefault();
      // TODO: 在這裡接你原先的 goECPay / 產訂單程式
      // window.goECPay?.({ items: itemNames, period, total, ref });

      alert(`（示範）將導向綠界。\n主題：${itemNames.join(',')||'1個'}\n週期：${termMap[period]||'月'}\n金額：$${total}\n推薦碼：${ref||'（無）'}`);
    });
  })();
  </script>
</body>
</html>






