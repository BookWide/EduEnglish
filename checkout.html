<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BookWide｜結帳（整合版：模擬付款＋列印帳單）</title>

  <!-- ★ Supabase 設定：請把 anon key 換成你自己的 -->
  <meta name="supabase-url" content="https://jeajrwpmrgczimmrflxo.supabase.co" />
  <meta name="supabase-anon-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzd...6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do" />

  <script type="module" src="https://esm.sh/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --fg:#111;
      --bg:#fff;
      --muted:#666;
      --line:#e6e6e6;
      --brand:#111;
      --ok:#0a7f2e;
      --bad:#b2172e;
      --accent:#2574d9;
      --pill:#f7f7f7;
      --pill-border:#e0e0e0;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;
      padding:0;
      background:var(--bg);
      color:var(--fg);
      font:15px/1.7 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
    }
    body{
      min-height:100vh;
    }
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}

    header{
      border-bottom:1px solid var(--line);
      padding:14px 24px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    .logo{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:600;
      letter-spacing:0.04em;
    }
    .logo-main{
      font-size:18px;
    }
    .logo-sub{
      font-size:12px;
      color:var(--muted);
    }
    .header-right{
      display:flex;
      align-items:center;
      gap:12px;
      font-size:13px;
      color:var(--muted);
    }
    .pill{
      border-radius:999px;
      padding:4px 10px;
      border:1px solid var(--pill-border);
      background:var(--pill);
      font-size:12px;
      color:var(--muted);
    }

    .wrap{
      max-width:1080px;
      margin:0 auto;
      padding:20px 16px 40px;
    }

    .breadcrumb{
      font-size:12px;
      color:var(--muted);
      margin-bottom:12px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .breadcrumb a{color:var(--muted);}
    .breadcrumb a:hover{color:var(--accent);}
    .breadcrumb-right{
      margin-left:auto;
      font-size:12px;
    }

    .layout{
      display:grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
      gap:20px;
    }

    .card{
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      padding:18px 18px 16px;
      box-shadow:0 2px 4px rgba(0,0,0,.02);
    }
    .card-title-row{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      margin-bottom:6px;
      gap:10px;
    }
    .card-title{
      font-size:15px;
      font-weight:600;
    }
    .card-sub{
      font-size:12px;
      color:var(--muted);
    }
    .card-section-title{
      font-size:13px;
      font-weight:600;
      margin:14px 0 4px;
    }
    .card-section-title:first-of-type{
      margin-top:4px;
    }
    .field-row{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      padding:4px 0;
      border-bottom:1px dashed #f0f0f0;
      font-size:13px;
    }
    .field-row:last-child{
      border-bottom:none;
    }
    .field-label{
      color:var(--muted);
      min-width:80px;
    }
    .field-value{
      text-align:right;
      flex:1;
      padding-left:12px;
      font-weight:500;
    }
    .field-value-muted{
      color:var(--muted);
      font-weight:400;
    }

    .total-row{
      display:flex;
      justify-content:space-between;
      padding:8px 0;
      border-top:1px solid var(--line);
      font-size:14px;
      font-weight:600;
      margin-top:8px;
    }
    .total-label{
      color:var(--muted);
    }
    .total-amount{
      font-size:18px;
      letter-spacing:0.04em;
    }

    .note{
      font-size:12px;
      color:var(--muted);
      margin-top:10px;
      line-height:1.6;
    }

    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:12px;
    }
    button{
      border-radius:999px;
      border:1px solid transparent;
      padding:7px 16px;
      font-size:13px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:#f5f5f5;
      color:#111;
    }
    button.primary{
      background:#111;
      color:#fff;
    }
    button.secondary{
      background:#fff;
      border-color:var(--line);
    }
    button:disabled{
      opacity:.4;
      cursor:not-allowed;
    }

    .status-bar{
      margin-top:10px;
      font-size:12px;
      padding:6px 10px;
      border-radius:8px;
      background:#fafafa;
      border:1px dashed #e0e0e0;
      color:var(--muted);
    }
    .status-bar.ok{
      border-color:var(--ok);
      color:var(--ok);
      background:#f2fff5;
    }
    .status-bar.bad{
      border-color:var(--bad);
      color:var(--bad);
      background:#fff3f5;
    }

    /* 右側帳單預覽 */
    .invoice-header{
      display:flex;
      justify-content:space-between;
      margin-bottom:4px;
    }
    .invoice-title{
      font-weight:700;
    }
    .invoice-sub{
      font-size:11px;
      color:var(--muted);
    }
    table.invoice-table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      margin-top:8px;
    }
    table.invoice-table th,
    table.invoice-table td{
      border-bottom:1px solid #f1f1f1;
      padding:4px 2px;
    }
    table.invoice-table th{
      text-align:left;
      color:var(--muted);
      font-weight:500;
    }
    table.invoice-table td.num{
      text-align:right;
    }
    .invoice-foot{
      margin-top:8px;
      font-size:11px;
      color:var(--muted);
      line-height:1.5;
    }
    .invoice-meta{
      font-size:11px;
      color:var(--muted);
      margin-top:4px;
    }

    .sub-info{
      margin-top:10px;
      font-size:12px;
      padding:8px 10px;
      border-radius:8px;
      background:#fafafa;
      border:1px solid #eee;
    }
    .sub-info-title{
      font-weight:600;
      margin-bottom:2px;
    }
    .sub-info-row{
      display:flex;
      justify-content:space-between;
      padding:1px 0;
    }
    .sub-info-label{
      color:var(--muted);
    }
    .sub-info-value{
      font-weight:500;
    }

    .print-link{
      font-size:12px;
      margin-top:10px;
      text-align:right;
    }

    @media (max-width:900px){
      .layout{
        grid-template-columns:1fr;
      }
      .wrap{
        padding-inline:12px;
      }
    }
    @media (max-width:480px){
      header{
        padding-inline:14px;
      }
      .layout{
        gap:14px;
      }
      .card{
        padding-inline:14px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <div>
        <div class="logo-main">BookWide</div>
        <div class="logo-sub">EduEnglish 訂閱結帳</div>
      </div>
    </div>
    <div class="header-right">
      <span id="user-email" class="pill">尚未登入</span>
      <span id="user-id" style="font-size:11px;color:var(--muted);"></span>
    </div>
  </header>

  <div class="wrap">
    <div class="breadcrumb">
      <div>
        <a href="./index.html">首頁</a> &gt;
        <a href="./pricing.html">訂閱方案</a> &gt;
        <span>結帳</span>
      </div>
      <div class="breadcrumb-right">
        <a href="./pricing.html">← 返回方案選擇</a>
      </div>
    </div>

    <div class="layout">
      <!-- 左：訂單資訊 -->
      <div class="card">
        <div class="card-title-row">
          <div class="card-title">訂單資訊</div>
          <div class="card-sub">請確認方案內容與付款方式</div>
        </div>

        <div class="card-section-title">方案內容</div>
        <div class="field-row">
          <div class="field-label">方案名稱</div>
          <div class="field-value">
            <span id="plan-name">自訂方案</span>
          </div>
        </div>
        <div class="field-row">
          <div class="field-label">計費週期</div>
          <div class="field-value field-value-muted" id="plan-period">—</div>
        </div>
        <div class="field-row">
          <div class="field-label">授權內容</div>
          <div class="field-value field-value-muted" id="plan-categories">—</div>
        </div>

        <div class="card-section-title">金額明細</div>
        <div class="field-row">
          <div class="field-label">應付金額（新台幣）</div>
          <div class="field-value">
            <span id="amount-ntd">—</span>
          </div>
        </div>
        <div class="field-row">
          <div class="field-label">金額原始值（分）</div>
          <div class="field-value field-value-muted" id="amount-raw">—</div>
        </div>

        <div class="card-section-title">訂閱人資訊</div>
        <div class="field-row">
          <div class="field-label">E-mail（登入帳號）</div>
          <div class="field-value field-value-muted" id="pair-email">—</div>
        </div>
        <div class="field-row">
          <div class="field-label">推薦代碼</div>
          <div class="field-value field-value-muted" id="ref-code">（無）</div>
        </div>

        <div class="card-section-title">付款動作</div>
        <div class="btn-row">
          <button id="btn-mock" class="primary">
            模擬付款（寫入訂單）
          </button>
          <button id="btn-ecpay" class="secondary">
            綠界付款（正式）
          </button>
        </div>
        <div class="status-bar" id="status-bar">
          讀取中…
        </div>
      </div>

      <!-- 右：帳單預覽 -->
      <div class="card">
        <div class="card-title-row">
          <div class="card-title">帳單預覽（列印用）</div>
        </div>

        <div class="invoice-header">
          <div>
            <div class="invoice-title">BookWide 教育平台</div>
            <div class="invoice-sub">非正式發票，僅供學員對帳使用</div>
          </div>
          <div class="invoice-meta">
            <div>開立日期：<span id="inv-date">—</span></div>
            <div>訂單編號：<span id="inv-no">—</span></div>
          </div>
        </div>

        <div class="invoice-meta">
          訂閱人：<span id="inv-buyer">—</span><br>
          方案說明：<span id="inv-plan-desc">EduEnglish 線上訂閱方案</span>
        </div>

        <table class="invoice-table">
          <thead>
            <tr>
              <th>項目</th>
              <th style="width:50px;">數量</th>
              <th style="width:60px;">單價</th>
              <th style="width:60px;">小計</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td id="inv-item">EduEnglish 線上訂閱方案</td>
              <td class="num">1</td>
              <td class="num" id="inv-unit">—</td>
              <td class="num" id="inv-subtotal">—</td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3" style="text-align:right;">應付總額</td>
              <td class="num" id="inv-total">—</td>
            </tr>
          </tfoot>
        </table>

        <div class="invoice-foot">
          ※ 實際金流由第三方（綠界科技 ECPay）代收，本頁為平台訂閱記錄。<br>
          ※ 本帳單僅供學習用途，如需正式發票請來信洽詢。
        </div>

        <div class="sub-info">
          <div class="sub-info-title">我的訂閱（模擬顯示）</div>
          <div class="sub-info-row">
            <div class="sub-info-label">方案</div>
            <div class="sub-info-value" id="sub-plan">—</div>
          </div>
          <div class="sub-info-row">
            <div class="sub-info-label">訂單編號</div>
            <div class="sub-info-value" id="sub-order">—</div>
          </div>
          <div class="sub-info-row">
            <div class="sub-info-label">狀態</div>
            <div class="sub-info-value" id="sub-status">尚未建立</div>
          </div>
        </div>

        <div class="print-link">
          <button onclick="window.print()" class="secondary">列印帳單</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ★ 結帳邏輯：抓登入 ＋ 呼叫 create-order -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    const supabaseUrl = document
      .querySelector('meta[name="supabase-url"]')
      .getAttribute('content')

    const supabaseAnonKey = document
      .querySelector('meta[name="supabase-anon-key"]')
      .getAttribute('content')

    const supabase = createClient(supabaseUrl, supabaseAnonKey)

    const elUserEmail = document.getElementById('user-email')
    const elUserId = document.getElementById('user-id')
    const elPairEmail = document.getElementById('pair-email')
    const elRefCode = document.getElementById('ref-code')
    const elAmountNtd = document.getElementById('amount-ntd')
    const elAmountRaw = document.getElementById('amount-raw')
    const elPlanName = document.getElementById('plan-name')
    const elPlanPeriod = document.getElementById('plan-period')
    const elPlanCategories = document.getElementById('plan-categories')
    const elStatusBar = document.getElementById('status-bar')
    const btnMock = document.getElementById('btn-mock')
    const btnEcpay = document.getElementById('btn-ecpay')

    const elInvDate = document.getElementById('inv-date')
    const elInvNo = document.getElementById('inv-no')
    const elInvBuyer = document.getElementById('inv-buyer')
    const elInvItem = document.getElementById('inv-item')
    const elInvUnit = document.getElementById('inv-unit')
    const elInvSubtotal = document.getElementById('inv-subtotal')
    const elInvTotal = document.getElementById('inv-total')
    const elInvPlanDesc = document.getElementById('inv-plan-desc')

    const elSubPlan = document.getElementById('sub-plan')
    const elSubOrderNo = document.getElementById('sub-order')
    const elSubStatus = document.getElementById('sub-status')

    let currentUser = null
    let currentOrderNo = null

    function setStatus(text, level = '') {
      elStatusBar.textContent = text || ''
      elStatusBar.classList.remove('ok', 'bad')
      if (level === 'ok') elStatusBar.classList.add('ok')
      if (level === 'bad') elStatusBar.classList.add('bad')
    }

    function parseQuery() {
      const params = new URLSearchParams(window.location.search)
      const planId = params.get('plan_id') || 'custom'
      const planLabel = params.get('plan_label') || 'EduEnglish 線上訂閱方案'
      const period = params.get('period') || 'month'
      const amountRaw = Number(params.get('amount') || '0')
      const ntd = (amountRaw / 100).toFixed(0)
      const refCode = params.get('ref') || ''
      const cats = params.get('cats') || '全站教材使用權'

      elPlanName.textContent = planLabel
      elPlanPeriod.textContent = period === 'month' ? '月繳' : (period === 'year' ? '年繳' : period)
      elPlanCategories.textContent = cats
      elAmountRaw.textContent = amountRaw ? amountRaw.toString() : '—'
      elAmountNtd.textContent = amountRaw ? `NT$ ${ntd}` : '—'

      elInvItem.textContent = planLabel
      elInvUnit.textContent = amountRaw ? `NT$ ${ntd}` : '—'
      elInvSubtotal.textContent = amountRaw ? `NT$ ${ntd}` : '—'
      elInvTotal.textContent = amountRaw ? `NT$ ${ntd}` : '—'
      elInvPlanDesc.textContent = planLabel + '（' + (period === 'month' ? '月繳' : '年繳') + '）'

      if (refCode) {
        elRefCode.textContent = refCode
      }

      const today = new Date()
      const d = today.getFullYear() + '-' +
        String(today.getMonth() + 1).padStart(2, '0') + '-' +
        String(today.getDate()).padStart(2, '0')
      elInvDate.textContent = d

      return {
        plan_id: planId,
        plan_label: planLabel,
        period,
        categories: cats,
        amount_raw: amountRaw,
        amount_ntd: Number(ntd),
        referral_code: refCode
      }
    }

    const orderContext = parseQuery()

    async function initUser() {
      const { data, error } = await supabase.auth.getUser()
      console.log('auth.getUser() 回傳：', data, error)

      if (error || !data.user) {
        elUserEmail.textContent = '尚未登入'
        elUserId.textContent = ''
        elPairEmail.textContent = '請先登入後再結帳'
        elInvBuyer.textContent = '（請先登入）'
        setStatus('尚未登入，請先回首頁登入再進入結帳頁面。', 'bad')
        btnMock.disabled = true
        btnEcpay.disabled = true
        return
      }
      currentUser = data.user
      elUserEmail.textContent = currentUser.email
      elUserId.textContent = 'UID：' + currentUser.id
      elPairEmail.textContent = currentUser.email
      elInvBuyer.textContent = currentUser.email

      btnMock.disabled = false
      btnEcpay.disabled = false
      setStatus('')
    }

    async function callCreateOrder(mode) {
      if (!currentUser) {
        setStatus('尚未登入，無法建立訂單。', 'bad')
        return
      }
      if (!orderContext.amount_raw) {
        setStatus('金額為 0，請從 pricing 頁重新選擇方案。', 'bad')
        return
      }

      setStatus('建立訂單中…')
      btnMock.disabled = true
      btnEcpay.disabled = true

      const payload = {
        // Edge Function create-order 需要的欄位
        user_id: currentUser.id,
        buyer_id: currentUser.id,
        items: [orderContext.plan_label || 'EduEnglish 線上訂閱方案'],
        period: orderContext.period || 'month',
        status: mode === 'mock' ? 'paid' : 'pending',
        email_to: currentUser.email,

        // 額外紀錄用（目前 create-order 不會寫入，但保留以後擴充）
        mode,
        amount: orderContext.amount_raw,
        currency: 'TWD',
        plan_id: orderContext.plan_id,
        plan_label: orderContext.plan_label,
        categories: orderContext.categories,
        referral_code: orderContext.referral_code || null
      }

      try {
        const { data, error } = await supabase.functions.invoke('create-order', {
          body: payload
        })

        if (error) {
          console.error('create-order error:', error)
          setStatus('建立訂單失敗：' + (error.message || '未知錯誤'), 'bad')
          return
        }

        console.log('create-order result:', data)
        const orderNo = data?.order?.id || data?.order_id || data?.order_no || data?.id || '(未回傳編號)'
        currentOrderNo = orderNo

        elInvNo.textContent = orderNo
        elSubPlan.textContent = orderContext.plan_label + '（' + orderContext.period + '）'
        elSubOrderNo.textContent = orderNo
        elSubStatus.textContent = mode === 'mock' ? '已建立（模擬付款）' : '已送出（等待金流回傳）'

        setStatus('訂單已建立完成。若為模擬付款，系統僅寫入 orders 並寄出通知信（若有設定）。', 'ok')
      } catch (e) {
        console.error('create-order exception:', e)
        setStatus('建立訂單時發生錯誤，請稍後再試。', 'bad')
      } finally {
        btnMock.disabled = false
        btnEcpay.disabled = false
      }
    }

    btnMock.addEventListener('click', () => callCreateOrder('mock'))
    btnEcpay.addEventListener('click', () => {
      setStatus('未串接綠界金流 demo，中止呼叫。', 'bad')
    })

    initUser()
  </script>
</body>
</html>

















