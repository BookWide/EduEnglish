<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide｜結帳</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#f4f6fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --brand:#2563eb; --danger:#b91c1c; --ok:#065f46; --chip:#111827;
      --radius:18px; --shadow:0 10px 30px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif}
    a{color:inherit;text-decoration:none}
    header{position:sticky;top:0;z-index:10;background:rgba(244,246,251,.92);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid var(--line)}
    .wrap{max-width:1120px;margin:0 auto;padding:18px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .pill{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;display:inline-flex;gap:8px;align-items:center}
    .btn{border:0;border-radius:999px;padding:12px 18px;background:#111827;color:#fff;cursor:pointer;font-weight:800}
    .btn.secondary{background:#fff;color:var(--ink);border:1px solid var(--line)}
    .btn.brand{background:var(--brand)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:16px}
    @media(max-width:960px){ .grid{grid-template-columns:1fr} }
    .card{background:var(--card);border:1px solid var(--line);border-radius:26px;box-shadow:var(--shadow);padding:18px}
    .h1{font-size:38px;margin:12px 0 6px;font-weight:900;letter-spacing:1px}
    .muted{color:var(--muted)}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .k{color:var(--muted);min-width:84px}
    .v{font-weight:800}
    .plans{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
    @media(max-width:960px){ .plans{grid-template-columns:1fr} }
    .plan{
      border:1px solid var(--line);border-radius:18px;padding:14px 14px;background:#fff;cursor:pointer;
      display:flex;flex-direction:column;gap:6px;min-height:104px;
    }
    .plan.active{border-color:var(--brand);box-shadow:0 0 0 3px rgba(37,99,235,.12)}
    .price{font-weight:950;font-size:22px}
    .subprice{font-size:13px;color:var(--muted)}
    .chipTag{
      display:inline-flex;align-items:center;gap:6px;
      padding:5px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;color:#374151;
      font-size:12px;font-weight:900;
    }
    .chipTag.on{border-color:rgba(6,95,70,.2);background:rgba(6,95,70,.06);color:var(--ok)}
    .hr{height:1px;background:var(--line);margin:14px 0}
    .msg{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;white-space:pre-wrap;word-break:break-word}
    .msg.ok{border-color:rgba(6,95,70,.25);background:rgba(6,95,70,.06);color:var(--ok)}
    .msg.err{border-color:rgba(185,28,28,.25);background:rgba(185,28,28,.06);color:var(--danger)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;white-space:pre-wrap;word-break:break-word}
    .payBoxTitle{font-weight:950;font-size:26px;margin:2px 0 4px}
    .payAmount{font-weight:1000;font-size:44px;letter-spacing:1px}
    .smallLine{display:flex;justify-content:space-between;gap:10px;margin-top:8px;color:var(--muted)}
    .smallLine b{color:var(--ink)}
    footer{padding:26px 0;color:var(--muted);text-align:center}
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <a class="pill" href="/index.html">← 回首頁</a>
        <div class="pill" id="who">未登入</div>
        <a class="pill" href="/account/subscription.html">我的訂閱 →</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="h1">結帳</div>
    <div class="muted">選擇方案後付款（由後端 create-ecpay-order 建單並回傳自動送出的綠界表單）。</div>

    <div class="grid">
      <!-- 左：方案 -->
      <section class="card">
        <div class="row">
          <div class="k">課程：</div>
          <div class="v" id="topicsText">-</div>
        </div>
        <div class="row" style="margin-top:8px">
          <div class="k">方案：</div>
          <div class="v" id="planText">-</div>
          <span class="chipTag" id="refChip" style="display:none;">推薦碼：<span id="refText"></span></span>
          <span class="chipTag on" id="discountChip" style="display:none;">已套用 9 折</span>
        </div>

        <div class="plans" id="plans">
          <div class="plan" data-plan="month">
            <div class="muted">月方案</div>
            <div class="price" id="p_month">NT$ 1,000</div>
            <div class="subprice" id="p_month_sub"></div>
          </div>
          <div class="plan" data-plan="semi">
            <div class="muted">半年方案</div>
            <div class="price" id="p_semi">NT$ 5,400</div>
            <div class="subprice" id="p_semi_sub"></div>
          </div>
          <div class="plan" data-plan="year">
            <div class="muted">一年方案</div>
            <div class="price" id="p_year">NT$ 9,600</div>
            <div class="subprice" id="p_year_sub"></div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <button class="btn brand" id="btnPay">綠界付款（Stage/Prod 由後端決定）</button>
          <a class="btn secondary" href="javascript:history.back()">返回上一頁</a>
        </div>

        <div id="msg" class="msg" style="display:none"></div>
        <div id="debug" class="msg" style="display:none"><div class="mono" id="debugText"></div></div>

        <div class="hr"></div>
        <div class="muted" style="line-height:1.8">
          • 本頁只呼叫 <b>create-ecpay-order</b><br/>
          • 後端會：<b>算折扣金額 → insert orders(pending) → 產生綠界表單（折扣後 TotalAmount）</b><br/>
          • 付款完成後：綠界呼叫 <b>ecpay-return</b> → orders=paid → 寫 expire_at → upsert subscriptions
        </div>
      </section>

      <!-- 右：本次應付 -->
      <section class="card">
        <div class="payBoxTitle">本次應付</div>
        <div class="payAmount" id="payAmount">NT$ -</div>
        <div class="smallLine"><span>原價</span><b id="origAmount">NT$ -</b></div>
        <div class="smallLine"><span>折扣</span><b id="discAmount">-</b></div>
        <div class="smallLine"><span>期間</span><b id="periodText">-</b></div>
        <div class="hr"></div>
        <div class="muted" style="line-height:1.7">
          ✅ 你看到的「本次應付」會 <b>100% 送進綠界</b>（由後端計算並填到 TotalAmount）。<br/>
          如果綠界仍顯示原價，就代表後端還沒改到。
        </div>
      </section>
    </div>

    <footer>BookWide © 2025</footer>
  </main>

<script>
  const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
  const FN_CREATE_ECPAY_ORDER = `${SUPABASE_URL}/functions/v1/create-ecpay-order`;

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = (id)=>document.getElementById(id);
  const msgBox = $("msg");
  const dbgBox = $("debug");
  const dbgText = $("debugText");

  const PRICE = { month: 1000, semi: 5400, year: 9600 }; // 顯示用（真正收多少以後端為準）

  function ntd(n){ return "NT$ " + Number(n||0).toLocaleString("en-US"); }
  function showMsg(type, text){
    msgBox.style.display = "block";
    msgBox.className = "msg " + (type === "ok" ? "ok" : "err");
    msgBox.textContent = text;
  }
  function showDbg(obj){
    dbgBox.style.display = "block";
    dbgText.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
  }
  function parseQuery(){
    const u = new URL(location.href);

    const rawTopics = u.searchParams.get("topics") || "";
    const topics = rawTopics
      .split(",")
      .map(s=>decodeURIComponent(s))
      .map(s=>s.trim())
      .filter(Boolean);

    const plan = (u.searchParams.get("plan") || "month").trim();
    const ref  = (u.searchParams.get("ref") || "").trim(); // 推薦碼
    return { topics, plan, ref };
  }
  function normPlan(p){
    const s = String(p||"").toLowerCase().trim();
    if (s === "semi" || s === "half" || s === "6m" || s === "halfyear") return "semi";
    if (s === "year" || s === "y" || s === "12m" || s === "yearly") return "year";
    return "month";
  }
  function planToPeriod(plan){
    if (plan === "semi") return "half";
    if (plan === "year") return "year";
    return "month";
  }
  function planLabel(plan){
    return plan === "semi" ? "半年方案" : plan === "year" ? "一年方案" : "月方案";
  }
  function safeTopicsFallback(arr){
    if (Array.isArray(arr) && arr.length) return arr;
    return ["story","music","movie","news","pro"];
  }

  function setActivePlan(plan){
    document.querySelectorAll(".plan").forEach(el=>{
      el.classList.toggle("active", el.dataset.plan === plan);
    });
    $("planText").textContent = planLabel(plan);
    $("periodText").textContent = planToPeriod(plan) + " (" + planToPeriod(plan) + ")";
  }

  function computeUiDiscount(ref, base){
    // UI 顯示：ref 存在就 9 折；真正是否可用由後端判定（避免自推/亂碼）
    if (!ref) return { pay: base, disc: 0, rate: 1 };
    const pay = Math.round(base * 0.9);
    return { pay, disc: base - pay, rate: 0.9 };
  }

  function refreshUi(){
    const q = parseQuery();
    const plan = normPlan(q.plan);
    const ref = q.ref;

    const topics = safeTopicsFallback(q.topics);
    $("topicsText").textContent = topics.join(", ");
    setActivePlan(plan);

    if (ref){
      $("refChip").style.display = "inline-flex";
      $("refText").textContent = ref;
      $("discountChip").style.display = "inline-flex";
    } else {
      $("refChip").style.display = "none";
      $("discountChip").style.display = "none";
    }

    // 方案卡片顯示：原價 + 折扣價（僅 UI）
    const dM = computeUiDiscount(ref, PRICE.month);
    const dS = computeUiDiscount(ref, PRICE.semi);
    const dY = computeUiDiscount(ref, PRICE.year);

    $("p_month").textContent = ntd(PRICE.month);
    $("p_semi").textContent  = ntd(PRICE.semi);
    $("p_year").textContent  = ntd(PRICE.year);

    $("p_month_sub").textContent = ref ? (ntd(PRICE.month) + " → " + ntd(dM.pay) + "（已套用 9 折）") : "";
    $("p_semi_sub").textContent  = ref ? (ntd(PRICE.semi)  + " → " + ntd(dS.pay) + "（已套用 9 折）") : "";
    $("p_year_sub").textContent  = ref ? (ntd(PRICE.year)  + " → " + ntd(dY.pay) + "（已套用 9 折）") : "";

    const base = PRICE[plan];
    const d = computeUiDiscount(ref, base);

    $("payAmount").textContent  = ntd(d.pay);
    $("origAmount").textContent = ntd(base);
    $("discAmount").textContent = ref ? ("- " + ntd(d.disc).replace("NT$ ","NT$ ")) : "-";
  }

  async function getAccessToken(){
    const { data } = await sb.auth.getSession();
    return data?.session?.access_token || "";
  }

  async function refreshUser(){
    const { data } = await sb.auth.getUser();
    const user = data?.user;
    if (user?.id) $("who").textContent = (user.email || "已登入") + " · " + user.id.slice(0,8);
    else $("who").textContent = "未登入（請先登入再付款）";
    return user;
  }

  async function callCreateEcpayOrder(payload, accessToken){
    const res = await fetch(FN_CREATE_ECPAY_ORDER, {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        // ✅ 這行就是你 Missing Bearer token 的解藥
        "Authorization": "Bearer " + accessToken
      },
      body: JSON.stringify(payload),
    });

    const json = await res.json().catch(()=> ({}));
    if (!res.ok || !json?.ok) {
      const msg = (json?.message || "create-ecpay-order failed");
      const detail = (json?.detail ? ("\n" + String(json.detail)) : "");
      throw new Error(msg + detail);
    }
    return json;
  }

  function submitReturnedHtml(html){
    document.open();
    document.write(html);
    document.close();
  }

  (async function main(){
    refreshUi();

    // 切換方案
    $("plans").addEventListener("click", (e)=>{
      const el = e.target.closest(".plan");
      if (!el) return;
      const p = el.dataset.plan;
      const u = new URL(location.href);
      u.searchParams.set("plan", p);
      history.replaceState({}, "", u.toString());
      refreshUi();
    });

    const user = await refreshUser();
    if (!user?.id){
      showMsg("err","你尚未登入：請先回首頁登入，再進行付款。");
      $("btnPay").disabled = true;
      return;
    }

    $("btnPay").addEventListener("click", async ()=>{
      try{
        msgBox.style.display="none";
        dbgBox.style.display="none";
        $("btnPay").disabled = true;

        const q = parseQuery();
        const topics = safeTopicsFallback(q.topics);
        const plan = normPlan(q.plan);
        const period = planToPeriod(plan);
        const ref = (q.ref || "").trim();

        const accessToken = await getAccessToken();
        if (!accessToken){
          // 有時候 getUser 會有，但 session 過期了，就會 missing bearer
          throw new Error("Missing Authorization Bearer token（session 沒拿到 access_token，請重新登入）");
        }

        const payload = {
          period,                 // month/half/year
          items: topics,          // 課程
          referral_code: ref || null, // ✅ 推薦碼：交給後端判斷是否可折扣
          // 不要自己送 amount，避免被前端改；後端用 period/ref 計算
        };

        showDbg({ step:"calling create-ecpay-order", endpoint: FN_CREATE_ECPAY_ORDER, payload });

        const out = await callCreateEcpayOrder(payload, accessToken);

        // out.html 是後端產生的自動送出表單（折扣後 TotalAmount）
        showDbg({ ok:true, order_id: out.order_id, merchant_trade_no: out.merchant_trade_no, amount: out.amount });

        submitReturnedHtml(out.html);

      } catch (err){
        showMsg("err", "送出失敗：\n" + (err?.message || err));
        showDbg(String(err?.stack || err));
      } finally {
        $("btnPay").disabled = false;
      }
    });
  })();
</script>
</body>
</html>





























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































