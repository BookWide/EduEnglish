<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide｜結帳</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#f4f6fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --brand:#2563eb; --danger:#b91c1c; --radius:18px; --shadow:0 10px 30px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif}
    a{color:inherit;text-decoration:none}

    .wrap{max-width:1180px;margin:24px auto;padding:0 18px}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
    .pill{display:inline-flex;align-items:center;gap:10px;background:#fff;border:1px solid var(--line);border-radius:999px;padding:8px 12px}
    .btn{border:0;border-radius:999px;padding:11px 18px;font-size:16px;cursor:pointer}
    .btn.primary{background:var(--brand);color:#fff}
    .btn.ghost{background:#fff;border:1px solid var(--line);color:var(--ink)}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .grid{display:grid;grid-template-columns:1.25fr .9fr;gap:18px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px}
    h1{margin:0 0 8px;font-size:44px}
    .muted{color:var(--muted)}
    .divider{height:1px;background:var(--line);margin:14px 0}

    .plans{display:flex;flex-direction:column;gap:12px;margin-top:10px}
    .plan{
      border:1px solid var(--line);border-radius:16px;padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;cursor:pointer;
      background:#fff;
    }
    .plan.active{outline:2px solid rgba(37,99,235,.32);border-color:rgba(37,99,235,.35)}
    .plan .name{font-weight:800;font-size:18px}
    .plan .price{font-weight:900;font-size:20px}

    .field{margin-top:14px}
    input{
      width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:14px;
      font-size:16px;
    }

    .sumRow{display:flex;align-items:center;justify-content:space-between;margin:8px 0}
    .sumBig{font-size:40px;font-weight:900}

    .err{margin-top:14px;border:1px solid rgba(185,28,28,.25);background:#fff5f5;color:var(--danger);
      padding:12px 14px;border-radius:14px;display:none;white-space:pre-wrap}
  </style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <a class="pill" href="/index.html">← 回首頁</a>
    <div class="pill">
      <span class="muted" id="loginHint">未登入</span>
      <button class="btn ghost" id="btnLogout" style="display:none">登出</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h1>BookWide 結帳</h1>
      <div class="muted">課程：<span id="topicsText">—</span></div>

      <div class="divider"></div>

      <div class="plans">
        <div class="plan active" data-plan="month">
          <div class="name">月方案</div>
          <div class="price">NT$ 1,000</div>
        </div>
        <div class="plan" data-plan="half">
          <div class="name">半年方案</div>
          <div class="price">NT$ 5,400</div>
        </div>
        <div class="plan" data-plan="year">
          <div class="name">一年方案</div>
          <div class="price">NT$ 9,600</div>
        </div>
      </div>

      <div class="field">
        <div style="font-weight:800">推薦碼（選填）</div>
        <input id="referralCode" placeholder="輸入推薦碼" />
      </div>

      <div style="margin-top:16px;display:flex;gap:12px">
        <button class="btn primary" id="payBtn">前往綠界付款</button>
        <button class="btn ghost" onclick="location.reload()">重整</button>
      </div>

      <div class="err" id="errBox"></div>
    </div>

    <div class="card">
      <div class="muted">本次應付</div>
      <div class="sumBig" id="sumPay">NT$ 1,000</div>

      <div class="divider"></div>

      <div class="sumRow"><div class="muted">原價</div><div id="sumBase">NT$ 1,000</div></div>
      <div class="sumRow"><div class="muted">折扣</div><div id="sumDisc">NT$ 0</div></div>
      <div class="sumRow"><div class="muted">期間</div><div id="sumPeriod">month</div></div>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let plan = "month";
let TOPICS = "";

const PRICE = { month:1000, half:5400, year:9600 };

const $ = id => document.getElementById(id);
const fmt = n => "NT$ " + Number(n||0).toLocaleString();
const err = m => { $("errBox").style.display=m?"block":"none"; $("errBox").textContent=m||""; };

function setPlan(p){
  plan = p;
  document.querySelectorAll(".plan").forEach(el=>{
    el.classList.toggle("active", el.dataset.plan===p);
  });
  // 前端不亂折扣
  $("sumPay").innerText = fmt(PRICE[p]);
  $("sumBase").innerText = fmt(PRICE[p]);
  $("sumDisc").innerText = fmt(0);
  $("sumPeriod").innerText = p;
}

document.querySelectorAll(".plan").forEach(el=>{
  el.onclick = ()=>setPlan(el.dataset.plan);
});

// init from URL
(()=>{
  const u = new URL(location.href);
  TOPICS = (u.searchParams.get("topics")||"").trim();
  $("topicsText").innerText = TOPICS || "—";

  const p = (u.searchParams.get("plan")||"month");
  if (PRICE[p]) setPlan(p);

  const ref = u.searchParams.get("ref");
  if (ref) $("referralCode").value = ref;
})();

async function refreshAuth(){
  const {data:{user}} = await sb.auth.getUser();
  if (user){
    $("loginHint").textContent = user.email;
    $("btnLogout").style.display="inline-flex";
  }
}
refreshAuth();

$("btnLogout").onclick = async ()=>{
  await sb.auth.signOut();
  location.href="/index.html";
};

$("payBtn").onclick = async ()=>{
  err("");
  $("payBtn").disabled=true;

  try{
    const {data:{session}} = await sb.auth.getSession();
    if (!session?.access_token) throw "請先登入";

    const ref = ($("referralCode").value||"").trim()||null;

    const r = await fetch(SUPABASE_URL+"/functions/v1/create-ecpay-order",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "apikey":SUPABASE_ANON_KEY,
        "Authorization":"Bearer "+session.access_token
      },
      body:JSON.stringify({
        period:plan,
        referral_code:ref,
        topics:TOPICS
      })
    });

    const data = await r.json();

    // ✅ 用後端 pricing 更新右側（關鍵）
    if (data?.pricing){
      $("sumPay").innerText  = fmt(data.pricing.total_amount);
      $("sumBase").innerText = fmt(data.pricing.list_price);
      $("sumDisc").innerText = fmt(data.pricing.discount_amount);
    }

    if (data?.html){
      document.open(); document.write(data.html); document.close();
      return;
    }

    throw "付款建立失敗";
  }catch(e){
    err(String(e));
    $("payBtn").disabled=false;
  }
};
</script>
</body>
</html>




























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































