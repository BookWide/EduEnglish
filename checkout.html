<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BookWide｜結帳（模擬付款＋綠界測試）</title>

  <style>
    :root{
      --fg:#111;
      --bg:#fff;
      --muted:#666;
      --line:#e6e6e6;
      --brand:#111;
      --ok:#0a7f2e;
      --bad:#b2172e;
      --pill:#f4f4f4;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font:16px/1.65 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,
           "Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
    }
    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:22px 18px 40px;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin:0 0 18px;
      border-bottom:1px solid var(--line);
      padding-bottom:10px;
    }
    .logo{ font-weight:700; letter-spacing:0.04em; }
    .logo span{
      font-size:13px;
      display:block;
      color:var(--muted);
      letter-spacing:0.08em;
    }
    .user-info{ text-align:right; font-size:13px; color:var(--muted); }
    .user-info strong{ display:block; font-size:14px; color:var(--fg); }
    h1{ font-size:20px; margin:12px 0 4px; }
    h2{ font-size:17px; margin:18px 0 8px; }
    .section{
      border:1px solid var(--line);
      border-radius:8px;
      padding:14px 14px 12px;
      margin-bottom:14px;
    }
    .pill-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin:4px 0 6px;
    }
    .pill{
      padding:4px 10px;
      border-radius:999px;
      background:var(--pill);
      font-size:13px;
    }
    .price{ font-size:22px; font-weight:700; }
    .price small{
      font-size:13px;
      font-weight:400;
      color:var(--muted);
      margin-left:4px;
    }
    .note{ font-size:13px; color:var(--muted); }
    .note strong{ color:#111; }
    textarea{
      width:100%;
      min-height:80px;
      resize:vertical;
      font:inherit;
      padding:8px;
      border-radius:6px;
      border:1px solid var(--line);
    }
    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:8px;
    }
    button{
      cursor:pointer;
      border-radius:999px;
      padding:9px 18px;
      border:1px solid var(--brand);
      background:var(--brand);
      color:#fff;
      font:15px system-ui,-apple-system,"Noto Sans TC",sans-serif;
    }
    button[disabled]{ opacity:0.5; cursor:not-allowed; }
    .btn-ghost{ background:#fff; color:var(--brand); }
    .status{ margin-top:10px; font-size:14px; }
    .status.ok{color:var(--ok);}
    .status.bad{color:var(--bad);}
    .tag{
      display:inline-block;
      font-size:12px;
      padding:1px 6px;
      border-radius:999px;
      background:#f3f3f3;
      color:var(--muted);
      margin-left:4px;
    }
    .warn-box{
      border-radius:6px;
      background:#fff7f7;
      border:1px solid #f1c2c2;
      padding:8px 10px;
      font-size:13px;
      color:var(--bad);
      margin-top:6px;
    }
    .calc-box{
      margin-top:10px;
      padding-top:10px;
      border-top:1px dashed var(--line);
    }
    .calc-line{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:13px;
      color:var(--muted);
      margin:4px 0;
    }
    .calc-line b{ color:#111; font-weight:700; }
    .calc-line.final{
      font-size:14px;
      color:#111;
      margin-top:6px;
    }
    @media (max-width:640px){
      .wrap{padding:16px 12px 28px;}
      header{flex-direction:column;align-items:flex-start;}
      .user-info{text-align:left;}
    }
  </style>
</head>
<body>
<div class="wrap">

  <header>
    <div class="logo">
      BookWide
      <span>ENGLISH LEARNING</span>
    </div>
    <div class="user-info" id="userBox">
      <strong id="userEmail">檢查登入中…</strong>
      <span id="userHint">請稍候</span>
    </div>
  </header>

  <main>
    <h1>訂閱方案</h1>

    <section class="section" id="planSection">
      <div class="pill-row" id="itemsPills"></div>

      <div>
        <span id="periodText">方案期間：—</span>
        <span class="tag" id="refTag" style="display:none;"></span>
      </div>

      <div style="margin-top:6px;">
        <span class="price" id="priceText">—</span>
        <small id="priceHint">（依方案固定價）</small>
      </div>

      <!-- ✅ 折扣明細 -->
      <div class="calc-box" id="calcBox" style="display:none;">
        <div class="calc-line"><span>原價</span><span id="baseAmountText">—</span></div>
        <div class="calc-line"><span>折扣</span><span id="discountAmountText">—</span></div>
        <div class="calc-line final"><span><b>實付</b></span><span><b id="finalAmountText">—</b></span></div>
        <div class="calc-line"><span>推薦人分潤（10%）</span><span id="commissionText">—</span></div>
        <div class="calc-line" id="selfRefHint" style="display:none;"><span>自推規則</span><span>自推不折扣、不分潤</span></div>
      </div>

      <div class="note" style="margin-top:10px;">
        提醒：你目前的定價是 <strong>一個方案就包含 5 大項</strong>，金額不會因勾選項目數而變動。
      </div>
      <div class="note">
        若方案不正確，請回 <strong>pricing.html</strong> 重新選擇。
      </div>
    </section>

    <section class="section">
      <h2>備註 / 發票資訊（選填）</h2>
      <textarea id="noteInput" placeholder="如需填寫統編、抬頭，或其他備註，請在此留下（選填）。"></textarea>
      <div class="note">此欄位內容會一起寫入訂單，並附在通知 email 中。</div>
    </section>

    <section class="section">
      <h2>付款方式</h2>
      <div class="note">目前提供兩種流程：</div>
      <ul class="note" style="margin-top:4px;padding-left:20px;">
        <li><strong>模擬付款</strong>：只在系統內建立訂單、標記為已付款，方便測試守門與訂閱流程。</li>
        <li><strong>綠界測試付款</strong>：呼叫 Edge Function 串接綠界 <code>Stage</code> 測試環境，完整走正式付款流程（但不會真正扣款）。</li>
      </ul>

      <div class="btn-row">
        <button id="payBtn" type="button">模擬付款並送出訂單</button>
        <button id="ecpayBtn" type="button">綠界測試付款（Stage）</button>
        <button class="btn-ghost" type="button" onclick="history.back()">返回上一頁</button>
      </div>

      <div id="statusBox" class="status"></div>
      <div id="loginWarn" class="warn-box" style="display:none;">
        ⚠ 尚未登入，請先回首頁或登入頁完成登入，再回來結帳。
      </div>
    </section>

  </main>

</div>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  // ---- Supabase 設定 ----
  const SUPABASE_URL = 'https://jeajrwpmrgczimmrflxo.supabase.co';
  const SUPABASE_ANON_KEY =
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do';

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ===== 規則：折扣/分潤（你指定） =====
  const DISCOUNT_RATE = 0.10;    // 被推薦人折扣 10%
  const COMMISSION_RATE = 0.10;  // 推薦人分潤 10%
  const SELF_REF_GIVE_DISCOUNT = false; // 自推：不要折扣（也不分潤）

  // ========= 1. 讀取 URL 參數 =========
  const params = new URLSearchParams(location.search);

  // topics/items 只用於顯示與寫入訂單
  const rawItemsParam = (params.get('items') || params.get('topics') || '').trim();
  const items = rawItemsParam
    ? rawItemsParam.split(',').map(s => s.trim()).filter(Boolean)
    : ['story','music','movie','news','pro']; // 沒帶就預設全包（你方案本來就全包）

  // period/plan → month/half/year
  let period = (params.get('period') || params.get('plan') || 'month').trim();
  if (period === 'monthly') period = 'month';
  if (period === 'semi') period = 'half';
  if (['halfyear', 'half-year', '6m'].includes(period)) period = 'half';
  if (['yearly', '12m'].includes(period)) period = 'year';

  // 固定方案價（不乘主題數）
  function priceByPeriod(p){
    switch (p) {
      case 'month': return 1000;
      case 'half':  return 5400;
      case 'year':  return 9600;
      default:      return 0;
    }
  }

  // ✅ baseAmount 永遠以 period 固定價為準（不信任 URL amount）
  const baseAmount = priceByPeriod(period);

  // 推薦碼
  const refCode = (params.get('ref') || params.get('referral') || '').trim();

  // ========= 2. 顯示在畫面上 =========
  const itemsPillsEl = document.getElementById('itemsPills');
  const periodTextEl = document.getElementById('periodText');
  const priceTextEl = document.getElementById('priceText');
  const refTagEl = document.getElementById('refTag');

  const calcBoxEl = document.getElementById('calcBox');
  const baseAmountTextEl = document.getElementById('baseAmountText');
  const discountAmountTextEl = document.getElementById('discountAmountText');
  const finalAmountTextEl = document.getElementById('finalAmountText');
  const commissionTextEl = document.getElementById('commissionText');
  const selfRefHintEl = document.getElementById('selfRefHint');

  function zhItemName(key) {
    switch (key) {
      case 'story': return '故事 Story';
      case 'music': return '音樂 Music';
      case 'movie': return '電影 Movie';
      case 'news':  return '實況 News';
      case 'pro':   return '基礎語法 Pro';
      default:      return key;
    }
  }
  function zhPeriod(p) {
    switch (p) {
      case 'month': return '月方案';
      case 'half':  return '半年方案';
      case 'year':  return '一年方案';
      default:      return p;
    }
  }
  function money(n){
    return Number(n || 0).toLocaleString() + ' 元';
  }

  items.forEach(k => {
    const pill = document.createElement('span');
    pill.className = 'pill';
    pill.textContent = zhItemName(k);
    itemsPillsEl.appendChild(pill);
  });

  periodTextEl.textContent = '方案期間：' + zhPeriod(period);
  priceTextEl.textContent = money(baseAmount);

  if (refCode) {
    refTagEl.style.display = 'inline-block';
    refTagEl.textContent = '推薦碼：' + refCode;
  }

  // ========= 3. 讀取登入使用者 =========
  const userEmailEl = document.getElementById('userEmail');
  const userHintEl = document.getElementById('userHint');
  const loginWarnEl = document.getElementById('loginWarn');
  const payBtn = document.getElementById('payBtn');
  const ecpayBtn = document.getElementById('ecpayBtn');
  const statusBox = document.getElementById('statusBox');

  let currentUser = null;

  async function loadUser() {
    const { data, error } = await supabase.auth.getUser();

    if (error || !data?.user) {
      currentUser = null;
      userEmailEl.textContent = '尚未登入';
      userHintEl.textContent = '請先登入後再結帳';
      loginWarnEl.style.display = 'block';
      payBtn.disabled = true;
      ecpayBtn.disabled = true;
      // 沒登入也先顯示「原價」即可
      calcBoxEl.style.display = refCode ? 'block' : 'none';
      baseAmountTextEl.textContent = money(baseAmount);
      discountAmountTextEl.textContent = refCode ? '（登入後計算）' : '—';
      finalAmountTextEl.textContent = refCode ? '（登入後計算）' : money(baseAmount);
      commissionTextEl.textContent = refCode ? '（登入後計算）' : '—';
      return;
    }

    currentUser = data.user;
    userEmailEl.textContent = currentUser.email || '(無 email)';
    userHintEl.textContent = '已登入，請確認下方方案再送出訂單';
    loginWarnEl.style.display = 'none';
    payBtn.disabled = false;
    ecpayBtn.disabled = false;

    // ✅ 登入後立刻計算折扣/自推/分潤並顯示
    await renderCalcPreview();
  }

  loadUser();

  // 取得自己的 ref_code（用於自推判斷）
  async function getMyRefCode(){
    try{
      const { data, error } = await supabase
        .from('profiles')
        .select('ref_code')
        .eq('id', currentUser.id)
        .single();
      if (error) return null;
      return data?.ref_code ? String(data.ref_code) : null;
    }catch(e){
      return null;
    }
  }

  async function computeReferralPricing(){
    const myRef = currentUser ? await getMyRefCode() : null;
    const isSelfRef = !!(refCode && myRef && String(refCode) === String(myRef));

    // 自推：不折扣不分潤
    if (isSelfRef && !SELF_REF_GIVE_DISCOUNT){
      return {
        base_amount: baseAmount,
        discount_amount: 0,
        final_amount: baseAmount,
        commission_amount: 0,
        is_self_ref: true
      };
    }

    // 沒推薦碼
    if (!refCode){
      return {
        base_amount: baseAmount,
        discount_amount: 0,
        final_amount: baseAmount,
        commission_amount: 0,
        is_self_ref: false
      };
    }

    // 有推薦碼且非自推 → 折扣 & 分潤
    const discount = Math.round(baseAmount * DISCOUNT_RATE);
    const finalPay = Math.max(0, baseAmount - discount);
    const commission = Math.round(finalPay * COMMISSION_RATE);

    return {
      base_amount: baseAmount,
      discount_amount: discount,
      final_amount: finalPay,
      commission_amount: commission,
      is_self_ref: false
    };
  }

  async function renderCalcPreview(){
    const r = await computeReferralPricing();

    // 沒推薦碼就不顯示計算盒（版面更乾淨）
    if (!refCode){
      calcBoxEl.style.display = 'none';
      priceTextEl.textContent = money(baseAmount);
      return;
    }

    calcBoxEl.style.display = 'block';
    baseAmountTextEl.textContent = money(r.base_amount);
    discountAmountTextEl.textContent = (r.discount_amount ? ('- ' + money(r.discount_amount)) : money(0));
    finalAmountTextEl.textContent = money(r.final_amount);
    commissionTextEl.textContent = (r.commission_amount ? money(r.commission_amount) : money(0));

    selfRefHintEl.style.display = r.is_self_ref ? 'flex' : 'none';

    // 主價格顯示「實付」（比較符合你想看到折扣後是否生效）
    priceTextEl.textContent = money(r.final_amount);
  }

  // 共用：組 payload（✅ 改成 async，含折扣/分潤欄位）
  async function buildPayload(mockFlag) {
    const note = document.getElementById('noteInput').value.trim();

    const r = await computeReferralPricing();

    return {
      user_id: currentUser.id,
      email: currentUser.email,
      items,
      period,

      // ✅ 實付金額（送單用這個）
      amount: r.final_amount,

      // ✅ 明細（後端入帳用）
      base_amount: r.base_amount,
      discount_amount: r.discount_amount,
      final_amount: r.final_amount,
      commission_amount: r.commission_amount,
      referral_code: refCode || null,
      is_self_ref: !!r.is_self_ref,

      note: note || null,
      mock: !!mockFlag,
      gateway: mockFlag ? 'mock' : 'ecpay'
    };
  }

  function disableButtons() {
    payBtn.disabled = true;
    ecpayBtn.disabled = true;
  }
  function enableButtons() {
    payBtn.disabled = false;
    ecpayBtn.disabled = false;
  }

  function computeSubStartMonday() {
    const today = new Date();
    const dow = today.getDay(); // 0=Sun,1=Mon,...
    const diff = (dow + 6) % 7; // days since Monday
    const monday = new Date(today.getFullYear(), today.getMonth(), today.getDate() - diff);
    const y = monday.getFullYear();
    const m = String(monday.getMonth() + 1).padStart(2, '0');
    const d = String(monday.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
  }

  function storeSubscriptionToLocal(period) {
    try {
      const start = computeSubStartMonday();
      localStorage.setItem('bwSubPlan', period);
      localStorage.setItem('bwSubStart', start);
      console.debug('[checkout] subscription stored:', period, start);
    } catch (e) {
      console.warn('[checkout] localStorage set failed', e);
    }
  }

  // ========= 4. 模擬付款 =========
  async function handleMockPay() {
    if (!currentUser) {
      alert('請先登入後再結帳。');
      return;
    }

    statusBox.textContent = '正在建立訂單與寄出 Email（模擬付款）…';
    statusBox.className = 'status';
    disableButtons();

    const payload = await buildPayload(true);

    try {
      const res = await fetch(
        'https://jeajrwpmrgczimmrflxo.functions.supabase.co/create-order',
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          },
          body: JSON.stringify(payload)
        }
      );

      const data = await res.json().catch(() => null);

      if (!res.ok) {
        console.error('create-order error', data || res.statusText);
        throw new Error(data?.message || `Edge Function 錯誤：${res.status}`);
      }

      statusBox.textContent = '✅ 訂單建立成功（模擬），Email 已寄出，準備前往訂閱狀態頁…';
      statusBox.className = 'status ok';

      storeSubscriptionToLocal(period);

      setTimeout(() => {
        const qs = new URLSearchParams({
          items: items.join(','),
          period,
          amount: String(payload.amount),
          ref: refCode || ''
        });
        window.location.href = 'account/subscription.html?' + qs.toString();
      }, 1200);

    } catch (err) {
      console.error(err);
      statusBox.textContent = '❌ 建立訂單或寄信失敗：' + err.message;
      statusBox.className = 'status bad';
      enableButtons();
    }
  }

  // ========= 5. 綠界測試付款 =========
  async function handleEcpayPay() {
    if (!currentUser) {
      alert('請先登入後再結帳。');
      return;
    }

    statusBox.textContent = '正在連線綠界 Stage 測試環境，請稍候…';
    statusBox.className = 'status';
    disableButtons();

    const payload = await buildPayload(false);

    try {
      const res = await fetch(
        'https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/create-ecpay-order',
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          },
          body: JSON.stringify(payload)
        }
      );

      const data = await res.json().catch(() => null);

      if (!res.ok) {
        console.error('create-ecpay-order error', data || res.statusText);
        throw new Error(data?.message || `create-ecpay-order 錯誤：${res.status}`);
      }

      if (data && data.html) {
        statusBox.textContent = '✅ 已建立綠界訂單，即將前往綠界測試付款頁面…';
        statusBox.className = 'status ok';

        storeSubscriptionToLocal(period);

        const payWin = window.open('', '_self');
        payWin.document.open();
        payWin.document.write(data.html);
        payWin.document.close();
        return;
      }

      const redirectUrl = data?.redirect_url || data?.payment_url;
      if (redirectUrl) {
        statusBox.textContent = '✅ 已建立綠界訂單，準備重新導向…';
        statusBox.className = 'status ok';

        storeSubscriptionToLocal(period);

        window.location.href = redirectUrl;
        return;
      }

      throw new Error('Edge Function 回傳格式不符合預期，缺少 html / redirect_url / payment_url');

    } catch (err) {
      console.error(err);
      statusBox.textContent = '❌ 串接綠界測試付款失敗：' + err.message;
      statusBox.className = 'status bad';
      enableButtons();
    }
  }

  payBtn.addEventListener('click', handleMockPay);
  ecpayBtn.addEventListener('click', handleEcpayPay);
</script>

</body>
</html>

























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































