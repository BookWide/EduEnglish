<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide｜結帳</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#f4f6fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --brand:#2563eb; --danger:#b91c1c; --ok:#065f46;
      --radius:18px; --shadow:0 10px 30px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);
      font-family:system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif}
    a{color:inherit;text-decoration:none}
    header{position:sticky;top:0;z-index:10;background:#f4f6fb;border-bottom:1px solid var(--line)}
    .wrap{max-width:1120px;margin:0 auto;padding:18px}
    .topbar{display:flex;justify-content:space-between;align-items:center}
    .pill{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff}
    .btn{border:0;border-radius:999px;padding:12px 18px;font-weight:900;cursor:pointer}
    .btn.brand{background:var(--brand);color:#fff}
    .btn.secondary{background:#fff;border:1px solid var(--line)}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:16px}
    @media(max-width:960px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:26px;
      box-shadow:var(--shadow);padding:18px}
    .h1{font-size:36px;font-weight:900}
    .muted{color:var(--muted)}
    .plans{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
    @media(max-width:960px){.plans{grid-template-columns:1fr}}
    .plan{border:1px solid var(--line);border-radius:18px;padding:14px;cursor:pointer}
    .plan.active{border-color:var(--brand)}
    .price{font-size:22px;font-weight:900}
    .msg{margin-top:10px;padding:10px;border-radius:12px;border:1px solid var(--line)}
    .msg.err{border-color:rgba(185,28,28,.3);background:rgba(185,28,28,.06);color:var(--danger)}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <a class="pill" href="/index.html">← 回首頁</a>
      <div class="pill" id="who">未登入</div>
      <a class="pill" href="/account/subscription.html">我的訂閱 →</a>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="h1">結帳</div>
  <div class="muted">完成付款後即開通訂閱</div>

  <div class="grid">
    <section class="card">
      <div class="muted">方案</div>

      <div class="plans" id="plans">
        <div class="plan" data-plan="month">
          <div>月方案</div>
          <div class="price">NT$ 1,000</div>
        </div>
        <div class="plan" data-plan="semi">
          <div>半年方案</div>
          <div class="price">NT$ 5,400</div>
        </div>
        <div class="plan" data-plan="year">
          <div>一年方案</div>
          <div class="price">NT$ 9,600</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <span class="muted">推薦碼：</span>
        <b id="refText">—</b>
      </div>

      <div style="margin-top:14px">
        <button class="btn brand" id="btnPay">前往付款</button>
        <a class="btn secondary" href="javascript:history.back()">返回</a>
      </div>

      <div id="msg" class="msg err" style="display:none"></div>
    </section>

    <section class="card">
      <div class="muted">本次應付</div>
      <div style="font-size:44px;font-weight:900" id="payAmount">NT$ -</div>
      <div class="muted">含推薦折扣（若適用）</div>
    </section>
  </div>
</main>

<script>
const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_ANON_KEY";
const FN_CREATE_ECPAY_ORDER = SUPABASE_URL + "/functions/v1/create-ecpay-order";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const PRICE = { month:1000, semi:5400, year:9600 };
const REF_KEY = "bw_ref";

const $ = id => document.getElementById(id);

function getQueryRef(){
  return (new URL(location.href).searchParams.get("ref")||"").trim();
}
function getStoredRef(){ return localStorage.getItem(REF_KEY)||""; }
function setStoredRef(v){
  if(v) localStorage.setItem(REF_KEY,v);
  else localStorage.removeItem(REF_KEY);
}
function ntd(n){ return "NT$ "+n.toLocaleString("en-US"); }

let currentPlan="month";
let finalRef="";

async function refreshUser(){
  const {data}=await sb.auth.getUser();
  if(data?.user){
    $("who").textContent=data.user.email;
    return data.user;
  }
  $("who").textContent="未登入";
  return null;
}

async function resolveRef(user){
  let ref = getQueryRef() || getStoredRef();
  if(ref) setStoredRef(ref);

  const {data}=await sb.from("profiles")
    .select("referral_code").eq("id",user.id).single();
  if(ref && data?.referral_code===ref){
    ref="";
    setStoredRef("");
  }
  finalRef=ref;
  $("refText").textContent=ref||"—";
}

function refreshAmount(){
  let base=PRICE[currentPlan];
  let pay=finalRef?Math.round(base*0.9):base;
  $("payAmount").textContent=ntd(pay);
}

(async()=>{
  const user=await refreshUser();
  if(!user){$("msg").style.display="block";$("msg").textContent="請先登入";return;}
  await resolveRef(user);

  document.querySelectorAll(".plan").forEach(p=>{
    p.onclick=()=>{
      currentPlan=p.dataset.plan;
      document.querySelectorAll(".plan").forEach(x=>x.classList.remove("active"));
      p.classList.add("active");
      refreshAmount();
    };
  });
  document.querySelector('.plan[data-plan="month"]').classList.add("active");
  refreshAmount();

  $("btnPay").onclick=async()=>{
    try{
      const {data}=await sb.auth.getSession();
      const token=data.session.access_token;
      const res=await fetch(FN_CREATE_ECPAY_ORDER,{
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization":"Bearer "+token
        },
        body:JSON.stringify({
          period:currentPlan,
          referral_code:finalRef||null
        })
      });
      const out=await res.json();
      if(!out.ok) throw out;
      document.open();document.write(out.html);document.close();
    }catch(e){
      $("msg").style.display="block";
      $("msg").textContent="付款失敗";
    }
  };
})();
</script>
</body>
</html>































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































