<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js';

const supabase = createClient(
  'https://jeajrwpmrgczimmrflxo.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do'
);

// ⭐ 守門：如果沒登入，強制回 login.html
const { data: { session } } = await supabase.auth.getSession();

if (!session) {
  alert("請先登入才能訂閱方案！");
  window.location.href = "login.html";
}
</script>


<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>結帳 - BookWide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --bg:#ffffff; --text:#111827; --muted:#6b7280; --border:#e5e7eb;
      --accent:#2563eb; --danger:#b91c1c; --ok:#065f46;
      --chip:#111827; --chipText:#f9fafb;
    }
    html,body{
      margin:0; padding:0;
      background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","Microsoft JhengHei",sans-serif;
    }
    a{color:var(--accent);text-decoration:none;}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px 40px;}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
    .btn-link{display:inline-flex;align-items:center;gap:4px;font-size:.95rem;}
    h1{font-size:32px;margin:12px 0 20px;}
    .layout{display:grid;grid-template-columns:minmax(0,3fr) minmax(0,2.4fr);gap:20px;}
    @media(max-width:880px){ .layout{grid-template-columns:1fr;} }
    .card{border:1px solid var(--border);border-radius:16px;padding:18px;}
    .section-title{font-size:18px;font-weight:600;margin-bottom:12px;}
    .muted{color:var(--muted);}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:4px 0 10px;}
    .chip{
      display:inline-flex;align-items:center;justify-content:center;
      padding:4px 10px;border-radius:999px;
      background:#f3f4f6;color:#111827;font-size:.9rem;
      border:1px solid #e5e7eb;
    }
    .chip.main{background:var(--chip);color:var(--chipText);font-weight:600;}
    dl{margin:0;}
    .row{display:flex;align-items:center;justify-content:space-between;margin:6px 0;}
    .row span.label{color:var(--muted);}
    .row.total{border-top:1px dashed var(--border);margin-top:12px;padding-top:8px;font-size:1.05rem;font-weight:700;}
    .tag-plan{display:inline-flex;align-items:center;border-radius:999px;padding:4px 10px;font-size:.85rem;background:#eff6ff;color:#1d4ed8;font-weight:600;}
    .note{font-size:.9rem;color:var(--muted);margin-top:6px;}
    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:16px;}
    .btn{
      border:none;border-radius:999px;padding:10px 16px;
      font-size:.95rem;font-weight:600;cursor:pointer;
      display:inline-flex;align-items:center;gap:6px;
    }
    .btn.primary{background:#16a34a;color:#fff;}
    .btn.danger{background:#fee2e2;color:#991b1b;}
    .btn.outline{background:#fff;border:1px solid #111827;color:#111827;}
    .btn[disabled]{opacity:.6;cursor:not-allowed;}
    .receipt-list{padding-left:20px;margin:6px 0 0;}
    .status-msg{margin-top:10px;font-size:.9rem;}
    .status-ok{color:var(--ok);}
    .status-err{color:var(--danger);}
    .badge-sim{display:inline-flex;align-items:center;border-radius:999px;padding:3px 8px;font-size:.8rem;background:#fef3c7;color:#92400e;margin-left:8px;}
    .field-row{margin-top:10px;font-size:.9rem;}
    .field-row label{display:block;margin-bottom:4px;color:var(--muted);}
    .field-row input{
      width:100%;padding:8px 10px;border-radius:8px;border:1px solid var(--border);
      font:inherit;
    }
  </style>
  <script>
    // 與 subscription.html 相同的全域設定（可由外部注入，如果已在全站設定可以移除這裡）
    window.SB_URL  = window.SB_URL  || "https://jeajrwpmrgczimmrflxo.supabase.co";
    window.SB_ANON = window.SB_ANON || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <a class="btn-link" href="pricing.html">← 返回方案與定價</a>
    <span class="muted">模擬付款模式（尚未串接線上金流）</span>
  </div>

  <h1>結帳</h1>

  <div class="layout">
    <!-- 左側：訂單摘要 -->
    <div class="card">
      <div class="section-title">訂單摘要 <span id="planBadge" class="tag-plan"></span></div>
      <div class="muted" style="margin-bottom:10px;">帳號：<span id="userEmail">尚未登入</span></div>

      <div>
        <div class="muted">方案</div>
        <div class="chips" id="topicChips"></div>
      </div>

      <div class="field-row">
        <label for="refInput">推薦碼（選填）</label>
        <input id="refInput" type="text" placeholder="若有朋友推薦，可輸入推薦碼，可享 10% 折扣">
      </div>

      <dl style="margin-top:14px;">
        <div class="row">
          <span class="label">小計</span>
          <span id="subtotalText">NT$0</span>
        </div>
        <div class="row">
          <span class="label">推薦折扣（10%）</span>
          <span id="discountText">-NT$0</span>
        </div>
        <div class="row">
          <span class="label">稅額（5%）</span>
          <span id="taxText">NT$0</span>
        </div>
        <div class="row total">
          <span>應付金額</span>
          <span id="totalText">NT$0</span>
        </div>
      </dl>

      <p class="note">目前為模擬付款模式：付款結果只會寫入 Supabase 訂單資料，不會產生實際金流與 Email 通知。</p>

      <div class="btns">
        <button id="btnPaySuccess" class="btn primary">模擬付款成功</button>
        <button id="btnPayFail" class="btn danger">模擬付款失敗</button>
        <button id="btnPrint" class="btn outline">列印帳單 / 存 PDF</button>
      </div>

      <div id="status" class="status-msg"></div>
    </div>

    <!-- 右側：帳單預覽 -->
    <div class="card">
      <div class="section-title">帳單預覽 <span class="badge-sim">印出時僅輸出此區塊</span></div>
      <p class="muted" style="margin-top:0;">僅供模擬，實際付款通知以未來綠界或金流系統為準。</p>
      <hr style="border:none;border-top:1px dashed var(--border);margin:12px 0;">
      <h3 style="margin:0 0 4px;">BookWide 訂閱方案</h3>
      <div class="muted" style="font-size:.9rem;margin-bottom:10px;">
        帳單日期：<span id="billDate"></span><br>
        帳號：<span id="billEmail">尚未登入</span>
      </div>
      <div>
        <strong>內容：</strong>
        <ul id="billItems" class="receipt-list"></ul>
      </div>
      <div style="margin-top:10px;font-size:.95rem;">
        <div class="row">
          <span class="label">小計</span>
          <span id="billSubtotal">NT$0</span>
        </div>
        <div class="row">
          <span class="label">推薦折扣（10%）</span>
          <span id="billDiscount">-NT$0</span>
        </div>
        <div class="row">
          <span class="label">稅額（5%）</span>
          <span id="billTax">NT$0</span>
        </div>
        <div class="row total">
          <span>應付金額</span>
          <span id="billTotal">NT$0</span>
        </div>
      </div>
      <p class="note">若您對訂閱或付款有疑問，請聯絡客服或日後的付款通知信客服信箱。</p>
    </div>
  </div>
</div>

<script>
(function(){
  const supabase = window.supabase.createClient(window.SB_URL, window.SB_ANON);

  const TOPIC_LABELS = {
    story: '故事 Story',
    music: '音樂 Music',
    movie: '電影 Movie',
    news: '新聞 News',
    pro: '專業行業 Professional'
  };

  const PLAN_LABELS = {
    month: '月繳',
    halfyear: '半年繳',
    year: '年繳'
  };

  // 每個主題的單價（新台幣）
  const PRICE_PER_TOPIC = {
    month: 200,
    halfyear: 1000,
    year: 1800
  };

  const qs = new URLSearchParams(location.search);
  const topicsParam = qs.get('topics') || '';
  const plan = qs.get('plan') || 'month';
  const initRef = qs.get('ref') || '';

  const topics = topicsParam
    .split(',')
    .map(s => s.trim())
    .filter(s => !!s && TOPIC_LABELS[s]);

  // 填初始推薦碼
  document.getElementById('refInput').value = initRef;

  const elChips = document.getElementById('topicChips');
  const elPlanBadge = document.getElementById('planBadge');

  function currency(n){
    return 'NT$' + Number(Math.round(n)).toLocaleString('zh-TW');
  }

  function calcAndRender(){
    const refCode = document.getElementById('refInput').value.trim();
    const pricePer = PRICE_PER_TOPIC[plan] || PRICE_PER_TOPIC.month;
    const count = topics.length || 0;
    const subtotal = pricePer * count;
    const discount = refCode ? (subtotal * 0.10) : 0; // 推薦折扣 10%
    const taxable = subtotal - discount;
    const tax = taxable * 0.05; // 稅額 5%
    const total = taxable + tax;

    // 左側
    document.getElementById('subtotalText').textContent = currency(subtotal);
    document.getElementById('discountText').textContent = '-' + currency(discount);
    document.getElementById('taxText').textContent = currency(tax);
    document.getElementById('totalText').textContent = currency(total);

    // 右側
    document.getElementById('billSubtotal').textContent = currency(subtotal);
    document.getElementById('billDiscount').textContent = '-' + currency(discount);
    document.getElementById('billTax').textContent = currency(tax);
    document.getElementById('billTotal').textContent = currency(total);

    return { subtotal, discount, tax, total, refCode };
  }

  // 主題顯示
  if (topics.length === 0){
    elChips.innerHTML = '<span class="muted">未選擇主題，請回上一頁重新選擇。</span>';
  }else{
    elChips.innerHTML = topics.map(key=>{
      const label = TOPIC_LABELS[key] || key;
      return '<span class="chip">'+label+'</span>';
    }).join('');
  }
  elPlanBadge.textContent = PLAN_LABELS[plan] || '月繳';

  // 帳單右側明細列表
  const billItems = document.getElementById('billItems');
  if (topics.length){
    billItems.innerHTML = topics.map(k=>{
      const label = TOPIC_LABELS[k] || k;
      return '<li>'+label+' × 1</li>';
    }).join('');
  }else{
    billItems.innerHTML = '<li class="muted">尚未選擇主題</li>';
  }

  // 帳單日期
  const today = new Date();
  document.getElementById('billDate').textContent = today.toLocaleDateString('zh-TW');

  // 監聽推薦碼變化重新計算
  document.getElementById('refInput').addEventListener('input', calcAndRender);

  // 初次計算
  let lastCalc = calcAndRender();

  // 讀取登入使用者 email
  (async ()=>{
    const { data: { user } } = await supabase.auth.getUser();
    const email = user?.email || '尚未登入';
    document.getElementById('userEmail').textContent = email;
    document.getElementById('billEmail').textContent = email;
  })();

  function setStatus(msg, ok){
    const el = document.getElementById('status');
    el.textContent = msg;
    el.className = 'status-msg ' + (ok ? 'status-ok' : 'status-err');
  }

  function setLoading(isLoading){
    document.getElementById('btnPaySuccess').disabled = isLoading;
    document.getElementById('btnPayFail').disabled = isLoading;
  }

  // 付款成功
  document.getElementById('btnPaySuccess').addEventListener('click', async ()=>{
    setStatus('', true);
    setLoading(true);
    lastCalc = calcAndRender();

    try{
      const { data: { user }, error: userErr } = await supabase.auth.getUser();
      if (userErr) throw userErr;
      if (!user){
        setStatus('請先登入帳號，再進行結帳。', false);
        setLoading(false);
        return;
      }

      if (!topics.length){
        setStatus('未選擇主題，請先回上一頁選擇方案。', false);
        setLoading(false);
        return;
      }

      const now = new Date();
      const expire = new Date(now);
      if (plan === 'year'){
        expire.setFullYear(expire.getFullYear() + 1);
      }else if (plan === 'halfyear'){
        expire.setMonth(expire.getMonth() + 6);
      }else{
        expire.setMonth(expire.getMonth() + 1);
      }

      const subtotalWithTax = lastCalc.subtotal - lastCalc.discount + lastCalc.tax;
      const subtotalCents = Math.round(subtotalWithTax * 100);
      const discountCents = Math.round(lastCalc.discount * 100);
      const commissionCents = Math.round((lastCalc.refCode ? (lastCalc.subtotal * 0.10) : 0) * 100);

      // 寫入 orders
      const orderPayload = {
        buyer_id: user.id,
        items: topics,
        period: plan,
        subtotal_cents: subtotalCents,
        discount_cents: discountCents,
        commission_cents: commissionCents,
        status: 'paid',
        paid_at: now.toISOString(),
        expire_at: expire.toISOString(),
        referral_code: lastCalc.refCode || null
      };

      const { data: newOrder, error: orderErr } = await supabase
        .from('orders')
        .insert(orderPayload)
        .select()
        .single();

      if (orderErr) throw orderErr;

      // 更新 profiles：plan / plan_name / expires_at
      await supabase
        .from('profiles')
        .update({
          plan: plan,
          plan_name: topics.join(','),
          expires_at: expire.toISOString()
        })
        .eq('id', user.id);

      setStatus('模擬付款成功，訂單已寫入，將跳轉到「我的訂閱」。', true);
      setTimeout(()=>{
        location.href = 'account/subscription.html';
      }, 800);

    }catch(err){
      console.error(err);
      setStatus('寫入訂單時發生錯誤：' + (err.message || err), false);
      setLoading(false);
    }
  });

  // 付款失敗
  document.getElementById('btnPayFail').addEventListener('click', ()=>{
    setStatus('已模擬付款失敗，未寫入任何訂單。', false);
  });

  // 列印 / 存 PDF
  document.getElementById('btnPrint').addEventListener('click', ()=>{
    window.print();
  });
})();
</script>
</body>
</html>














