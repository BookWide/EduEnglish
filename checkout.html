<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide｜結帳</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#f4f6fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --brand:#2563eb; --brand2:#111827; --danger:#b91c1c; --ok:#065f46; --warn:#92400e;
      --radius:18px; --shadow:0 10px 30px rgba(15,23,42,.08);
      --soft:#f8fafc;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);
      font-family:system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif}
    a{color:inherit;text-decoration:none}
    header{position:sticky;top:0;z-index:20;background:rgba(244,246,251,.92);
      backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid var(--line)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .pill{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;
      display:inline-flex;gap:8px;align-items:center;box-shadow:0 6px 18px rgba(15,23,42,.06);font-size:13px}
    .pill.bad{border-color:rgba(185,28,28,.25);background:rgba(185,28,28,.06);color:var(--danger)}
    .pill.ok{border-color:rgba(6,95,70,.25);background:rgba(6,95,70,.06);color:var(--ok)}
    .pill.warn{border-color:rgba(146,64,14,.25);background:rgba(146,64,14,.06);color:var(--warn)}
    .grid{display:grid;grid-template-columns:1.4fr .9fr;gap:16px;margin-top:14px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }
    .card{background:var(--card);border:1px solid var(--line);border-radius:24px;box-shadow:var(--shadow);padding:18px}
    h1{margin:10px 0 4px;font-size:36px;letter-spacing:.5px}
    .muted{color:var(--muted)}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .kv{display:grid;grid-template-columns:84px 1fr;gap:8px 10px;margin-top:10px}
    .k{color:var(--muted)}
    .v{font-weight:800}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .hr{height:1px;background:var(--line);margin:14px 0}
    .plans{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    @media (max-width:720px){ .plans{grid-template-columns:1fr} }
    .plan{border:1px solid var(--line);border-radius:18px;padding:14px 14px;background:#fff;cursor:pointer}
    .plan.active{border-color:var(--brand);box-shadow:0 0 0 4px rgba(37,99,235,.12)}
    .planTitle{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .badge{font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:var(--soft);color:#334155}
    .price{font-weight:950;font-size:22px;margin-top:6px}
    .subprice{font-size:12px;color:var(--muted);margin-top:4px}
    .strike{color:#94a3b8;text-decoration:line-through}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{border:0;border-radius:999px;padding:12px 18px;background:var(--brand2);color:#fff;cursor:pointer;font-weight:900}
    .btn.brand{background:var(--brand)}
    .btn.ghost{background:#fff;color:var(--ink);border:1px solid var(--line)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .msg{margin-top:12px;padding:12px 14px;border-radius:14px;border:1px solid var(--line);background:#fff;white-space:pre-wrap;word-break:break-word}
    .msg.err{border-color:rgba(185,28,28,.25);background:rgba(185,28,28,.06);color:var(--danger)}
    .msg.ok{border-color:rgba(6,95,70,.25);background:rgba(6,95,70,.06);color:var(--ok)}
    .tiny{font-size:12px;color:var(--muted)}
    .rightBox{position:sticky;top:86px}
    @media (max-width:980px){ .rightBox{position:static} }
    .total{font-size:28px;font-weight:950}
    .totalRow{display:flex;align-items:flex-end;justify-content:space-between;gap:10px}
    .foot{padding:24px 0;text-align:center;color:var(--muted)}
    .debug{display:none;margin-top:10px}
    .debug pre{margin:0;font-size:12px;white-space:pre-wrap;word-break:break-word}

    /* mobile bottom bar */
    .bottomBar{
      position:fixed;left:0;right:0;bottom:0;z-index:30;
      background:rgba(244,246,251,.92);backdrop-filter:saturate(180%) blur(10px);
      border-top:1px solid var(--line);
      display:none;
    }
    .bottomInner{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:12px;justify-content:space-between}
    .bottomPay{display:flex;gap:10px;align-items:center}
    @media (max-width:980px){
      .bottomBar{display:block}
      body{padding-bottom:76px}
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <a class="pill" href="/index.html">← 回首頁</a>
      <div class="pill" id="who">未登入</div>
      <a class="pill" href="/account/subscription.html">我的訂閱 →</a>
    </div>
  </div>
</header>

<main class="wrap">
  <h1>結帳</h1>
  <div class="muted">選擇方案後付款（後端 create-ecpay-order 會建立訂單並回傳自動送出的綠界表單）。</div>

  <div class="grid">
    <!-- LEFT -->
    <section class="card">
      <div class="row">
        <div>
          <div class="muted" style="font-weight:800">課程</div>
          <div class="v" id="topicsText">-</div>
        </div>

        <div style="text-align:right">
          <div class="muted" style="font-weight:800">推薦碼</div>
          <div class="v mono" id="refText">-</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div>
          <div class="muted" style="font-weight:800">方案</div>
          <div class="v" id="planText">-</div>
        </div>

        <div id="discountPillWrap"></div>
      </div>

      <div class="plans" id="plans">
        <div class="plan" data-plan="month">
          <div class="planTitle">
            <div style="font-weight:950">月方案</div>
            <span class="badge">最常用</span>
          </div>
          <div class="price" id="p_month">NT$ 1,000</div>
          <div class="subprice" id="p_month_sub"></div>
        </div>

        <div class="plan" data-plan="semi">
          <div class="planTitle">
            <div style="font-weight:950">半年方案</div>
            <span class="badge">省更多</span>
          </div>
          <div class="price" id="p_semi">NT$ 5,400</div>
          <div class="subprice" id="p_semi_sub"></div>
        </div>

        <div class="plan" data-plan="year">
          <div class="planTitle">
            <div style="font-weight:950">一年方案</div>
            <span class="badge">最優惠</span>
          </div>
          <div class="price" id="p_year">NT$ 9,600</div>
          <div class="subprice" id="p_year_sub"></div>
        </div>
      </div>

      <div class="btnRow">
        <button class="btn brand" id="btnPay">綠界付款（Stage/Prod 由後端決定）</button>
        <button class="btn ghost" id="btnBack">返回上一頁</button>
      </div>

      <div id="msg" class="msg" style="display:none"></div>

      <div class="debug" id="debug">
        <div class="msg">
          <div class="tiny" style="font-weight:900;margin-bottom:6px">Debug</div>
          <pre id="debugText" class="mono"></pre>
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="rightBox">
      <section class="card">
        <div class="totalRow">
          <div>
            <div class="muted" style="font-weight:900">本次應付</div>
            <div class="total" id="payAmount">NT$ -</div>
            <div class="tiny" id="payHint"></div>
          </div>
          <div id="payStatusPill"></div>
        </div>

        <div class="hr"></div>

        <div class="kv">
          <div class="k">原價</div><div class="mono" id="origAmount">-</div>
          <div class="k">折扣</div><div class="mono" id="discountText">-</div>
          <div class="k">期間</div><div class="mono" id="periodText">-</div>
        </div>

        <div class="hr"></div>

        <div class="tiny">
          • create-ecpay-order：insert orders(pending) → 回傳表單 HTML → 送綠界<br/>
          • 付款完成：綠界呼叫 ecpay-return → orders 改 paid → 寫 expire_at → upsert subscriptions
        </div>
      </section>
    </aside>
  </div>

  <div class="foot">BookWide © 2025</div>
</main>

<!-- mobile bottom bar -->
<div class="bottomBar" id="bottomBar">
  <div class="bottomInner">
    <div>
      <div class="tiny" style="font-weight:900">本次應付</div>
      <div style="font-weight:950;font-size:20px" id="payAmount2">NT$ -</div>
    </div>
    <div class="bottomPay">
      <button class="btn brand" id="btnPay2">付款</button>
      <button class="btn ghost" id="btnBack2">返回</button>
    </div>
  </div>
</div>

<script>
/* =========================
   ✅ 只要確認這兩個
========================= */
const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";

const FN_CREATE_ECPAY_ORDER = `${SUPABASE_URL}/functions/v1/create-ecpay-order`;

/* ========================= */
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const $ = (id)=>document.getElementById(id);

const PRICE_NTD = { month: 1000, semi: 5400, year: 9600 };   // 顯示用（元）
const DISCOUNT_RATE = 0.10;                                  // 10% 折扣

function showMsg(type, text){
  const box = $("msg");
  box.style.display = "block";
  box.className = "msg " + (type === "ok" ? "ok" : "err");
  box.textContent = text;
}
function showDbg(obj){
  $("debug").style.display = "block";
  $("debugText").textContent = (typeof obj === "string") ? obj : JSON.stringify(obj, null, 2);
}

function fmtNTD(n){
  if (n == null || isNaN(n)) return "NT$ -";
  return "NT$ " + Number(n).toLocaleString("en-US");
}
function normPlan(p){
  const s = String(p||"").toLowerCase().trim();
  if (["semi","half","6m","halfyear","half-year"].includes(s)) return "semi";
  if (["year","y","12m","yearly"].includes(s)) return "year";
  return "month";
}
function planToPeriod(plan){
  if (plan === "semi") return "half";
  if (plan === "year") return "year";
  return "month";
}
function parseQuery(){
  const u = new URL(location.href);
  // topics=story,music,...（你原本用 %2C 也 OK）
  const topics = (u.searchParams.get("topics") || "")
    .split(",")
    .map(s=>decodeURIComponent(s))
    .map(s=>s.trim())
    .filter(Boolean);

  const plan = normPlan(u.searchParams.get("plan") || "month");

  // 推薦碼：ref=45845
  const ref = (u.searchParams.get("ref") || "").trim();

  return { topics, plan, ref };
}
function safeTopicsFallback(arr){
  if (Array.isArray(arr) && arr.length) return arr;
  return ["story","music","movie","news","pro"];
}

function computeAmount(plan, ref){
  const original = PRICE_NTD[plan] || PRICE_NTD.month;
  const hasRef = !!ref;
  const discounted = hasRef ? Math.round(original * (1 - DISCOUNT_RATE)) : original;
  const discount = original - discounted;
  return { hasRef, original, discounted, discount };
}

function setActivePlan(plan){
  document.querySelectorAll(".plan").forEach(el=>{
    el.classList.toggle("active", el.dataset.plan === plan);
  });
  $("planText").textContent = (plan === "semi") ? "半年方案" : (plan === "year") ? "一年方案" : "月方案";
  $("periodText").textContent = (plan === "semi") ? "半年（half）" : (plan === "year") ? "一年（year）" : "月（month）";
}

function renderPrices(plan, ref){
  const { hasRef, original, discounted, discount } = computeAmount(plan, ref);

  // 方案卡：顯示折扣後（如果有 ref）
  ["month","semi","year"].forEach(p=>{
    const orig = PRICE_NTD[p];
    const hasRef2 = !!ref;
    const disc = hasRef2 ? Math.round(orig * (1 - DISCOUNT_RATE)) : orig;
    $(p === "month" ? "p_month" : p === "semi" ? "p_semi" : "p_year").textContent = fmtNTD(orig);
    const subId = (p === "month") ? "p_month_sub" : (p === "semi") ? "p_semi_sub" : "p_year_sub";
    if (hasRef2){
      $(subId).innerHTML = `<span class="strike">${fmtNTD(orig)}</span> → <b style="color:var(--ok)">${fmtNTD(disc)}</b>（已套用 9 折）`;
    } else {
      $(subId).textContent = "";
    }
  });

  // 右側總結
  $("payAmount").textContent = fmtNTD(discounted);
  $("payAmount2").textContent = fmtNTD(discounted);
  $("origAmount").textContent = fmtNTD(original);
  $("discountText").textContent = hasRef ? (`- ${fmtNTD(discount)}（9 折）`) : "-";
  $("payHint").textContent = hasRef ? "已套用推薦碼折扣；付款金額以此為準（送後端 amount_cents）" : "未使用推薦碼（原價付款）";

  // 折扣 pill
  const wrap = $("discountPillWrap");
  wrap.innerHTML = "";
  if (hasRef){
    const pill = document.createElement("div");
    pill.className = "pill ok";
    pill.textContent = "已套用 9 折";
    wrap.appendChild(pill);
  }

  // pay status pill
  const ps = $("payStatusPill");
  ps.innerHTML = "";
  const p2 = document.createElement("div");
  p2.className = hasRef ? "pill ok" : "pill";
  p2.textContent = hasRef ? "折扣生效" : "原價";
  ps.appendChild(p2);
}

async function refreshUser(){
  const { data: authData } = await sb.auth.getUser();
  const user = authData?.user;
  if (user?.id){
    $("who").textContent = (user.email || "已登入") + " · " + user.id.slice(0,8);
  } else {
    $("who").textContent = "未登入（請先登入再付款）";
  }
  return user;
}

async function getAccessToken(){
  // ✅ 用 session 拿 token（解 Missing Authorization Bearer token）
  const { data } = await sb.auth.getSession();
  return data?.session?.access_token || "";
}

async function callCreateEcpayOrder(payload){
  const token = await getAccessToken();
  if (!token) throw new Error("Missing Authorization Bearer token（請重新登入後再試）");

  const res = await fetch(FN_CREATE_ECPAY_ORDER, {
    method: "POST",
    headers: {
      "Content-Type":"application/json",
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": "Bearer " + token,
    },
    body: JSON.stringify(payload),
  });

  const json = await res.json().catch(()=> ({}));

  if (!res.ok || !json?.ok){
    const msg = (json?.message || "create-ecpay-order failed");
    const detail = (json?.detail ? ("\n" + String(json.detail)) : "");
    throw new Error(msg + detail);
  }
  return json;
}

function submitReturnedHtml(html){
  document.open();
  document.write(html);
  document.close();
}

function bindBack(){
  const goBack = ()=>{ if (history.length > 1) history.back(); else location.href="/pricing.html"; };
  $("btnBack").onclick = goBack;
  $("btnBack2").onclick = goBack;
}

function bindPlanClicks(){
  $("plans").addEventListener("click", (e)=>{
    const el = e.target.closest(".plan");
    if (!el) return;
    const p = el.dataset.plan;
    const u = new URL(location.href);
    u.searchParams.set("plan", p);
    history.replaceState({}, "", u.toString());
    const q = parseQuery();
    setActivePlan(normPlan(p));
    renderPrices(normPlan(p), q.ref);
  });
}

async function handlePay(){
  const user = await refreshUser();
  if (!user?.id){
    showMsg("err","你尚未登入：請先回首頁登入，再進行付款。");
    $("btnPay").disabled = true;
    $("btnPay2").disabled = true;
    $("who").classList.add("bad");
    return;
  }

  const doPay = async ()=>{
    try{
      $("msg").style.display="none";
      $("debug").style.display="none";

      $("btnPay").disabled = true;
      $("btnPay2").disabled = true;

      const q = parseQuery();
      const topics = safeTopicsFallback(q.topics);
      const plan = normPlan(q.plan);
      const period = planToPeriod(plan);

      const amt = computeAmount(plan, q.ref);

      // ✅ 折扣後的金額用「分」傳給後端（cents），讓後端用它送綠界
      // 例如 NT$900 -> 90000
      const amount_cents = amt.discounted * 100;
      const original_amount_cents = amt.original * 100;

      const payload = {
        user_id: user.id,
        email: user.email,
        items: topics,
        period,                        // month/half/year
        referral_code: q.ref || null,  // 推薦碼
        amount_cents,                  // ✅ 折扣後（請後端用這個當 TotalAmount/TradeAmt）
        original_amount_cents,         // 原價（用於分潤計算/顯示）
        discount_rate: amt.hasRef ? DISCOUNT_RATE : 0,
      };

      showDbg({ step:"calling create-ecpay-order", endpoint: FN_CREATE_ECPAY_ORDER, payload });

      const out = await callCreateEcpayOrder(payload);

      showDbg({ ok:true, order_id: out.order_id, merchant_trade_no: out.merchant_trade_no, sent_amount_cents: amount_cents });

      submitReturnedHtml(out.html);

    }catch(err){
      showMsg("err", "送出失敗：\n" + (err?.message || err));
      showDbg(String(err?.stack || err));
    }finally{
      $("btnPay").disabled = false;
      $("btnPay2").disabled = false;
    }
  };

  $("btnPay").onclick = doPay;
  $("btnPay2").onclick = doPay;
}

(function init(){
  bindBack();

  const q = parseQuery();
  const topics = safeTopicsFallback(q.topics);
  const plan = normPlan(q.plan);

  $("topicsText").textContent = topics.join(", ");
  $("refText").textContent = q.ref ? q.ref : "-";

  if (q.ref){
    $("refText").style.color = "var(--ok)";
    $("refText").style.fontWeight = "950";
  }

  setActivePlan(plan);
  renderPrices(plan, q.ref);
  bindPlanClicks();

  handlePay();
})();
</script>

</body>
</html>



























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































