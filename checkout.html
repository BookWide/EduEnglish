<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide｜結帳</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#f4f6fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --brand:#2563eb; --danger:#b91c1c; --ok:#065f46; --soft:#eff6ff;
      --radius:18px; --shadow:0 10px 30px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif}
    a{color:inherit;text-decoration:none}
    header{position:sticky;top:0;z-index:10;background:rgba(244,246,251,.9);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid var(--line)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .pill{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;display:inline-flex;gap:8px;align-items:center}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:16px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    .h1{font-size:34px;margin:12px 0 4px}
    .muted{color:var(--muted)}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .k{color:var(--muted);min-width:90px}
    .v{font-weight:800}
    .plans{display:flex;flex-direction:column;gap:10px;margin-top:14px}
    .plan{
      border:1px solid var(--line);border-radius:16px;padding:14px 16px;background:#fff;cursor:pointer;
      display:flex;justify-content:space-between;align-items:center;gap:10px;
    }
    .plan .left{display:flex;flex-direction:column;gap:4px}
    .plan .name{font-weight:900}
    .plan .sub{font-size:12px;color:var(--muted)}
    .plan .price{font-size:26px;font-weight:950;letter-spacing:.5px}
    .plan.active{border-color:var(--brand);box-shadow:0 0 0 3px rgba(37,99,235,.12)}
    .hr{height:1px;background:var(--line);margin:14px 0}
    .btn{border:0;border-radius:999px;padding:12px 18px;background:#111827;color:#fff;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--ink);border:1px solid var(--line)}
    .btn.brand{background:var(--brand)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .msg{margin-top:12px;padding:12px 14px;border-radius:14px;border:1px solid var(--line);background:#fff;white-space:pre-wrap;word-break:break-word}
    .msg.ok{border-color:rgba(6,95,70,.25);background:rgba(6,95,70,.06);color:var(--ok)}
    .msg.err{border-color:rgba(185,28,28,.25);background:rgba(185,28,28,.06);color:var(--danger)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;white-space:pre-wrap;word-break:break-word}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;color:var(--muted);font-size:12px}
    .badge{display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;background:var(--soft);color:var(--brand);border:1px solid rgba(37,99,235,.18);font-size:12px;font-weight:800}
    .sumTitle{font-size:26px;font-weight:950;margin:0}
    .sumBig{font-size:46px;font-weight:1000;letter-spacing:1px;margin:6px 0 6px}
    .sumLine{display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px dashed rgba(100,116,139,.25)}
    .sumLine:last-child{border-bottom:none}
    footer{padding:26px 0;color:var(--muted);text-align:center}
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <a class="pill" href="/index.html">← 回首頁</a>
        <div class="pill" id="who">未登入</div>
        <a class="pill" href="/account/subscription.html">我的訂閱 →</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="h1">結帳</div>
    <div class="muted">付款金額以後端 create-ecpay-order 計算為準（包含推薦碼折扣）。</div>

    <div class="grid">
      <!-- Left -->
      <section class="card">
        <div class="row">
          <div class="k">課程：</div>
          <div class="v" id="topicsText">-</div>
        </div>
        <div class="row" style="margin-top:8px">
          <div class="k">方案：</div>
          <div class="v" id="planText">-</div>
          <span class="chip" id="refChip" style="display:none">推薦碼：<b id="refText"></b></span>
          <span class="badge" id="discBadge" style="display:none">已套用 9 折</span>
        </div>

        <div class="plans" id="plans">
          <div class="plan" data-plan="month">
            <div class="left">
              <div class="name">月方案</div>
              <div class="sub" id="sub-month"></div>
            </div>
            <div class="price" id="price-month">NT$ 1,000</div>
          </div>

          <div class="plan" data-plan="half">
            <div class="left">
              <div class="name">半年方案</div>
              <div class="sub" id="sub-half"></div>
            </div>
            <div class="price" id="price-half">NT$ 5,400</div>
          </div>

          <div class="plan" data-plan="year">
            <div class="left">
              <div class="name">一年方案</div>
              <div class="sub" id="sub-year"></div>
            </div>
            <div class="price" id="price-year">NT$ 9,600</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <button class="btn brand" id="btnPay">綠界付款（Stage/Prod 由後端決定）</button>
          <a class="btn secondary" href="javascript:history.back()">返回上一頁</a>
        </div>

        <div id="msg" class="msg" style="display:none"></div>
        <div id="debug" class="msg" style="display:none"><div class="mono" id="debugText"></div></div>
      </section>

      <!-- Right -->
      <aside class="card">
        <p class="sumTitle">本次應付</p>
        <div class="sumBig" id="payBig">—</div>

        <div class="sumLine"><span class="muted">原價</span><b id="baseLine">—</b></div>
        <div class="sumLine"><span class="muted">折扣</span><b id="discLine">—</b></div>
        <div class="sumLine"><span class="muted">期間</span><b id="periodLine">—</b></div>

        <div class="hr"></div>
        <div class="muted" style="line-height:1.6">
          • 金額含推薦折扣（若有）<br/>
          • 金額會 100% 送到綠界 TotalAmount<br/>
          • 若綠界仍顯示原價，代表後端尚未帶入/或請求失敗
        </div>
      </aside>
    </div>

    <footer>BookWide © 2025</footer>
  </main>

<script>
  // ===================== 固定設定（你已給我） =====================
  const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
  const FN_CREATE = `${SUPABASE_URL}/functions/v1/create-ecpay-order`;

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ===================== UI helpers =====================
  const $ = (id)=>document.getElementById(id);
  const msgBox = $("msg");
  const dbgBox = $("debug");
  const dbgText = $("debugText");

  function showMsg(type, text){
    msgBox.style.display = "block";
    msgBox.className = "msg " + (type === "ok" ? "ok" : "err");
    msgBox.textContent = text;
  }
  function showDbg(obj){
    dbgBox.style.display = "block";
    dbgText.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
  }
  function money(n){
    const v = Number(n||0);
    return "NT$ " + v.toLocaleString("zh-Hant-TW");
  }

  // ===================== query / state =====================
  const PRICE = { month:1000, half:5400, year:9600 };

  function parseQuery(){
    const u = new URL(location.href);

    // topics 可能是 "story,music" 或被 %2C 編碼
    const rawTopics = u.searchParams.get("topics") || "";
    const topics = rawTopics
      .split(",")
      .map(s=>decodeURIComponent(s).trim())
      .filter(Boolean);

    // plan 你網址常用 monthly；統一映射
    const planRaw = (u.searchParams.get("plan") || "month").toLowerCase().trim();
    const plan = (planRaw === "monthly" || planRaw === "month") ? "month"
              : (planRaw === "semi" || planRaw === "half" || planRaw === "6m") ? "half"
              : (planRaw === "year" || planRaw === "12m") ? "year"
              : "month";

    // 推薦碼 ref 或 referral 或 referral_code
    const ref = (u.searchParams.get("ref") || u.searchParams.get("referral") || u.searchParams.get("referral_code") || "").trim();

    return { topics, plan, ref };
  }

  function updateUrlPlan(p){
    const u = new URL(location.href);
    u.searchParams.set("plan", p === "month" ? "monthly" : p); // 你原本用 monthly
    history.replaceState({}, "", u.toString());
  }

  function setActivePlan(plan){
    document.querySelectorAll(".plan").forEach(el=>{
      el.classList.toggle("active", el.dataset.plan === plan);
    });
    $("planText").textContent = (plan === "half") ? "半年方案" : (plan === "year") ? "一年方案" : "月方案";
  }

  function updateSummary(plan, ref){
    const base = PRICE[plan] ?? PRICE.month;
    const hasRef = !!ref;
    const disc = hasRef ? Math.round(base * 0.1) : 0;
    const pay = base - disc;

    $("baseLine").textContent = money(base);
    $("discLine").textContent = disc ? ("- " + money(disc) + "（9 折）") : money(0);
    $("periodLine").textContent = plan;
    $("payBig").textContent = money(pay);

    // 左側子描述
    $("sub-month").textContent = hasRef ? `原價 ${money(PRICE.month)} → ${money(PRICE.month - Math.round(PRICE.month*0.1))}（已套用 9 折）` : "";
    $("sub-half").textContent  = hasRef ? `原價 ${money(PRICE.half)} → ${money(PRICE.half - Math.round(PRICE.half*0.1))}（已套用 9 折）` : "";
    $("sub-year").textContent  = hasRef ? `原價 ${money(PRICE.year)} → ${money(PRICE.year - Math.round(PRICE.year*0.1))}（已套用 9 折）` : "";

    $("discBadge").style.display = hasRef ? "inline-flex" : "none";
    $("refChip").style.display = hasRef ? "inline-flex" : "none";
    $("refText").textContent = ref || "";
  }

  async function refreshUser(){
    const { data: { user } } = await sb.auth.getUser();
    if (user?.id) $("who").textContent = (user.email || "已登入") + " · " + user.id.slice(0,8);
    else $("who").textContent = "未登入";
    return user;
  }

  async function getAccessToken(){
    const { data: { session } } = await sb.auth.getSession();
    return session?.access_token || null;
  }

  function submitReturnedHtml(html){
    // 後端回傳完整自動送出表單 html
    document.open();
    document.write(html);
    document.close();
  }

  async function callCreateOrder(payload, token){
    const res = await fetch(FN_CREATE, {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        "Authorization": "Bearer " + token,
      },
      body: JSON.stringify(payload),
    });

    const json = await res.json().catch(()=> ({}));
    if (!res.ok || !json?.ok){
      const msg = json?.message || "create-ecpay-order failed";
      const detail = json?.detail ? ("\n" + String(json.detail)) : "";
      throw new Error(msg + detail);
    }
    return json;
  }

  // ===================== main =====================
  (async function(){
    const q = parseQuery();

    $("topicsText").textContent = (q.topics?.length ? q.topics.join(", ") : "story, music, movie, news, pro");
    setActivePlan(q.plan);
    updateSummary(q.plan, q.ref);

    // plan click
    $("plans").addEventListener("click", (e)=>{
      const el = e.target.closest(".plan");
      if (!el) return;
      const p = el.dataset.plan;
      updateUrlPlan(p);
      setActivePlan(p);
      const q2 = parseQuery();
      updateSummary(p, q2.ref);
    });

    // login state
    const user = await refreshUser();
    if (!user){
      showMsg("err", "請先登入後再付款");
      $("btnPay").disabled = true;
      return;
    }

    $("btnPay").addEventListener("click", async ()=>{
      try{
        msgBox.style.display="none";
        dbgBox.style.display="none";
        $("btnPay").disabled = true;

        const userNow = await refreshUser();
        if (!userNow) throw new Error("未登入");

        const token = await getAccessToken();
        if (!token) throw new Error("無法取得登入 token");

        const q3 = parseQuery();
        const topics = (q3.topics?.length ? q3.topics : ["story","music","movie","news","pro"]);
        const period = (q3.plan === "half") ? "half" : (q3.plan === "year") ? "year" : "month";

        const payload = {
          user_id: userNow.id,
          email: userNow.email,
          period,
          items: topics,
          referral_code: q3.ref || null,
        };

        showDbg({ endpoint: FN_CREATE, payload });

        const out = await callCreateOrder(payload, token);

        // out.html 送到綠界（折扣後金額由後端寫進 TotalAmount）
        submitReturnedHtml(out.html);

      }catch(err){
        showMsg("err", String(err?.message || err));
        showDbg(String(err?.stack || err));
      }finally{
        $("btnPay").disabled = false;
      }
    });

  })();
</script>
</body>
</html>












































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































