<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide｜結帳</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#f4f6fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --brand:#2563eb; --danger:#b91c1c; --ok:#065f46; --soft:#eff6ff;
      --radius:18px; --shadow:0 10px 30px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;}
    a{color:inherit;text-decoration:none}
    .topbar{
      position:sticky;top:0;z-index:50;
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 18px;background:rgba(244,246,251,.9);backdrop-filter:blur(8px);
      border-bottom:1px solid var(--line);
    }
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:10px 14px;border-radius:999px;border:1px solid var(--line);
      background:#fff;color:var(--ink);cursor:pointer;font-weight:600;
    }
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .chip{
      display:inline-flex;align-items:center;gap:6px;
      padding:5px 10px;border-radius:999px;background:#fff;border:1px solid var(--line);
      color:var(--muted);font-size:13px;
    }
    .wrap{max-width:1180px;margin:0 auto;padding:22px 18px 40px;}
    h1{margin:14px 0 6px;font-size:44px;letter-spacing:1px}
    .sub{margin:0 0 18px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:18px;align-items:start}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} h1{font-size:34px} }

    .panel{
      background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
      box-shadow:var(--shadow);padding:18px;
    }
    .row{display:flex;gap:18px;flex-wrap:wrap}
    .kv{min-width:260px}
    .k{color:var(--muted);font-size:14px}
    .v{font-weight:800;font-size:18px;margin-top:2px}
    .plans{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px}
    .plan{
      border:1.5px solid var(--line);border-radius:16px;padding:14px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      cursor:pointer;background:#fff;
    }
    .plan.active{border-color:var(--brand);box-shadow:0 0 0 4px rgba(37,99,235,.12)}
    .plan .name{font-weight:800;font-size:18px}
    .plan .price{font-weight:900;font-size:26px}
    .actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:16px}
    .notice{
      margin-top:12px;padding:12px 14px;border-radius:14px;border:1px solid var(--line);
      background:#fff;color:var(--muted);font-size:14px;line-height:1.5;
    }
    .err{
      margin-top:12px;padding:12px 14px;border-radius:14px;
      border:1px solid #fecaca;background:#fff1f2;color:var(--danger);font-weight:800;
    }
    .err pre{
      margin:8px 0 0;font-size:12px;white-space:pre-wrap;word-break:break-word;
      color:#7f1d1d;font-weight:600;
    }

    .sideTitle{font-weight:900;font-size:34px;margin:0 0 10px}
    .sideAmount{font-weight:950;font-size:54px;margin:0 0 8px}
    .sideList{margin:10px 0 0;padding-left:18px;color:var(--muted);line-height:1.6}
    .sideKV{margin-top:14px;border-top:1px solid var(--line);padding-top:14px}
    .sideKV .line{display:flex;justify-content:space-between;gap:10px;margin:8px 0}
    .sideKV .label{color:var(--muted)}
    .sideKV .val{font-weight:900}
    .muted{color:var(--muted)}
  </style>
</head>

<body>
  <div class="topbar">
    <a class="btn" href="/index.html">← 回首頁</a>
    <div class="chip" id="who">未登入</div>
    <a class="btn" href="/account/subscription.html">我的訂閱 →</a>
  </div>

  <div class="wrap">
    <h1>結帳</h1>
    <p class="sub">付款金額以後端 <b>create-ecpay-order</b> 計算為準</p>

    <div class="grid">
      <div class="panel">
        <div class="row">
          <div class="kv">
            <div class="k">課程：</div>
            <div class="v" id="topicsText">—</div>
          </div>
          <div class="kv">
            <div class="k">方案：</div>
            <div class="v" id="planText">—</div>
          </div>
          <div class="kv">
            <div class="k">推薦碼：</div>
            <div class="v" id="refText">—</div>
          </div>
        </div>

        <div class="plans" id="plans">
          <!-- cards -->
        </div>

        <div class="actions">
          <button class="btn primary" id="payBtn">綠界付款（Stage/Prod 由後端決定）</button>
          <button class="btn" id="backBtn">返回上一頁</button>
        </div>

        <div id="msgBox" class="notice">
          • 看到的「本次應付」會 100% 送到綠界 TotalAmount（由後端計算並填到 TotalAmount）。<br>
          • 如果綠界仍顯示原價，就代表後端沒吃到推薦碼或後端還沒改對。
        </div>

        <div id="errBox" class="err" style="display:none;">
          <div id="errTitle">送出失敗</div>
          <pre id="errDetail"></pre>
        </div>
      </div>

      <div class="panel">
        <div class="sideTitle">本次應付</div>
        <div class="sideAmount" id="payShow">—</div>
        <div class="muted" id="sideHint">• 金額含推薦折扣（若有）<br>• 金額會 100% 送到綠界 TotalAmount</div>

        <div class="sideKV">
          <div class="line"><div class="label">原價</div><div class="val" id="baseShow">—</div></div>
          <div class="line"><div class="label">折扣</div><div class="val" id="discShow">—</div></div>
          <div class="line"><div class="label">期間</div><div class="val" id="periodShow">—</div></div>
        </div>

        <ul class="sideList">
          <li>請先登入再付款（右上需出現 email）。</li>
          <li>付款後會依 ecpay-return 回寫 orders / 訂閱資訊（你的後端規則）。</li>
        </ul>
      </div>
    </div>
  </div>

<script>
  // ====== Supabase ======
  const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
  const FN_CREATE = `${SUPABASE_URL}/functions/v1/create-ecpay-order`;

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ====== UI helpers ======
  const $ = (id) => document.getElementById(id);
  const fmtNT = (n) => "NT$ " + Number(n).toLocaleString("zh-Hant-TW");

  function showErr(title, detail){
    $("errBox").style.display = "block";
    $("errTitle").textContent = title || "送出失敗";
    $("errDetail").textContent = detail || "";
  }
  function hideErr(){
    $("errBox").style.display = "none";
    $("errTitle").textContent = "";
    $("errDetail").textContent = "";
  }

  // ====== parse query ======
  const qs = new URLSearchParams(location.search);
  const topics = (qs.get("topics") || "").split(",").map(s => s.trim()).filter(Boolean);
  const ref = (qs.get("ref") || "").trim();
  const planQ = (qs.get("plan") || "monthly").toLowerCase().trim();

  // Our internal period keys: month / half / year
  const planMap = { monthly:"month", month:"month", m:"month", half:"half", halfyear:"half", semi:"half", yearly:"year", year:"year", annual:"year" };
  let selectedPeriod = planMap[planQ] || "month";

  const PRICES = { month:1000, half:5400, year:9600 };

  function computeSide(base, referral){
    const disc = referral ? Math.round(base * 0.1) : 0;
    const pay = Math.max(1, base - disc);
    return { base, disc, pay };
  }

  function render(){
    $("topicsText").textContent = topics.length ? topics.join(", ") : "story, music, movie, news, pro";
    $("refText").textContent = ref ? ref : "—";
    $("planText").textContent = (selectedPeriod === "half") ? "半年方案" : (selectedPeriod === "year") ? "一年方案" : "月方案";

    const { base, disc, pay } = computeSide(PRICES[selectedPeriod], ref);
    $("baseShow").textContent = fmtNT(base);
    $("discShow").textContent = fmtNT(disc);
    $("payShow").textContent  = fmtNT(pay);
    $("periodShow").textContent = selectedPeriod;

    const cards = [
      { key:"month", label:"月方案", price:PRICES.month },
      { key:"half",  label:"半年方案", price:PRICES.half },
      { key:"year",  label:"一年方案", price:PRICES.year },
    ];

    const wrap = $("plans");
    wrap.innerHTML = "";
    cards.forEach(c => {
      const div = document.createElement("div");
      div.className = "plan" + (c.key === selectedPeriod ? " active" : "");
      div.innerHTML = `
        <div>
          <div class="name">${c.label}</div>
          <div class="muted">${ref ? `${fmtNT(c.price)} → ${fmtNT(computeSide(c.price, ref).pay)}（已套用 9 折）` : fmtNT(c.price)}</div>
        </div>
        <div class="price">${fmtNT(c.price)}</div>
      `;
      div.onclick = () => { selectedPeriod = c.key; hideErr(); render(); };
      wrap.appendChild(div);
    });
  }

  async function loadAuth(){
    const { data } = await sb.auth.getSession();
    const session = data?.session || null;
    if (session?.user?.email){
      $("who").textContent = `${session.user.email} · ${session.user.id.slice(0,8)}`;
      $("payBtn").disabled = false;
      return session;
    } else {
      $("who").textContent = "未登入";
      $("payBtn").disabled = true;
      showErr("請先登入後再付款", "右上角需顯示 email，才會帶 Authorization 去呼叫 create-ecpay-order");
      return null;
    }
  }

  async function callCreateOrder(session){
    hideErr();
    $("payBtn").disabled = true;

    const payload = {
      period: selectedPeriod,
      referral_code: ref || null,
      items: topics.length ? topics : ["story","music","movie","news","pro"],
      // 這兩個不強制，但你有就送（後端也能用 Authorization 取 user_id）
      user_id: session?.user?.id || null,
      email: session?.user?.email || null,
    };

    try{
      const r = await fetch(FN_CREATE, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": SUPABASE_ANON_KEY,
          ...(session?.access_token ? { "Authorization": "Bearer " + session.access_token } : {}),
        },
        body: JSON.stringify(payload),
      });

      const txt = await r.text();
      let j = null;
      try { j = JSON.parse(txt); } catch { j = { ok:false, message:"invalid json", raw: txt }; }

      if (!r.ok || !j?.ok){
        showErr(j?.message || "送出失敗", JSON.stringify(j, null, 2));
        $("payBtn").disabled = false;
        return;
      }

      // ✅ 直接把後端回傳的 html 丟到新視窗（避免主頁被覆蓋也可回來）
      const w = window.open("", "_blank");
      if (w){
        w.document.open();
        w.document.write(j.html);
        w.document.close();
      } else {
        // popup 被擋，改成在本頁直接覆蓋
        document.open(); document.write(j.html); document.close();
      }
    }catch(e){
      showErr("Failed to fetch", String(e));
      $("payBtn").disabled = false;
    }
  }

  // ====== boot ======
  render();
  $("backBtn").onclick = () => history.back();
  $("payBtn").onclick = async () => {
    const session = await loadAuth();
    if (!session) return;
    await callCreateOrder(session);
  };

  // refresh auth status on load
  loadAuth();
</script>
</body>
</html>






































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































