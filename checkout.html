<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checkout｜BookWide</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#f4f6fb;
      --panel:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow:0 10px 30px rgba(15,23,42,.08);
      --radius:18px;

      --brand:#2563eb;
      --danger:#b91c1c;
      --ok:#065f46;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:980px;margin:0 auto;padding:22px 18px 48px;}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;gap:12px;flex-wrap:wrap;}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      padding:10px 16px;border-radius:999px;border:1px solid var(--border);
      background:#fff;cursor:pointer;user-select:none;
      box-shadow:0 6px 18px rgba(15,23,42,.06);
      font-weight:700;
    }
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff;}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 14px;border-radius:999px;background:#fff;border:1px solid var(--border);
      box-shadow:0 6px 18px rgba(15,23,42,.06);
      font-weight:700;
      max-width:520px;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    h1{font-size:44px;letter-spacing:1px;margin:18px 0 14px;}
    .card{
      background:var(--panel);
      border-radius:28px;
      box-shadow:var(--shadow);
      border:1px solid rgba(229,231,235,.7);
      padding:22px;
      margin:14px 0;
    }
    .muted{color:var(--muted);font-weight:700;}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;}
    .err{
      margin-top:12px;
      color:var(--danger);
      font-weight:900;
      white-space:pre-wrap;
      display:none;
      border:1px solid rgba(185,28,28,.25);
      background:#fff5f5;
      padding:12px 14px;
      border-radius:14px;
    }
    .ok{
      color:var(--ok);
      font-weight:900;
    }
    .plans{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px;}
    .plan{
      border:1px solid var(--border);
      border-radius:18px;
      background:#fff;
      padding:14px 14px;
      cursor:pointer;
      user-select:none;
    }
    .plan.active{outline:2px solid rgba(37,99,235,.35);border-color:rgba(37,99,235,.35);}
    .plan .t{font-weight:900;font-size:16px;}
    .plan .p{margin-top:6px;font-weight:900;font-size:22px;}
    .plan .s{margin-top:6px;color:var(--muted);font-weight:800;font-size:12px;}
    @media (max-width: 860px){
      h1{font-size:34px}
      .plans{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="btn" href="/index.html">← 回首頁</a>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;">
        <div class="pill" id="who">未登入</div>
        <a class="btn" href="/account/subscription.html">我的訂閱 →</a>
      </div>
    </div>

    <h1>訂閱結帳</h1>

    <div class="card">
      <div class="muted">選擇方案</div>

      <div class="plans" id="plans">
        <div class="plan" data-plan="month">
          <div class="t">月繳</div>
          <div class="p">NT$ 1,000</div>
          <div class="s">每月自動續訂（測試用）</div>
        </div>
        <div class="plan" data-plan="half">
          <div class="t">半年</div>
          <div class="p">NT$ 5,400</div>
          <div class="s">一次購買 6 個月</div>
        </div>
        <div class="plan" data-plan="year">
          <div class="t">一年</div>
          <div class="p">NT$ 9,600</div>
          <div class="s">一次購買 12 個月</div>
        </div>
      </div>

      <div class="row" style="margin-top:14px;">
        <button class="btn primary" id="payBtn">前往綠界付款</button>
        <button class="btn" id="resetBtn" type="button">重整</button>
        <span class="muted" id="hint"></span>
      </div>

      <div class="err" id="errBox"></div>
    </div>

    <div class="card">
      <div class="muted">說明</div>
      <div style="margin-top:10px;line-height:1.7;font-weight:800;color:#334155;">
        有推薦碼：會帶入後端計算折扣與分潤（referrals 表：code → owner_id / referrer_user_id）。<br/>
        付款後由 ecpay-return 回寫 orders（paid/expire_at...），subscription.html 會自動顯示。<br/>
        <span class="ok">（重要）OrderResultURL 不能指向靜態 subscription.html，必須指向 ecpay-result Edge Function（否則會 405）。</span>
      </div>
    </div>
  </div>

<script>
  // 你原本全站如果有掛 window.SUPABASE_URL / ANON_KEY，就會吃那個
  const SUPABASE_URL = window.SUPABASE_URL || "YOUR_SUPABASE_URL";
  const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || "YOUR_SUPABASE_ANON_KEY";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = (id)=>document.getElementById(id);

  function showErr(msg){
    const box = $("errBox");
    box.style.display = "block";
    box.textContent = String(msg || "未知錯誤");
  }
  function clearErr(){
    const box = $("errBox");
    box.style.display = "none";
    box.textContent = "";
  }

  function getQS(name){
    const u = new URL(location.href);
    return u.searchParams.get(name);
  }

  // 方案來源：?plan=month|half|year（你截圖也有 plan=month）
  let plan = (getQS("plan") || "month").toLowerCase();
  if (!["month","half","year"].includes(plan)) plan = "month";

  function renderPlans(){
    document.querySelectorAll(".plan").forEach(el=>{
      el.classList.toggle("active", el.dataset.plan === plan);
    });
    $("hint").textContent = "目前方案：" + plan;
  }

  document.querySelectorAll(".plan").forEach(el=>{
    el.addEventListener("click", ()=>{
      plan = el.dataset.plan || "month";
      renderPlans();
    });
  });

  $("resetBtn").addEventListener("click", ()=>location.reload());

  async function initUser(){
    const { data: { user }, error } = await sb.auth.getUser();
    if (error || !user){
      $("who").textContent = "未登入";
      return null;
    }
    const email = user.email || "-";
    const uidShort = (user.id || "").slice(0,7);
    $("who").textContent = `${email} · ${uidShort}`;
    return user;
  }

  (async ()=>{
    renderPlans();
    const user = await initUser();

    $("payBtn").addEventListener("click", async ()=>{
      clearErr();
      if (!user){
        showErr("請先登入後再付款。");
        return;
      }

      const btn = $("payBtn");
      btn.disabled = true;

      try{
        // ✅ 你的 Edge Function：create-ecpay-order
        const url = "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/create-ecpay-order";

        const resp = await fetch(url, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({
            user_id: user.id,
            period: plan,
            // 你原本有 topics / plan querystring，這裡保持最小
          }),
        });

        const text = await resp.text();

        if (!resp.ok){
          showErr("付款建立失敗（HTTP " + resp.status + "）：\n" + text);
          btn.disabled = false;
          return;
        }

        let data;
        try{ data = JSON.parse(text); }catch(_e){
          const t = (text || "").trim();
          // ✅ CEO 若直接回傳「HTML 自動送單頁」，就直接寫入並跳轉到綠界
          if (t.startsWith("<!doctype") || t.startsWith("<html") || t.startsWith("<")){
            document.open();
            document.write(text);
            document.close();
            return;
          }
          showErr("付款建立失敗：回傳不是 JSON：\n" + text);
          btn.disabled = false;
          return;
        }

        if (!data || data.ok !== true){
          showErr("付款建立失敗：\n" + (data && (data.message || data.error) ? (data.message || data.error) : text));
          btn.disabled = false;
          return;
        }

        // ✅ 情況 A：回 JSON，裡面有 data.html（你目前 CEO 的設計）
        if (data.html){
          document.open();
          document.write(data.html);
          document.close();
          return;
        }

        // ✅ 情況 B：回 JSON，但不是 html（保留相容）
        showErr("付款建立失敗：回傳 JSON 但缺少 html 欄位。");
        btn.disabled = false;
      }catch(e){
        btn.disabled = false;
        showErr(String(e?.message || e));
      }
    });
  })();
</script>
</body>
</html>




























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































