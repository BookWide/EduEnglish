<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide｜結帳</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#f4f6fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --brand:#2563eb; --soft:#eff6ff;
      --ok:#065f46; --danger:#b91c1c; --shadow:0 10px 30px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;}
    a{text-decoration:none;color:inherit}
    .wrap{max-width:980px;margin:22px auto;padding:0 16px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:12px 16px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;box-shadow:var(--shadow);font-weight:900}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff;box-shadow:none}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;background:#fff;border:1px solid var(--line);box-shadow:var(--shadow);color:var(--muted);font-size:13px}
    h1{font-size:44px;margin:10px 0 14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:28px;box-shadow:var(--shadow);padding:18px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    @media (max-width:820px){ .grid{grid-template-columns:1fr} h1{font-size:36px} }
    .plans{display:grid;gap:10px}
    .plan{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;padding:14px;border:1px solid var(--line);border-radius:16px;background:#fff;cursor:pointer}
    .plan.active{border-color:var(--brand);box-shadow:0 0 0 3px rgba(37,99,235,.12)}
    .pname{font-weight:1000}
    .pdesc{color:var(--muted);font-size:13px;margin-top:4px;line-height:1.4}
    .price{font-weight:1000;font-size:18px;white-space:nowrap}
    .box{margin-top:12px;padding:12px;border-radius:16px;background:var(--soft);border:1px solid #dbeafe}
    .line{display:flex;justify-content:space-between;gap:10px;margin:6px 0}
    .total{font-weight:1000}
    input{width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:14px;font-size:15px;outline:none}
    input:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(37,99,235,.12)}
    .note{font-size:13px;color:var(--muted);line-height:1.6}
    .ok{color:var(--ok);font-weight:900}
    .danger{color:var(--danger);font-weight:900}
    .spin{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.35);border-top-color:#fff;border-radius:50%;animation:sp 1s linear infinite}
    @keyframes sp{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <a class="btn" href="/pricing.html">← 返回方案</a>
      <div id="who" class="pill">未登入</div>
    </div>

    <h1>結帳</h1>

    <div class="card">
      <div class="grid">
        <div>
          <div style="font-weight:1000;margin:6px 0 10px">選擇方案</div>
          <div class="plans" id="plans"></div>

          <div class="box">
            <div class="line"><div class="note">原價</div><div id="basePrice">-</div></div>
            <div class="line"><div class="note">折扣（有效推薦碼才算）</div><div id="discount">-</div></div>
            <div class="line total"><div>應付金額</div><div id="payPrice">-</div></div>
          </div>
        </div>

        <div>
          <div style="font-weight:1000;margin:6px 0 10px">推薦碼（可留空）</div>
          <input id="refInput" placeholder="例如：62754" />
          <div class="note" style="margin-top:10px">
            付款成功後會回寫：<b>orders.paid_at / orders.expire_at</b>，並 upsert <b>subscriptions</b> + 更新 <b>profiles.pro_expire_at</b> 放行播放。<br/>
            Email：只有 Function 有設定 <b>RESEND_API_KEY</b> + <b>EMAIL_FROM</b> 才會真的寄。
          </div>

          <div style="height:14px"></div>

          <button class="btn primary" id="payBtn" style="width:100%">
            <span id="payBtnText">前往綠界付款</span>
          </button>
          <div id="msg" class="note" style="margin-top:10px"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== Supabase（你提供的）======
    const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";

    const FN_CREATE = `${SUPABASE_URL}/functions/v1/create-ecpay-order`;
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const PRICE = { month:1000, half:5400, year:9600 };

    const qs = new URLSearchParams(location.search);
    const state = {
      period: (qs.get("period") || "month").toLowerCase(),
      ref: (qs.get("ref") || qs.get("referral_code") || "").trim(),
      user: null
    };

    function ntd(n){ return "NT$ " + Number(n||0).toLocaleString("en-US"); }

    function renderPlans(){
      const root = document.getElementById("plans");
      root.innerHTML = "";
      const list = [
        {k:"month", t:"月方案", d:"每月續訂，適合先體驗。", p:PRICE.month},
        {k:"half",  t:"半年方案", d:"穩定學習節奏。", p:PRICE.half},
        {k:"year",  t:"一年方案", d:"最划算，長期規劃。", p:PRICE.year},
      ];
      list.forEach(x=>{
        const el = document.createElement("div");
        el.className = "plan" + (state.period===x.k ? " active":"");
        el.innerHTML = `<div><div class="pname">${x.t}</div><div class="pdesc">${x.d}</div></div><div class="price">${ntd(x.p)}</div>`;
        el.onclick = ()=>{ state.period=x.k; renderPlans(); renderCalc(); };
        root.appendChild(el);
      });
    }

    function renderCalc(){
      const base = PRICE[state.period] || PRICE.month;
      const hasRef = !!document.getElementById("refInput").value.trim();
      const disc = hasRef ? Math.round(base * 0.10) : 0; // 前端只是預估顯示；真正折扣由後端 referrals 驗證
      const pay = Math.max(1, base - disc);
      document.getElementById("basePrice").textContent = ntd(base);
      document.getElementById("discount").innerHTML = hasRef ? `<span class="ok">- ${ntd(disc)}</span>` : "-";
      document.getElementById("payPrice").textContent = ntd(pay);
    }

    function setMsg(t,isErr=false){
      document.getElementById("msg").innerHTML = isErr ? `<span class="danger">${t}</span>` : t;
    }
    function setLoading(on){
      const btn = document.getElementById("payBtn");
      const t = document.getElementById("payBtnText");
      if(on){ btn.disabled=true; t.innerHTML = `<span class="spin"></span> 建立訂單中…`; }
      else { btn.disabled=false; t.textContent = "前往綠界付款"; }
    }

    async function loadUser(){
      const { data } = await sb.auth.getUser();
      state.user = data?.user || null;
      document.getElementById("who").textContent = state.user ? `${state.user.email || "(no email)"} · ${state.user.id.slice(0,8)}` : "未登入";
    }

    async function goPay(){
      if(!state.user){ setMsg("請先登入再結帳（回首頁登入後再來）。", true); return; }

      const ref = document.getElementById("refInput").value.trim();
      setLoading(true); setMsg("");

      try{
        const sess = await sb.auth.getSession();
        const token = sess.data?.session?.access_token || "";

        const resp = await fetch(FN_CREATE, {
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            ...(token ? {"Authorization":"Bearer " + token} : {})
          },
          body: JSON.stringify({
            period: state.period,
            referral_code: ref || null
          })
        });

        const j = await resp.json().catch(()=>null);
        if(!resp.ok || !j || !j.ok){
          setLoading(false);
          setMsg("建立訂單失敗：" + (j?.message || j?.detail || ("HTTP " + resp.status)), true);
          return;
        }

        // 直接把綠界表單頁寫到畫面並自動送出
        document.open(); document.write(j.html); document.close();

      }catch(e){
        setLoading(false);
        setMsg("建立訂單失敗：" + (e?.message || String(e)), true);
      }
    }

    (async ()=>{
      renderPlans();
      document.getElementById("refInput").value = state.ref;
      document.getElementById("refInput").addEventListener("input", renderCalc);
      renderCalc();
      await loadUser();
      document.getElementById("payBtn").addEventListener("click", goPay);
    })();
  </script>
</body>
</html>















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































