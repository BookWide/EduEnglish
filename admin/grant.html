
<!doctype html><meta charset="utf-8"><title>Admin｜授權/暫停管理員</title>
<nav>…（同上導覽）…</nav><hr>
<h1>授權 / 暫停管理員</h1>
<div id="list" style="font-family:system-ui"></div>
<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const supabase = createClient("https://jeajrwpmrgczimmrflxo.supabase.co","public-anon-key");

async function mustAdmin(){
  const { data:{ session } } = await supabase.auth.getSession();
  if(!session){ document.body.innerHTML="請先登入"; return false; }
  const { data: profile } = await supabase.from("profiles").select("is_admin").eq("id",session.user.id).single();
  return !!profile?.is_admin || (document.body.innerHTML="非管理員", false);
}

async function load(){
  const { data, error } = await supabase.from("profiles").select("id,email,display_name,is_admin,suspended").order("email");
  if(error){ list.textContent = error.message; return; }
  list.innerHTML = data.map(u=>`
    <div style="display:grid;grid-template-columns:280px 160px 100px 100px;gap:8px;padding:8px;border-bottom:1px solid #eee">
      <div>${u.email}</div>
      <div>${u.display_name||""}</div>
      <button data-act="adm" data-id="${u.id}" style="padding:.25rem .5rem">${u.is_admin?'取消管理員':'設為管理員'}</button>
      <button data-act="sus" data-id="${u.id}" style="padding:.25rem .5rem">${u.suspended?'解除暫停':'暫停'}</button>
    </div>
  `).join('');
}

document.addEventListener('click', async e=>{
  const btn = e.target.closest('button[data-act]');
  if(!btn) return;
  const id = btn.dataset.id;
  if(btn.dataset.act==="adm"){
    const { data: cur } = await supabase.from('profiles').select('is_admin').eq('id',id).single();
    await supabase.from('profiles').update({ is_admin: !cur.is_admin }).eq('id', id);
  }else{
    const { data: cur } = await supabase.from('profiles').select('suspended').eq('id',id).single();
    await supabase.from('profiles').update({ suspended: !cur.suspended }).eq('id', id);
  }
  load();
});

(async()=>{ if(await mustAdmin()) load(); })();
</script>
