<!doctype html><meta charset="utf-8"><title>Admin｜Topics/價格設定</title>
<nav>…（同上導覽）…</nav><hr>
<h1>公告與價格</h1>
<label>公告文字</label><br>
<textarea id="ann" rows="3" style="width:560px"></textarea>
<div style="margin:12px 0"></div>
<label>月繳（NT$）</label><br><input id="m" style="width:120px"><br><br>
<label>半年（NT$）</label><br><input id="h" style="width:120px"><br><br>
<label>年繳（NT$）</label><br><input id="y" style="width:120px"><br><br>
<button id="save" style="padding:.5rem 1rem">儲存</button>
<span id="msg" style="margin-left:12px;color:#090"></span>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const supabase = createClient("https://jeajrwpmrgczimmrflxo.supabase.co","public-anon-key");
async function mustAdmin(){
  const { data:{ session } } = await supabase.auth.getSession();
  if(!session){ document.body.innerHTML="請先登入"; return false; }
  const { data: p } = await supabase.from('profiles').select('is_admin').eq('id',session.user.id).single();
  if(!p?.is_admin){ document.body.innerHTML="非管理員"; return false; }
  return true;
}
async function getKV(key){
  const { data } = await supabase.from('app_settings').select('value').eq('key',key).maybeSingle();
  return data?.value ?? '';
}
async function upsertKV(key,value){
  await supabase.from('app_settings').upsert({ key, value });
}
(async()=>{
  if(!await mustAdmin()) return;
  ann.value = await getKV('announcement');
  m.value   = await getKV('price_month');
  h.value   = await getKV('price_halfyear');
  y.value   = await getKV('price_year');

  save.addEventListener('click', async ()=>{
    await Promise.all([
      upsertKV('announcement', ann.value.trim()),
      upsertKV('price_month', m.value.trim()),
      upsertKV('price_halfyear', h.value.trim()),
      upsertKV('price_year', y.value.trim())
    ]);
    msg.textContent = '已儲存';
    setTimeout(()=>msg.textContent='',1500);
  });
})();
</script>

