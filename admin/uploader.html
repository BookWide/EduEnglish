<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin · MP4 上傳自動化（維持舊版樣式）· v20251107</title>
  <!-- 與原三分頁相同的 Supabase 啟動腳本 -->
  <script type="module" src="./supa.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <style>
    :root{ --bg:#ffffff; --fg:#111; --muted:#6b7280; --muted-2:#9ca3af; --line:#e5e7eb;
           --brand:#2563eb; --chip:#eef2ff; --ok:#16a34a; --warn:#f59e0b; --card:#fafafa; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","PingFang TC","Noto Sans CJK TC","微軟正黑體",sans-serif}
    header{padding:18px 20px;border-bottom:1px solid var(--line);display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .title{font-size:22px;font-weight:700;margin-right:auto}
    .chip{display:inline-block;padding:.35rem .6rem;border-radius:999px;background:var(--chip);color:var(--brand);font-size:12px}
    .wrap{max-width:1120px;margin:24px auto;padding:0 16px}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0 16px}
    .input, select{border:1px solid var(--line);border-radius:10px;padding:.55rem .8rem;background:#fff}
    .btn{border:1px solid var(--brand);background:var(--brand);color:#fff;border-radius:10px;padding:.55rem .9rem;cursor:pointer}
    .btn.outline{background:#fff;color:var(--brand)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
    .table th,.table td{padding:.75rem .8rem;border-bottom:1px solid var(--line);text-align:left}
    .table th{background:var(--card);font-weight:600;color:#222}
    .muted{color:var(--muted)} .hint{color:var(--muted-2);font-size:13px}
    .hr{height:1px;background:var(--line);margin:18px 0}
    .row{display:grid;gap:12px} .grid-2{grid-template-columns:1fr 1fr} .grid-3{grid-template-columns:1fr 1fr 1fr}
    @media (max-width:820px){ .grid-2,.grid-3{grid-template-columns:1fr} }
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px}
    footer{padding:22px 20px;color:#666;border-top:1px solid var(--line);text-align:center;margin-top:28px}
    .pill{display:inline-block;padding:.25rem .55rem;border-radius:999px;border:1px solid var(--line);font-size:12px}
    .pill.ok{color:#16a34a;border-color:#16a34a} .pill.warn{color:#f59e0b;border-color:#f59e0b}
    .drop{border:2px dashed var(--line);border-radius:12px;padding:18px;text-align:center;background:#fff}
    .drop.drag{border-color:#2563eb;background:#f8fbff}
    .progress{height:10px;background:#eef2ff;border-radius:99px;overflow:hidden}
    .bar{height:100%;width:0;background:#2563eb;transition:width .2s}
    code{background:#f6f8fa;border:1px solid #eaeef2;border-radius:6px;padding:2px 6px}
  </style>
</head>
<body>
  <header>
    <div class="title">BookWide Admin 主控台</div>
    <span class="chip">舊版版型 · 內嵌 Supabase</span>
    <nav class="tabs">
      <a href="/EduEnglish/admin/users.html" class="btn outline">使用者清單</a>
      <a href="/EduEnglish/admin/grant.html" class="btn outline">授權 / 暫停管理員</a>
      <a href="/EduEnglish/admin/uploader.html" class="btn" aria-current="page">MP4 上傳</a>
    </nav>
  </header>

  <main class="wrap">
    <section id="panel-mp4">
      <div class="card">
        <h3 style="margin:6px 0 14px">MP4 上傳自動化（slug 檔名 · 完成即送 JSON ZIP）</h3>

        <div class="row grid-3">
          <div><label class="muted">分類</label>
            <select id="cat" class="input">
              <option value="story">story</option><option value="music" selected>music</option>
              <option value="movie">movie</option><option value="news">news</option>
              <option value="pro">pro</option>
            </select></div>
          <div><label class="muted">Slug（不含空白與副檔名）</label>
            <input id="slug" class="input" placeholder="alittlelove"></div>
          <div><label class="muted">顯示標題（可空）</label>
            <input id="title" class="input" placeholder="A Little Love"></div>
        </div>

        <div class="row grid-3" style="margin-top:12px">
          <div>
            <label class="muted">MP4 檔（可拖拉到框內）</label>
            <div id="drop" class="drop">
              <input id="mp4File" type="file" accept="video/mp4" style="display:none">
              <div>將檔案拖曳到此處，或 <button id="picker" class="btn outline" type="button">選擇檔案</button></div>
              <div id="chosen" class="hint" style="margin-top:6px">尚未選檔</div>
              <div class="progress" style="margin-top:8px"><div id="bar" class="bar"></div></div>
            </div>
          </div>
          <div><label class="muted">封面（可選）</label><input id="coverFile" type="file" accept="image/*" class="input"></div>
          <div><label class="muted">公開狀態</label>
            <select id="isPublic" class="input"><option value="true">公開</option><option value="false">非公開</option></select>
          </div>
        </div>

        <div class="row grid-3" style="margin-top:12px">
          <div style="display:flex;align-items:flex-end;gap:10px">
            <button id="btnUpload" class="btn">上傳並寫入資料表</button>
            <label class="hint" style="display:flex;align-items:center;gap:6px">
              <input id="autoAlign" type="checkbox" checked> 自動對齊字幕（吸附靜音）
            </label>
            <a id="zipLink" class="btn outline" href="#" download style="display:none">下載 JSON ZIP</a>
          </div>
          <div style="display:flex;align-items:flex-end">
            <span class="hint">影片路徑：<code>videos/{category}/{slug}.mp4</code>；封面（若選）：<code>assets/{category}/{slug}/cover.jpg</code></span>
          </div>
        </div>

        <div class="row grid-3" style="margin-top:12px">
          <div class="hint">對齊參數：門檻 <code id="p-th">0.008</code> · 靜音≧ <code id="p-sil">0.25s</code> · 吸附窗口 ±<code id="p-win">1.5s</code></div>
          <div style="display:flex;gap:8px;align-items:center">
            <label class="muted">RMS 門檻</label><input id="th" class="input" type="number" step="0.0001" value="0.008" style="width:110px">
            <label class="muted">最短靜音</label><input id="sil" class="input" type="number" step="0.05" value="0.25" style="width:110px">
            <label class="muted">窗口(±s)</label><input id="win" class="input" type="number" step="0.1" value="1.5" style="width:110px">
          </div>
        </div>

        <div class="hr"></div><div id="upMsg" class="muted">就緒。</div>
      </div>
    </section>
  </main>

  <footer>BookWide Admin · 舊版樣式 · v20251107</footer>

  <script type="module">
    // 與原檔一致：等待 supa.js 準備完成，檢查 admin 身分（由 supa.js 內的 BW 物件提供）
    const ready = () => new Promise(function(r){
      if (window.BW && window.BW.supa) return r();
      const t = setInterval(function(){ if(window.BW && window.BW.supa){clearInterval(t); r();}},50);
    });
    await ready();
    await BW.requireAdmin();
    BW.startHeartbeat(2);

    const supa = BW.supa;
    const $ = (q,root)=> (root||document).querySelector(q);

    // 拖放/選檔 UI 與原檔一致
    const drop = $('#drop'); const picker = $('#picker'); const mp4Input=$('#mp4File'); const chosen=$('#chosen');
    const bar = $('#bar'); const btnUpload = $('#btnUpload'); const upMsg = $('#upMsg'); const zipLink = $('#zipLink');

    drop.addEventListener('dragover',e=>{ e.preventDefault(); drop.classList.add('drag'); });
    drop.addEventListener('dragleave',()=> drop.classList.remove('drag'));
    drop.addEventListener('drop',e=>{
      e.preventDefault(); drop.classList.remove('drag');
      const f=e.dataTransfer.files && e.dataTransfer.files[0]; if(f){ mp4Input.files=e.dataTransfer.files; reflectChoose(); }
    });
    picker.addEventListener('click',()=> mp4Input.click());
    mp4Input.addEventListener('change',reflectChoose);
    function reflectChoose(){
      const f=mp4Input.files && mp4Input.files[0];
      if(!f){ chosen.textContent='尚未選檔'; return; }
      chosen.textContent = f.name+' · '+(f.size/1024/1024).toFixed(2)+' MB';
      const slug = ($('#slug').value||'').trim();
      if(!slug){
        const base=f.name.replace(/\.mp4$/i,'').replace(/\s+/g,'-').toLowerCase();
        $('#slug').value = base.slice(0,80);
      }
    }
    const setBar = (p)=>{ bar.style.width = Math.max(3, Math.min(100, p)) + '%'; };

    // 取得影片長度（維持原碼）
    async function getVideoDuration(file){
      return new Promise(function(resolve){
        const v=document.createElement('video'); v.preload='metadata';
        v.onloadedmetadata=function(){ resolve(Math.round(v.duration||0)); URL.revokeObjectURL(v.src); };
        v.onerror=function(){ resolve(0); }; v.src=URL.createObjectURL(file);
      });
    }
    async function ensureFolder(bucket, pathLike){
      try{ await supa.storage.from(bucket).list(pathLike); return true; }catch(e){ return true; }
    }

    // ===== JSON ZIP 產生：完全比照原檔流程 =====
    function pad2(n){ return n.toString().padStart(2,'0'); }
    function pick(arr, n){ const a=arr.slice(); const out=[]; while(out.length<n && a.length){ out.push(a.splice(Math.floor(Math.random()*a.length),1)[0]); } return out; }
    const BANK={
      commonVocab:[{"word":"festival","pos":"n.","zh":"節日","en":"a special day of celebration","example":"This festival brings families together."},{"word":"moon","pos":"n.","zh":"月亮","en":"Earth's natural satellite","example":"We admire the full moon."},{"word":"gather","pos":"v.","zh":"聚集","en":"come together","example":"Families gather for dinner."},{"word":"mooncake","pos":"n.","zh":"月餅","en":"round pastry for Mid-Autumn","example":"They share mooncakes."},{"word":"lantern","pos":"n.","zh":"燈籠","en":"a light in a cover","example":"Kids carry lanterns."},{"word":"legend","pos":"n.","zh":"傳說","en":"traditional story","example":"There is a legend about the moon."},{"word":"archer","pos":"n.","zh":"弓箭手","en":"a person skilled with a bow","example":"He was a brave archer."},{"word":"elixir","pos":"n.","zh":"仙丹","en":"magical drink","example":"The elixir grants immortality."},{"word":"immortal","pos":"adj.","zh":"不死的","en":"living forever","example":"She became immortal."},{"word":"reunion","pos":"n.","zh":"團圓","en":"coming together again","example":"The festival is for reunion."},{"word":"admire","pos":"v.","zh":"欣賞","en":"look at with pleasure","example":"They admire the bright moon."},{"word":"harvest","pos":"n.","zh":"收穫","en":"gathering crops","example":"People thank for the harvest."},{"word":"tradition","pos":"n.","zh":"傳統","en":"custom passed down","example":"Sharing mooncakes is a tradition."},{"word":"celebrate","pos":"v.","zh":"慶祝","en":"do something special","example":"People celebrate together."},{"word":"rabbit","pos":"n.","zh":"兔子","en":"small animal","example":"A rabbit appears in the legend."},{"word":"blessing","pos":"n.","zh":"祝福","en":"good wishes","example":"They ask for blessings."},{"word":"tea","pos":"n.","zh":"茶","en":"a popular drink","example":"People drink tea at night."},{"word":"poem","pos":"n.","zh":"詩","en":"a piece of writing","example":"They read poems about the moon."},{"word":"clear","pos":"adj.","zh":"晴朗的","en":"without clouds","example":"We hope for a clear sky."},{"word":"family","pos":"n.","zh":"家庭","en":"parents and children","example":"Family time matters."}],
      mcDistractors:["sun","star","cloud","tree","river","noodles","cheese","pepper","books","games","rainy","windy"]
    };
    function buildCues(durationSec){
      const total=20; const span=Math.max(2, Math.floor((durationSec||120)/total));
      const cues=[]; let t=0;
      for(let i=0;i<total;i++){ const s=t, e=s+span; cues.push({ "s": s, "e": e, "t": "第 "+pad2(i+1)+" 句（請編輯）" }); t=e; }
      return cues;
    }
    function makeMCQ(q, correct, wrongs){
      const ch=pick(wrongs,3); ch.push(correct);
      for(let i=ch.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); const tmp=ch[i]; ch[i]=ch[j]; ch[j]=tmp; }
      return {"type":"mc", "q":q, "choices":ch, "answer": ch.indexOf(correct)};
    }
    function buildQuizFromVocab(vocab, title){
      const wrongs=BANK.mcDistractors.slice(), quiz=[];
      for(let i=0;i<20;i++){ const v=vocab[i%vocab.length]; quiz.push(makeMCQ('What is the meaning of "'+v.word+'"?', v.zh, wrongs)); }
      while(quiz.length<80) quiz.push(makeMCQ("The moon is very ____ tonight.","bright",["broken","tiny","thin"]));
      return quiz;
    }
    function buildVocab(){
      const words=BANK.commonVocab.slice();
      return pick(words,20).map(x=>({"word":x.word,"pos":x.pos,"zh":x.zh,"en":x.en,"sample":x.example||x.en}));
    }
    async function fetchAudioBuffer(url){ const ctx = new (window.AudioContext||window.webkitAudioContext)({sampleRate:44100}); const r = await fetch(url, {mode:'cors'}); const b = await r.arrayBuffer(); return await ctx.decodeAudioData(b); }
    function energyEnvelope(buf, frameSize, hop){ frameSize=frameSize||1024; hop=hop||256; const ch=buf.getChannelData(0); const frames=Math.max(0, Math.floor((ch.length - frameSize)/hop)); const env=new Float32Array(frames); for(let i=0;i<frames;i++){ let sum=0; for(let j=0;j<frameSize;j++){ const v=ch[i*hop+j]; sum+=v*v; } env[i]=Math.sqrt(sum/frameSize); } return {"env":env,"tStep": hop / buf.sampleRate}; }
    function detectSilences(env, tStep, thresh, minSil){ thresh=(typeof thresh==='number')?thresh:0.008; minSil=(typeof minSil==='number')?minSil:0.25; const minFrames=Math.max(1, Math.floor(minSil/tStep)); const segs=[]; let run=-1; for(let i=0;i<env.length;i++){ if(env[i]<thresh){ if(run<0) run=i; } else if(run>=0){ const len=i-run; if(len>=minFrames) segs.push({"s":run*tStep,"e":i*tStep}); run=-1; } } if(run>=0){ const i=env.length; const len=i-run; if(len>=minFrames) segs.push({"s":run*tStep,"e":i*tStep}); } return segs; }
    function snapToSilence(cues, silences, win){ win=(typeof win==='number')?win:1.5; function nearStart(t){ let best=null,d=Infinity; for(const s of silences){ const dd=Math.abs(t-s.s); if(dd<d && dd<=win){ d=dd; best=s; } } return best; } function nearEnd(t){ let best=null,d=Infinity; for(const s of silences){ const dd=Math.abs(t-s.e); if(dd<d && dd<=win){ d=dd; best=s; } } return best; } const out=cues.map(c=>({"s":c.s,"e":c.e,"t":c.t})); for(const c of out){ const sSil=nearEnd(c.s); const eSil=nearStart(c.e); if(sSil) c.s=Math.max(0,sSil.e); if(eSil) c.e=Math.max(c.s+0.05,eSil.s); } for(let i=1;i<out.length;i++){ if(out[i].s<out[i-1].e) out[i].s=out[i-1].e; if(out[i].e<=out[i].s) out[i].e=out[i].s+0.05; } return out; }

    async function makeZipJson(opts){
      const {category, slug, title, publicVideoUrl, publicCoverUrl, durationSec} = opts;
      const indexName = `index-${slug}.json`;
      const cuesName  = `cues-${slug}.json`;
      const vocabName = `vocab-${slug}.json`;
      const quizName  = `quiz-${slug}.json`;
      const aiName    = `ai-${slug}.json`;

      const indexJson = {
        title: title || slug, category, slug,
        video: publicVideoUrl, cover: publicCoverUrl || null,
        cues: { zh: "./"+cuesName }, vocab: "./"+vocabName, quiz: "./"+quizName, ai: "./"+aiName,
        is_public: true
      };

      let cuesZh = buildCues(durationSec||0);
      if(document.getElementById('autoAlign').checked){
        try{
          const th = parseFloat(document.getElementById('th').value||'0.008');
          const sil= parseFloat(document.getElementById('sil').value||'0.25');
          const win= parseFloat(document.getElementById('win').value||'1.5');
          const buf= await fetchAudioBuffer(publicVideoUrl);
          const o  = energyEnvelope(buf);
          cuesZh   = snapToSilence(cuesZh, detectSilences(o.env,o.tStep, th, sil), win);
        }catch(e){ console.warn('自動對齊失敗，改用平均切段', e); }
      }

      const vocab = buildVocab();
      const quiz  = buildQuizFromVocab(vocab, title);
      const ai    = { title: title||"Lesson", generated_at: new Date().toISOString(), prompts: [
        "Describe the festival.","What will you do this year?","Share a memory about the moon."
      ]};

      const zip = new JSZip();
      const dir = zip.folder(`data/${category}/${slug}`);
      dir.file(indexName, JSON.stringify(indexJson, null, 2));
      dir.file(cuesName,  JSON.stringify(cuesZh,  null, 2));
      dir.file(vocabName, JSON.stringify(vocab, null, 2));
      dir.file(quizName,  JSON.stringify(quiz,  null, 2));
      dir.file(aiName,    JSON.stringify(ai,    null, 2));
      const blob = await zip.generateAsync({type:'blob'});
      return URL.createObjectURL(blob);
    }

    // 上傳流程：維持原檔一致
    document.getElementById('btnUpload').addEventListener('click', async ()=>{
      const cat=$('#cat').value.trim();
      const slug=$('#slug').value.trim();
      const title=$('#title').value.trim();
      const mp4=mp4Input.files && mp4Input.files[0];
      const cov=$('#coverFile').files[0];
      const isPublic=$('#isPublic').value==='true';
      if(!cat||!slug||!mp4){ upMsg.textContent='請選擇分類、輸入 slug 並選擇 MP4 檔'; return; }
      zipLink.style.display='none'; zipLink.removeAttribute('href');

      btnUpload.disabled=true; setBar(8); upMsg.textContent='開始上傳…';
      try{
        const mp4Rel=`${cat}/${slug}.mp4`; const mp4Full=`videos/${mp4Rel}`;
        await ensureFolder('videos',cat);
        setBar(15);
        const up1=await supa.storage.from('videos').upload(mp4Rel, mp4, {upsert:true, contentType:'video/mp4'});
        if(up1.error) throw up1.error;
        setBar(55);
        let coverFull=null; if(cov){
          const rel=`${cat}/${slug}/cover.jpg`; coverFull=`assets/${rel}`;
          await ensureFolder('assets',`${cat}/${slug}`);
          const up2=await supa.storage.from('assets').upload(rel, cov, {upsert:true});
          if(up2.error) throw up2.error;
        }
        setBar(70);
        const duration=await getVideoDuration(mp4);
        const rec={category:cat, slug, title:(title||null), storage_path:mp4Full, cover_path:coverFull,
                   size_bytes:mp4.size||null, duration_sec:duration||null, is_public:isPublic,
                   updated_at:new Date().toISOString()};
        await supa.from('videos').upsert(rec, {onConflict:'category,slug'});
        setBar(85);
        const publicVideoUrl = supa.storage.url + '/object/public/' + mp4Full;
        const publicCoverUrl = coverFull ? (supa.storage.url + '/object/public/' + coverFull) : null;
        upMsg.textContent='產生 ZIP（含自動對齊）…';
        const url = await makeZipJson({category:cat, slug, title, publicVideoUrl, publicCoverUrl, durationSec: duration});
        zipLink.href = url; zipLink.download = `${cat}-${slug}-templates.zip`; zipLink.style.display='inline-block';
        setBar(100);
        upMsg.innerHTML='✅ 完成！已上傳並寫入資料表<br>影片：<code>'+mp4Full+'</code>'+(coverFull?('；封面：<code>'+coverFull+'</code>'):'')+'<br>長度：'+(duration||0)+' 秒，大小：'+(mp4.size/1024/1024).toFixed(2)+' MB · <b>請點「下載 JSON ZIP」</b>';
      }catch(err){ console.error(err); upMsg.textContent='上傳/寫入失敗：'+(err && (err.message||err)); setBar(0); }
      finally{ btnUpload.disabled=false; }
    });
  </script>

  <!-- 你也可以在這頁額外再掛管理員守衛：
  <script src="/EduEnglish/admin/admin_guard_v20251107c.js?v=1107c"></script>
  -->
</body>
</html>


