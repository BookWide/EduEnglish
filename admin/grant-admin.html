<!doctype html><html lang="zh-Hant"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin 授權 / 暫停管理員</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC,Arial,sans-serif;background:#0b1220;color:#e6e8ec;margin:0;padding:24px}
  h1{margin:0 0 16px;font-size:20px}
  .row{display:flex;gap:8px;align-items:center;margin:10px 0}
  input{padding:8px 10px;border-radius:8px;border:1px solid #24324a;background:#0f172a;color:#e6e8ec;min-width:320px}
  .btn{background:#1f6feb;border:0;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
  .ghost{background:#334155}
  .muted{opacity:.7}
  .card{background:#0f172a;border:1px solid #25324a;border-radius:12px;padding:16px;margin-top:8px}
  ul{margin:8px 0 0 18px}
</style>
</head><body>
  <h1>Admin 授權 / 暫停管理員</h1>
  <div class="row">
    <button class="btn" onclick="location.href='../index.html'">← 返回首頁</button>
    <span class="muted">輸入要操作的 Email（必須已登入且你是管理員）</span>
  </div>

  <div class="card">
    <div id="guard" class="muted">檢查管理員身分中…</div>

    <div id="panel" style="display:none">
      <div class="row"><input id="email" placeholder="someone@example.com"/></div>
      <div class="row">
        <button class="btn"   id="grant">授權為管理員</button>
        <button class="btn ghost" id="revoke">取消管理員</button>
        <button class="btn"   id="pause">暫停此帳號</button>
        <button class="btn ghost" id="resume">恢復此帳號</button>
      </div>
      <div class="muted" id="msg"></div>
      <div class="muted" style="margin-top:8px">說明：
        <ul>
          <li>僅變更 <code>profiles.is_admin</code> / <code>profiles.is_paused</code> 欄位。</li>
          <li>請先在 RLS 允許「管理員」可更新這兩個欄位。</li>
        </ul>
      </div>
    </div>
  </div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

const supa = (window.supa) ? window.supa : createClient('YOUR_SUPABASE_URL','YOUR_SUPABASE_ANON_KEY');

const guard = document.querySelector('#guard');
const panel = document.querySelector('#panel');
const email = document.querySelector('#email');
const msg   = document.querySelector('#msg');

async function mustBeAdmin(){
  const { data: sess } = await supa.auth.getSession();
  const user = sess?.session?.user;
  if(!user){ guard.textContent='請先登入（僅限管理員）'; return null; }
  const { data, error } = await supa.from('profiles').select('is_admin').eq('user_id', user.id).maybeSingle();
  if(error||!data?.is_admin){ guard.textContent='403 Forbidden：你不是管理員'; return null; }
  return user;
}

async function updateByEmail(targetEmail, patch){
  msg.textContent = '處理中…';
  const { data, error } = await supa.from('profiles').update(patch).eq('email', targetEmail).select('email').maybeSingle();
  msg.textContent = error ? ('失敗：'+error.message) : ('完成：'+ (data?.email||targetEmail));
}

document.querySelector('#grant').onclick  = ()=> updateByEmail(email.value.trim(), { is_admin: true  });
document.querySelector('#revoke').onclick = ()=> updateByEmail(email.value.trim(), { is_admin: false });
document.querySelector('#pause').onclick  = ()=> updateByEmail(email.value.trim(), { is_paused: true  });
document.querySelector('#resume').onclick = ()=> updateByEmail(email.value.trim(), { is_paused: false });

(async()=>{ const me = await mustBeAdmin(); if(me){ guard.style.display='none'; panel.style.display='block'; } })();
</script>
</body></html>
