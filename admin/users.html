<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin · 使用者清單（經典三分頁） · v20251107</title>
  <script type="module" src="./supa.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <style>
:root{ --bg:#ffffff; --fg:#111; --muted:#6b7280; --muted-2:#9ca3af; --line:#e5e7eb;
       --brand:#2563eb; --chip:#eef2ff; --ok:#16a34a; --warn:#f59e0b; --card:#fafafa; }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","PingFang TC","Noto Sans CJK TC","微軟正黑體",sans-serif}
header{padding:18px 20px;border-bottom:1px solid var(--line);display:flex;gap:14px;align-items:center;flex-wrap:wrap}
.title{font-size:22px;font-weight:700;margin-right:auto}
.chip{display:inline-block;padding:.35rem .6rem;border-radius:999px;background:var(--chip);color:var(--brand);font-size:12px}
.wrap{max-width:1200px;margin:24px auto;padding:0 16px}
.input, select, textarea{border:1px solid var(--line);border-radius:10px;padding:.55rem .8rem;background:#fff}
textarea{width:100%;min-height:120px}
.btn{border:1px solid var(--brand);background:var(--brand);color:#fff;border-radius:10px;padding:.55rem .9rem;cursor:pointer}
.btn.ghost{background:#fff;color:var(--brand)}
.btn:disabled{opacity:.6;cursor:not-allowed}
.muted{color:var(--muted)} .hint{color:var(--muted-2);font-size:13px}
.hr{height:1px;background:var(--line);margin:18px 0}
.row{display:grid;gap:12px} .grid-2{grid-template-columns:1fr 1fr} .grid-3{grid-template-columns:1fr 1fr 1fr}
@media (max-width:980px){ .grid-3{grid-template-columns:1fr} .grid-2{grid-template-columns:1fr} }
.card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px}
footer{padding:22px 20px;color:#666;border-top:1px solid var(--line);text-align:center;margin-top:28px}
.pill{display:inline-block;padding:.25rem .55rem;border-radius:999px;border:1px solid var(--line);font-size:12px}
.pill.ok{color:#16a34a;border-color:#16a34a} .pill.warn{color:#f59e0b;border-color:#f59e0b}
.drop{border:2px dashed var(--line);border-radius:12px;padding:18px;text-align:center;background:#fff}
.drop.drag{border-color:#2563eb;background:#f8fbff}
.progress{height:10px;background:#eef2ff;border-radius:99px;overflow:hidden}
.bar{height:100%;width:0;background:#2563eb;transition:width .2s}
code{background:#f6f8fa;border:1px solid #eaeef2;border-radius:6px;padding:2px 6px}
.table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
.table th,.table td{padding:.75rem .8rem;border-bottom:1px solid var(--line);text-align:left}
.table th{background:var(--card);font-weight:600;color:#222}
nav.tabs a{border:1px solid var(--line);background:#fff;border-radius:10px;padding:.5rem 1rem;text-decoration:none;color:#111;margin-left:8px}
nav.tabs a.active{background:var(--brand);color:#fff;border-color:var(--brand)}
.badge{font-size:12px;border:1px solid var(--line);border-radius:999px;padding:.2rem .5rem;background:#fff}
</style>
</head>

<body>
<header>
  <div class="title">BookWide Admin 主控台</div>
  <nav class="tabs">
    <a href="/EduEnglish/admin/users.html" class="active">使用者清單</a>
    <a href="/EduEnglish/admin/grant.html" class="">授權 / 暫停管理員</a>
    <a href="/EduEnglish/admin/uploader.html" class="">MP4 上傳</a>
  </nav>
</header>

<main class="wrap">
  <div class="card">
    <div class="row grid-2">
      <div class="toolbar">
        <input id="q" class="input" style="min-width:260px" placeholder="搜尋 Email / 顯示名稱…">
        <button id="btnRefresh" class="btn">重新整理</button>
        <span class="hint">資料表：public.profiles · 台灣時區 · 10 分鐘內視為「在線」。</span>
      </div>
    </div>
    <table class="table" id="usersTable">
      <thead><tr>
        <th>Email</th><th>顯示名稱</th><th>最後登入（台灣）</th><th>最近在線（台灣）</th><th>管理員</th><th>狀態</th><th>到期日</th>
      </tr></thead>
      <tbody><tr><td colspan="7" class="muted">載入中…</td></tr></tbody>
    </table>
  </div>
</main>
<script type="module">
  const ready = () => new Promise(r=>{ const t=setInterval(()=>{ if(window.BW?.supa){clearInterval(t); r();}},50);});
  await ready(); await BW.requireAdmin(); BW.startHeartbeat(2);
  const supa = BW.supa;
  const $=(q,r)=> (r||document).querySelector(q);
  const fmtTW = ts => !ts?'':new Date(ts).toLocaleString('zh-TW',{timeZone:'Asia/Taipei',hour12:false});
  const pill = (ok,t,cls)=>{ t=(t!==undefined)?t:(ok?'在線':'離線'); cls=cls||(ok?'pill ok':'pill'); return `<span class="${cls}">${t}</span>`; };
  const isOnlineWithin = (ts, min)=>{ if(!ts) return false; const d=(Date.now()-new Date(ts).getTime())/60000; return d<=min; };
  async function loadProfiles(){
    const tbody = $('#usersTable tbody'); tbody.innerHTML='<tr><td class="muted" colspan="7">載入中…</td></tr>';
    const cols='email, display_name, is_admin, is_paused, last_sign_in_at, last_seen_at, expires_at';
    const r = await supa.from('profiles').select(cols).order('email',{ascending:true});
    if(r.error){ tbody.innerHTML='<tr><td class="muted" colspan="7">讀取失敗：'+r.error.message+'</td></tr>'; return; }
    const q = ($('#q').value||'').trim().toLowerCase();
    const rows = (r.data||[]).filter(x => !q || ( (x.email||'').toLowerCase().includes(q) || (x.display_name||'').toLowerCase().includes(q) ));
    if(!rows.length){ tbody.innerHTML='<tr><td class="muted" colspan="7">沒有符合的資料</td></tr>'; return; }
    tbody.innerHTML = rows.map(x=>{
      const online = isOnlineWithin(x.last_seen_at, 10);
      const status = x.is_paused ? '<span class="pill warn">暫停</span>' : '<span class="pill ok">正常</span>';
      return `<tr>
        <td>${x.email||''}</td>
        <td>${x.display_name||''}</td>
        <td>${fmtTW(x.last_sign_in_at)||''}</td>
        <td>${fmtTW(x.last_seen_at)||''} &nbsp; ${pill(online)}</td>
        <td>${x.is_admin?'<span class="pill ok">是</span>':'<span class="pill">否</span>'}</td>
        <td>${status}</td>
        <td>${x.expires_at||''}</td>
      </tr>`;
    }).join('');
  }
  document.getElementById('btnRefresh').addEventListener('click', loadProfiles);
  document.getElementById('q').addEventListener('input', loadProfiles);
  loadProfiles();
</script>

<footer>BookWide Admin · v20251107</footer>
</body>
</html>



