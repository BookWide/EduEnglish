<!doctype html><html lang="zh-Hant"><head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>BookWide Admin · 上傳自動化＋對齊字幕（slug 檔名版）· v20251104-2</title>
<script src="./supa.js" type="module"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>
    :root{ --bg:#ffffff; --fg:#111; --muted:#6b7280; --muted-2:#9ca3af; --line:#e5e7eb;
           --brand:#2563eb; --chip:#eef2ff; --ok:#16a34a; --warn:#f59e0b; --card:#fafafa; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","PingFang TC","Noto Sans CJK TC","微軟正黑體",sans-serif}
    header{padding:18px 20px;border-bottom:1px solid var(--line);display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .title{font-size:22px;font-weight:700;margin-right:auto}
    .chip{display:inline-block;padding:.35rem .6rem;border-radius:999px;background:var(--chip);color:var(--brand);font-size:12px}
    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab-btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:.5rem 1rem;cursor:pointer}
    .tab-btn.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    .wrap{max-width:1120px;margin:24px auto;padding:0 16px}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0 16px}
    .input, select{border:1px solid var(--line);border-radius:10px;padding:.55rem .8rem;background:#fff}
    .btn{border:1px solid var(--brand);background:var(--brand);color:#fff;border-radius:10px;padding:.55rem .9rem;cursor:pointer}
    .btn.outline{background:#fff;color:var(--brand)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
    .table th,.table td{padding:.75rem .8rem;border-bottom:1px solid var(--line);text-align:left}
    .table th{background:var(--card);font-weight:600;color:#222}
    .muted{color:var(--muted)} .hint{color:var(--muted-2);font-size:13px}
    .hr{height:1px;background:var(--line);margin:18px 0}
    .row{display:grid;gap:12px} .grid-2{grid-template-columns:1fr 1fr} .grid-3{grid-template-columns:1fr 1fr 1fr}
    @media (max-width:820px){ .grid-2,.grid-3{grid-template-columns:1fr} }
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px}
    footer{padding:22px 20px;color:var(--muted);border-top:1px solid var(--line);text-align:center;margin-top:28px}
    .pill{display:inline-block;padding:.25rem .55rem;border-radius:999px;border:1px solid var(--line);font-size:12px}
    .pill.ok{color:#16a34a;border-color:#16a34a} .pill.warn{color:#f59e0b;border-color:#f59e0b}
    .drop{border:2px dashed var(--line);border-radius:12px;padding:18px;text-align:center;background:#fff}
    .drop.drag{border-color:#2563eb;background:#f8fbff}
    .progress{height:10px;background:#eef2ff;border-radius:99px;overflow:hidden}
    .bar{height:100%;width:0;background:#2563eb;transition:width .2s}
    code{background:#f6f8fa;border:1px solid #eaeef2;border-radius:6px;padding:2px 6px}
  </style>
</head><body><header>
<div class="title">BookWide Admin 主控台</div>
<span class="chip">白底 · 單檔 · 內嵌 Supabase</span>
<nav class="tabs"><a href="/EduEnglish/admin/users.html">使用者清單</a><a href="/EduEnglish/admin/grant.html">授權 / 暫停管理員</a><a href="/EduEnglish/admin/uploader.html">MP4 上傳自動化</a></nav>
</header><main class="wrap"><section id="panel-users">
<div class="toolbar">
<input class="input" id="q" placeholder="搜尋 Email / 顯示名稱…" style="min-width:260px"/>
<button class="btn outline" id="btnRefresh">重新整理</button>
<span class="hint">顯示資料來自 <b>public.profiles</b> · 時間以台灣時區 (Asia/Taipei) 顯示 · 每 10 分鐘內視為「在線」。</span>
</div>
<table class="table" id="usersTable">
<thead><tr>
<th>Email</th><th>顯示名稱</th><th>最後登入（台灣）</th><th>最近在線（台灣）</th><th>管理員</th><th>狀態</th><th>到期日</th>
</tr></thead>
<tbody><tr><td class="muted" colspan="7">載入中…</td></tr></tbody>
</table>
</section><section id="panel-roles" style="display:none">
<div class="card">
<div class="row grid-3">
<div><label class="muted">Email</label><input class="input" id="roleEmail" placeholder="user@example.com"/></div>
<div>
<label class="muted">動作</label>
<select class="input" id="roleAction">
<option value="grant-admin">授予管理員</option>
<option value="revoke-admin">移除管理員</option>
<option value="pause">暫停登入</option>
<option value="unpause">解除暫停</option>
</select>
</div>
<div style="display:flex;align-items:flex-end"><button class="btn" id="btnApplyRole">套用</button></div>
</div>
<div class="hr"></div>
<div class="hint">此區直接更新 <b>public.profiles</b> 欄位：<code>is_admin</code> / <code>is_paused</code>。</div>
<div class="muted" id="roleMsg" style="margin-top:10px"></div>
</div>
</section><section id="panel-mp4" style="display:none">
<div class="card">
<h3 style="margin:6px 0 14px">MP4 上傳自動化（slug 檔名 · 完成即送 JSON ZIP）</h3>
<div class="row grid-3">
<div><label class="muted">分類</label>
<select class="input" id="cat">
<option value="story">story</option><option selected="" value="music">music</option>
<option value="movie">movie</option><option value="news">news</option>
<option value="pro">pro</option>
</select></div>
<div><label class="muted">Slug（不含空白與副檔名）</label>
<input class="input" id="slug" placeholder="alittlelove"/></div>
<div><label class="muted">顯示標題（可空）</label>
<input class="input" id="title" placeholder="A Little Love"/></div>
</div>
<div class="row grid-3" style="margin-top:12px">
<div>
<label class="muted">MP4 檔（可拖拉到框內）</label>
<div class="drop" id="drop">
<input accept="video/mp4" id="mp4File" style="display:none" type="file"/>
<div>將檔案拖曳到此處，或 <button class="btn outline" id="picker" type="button">選擇檔案</button></div>
<div class="hint" id="chosen" style="margin-top:6px">尚未選檔</div>
<div class="progress" style="margin-top:8px"><div class="bar" id="bar"></div></div>
</div>
</div>
<div><label class="muted">封面（可選）</label><input accept="image/*" class="input" id="coverFile" type="file"/></div>
<div><label class="muted">公開狀態</label>
<select class="input" id="isPublic"><option value="true">公開</option><option value="false">非公開</option></select>
</div>
</div>
<div class="row grid-3" style="margin-top:12px">
<div style="display:flex;align-items:flex-end;gap:10px">
<button class="btn" id="btnUpload">上傳並寫入資料表</button>
<label class="hint" style="display:flex;align-items:center;gap:6px">
<input checked="" id="autoAlign" type="checkbox"/> 自動對齊字幕（吸附靜音）
            </label>
<a class="btn outline" download="" href="#" id="zipLink" style="display:none">下載 JSON ZIP</a>
</div>
<div style="display:flex;align-items:flex-end">
<span class="hint">影片路徑：<code>videos/{category}/{slug}.mp4</code>；封面（若選）：<code>assets/{category}/{slug}/cover.jpg</code></span>
</div>
</div>
<div class="row grid-3" style="margin-top:12px">
<div class="hint">對齊參數：門檻 <code id="p-th">0.008</code> · 靜音≧ <code id="p-sil">0.25s</code> · 吸附窗口 ±<code id="p-win">1.5s</code></div>
<div style="display:flex;gap:8px;align-items:center">
<label class="muted">RMS 門檻</label><input class="input" id="th" step="0.0001" style="width:110px" type="number" value="0.008"/>
<label class="muted">最短靜音</label><input class="input" id="sil" step="0.05" style="width:110px" type="number" value="0.25"/>
<label class="muted">窗口(±s)</label><input class="input" id="win" step="0.1" style="width:110px" type="number" value="1.5"/>
</div>
</div>
<div class="hr"></div><div class="muted" id="upMsg">就緒。</div>
</div>
</section></main><footer>BookWide Admin · 內嵌 Supabase 版 · v20251104-slug2</footer><script type="module">
if (!window.BANK){
  window.BANK = {
    commonVocab: [
      {word:"festival",pos:"n.",zh:"節日",en:"a special day",example:"It is a traditional festival."},
      {word:"lantern",pos:"n.",zh:"燈籠",en:"a light in a paper cover"},
      {word:"moon",pos:"n.",zh:"月亮",en:"the moon in the sky"},
      {word:"reunion",pos:"n.",zh:"團聚",en:"the act of coming together"},
      {word:"share",pos:"v.",zh:"分享",en:"to give part of something"},
      {word:"admire",pos:"v.",zh:"欣賞",en:"to enjoy looking at"},
      {word:"tradition",pos:"n.",zh:"傳統",en:"a custom that people follow"},
      {word:"poem",pos:"n.",zh:"詩",en:"a piece of writing in verse"},
      {word:"full",pos:"adj.",zh:"圓的/滿的",en:"complete; not empty"},
      {word:"lunar",pos:"adj.",zh:"月的/陰曆的",en:"related to the moon"}
    ],
    mcDistractors: ["a book","a tree","a car","a computer","a movie","a city","a phone","a river","a desk","a game"]
  };
}

function secToMMSS(sec){ sec=Math.max(0,Math.round(sec)); const m=String(Math.floor(sec/60)).padStart(2,'0'); const s=String(sec%60).padStart(2,'0'); return `${m}:${s}`; }
function pad2(n){ return n.toString().padStart(2,'0'); }
function pick(arr, n){ const a=arr.slice(); const out=[]; while(out.length<n && a.length){ out.push(a.splice(Math.floor(Math.random()*a.length),1)[0]); } return out; }

function buildSegments(durationSec){
  const total = 20;
  const span  = Math.max(2, Math.floor((durationSec||120)/total));
  const segs  = [];
  let t=0;
  for(let i=0;i<total;i++){ const s=t, e=s+span; segs.push({ s, e, t: `第 ${pad2(i+1)} 句（請編輯）` }); t=e; }
  return segs;
}
function segmentsToHouyiCues(segs){
  return segs.map(c => ({ time: secToMMSS(c.s), en: "", zh: c.t }));
}

function buildVocabHouyi(){
  const words = window.BANK.commonVocab.slice();
  return pick(words, 20).map(x => ({
    time: 0, word: x.word, pos: x.pos, zh: x.zh, en: x.en, sample: x.example || x.en
  }));
}

function makeMCQ(q, correct, wrongs){
  const ch = pick(wrongs, 3); ch.push(correct);
  for(let i=ch.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [ch[i],ch[j]]=[ch[j],ch[i]]; }
  return { type:'mc', q, choices: ch, answer: ch.indexOf(correct) };
}

function buildQuizHouyiFromVocab(vocab, title){
  const wrongs = window.BANK.mcDistractors.slice();
  const raw = [];

  for(let i=0;i<20;i++){
    const v = vocab[i%vocab.length];
    raw.push(makeMCQ(`What is the meaning of "${v.word}"?`, v.zh, wrongs));
  }
  const grammar = [
    makeMCQ("Lanterns ____ by children at night.","are carried",["carry","are carrying","carried"]),
    makeMCQ("People ____ mooncakes every year.","eat",["ate","are eaten","is eating"]),
    makeMCQ("This is the night ____ families meet.","when",["who","which","where"]),
    makeMCQ("He suggested that we ____ tea.","drink",["drank","to drink","drinking"]),
    makeMCQ("People enjoy ____ poems.","reading",["read","to read","reads"]),
  ];
  while (grammar.length < 20) grammar.push(makeMCQ("The moon is very ____ tonight.","bright",["broken","tiny","thin"]));
  raw.push(...grammar.slice(0,20));

  const reading = [
    makeMCQ(`Why do families meet in "${title||'the story'}"?`,"For reunion",["For business","For exercise","For study"]),
    makeMCQ("They choose a park with a clear view. What do they want to see?","The full moon",["Sunrise","Fireworks","TV show"]),
    makeMCQ("Kids carry lanterns and guess riddles. What does this show?","They enjoy traditions",["They are bored","They hate the dark","They are studying"]),
  ];
  while (reading.length < 20) reading.push(makeMCQ("People share tea and fruit. The mood is ____.","warm",["cold","tense","lonely"]));
  raw.push(...reading.slice(0,20));

  const mixed = [
    makeMCQ("Which is NOT related to Mid-Autumn?","Christmas tree",["Mooncakes","Lanterns","Jade Rabbit"]),
    makeMCQ("Choose the collocation: admire the ____ moon.","full",["thin","broken","small"]),
    makeMCQ("The festival follows the ____ calendar.","lunar",["solar","school","work"]),
  ];
  while (mixed.length < 20) mixed.push(makeMCQ("A polite gift is a box of ____.","mooncakes",["books","spoons","noodles"]));
  raw.push(...mixed.slice(0,20));

  const sections = ["Vocabulary","Grammar","Reading","Mixed"];
  return raw.map((q, i) => ({
    section: sections[Math.floor(i/20)],
    type: "MCQ",
    question: q.q,
    options: q.choices,
    answer: q.choices[q.answer],
    explanation: ""
  }));
}

function buildAIHouyi(title){
  const prompts = [
    "Describe the festival.","What will you do this year?","Share a memory about the moon.",
    "What is your favorite song or activity?","Who do you celebrate with?","Describe the food you enjoy.",
    "How do you feel during the holiday?","Which tradition do you like most?","Describe the decorations.",
    "What do people do at night?","What stories do you know about this festival?","How is it different from others?",
    "Describe one interesting experience you had.","What does this festival mean to you?","What will you do next time to celebrate?"
  ];
  return {
    title: title || "Lesson",
    topics: prompts.map((p, i) => ({ title: `Topic ${i+1}`, prompt: p, hint: "", sample: "" }))
  };
}

async function makeZipJson(opts){
  const {category, slug, title, publicVideoUrl, publicCoverUrl, durationSec} = opts;

  let segs = buildSegments(durationSec||0);
  try{
    const auto = document.getElementById('autoAlign');
    if (auto && auto.checked && typeof fetchAudioBuffer === 'function'){
      const th  = parseFloat(document.getElementById('th')?.value||'0.008');
      const sil = parseFloat(document.getElementById('sil')?.value||'0.25');
      const win = parseFloat(document.getElementById('win')?.value||'1.5');
      const buf = await fetchAudioBuffer(publicVideoUrl);
      const o   = energyEnvelope(buf);
      const sils= detectSilences(o.env, o.tStep, th, sil);
      segs      = snapToSilence(segs, sils, win);
    }
  }catch(e){ console.warn('Auto align failed, fallback to uniform segments', e); }
  const cuesHouyi = segmentsToHouyiCues(segs);
  const vocabHouyi = buildVocabHouyi();
  const quizHouyi  = buildQuizHouyiFromVocab(vocabHouyi, title);
  const aiHouyi    = buildAIHouyi(title);

  const indexJson = {
    title: title || slug,
    category, slug,
    video: publicVideoUrl,
    cover: publicCoverUrl || null,
    cues: { zh: `./cues-${slug}.json` },
    vocab: `./vocab-${slug}.json`,
    quiz:  `./quiz-${slug}.json`,
    ai:    `./ai-${slug}.json`,
    is_public: true
  };

  const zip   = new JSZip();
  const dir   = zip.folder(`data/${category}/${slug}`);
  dir.file(`index-${slug}.json`, JSON.stringify(indexJson,  null, 2));
  dir.file(`cues-${slug}.json`,  JSON.stringify(cuesHouyi,  null, 2));
  dir.file(`vocab-${slug}.json`, JSON.stringify(vocabHouyi, null, 2));
  dir.file(`quiz-${slug}.json`,  JSON.stringify(quizHouyi,  null, 2));
  dir.file(`ai-${slug}.json`,    JSON.stringify(aiHouyi,    null, 2));

  const blob = await zip.generateAsync({type:"blob"});
  const url  = URL.createObjectURL(blob);
  window.__lastZipUrl = url;
  return url;
}
window.makeZipJson = makeZipJson;
</script></body></html>


