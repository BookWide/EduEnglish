<!doctype html><meta charset="utf-8"><title>Admin｜使用者清單</title>
<div id="app">
  <!-- 共用導覽插這裡 -->
  <nav style="display:flex;gap:.75rem;flex-wrap:wrap;align-items:center;margin:8px 0 16px">
    <a href="/EduEnglish/admin/users.html">使用者清單</a>
    <a href="/EduEnglish/admin/grant.html">授權/暫停管理員</a>
    <a href="/EduEnglish/admin/uploader.html">MP4 上傳</a>
    <a href="/EduEnglish/admin/settings.html">Topics/價格設定</a>
    <span id="admin-badge" style="margin-left:auto;padding:.25rem .5rem;border-radius:8px;background:#eef">admin</span>
  </nav><hr>
  <h1>使用者清單</h1>
  <input id="kw" placeholder="搜尋 email / 顯示名稱…" style="margin:.5rem 0;padding:.5rem;width:320px">
  <div id="list" style="margin-top:8px;font-family:system-ui,Segoe UI,Roboto"></div>
</div>
<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const supabase = createClient("https://jeajrwpmrgczimmrflxo.supabase.co","public-anon-key");

async function mustAdmin(){
  const { data:{ session } } = await supabase.auth.getSession();
  if(!session){ document.body.innerHTML="請先登入"; return false; }
  const { data: profile } = await supabase.from("profiles").select("is_admin,display_name").eq("id",session.user.id).single();
  if(!profile?.is_admin){ document.body.innerHTML="非管理員"; return false; }
  document.querySelector("#admin-badge").textContent = session.user.email;
  return true;
}

function render(rows){
  const kw = (document.querySelector('#kw').value||"").toLowerCase();
  const box = document.querySelector('#list');
  box.innerHTML = rows
    .filter(r => (r.email||"").toLowerCase().includes(kw) || (r.display_name||"").toLowerCase().includes(kw))
    .map(r => `
      <div style="display:grid;grid-template-columns:260px 180px 180px 90px 90px;gap:8px;padding:8px;border-bottom:1px solid #eee">
        <div>${r.email||""}</div>
        <div>${r.display_name||""}</div>
        <div>${r.last_sign_in_at||""}</div>
        <div>${r.online_status||""}</div>
        <div>${r.state||"正常"}</div>
      </div>
    `).join('');
}

(async ()=>{
  if(!await mustAdmin()) return;
  const { data, error } = await supabase.from("admin_users_overview").select("*").order("last_seen_at",{ascending:false});
  if(error){ document.querySelector('#list').textContent = error.message; return; }
  render(data || []);
  document.querySelector('#kw').addEventListener('input', ()=>render(data||[]));
})();
</script>

