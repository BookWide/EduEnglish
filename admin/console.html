<!doctype html><html lang="zh-Hant"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin 主控台（只讀）</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC,Arial,sans-serif;background:#0b1220;color:#e6e8ec;margin:0;padding:24px}
  h1{margin:0 0 16px;font-size:20px}
  .bar{display:flex;gap:8px;align-items:center;margin-bottom:16px}
  .btn{background:#1f6feb;border:0;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
  .muted{opacity:.7}
  .card{background:#0f172a;border:1px solid #25324a;border-radius:12px;padding:16px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border-bottom:1px solid #24324a;padding:8px 10px;text-align:left;white-space:nowrap}
  th{font-weight:600;color:#cdd5df}
</style>
</head><body>
  <h1>Admin 主控台（只讀）</h1>
  <div class="bar">
    <button class="btn" onclick="location.href='../index.html'">← 返回首頁</button>
    <span class="muted">僅顯示：Email / 顯示名稱 / 是否管理員 / 是否停用 / 最後登入 / 到期日</span>
  </div>

  <div class="card">
    <div id="guard" class="muted">檢查管理員身分中…</div>
    <table id="grid" style="display:none">
      <thead><tr>
        <th>Email</th><th>顯示名稱</th><th>Admin</th><th>停用</th>
        <th>最後登入</th><th>方案到期</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

const supa = (window.supa) ? window.supa : createClient('YOUR_SUPABASE_URL','YOUR_SUPABASE_ANON_KEY');

const guard = document.querySelector('#guard');
const grid  = document.querySelector('#grid');
const tbody = grid.querySelector('tbody');

function fmt(t){if(!t)return ''; const d=new Date(t); return isNaN(d)?'':d.toLocaleString();}

async function mustBeAdmin(){
  const { data: sess } = await supa.auth.getSession();
  const user = sess?.session?.user;
  if(!user){ guard.textContent='請先登入（僅限管理員）'; return null; }
  const { data, error } = await supa.from('profiles').select('is_admin').eq('user_id', user.id).maybeSingle();
  if(error||!data?.is_admin){ guard.textContent='403 Forbidden：你不是管理員'; return null; }
  return user;
}

async function load(){
  const me = await mustBeAdmin(); if(!me) return;
  guard.style.display='none'; grid.style.display='table';

  // 只讀欄位：依你的 profiles 欄位為準
  const { data, error } = await supa.from('profiles')
    .select('email, display_name, is_admin, is_paused, last_seen_at, plan_expire_at')
    .order('last_seen_at', { ascending:false });
  if(error){ guard.style.display='block'; guard.textContent='讀取失敗：'+error.message; return; }

  tbody.innerHTML = '';
  for(const r of (data||[])){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.email||''}</td>
      <td>${r.display_name||''}</td>
      <td>${r.is_admin? '✔':'—'}</td>
      <td>${r.is_paused? '✔':'—'}</td>
      <td>${fmt(r.last_seen_at)}</td>
      <td>${fmt(r.plan_expire_at)}</td>`;
    tbody.appendChild(tr);
  }
}
load();
</script>
</body></html>
