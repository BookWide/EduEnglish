<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BookWide｜我的訂閱</title>
  <style>
    :root{
      --bg:#f5f5f7;
      --fg:#111;
      --muted:#666;
      --card:#fff;
      --border:#ddd;
      --accent:#111827;
      --pill:#111827;
      --pillText:#fff;
      --pillMuted:#f3f4f6;
      --danger:#b91c1c;
      --ok:#047857;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font:16px/1.6 -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui,
           "Noto Sans TC","PingFang TC","Microsoft JhengHei", sans-serif;
    }
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{
      max-width:960px;
      margin:0 auto;
      padding:20px 16px 40px;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:20px;
    }
    .back-link{
      font-size:14px;
      color:var(--muted);
    }
    h1{
      font-size:26px;
      margin:4px 0 0;
      letter-spacing:.04em;
    }
    .card{
      background:var(--card);
      border-radius:18px;
      border:1px solid var(--border);
      padding:18px 18px 16px;
      margin-bottom:18px;
      box-shadow:0 12px 30px rgba(15,23,42,.06);
    }
    .card-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
      font-size:15px;
      font-weight:600;
    }
    .card-title small{
      font-weight:400;
      color:var(--muted);
      font-size:13px;
    }
    .grid{
      display:grid;
      grid-template-columns:120px minmax(0,1fr);
      row-gap:6px;
      column-gap:12px;
      font-size:14px;
    }
    .key{
      color:var(--muted);
      text-align:right;
      padding-right:4px;
      white-space:nowrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:2px 10px;
      border-radius:999px;
      background:var(--pill);
      color:var(--pillText);
      font-size:13px;
    }
    .pill.muted{
      background:var(--pillMuted);
      color:var(--fg);
    }
    .muted{color:var(--muted);font-size:13px;}
    .status-ok{color:var(--ok);font-weight:600;font-size:13px;}
    .status-exp{color:var(--danger);font-weight:600;font-size:13px;}

    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }
    th,td{
      padding:7px 8px;
      border-bottom:1px solid var(--border);
    }
    th{
      text-align:left;
      font-size:13px;
      color:var(--muted);
      font-weight:500;
    }
    tbody tr:hover{
      background:#f9fafb;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      padding:0 8px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:12px;
      color:var(--muted);
      background:#fff;
    }
    .btn-row{
      margin-top:14px;
      display:flex;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }
    .btn{
      border-radius:999px;
      border:1px solid var(--border);
      padding:6px 14px;
      font-size:14px;
      background:#fff;
      cursor:pointer;
    }
    .btn.primary{
      background:var(--accent);
      color:#fff;
      border-color:var(--accent);
    }
    .btn:disabled{
      opacity:.5;
      cursor:default;
    }
    .small-note{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
    }
    @media (max-width:640px){
      .grid{
        grid-template-columns:100px minmax(0,1fr);
      }
      .wrap{padding:16px 12px 28px;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <a class="back-link" href="../index.html">← 回首頁</a>
        <h1>我的訂閱</h1>
      </div>
      <a href="../pricing.html">方案與定價 →</a>
    </header>

    <!-- 目前使用中 -->
    <section id="current-card" class="card">
      <div class="card-title">
        <span>目前使用中</span>
        <small id="current-summary" class="muted">讀取中…</small>
      </div>
      <div id="current-body" class="muted">正在載入訂閱資料…</div>
      <div class="btn-row">
        <button id="btn-renew" class="btn primary" disabled>前往續約 / 變更方案</button>
        <button id="btn-refresh" class="btn" type="button">重新整理</button>
      </div>
      <div class="small-note">
        備註：以「已付款且尚未到期」的最新一筆訂單為準。若您剛完成付款，可能需數秒鐘同步資料。
      </div>
    </section>

    <!-- 歷史訂單 -->
    <section class="card">
      <div class="card-title">
        <span>歷史訂單</span>
        <small class="muted">僅顯示與訂閱相關的訂單（成功／失敗皆會記錄）。</small>
      </div>
      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>付款日期</th>
              <th>方案</th>
              <th>週期</th>
              <th>金額</th>
              <th>狀態</th>
            </tr>
          </thead>
          <tbody id="history-body">
            <tr><td colspan="5" class="muted">正在載入訂單資料…</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="muted" style="font-size:12px;margin-top:8px;">
      如對訂閱或付款有疑問，請來信至 <a href="mailto:support@bookwide.net">support@bookwide.net</a>，並提供您的登入 Email 與訂單日期，方便我們協助查詢。
    </section>
  </div>

  <script type="module">
    // 初始化 Supabase
    const SUPABASE_URL = 'https://jeajrwpmrgczimmrflxo.supabase.co';
    const SUPABASE_ANON_KEY = '（這裡填你的 anon key）';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // 簡單的日期格式：轉成台北時間 yyyy/mm/dd
    function fmtDate(value){
      if(!value) return '—';
      const d = new Date(value);
      if(Number.isNaN(d.getTime())) return '—';
      return d.toLocaleDateString('zh-TW',{
        timeZone:'Asia/Taipei',
        year:'numeric',month:'2-digit',day:'2-digit'
      });
    }

    // 台幣金額：cents（分）→ NTD
    function currency(cents){
      const n = Math.round((cents||0)/100);
      return 'NT$' + n.toLocaleString('zh-TW');
    }

    // 計算距離今天幾天：到期日 - 今天
    function daysLeft(expire){
      if(!expire) return null;
      const end = new Date(expire);
      if(Number.isNaN(end.getTime())) return null;
      const today = new Date();
      const diffMs = end.getTime() - today.getTime();
      return Math.floor(diffMs / (1000*60*60*24));
    }

    async function loadPage(){
      const currentBody   = document.getElementById('current-body');
      const currentSummary= document.getElementById('current-summary');
      const historyBody   = document.getElementById('history-body');
      const btnRenew      = document.getElementById('btn-renew');
      const btnRefresh    = document.getElementById('btn-refresh');

      // 取得目前登入使用者
      const { data: { user }, error: userErr } = await supabase.auth.getUser();
      if(userErr || !user){
        currentBody.textContent = '尚未登入，請先回首頁登入後再查看訂閱。';
        currentSummary.textContent = '未登入';
        historyBody.innerHTML = '<tr><td colspan="5" class="muted">無法載入：尚未登入。</td></tr>';
        btnRenew.disabled = true;
        return;
      }
      const email = user.email || '—';

      // 抓 profiles 的最後登入時間
      let lastLogin = '—';
      const { data: prof, error: profErr } = await supabase
        .from('profiles')
        .select('last_login_at')
        .eq('id', user.id)
        .maybeSingle();
      if(!profErr && prof && prof.last_login_at){
        lastLogin = fmtDate(prof.last_login_at);
      }

      // 抓 orders：僅與訂閱有關的訂單
      const { data: orders, error: orderErr } = await supabase
        .from('orders')
        .select('id, items, period, subtotal_cents, discount_cents, status, created_at, paid_at, expire_at, referral_code')
        .eq('user_id', user.id)
        .order('created_at', { ascending:false });

      if(orderErr){
        currentBody.textContent = '載入訂閱資料時發生錯誤，請稍後重試。';
        currentSummary.textContent = '讀取失敗';
        historyBody.innerHTML = '<tr><td colspan="5" class="muted">載入失敗。</td></tr>';
        btnRenew.disabled = false;
        return;
      }

      // ---- 歷史訂單表格 ----
      if(!orders || !orders.length){
        historyBody.innerHTML = '<tr><td colspan="5" class="muted">目前尚無訂單紀錄。</td></tr>';
      }else{
        historyBody.innerHTML = '';
        for(const o of orders){
          const row = document.createElement('tr');
          const itemsText = Array.isArray(o.items) ? o.items.join('、') : (o.items || '—');
          const totalCents = (o.subtotal_cents||0) - (o.discount_cents||0);
          const status =
            o.status === 'paid' ? '<span class="status-ok">已付款</span>' :
            o.status === 'pending' ? '<span class="badge">處理中</span>' :
            o.status === 'failed' ? '<span class="status-exp">失敗</span>' :
            o.status || '—';
          const paidDate = fmtDate(o.paid_at || o.created_at);

          row.innerHTML = `
            <td>${paidDate}</td>
            <td>${itemsText}</td>
            <td>${o.period || '—'}</td>
            <td>${currency(totalCents)}</td>
            <td>${status}</td>
          `;
          historyBody.appendChild(row);
        }
      }

      // ---- 目前使用中的訂閱 ----
      // 找出「已付款且尚未到期」的最新一筆訂單
      const now = new Date();
      const active = (orders || []).find(o =>
        o.status === 'paid' &&
        o.expire_at &&
        new Date(o.expire_at).getTime() >= now.getTime()
      );

      const box = currentBody;
      box.innerHTML = '';
      if(!active){
        currentSummary.textContent = '尚未有啟用中的訂閱方案';
        box.innerHTML = '<div class="muted">目前沒有使用中的訂閱方案。請點選下方「前往續約 / 變更方案」選擇想要的主題與方案。</div>';
        btnRenew.disabled = false;
        btnRenew.onclick = () => {
          window.location.href = '../pricing.html';
        };
        btnRefresh.onclick = () => location.reload();
        return;
      }

      const order = active;

      // 有有效訂單：使用最新一筆 paid + 未到期訂單
      const items = Array.isArray(order.items) ? order.items.join('、') : (order.items || '—');
      const totalCents = (order.subtotal_cents||0) - (order.discount_cents||0);
      const exp = fmtDate(order.expire_at);
      const dl  = daysLeft(order.expire_at);

      // 訂閱開始日：優先採用 paid_at，否則用 created_at
      const startRaw = order.paid_at || order.created_at;
      const start = fmtDate(startRaw);
      const periodRange =
        (startRaw && order.expire_at)
          ? `${start} ～ ${exp}`
          : '—';

      const status =
        dl == null ? '—'
        : (dl >= 0
           ? `<span class="status-ok">使用中</span>`
           : `<span class="status-exp">已到期</span>`);
      const leftText =
        dl == null ? ''
        : (dl >= 0
           ? `剩餘 ${dl} 天`
           : `${Math.abs(dl)} 天前到期`);

      // 稅額拆分：總價 = 未稅 + 5% 稅金
      const total = totalCents || 0;
      const net   = Math.round(total / 1.05);
      const tax   = total - net;
      const amountMain   = currency(total);
      const amountDetail = `未稅 ${currency(net)}，稅額 ${currency(tax)}`;

      const referral = order.referral_code || '—';

      box.innerHTML = `
        <div class="grid">
          <div class="key">帳號</div><div>${email}</div>
          <div class="key">方案</div><div><span class="pill">${items}</span></div>
          <div class="key">週期</div><div>${order.period || '—'}</div>
          <div class="key">付款日期</div><div>${start}</div>
          <div class="key">訂閱期間</div><div>${periodRange}</div>
          <div class="key">到期日</div>
            <div><b>${exp}</b>${leftText ? '　<small class="muted">'+leftText+'</small>' : ''}</div>
          <div class="key">金額</div>
            <div><b>${amountMain}</b><br><small class="muted">${amountDetail}</small></div>
          <div class="key">推薦碼</div><div>${referral}</div>
          <div class="key">狀態</div><div>${status}</div>
          <div class="key">最後登入</div><div>${lastLogin}</div>
        </div>`;

      currentSummary.textContent =
        `${items}｜${order.period || '—'}｜${amountMain}`;

      // 續約帶方案 + 週期回 pricing
      btnRenew.disabled = false;
      btnRenew.onclick = () => {
        const params = new URLSearchParams();
        if(Array.isArray(order.items) && order.items.length){
          params.set('topics', order.items.join(','));
        }
        if(order.period) params.set('plan', order.period);
        window.location.href = '../pricing.html?' + params.toString();
      };
      btnRefresh.onclick = () => location.reload();
    }

    loadPage();
  </script>
</body>
</html>

