<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>我的訂閱</title>
  <style>
    :root{
      --bg:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --pill:#111827;
      --pillText:#ffffff;
      --ok:#065f46;
      --exp:#b91c1c;
    }
    html,body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
    }
    .wrap{max-width:980px;margin:28px auto;padding:0 16px}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .back{display:inline-block;color:#2563eb;text-decoration:none;font-size:.95rem}
    h1{font-size:34px;margin:8px 0 14px}

    .card{
      border:1px solid var(--border);
      border-radius:12px;
      padding:16px 16px 18px;
      background:#fff;
      margin-bottom:18px;
    }
    .muted{color:var(--muted);font-size:.95rem}
    .btn{
      border-radius:999px;
      border:1px solid #111;
      background:#111;
      color:#fff;
      padding:8px 16px;
      font-size:.9rem;
      cursor:pointer;
    }
    .btn.secondary{
      background:#fff;
      color:#111;
    }
    .grid{
      display:grid;
      grid-template-columns:120px 1fr;
      gap:8px 18px;
      align-items:center;
    }
    .key{color:var(--muted);font-size:.9rem}
    .pill{
      display:inline-block;
      background:var(--pill);
      color:var(--pillText);
      border-radius:999px;
      padding:2px 10px;
      font-size:.85rem;
    }
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px 6px;border-bottom:1px solid var(--border);text-align:left;font-size:.95rem}
    th{color:var(--muted);font-weight:600}
    td.right,th.right{text-align:right}
    .status-ok{color:var(--ok);font-weight:700}
    .status-exp{color:var(--exp);font-weight:700}
    .empty{color:var(--muted);text-align:center;padding:16px 0}
    .hint{color:var(--muted);font-size:.9rem;margin-top:8px;display:inline-block}
    @media(max-width:680px){
      .grid{grid-template-columns:1fr}
      .grid .key{text-align:left}
    }
  </style>

  <!-- Supabase 設定：和 checkout.html 保持一致 -->
  <script>
    window.SB_URL  = window.SB_URL  || "https://jeajrwpmrgczimmrflxo.supabase.co";
    window.SB_ANON = window.SB_ANON || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do"; // ← 換成你實際的 anon key
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="back" href="../index.html">← 回首頁</a>
      <a class="back" href="../pricing.html">方案與定價 →</a>
    </div>

    <h1>我的訂閱</h1>

    <!-- 目前使用中 -->
    <div id="activeCard" class="card">
      <div class="muted">目前使用中</div>
      <div id="activeContent" style="margin-top:8px">
        <!-- 動態填入 -->
      </div>
      <div id="renewArea" style="margin-top:12px; display:none;">
        <button id="btnRenew" class="btn">立即續約</button>
        <span class="hint">到期前 7 天會寄送提醒信。</span>
      </div>
    </div>

    <!-- 歷史訂單 -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="muted">歷史訂單</div>
        <button id="btnRefresh" class="btn secondary">重新整理</button>
      </div>
      <div id="ordersArea">
        <table>
          <thead>
            <tr>
              <th>日期</th>
              <th>方案</th>
              <th>週期</th>
              <th class="right">金額</th>
              <th>狀態</th>
            </tr>
          </thead>
          <tbody id="ordersBody">
          </tbody>
        </table>
      </div>
    </div>

    <p class="hint">若您對訂閱或付款有疑問，請聯絡客服或回覆付款通知信。</p>
  </div>

  <script>
  (function(){
    const supabase = window.supabase.createClient(window.SB_URL, window.SB_ANON);

    const $ = (q)=>document.querySelector(q);
    const currency = (cents)=>'NT$' + Math.round((cents||0)/100).toLocaleString('zh-TW');
    const fmtDate = (value)=>{
      if(!value) return '—';
      try{
        const d = new Date(value);
        if(isNaN(d.getTime())) return '—';
        return d.toLocaleDateString('zh-TW',{year:'numeric',month:'2-digit',day:'2-digit'});
      }catch(e){ return '—'; }
    };
    const daysLeft = (value)=>{
      if(!value) return null;
      try{
        const d = new Date(value);
        if(isNaN(d.getTime())) return null;
        const now = new Date();
        const diff = d.getTime() - now.getTime();
        return Math.ceil(diff / 86400000);
      }catch(e){ return null; }
    };

    async function loadOrders(){
      const tbody = $('#ordersBody');
      const activeBox = $('#activeContent');
      const renewArea = $('#renewArea');

      // 讀取登入使用者
      const { data: userData, error: authErr } = await supabase.auth.getUser();
      const user = userData?.user || null;
      if(authErr || !user){
        activeBox.innerHTML =
          '<div class="empty">請先登入查看訂閱狀態。</div>';
        tbody.innerHTML =
          '<tr><td colspan="5" class="empty">請先登入查看訂單紀錄。</td></tr>';
        renewArea.style.display = 'none';
        return;
      }

      // 取 profile（給最後登入 & fallback 用）
      const { data: profile } = await supabase
        .from('profiles')
        .select('expires_at, plan, plan_name, last_sign_in_at')
        .eq('id', user.id)
        .maybeSingle();

      // 取 orders
      const { data: orders, error: orderErr } = await supabase
        .from('orders')
        .select('id, items, period, subtotal_cents, discount_cents, status, paid_at, expire_at')
        .eq('buyer_id', user.id)
        .order('paid_at', { ascending:false })
        .limit(100);

      if(orderErr){
        tbody.innerHTML =
          '<tr><td colspan="5" class="empty">載入失敗：' + (orderErr.message || orderErr) + '</td></tr>';
      }else if(!orders || orders.length === 0){
        tbody.innerHTML =
          '<tr><td colspan="5" class="empty">尚無訂單</td></tr>';
      }else{
        tbody.innerHTML = '';
        for(const o of orders){
          const items = Array.isArray(o.items) ? o.items.join(', ') : (o.items || '—');
          const totalCents = (o.subtotal_cents||0) - (o.discount_cents||0);
          const paid = fmtDate(o.paid_at);
          const statusText = o.status === 'paid'
            ? '<span class="status-ok">已付款</span>'
            : '<span class="status-exp">未完成</span>';
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${paid}</td>
            <td>${items}</td>
            <td>${o.period || '—'}</td>
            <td class="right">${currency(totalCents)}</td>
            <td>${statusText}</td>
          `;
          tbody.appendChild(tr);
        }
      }

      // 找出目前使用中的訂閱（優先用 orders）
      let activeOrder = null;
      if(orders && orders.length){
        const now = new Date();
        const valid = orders.filter(o =>
          o.status === 'paid' &&
          o.expire_at &&
          new Date(o.expire_at) > now
        );
        valid.sort((a,b)=> new Date(b.expire_at) - new Date(a.expire_at));
        activeOrder = valid[0] || null;
      }

      renderActive(user, profile, activeOrder);
    }

    function renderActive(user, profile, order){
      const box = $('#activeContent');
      const renewArea = $('#renewArea');
      const email = user.email || '—';
      const lastLogin = fmtDate(profile?.last_sign_in_at);

      // 沒 active 訂單，就看 profile 的 expires_at / plan
      if(!order && !profile?.expires_at){
        box.innerHTML =
          `<div class="empty">目前尚未訂閱任何方案。</div>`;
        renewArea.style.display = 'none';
        return;
      }

      if(!order && profile?.expires_at){
        const exp = fmtDate(profile.expires_at);
        const dl  = daysLeft(profile.expires_at);
        const plan = profile.plan_name || profile.plan || '—';
        const status =
          dl == null ? '已到期 / 未訂閱'
          : (dl >= 0
             ? `<span class="status-ok">使用中</span>`
             : `<span class="status-exp">已到期</span>`);
        const leftText =
          dl == null ? ''
          : (dl >= 0
             ? `剩餘 ${dl} 天`
             : `${Math.abs(dl)} 天前到期`);

        box.innerHTML = `
          <div class="grid">
            <div class="key">帳號</div><div>${email}</div>
            <div class="key">方案</div><div><span class="pill">${plan}</span></div>
            <div class="key">到期日</div>
              <div><b>${exp}</b>${leftText ? '　<small class="muted">'+leftText+'</small>' : ''}</div>
            <div class="key">狀態</div><div>${status}</div>
            <div class="key">最後登入</div><div>${lastLogin}</div>
          </div>`;
        renewArea.style.display = '';
        $('#btnRenew').onclick = ()=>{ location.href = '../pricing.html'; };
        return;
      }

      // 有有效訂單：使用最新一筆 paid + 未到期訂單
      const items = Array.isArray(order.items) ? order.items.join('、') : (order.items || '—');
      const totalCents = (order.subtotal_cents||0) - (order.discount_cents||0);
      const exp = fmtDate(order.expire_at);
      const dl  = daysLeft(order.expire_at);
      const paid = fmtDate(order.paid_at);
      const status =
        dl == null ? '—'
        : (dl >= 0
           ? `<span class="status-ok">使用中</span>`
           : `<span class="status-exp">已到期</span>`);
      const leftText =
        dl == null ? ''
        : (dl >= 0
           ? `剩餘 ${dl} 天`
           : `${Math.abs(dl)} 天前到期`);

      box.innerHTML = `
        <div class="grid">
          <div class="key">帳號</div><div>${email}</div>
          <div class="key">方案</div><div><span class="pill">${items}</span></div>
          <div class="key">週期</div><div>${order.period || '—'}</div>
          <div class="key">付款日期</div><div>${paid}</div>
          <div class="key">到期日</div>
            <div><b>${exp}</b>${leftText ? '　<small class="muted">'+leftText+'</small>' : ''}</div>
          <div class="key">金額</div><div><b>${currency(totalCents)}</b></div>
          <div class="key">狀態</div><div>${status}</div>
          <div class="key">最後登入</div><div>${lastLogin}</div>
        </div>`;

      // 續約帶方案 + 週期回 pricing
      renewArea.style.display = '';
      const usp = new URLSearchParams();
      usp.set('items', Array.isArray(order.items)
        ? order.items.join(',')
        : (order.items || ''));
      usp.set('period', order.period || 'month');
      $('#btnRenew').onclick = ()=>{
        location.href = '../pricing.html?' + usp.toString();
      };
    }

    $('#btnRefresh').onclick = loadOrders;
    loadOrders();
  })();
  </script>
</body>
</html>

