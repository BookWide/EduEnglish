<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>我的訂閱｜BookWide</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                   "Noto Sans TC","PingFang TC","Microsoft JhengHei", sans-serif;
      margin:0; background:#f4f6fb; color:#111827;
    }
    .wrap{max-width:960px;margin:40px auto;padding:0 16px;}
    h1{margin-bottom:16px;}
    .card{
      background:#fff;border-radius:12px;padding:20px;margin-bottom:24px;
      box-shadow:0 10px 30px rgba(15,23,42,.08);
    }
    .row{display:flex;justify-content:space-between;margin:6px 0;}
    .muted{color:#6b7280;}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:10px;border-bottom:1px solid #e5e7eb;text-align:left;}
    th{background:#f9fafb;}
    .btn{
      display:inline-block;margin-top:12px;padding:10px 16px;
      background:#2563eb;color:#fff;border-radius:8px;text-decoration:none;
    }
  </style>
</head>
<body>

<div class="wrap">
  <h1>我的訂閱</h1>

  <!-- 目前訂閱 -->
  <div class="card" id="currentBox">
    <h3>目前訂閱</h3>
    <div id="currentEmpty" class="muted">尚無訂閱紀錄</div>
    <div id="currentContent" style="display:none">
      <div class="row">
        <span class="muted">付款金額</span>
        <strong id="currentAmount"></strong>
      </div>
      <div class="row">
        <span class="muted">方案</span>
        <span id="currentPeriod"></span>
      </div>
      <div class="row">
        <span class="muted">付款日期</span>
        <span id="currentPaidAt"></span>
      </div>
      <div class="row">
        <span class="muted">到期日</span>
        <span id="currentExpireAt"></span>
      </div>
    </div>
  </div>

  <!-- 歷史訂單 -->
  <div class="card">
    <h3>歷史訂單</h3>
    <table>
      <thead>
        <tr>
          <th>付款日期</th>
          <th>方案</th>
          <th>金額</th>
        </tr>
      </thead>
      <tbody id="orderRows"></tbody>
    </table>
  </div>

  <a href="/pricing.html" class="btn" id="buyBtn">前往訂閱</a>
</div>

<script>
/* ====== 你自己的 Supabase 設定 ====== */
const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ====== 工具 ====== */
const fmtDate = d => d ? new Date(d).toLocaleDateString() : '-';
const fmtAmount = n => `NT$ ${Number(n).toLocaleString()}`;

/* ====== 主流程 ====== */
(async () => {
  const { data:{ user } } = await supabase.auth.getUser();
  if (!user) {
    alert("請先登入");
    location.href = "/index.html";
    return;
  }

  /* ====== 1. 目前訂閱（最後一次付款那筆） ====== */
  const { data: current } = await supabase
    .from('orders')
    .select('*')
    .eq('user_id', user.id)
    .in('status', ['paid','success'])
    .order('paid_at', { ascending:false, nullsFirst:false })
    .order('created_at', { ascending:false })
    .limit(1)
    .maybeSingle();

  if (current) {
    document.getElementById('currentEmpty').style.display = 'none';
    document.getElementById('currentContent').style.display = 'block';

    document.getElementById('currentAmount').textContent = fmtAmount(current.total);
    document.getElementById('currentPeriod').textContent = current.period || '-';
    document.getElementById('currentPaidAt').textContent = fmtDate(current.paid_at);
    document.getElementById('currentExpireAt').textContent = fmtDate(current.expire_at);
  }

  /* ====== 2. 歷史訂單（一筆一筆） ====== */
  const { data: orders } = await supabase
    .from('orders')
    .select('*')
    .eq('user_id', user.id)
    .in('status', ['paid','success'])
    .order('paid_at', { ascending:false, nullsFirst:false })
    .order('created_at', { ascending:false });

  const tbody = document.getElementById('orderRows');
  if (orders && orders.length) {
    orders.forEach(o => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${fmtDate(o.paid_at)}</td>
        <td>${o.period || '-'}</td>
        <td>${fmtAmount(o.total)}</td>
      `;
      tbody.appendChild(tr);
    });
  } else {
    tbody.innerHTML = `<tr><td colspan="3" class="muted">尚無訂單</td></tr>`;
  }

  /* ====== 3. 有效訂閱時擋再買 ====== */
  const { data: active } = await supabase
    .from('orders')
    .select('id, expire_at')
    .eq('user_id', user.id)
    .in('status', ['paid','success'])
    .gt('expire_at', new Date().toISOString())
    .limit(1);

  if (active && active.length) {
    document.getElementById('buyBtn').onclick = e => {
      e.preventDefault();
      alert(`你目前已有有效訂閱\n到期日：${fmtDate(active[0].expire_at)}`);
    };
  }

})();
</script>

</body>
</html>






