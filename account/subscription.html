<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>我的訂閱</title>
  <style>
    :root{
      --bg:#ffffff; --text:#111; --muted:#6b7280; --border:#e5e7eb;
      --chip:#111; --chipText:#fff; --ok:#065f46; --warn:#92400e;
    }
    html,body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","Microsoft JhengHei",sans-serif;margin:0}
    .wrap{max-width:980px;margin:28px auto;padding:0 16px}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .back{display:inline-block;color:#2563eb;text-decoration:none}
    h1{font-size:34px;margin:8px 0 14px}
    .card{border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:16px}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:8px;background:var(--chip);color:var(--chipText);border-radius:999px;padding:6px 12px;font-weight:700}
    .btn{display:inline-flex;align-items:center;gap:8px;background:#111;color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn.secondary{background:#fff;color:#111;border:1px solid #111}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:680px){ .grid{grid-template-columns:1fr} }
    .kvs{display:grid;grid-template-columns:120px 1fr;gap:8px;align-items:center}
    .kvs div.key{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
    th{color:var(--muted);font-weight:600}
    .right{text-align:right}
    .status-ok{color:var(--ok);font-weight:700}
    .status-exp{color:#991b1b;font-weight:700}
    .hint{color:var(--muted);font-size:.95rem}
    .empty{color:var(--muted);text-align:center;padding:16px}
  </style>
  <script>
    // 由你的全站注入，或在此直接指定
    window.SB_URL  = window.SB_URL  || "https://jeajrwpmrgczimmrflxo.supabase.co";
    window.SB_ANON = window.SB_ANON || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="back" href="../index.html">← 回首頁</a>
      <a class="back" href="../pricing.html">方案與定價 →</a>
    </div>
    <h1>我的訂閱</h1>

    <div id="activeCard" class="card">
      <div class="muted">目前使用中</div>
      <div id="activeContent" class="grid" style="margin-top:8px">
        <!-- 動態填入 -->
      </div>
      <div id="renewArea" style="margin-top:12px; display:none;">
        <button id="btnRenew" class="btn">立即續約</button>
        <span class="hint">到期前 7 天會寄送提醒信。</span>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="muted">歷史訂單</div>
        <button id="btnRefresh" class="btn secondary">重新整理</button>
      </div>
      <div id="ordersArea">
        <table>
          <thead>
            <tr>
              <th>日期</th>
              <th>方案</th>
              <th>週期</th>
              <th class="right">金額</th>
              <th>狀態</th>
            </tr>
          </thead>
          <tbody id="ordersBody">
            <tr><td colspan="5" class="empty">載入中…</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <p class="hint">若您對訂閱或付款有疑問，請聯絡客服或回覆付款通知信。</p>
  </div>

  <script>
  (async function(){
    const supabase = window.supabase.createClient(window.SB_URL, window.SB_ANON);
    const { data: { user } } = await supabase.auth.getUser();
    if (!user){ document.querySelector('#ordersBody').innerHTML = '<tr><td colspan="5" class="empty">請先登入查看訂閱與訂單</td></tr>'; return; }

    const currency = (cents)=> 'NT$' + Math.round(cents/100);
const fmtDate = (d)=>{ try{ if(!d) return '—'; const x=new Date(d); if(isNaN(+x)) return '—'; return x.toLocaleDateString(); }catch(e){ return '—'; } };
const daysLeft = (d)=>{ try{ if(!d) return null; const x=new Date(d).getTime(); const n=Date.now(); return Math.ceil((x-n)/86400000); }catch(e){ return null; } };

    async function loadOrders(){
      const { data: myProfile } = await supabase.from('profiles').select('last_sign_in_at').eq('id', user.id).single();
      const { data, error } = await supabase
        .from('orders')
        .select('id, items, period, subtotal_cents, discount_cents, commission_cents, status, paid_at, expire_at')
        .eq('buyer_id', user.id)
        .order('paid_at', { ascending: false })
        .limit(100);

      if (error){
        document.querySelector('#ordersBody').innerHTML = '<tr><td colspan="5" class="empty">載入失敗：'+ (error.message||error) +'</td></tr>';
        return { list: [], active: null };
      }

      // Render table
      const body = document.querySelector('#ordersBody');
      if (!data || data.length === 0){
        body.innerHTML = '<tr><td colspan="5" class="empty">尚無訂單</td></tr>';
      }else{
        body.innerHTML = data.map(o=>{
          const total = (o.subtotal_cents||0) - (o.discount_cents||0);
          const date = o.paid_at ? new Date(o.paid_at).toLocaleDateString() : '—';
          const items = Array.isArray(o.items) ? o.items.join(', ') : (o.items||'').toString();
          const statusTxt = (o.status==='paid') ? '<span class="status-ok">已付款</span>' :
                             (o.status==='expired') ? '<span class="status-exp">已到期</span>' : (o.status||'—');
          return `<tr>
            <td>${date}</td>
            <td>${items}</td>
            <td>${o.period||'—'}</td>
            <td class="right">${currency(total)}</td>
            <td>${statusTxt}</td>
          </tr>`;
        }).join('');
      }

      // Pick active subscription: paid & 未到期 中最晚到期的那筆
      const now = new Date();
      const valid = (data||[]).filter(o => o.status==='paid' && o.expire_at && new Date(o.expire_at) > now);
      valid.sort((a,b)=> new Date(b.expire_at) - new Date(a.expire_at));
      const active = valid[0] || null;
      renderActive(active);
      return { list: data, active };
    }

    async function renderActive(active){
      const box = document.getElementById('activeContent');
      const renew = document.getElementById('renewArea');
      if (!active){
        // Fallback: read profiles.expires_at / plan
        const { data: prof } = await supabase.from('profiles')
          .select('expires_at, plan, plan_name, tier, last_sign_in_at')
          .eq('id', user.id)
          .single();
        const exp = prof?.expires_at || null;
        const plan = prof?.plan || prof?.plan_name || prof?.tier || '—';
        const dl = daysLeft(exp);
        const status = (exp && new Date(exp) > new Date()) ? '<span class="status-ok">使用中</span>' : '<span class="status-exp">已到期 / 未訂閱</span>';
        const lastLogin = fmtDate(prof?.last_sign_in_at);
        box.innerHTML = `
          <div class="kvs">
            <div class="key">方案</div><div><span class="pill">${plan}</span></div>
            <div class="key">到期日</div><div><b>${fmtDate(exp)}</b>${(dl!=null)?`　<small class="muted">${dl>=0?`剩餘 ${dl} 天`:`${Math.abs(dl)} 天前到期`}</small>`:''}</div>
            <div class="key">狀態</div><div>${status}</div>
            <div class="key">最後登入</div><div>${lastLogin}</div>
          </div>`;
        renew.style.display = '';
        document.getElementById('btnRenew').onclick = ()=>{ location.href = '../pricing.html'; };
        return;
      }
      const items = Array.isArray(active.items) ? active.items.join('、') : active.items;
      const total = (active.subtotal_cents||0) - (active.discount_cents||0);
      const expire = new Date(active.expire_at).toLocaleDateString();
      const paid = active.paid_at ? new Date(active.paid_at).toLocaleDateString() : '—';

      box.innerHTML = `
        <div class="kvs">
          <div class="key">方案</div><div><span class="pill">${items}</span></div>
          <div class="key">週期</div><div>${active.period||'—'}</div>
          <div class="key">付款日期</div><div>${paid}</div>
          <div class="key">到期日</div><div><b>${expire}</b>　<small class="muted">${(daysLeft(active.expire_at)!=null)?(daysLeft(active.expire_at)>=0?`剩餘 ${daysLeft(active.expire_at)} 天`:`${Math.abs(daysLeft(active.expire_at))} 天前到期`):''}</small></div>
          <div class="key">金額</div><div><b>${currency(total)}</b></div>
          <div class="key">狀態</div><div><span class="status-ok">使用中</span></div>
          <div class="key">最後登入</div><div>${fmtDate(myProfile?.last_sign_in_at)}</div>
        </div>
      `;
      renew.style.display = '';
      // 綁定續約按鈕：導回 pricing，帶上目前方案與週期
      const usp = new URLSearchParams();
      usp.set('items', (Array.isArray(active.items)?active.items: (active.items||'')).toString().replace(/\s+/g,''));
      usp.set('period', active.period || 'month');
      document.getElementById('btnRenew').onclick = ()=>{
        location.href = '../pricing.html?' + usp.toString();
      };
    }

    document.getElementById('btnRefresh').onclick = loadOrders;
    loadOrders();
  })();
  </script>
</body>
</html>

