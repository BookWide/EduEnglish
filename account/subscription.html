<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>我的訂閱｜BookWide</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#f4f6fb;
      --card:#fff;
      --ink:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --brand:#2563eb;
      --brand2:#111827;
      --radius:18px;
      --shadow:0 10px 30px rgba(15,23,42,.08);
      --ok:#065f46;
      --bad:#b91c1c;
      --warn:#92400e;
      --soft:#f9fafb;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      background:var(--bg);
      color:var(--ink);
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px;}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      gap:12px;margin-bottom:10px;
    }
    .topLeft,.topRight{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      background:#fff;border:1px solid var(--line);
      box-shadow:0 6px 18px rgba(15,23,42,.06);
      font-size:13px;color:#374151;
    }
    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      padding:10px 16px;border-radius:999px;border:1px solid var(--line);
      background:#fff;cursor:pointer;
      box-shadow:0 8px 22px rgba(15,23,42,.08);
      font-weight:700;
    }
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff;}
    .btn.dark{background:var(--brand2);border-color:var(--brand2);color:#fff;}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    h1{margin:12px 0 18px 0;font-size:44px;letter-spacing:1px}
    .card{
      background:var(--card);
      border-radius:28px;
      box-shadow:var(--shadow);
      padding:26px;
      margin:18px 0;
    }
    .card h3{margin:0 0 14px 0;font-size:20px}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:#fff;color:#374151;
      font-size:12px;margin-left:8px;
    }
    .pill.ok{color:var(--ok);border-color:#bbf7d0;background:#ecfdf5}
    .pill.bad{color:var(--bad);border-color:#fecaca;background:#fef2f2}
    .pill.neu{color:#374151}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    @media(max-width:860px){ .grid2{grid-template-columns:1fr} h1{font-size:36px} }
    .kv{display:grid;grid-template-columns:110px 1fr;gap:8px 12px;align-items:center}
    .kv b{font-weight:800}
    .divider{height:1px;background:var(--line);margin:14px 0}
    table{width:100%;border-collapse:collapse;margin-top:8px;}
    th,td{padding:14px 12px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top;}
    th{font-weight:800;color:#111827}
    td:last-child,th:last-child{text-align:right}
    .warnBox{
      border:1px dashed #e5e7eb;border-radius:14px;
      padding:12px 14px;background:var(--soft);
      display:flex;gap:10px;align-items:flex-start;
      color:#374151;
    }
    .warnIcon{font-size:18px;line-height:1}
    .warnTitle{font-weight:900;color:var(--warn)}
    .actionsRow{display:flex;gap:12px;flex-wrap:wrap;margin-top:14px}
    .tiny{font-size:12px;color:var(--muted)}
    .rightAmount{font-size:16px;font-weight:900}
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="topLeft">
        <button class="btn" id="btnHome">← 回首頁</button>
      </div>

      <div class="topRight">
        <div class="chip" id="whoChip">未登入</div>
        <button class="btn" id="btnBack">回上一頁 →</button>
      </div>
    </div>

    <h1>我的訂閱</h1>

    <div class="card">
      <h3>目前訂閱 <span id="subStatus" class="pill neu">檢查中</span></h3>

      <div class="grid2">
        <div id="currentSub" class="muted">讀取中…</div>
        <div id="currentRight" class="muted"></div>
      </div>

      <div id="avoidDup" style="margin-top:14px;display:none;"></div>

      <div class="actionsRow">
        <a href="/pricing.html" class="btn primary" id="btnGoPricing">前往訂閱</a>
        <button class="btn" id="btnLocked" style="display:none;" disabled>訂閱中（已鎖定避免重複）</button>
      </div>
    </div>

    <div class="card">
      <h3>歷史訂單</h3>
      <table>
        <thead>
          <tr>
            <th>付款日期</th>
            <th>方案</th>
            <th>金額</th>
          </tr>
        </thead>
        <tbody id="historyBody">
          <tr><td colspan="3" class="muted">讀取中…</td></tr>
        </tbody>
      </table>
      <div id="debug" class="tiny" style="margin-top:10px;"></div>
    </div>

  </div>

<script type="module">
const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";

async function waitSupabase(ms = 4000){
  const start = Date.now();
  while(!window.supabase){
    if(Date.now()-start>ms) return false;
    await new Promise(r=>setTimeout(r,50));
  }
  return true;
}
function $(id){ return document.getElementById(id); }
function fmtDate(v){
  if(!v) return "-";
  const d = new Date(v);
  return isNaN(d.getTime()) ? "-" : d.toLocaleString();
}

/**
 * ✅ 這裡是關鍵修正：
 * - total / subtotal：視為「元」
 * - total_cents / unit_price：視為「分」
 */
function moneyNTDFromRow(o){
  if(!o) return "-";

  // 1) total（元）
  if (typeof o.total === "number" && o.total > 0) {
    return "NT$ " + Math.round(o.total).toLocaleString("en-US");
  }

  // 2) subtotal（元）
  if (typeof o.subtotal === "number" && o.subtotal > 0) {
    return "NT$ " + Math.round(o.subtotal).toLocaleString("en-US");
  }

  // 3) total_cents（分）
  if (typeof o.total_cents === "number" && o.total_cents > 0) {
    const ntd = Math.round(o.total_cents / 100);
    return "NT$ " + ntd.toLocaleString("en-US");
  }

  // 4) unit_price*quantity（分）
  if (typeof o.unit_price === "number" && o.unit_price > 0) {
    const q = (typeof o.quantity === "number" && o.quantity>0) ? o.quantity : 1;
    const cents = o.unit_price * q;
    const ntd = Math.round(cents / 100);
    return "NT$ " + ntd.toLocaleString("en-US");
  }

  return "NT$ 0";
}

function planTextFromRow(o){
  const s = o?.status ? String(o.status) : "-";
  const exp = o?.expire_at ? ("到期 " + fmtDate(o.expire_at)) : "無到期日";
  return `${s}（${exp}）`;
}
function isActiveByExpire(o){
  if(!o) return false;
  if(!o.expire_at) return true;
  const exp = new Date(o.expire_at);
  return !isNaN(exp.getTime()) && exp > new Date();
}
function daysLeft(expire_at){
  if(!expire_at) return null;
  const exp = new Date(expire_at);
  if(isNaN(exp.getTime())) return null;
  const diff = exp.getTime() - Date.now();
  return Math.ceil(diff / 86400000);
}

$("btnHome").onclick = () => location.href = "/index.html";
$("btnBack").onclick = () => {
  if (history.length > 1) history.back();
  else location.href = "/index.html";
};

(async () => {
  const $current = $("currentSub");
  const $right   = $("currentRight");
  const $history = $("historyBody");
  const $status  = $("subStatus");
  const $debug   = $("debug");
  const $who     = $("whoChip");
const $locked  = $("btnLocked");
  const $avoidDup= $("avoidDup");
  const $goPricing = $("btnGoPricing");

  if(!(await waitSupabase(5000))){
    $status.textContent = "錯誤";
    $status.className = "pill bad";
    $current.innerHTML = `<div class="mono" style="color:var(--bad);font-weight:900;">supabase-js 未載入</div>`;
    $history.innerHTML = `<tr><td colspan="3" style="color:var(--bad);font-weight:900;">SDK 未載入</td></tr>`;
    return;
  }

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const { data: authData, error: authErr } = await sb.auth.getUser();
  const user = authData?.user;

  if(authErr || !user){
    $who.textContent = "未登入";
    $status.textContent = "未登入";
    $status.className = "pill bad";
    $current.innerHTML = `<div style="color:var(--bad);font-weight:900;">尚未登入</div>`;
    $history.innerHTML = `<tr><td colspan="3" class="muted">請先登入</td></tr>`;
$debug.textContent = "";
    return;
  }

  const email = user.email || "(no email)";
  const uidShort = String(user.id || "").slice(0,8);
  $who.textContent = `${email} · ${uidShort}`;
  $debug.textContent = `auth uid: ${user.id}`;

  // ✅ 這裡多抓 total/subtotal
  const { data: orders, error: ordersErr } = await sb
    .from("orders")
    .select("id,status,paid_at,expire_at,buyer_id,user_id,referrer_id,referral_code,total,total_cents,subtotal,unit_price,quantity,items,period")
    .or(`buyer_id.eq.${user.id},user_id.eq.${user.id}`)
    .order("paid_at", { ascending: false, nullsFirst: false });

  if(ordersErr){
    $status.textContent = "錯誤";
    $status.className = "pill bad";
    $current.innerHTML = `<div style="color:var(--bad);font-weight:900;">讀取失敗：${ordersErr.message}</div>`;
    $history.innerHTML = `<tr><td colspan="3" style="color:var(--bad);font-weight:900;">${ordersErr.message}</td></tr>`;
return;
  }

  const list = Array.isArray(orders) ? orders : [];
  if(list.length === 0){
    $status.textContent = "無資料";
    $status.className = "pill neu";
    $current.innerHTML = `<div style="color:var(--bad);font-weight:900;">尚無訂閱紀錄</div>`;
    $history.innerHTML = `<tr><td colspan="3" class="muted">沒有任何訂單</td></tr>`;

    // ✅ 未訂閱：直接導回你的成熟訂閱入口（pricing）
    setTimeout(()=>location.replace('/pricing.html'), 120);
    return;
  }

  const paidList = list.filter(o => String(o.status||"").toLowerCase() === "paid");
  const activePaid = paidList.find(o => isActiveByExpire(o)) || null;
  const latest = activePaid || list[0];

  const active = activePaid ? true : (String(latest.status||"").toLowerCase()==="paid" && isActiveByExpire(latest));

  $status.textContent = active ? "有效" : "無資料";
  $status.className = "pill " + (active ? "ok" : "neu");

  if(!active){
    // ✅ 沒有有效訂閱：回到 pricing（讓用戶完成你既有的 checkout/綠界流程）
    setTimeout(()=>location.replace('/pricing.html'), 120);
    return;
  }

  const amt = moneyNTDFromRow(latest);
  const buyerEmail = email;

  $right.innerHTML = `
    <div class="kv">
      <div class="muted">金額：</div><div class="rightAmount">${amt}</div>
      <div class="muted">到期日期：</div><div class="mono">${fmtDate(latest.expire_at)}</div>
      <div class="muted">下單帳號：</div><div class="mono">${buyerEmail}</div>
    </div>
  `;

  $current.innerHTML = `
    <div class="kv">
      <div class="muted">狀態：</div><div><b style="color:${active?'var(--ok)':'var(--bad)'}">${latest.status || "-"}</b></div>
      <div class="muted">付款日期：</div><div class="mono">${fmtDate(latest.paid_at)}</div>
      <div class="muted">訂單ID：</div><div class="mono">${latest.id}</div>
    </div>
  `;

  if(active){
    // After successful subscription return, if user has not completed level survey, redirect once
    // Only auto-redirect when URL contains rtn/mtn (payment return) to avoid looping on later visits.
    try{
      const qs = new URLSearchParams(location.search);
      const isReturn = qs.has('rtn') || qs.has('mtn');
      if(isReturn){
        const done = (localStorage.getItem('BW_LEVEL_DONE') === '1') || !!localStorage.getItem('BW_CEFR_BEST');
        let hasProfileLevel = false;
        try{
          const prof = await sb.from('profiles').select('cefr_level,cefr_score').eq('id', user.id).maybeSingle();
          const pr = prof?.data || {};
          hasProfileLevel = !!(pr.cefr_level || pr.cefr_score);
        }catch(_e){ /* ignore */ }
        if(!(done || hasProfileLevel)){
          const next = qs.get('next') || '/player.html';
          const url = '/account/level-survey.html?next=' + encodeURIComponent(next);
          setTimeout(()=>location.replace(url), 250);
        }
      }
    }catch(_){ }

    const leftDays = daysLeft(latest.expire_at);
    $avoidDup.style.display = "block";
    $avoidDup.innerHTML = `
      <div class="warnBox">
        <div class="warnIcon">⚠️</div>
        <div>
          <div class="warnTitle">尚未到期，請勿重覆訂閱</div>
          <div class="tiny">你現在的訂閱仍有效${leftDays!=null?`，距離到期約 ${leftDays} 天`:``}。（避免重複扣款）</div>
        </div>
      </div>
    `;

    $goPricing.style.display = "none";
$locked.style.display = "inline-flex";
  } else {
$goPricing.style.display = "inline-flex";
    $locked.style.display = "none";
    $avoidDup.style.display = "none";
  }

  const history = paidList.length ? paidList : list;

  $history.innerHTML = history.map(o => `
    <tr>
      <td class="mono"><b>${fmtDate(o.paid_at)}</b></td>
      <td>${planTextFromRow(o)}</td>
      <td class="mono"><b>${moneyNTDFromRow(o)}</b></td>
    </tr>
  `).join("");

})();
</script>
</body>
</html>














