<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>學習控制台</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f6f8fb; --card:#fff; --text:#1f2937; --muted:#6b7280; --brand:#2563eb; --chip:#eef2ff; --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:"Noto Sans TC",system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";background:var(--bg);color:var(--text)}
    a{color:var(--brand);text-decoration:none}
    .wrap{max-width:1080px;margin:28px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    header .back{display:inline-flex;align-items:center;gap:8px;color:var(--brand)}
    header .user{color:var(--muted);font-size:14px}
    h1{font-size:28px;margin:6px 0 18px;font-weight:800}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px}
    .card h2{margin:0 0 12px;font-size:20px}
    .item{padding:12px 10px;border-radius:12px;border:1px solid var(--border);background:#fff;display:flex;align-items:center;gap:12px}
    .item+.item{margin-top:8px}
    .thumb{width:72px;height:48px;background:#f2f2f6;border-radius:8px;object-fit:cover;border:1px solid var(--border)}
    .meta{flex:1}
    .title{font-weight:700}
    .sub{color:var(--muted);font-size:13px;margin-top:2px}
    .chip{background:var(--chip);color:#4f46e5;border-radius:999px;font-size:12px;padding:4px 8px;margin-left:8px}
    .empty{color:var(--muted);padding:8px 4px}
    footer{margin:28px 0 10px;color:var(--muted);font-size:13px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <a class="back" href="/EduEnglish/index.html">← 回首頁</a>
      <div class="user" id="userEmail"> </div>
    </header>

    <h1>學習控制台</h1>

    <div class="grid">
      <!-- 左側 -->
      <section class="card">
        <h2>繼續播放 <span id="continuePct" class="chip" style="display:none"></span></h2>
        <div id="continueBlock" class="block">
          <div class="empty">目前沒有未看完的影片。</div>
        </div>
      </section>

      <!-- 右側 -->
      <section class="card">
        <h2>今日複習</h2>
        <div id="reviewBlock" class="block">
          <div class="empty">今日沒有到期的複習項目。</div>
        </div>
      </section>
    </div>

    <div class="grid" style="margin-top:20px">
      <section class="card">
        <h2>最近看過</h2>
        <div id="recentBlock" class="block">
          <div class="empty">尚無觀看紀錄。</div>
        </div>
      </section>

      <section class="card">
        <h2>我的清單</h2>
        <div id="favBlock" class="block">
          <div class="empty">尚未收藏任何影片。</div>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top:20px">
      <h2>學習曲線（最近 7 天）</h2>
      <div class="empty">（預留：之後以 Chart.js 畫每日觀看數或學習分鐘數）</div>
      <canvas id="chart" style="display:none"></canvas>
    </section>

    <footer>BookWide · EduEnglish</footer>
  </div>

  <!-- Chart.js（學習曲線預留） -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- 主程式：連 Supabase -->
  <script type="module">
    import { supabase } from '../supa.js';

    const elUser = document.querySelector('#userEmail');
    const elContinue = document.querySelector('#continueBlock');
    const elContinuePct = document.querySelector('#continuePct');
    const elRecent = document.querySelector('#recentBlock');
    const elFav = document.querySelector('#favBlock');
    const elReview = document.querySelector('#reviewBlock');

    // 方便建立項目卡
    const makeItem = (slug, title, pct = null, whenText = '', thumb = '') => {
      const a = document.createElement('a');
      a.className = 'item';
      a.href = `/EduEnglish/player.html?slug=${encodeURIComponent(slug)}`;
      a.innerHTML = `
        <img class="thumb" src="${thumb || 'https://dummyimage.com/320x180/eee/aaa.jpg&text=Video'}" alt="">
        <div class="meta">
          <div class="title">${title || slug}${pct != null ? `<span class="chip">${pct}%</span>`:''}</div>
          <div class="sub">${whenText || ''}</div>
        </div>
      `;
      return a;
    };

    // 取得登入者
    const { data: userRes } = await supabase.auth.getUser();
    const user = userRes?.user;
    if (!user) {
      // 未登入 → 導回登入頁（可帶 next）
      location.href = `/EduEnglish/login.html?next=${encodeURIComponent(location.pathname)}`;
    }
    elUser.textContent = user.email;

    // 先載 video_meta 做 slug→title/縮圖 對照
    const titleMap = {};
    const thumbMap = {};
    (await supabase.from('video_meta').select('slug,title,thumbnail_url,active').eq('active', true))
      .data?.forEach(v => { titleMap[v.slug] = v.title; thumbMap[v.slug] = v.thumbnail_url });

    // 讀 watch_logs：最近 50 筆
    const { data: logs } = await supabase
      .from('watch_logs')
      .select('video_slug, progress_pct, updated_at')
      .eq('user_id', user.id)
      .order('updated_at', { ascending: false })
      .limit(50);

    // 繼續播放：找第一筆 1~99% 的
    const cont = (logs || []).find(r => r.progress_pct > 0 && r.progress_pct < 100);
    if (cont) {
      elContinue.innerHTML = '';
      const title = titleMap[cont.video_slug] || cont.video_slug;
      const thumb = thumbMap[cont.video_slug] || '';
      const when = new Date(cont.updated_at).toLocaleString();
      elContinue.appendChild(makeItem(cont.video_slug, title, Math.round(cont.progress_pct), `上次看到：${when}`, thumb));
      elContinuePct.textContent = `未完成 ${Math.round(cont.progress_pct)}%`;
      elContinuePct.style.display = 'inline-block';
    }

    // 最近看過：取前三筆（包含 0%/100%）
    if (logs && logs.length) {
      elRecent.innerHTML = '';
      logs.slice(0, 3).forEach(r => {
        const title = titleMap[r.video_slug] || r.video_slug;
        const thumb = thumbMap[r.video_slug] || '';
        const when = new Date(r.updated_at).toLocaleString();
        elRecent.appendChild(makeItem(r.video_slug, title, Math.round(r.progress_pct), `${when} · 進度 ${Math.round(r.progress_pct)}%`, thumb));
      });
    }

    // 我的清單（favorites）
    const { data: favs } = await supabase
      .from('favorites')
      .select('video_slug, created_at')
      .eq('user_id', user.id)
      .order('created_at', { ascending: false })
      .limit(5);

    if (favs && favs.length) {
      elFav.innerHTML = '';
      favs.forEach(f => {
        const title = titleMap[f.video_slug] || f.video_slug;
        const thumb = thumbMap[f.video_slug] || '';
        const when = new Date(f.created_at).toLocaleDateString();
        elFav.appendChild(makeItem(f.video_slug, title, null, `加入日期：${when}`, thumb));
      });
    }

    // 今日複習（預留：目前顯示空訊息）
    // 之後你可在 review_tasks 增加 due_at，這裡查 eq('due_at', today)
    // 若有資料，照上面 makeItem 方式渲染

    // 學習曲線（預留：有需要再開）
    // const ctx = document.querySelector('#chart'); // 之後用 logs 聚合資料，用 Chart.js 畫線圖
  </script>
</body>
</html>











