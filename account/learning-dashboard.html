<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>學習控制台</title>
  <style>
    :root {
      --card-bg:#fff;
      --muted:#6b7280;
      --border:#e5e7eb;
      --brand:#2563eb;
    }
    body{
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji;
      margin:0; background:#f4f6fb; color:#111827;
    }
    .wrap{ max-width:1080px; margin:32px auto 80px; padding:0 16px; }
    .nav{ display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
    .back{
      display:inline-flex; align-items:center; gap:.5rem;
      background:#eef2ff; color:#1e40af; border:1px solid #c7d2fe;
      text-decoration:none; padding:8px 12px; border-radius:10px; font-weight:600;
    }
    h1{ margin:8px 0 16px; font-size:28px; letter-spacing:.04em; }
    .grid{
      display:grid; grid-template-columns:1fr 1fr; gap:20px;
    }
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background:var(--card-bg); border:1px solid var(--border);
      border-radius:16px; padding:16px 16px; box-shadow:0 1px 0 rgba(0,0,0,.02);
    }
    .card h2{ margin:0 0 10px; font-size:20px; }
    .muted{ color:var(--muted); }
    .list{ margin:8px 0 0; padding-left:18px; }
    .list li{ margin:8px 0; }

    /* 新增：藍底白字徽章 */
    .pill{
      display:inline-block; padding:4px 10px; border-radius:999px;
      background:var(--brand); color:#fff; font-size:12px; font-weight:700;
      vertical-align:middle;
    }

    /* 可點的卡片鍊結 */
    .link-card{
      display:block; padding:12px 14px; border-radius:12px;
      background:#f9fafb; color:inherit; text-decoration:none;
      border:1px solid var(--border); transition:.15s;
    }
    .link-card:hover{ background:#f3f4f6; border-color:#d1d5db; }
    .title-line{ font-weight:700; font-size:17px; margin-bottom:6px; }
    .sub-line{ color:#374151; font-size:14px; }

    /* 右上角 mail */
    .mail{ color:#374151; }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- 上方工具列 -->
    <div class="nav">
      <a class="back" href="../index.html">← 回首頁</a>
      <div class="mail" id="userEmail"></div>
    </div>

    <h1>學習控制台</h1>

    <div class="grid">

      <!-- 繼續播放 -->
      <section class="card">
        <h2>
          繼續播放
          <span id="continueBadge" class="pill" style="display:none">未完成</span>
        </h2>
        <div id="continueBody" class="muted">目前沒有未看完的影片。</div>
      </section>

      <!-- 今日複習（保留外觀與占位） -->
      <section class="card">
        <h2>今日複習</h2>
        <div class="muted" id="reviewToday">今日沒有到期的複習項目。</div>
      </section>

      <!-- 最近看過 -->
      <section class="card">
        <h2>最近看過</h2>
        <ul id="recentList" class="list muted">
          <li>尚無觀看紀錄。</li>
        </ul>
      </section>

      <!-- 我的清單（保留） -->
      <section class="card">
        <h2>我的清單</h2>
        <div class="muted">尚未收藏任何影片。</div>
      </section>

      <!-- 學習曲線（預留） -->
      <section class="card" style="grid-column:1/-1">
        <h2>學習曲線（最近 7 天）</h2>
        <div class="muted">（預留；之後改為 Chart.js 折線圖）</div>
      </section>
    </div>
  </div>

  <!-- 這支照你的專案結構，從 /EduEnglish/account/ 回上一層取用 -->
  <script type="module">
    import { supabase } from '../supa.js';

    const emailEl   = document.getElementById('userEmail');
    const contBody  = document.getElementById('continueBody');
    const contBadge = document.getElementById('continueBadge');
    const recentUl  = document.getElementById('recentList');

    const fmtDate = (iso) => {
      const d = new Date(iso);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      return `${y}/${m}/${day} ${hh}:${mm}`;
    };

    // 1) 取得登入
    const { data:authData, error:authErr } = await supabase.auth.getUser();
    const user = authData?.user || null;
    if (!user) {
      // 未登入仍顯示頁面，但提醒並導回首頁
      alert('請先登入後再使用學習控制台');
      location.href = '../index.html';
      throw new Error('No session');
    }
    emailEl.textContent = user.email ?? '';

    // 2) 撈 watch_logs（已在 DB 啟用 RLS -> 只能看到自己的）
    const { data:logs, error:logErr } = await supabase
      .from('watch_logs')
      .select('*')
      .order('updated_at', { ascending:false })
      .limit(30);

    if (logErr) {
      console.warn('watch_logs 讀取失敗：', logErr.message || logErr);
    }

    if (!logs || logs.length === 0) {
      contBody.textContent = '目前沒有未看完的影片。';
      recentUl.innerHTML = '<li>尚無觀看紀錄。</li>';
    } else {
      // A. 繼續播放：找到第一個進度 < 100 的條目；若都 100%，就用最最新的一筆當作提示
      const cont = logs.find(l => (l.progress_pct ?? 0) < 100) ?? logs[0];
      const pct  = Math.round(cont.progress_pct ?? 0);
      const slug = cont.video_slug;
      const videoUrl = `../player.html?slug=${encodeURIComponent(slug)}`;

      contBody.innerHTML = `
        <a class="link-card" href="${videoUrl}">
          <div class="title-line">🎬 ${slug}</div>
          <div class="sub-line">上次進度 <b>${pct}%</b>　更新：${fmtDate(cont.updated_at)}</div>
        </a>
      `;
      contBadge.style.display = (pct >= 100) ? 'none' : 'inline-block';

      // B. 最近看過：列 6 筆
      const items = logs.slice(0, 6).map(r => {
        const p = Math.round(r.progress_pct ?? 0);
        const s = r.video_slug;
        const url = `../player.html?slug=${encodeURIComponent(s)}`;
        return `
          <li>
            <a href="${url}" style="text-decoration:none;color:inherit;"><b>🎞 ${s}</b></a>
            <span class="muted">　進度 ${p}%・${fmtDate(r.updated_at)}</span>
          </li>
        `;
      }).join('');
      recentUl.innerHTML = items;
    }

    // （「今日複習」、「我的清單」、「學習曲線」保留你既有結構，之後要串資料再補。）
  </script>
</body>
</html>
































