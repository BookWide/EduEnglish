<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>學習控制台｜BookWide</title>
  <style>
    :root{
      --bg:#f4f6fb;
      --card-bg:#fff;
      --muted:#6b7280;
      --border:#e5e7eb;
      --brand:#2563eb;
      --brand-soft:#e0edff;
      --danger:#b91c1c;
      --radius-lg:18px;
      --shadow-card:0 10px 30px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      background:var(--bg);
      color:#111827;
    }
    a{text-decoration:none;color:inherit;}
    img{max-width:100%;display:block;}

    .wrap{
      max-width:1080px;
      margin:32px auto 80px;
      padding:0 16px;
    }

    .nav{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:16px;
      gap:12px;
    }
    .back{
      display:inline-flex;
      align-items:center;
      gap:.5rem;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid #c7d2fe;
      background:#eef2ff;
      color:#1e40af;
      font-size:14px;
      cursor:pointer;
    }
    .back span:first-child{font-size:18px;margin-top:-2px;}
    .user-pill{
      padding:6px 12px;
      border-radius:999px;
      background:#111827;
      color:#f9fafb;
      font-size:13px;
      display:flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .user-pill small{opacity:.8;}
    .logout-btn{
      margin-left:8px;
      padding:4px 10px;
      font-size:12px;
      border-radius:999px;
      border:1px solid #4b5563;
      background:#fff;
      color:#111827;
      cursor:pointer;
    }

    h1{
      margin:0 0 18px;
      font-size:26px;
      letter-spacing:.05em;
    }

    .layout{
      display:grid;
      grid-template-columns:minmax(0,2fr) minmax(0,1.55fr);
      gap:18px;
      align-items:flex-start;
    }
    @media(max-width:880px){
      .layout{
        grid-template-columns:minmax(0,1fr);
      }
    }

    .card{
      background:var(--card-bg);
      border-radius:var(--radius-lg);
      padding:16px 18px;
      box-shadow:var(--shadow-card);
      border:1px solid rgba(148,163,184,.28);
    }
    .card-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .card-title h2{
      margin:0;
      font-size:16px;
    }
    .tag{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      background:#e5e7eb;
      color:#374151;
    }
    .tag.blue{
      background:var(--brand-soft);
      color:#1e40af;
    }

    /* 繼續播放 */
    .continue-box{
      display:flex;
      align-items:center;
      gap:14px;
      padding:10px 0 6px;
      min-height:72px;
    }
    .thumb{
      width:70px;
      height:70px;
      border-radius:12px;
      overflow:hidden;
      background:#e5e7eb;
      flex-shrink:0;
    }
    .thumb img{width:100%;height:100%;object-fit:cover;}
    .cont-meta{
      flex:1;
      min-width:0;
    }
    .cont-meta .title{
      font-weight:600;
      margin-bottom:4px;
      font-size:15px;
    }
    .cont-meta .sub{
      font-size:12px;
      color:var(--muted);
    }
    .progress-wrap{
      margin-top:8px;
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:var(--muted);
    }
    .bar{
      position:relative;
      flex:1;
      height:6px;
      background:#e5e7eb;
      border-radius:999px;
      overflow:hidden;
    }
    .bar span{
      position:absolute;
      inset:0;
      width:0%;
      border-radius:999px;
      background:linear-gradient(90deg,#3b82f6,#10b981);
    }

    .btn-primary{
      margin-top:10px;
      padding:6px 14px;
      font-size:13px;
      border-radius:999px;
      border:none;
      background:var(--brand);
      color:#fff;
      cursor:pointer;
    }

    /* 最近看過 */
    .recent-list{
      margin:4px 0 0;
      padding:0;
      list-style:none;
      font-size:13px;
    }
    .recent-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:4px 0;
      gap:10px;
      cursor:pointer;
    }
    .recent-left{
      display:flex;
      align-items:center;
      gap:6px;
      min-width:0;
    }
    .dot{
      width:18px;
      height:18px;
      border-radius:4px;
      background:#111827;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:10px;
      color:#f9fafb;
      flex-shrink:0;
    }
    .recent-title{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .recent-meta{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }

    /* 今日複習 & 清單 */
    .grid-small{
      display:grid;
      grid-template-columns:minmax(0,1fr);
      gap:14px;
    }
    .review-item{
      display:flex;
      gap:10px;
      padding:6px 0;
      font-size:13px;
      cursor:pointer;
    }
    .review-thumb{
      width:56px;
      height:56px;
      border-radius:10px;
      overflow:hidden;
      flex-shrink:0;
      background:#e5e7eb;
    }
    .review-info small{
      display:block;
      font-size:11px;
      color:#6b7280;
    }

    .empty-tip{
      font-size:13px;
      color:var(--muted);
      padding-top:4px;
    }

    /* 學習曲線 */
    .chart-wrap{
      margin-top:6px;
    }
    .chart-row{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:12px;
      margin:4px 0;
    }
    .chart-label{
      width:54px;
      color:var(--muted);
      flex-shrink:0;
    }
    .chart-bar{
      flex:1;
      height:8px;
      border-radius:999px;
      background:#e5e7eb;
      overflow:hidden;
      display:flex;           /* 多段顏色 */
    }
    .chart-bar span{
      height:100%;
      flex:0 0 auto;
    }
    .chart-val{
      width:40px;
      text-align:right;
      color:#6b7280;
      flex-shrink:0;
    }

    /* 五大分類顏色 */
    .seg-story{ background:#3b82f6; }   /* 藍 */
    .seg-music{ background:#22c55e; }   /* 綠 */
    .seg-movie{ background:#a855f7; }   /* 紫 */
    .seg-news{  background:#f97316; }   /* 橘 */
    .seg-pro{   background:#ec4899; }   /* 粉 */

    .badge-status{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid #c7d2fe;
      background:#e0edff;
      color:#1e3a8a;
    }
  </style>
</head>
<body>
<div class="wrap">
  <header class="nav">
    <button class="back" onclick="window.location.href='../index.html'">
      <span>←</span><span>回首頁</span>
    </button>
    <div style="display:flex;align-items:center;gap:6px;">
      <div id="userPill" class="user-pill" style="display:none;">
        <small>已登入</small><span id="userEmail"></span>
      </div>
      <button id="logoutBtn" class="logout-btn" style="display:none;">登出</button>
    </div>
  </header>

  <main>
    <h1>學習控制台</h1>

    <div class="layout">
      <!-- 左側：主要區塊 -->
      <div style="display:flex;flex-direction:column;gap:18px;">
        <!-- 繼續播放 -->
        <section class="card">
          <div class="card-title">
            <h2>繼續播放</h2>
            <span id="continueStatus" class="badge-status">未完成</span>
          </div>
          <div id="continueBox" class="continue-box">
            <div class="empty-tip">載入中...</div>
          </div>
          <button class="btn-primary" id="btnResume">從上次進度繼續</button>
        </section>

        <!-- 最近看過 -->
        <section class="card">
          <div class="card-title">
            <h2>最近看過</h2>
            <span class="tag">最近 10 筆紀錄</span>
          </div>
          <ul id="recentList" class="recent-list">
            <li class="empty-tip">載入中...</li>
          </ul>
        </section>

        <!-- 學習曲線 -->
        <section class="card">
          <div class="card-title">
            <h2>學習曲線（最近 30 天）</h2>
            <span class="tag blue">以完成度統計</span>
          </div>
          <div id="chartArea" class="chart-wrap">
            <div class="empty-tip">載入中...</div>
          </div>
        </section>
      </div>

      <!-- 右側：今日複習 / 我的清單 -->
      <div class="grid-small">
        <section class="card">
          <div class="card-title">
            <h2>今日複習</h2>
            <span class="tag">系統推薦</span>
          </div>
          <div id="reviewList">
            <div class="empty-tip">載入中...</div>
          </div>
        </section>

        <!-- 先隱藏「我的清單」 -->
        <section class="card" style="display:none;">
          <div class="card-title">
            <h2>我的清單</h2>
            <span class="tag">收藏影片</span>
          </div>
          <div id="favoriteList" class="empty-tip">載入中...</div>
        </section>
      </div>
    </div>
  </main>
</div>

<!-- Supabase JS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script>
  const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ▶ 前台影片索引（index-all.json）做為唯一真相
  const VIDEO_INDEX_URL = "../data/index-all.json";
  let videoIndexMap = {};

  async function loadVideoIndex(){
    if(Object.keys(videoIndexMap).length) return; // 已載入過
    try{
      const res = await fetch(VIDEO_INDEX_URL + "?v=20251124");
      if(!res.ok) throw new Error("index-all.json 載入失敗");
      const list = await res.json();
      videoIndexMap = {};
      (list || []).forEach(v => {
        if(!v.slug) return;
        videoIndexMap[v.slug] = v;
      });
    }catch(err){
      console.error("loadVideoIndex error", err);
      videoIndexMap = {};
    }
  }

  function metaFromIndex(slug){
    const idx = videoIndexMap[slug] || {};
    const cat = idx.category || "story";
    const title = idx.title || slug || "未命名影片";
    const cover_path = idx.cover_path || `assets/${cat}/${slug}.jpg`;
    return { cat, title, cover_path };
  }

  function storageUrl(path){
    if(!path) return "";
    if(/^https?:\/\//.test(path)) return path;
    return `${SUPABASE_URL}/storage/v1/object/public/${path}`;
  }

  function formatTime(ts){
    if(!ts) return "";
    const d = new Date(ts);
    if(isNaN(d.getTime())) return "";
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    return `${y}/${m}/${day} ${hh}:${mm}`;
  }

  // 統一跳轉到 player.html
  function jumpToVideo(cat, slug, resume){
    if(!cat || !slug) return;
    const qResume = resume ? "&resume=1" : "";
    const url = `../player.html?cat=${encodeURIComponent(cat)}&slug=${encodeURIComponent(slug)}${qResume}`;
    window.location.href = url;
  }

  // 針對「列表項目」做事件委派
  document.addEventListener("click", (e) => {
    const el = e.target.closest('[data-jump="video"]');
    if(!el) return;
    const cat = el.getAttribute("data-cat");
    const slug = el.getAttribute("data-slug");
    jumpToVideo(cat, slug, true);
  });

  /* ---------- 渲染區 ---------- */
  function renderContinue(item){
    const box = document.getElementById("continueBox");
    const status = document.getElementById("continueStatus");

    if(!item){
      box.innerHTML = `<div class="empty-tip">目前沒有未完成的影片。</div>`;
      status.textContent = "尚無紀錄";
      return;
    }

    const pct = Math.max(0, Math.min(100, Math.round(item.progress_pct || 0)));
    const cover = item.cover_path ? storageUrl(item.cover_path) : "";
    const title = item.title || item.video_title || item.video_slug || item.slug || "未命名影片";
    const updated = formatTime(item.updated_at);
    const cat = item.category || item.video_category || "story";
    const slug = item.video_slug || item.slug || "";

    box.innerHTML = `
      <div class="thumb">
        ${cover ? `<img src="${cover}" alt="${title}">` : ""}
      </div>
      <div class="cont-meta">
        <div class="title">${title}</div>
        <div class="sub">
          上次進度 ${pct}%　${updated ? `更新：${updated}` : ""}
        </div>
        <div class="progress-wrap">
          <div class="bar"><span style="width:${pct}%;"></span></div>
          <span>${pct}%</span>
        </div>
      </div>
    `;

    status.textContent = pct >= 100 ? "已完成" : "未完成";

    const btn = document.getElementById("btnResume");
    btn.onclick = () => {
      jumpToVideo(cat, slug, true);
    };
  }

  function renderRecent(list){
    const ul = document.getElementById("recentList");
    if(!list.length){
      ul.innerHTML = `<li class="empty-tip">尚未產生觀看紀錄。</li>`;
      return;
    }

    ul.innerHTML = list.slice(0,10).map(v => {
      const pct = Math.max(0, Math.min(100, Math.round(v.progress_pct || 0)));
      const title = v.title || v.video_title || v.video_slug || v.slug || "未命名影片";
      const updated = formatTime(v.updated_at);
      const cat = v.category || v.video_category || "story";
      const slug = v.video_slug || v.slug || "";
      return `
        <li class="recent-item" data-jump="video" data-cat="${cat}" data-slug="${slug}">
          <div class="recent-left">
            <div class="dot">影片</div>
            <div class="recent-title">${title}</div>
          </div>
          <div class="recent-meta">
            ${pct ? `進度 ${pct}%` : ""}${pct && updated ? " · " : ""}${updated || ""}
          </div>
        </li>
      `;
    }).join("");
  }

  function renderFavorites(list){
    const box = document.getElementById("favoriteList");
    if(!list.length){
      box.className = "empty-tip";
      box.textContent = "尚未收藏任何影片。";
      return;
    }
    box.className = "";
    box.innerHTML = list.map(v => {
      const cover = v.cover_path ? storageUrl(v.cover_path) : "";
      const title = v.title || v.video_title || v.slug || v.video_slug || "未命名影片";
      const cat = v.category || v.video_category || "story";
      const slug = v.slug || v.video_slug || "";
      return `
        <div class="review-item" data-jump="video" data-cat="${cat}" data-slug="${slug}">
          <div class="review-thumb">
            ${cover ? `<img src="${cover}" alt="${title}">` : ""}
          </div>
          <div class="review-info">
            <div>${title}</div>
            <small>${cat}</small>
          </div>
        </div>
      `;
    }).join("");
  }

  function renderReview(list){
    const box = document.getElementById("reviewList");
    if(!list.length){
      box.innerHTML = `<div class="empty-tip">今天暫無推薦影片。</div>`;
      return;
    }
    box.innerHTML = list.slice(0,3).map(v => {
      const cover = v.cover_path ? storageUrl(v.cover_path) : "";
      const title = v.title || v.video_title || v.slug || v.video_slug || "未命名影片";
      const cat = v.category || v.video_category || "story";
      const slug = v.video_slug || v.slug || "";
      return `
        <div class="review-item" data-jump="video" data-cat="${cat}" data-slug="${slug}">
          <div class="review-thumb">
            ${cover ? `<img src="${cover}" alt="${title}">` : ""}
          </div>
          <div class="review-info">
            <div>${title}</div>
            <small>${cat}</small>
          </div>
        </div>
      `;
    }).join("");
  }

  // 新版：30 天 + 五分類顏色
  function renderCurve(curve){
    const area = document.getElementById("chartArea");
    if(!curve.length){
      area.innerHTML = `<div class="empty-tip">尚無足夠資料繪製曲線。</div>`;
      return;
    }

    const cats = ["story","music","movie","news","pro"];
    const catClass = {
      story:"seg-story",
      music:"seg-music",
      movie:"seg-movie",
      news:"seg-news",
      pro:"seg-pro"
    };

    area.innerHTML = curve.map(d => {
      const segments = cats
        .filter(cat => d.cats[cat] > 0)
        .map(cat => {
          const val = d.cats[cat];
          const cls = catClass[cat] || "";
          return `<span class="${cls}" style="flex:${val};"></span>`;
        }).join("");

      return `
        <div class="chart-row">
          <div class="chart-label">${d.label}</div>
          <div class="chart-bar">
            ${segments || ""}
          </div>
          <div class="chart-val">${d.overall}%</div>
        </div>
      `;
    }).join("");
  }

  /* ---------- 主要資料讀取 ---------- */
  async function loadDashboard(user){
    const userEmail = user.email;
    const userId = user.id;

    // 1) 先載入前台影片清單（含 category / slug / title）
    await loadVideoIndex();

    // 2) watch_logs：只拿 slug + 進度 + 時間，其他由 index-all.json 補
    const { data: logs, error: lErr } = await supabase
      .from("watch_logs")
      .select("*")
      .eq("email", userEmail)
      .order("updated_at", { ascending:false });

    if(lErr){
      console.error("watch_logs error", lErr);
    }

    const logsFilled = (logs || [])
      .map(row => {
        const slug = row.video_slug || row.slug;
        if(!slug) return null;
        const idx = videoIndexMap[slug];
        if(!idx) return null; // 沒在 index-all.json 裡就當作無效紀錄
        const meta = metaFromIndex(slug);
        return {
          ...row,
          slug,
          video_slug: slug,
          category: meta.cat,
          video_category: meta.cat,
          title: meta.title,
          video_title: meta.title,
          cover_path: meta.cover_path
        };
      })
      .filter(Boolean);

    // 3) favorites：同樣用 slug 去對 index-all.json
    let favoritesFull = [];
    if(userId){
      const { data: favRows, error: fErr } = await supabase
        .from("favorites")
        .select("*")
        .eq("user_id", userId);
      if(fErr){
        console.error("favorites error", fErr);
      }
      favoritesFull = (favRows || [])
        .map(f => {
          const slug = f.video_slug || f.slug;
          if(!slug) return null;
          const idx = videoIndexMap[slug];
          if(!idx) return null;
          const meta = metaFromIndex(slug);
          return {
            slug,
            video_slug: slug,
            category: meta.cat,
            video_category: meta.cat,
            title: meta.title,
            video_title: meta.title,
            cover_path: meta.cover_path
          };
        })
        .filter(Boolean);

      // 去重複
      const favMap = new Map();
      favoritesFull.forEach(v => {
        const key = v.slug;
        if(!favMap.has(key)) favMap.set(key, v);
      });
      favoritesFull = Array.from(favMap.values());
    }

    // 今日複習：未完成的片子
    const todayReview = logsFilled.filter(r => (r.progress_pct || 0) < 100);

    // 繼續播放：優先未完成，沒有就最後一筆
    let continueItem = null;
    if(logsFilled.length){
      const incomplete = logsFilled.filter(r => (r.progress_pct || 0) < 100);
      continueItem = incomplete[0] || logsFilled[0] || null;
    }

    const recent = logsFilled.slice(0,10);

    // 學習曲線：最近 30 天
    const now = new Date();
    const curve = [];
    const cats = ["story","music","movie","news","pro"];

    for(let i=29;i>=0;i--){
      const d = new Date(now.getTime() - i*24*60*60*1000);
      const key = d.toISOString().slice(0,10);

      const dayLogs = logsFilled.filter(r => {
        const u = (r.updated_at || "").toString();
        return u.startsWith(key);
      });

      const overall = dayLogs.length
        ? Math.round(
            dayLogs.reduce((a,c)=>a+(c.progress_pct||0),0)/dayLogs.length
          )
        : 0;

      const byCat = {};
      cats.forEach(cat => {
        const list = dayLogs.filter(r => (r.video_category || r.category) === cat);
        const avg = list.length
          ? Math.round(
              list.reduce((a,c)=>a+(c.progress_pct||0),0)/list.length
            )
          : 0;
        byCat[cat] = Math.max(0, Math.min(100, avg));
      });

      const label =
        i===0 ? "今天" :
        i===1 ? "昨天" :
        `${d.getMonth()+1}/${d.getDate()}`;

      curve.push({
        label,
        overall: Math.max(0, Math.min(100, overall)),
        cats: byCat
      });
    }

    renderContinue(continueItem);
    renderRecent(recent);
    renderFavorites(favoritesFull);
    renderReview(todayReview);
    renderCurve(curve);
  }

  async function init(){
    const { data, error } = await supabase.auth.getUser();
    if(error || !data.user){
      window.location.href = "../login.html";
      return;
    }

    const user = data.user;
    document.getElementById("userEmail").textContent = user.email || "";
    document.getElementById("userPill").style.display = "flex";

    const logoutBtn = document.getElementById("logoutBtn");
    logoutBtn.style.display = "inline-block";
    logoutBtn.onclick = async () => {
      await supabase.auth.signOut();
      window.location.href = "../login.html";
    };

    loadDashboard(user);
  }

  init();
</script>
</body>
</html>




























































