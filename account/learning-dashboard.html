<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>學習控制台｜BookWide</title>

<link rel="stylesheet" href="../css/dashboard.css" />

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<style>
/* 你的 CSS 保留，我只補排行榜區塊顏色 */
.rank-score { color:#2563eb; font-weight:600; }
</style>
</head>

<body>
<div id="app" class="wrap">

    <!-- ------------------------------------------------------
        ① 上次播放 / 最近觀看 / 今日複習（保持原樣）
    ------------------------------------------------------- -->

    <section id="continue-section">
        <!--（你的原始內容，我完全沒動）-->
    </section>

    <section id="recent-section">
        <!--（你的原始內容，我完全沒動）-->
    </section>

    <section id="today-section">
        <!--（你的原始內容，我完全沒動）-->
    </section>

    <!-- ------------------------------------------------------
        ② ⭐ 金榜排行榜（最近 30 天）
        —— 此區塊為你要求修好的排行榜
    ------------------------------------------------------- -->

    <section class="card" style="margin-top:24px;">
        <div class="card-title">
            金榜排行（最近 30 天）
            <span style="font-size:12px;color:#999;margin-left:8px">前 10 名</span>
        </div>

        <div id="rank-list"></div>
    </section>

</div>

<script>
/* ------------------------------------------------------------
    Supabase Init
------------------------------------------------------------ */
const supabase = window.supabase.createClient(
    "https://jeajrwpmrgczimmrflxo.supabase.co",
    "YOUR_ANON_KEY"
);

/* ------------------------------------------------------------
    ③ 取得排行榜資料（影片秒數 + 測驗成績）
------------------------------------------------------------ */
async function loadRanking(){

    const sql = `
WITH recent_watch AS (
    SELECT 
        wl.email,
        SUM(wl.duration_sec) AS watch_sec
    FROM public.watch_logs wl
    WHERE wl.updated_at > now() - interval '30 days'
    GROUP BY wl.email
),

recent_quiz AS (
    SELECT
        q.email,
        SUM(q.score) AS quiz_score
    FROM public.quiz_logs q
    WHERE q.created_at > now() - interval '30 days'
    GROUP BY q.email
)

SELECT
    u.id AS user_id,
    u.email,
    COALESCE(p.nickname, split_part(u.email, '@', 1)) AS display_name,

    COALESCE(rw.watch_sec, 0) AS watch_sec,
    COALESCE(rq.quiz_score, 0) AS quiz_score,

    COALESCE(rw.watch_sec, 0) * 1
      + COALESCE(rq.quiz_score, 0) * 1 AS total_score

FROM auth.users u
LEFT JOIN public.profiles p ON p.id = u.id
LEFT JOIN recent_watch rw ON rw.email = u.email
LEFT JOIN recent_quiz rq ON rq.email = u.email

WHERE u.email IS NOT NULL
ORDER BY total_score DESC
LIMIT 10;
    `;

    const { data, error } = await supabase.rpc("exec_sql", { sql });

    if(error){
        console.error(error);
        document.querySelector("#rank-list").innerHTML =
            "<div style='padding:12px;color:red;'>排行榜讀取失敗</div>";
        return;
    }

    renderRanking(data);
}

/* ------------------------------------------------------------
    ④ 排行榜渲染到畫面
------------------------------------------------------------ */
function renderRanking(rows){

    const box = document.querySelector("#rank-list");
    box.innerHTML = "";

    rows.forEach((u, i)=>{
        const item = document.createElement("div");
        item.className = "rank-item";
        item.style.cssText = `
            display:flex;justify-content:space-between;
            padding:8px 14px;border-bottom:1px solid #eee;
        `;

        item.innerHTML = `
            <div>
                <span style="margin-right:8px;color:#999;">${i+1}</span>
                ${u.display_name}
            </div>

            <div class="rank-score">
                ${u.total_score} 分
            </div>
        `;
        box.appendChild(item);
    });
}

/* ------------------------------------------------------------
    ⑤ 初始化：載入排行榜
------------------------------------------------------------ */
loadRanking();

</script>
</body>
</html>




























































































































































