<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>學習控制台 | BookWide</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --primary:#2563eb;
      --chip:#e5edff;
      --border:#e5e7eb;
      --shadow: 0 6px 18px rgba(0,0,0,.06);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:var(--bg);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .wrap{max-width:1128px;margin:0 auto;padding:28px 20px 80px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;
    }
    .back{
      display:inline-flex;align-items:center;gap:6px;
      font-size:14px;color:var(--primary);text-decoration:none;
      padding:6px 8px;border-radius:10px;background:#eef5ff;border:1px solid #dbe9ff;
    }
    .user{color:var(--muted);font-size:14px}
    h1{font-size:30px;margin:14px 0 22px}

    .grid{display:grid;gap:18px;grid-template-columns:1fr;align-items:start}
    @media(min-width:960px){ .grid{ grid-template-columns: 1.3fr 1fr; } }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
    }
    .card h2{font-size:20px;margin:0 0 14px;display:flex;align-items:center;gap:10px}
    .chip{
      display:inline-block; padding:.25rem .55rem; border-radius:999px;
      background:var(--chip); color:var(--primary); font-weight:600; font-size:12px;
      border:1px solid #d8e4ff;
    }

    .items{display:flex;flex-direction:column;gap:12px}
    .item{
      display:flex;gap:14px;text-decoration:none;color:inherit;
      border:1px solid var(--border); border-radius:14px; padding:10px;
      background:#fff;
      transition:transform .15s ease, box-shadow .15s ease;
    }
    .item:hover{ transform: translateY(-1px); box-shadow: 0 10px 24px rgba(0,0,0,.08); }
    .thumb{
      width:120px;height:68px;border-radius:10px;object-fit:cover;background:#f3f4f6;
      flex:0 0 auto;border:1px solid var(--border);
    }
    .meta{display:flex;flex-direction:column;justify-content:center;min-width:0}
    .title{font-size:16px;font-weight:700;display:flex;align-items:center;gap:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sub{font-size:13px;color:var(--muted);margin-top:2px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="back" href="/EduEnglish/index.html" title="回首頁">← 回首頁</a>
      <div class="user" id="userEmail">—</div>
    </div>
    <h1>學習控制台</h1>

    <div class="grid">
      <!-- 左側主欄 -->
      <div class="stack" style="display:flex;flex-direction:column;gap:18px;">
        <section class="card">
          <h2>繼續播放 <span id="continuePct" class="chip" style="display:none">未完成 0%</span></h2>
          <div id="continueBlock" class="items">
            <div class="sub">目前沒有未看完的影片。</div>
          </div>
        </section>

        <section class="card">
          <h2>最近看過</h2>
          <div id="recentBlock" class="items">
            <div class="sub">尚無觀看紀錄。</div>
          </div>
        </section>

        <section class="card">
          <h2>學習曲線（最近 7 天）</h2>
          <div class="sub">（預留，之後改為 Chart.js 線圖）</div>
        </section>
      </div>

      <!-- 右側側欄 -->
      <div class="stack" style="display:flex;flex-direction:column;gap:18px;">
        <section class="card">
          <h2>今日複習</h2>
          <div id="reviewBlock" class="items">
            <div class="sub">今日沒有到期的複習項目。</div>
          </div>
        </section>

        <section class="card">
          <h2>我的清單</h2>
          <div id="favBlock" class="items">
            <div class="sub">尚未收藏任何影片。</div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from '../supa.js';

    const elUser = document.querySelector('#userEmail');
    const elContinue = document.querySelector('#continueBlock');
    const elContinuePct = document.querySelector('#continuePct');
    const elRecent = document.querySelector('#recentBlock');
    const elFav = document.querySelector('#favBlock');
    // const elReview = document.querySelector('#reviewBlock'); // 預留

    // 友善預設（若 DB 尚未建立 video_meta，就用這組對照）
    const friendlyTitle = {
      'lesson-english-01': 'Mid-Autumn Festival',
      'lesson-english-02': 'Hou Yi and the Ten Suns',
      'lesson-english-03': 'Lantern Festival',
    };
    const friendlyThumb = {
      'lesson-english-01': 'https://images.unsplash.com/photo-1509099836639-18ba1795216d?q=80&w=1200&auto=format&fit=crop',
      'lesson-english-02': 'https://images.unsplash.com/photo-1549887534-1541e9326642?q=80&w=1200&auto=format&fit=crop',
      'lesson-english-03': 'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop',
    };

    const rel = (iso) => {
      const d = new Date(iso);
      const diff = Math.floor((Date.now() - d.getTime()) / 1000);
      if (diff < 60) return `${diff} 秒前`;
      const m = Math.floor(diff / 60);
      if (m < 60) return `${m} 分鐘前`;
      const h = Math.floor(m / 60);
      if (h < 24) return `${h} 小時前`;
      const day = Math.floor(h / 24);
      return `${day} 天前`;
    };

    const makeItem = (slug, title, pct = null, whenText = '', thumb = '') => {
      const a = document.createElement('a');
      a.className = 'item';
      a.href = \`/EduEnglish/player.html?slug=\${encodeURIComponent(slug)}\`;
      a.innerHTML = \`
        <img class="thumb" src="\${thumb || 'https://dummyimage.com/320x180/eee/aaa.jpg&text=Video'}" alt="">
        <div class="meta">
          <div class="title">
            \${title || slug}
            \${pct != null && pct > 0 ? \`<span class="chip">\${pct}%</span>\` : \`\`}
          </div>
          <div class="sub">\${whenText || ''}</div>
        </div>\`;
      return a;
    };

    // 取得登入使用者
    const { data: userRes } = await supabase.auth.getUser();
    const user = userRes?.user;
    if (!user) {
      location.href = \`/EduEnglish/login.html?next=\${encodeURIComponent(location.pathname)}\`;
    }
    elUser.textContent = user.email;

    // 把 DB 的標題/縮圖載進來（若 DB 有值就用 DB，沒有才用友善預設）
    const titleMap = { ...friendlyTitle };
    const thumbMap = { ...friendlyThumb };

    const vm = await supabase.from('video_meta').select('slug,title,thumbnail_url,active').eq('active', true);
    vm.data?.forEach(v => {
      if (v.title) titleMap[v.slug] = v.title;
      if (v.thumbnail_url) thumbMap[v.slug] = v.thumbnail_url;
    });

    // 讀 watch_logs
    const { data: logs } = await supabase
      .from('watch_logs')
      .select('video_slug, progress_pct, updated_at')
      .eq('user_id', user.id)
      .order('updated_at', { ascending: false })
      .limit(50);

    // 繼續播放：先找 1~99%，找不到就用最新一筆
    let cont = (logs || []).find(r => r.progress_pct > 0 && r.progress_pct < 100);
    if (!cont && logs?.length) cont = logs[0];

    if (cont) {
      elContinue.innerHTML = '';
      const slug = cont.video_slug;
      const title = titleMap[slug] || slug;
      const thumb = thumbMap[slug] || '';
      const pct = Math.round(cont.progress_pct);
      const when = rel(cont.updated_at);
      elContinue.appendChild(makeItem(slug, title, pct, \`上次看到：\${when}\`, thumb));
      if (pct > 0) {
        elContinuePct.textContent = \`未完成 \${pct}%\`;
        elContinuePct.style.display = 'inline-block';
      } else {
        elContinuePct.style.display = 'none';
      }
    }

    // 最近看過（前三筆）
    if (logs?.length) {
      elRecent.innerHTML = '';
      logs.slice(0, 3).forEach(r => {
        const slug = r.video_slug;
        const title = titleMap[slug] || slug;
        const thumb = thumbMap[slug] || '';
        const pct = Math.round(r.progress_pct);
        elRecent.appendChild(makeItem(slug, title, pct, \`\${rel(r.updated_at)} · 進度 \${pct}%\`, thumb));
      });
    }

    // 我的清單（favorites）
    const { data: favs } = await supabase
      .from('favorites')
      .select('video_slug, created_at')
      .eq('user_id', user.id)
      .order('created_at', { ascending: false })
      .limit(5);

    if (favs?.length) {
      elFav.innerHTML = '';
      favs.forEach(f => {
        const slug = f.video_slug;
        const title = titleMap[slug] || slug;
        const thumb = thumbMap[slug] || '';
        elFav.appendChild(makeItem(slug, title, null, \`加入：\${rel(f.created_at)}\`, thumb));
      });
    }
  </script>
</body>
</html>













