<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>å­¸ç¿’æ§åˆ¶å°ï½œBookWide</title>
  <style>
    :root{
      --bg:#f4f7fb;
      --card:#ffffff;
      --ink:#0b1220;
      --muted:#5b6b86;
      --line:rgba(10,18,32,.08);
      --brand:#1f5bff;
      --brand2:#0a3cc7;
      --ok:#16a34a;
      --warn:#f59e0b;
      --danger:#ef4444;
      --shadow:0 10px 30px rgba(12,22,45,.08);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--ink);
      background:linear-gradient(180deg,#07142f 0,#07142f 86px,var(--bg) 86px,var(--bg) 100%);
    }
    a{color:inherit}
    .topbar{
      position:sticky; top:0; z-index:50;
      background:rgba(7,20,47,.92);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .topbar .inner{
      max-width:1180px; margin:0 auto; padding:14px 16px;
      display:flex; align-items:center; gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px; min-width:220px;
      color:#fff; font-weight:800; letter-spacing:.2px;
    }
    .beta{
      font-weight:700; font-size:12px; color:#dbe7ff;
      border:1px solid rgba(219,231,255,.35);
      padding:2px 8px; border-radius:999px;
    }
    .top-actions{margin-left:auto; display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .pill{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      color:#eaf1ff;
      font-size:13px;
      background:rgba(255,255,255,.05);
    }
    .pill b{color:#fff}
    .btn{
      appearance:none; border:0; cursor:pointer;
      border-radius:999px; padding:10px 14px;
      font-weight:800; letter-spacing:.2px;
      display:inline-flex; align-items:center; gap:8px;
      box-shadow:none;
      transition: transform .06s ease, filter .12s ease, background .12s ease;
      user-select:none;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(180deg,var(--brand),var(--brand2)); color:#fff}
    .btn.ghost{background:rgba(255,255,255,.06); color:#fff; border:1px solid rgba(255,255,255,.14)}
    .wrap{max-width:1180px; margin:0 auto; padding:18px 16px 40px}
    .notice{
      margin:14px 0 18px;
      background:rgba(255,255,255,.85);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 14px;
      display:flex; gap:12px; align-items:flex-start;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
    }
    .notice .dot{width:10px;height:10px;border-radius:999px;margin-top:5px;background:var(--ok)}
    .notice .txt{font-size:13px; color:var(--muted); line-height:1.55}
    .grid{display:grid; grid-template-columns: 1.25fr .95fr; gap:18px}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow: var(--shadow);
    }
    .card .hd{
      padding:16px 16px 0;
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
    }
    .h1{font-size:28px; font-weight:900; letter-spacing:.3px; margin:0}
    .sub{margin:6px 0 0; color:var(--muted); font-size:13px}
    .badge{
      font-size:12px; font-weight:800;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line);
      color:#193152; background:#f5f8ff;
      white-space:nowrap;
    }
    .card .bd{padding:16px}
    .quick{
      display:grid; grid-template-columns: repeat(3,minmax(0,1fr));
      gap:10px;
    }
    .qbtn{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 12px;
      background:linear-gradient(180deg,#fff,#fbfdff);
      cursor:pointer;
      text-align:left;
      transition: transform .06s ease, box-shadow .12s ease;
    }
    .qbtn:hover{box-shadow:0 10px 22px rgba(12,22,45,.07)}
    .qbtn:active{transform:translateY(1px)}
    .qbtn .t{font-weight:900}
    .qbtn .d{margin-top:6px; font-size:12px; color:var(--muted); line-height:1.45}
    .split{display:grid; grid-template-columns: 1.05fr .95fr; gap:14px}
    .mini{border:1px dashed rgba(10,18,32,.18); background:rgba(10,18,32,.02); border-radius:14px; padding:12px}
    .mini .k{font-size:12px; color:var(--muted)}
    .mini .v{margin-top:4px; font-size:18px; font-weight:900}
    .list{margin:0; padding:0; list-style:none; display:flex; flex-direction:column; gap:10px}
    .row{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      display:flex; align-items:center; gap:12px;
      background:#fff;
    }
    .thumb{
      width:44px; height:44px; border-radius:12px;
      background:linear-gradient(135deg,#dbe7ff,#f0f6ff);
      display:flex; align-items:center; justify-content:center;
      font-weight:900; color:#27406b;
      flex:0 0 auto;
    }
    .row .meta{min-width:0; flex:1}
    .row .meta .title{font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .row .meta .desc{margin-top:4px; font-size:12px; color:var(--muted)}
    .row .act{flex:0 0 auto; display:flex; gap:8px}
    .row .act .btn2{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:9px 12px;
      font-weight:900;
      cursor:pointer;
    }
    .row .act .btn2.primary{border:0; color:#fff; background:linear-gradient(180deg,var(--brand),var(--brand2))}
    .smallnote{margin-top:10px; font-size:12px; color:var(--muted); line-height:1.5}
    .rightCard .bd{padding-top:10px}
    .sectionTitle{
      font-size:14px; font-weight:900; margin:0 0 10px;
      display:flex; align-items:center; justify-content:space-between; gap:8px;
    }
    .mono{font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .rank{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px; border:1px solid var(--line)}
    .rank th,.rank td{padding:10px 12px; font-size:13px; border-bottom:1px solid var(--line); text-align:left}
    .rank th{background:#f7faff; color:#223a63; font-weight:900}
    .rank tr:last-child td{border-bottom:0}
    .rank td:last-child{text-align:right; font-weight:900}
    .chartBox{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:linear-gradient(180deg,#fff,#fbfdff);
    }
    .chartFake{
      height:180px; border-radius:12px;
      background:repeating-linear-gradient(90deg, rgba(31,91,255,.08) 0, rgba(31,91,255,.08) 1px, transparent 1px, transparent 22px),
                 linear-gradient(180deg, rgba(31,91,255,.08), rgba(31,91,255,0));
    }
    .foot{
      margin-top:22px; text-align:center; color:rgba(255,255,255,.65); font-size:12px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .brand{min-width:0}
    }
    @media (max-width: 640px){
      .topbar .inner{gap:8px}
      .pill{display:none}
      .quick{grid-template-columns:1fr}
      .split{grid-template-columns:1fr}
      .h1{font-size:22px}
    }
  
/* ===== Restored Learning Curve (Chart) ===== */
.chart-wrap{
  width:100%;
  border-radius:16px;
  background:#fff;
  border:1px solid rgba(15,23,42,.08);
  padding:14px 14px 10px;
}
.day-strip{display:grid;grid-template-columns:repeat(8,minmax(0,1fr));gap:8px;margin:0 0 10px}
.day-pill{
  border:1px solid rgba(15,23,42,.12);
  background:#fff;
  border-radius:999px;
  padding:7px 6px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  line-height:1.05;
}
.day-pill .pts{font-weight:800;font-size:12px}
.day-pill .dt{font-size:11px;opacity:.7;margin-top:3px}
.chart-canvas-wrap{position:relative;height:240px}
.empty-tip{padding:18px 10px;font-size:13px;color:#64748b}
@media (min-width: 860px){
  .chart-canvas-wrap{height:260px}
}

</style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="topbar">
    <div class="inner">
      <div class="brand">BookWide <span class="beta">Beta</span></div>
      <div class="top-actions">
        <div class="pill">å·²ç™»å…¥ <b id="bwUser">â€”</b></div>
        <button class="btn ghost" id="btnHome">å›é¦–é </button>
        <button class="btn primary" id="btnContinue">å¾ä¸Šæ¬¡é€²åº¦ç¹¼çºŒ</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="notice" id="notice">
      <div class="dot" id="noticeDot"></div>
      <div class="txt" id="noticeText">å·²é€šéï¼Œé–‹å§‹å­¸ç¿’ã€‚ä½ å¯ä»¥ç›´æ¥ã€Œå¾ä¸Šæ¬¡é€²åº¦ç¹¼çºŒã€ï¼Œæˆ–å…ˆå®Œæˆã€Œä»Šæ—¥å£èªªã€ã€‚</div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="hd">
          <div>
            <h1 class="h1">å­¸ç¿’æ§åˆ¶å°</h1>
            <div class="sub" id="subline">å­¸ç¿’é€²åº¦ï¼šç¬¬ 1 é€± / å¯ç”¨è‡³ç¬¬ 4 é€±ï½œå…§å®¹åº«ï¼š54 é€±ï½œæ–¹æ¡ˆï¼šæœˆæ–¹æ¡ˆ</div>
          </div>
          <div class="badge" id="statusBadge">ç‹€æ…‹ï¼šæœ‰æ•ˆ</div>
        </div>

        <div class="bd">
          <div class="split">
            <div class="mini">
              <div class="k">ä»Šæ—¥å»ºè­°</div>
              <div class="v" id="todayPlan">å…ˆåš 1 æ¬¡å£èªªï¼Œå†çœ‹ç‰‡ 1 æ®µ</div>
              <div class="smallnote">å¦‚æœä½ ç”¨æ‰‹æ©Ÿï¼šå£èªªåŠŸèƒ½å¯èƒ½æ¯”æ¡Œæ©Ÿå—é™ï¼ˆèªéŸ³ / è‡ªå‹•æ’­æ”¾é™åˆ¶è¼ƒå¤šï¼‰ï¼Œå»ºè­°ç”¨æ¡Œæ©Ÿå®Œæˆå£èªªã€‚</div>
            </div>
            <div class="mini">
              <div class="k">æœ¬é€±ç›®æ¨™</div>
              <div class="v"><span id="weekGoal">å®Œæˆ 3 æ¬¡å£èªª</span></div>
              <div class="smallnote">é”æ¨™å¾Œï¼Œæ’è¡Œæ¦œèˆ‡åˆ†æ•¸æ›²ç·šæœƒæ›´ç©©å®šä¸Šå‡ã€‚</div>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="quick">
            <button class="qbtn" id="qTalk">
              <div class="t">ä»Šæ—¥å£èªª</div>
              <div class="d">é€²åˆ° Talk ç·´ç¿’ï¼ˆå»ºè­°æ¡Œæ©Ÿï¼‰ã€‚</div>
            </button>
            <button class="qbtn" id="qPlayer">
              <div class="t">ç€è¦½æ•™æ</div>
              <div class="d">å›åˆ°æ’­æ”¾æ¸…å–®ï¼ŒæŒ‘ä¸€æ”¯æƒ³çœ‹çš„ã€‚</div>
            </button>
            <button class="qbtn" id="qHistory">
              <div class="t">æœ€è¿‘çœ‹é</div>
              <div class="d">å¿«é€Ÿå›åˆ°æœ€è¿‘ 10 ç­†ç´€éŒ„ã€‚</div>
            </button>
          </div>

          <div style="height:14px"></div>

          <div class="sectionTitle">ç¹¼çºŒæ’­æ”¾ <span class="badge" id="continueState">æœªå®Œæˆ</span></div>
          <div class="row">
            <div class="thumb">â–¶</div>
            <div class="meta">
              <div class="title" id="continueTitle">The Mid-Autumn Festival</div>
              <div class="desc" id="continueDesc">ä¸Šæ¬¡é€²åº¦ 27%ãƒ»æ›´æ–°ï¼š<span class="mono">2026/02/04 23:13</span>ãƒ»èª²è¡¨ç¬¬ 1 é€±</div>
            </div>
            <div class="act">
              <button class="btn2 primary" id="btnResume">å¾ä¸Šæ¬¡é€²åº¦ç¹¼çºŒ</button>
            </div>
          </div>

          <div style="height:14px"></div>

          <div class="sectionTitle">ä»Šæ—¥å£èªªä»»å‹™ <span class="badge">AI Speak</span></div>
          <div class="row">
            <div class="thumb">talk</div>
            <div class="meta">
              <div class="title" id="talkTitle">Coffee Shop</div>
              <div class="desc" id="talkDesc">W1ãƒ»A1ï¼ˆå»ºè­°æ¡Œæ©Ÿæ“ä½œï¼‰</div>
            </div>
            <div class="act">
              <button class="btn2" id="btnTalk">é–‹å§‹å£èªª</button>
            </div>
          </div>

          <div style="height:14px"></div>

          <div class="sectionTitle">æœ€è¿‘çœ‹é <span class="badge" id="recentBadge">æœ€è¿‘ 10 ç­†</span></div>
          <ul class="list" id="recentList">
            <li class="row">
              <div class="thumb">ğŸ¬</div>
              <div class="meta">
                <div class="title">Going Back Home</div>
                <div class="desc">é€²åº¦ 100%ãƒ»<span class="mono">2026/02/05 13:32</span>ãƒ»ç¬¬ 1 é€±</div>
              </div>
              <div class="act"><button class="btn2" data-open="player">æ’­æ”¾</button></div>
            </li>
            <li class="row">
              <div class="thumb">ğŸ“˜</div>
              <div class="meta">
                <div class="title">The lion and the mouse</div>
                <div class="desc">é€²åº¦ 100%ãƒ»<span class="mono">2026/02/03 06:56</span>ãƒ»ç¬¬ 2 é€±</div>
              </div>
              <div class="act"><button class="btn2" data-open="player">æ’­æ”¾</button></div>
            </li>
          </ul>
          <div class="smallnote">æç¤ºï¼šå¦‚æœä½ å¸Œæœ›ã€Œç¹¼çºŒæ’­æ”¾ã€æ¯æ¬¡éƒ½æº–ç¢ºï¼Œå»ºè­°åœ¨æ’­æ”¾å™¨çœ‹å®Œå¾Œï¼Œä¿ç•™é é¢è·³è½‰ï¼ˆç³»çµ±æœƒè¨˜ä½ä¸Šæ¬¡é€²åº¦ï¼‰ã€‚</div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card rightCard">
        <div class="hd">
          <div>
            <div class="sectionTitle" style="margin:0">å­¸ç¿’æ›²ç·šï¼ˆæœ€è¿‘ 30 å¤©ï¼‰</div>
            <div class="sub">æŠ˜ç·šï¼šå®Œæˆåº¦ï½œä¸Šæ–¹åœ“åœˆï¼šç•¶æ—¥ç¸½åˆ†</div>
          </div>
          <button class="btn ghost" style="padding:9px 12px" id="btnShare">åˆ†äº«</button>
        </div>
        <div class="bd">
          <div class="chartBox">
  <div id="chartArea" class="chart-wrap">
    <div class="empty-tip" id="curveEmpty">è¼‰å…¥ä¸­â€¦</div>
  </div>
</div>

          <div style="height:14px"></div>

          <div class="sectionTitle">é‡‘æ¦œæ’è¡Œï¼ˆæœ€è¿‘ 7 å¤©ï¼‰ <span class="badge">å‰ 10 å</span></div>
          <table class="rank" aria-label="æ’è¡Œæ¦œ">
            <thead>
              <tr><th style="width:42px">#</th><th>ä½¿ç”¨è€…</th><th>åˆ†æ•¸</th></tr>
            </thead>
            <tbody>
              <tr><td class="mono">1</td><td>pmktools</td><td class="mono">44</td></tr>
              <tr><td class="mono">2</td><td>pmktools</td><td class="mono">29</td></tr>
              <tr><td class="mono">3</td><td>384246452</td><td class="mono">17</td></tr>
            </tbody>
          </table>

          <div style="height:14px"></div>

          <div class="chartBox">
            <div class="sectionTitle" style="margin:0 0 8px">ä½ å¯ä»¥å†åŠ çš„ 3 å€‹å°åŠŸèƒ½</div>
            <ol style="margin:0; padding-left:18px; color:var(--muted); font-size:13px; line-height:1.6">
              <li>ã€Œä»Šæ—¥å£èªªã€å®Œæˆå¾Œï¼šè‡ªå‹•è·³å›æ­¤é ä¸¦é¡¯ç¤ºâœ…å®Œæˆã€‚</li>
              <li>ã€Œç¹¼çºŒæ’­æ”¾ã€æŒ‰éˆ•ï¼šè®€å– localStorage çš„ lastPlayerUrlï¼ˆæˆ‘å·²åŠ å¥½ï¼Œæ’­æ”¾å™¨åªè¦å¯«å…¥å³å¯ï¼‰ã€‚</li>
              <li>åŠ å…¥ã€Œåˆ°æœŸæ—¥ã€é¡¯ç¤ºï¼šæé†’ç”¨æˆ¶çºŒè¨‚ï¼Œé™ä½åˆ°æœŸå¾Œçš„å®¢æœæˆæœ¬ã€‚</li>
            </ol>
          </div>
        </div>
      </div>
    </div>

    <div class="foot">Â© BookWide</div>
  </div>

  <script>
    // ========= åªåšã€Œä¸ç ´å£æ—¢æœ‰ã€çš„å‰ç«¯å„ªåŒ– =========
    // - å¦‚æœä½ å¾ŒçºŒæŠŠ Supabase / é€²åº¦è³‡æ–™æ¥å›ä¾†ï¼Œé€™æ®µä¹Ÿèƒ½å…±å­˜
    (function(){
      const $ = (s)=>document.querySelector(s);

      // 1) ä½¿ç”¨è€…é¡¯ç¤ºï¼ˆå„ªå…ˆ localStorage / URL åƒæ•¸ï¼‰
      const params = new URLSearchParams(location.search);
      const user = params.get("email") || localStorage.getItem("BW_EMAIL") || localStorage.getItem("bw_email") || "â€”";
      $("#bwUser").textContent = user;

      // 2) Quick actionsï¼šç›¡é‡ç”¨ä½ ç¾æœ‰çš„è·¯å¾‘ï¼ˆæ‰¾ä¸åˆ°å°±é€€å›ï¼‰
      const PATH = {
        home: "/index.html",
        player: "/player.html",
        talk: "/talk.html",
      };

      // ä½ ç¾æœ‰æ’­æ”¾å™¨è‹¥é¡˜æ„é…åˆï¼Œåªè¦åœ¨é›¢é–‹æ’­æ”¾å™¨å‰å¯«å…¥ï¼š
      // localStorage.setItem("BW_LAST_PLAYER_URL", location.href);
      // localStorage.setItem("BW_LAST_TITLE", "<ç‰‡å>");
      const lastUrl = localStorage.getItem("BW_LAST_PLAYER_URL") || localStorage.getItem("bw_last_player_url");
      const lastTitle = localStorage.getItem("BW_LAST_TITLE") || localStorage.getItem("bw_last_title");
      if(lastTitle) $("#continueTitle").textContent = lastTitle;
      if(lastUrl){
        $("#continueDesc").insertAdjacentHTML("beforeend", 'ãƒ»å·²è¨˜ä½ä¸Šæ¬¡æ’­æ”¾');
      }else{
        $("#continueDesc").insertAdjacentHTML("beforeend", 'ãƒ»å°šæœªå»ºç«‹ã€Œä¸Šæ¬¡æ’­æ”¾ã€ç´€éŒ„');
      }

      function go(url){ location.href = url; }

      $("#btnHome").onclick = ()=>go(PATH.home);
      $("#qPlayer").onclick = ()=>go(PATH.player);
      $("#qTalk").onclick = ()=>go(PATH.talk);
      $("#btnTalk").onclick = ()=>go(PATH.talk);
      $("#qHistory").onclick = ()=>document.getElementById("recentList")?.scrollIntoView({behavior:"smooth", block:"start"});
      $("#btnContinue").onclick = ()=>go(lastUrl || PATH.player);
      $("#btnResume").onclick = ()=>go(lastUrl || PATH.player);

      // recent row buttons
      document.querySelectorAll('[data-open="player"]').forEach(btn=>{
        btn.addEventListener("click", ()=>go(PATH.player));
      });

      // 3) åˆ†äº«ï¼šè¤‡è£½ç¶²å€
      $("#btnShare").onclick = async ()=>{
        try{
          await navigator.clipboard.writeText(location.href);
          toast("å·²è¤‡è£½é€£çµ");
        }catch(e){
          toast("ç„¡æ³•è¤‡è£½ï¼ˆè«‹æ‰‹å‹•è¤‡è£½ç¶²å€ï¼‰");
        }
      };

      // 4) å°å‹ toast
      let tmr;
      function toast(msg){
        clearTimeout(tmr);
        let el = document.getElementById("bwToast");
        if(!el){
          el = document.createElement("div");
          el.id="bwToast";
          el.style.cssText = "position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(7,20,47,.92);color:#fff;padding:10px 14px;border-radius:999px;font-weight:900;letter-spacing:.2px;box-shadow:0 12px 30px rgba(0,0,0,.18);z-index:9999;font-size:13px;opacity:0;transition:opacity .15s ease;";
          document.body.appendChild(el);
        }
        el.textContent = msg;
        el.style.opacity = "1";
        tmr = setTimeout(()=>{ el.style.opacity="0"; }, 1400);
      }
    })();
  </script>

<script>
/* ===== Learning curve: restore real data (watch_logs + quiz_logs) ===== */
(function(){
  const SUPABASE_URL = 'https://jeajrwpmrgczimmrflxo.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do';

  const chartArea = document.getElementById('chartArea');
  const curveEmpty = document.getElementById('curveEmpty');

  if (!window.supabase || !window.Chart || !chartArea) return;

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true, autoRefreshToken: true }
  });

  const CATS = [
    { key:'story', label:'æ•…äº‹ Story' },
    { key:'music', label:'éŸ³æ¨‚ Music' },
    { key:'movie', label:'é›»å½± Movie' },
    { key:'news',  label:'æ–°è News' },
    { key:'pro',   label:'å°ˆæ¥­ Pro' },
  ];

  function ymd(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const da = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${da}`;
  }
  function md(d){
    return `${d.getMonth()+1}/${d.getDate()}`;
  }
  function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

  function normCat(v){
    const s = (v||'').toString().toLowerCase();
    if (!s) return 'story';
    if (s.includes('stor')) return 'story';
    if (s.includes('music')) return 'music';
    if (s.includes('mov')) return 'movie';
    if (s.includes('news')) return 'news';
    if (s.includes('pro')) return 'pro';
    return 'story';
  }

  function renderCurve(days, seriesByCat, scoreByDay){
    chartArea.innerHTML = '';

    // day strip (scores)
    const strip = document.createElement('div');
    strip.className = 'day-strip';
    const last8 = days.slice(-8);

    for (const day of last8){
      const pill = document.createElement('div');
      pill.className = 'day-pill';
      const pts = document.createElement('div');
      pts.className = 'pts';
      const dt = document.createElement('div');
      dt.className = 'dt';

      const key = ymd(day);
      const sc = scoreByDay.get(key) || 0;

      pts.textContent = sc;
      dt.textContent = md(day);
      pill.appendChild(pts);
      pill.appendChild(dt);
      strip.appendChild(pill);
    }
    chartArea.appendChild(strip);

    // chart
    const wrap = document.createElement('div');
    wrap.className = 'chart-canvas-wrap';
    const canvas = document.createElement('canvas');
    wrap.appendChild(canvas);
    chartArea.appendChild(wrap);

    const labels = days.map(md);

    const datasets = CATS.map((c) => ({
      label: c.label,
      data: seriesByCat.get(c.key) || days.map(()=>0),
      tension: 0.25,
      borderWidth: 2,
      pointRadius: 0,
      spanGaps: true,
    }));

    new Chart(canvas.getContext('2d'), {
      type: 'line',
      data: { labels, datasets },
      options: {
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            ticks: { callback: (v)=> v + '%' }
          }
        }
      }
    });
  }

  async function loadCurve(){
    try{
      const { data: userRes } = await sb.auth.getUser();
      const user = userRes?.user;
      if (!user){
        if (curveEmpty) curveEmpty.textContent = 'å°šæœªç™»å…¥ã€‚';
        return;
      }

      const now = new Date();
      const start = new Date(now);
      start.setDate(start.getDate() - 29);
      start.setHours(0,0,0,0);

      const startISO = start.toISOString();

      // days list
      const days = [];
      for (let i=0;i<30;i++){
        const d = new Date(start);
        d.setDate(start.getDate()+i);
        days.push(d);
      }
      const dayIndex = new Map(days.map((d,i)=>[ymd(d), i]));

      // init
      const seriesByCat = new Map();
      for (const c of CATS){
        seriesByCat.set(c.key, new Array(days.length).fill(0));
      }
      const scoreByDay = new Map();

      // watch logs
      // try best-effort fields: updated_at, progress_pct, completion_pct, percent, video_category/category
      const wl = await sb
        .from('watch_logs')
        .select('updated_at,progress_pct,completion_pct,percent,video_category,category')
        .eq('user_id', user.id)
        .gte('updated_at', startISO);

      const watchRows = wl.data || [];
      for (const r of watchRows){
        const dt = new Date(r.updated_at);
        const key = ymd(dt);
        const idx = dayIndex.get(key);
        if (idx == null) continue;

        const cat = normCat(r.video_category || r.category);
        const arr = seriesByCat.get(cat) || seriesByCat.get('story');

        const pRaw = (r.progress_pct ?? r.completion_pct ?? r.percent ?? 0);
        const p = clamp(Number(pRaw)||0, 0, 100);

        // use max for that day & cat
        arr[idx] = Math.max(arr[idx] || 0, p);
      }

      // quiz logs (scores)
      const ql = await sb
        .from('quiz_logs')
        .select('created_at,score')
        .eq('user_id', user.id)
        .gte('created_at', startISO);

      const quizRows = ql.data || [];
      for (const r of quizRows){
        const dt = new Date(r.created_at);
        const key = ymd(dt);
        const s = Number(r.score)||0;
        scoreByDay.set(key, (scoreByDay.get(key)||0) + s);
      }

      // If nothing at all
      const anyProgress = [...seriesByCat.values()].some(arr => arr.some(v => (v||0) > 0));
      const anyScore = [...scoreByDay.values()].some(v => v > 0);
      if (!anyProgress && !anyScore){
        chartArea.innerHTML = '<div class="empty-tip">æœ€è¿‘ 30 å¤©é‚„æ²’æœ‰å­¸ç¿’ç´€éŒ„ã€‚å…ˆå¾ã€Œå¾ä¸Šæ¬¡é€²åº¦ç¹¼çºŒã€é–‹å§‹å§ï¼</div>';
        return;
      }

      renderCurve(days, seriesByCat, scoreByDay);
    }catch(err){
      console.error(err);
      if (curveEmpty) curveEmpty.textContent = 'å­¸ç¿’æ›²ç·šè¼‰å…¥å¤±æ•—ï¼ˆè«‹çœ‹ Consoleï¼‰ã€‚';
    }
  }

  // run
  loadCurve();
})();
</script>

</body>
</html>
