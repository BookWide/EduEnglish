<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>å­¸ç¿’æ§åˆ¶å° Â· BookWide</title>
  <meta name="description" content="BookWide å­¸ç¿’æ§åˆ¶å°ï¼šç¹¼çºŒæ’­æ”¾ã€æœ€è¿‘çœ‹éã€ä»Šæ—¥è¤‡ç¿’èˆ‡å­¸ç¿’æ›²ç·šã€‚"/>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <style>
    :root{
      --ink:#0a0f1a; --muted:#667085; --border:#e5e7eb; --card:#ffffff; --bg:#fafafa;
      --primary:#0b53ff;
    }
    *{box-sizing:border-box} html,body{height:100%;margin:0;font-family:ui-sans-serif,system-ui,"Noto Sans TC",Arial}
    body{background:var(--bg);color:var(--ink)}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:18px 16px}
    .h1{font-size:26px;font-weight:800;margin:4px 0 14px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .card h3{margin:0 0 8px;font-size:18px}
    .list .item{display:block;padding:10px 10px;border:1px solid var(--border);border-radius:10px;margin:8px 0;background:#fff}
    .list .item:hover{background:#f8fbff;border-color:#cfe0ff}
    .title{font-weight:700}
    .meta{color:var(--muted);font-size:12px;margin-top:4px}
    .pill{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#334155;border:1px solid #dbe4ff}
    .empty{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .chart-wrap{background:#fff;border:1px solid var(--border);border-radius:14px;padding:12px}
    @media (max-width:860px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <main class="wrap">
    <div class="h1">å­¸ç¿’æ§åˆ¶å°</div>

    <div class="grid">
      <!-- ç¹¼çºŒæ’­æ”¾ -->
      <section class="card">
        <div class="row">
          <h3>ç¹¼çºŒæ’­æ”¾</h3>
          <span class="pill">æœªå®Œæˆ &lt; 90%</span>
        </div>
        <div id="continueBox" class="list">è¼‰å…¥ä¸­â€¦</div>
      </section>

      <!-- ä»Šæ—¥è¤‡ç¿’ï¼šåˆ°æœŸæ¸…å–®ï¼ˆè‹¥ç„¡è³‡æ–™/æœªå»ºè¡¨ï¼Œé¡¯ç¤ºç©ºç‹€æ…‹ï¼‰ -->
      <section class="card">
        <div class="row">
          <h3>ä»Šæ—¥è¤‡ç¿’</h3>
          <span class="pill">åˆ°æœŸæ¸…å–®</span>
        </div>
        <div id="reviewBox" class="list empty">è¼‰å…¥ä¸­â€¦</div>
      </section>

      <!-- æœ€è¿‘çœ‹é -->
      <section class="card">
        <h3>æœ€è¿‘çœ‹é</h3>
        <div id="recentBox" class="list">è¼‰å…¥ä¸­â€¦</div>
      </section>

      <!-- æˆ‘çš„æ¸…å–®ï¼šfavoritesï¼ˆè‹¥æœªå»ºè¡¨äº¦é¡¯ç¤ºç©ºï¼‰ -->
      <section class="card">
        <div class="row">
          <h3>æˆ‘çš„æ¸…å–®</h3>
          <span class="pill">æ”¶è—</span>
        </div>
        <div id="favBox" class="list empty">è¼‰å…¥ä¸­â€¦</div>
      </section>
    </div>

    <!-- å­¸ç¿’æ›²ç·š -->
    <section style="margin-top:14px">
      <div class="chart-wrap">
        <h3 style="margin:0 0 8px">å­¸ç¿’æ›²ç·šï¼ˆæœ€è¿‘ 7 å¤©ï¼‰</h3>
        <canvas id="learningChart" height="160"></canvas>
      </div>
    </section>
  </main>

  <!-- Chart.jsï¼ˆåªç”¨æ–¼å­¸ç¿’æ›²ç·šï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- ä¸»ç¨‹å¼ï¼šè®€ watch_logs / review_tasks / favoritesï¼Œæ¸²æŸ“å››å€å¡Š -->
  <script type="module">
    // âœ… è·¯å¾‘é‡é»ï¼šlearning-dashboard.html åœ¨ /account/ åº•ä¸‹ï¼Œæ‰€ä»¥ supa.js ç”¨ ././
    import { supabase } from '././supa.js';

    const $=(s,e=document)=>e.querySelector(s);
    const continueBox=$('#continueBox'), recentBox=$('#recentBox'), favBox=$('#favBox'), reviewBox=$('#reviewBox');
    const chartEl=$('#learningChart');

    const pct = x => Math.round((x||0)*100);
    const ago = iso => {
      const d=new Date(iso), diff=(Date.now()-d.getTime())/1000;
      if(diff<60) return 'å‰›å‰›';
      if(diff<3600) return Math.floor(diff/60)+' åˆ†é˜å‰';
      if(diff<86400) return Math.floor(diff/3600)+' å°æ™‚å‰';
      return Math.floor(diff/86400)+' å¤©å‰';
    };
    const todayIso = () => new Date().toISOString().split('T')[0];

    // å°è£ï¼šç›®å‰ç™»å…¥è€…
    async function me(){
      const { data, error } = await supabase.auth.getUser();
      if(error || !data?.user) return null;
      return data.user;
    }

    // 1) ç¹¼çºŒæ’­æ”¾ï¼šprogress_pct < 0.9ï¼ˆæœªå®Œæˆï¼‰
    async function loadContinue(){
      const user = await me();
      if(!user){ continueBox.innerHTML='<div class="empty">è«‹å…ˆç™»å…¥</div>'; return; }

      const { data, error } = await supabase
        .from('watch_logs')
        .select('video_slug, progress_pct, updated_at, position_sec, duration_sec')
        .eq('user_id', user.id)
        .lt('progress_pct', 0.9)
        .order('updated_at', { ascending:false })
        .limit(8);

      if(error){ continueBox.innerHTML='<div class="empty">è®€å–å¤±æ•—</div>'; return; }
      if(!data?.length){ continueBox.innerHTML='<div class="empty">ç›®å‰æ²’æœ‰æœªçœ‹å®Œçš„å½±ç‰‡ã€‚</div>'; return; }

      continueBox.innerHTML = data.map(r=>{
        const slug = r.video_slug || r.slug || '';
        const href = `./player.html?slug=${encodeURIComponent(slug)}`;
        return `<a class="item" href="${href}">
          <div class="title">${slug||'(æœªå‘½å)'}</div>
          <div class="meta">å·²çœ‹ ${pct(r.progress_pct)}% Â· ${ago(r.updated_at)}</div>
        </a>`;
      }).join('');
    }

    // 2) æœ€è¿‘çœ‹éï¼šæœ€æ–° 10 ç­†
    async function loadRecent(){
      const user = await me();
      if(!user){ recentBox.innerHTML='<div class="empty">è«‹å…ˆç™»å…¥</div>'; return; }

      const { data, error } = await supabase
        .from('watch_logs')
        .select('video_slug, progress_pct, updated_at')
        .eq('user_id', user.id)
        .order('updated_at', { ascending:false })
        .limit(10);

      if(error){ recentBox.innerHTML='<div class="empty">è®€å–å¤±æ•—</div>'; return; }
      if(!data?.length){ recentBox.innerHTML='<div class="empty">å°šç„¡è§€çœ‹ç´€éŒ„ã€‚</div>'; return; }

      recentBox.innerHTML = data.map(r=>{
        const slug = r.video_slug || r.slug || '';
        const href = `./player.html?slug=${encodeURIComponent(slug)}`;
        return `<a class="item" href="${href}">
          <div class="title">${slug||'(æœªå‘½å)'}</div>
          <div class="meta">${ago(r.updated_at)} Â· é€²åº¦ ${pct(r.progress_pct)}%</div>
        </a>`;
      }).join('');
    }

    // 3) æˆ‘çš„æ¸…å–® favoritesï¼ˆè‹¥æœªå»ºè¡¨æˆ–ç„¡è³‡æ–™ï¼Œé¡¯ç¤ºç©ºï¼‰
    async function loadFavorites(){
      const user = await me();
      if(!user){ favBox.innerHTML='<div class="empty">è«‹å…ˆç™»å…¥</div>'; return; }

      try{
        const { data, error } = await supabase
          .from('favorites')               // å»ºè­°è¡¨ï¼šfavorites(user_id uuid, video_slug text, created_at timestamptz)
          .select('video_slug, created_at')
          .eq('user_id', user.id)
          .order('created_at', { ascending:false })
          .limit(10);

        if(error){
          // è¡¨ä¸å­˜åœ¨æ™‚ï¼ŒSupabase æœƒå›å‚³ relation does not existï¼›è¦–ç‚ºæœªå•Ÿç”¨æ”¶è—åŠŸèƒ½
          favBox.innerHTML='<div class="empty">å°šæœªæ”¶è—ä»»ä½•å½±ç‰‡ã€‚</div>';
          return;
        }

        if(!data?.length){
          favBox.innerHTML='<div class="empty">å°šæœªæ”¶è—ä»»ä½•å½±ç‰‡ã€‚</div>';
          return;
        }

        favBox.innerHTML = data.map(r=>{
          const slug = r.video_slug || '';
          const href = `./player.html?slug=${encodeURIComponent(slug)}`;
          return `<a class="item" href="${href}">
            <div class="title">${slug||'(æœªå‘½å)'}</div>
            <div class="meta">æ”¶è—æ–¼ ${new Date(r.created_at).toLocaleDateString()}</div>
          </a>`;
        }).join('');
      }catch(_e){
        favBox.innerHTML='<div class="empty">å°šæœªæ”¶è—ä»»ä½•å½±ç‰‡ã€‚</div>';
      }
    }

    // 4) ä»Šæ—¥è¤‡ç¿’ review_tasksï¼ˆè‹¥æœªå»ºè¡¨æˆ–ç„¡åˆ°æœŸè³‡æ–™ï¼Œé¡¯ç¤ºç©ºï¼‰
    async function loadReview(){
      const user = await me();
      if(!user){ reviewBox.textContent='è«‹å…ˆç™»å…¥'; reviewBox.classList.add('empty'); return; }

      try{
        // å»ºè­°è¡¨ï¼šreview_tasks(user_id uuid, title text, video_slug text, due_date date, status text)
        const { data, error } = await supabase
          .from('review_tasks')
          .select('title, video_slug, due_date, status, updated_at')
          .eq('user_id', user.id)
          .lte('due_date', todayIso())     // åˆ°ä»Šå¤©ç‚ºæ­¢è¦è¤‡ç¿’
          .neq('status','done')            // å°šæœªå®Œæˆ
          .order('due_date', { ascending:true })
          .limit(20);

        if(error){
          reviewBox.innerHTML = '<div class="empty">ä»Šæ—¥æ²’æœ‰åˆ°æœŸçš„è¤‡ç¿’é …ç›®ã€‚</div>';
          return;
        }
        if(!data?.length){
          reviewBox.innerHTML = '<div class="empty">ä»Šæ—¥æ²’æœ‰åˆ°æœŸçš„è¤‡ç¿’é …ç›®ã€‚</div>';
          return;
        }

        reviewBox.classList.remove('empty');
        reviewBox.innerHTML = data.map(r=>{
          const slug = r.video_slug || '';
          const href = slug ? `./player.html?slug=${encodeURIComponent(slug)}#review` : '#';
          const title = r.title || (slug||'(æœªå‘½å)');
          const due = new Date(r.due_date).toLocaleDateString();
          return `<a class="item" href="${href}">
            <div class="title">ğŸ§  ${title}</div>
            <div class="meta">åˆ°æœŸï¼š${due}${r.updated_at ? ' Â· æ›´æ–°æ–¼ '+ago(r.updated_at) : ''}</div>
          </a>`;
        }).join('');
      }catch(_e){
        reviewBox.innerHTML = '<div class="empty">ä»Šæ—¥æ²’æœ‰åˆ°æœŸçš„è¤‡ç¿’é …ç›®ã€‚</div>';
      }
    }

    // 5) å­¸ç¿’æ›²ç·šï¼šçµ±è¨ˆæœ€è¿‘ 7 å¤©çš„ watch_logsï¼ˆä»¥ updated_atï¼‰
    async function loadCurve(){
      const user = await me();
      if(!user || !chartEl) return;

      const { data, error } = await supabase
        .from('watch_logs')
        .select('updated_at')
        .eq('user_id', user.id)
        .order('updated_at', { ascending:true });

      if(error || !data?.length) return;

      const counts = {};
      for(const r of data){
        const day = new Date(r.updated_at).toISOString().split('T')[0];
        counts[day] = (counts[day] || 0) + 1;
      }
      const keys = Object.keys(counts).sort();
      const labels = keys.slice(-7);
      const values = labels.map(d=>counts[d]);

      new Chart(chartEl.getContext('2d'), {
        type:'line',
        data:{ labels, datasets:[{ label:'æ¯æ—¥è§€çœ‹æ¬¡æ•¸', data:values, borderColor:'#0b53ff', tension:.2, fill:false }] },
        options:{ scales:{ y:{ beginAtZero:true, ticks:{ stepSize:1 }}}}
      });
    }

    // å•Ÿå‹•
    (async function(){
      await loadContinue();
      await loadRecent();
      await loadFavorites();
      await loadReview();
      await loadCurve();
    })();
  </script>
</body>
</html>




