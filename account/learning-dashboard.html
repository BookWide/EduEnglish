<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>學習控制台｜BookWide</title>

  <style>
    :root{
      --bg:#f4f6fb;
      --card-bg:#fff;
      --muted:#6b7280;
      --border:#e5e7eb;
      --brand:#2563eb;
      --brand-soft:#e0edff;
      --danger:#b91c1c;
      --radius-lg:18px;
      --shadow-card:0 10px 30px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      background:var(--bg);
      color:#111827;
    }
    a{text-decoration:none;color:inherit;}
    img{max-width:100%;display:block;}

    .wrap{
      max-width:1080px;
      margin:32px auto 80px;
      padding:0 16px;
    }

    .nav{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:16px;
      gap:12px;
    }
    .back{
      display:inline-flex;
      align-items:center;
      gap:.5rem;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid #c7d2fe;
      background:#eef2ff;
      color:#1e40af;
      font-size:14px;
      cursor:pointer;
    }
    .back span:first-child{font-size:18px;margin-top:-2px;}

    .user-pill{
      padding:6px 12px;
      border-radius:999px;
      background:#111827;
      color:#f9fafb;
      font-size:13px;
      display:flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .user-pill small{opacity:.8;}

    h1{
      margin:0 0 18px;
      font-size:26px;
      letter-spacing:.05em;
    }

    .layout{
      display:grid;
      grid-template-columns:minmax(0,1fr) minmax(0,1fr);
      gap:18px;
      align-items:flex-start;
    }
    @media(max-width:880px){
      .layout{ grid-template-columns:minmax(0,1fr); }
    }
    .col-main,
    .col-side{
      display:flex;
      flex-direction:column;
      gap:18px;
    }
    .rank-header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom:8px;
      padding:6px 4px 0;
      font-size:13px;
      color:var(--muted);
    }
    .rank-header-left{
      min-width:0;
    }
    .rank-header-title{
      font-size:15px;
      font-weight:600;
      color:#111827;
    }
    .rank-header-sub{
      margin-top:2px;
      padding-top:2px;
      border-top:1px solid #d1d5db;
      font-size:13px;
      color:#4b5563;
    }
    .btn-share{
      padding:5px 12px;
      font-size:13px;
      border-radius:999px;
      border:1px solid #c7d2fe;
      background:#eef2ff;
      color:#1e40af;
      cursor:pointer;
      white-space:nowrap;
    }
    .btn-share:hover{
      background:#e0edff;
    }

    .card{
      background:var(--card-bg);
      border-radius:var(--radius-lg);
      padding:16px 18px;
      box-shadow:var(--shadow-card);
      border:1px solid rgba(148,163,184,.28);
    }
    .card-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .card-title h2{
      margin:0;
      font-size:16px;
    }
    .tag{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      background:#e5e7eb;
      color:#374151;
    }
    .tag.blue{
      background:var(--brand-soft);
      color:#1e40af;
    }

    /* 繼續播放 */
    .continue-box{
      display:flex;
      align-items:center;
      gap:14px;
      padding:10px 0 6px;
      min-height:72px;
    }
    .thumb{
      width:70px;
      height:70px;
      border-radius:12px;
      overflow:hidden;
      background:#e5e7eb;
      flex-shrink:0;
    }
    .thumb img{width:100%;height:100%;object-fit:cover;}
    .cont-meta{
      flex:1;
      min-width:0;
    }
    .cont-meta .title{
      font-weight:600;
      margin-bottom:4px;
      font-size:15px;
    }
    .cont-meta .sub{
      font-size:12px;
      color:var(--muted);
    }
    .progress-wrap{
      margin-top:8px;
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:var(--muted);
    }
    .bar{
      position:relative;
      flex:1;
      height:6px;
      background:#e5e7eb;
      border-radius:999px;
      overflow:hidden;
    }
    .bar span{
      position:absolute;
      inset:0;
      width:0%;
      border-radius:999px;
      background:linear-gradient(90deg,#3b82f6,#10b981);
    }

    .btn-primary{
      margin-top:10px;
      padding:6px 14px;
      font-size:13px;
      border-radius:999px;
      border:none;
      background:var(--brand);
      color:#fff;
      cursor:pointer;
    }

    /* 最近看過 */
    .recent-list{
      margin:4px 0 0;
      padding:0;
      list-style:none;
      font-size:13px;
    }
    .recent-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:4px 0;
      gap:10px;
      cursor:pointer;
    }
    .recent-left{
      display:flex;
      align-items:center;
      gap:6px;
      min-width:0;
    }
    .dot{
      width:18px;
      height:18px;
      border-radius:4px;
      background:#111827;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:10px;
      color:#f9fafb;
      flex-shrink:0;
    }
    .recent-title{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .recent-meta{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }

    /* 今日複習 & 右側區塊 */
    .grid-small{
      display:grid;
      grid-template-columns:minmax(0,1fr);
      gap:14px;
    }
    .review-item{
      display:flex;
      gap:10px;
      padding:6px 0;
      font-size:13px;
      cursor:pointer;
    }
    .review-thumb{
      width:56px;
      height:56px;
      border-radius:10px;
      overflow:hidden;
      flex-shrink:0;
      background:#e5e7eb;
    }
    .review-info small{
      display:block;
      font-size:11px;
      color:#6b7280;
    }

    .empty-tip{
      font-size:13px;
      color:var(--muted);
      padding-top:4px;
    }

    /* 日圈（含橫向捲動條） */
    .chart-wrap{
      margin-top:6px;
    }
    .day-strip{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:4px 0 8px;
      margin-bottom:4px;
      overflow-x:auto;
      border-bottom:1px solid #e5e7eb;
      scrollbar-width:thin;
    }
    .day-strip::-webkit-scrollbar{
      height:8px;
    }
    .day-strip::-webkit-scrollbar-track{
      background:#e5e7eb;
      border-radius:999px;
    }
    .day-strip::-webkit-scrollbar-thumb{
      background:#9ca3af;
      border-radius:999px;
    }
    .day-pill{
      flex:0 0 auto;
      width:40px;
      text-align:center;
      font-size:11px;
      color:#4b5563;
    }
    .day-pill-circle{
      width:32px;
      height:32px;
      margin:0 auto 2px;
      border-radius:999px;
      border:2px solid #22c55e;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:11px;
      font-weight:600;
      color:#16a34a;
      background:#f0fdf4;
    }
    .day-pill-circle.low{
      border-color:#d1d5db;
      color:#6b7280;
      background:#f9fafb;
    }
    .day-pill-circle.zero{
      border-color:#e5e7eb;
      color:#9ca3af;
      background:#f9fafb;
    }
    .day-pill-date{
      font-size:10px;
      color:#6b7280;
      white-space:nowrap;
    }
    .day-pill.today .day-pill-circle{
      border-color:#3b82f6;
      color:#1d4ed8;
      background:#eff6ff;
    }

    .chart-container{
      position:relative;
      height:220px;
    }

    .badge-status{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid #c7d2fe;
      background:#e0edff;
      color:#1e3a8a;
    }

    /* 金榜排行 */
    .rank-list{
      list-style:none;
      margin:4px 0 0;
      padding:0;
      font-size:13px;
    }
    .rank-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:4px 0;
      border-bottom:1px dashed #e5e7eb;
    }
    .rank-item:last-child{
      border-bottom:none;
    }
    .rank-no{
      width:22px;
      font-weight:700;
      color:#1f2937;
    }
    .rank-name{
      flex:1;
      min-width:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .rank-score{
      width:60px;
      text-align:right;
      font-weight:600;
      color:#2563eb;
    }
    .rank-meta{
      width:120px;
      text-align:right;
      font-size:11px;
      color:#6b7280;
    }
    .rank-me{
      background:rgba(37,99,235,.06);
      border-radius:8px;
      padding:2px 4px;
    }
    .leaderboard-scroll{
      max-height:230px;
      overflow-y:auto;
      margin-top:4px;
      padding-right:4px;
    }
  </style>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- html2canvas for screenshot share -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
<div class="wrap">
  <header class="nav">
    <button class="back" onclick="window.location.href='../index.html'">
      <span>←</span><span>回首頁</span>
    </button>
    <div style="display:flex;align-items:center;gap:6px;">
      <div id="userPill" class="user-pill" style="display:none;">
        <small>已登入</small><span id="userEmail"></span>
      </div>
      <!-- 這個頁面不需要登出按鈕，已移除 -->
    </div>
  </header>

  <main>
    <h1>學習控制台</h1>

    <div class="layout" id="dashLayout">
      <!-- 左側：繼續播放 / 最近看過 / 今日複習 -->
      <div class="col-main">
<!-- 繼續播放 -->
        <section class="card">
          <div class="card-title">
            <h2>繼續播放</h2>
            <span id="continueStatus" class="badge-status">未完成</span>
          </div>
          <div id="continueBox" class="continue-box">
            <div class="empty-tip">載入中...</div>
          </div>
          <button class="btn-primary" id="btnResume">從上次進度繼續</button>
        </section>

        
<!-- 最近看過 -->
        <section class="card">
          <div class="card-title">
            <h2>最近看過</h2>
            <span class="tag">最近 10 筆紀錄</span>
          </div>
          <ul id="recentList" class="recent-list">
            <li class="empty-tip">載入中...</li>
          </ul>
        </section>

        
<section class="card">
          <div class="card-title">
            <h2>今日複習</h2>
            <span class="tag">系統推薦</span>
          </div>
          <div id="reviewList">
            <div class="empty-tip">載入中...</div>
          </div>
        </section>

    <!-- 今日口說任務 -->
    <section class="card" id="todayTalkCard" style="margin-top:14px;">
      <div class="card-head">
        <div class="title">今日口說任務</div>
        <div class="tag" title="AI Speaking">AI Speak</div>
      </div>
      <div id="talkList" class="review-list"></div>
      <div id="talkEmpty" class="empty-tip" style="display:none;">本日尚未安排口說任務。</div>
    </section>

      </div>

      <!-- 右側：排行榜分享 / 學習曲線 / 金榜排行 -->
      <div class="col-side">
        <div class="rank-header">
          <div class="rank-header-left">
            <div class="rank-header-title">加入排行榜</div>
            <div class="rank-header-sub">
              <span id="rankHeaderText">—— 名</span>
            </div>
          </div>
          <button type="button" class="btn-share" id="btnShareRank">分享</button>
        </div>
<!-- 學習曲線 -->
        <section class="card">
          <div class="card-title">
            <h2>學習曲線（最近 30 天）</h2>
            <span class="tag blue">折線：完成度，上方圓圈：當日總分</span>
          </div>
          <div id="chartArea" class="chart-wrap">
            <div class="empty-tip">載入中...</div>
          </div>
        </section>
<section class="card">
          <div class="card-title">
            <h2>金榜排行（最近 7 天）</h2>
            <span class="tag">前 10 名</span>
          </div>
          <div id="leaderboardBox">
            <div class="empty-tip">載入中...</div>
          </div>
        </section>
      </div>
    </div>
    </div>
  </main>
</div>

<!-- Supabase JS SDK (ESM) -->
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
  const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // expose for debugging
  window.supabaseClient = supabase;
const VIDEO_INDEX_URL = "../data/index-all.json";
  const WEEKLY_INDEX_URL = "../data/weekly-index.json";
  let videoIndexMap = {};
  let WEEKLY_INDEX = null;

  function pickTodayTalkFromWeeklyIndex(weekly){
    try{
      const todayKey = new Date().toISOString().slice(0,10); // YYYY-MM-DD
      const weeks = (weekly && weekly.weeks) ? weekly.weeks : [];
      const tryExtract = (dayObj)=>{
        if(!dayObj || typeof dayObj!=="object") return null;
        const cand =
          dayObj.talk ?? dayObj.speaking ?? dayObj.ai_speaking ?? dayObj.speaking_task ??
          (dayObj.tasks ? (dayObj.tasks.talk ?? dayObj.tasks.speaking) : null);
        if(!cand) return null;
        const t = Array.isArray(cand) ? cand[0] : cand;
        if(!t) return null;

        if(typeof t === "string"){
          return { scene: t, title: "Coffee Shop Speaking", level: "A1", trial: false, cover:"" };
        }
        return {
          scene: t.scene || t.slug || t.id || t.key || "",
          title: t.title || t.name || t.label || "AI Speaking",
          level: t.level || t.cefr || t.difficulty || "",
          trial: !!(t.trial || t.is_trial || t.free || t.preview),
          cover: t.cover || t.cover_url || t.poster || t.poster_url || t.thumb || t.image || ""
        };
      };

      for(const w of weeks){
        const days = w.days ?? w.day ?? w.items ?? w.schedule ?? null;
        if(!days) continue;

        if(Array.isArray(days)){
          for(const d of days){
            const dk = d.date || d.day || d.key;
            if(dk === todayKey){
              const got = tryExtract(d);
              if(got && got.scene) return got;
            }
          }
        }else if(typeof days === "object"){
          const d = days[todayKey];
          const got = tryExtract(d);
          if(got && got.scene) return got;
        }
      }
    }catch(e){}
    return null;
  }

  function renderTodayTalk(task){
    const list = document.getElementById("talkList");
    const empty = document.getElementById("talkEmpty");
    if(!list || !empty) return;

    if(!task || !task.scene){
      list.innerHTML = "";
      empty.style.display = "";
      return;
    }
    empty.style.display = "none";

    const title = task.title || "AI Speaking";
    const level = task.level ? String(task.level) : "";
    const cover = task.cover ? String(task.cover) : "";
    const sub = level ? `${level}${task.trial ? " · 試用" : ""}` : (task.trial ? "試用" : "");

    list.innerHTML = `
      <div class="review-item" data-jump="talk" data-scene="${encodeURIComponent(task.scene)}">
        <div class="review-thumb">
          ${cover ? `<img src="${cover}" alt="">` : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-weight:800;background:#eef2ff;color:#1d4ed8;">talk</div>`}
        </div>
        <div class="review-meta">
          <div class="t">${escapeHtml(title)}</div>
          <div class="s">${escapeHtml(sub)}</div>
        </div>
      </div>
    `;
  }

  let curveChart = null;

  async function loadVideoIndex(){
    if(Object.keys(videoIndexMap).length) return;
    try{
      const res = await fetch(VIDEO_INDEX_URL + "?v=20251124");
      if(!res.ok) throw new Error("index-all.json 載入失敗");
      const list = await res.json();
      videoIndexMap = {};
      (list || []).forEach(v => {
        if(!v.slug) return;
        videoIndexMap[v.slug] = v;
      });
    }catch(err){
      console.error("loadVideoIndex error", err);
      videoIndexMap = {};
    }
  }

  function metaFromIndex(slug){
    const idx = videoIndexMap[slug] || {};
    const cat = idx.category || "story";
    const title = idx.title || slug || "未命名影片";
    const cover_path = idx.cover_path || `assets/${cat}/${slug}.jpg`;
    return { cat, title, cover_path };
  }

const PLAN_MAX_WEEKS = {
  trial: 4,
  month: 4,
  half: 27,
  half_year: 27,
  year: 54,
  annual: 54
};

const CONTENT_MAX_WEEKS = 54; // weekly-index.json 目前最多 54 週

function getUrlParams(){
  const out = {};
  try{
    const usp = new URLSearchParams(window.location.search);
    for(const [k,v] of usp.entries()){
      out[k] = v;
    }
  }catch(e){}
  return out;
}

function getSubscriptionContext(){
  const params = getUrlParams();

  // 1️⃣ 先看網址參數（方便測試：?plan=year&start=2025-01-15）
  let plan  = params.plan || params.sub_plan || null;
  let start = params.start || params.sub_start || null;

  // 2️⃣ 再看 localStorage（和首頁 index.html 共用同一組 key）
  if(!plan){
    try{ plan = localStorage.getItem("bwSubPlan") || null; }catch(e){}
  }
  if(!start){
    try{ start = localStorage.getItem("bwSubStart") || null; }catch(e){}
  }

  if(!plan || !PLAN_MAX_WEEKS[plan]){
    plan = "month";
  }

  let startDate = null;
  if(start){
    const d = new Date(start);
    if(!Number.isNaN(d.getTime())){
      startDate = d;
    }
  }

  if(!startDate){
    const today = new Date();
    startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  }

  return { plan, startDate };
}

function getWeekIndex(){
  const { plan, startDate } = getSubscriptionContext();
  const today = new Date();

  startDate.setHours(0,0,0,0);
  today.setHours(0,0,0,0);

  const diffDays = Math.floor((today.getTime() - startDate.getTime()) / 86400000);
  let weekNumber = Math.floor(diffDays / 7) + 1;

  if(weekNumber < 1) weekNumber = 1;

  const planMax = PLAN_MAX_WEEKS[plan] || 4;
  const maxWeek = Math.min(planMax, CONTENT_MAX_WEEKS);
  if(weekNumber > maxWeek) weekNumber = maxWeek;

  const weekIndex = weekNumber - 1;
  console.debug("[dashboard weekly] plan=%s start=%s weekNumber=%d index=%d",
    plan,
    startDate.toISOString().slice(0,10),
    weekNumber,
    weekIndex
  );
  return weekIndex;
}

async function loadWeeklyIndex(){
  if(WEEKLY_INDEX !== null) return;
  try{
    const res = await fetch(WEEKLY_INDEX_URL + "?v=20251124");
    if(!res.ok){
      console.warn("weekly-index.json 載入失敗，今日複習改用 watch_logs");
      WEEKLY_INDEX = null;
      return;
    }
    const data = await res.json();
    if(!data || !Array.isArray(data.weeks)){
      console.warn("weekly-index.json 格式不正確，今日複習改用 watch_logs");
      WEEKLY_INDEX = null;
      return;
    }
    WEEKLY_INDEX = data;
  }catch(e){
    console.error("loadWeeklyIndex error", e);
    WEEKLY_INDEX = null;
  }
}


  function storageUrl(path){
    if(!path) return "";
    if(/^https?:\/\//.test(path)) return path;
    return `${SUPABASE_URL}/storage/v1/object/public/${path}`;
  }

  function formatTime(ts){
    if(!ts) return "";
    const d = new Date(ts);
    if(isNaN(d.getTime())) return "";
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    return `${y}/${m}/${day} ${hh}:${mm}`;
  }

  function jumpToVideo(cat, slug, resume){
    if(!cat || !slug) return;
    const qResume = resume ? "&resume=1" : "";
    const url = `../player.html?cat=${encodeURIComponent(cat)}&slug=${encodeURIComponent(slug)}${qResume}`;
    window.location.href = url;
  }

  document.addEventListener("click", (e) => {
    const el = e.target.closest('[data-jump="video"]');
    if(!el) return;
    const cat = el.getAttribute("data-cat");
    const slug = el.getAttribute("data-slug");
    jumpToVideo(cat, slug, true);
  });

  /* ---------- 渲染區 ---------- */
  function renderContinue(item){
    const box = document.getElementById("continueBox");
    const status = document.getElementById("continueStatus");

    if(!item){
      box.innerHTML = `<div class="empty-tip">目前沒有未完成的影片。</div>`;
      status.textContent = "尚無紀錄";
      return;
    }

    const pct = Math.max(0, Math.min(100, Math.round(item.progress_pct || 0)));
    const cover = item.cover_path ? storageUrl(item.cover_path) : "";
    const title = item.title || item.video_title || item.video_slug || item.slug || "未命名影片";
    const updated = formatTime(item.updated_at);
    const cat = item.category || item.video_category || "story";
    const slug = item.video_slug || item.slug || "";

    box.innerHTML = `
      <div class="thumb">
        ${cover ? `<img src="${cover}" alt="${title}">` : ""}
      </div>
      <div class="cont-meta">
        <div class="title">${title}</div>
        <div class="sub">
          上次進度 ${pct}%　${updated ? `更新：${updated}` : ""}
        </div>
        <div class="progress-wrap">
          <div class="bar"><span style="width:${pct}%;"></span></div>
          <span>${pct}%</span>
        </div>
      </div>
    `;

    status.textContent = pct >= 100 ? "已完成" : "未完成";

    const btn = document.getElementById("btnResume");
    btn.onclick = () => {
      jumpToVideo(cat, slug, true);
    };
  }

  function renderRecent(list){
    const ul = document.getElementById("recentList");
    if(!list.length){
      ul.innerHTML = `<li class="empty-tip">尚未產生觀看紀錄。</li>`;
      return;
    }

    ul.innerHTML = list.slice(0,10).map(v => {
      const pct = Math.max(0, Math.min(100, Math.round(v.progress_pct || 0)));
      const title = v.title || v.video_title || v.video_slug || v.slug || "未命名影片";
      const updated = formatTime(v.updated_at);
      const cat = v.category || v.video_category || "story";
      const slug = v.video_slug || v.slug || "";
      return `
        <li class="recent-item" data-jump="video" data-cat="${cat}" data-slug="${slug}">
          <div class="recent-left">
            <div class="dot">影片</div>
            <div class="recent-title">${title}</div>
          </div>
          <div class="recent-meta">
            ${pct ? `進度 ${pct}%` : ""}${pct && updated ? " · " : ""}${updated || ""}
          </div>
        </li>
      `;
    }).join("");
  }

  function renderReview(list){
    const box = document.getElementById("reviewList");
    if(!list.length){
      box.innerHTML = `<div class="empty-tip">今天暫無推薦影片。</div>`;
      return;
    }
    box.innerHTML = list.slice(0,3).map(v => {
      const cover = v.cover_path ? storageUrl(v.cover_path) : "";
      const title = v.title || v.video_title || v.slug || v.video_slug || "未命名影片";
      const cat = v.category || v.video_category || "story";
      const slug = v.video_slug || v.slug || "";
      return `
        <div class="review-item" data-jump="video" data-cat="${cat}" data-slug="${slug}">
          <div class="review-thumb">
            ${cover ? `<img src="${cover}" alt="${title}">` : ""}
          </div>
          <div class="review-info">
            <div>${title}</div>
            <small>${cat}</small>
          </div>
        </div>
      `;
    }).join("");
  }

  // 學習曲線：上方日圈 + 下方 Chart.js 多分類線圖
  function renderCurve(curve){
    const area = document.getElementById("chartArea");
    if(!curve.length){
      area.innerHTML = `<div class="empty-tip">尚無足夠資料繪製曲線。</div>`;
      return;
    }

    // 日圈：顯示當日總分 totalScore
    const dayStripHtml = `
      <div class="day-strip">
        ${curve.map((d,idx)=>{
          const score = Math.round(d.totalScore || 0);
          const isToday = (idx === curve.length - 1);
          let circleClass = "";
          if(score === 0) circleClass = " zero";
          else if(score < 40) circleClass = " low";
          const classes = "day-pill" + (isToday ? " today" : "");
          return `
            <div class="${classes}">
              <div class="day-pill-circle${circleClass}">
                ${score}
              </div>
              <div class="day-pill-date">${d.label}</div>
            </div>
          `;
        }).join("")}
      </div>
    `;

    area.innerHTML = dayStripHtml +
      `<div class="chart-container"><canvas id="bwChart"></canvas></div>`;

    const labels = curve.map(c => c.label);
    const cats = ["story","music","movie","news","pro"];
    const colors = {
      story:"#3b82f6",
      music:"#22c55e",
      movie:"#a855f7",
      news:"#f97316",
      pro:"#ec4899"
    };
    const displayNames = {
      story:"故事 Story",
      music:"音樂 Music",
      movie:"電影 Movie",
      news:"新聞 News",
      pro:"專業 Pro"
    };

    const datasets = cats.map(cat => ({
      label: displayNames[cat],
      data: curve.map(c => c.cats[cat] || 0),
      borderColor: colors[cat],
      backgroundColor: colors[cat],
      fill: false,
      tension: 0.35,
      pointRadius: 3,
      pointHoverRadius: 4
    }));

    const ctx = document.getElementById("bwChart").getContext("2d");
    if(curveChart){
      curveChart.destroy();
    }
    curveChart = new Chart(ctx, {
      type: "line",
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: "bottom",
            labels: { boxWidth: 10, boxHeight: 10, font: { size: 11 } }
          },
          tooltip: {
            callbacks: {
              label: function(context){
                const v = context.parsed.y ?? 0;
                return `${context.dataset.label}: ${v}%`;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            ticks: { callback: v => v + "%" }
          },
          x: {
            ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 8 }
          }
        }
      }
    });
  }

  // 金榜排行：最近 7 天 total_score（RPC）
  async function loadLeaderboard(user){
    const box = document.getElementById("leaderboardBox");
    box.innerHTML = `<div class="empty-tip">載入中...</div>`;

    try{
      const { data, error } = await supabase.rpc("get_leaderboard_7days");
      if(error) throw error;

      const rows = Array.isArray(data) ? data : [];
      rows.sort((a,b) => (b.total_score || 0) - (a.total_score || 0));
      const top10 = rows.slice(0,10);

      if(!top10.length){
        box.innerHTML = `<div class="empty-tip">最近 7 天尚無資料。</div>`;
        return;
      }

      const myEmail = user.email || "";

      box.innerHTML = `
        <div class="leaderboard-scroll">
          <ol class="rank-list">
            ${top10.map((row,idx) => {
              const rank = idx + 1;
              const email = row.email || "";
              const shortName =
                row.display_name ||
                (email ? email.replace(/@.*/,"") : "匿名學員");
              const total = Math.round(row.total_score || 0);
              const watchSec = Math.round(row.watch_sec || 0);
              const quizScore = Math.round(row.quiz_score || 0);
              const meClass = email === myEmail ? " rank-me" : "";
              return `
                <li class="rank-item${meClass}">
                  <span class="rank-no">${rank}</span>
                  <span class="rank-name">${shortName}</span>
                  <span class="rank-score">${total} 分</span>
                  <span class="rank-meta">
                    觀看 ${watchSec} 秒 · 測驗 ${quizScore} 分
                  </span>
                </li>
              `;
            }).join("")}
          </ol>
        </div>
      `;
    }catch(err){
      console.error("leaderboard error", err);
      box.innerHTML = `<div class="empty-tip">金榜資料載入失敗。</div>`;
    }
  }

  /* ---------- 主流程 ---------- */
  async function loadDashboard(user){
    const userEmail = user.email;

    await loadVideoIndex();

    // 觀看紀錄
    const { data: logs, error: lErr } = await supabase
      .from("watch_logs")
      .select("*")
      .eq("user_id", user.id)

      .order("updated_at", { ascending:false });

    if(lErr){
      console.error("watch_logs error", lErr);
    }

    const logsFilled = (logs || [])
      .map(row => {
        const slug = row.video_slug || row.slug;
        if(!slug) return null;
        const meta = metaFromIndex(slug);
        return {
          ...row,
          slug,
          video_slug: slug,
          category: meta.cat,
          video_category: meta.cat,
          title: meta.title,
          video_title: meta.title,
          cover_path: meta.cover_path
        };
      })
      .filter(Boolean);

    // 測驗紀錄（只需要分數與日期）
    const { data: quizLogs, error: qErr } = await supabase
      .from("quiz_logs")
      .select("email,score,created_at")
      .eq("user_id", user.id)

      .order("created_at",{ ascending:false });

    if(qErr){
      console.error("quiz_logs error", qErr);
    }

    // 先嘗試載入 weekly-index.json，從本週 15 支影片中隨機推薦 3 支
    await loadWeeklyIndex();

    
    // 今日口說任務（由 weekly-index.json 自動決定）
    const todayTalk = pickTodayTalkFromWeeklyIndex(WEEKLY_INDEX);
    renderTodayTalk(todayTalk);
let todayReview = [];
    if(WEEKLY_INDEX && Array.isArray(WEEKLY_INDEX.weeks) && WEEKLY_INDEX.weeks.length){
      const weekIndex = getWeekIndex();
      const weeksArr = WEEKLY_INDEX.weeks;
      const target = weeksArr[(weekIndex % weeksArr.length + weeksArr.length) % weeksArr.length];
      if(target && Array.isArray(target.videos)){
        const weeklyList = target.videos.map(v => {
          const slug = v.slug;
          if(!slug) return null;
          const meta = metaFromIndex(slug);
          return {
            slug,
            video_slug: slug,
            category: v.category || meta.cat,
            video_category: v.category || meta.cat,
            title: meta.title,
            video_title: meta.title,
            cover_path: meta.cover_path
          };
        }).filter(Boolean);

        if(weeklyList.length){
          // 隨機打散，取前 3 支當作「今日複習」
          weeklyList.sort(() => Math.random() - 0.5);
          todayReview = weeklyList.slice(0, 3);
        }
      }
    }

    // 如果 weekly-index 無法使用，退回舊邏輯：從未完成紀錄中推薦
    if(!todayReview.length){
      todayReview = logsFilled.filter(r => (r.progress_pct || 0) < 100);
    }

    // 繼續播放
    let continueItem = null;
    if(logsFilled.length){
      const incomplete = logsFilled.filter(r => (r.progress_pct || 0) < 100);
      continueItem = incomplete[0] || logsFilled[0] || null;
    }

    const recent = logsFilled.slice(0,10);

    // 學習曲線 30 天：分類完成度 + 每日總分（watch_sec + quiz_score）
    const now = new Date();
    const curve = [];
    const cats = ["story","music","movie","news","pro"];

    for(let i=29;i>=0;i--){
      const d = new Date(now.getTime() - i*24*60*60*1000);
      const key = d.toISOString().slice(0,10); // YYYY-MM-DD

      const dayLogs = logsFilled.filter(r => {
        const u = (r.updated_at || "").toString();
        return u.startsWith(key);
      });

      const dayQuiz = (quizLogs || []).filter(q => {
        const u = (q.created_at || "").toString();
        return u.startsWith(key);
      });

      // 每日分類平均完成度（%）
      const byCat = {};
      cats.forEach(cat => {
        const list = dayLogs.filter(r => (r.video_category || r.category) === cat);
        const avg = list.length
          ? Math.round(list.reduce((a,c)=>a+(c.progress_pct||0),0)/list.length)
          : 0;
        byCat[cat] = Math.max(0, Math.min(100, avg));
      });

      // 當日總分：watch_sec + quiz_score
      const watchSecDay = dayLogs.reduce((a,c)=> a + (c.duration_sec || 0), 0);
      const quizScoreDay = dayQuiz.reduce((a,c)=> a + (c.score || 0), 0);
      const totalScoreDay = watchSecDay + quizScoreDay;

      const label =
        i===0 ? "今天" :
        i===1 ? "昨天" :
        `${d.getMonth()+1}/${d.getDate()}`;

      curve.push({
        label,
        cats: byCat,
        totalScore: totalScoreDay
      });
    }

    renderContinue(continueItem);
    renderRecent(recent);
    renderReview(todayReview);
    renderCurve(curve);

    // 金榜排行（最近 7 天）
    loadLeaderboard(user);
  }


  async function handleShareDashboardImage(){
    const area = document.getElementById("dashLayout");
    if(!area || typeof html2canvas === "undefined"){
      alert("截圖功能目前無法使用，請改用裝置的截圖分享。");
      return;
    }

    const btn = document.getElementById("btnShareRank");
    try{
      if(btn){
        btn.disabled = true;
        btn.textContent = "產生中...";
      }

      const canvas = await html2canvas(area, { scale: 2, backgroundColor: null });
      const dataUrl = canvas.toDataURL("image/png");

      if(btn){
        btn.disabled = false;
        btn.textContent = "分享";
      }

      if(navigator.canShare && navigator.canShare({ files: [] }) && window.fetch){
        const res = await fetch(dataUrl);
        const blob = await res.blob();
        const file = new File([blob], "bookwide-dashboard.png", { type: "image/png" });
        await navigator.share({
          files:[file],
          title:"我的 BookWide 學習排行",
          text:"看看我在 BookWide 的學習表現！"
        });
      }else{
        const w = window.open();
        if(w){
          w.document.title = "BookWide 分享截圖";
          w.document.body.style.margin = "0";
          w.document.body.innerHTML = `<img src="${dataUrl}" style="max-width:100%;display:block;">`;
        }else{
          const a = document.createElement("a");
          a.href = dataUrl;
          a.download = "bookwide-dashboard.png";
          a.click();
        }
      }
    }catch(err){
      console.error("share image error", err);
      if(btn){
        btn.disabled = false;
        btn.textContent = "分享";
      }
      alert("截圖分享失敗，請改用裝置的截圖功能。");
    }
  }

  async function init(){
    const { data, error } = await supabase.auth.getUser();
    if(error || !data.user){
      window.location.href = "../login.html";
      return;
    }

    const user = data.user;
    document.getElementById("userEmail").textContent = user.email || "";
    document.getElementById("userPill").style.display = "flex";

    loadDashboard(user);
  }

  init();

  // click: talk card
  document.addEventListener("click", (e)=>{
    const el = e.target.closest("[data-jump='talk']");
    if(!el) return;
    const scene = decodeURIComponent(el.dataset.scene || "");
    if(scene) window.location.href = `/talk.html?scene=${encodeURIComponent(scene)}`;
  });
</script>
</body>
</html>





































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































