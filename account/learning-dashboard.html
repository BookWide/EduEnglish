<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>學習控制台</title>

  <!-- 你的既有 CSS 請保留；下方只是保底樣式，若不需要可刪 -->
  <style>
    :root{--fg:#1a1a1a;--muted:#6b7280;--accent:#0b53ff;--card:#fff;--bg:#f6f7fb;}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,"Microsoft JhengHei",sans-serif;}
    main{max-width:1100px;margin:28px auto;padding:0 16px;}
    h1{font-size:28px;margin:0 0 16px;}
    .grid{display:grid;gap:16px;}
    @media(min-width:860px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border-radius:14px;box-shadow:0 2px 10px rgba(10,22,70,.06);padding:16px}
    .card h2{font-size:18px;margin:0 0 8px}
    .empty{color:var(--muted);padding:8px 0}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:6px}
    .item{display:block;padding:10px 12px;border:1px solid #eee;border-radius:10px;text-decoration:none;color:inherit;background:#fff}
    .item:hover{border-color:#d8def0;background:#fbfdff}
    .title{font-weight:600}
    .meta{color:var(--muted);font-size:13px;margin-top:3px}
    .row{display:flex;gap:16px}
    .w50{flex:1}
    .chart-wrap{padding:10px 0}
  </style>

  <!-- Chart.js 僅用於學習曲線 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <main>
    <h1>學習控制台</h1>

    <!-- 上排：續看 + 今日複習 -->
    <div class="grid">
      <section class="card">
        <h2>繼續播放</h2>
        <div id="continueBox" class="list">
          <div class="empty">載入中…</div>
        </div>
      </section>

      <section class="card">
        <h2>今日複習</h2>
        <div id="reviewBox" class="list">
          <div class="empty">載入中…</div>
        </div>
      </section>
    </div>

    <!-- 下排：最近看過 + 我的清單 -->
    <div class="grid" style="margin-top:16px">
      <section class="card">
        <h2>最近看過</h2>
        <div id="recentBox" class="list">
          <div class="empty">載入中…</div>
        </div>
      </section>

      <section class="card">
        <h2>我的清單</h2>
        <div id="favBox" class="list">
          <div class="empty">載入中…</div>
        </div>
      </section>
    </div>

    <!-- 學習曲線 -->
    <section class="card" style="margin-top:16px">
      <h2>學習曲線（最近 7 天）</h2>
      <div class="chart-wrap">
        <canvas id="learningChart" height="120"></canvas>
      </div>
    </section>
  </main>

  <!-- 主程式：串 Supabase（重點：從 /account/ 回上一層找 supa.js） -->
  <script type="module">
    import { supabase } from '../supa.js';   // ← 請確認這個檔案存在於專案根目錄

    console.log('[dashboard] boot');

    const $ = (s, e=document) => e.querySelector(s);
    const continueBox = $('#continueBox');
    const recentBox   = $('#recentBox');
    const favBox      = $('#favBox');
    const reviewBox   = $('#reviewBox');
    const chartEl     = $('#learningChart');

    const pct = x => Math.round((x||0)*100);
    const ago = iso => {
      const d=new Date(iso), diff=(Date.now()-d.getTime())/1000;
      if(diff<60) return '剛剛';
      if(diff<3600) return Math.floor(diff/60)+' 分鐘前';
      if(diff<86400) return Math.floor(diff/3600)+' 小時前';
      return Math.floor(diff/86400)+' 天前';
    };
    const todayIso = () => new Date().toISOString().split('T')[0];

    async function me(){
      const { data, error } = await supabase.auth.getUser();
      if(error || !data?.user){ console.warn('[dashboard] no user', error); }
      return data?.user ?? null;
    }

    // 1) 續看（未看完）
    async function loadContinue(){
      const user = await me();
      if(!user){ continueBox.innerHTML='<div class="empty">請先登入</div>'; return; }
      const { data, error } = await supabase
        .from('watch_logs')
        .select('video_slug, progress_pct, updated_at')
        .eq('user_id', user.id)
        .lt('progress_pct', 0.9)
        .order('updated_at', { ascending:false })
        .limit(8);
      if(error){ continueBox.innerHTML='<div class="empty">讀取失敗</div>'; return; }
      if(!data?.length){ continueBox.innerHTML='<div class="empty">目前沒有未看完的影片。</div>'; return; }
      continueBox.innerHTML = data.map(r=>{
        const slug=r.video_slug||'';
        return `<a class="item" href="./player.html?slug=${encodeURIComponent(slug)}">
          <div class="title">${slug||'(未命名)'}</div>
          <div class="meta">已看 ${pct(r.progress_pct)}% · ${ago(r.updated_at)}</div>
        </a>`;
      }).join('');
    }

    // 2) 最近看過（不限完成）
    async function loadRecent(){
      const user = await me();
      if(!user){ recentBox.innerHTML='<div class="empty">請先登入</div>'; return; }
      const { data, error } = await supabase
        .from('watch_logs')
        .select('video_slug, progress_pct, updated_at')
        .eq('user_id', user.id)
        .order('updated_at', { ascending:false })
        .limit(10);
      if(error){ recentBox.innerHTML='<div class="empty">讀取失敗</div>'; return; }
      if(!data?.length){ recentBox.innerHTML='<div class="empty">尚無觀看紀錄。</div>'; return; }
      recentBox.innerHTML = data.map(r=>{
        const slug=r.video_slug||'';
        return `<a class="item" href="./player.html?slug=${encodeURIComponent(slug)}">
          <div class="title">${slug||'(未命名)'}</div>
          <div class="meta">${ago(r.updated_at)} · 進度 ${pct(r.progress_pct)}%</div>
        </a>`;
      }).join('');
    }

    // 3) 我的清單（favorites）
    async function loadFavorites(){
      const user = await me();
      if(!user){ favBox.innerHTML='<div class="empty">請先登入</div>'; return; }
      const { data, error } = await supabase
        .from('favorites')  // 若表尚未建立，就會顯示空清單
        .select('video_slug, created_at')
        .eq('user_id', user.id)
        .order('created_at', { ascending:false })
        .limit(10);
      if(error || !data?.length){
        favBox.innerHTML='<div class="empty">尚未收藏任何影片。</div>'; return;
      }
      favBox.innerHTML = data.map(r=>{
        const slug=r.video_slug||'';
        return `<a class="item" href="./player.html?slug=${encodeURIComponent(slug)}">
          <div class="title">${slug||'(未命名)'}</div>
          <div class="meta">收藏於 ${new Date(r.created_at).toLocaleDateString()}</div>
        </a>`;
      }).join('');
    }

    // 4) 今日複習（review_tasks）
    async function loadReview(){
      const user = await me();
      if(!user){ reviewBox.innerHTML='<div class="empty">請先登入</div>'; return; }
      const { data, error } = await supabase
        .from('review_tasks')     // 若尚未建表，會直接顯示空
        .select('title, video_slug, due_date, status, updated_at')
        .eq('user_id', user.id)
        .lte('due_date', todayIso())
        .neq('status','done')
        .order('due_date', { ascending:true })
        .limit(20);
      if(error || !data?.length){
        reviewBox.innerHTML='<div class="empty">今日沒有到期的複習項目。</div>'; return;
      }
      reviewBox.innerHTML = data.map(r=>{
        const title = r.title || r.video_slug || '(未命名)';
        const slug  = r.video_slug || '';
        const due   = new Date(r.due_date).toLocaleDateString();
        const href  = slug ? `./player.html?slug=${encodeURIComponent(slug)}#review` : '#';
        return `<a class="item" href="${href}">
          <div class="title">🧠 ${title}</div>
          <div class="meta">到期：${due}${r.updated_at?(' · 更新於 '+ago(r.updated_at)) : ''}</div>
        </a>`;
      }).join('');
    }

    // 5) 學習曲線（最近 7 天觀看次數）
    async function loadCurve(){
      const user = await me();
      if(!user || !chartEl) return;
      const { data, error } = await supabase
        .from('watch_logs')
        .select('updated_at')
        .eq('user_id', user.id)
        .order('updated_at',{ascending:true});
      if(error || !data?.length) return;

      const counts = {};
      for(const r of data){
        const d=new Date(r.updated_at).toISOString().split('T')[0];
        counts[d]=(counts[d]||0)+1;
      }
      const keys=Object.keys(counts).sort();
      const labels=keys.slice(-7);
      const values=labels.map(k=>counts[k]);

      new Chart(chartEl.getContext('2d'),{
        type:'line',
        data:{labels,datasets:[{label:'每日觀看次數',data:values,borderColor:'#0b53ff',tension:.2,fill:false}]},
        options:{scales:{y:{beginAtZero:true,ticks:{stepSize:1}}}}
      });
    }

    (async function init(){
      await loadContinue();
      await loadRecent();
      await loadFavorites();
      await loadReview();
      await loadCurve();
      console.log('[dashboard] ready');
    })();
  </script>
</body>
</html>






