<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>學習控制台</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <style>
    :root{
      --card-bg:#fff; --muted:#6b7280; --fg:#111827; --pill:#eef2ff;
      --border:#e5e7eb; --brand:#2563eb;
    }
    body{margin:0;background:#f8fafc;color:var(--fg);font:16px/1.6 system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans TC',sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:32px 20px}
    h1{font-size:32px;margin:0 0 20px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .card{background:var(--card-bg);border:1px solid var(--border);border-radius:14px;padding:20px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .card h2{font-size:20px;margin:0 0 10px}
    .muted{color:var(--muted)}
    .pill{display:inline-block;background:var(--pill);color:#4f46e5;border-radius:999px;padding:4px 10px;font-size:12px}
    .list{margin:8px 0 0;padding-left:20px}
    .empty{color:var(--muted)}
    .nav{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);z-index:10}
    .nav__inner{max-width:1100px;margin:0 auto;padding:10px 20px;display:flex;align-items:center;gap:12px}
    .back{color:var(--brand);text-decoration:none;font-weight:600}
    .email{margin-left:auto;color:var(--muted);font-size:14px}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <!-- 頂部導覽：返回首頁 + 顯示登入帳號 -->
  <div class="nav">
    <div class="nav__inner">
      <a class="back" href="/EduEnglish/index.html">← 回首頁</a>
      <span class="email" id="userEmail">登入中…</span>
    </div>
  </div>

  <main class="wrap">
    <h1>學習控制台</h1>

    <div class="grid">
      <!-- 繼續播放 -->
      <section class="card" id="secContinue">
        <h2>繼續播放 <span id="continueBadge" class="pill" style="display:none"></span></h2>
        <div id="continueBody" class="muted">載入中…</div>
      </section>

      <!-- 今日複習 -->
      <section class="card" id="secReview">
        <h2>今日複習</h2>
        <div id="reviewBody" class="muted">載入中…</div>
      </section>

      <!-- 最近看過 -->
      <section class="card" id="secRecent">
        <h2>最近看過</h2>
        <div id="recentBody" class="muted">載入中…</div>
      </section>

      <!-- 我的清單（收藏） -->
      <section class="card" id="secFav">
        <h2>我的清單</h2>
        <div id="favBody" class="muted">載入中…</div>
      </section>
    </div>

    <section class="card" style="margin-top:18px">
      <h2>學習曲線（最近 7 天）</h2>
      <div class="muted">（預留）</div>
    </section>
  </main>

  <!-- 主程式：串 Supabase（從 /account/ 回上一層找 supa.js） -->
  <script type="module">
    import { supabase } from '../supa.js'; // ← 確認這個檔案放在專案根目錄

    const $ = (s)=>document.querySelector(s);
    const userEmailEl = $('#userEmail');
    const continueBody = $('#continueBody');
    const continueBadge = $('#continueBadge');
    const recentBody = $('#recentBody');
    const favBody = $('#favBody');
    const reviewBody = $('#reviewBody');

    function fmtDate(d){
      try{
        const x = new Date(d);
        return x.toLocaleString('zh-TW',{hour12:false});
      }catch{ return d }
    }

    async function getUser() {
      const { data: { user } } = await supabase.auth.getUser();
      return user ?? null;
    }

    // 安全查詢：若資料表尚未建立 / 欄位不存在，不會整頁炸掉
    async function safeQuery(fn, fallback=null){
      try{ return await fn() }catch(e){ console.warn('[safeQuery]', e); return fallback }
    }

    async function boot(){
      // 1) 取得使用者
      const user = await getUser();
      if(!user){
        userEmailEl.textContent = '尚未登入';
        const msg = '請先登入以顯示你的學習紀錄。';
        [continueBody, recentBody, favBody, reviewBody].forEach(el => el.textContent = msg);
        return;
      }
      userEmailEl.textContent = user.email ?? '(未具名)';

      // 2) 繼續播放：從 watch_logs 找 progress_pct < 100 的最後一筆
      const watchRes = await safeQuery(async () => {
        return await supabase
          .from('watch_logs')
          .select('video_slug, progress_pct, updated_at')
          .eq('user_id', user.id)
          .lt('progress_pct', 100)
          .order('updated_at', { ascending:false })
          .limit(1);
      }, { data: null });

      if(watchRes?.data?.length){
        const w = watchRes.data[0];
        continueBody.innerHTML = `
          <div>上次看到：<b>${w.video_slug}</b></div>
          <div class="muted">進度：${Math.round(w.progress_pct)}%　更新：${fmtDate(w.updated_at)}</div>
        `;
        continueBadge.style.display = 'inline-block';
        continueBadge.textContent = `未完成 < ${Math.round(w.progress_pct)}%`;
      }else{
        continueBody.innerHTML = `<span class="empty">目前沒有未看完的影片。</span>`;
      }

      // 3) 最近看過：watch_logs 取最新 3 筆
      const recentRes = await safeQuery(async () => {
        return await supabase
          .from('watch_logs')
          .select('video_slug, progress_pct, updated_at')
          .eq('user_id', user.id)
          .order('updated_at', { ascending:false })
          .limit(3);
      }, { data: null });

      if(recentRes?.data?.length){
        recentBody.innerHTML = `<ul class="list">` + recentRes.data.map(r => `
          <li><b>${r.video_slug}</b>　
            <span class="muted">進度 ${Math.round(r.progress_pct)}%・${fmtDate(r.updated_at)}</span>
          </li>`).join('') + `</ul>`;
      }else{
        recentBody.innerHTML = `<span class="empty">尚無觀看紀錄。</span>`;
      }

      // 4) 收藏：favorites 取最新 3 筆 + 計數
      const favCountRes = await safeQuery(async () => {
        return await supabase
          .from('favorites')
          .select('id', { count:'exact', head:true })
          .eq('user_id', user.id);
      }, { count: 0 });

      const favListRes = await safeQuery(async () => {
        return await supabase
          .from('favorites')
          .select('video_slug, created_at')
          .eq('user_id', user.id)
          .order('created_at', { ascending:false })
          .limit(3);
      }, { data: [] });

      const cnt = favCountRes?.count ?? 0;
      if(cnt === 0){
        favBody.innerHTML = `<span class="empty">尚未收藏任何影片。</span>`;
      }else{
        favBody.innerHTML = `
          <div class="muted" style="margin-bottom:6px">共收藏 <b>${cnt}</b> 部影片</div>
          <ul class="list">
            ${ (favListRes?.data ?? []).map(f => `
              <li><b>${f.video_slug}</b>　
                <span class="muted">${fmtDate(f.created_at)}</span>
              </li>`).join('') }
          </ul>
        `;
      }

      // 5) 今日複習：review_tasks 若有 next_review_at（或 due_at）<= 今天
      // 若表不存在 / 欄位不存在，優雅降級成「今日沒有到期的複習項目」
      let reviewText = `<span class="empty">今日沒有到期的複習項目。</span>`;
      const nowIso = new Date().toISOString();
      const reviewRes = await safeQuery(async () => {
        // 嘗試用 next_review_at
        const r1 = await supabase
          .from('review_tasks')
          .select('video_slug, next_review_at')
          .eq('user_id', user.id)
          .lte('next_review_at', nowIso)
          .order('next_review_at', { ascending:true })
          .limit(5);
        if(r1.error && r1.error.message?.includes('column "next_review_at"')) {
          // 欄位不存在 → 用 created_at 當作 fallback
          return await supabase
            .from('review_tasks')
            .select('video_slug, created_at')
            .eq('user_id', user.id)
            .lte('created_at', nowIso)
            .order('created_at', { ascending:true })
            .limit(5);
        }
        return r1;
      }, { data: [] });

      if(reviewRes?.data?.length){
        reviewText = `
          <ul class="list">
            ${reviewRes.data.map(r => `
              <li><b>${r.video_slug}</b>　
                <span class="muted">${fmtDate(r.next_review_at ?? r.created_at)}</span>
              </li>`).join('')}
          </ul>`;
      }
      reviewBody.innerHTML = reviewText;
    }

    boot();
  </script>
</body>
</html>








