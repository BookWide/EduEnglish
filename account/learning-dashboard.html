<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å­¸ç¿’æ§åˆ¶å°</title>
  <style>
    :root {
      --card-bg:#fff;
      --muted:#6b7280;
      --border:#e5e7eb;
      --brand:#2563eb;
    }
    body{
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji;
      margin:0; background:#f4f6fb; color:#111827;
    }
    .wrap{ max-width:1080px; margin:32px auto 80px; padding:0 16px; }
    .nav{ display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
    .back{
      display:inline-flex; align-items:center; gap:.5rem;
      background:#eef2ff; color:#1e40af; border:1px solid #c7d2fe;
      text-decoration:none; padding:8px 12px; border-radius:10px; font-weight:600;
    }
    h1{ margin:8px 0 16px; font-size:28px; letter-spacing:.04em; }
    .grid{
      display:grid; grid-template-columns:1fr 1fr; gap:20px;
    }
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background:var(--card-bg); border:1px solid var(--border);
      border-radius:16px; padding:16px 16px; box-shadow:0 1px 0 rgba(0,0,0,.02);
    }
    .card h2{ margin:0 0 10px; font-size:20px; }
    .muted{ color:var(--muted); }
    .list{ margin:8px 0 0; padding-left:18px; }
    .list li{ margin:8px 0; }

    /* æ–°å¢ï¼šè—åº•ç™½å­—å¾½ç«  */
    .pill{
      display:inline-block; padding:4px 10px; border-radius:999px;
      background:var(--brand); color:#fff; font-size:12px; font-weight:700;
      vertical-align:middle;
    }

    /* å¯é»çš„å¡ç‰‡éŠçµ */
    .link-card{
      display:block; padding:12px 14px; border-radius:12px;
      background:#f9fafb; color:inherit; text-decoration:none;
      border:1px solid var(--border); transition:.15s;
    }
    .link-card:hover{ background:#f3f4f6; border-color:#d1d5db; }
    .title-line{ font-weight:700; font-size:17px; margin-bottom:6px; }
    .sub-line{ color:#374151; font-size:14px; }

    /* å³ä¸Šè§’ mail */
    .mail{ color:#374151; }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- ä¸Šæ–¹å·¥å…·åˆ— -->
    <div class="nav">
      <a class="back" href="../index.html">â† å›é¦–é </a>
      <div class="mail" id="userEmail"></div>
    </div>

    <h1>å­¸ç¿’æ§åˆ¶å°</h1>

    <div class="grid">

      <!-- ç¹¼çºŒæ’­æ”¾ -->
      <section class="card">
        <h2>
          ç¹¼çºŒæ’­æ”¾
          <span id="continueBadge" class="pill" style="display:none">æœªå®Œæˆ</span>
        </h2>
        <div id="continueBody" class="muted">ç›®å‰æ²’æœ‰æœªçœ‹å®Œçš„å½±ç‰‡ã€‚</div>
      </section>

      <!-- ä»Šæ—¥è¤‡ç¿’ï¼ˆä¿ç•™å¤–è§€èˆ‡å ä½ï¼‰ -->
      <section class="card">
        <h2>ä»Šæ—¥è¤‡ç¿’</h2>
        <div class="muted" id="reviewToday">ä»Šæ—¥æ²’æœ‰åˆ°æœŸçš„è¤‡ç¿’é …ç›®ã€‚</div>
      </section>

      <!-- æœ€è¿‘çœ‹é -->
      <section class="card">
        <h2>æœ€è¿‘çœ‹é</h2>
        <ul id="recentList" class="list muted">
          <li>å°šç„¡è§€çœ‹ç´€éŒ„ã€‚</li>
        </ul>
      </section>

      <!-- æˆ‘çš„æ¸…å–®ï¼ˆä¿ç•™ï¼‰ -->
      <section class="card">
        <h2>æˆ‘çš„æ¸…å–®</h2>
        <div class="muted">å°šæœªæ”¶è—ä»»ä½•å½±ç‰‡ã€‚</div>
      </section>

      <!-- å­¸ç¿’æ›²ç·šï¼ˆé ç•™ï¼‰ -->
      <section class="card" style="grid-column:1/-1">
        <h2>å­¸ç¿’æ›²ç·šï¼ˆæœ€è¿‘ 7 å¤©ï¼‰</h2>
        <div class="muted">ï¼ˆé ç•™ï¼›ä¹‹å¾Œæ”¹ç‚º Chart.js æŠ˜ç·šåœ–ï¼‰</div>
      </section>
    </div>
  </div>

  <!-- é€™æ”¯ç…§ä½ çš„å°ˆæ¡ˆçµæ§‹ï¼Œå¾ /EduEnglish/account/ å›ä¸Šä¸€å±¤å–ç”¨ -->
  <script type="module">
    import { supabase } from '../supa.js';

    const emailEl   = document.getElementById('userEmail');
    const contBody  = document.getElementById('continueBody');
    const contBadge = document.getElementById('continueBadge');
    const recentUl  = document.getElementById('recentList');

    const fmtDate = (iso) => {
      const d = new Date(iso);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      return `${y}/${m}/${day} ${hh}:${mm}`;
    };

    // 1) å–å¾—ç™»å…¥
    const { data:authData, error:authErr } = await supabase.auth.getUser();
    const user = authData?.user || null;
    if (!user) {
      // æœªç™»å…¥ä»é¡¯ç¤ºé é¢ï¼Œä½†æé†’ä¸¦å°å›é¦–é 
      alert('è«‹å…ˆç™»å…¥å¾Œå†ä½¿ç”¨å­¸ç¿’æ§åˆ¶å°');
      location.href = '../index.html';
      throw new Error('No session');
    }
    emailEl.textContent = user.email ?? '';

    // 2) æ’ˆ watch_logsï¼ˆå·²åœ¨ DB å•Ÿç”¨ RLS -> åªèƒ½çœ‹åˆ°è‡ªå·±çš„ï¼‰
    const { data:logs, error:logErr } = await supabase
      .from('watch_logs')
      .select('*')
      .order('updated_at', { ascending:false })
      .limit(30);

    if (logErr) {
      console.warn('watch_logs è®€å–å¤±æ•—ï¼š', logErr.message || logErr);
    }

    if (!logs || logs.length === 0) {
      contBody.textContent = 'ç›®å‰æ²’æœ‰æœªçœ‹å®Œçš„å½±ç‰‡ã€‚';
      recentUl.innerHTML = '<li>å°šç„¡è§€çœ‹ç´€éŒ„ã€‚</li>';
    } else {
      // A. ç¹¼çºŒæ’­æ”¾ï¼šæ‰¾åˆ°ç¬¬ä¸€å€‹é€²åº¦ < 100 çš„æ¢ç›®ï¼›è‹¥éƒ½ 100%ï¼Œå°±ç”¨æœ€æœ€æ–°çš„ä¸€ç­†ç•¶ä½œæç¤º
      const cont = logs.find(l => (l.progress_pct ?? 0) < 100) ?? logs[0];
      const pct  = Math.round(cont.progress_pct ?? 0);
      const slug = cont.video_slug;
      const videoUrl = `../player.html?slug=${encodeURIComponent(slug)}`;

      contBody.innerHTML = `
        <a class="link-card" href="${videoUrl}">
          <div class="title-line">ğŸ¬ ${slug}</div>
          <div class="sub-line">ä¸Šæ¬¡é€²åº¦ <b>${pct}%</b>ã€€æ›´æ–°ï¼š${fmtDate(cont.updated_at)}</div>
        </a>
      `;
      contBadge.style.display = (pct >= 100) ? 'none' : 'inline-block';

      // B. æœ€è¿‘çœ‹éï¼šåˆ— 6 ç­†
      const items = logs.slice(0, 6).map(r => {
        const p = Math.round(r.progress_pct ?? 0);
        const s = r.video_slug;
        const url = `../player.html?slug=${encodeURIComponent(s)}`;
        return `
          <li>
            <a href="${url}" style="text-decoration:none;color:inherit;"><b>ğŸ ${s}</b></a>
            <span class="muted">ã€€é€²åº¦ ${p}%ãƒ»${fmtDate(r.updated_at)}</span>
          </li>
        `;
      }).join('');
      recentUl.innerHTML = items;
    }

    // ï¼ˆã€Œä»Šæ—¥è¤‡ç¿’ã€ã€ã€Œæˆ‘çš„æ¸…å–®ã€ã€ã€Œå­¸ç¿’æ›²ç·šã€ä¿ç•™ä½ æ—¢æœ‰çµæ§‹ï¼Œä¹‹å¾Œè¦ä¸²è³‡æ–™å†è£œã€‚ï¼‰
  </script>
  <!-- Chart.js æŠ˜ç·šåœ–è£œé‡˜ï¼šå­¸ç¿’æ›²ç·šï¼ˆæœ€è¿‘ 7 å¤©ï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { supabase } from '../supa.js';

async function drawLearningCurve() {
  const wrap = document.querySelector('section.card:last-of-type .muted');
  if (!wrap) return;

  // å…ˆæ¸…ç©ºé ç•™æ–‡å­—ï¼ŒåŠ å…¥ç•«å¸ƒ
  wrap.innerHTML = `
    <div style="width:30%;min-width:260px;margin:20px auto;">
      <canvas id="learnCurve"></canvas>
    </div>
    <div id="learnCurveEmpty" style="text-align:center;color:#888;font-size:.9rem;display:none;">
      å°šç„¡è³‡æ–™ï¼ˆéå» 7 å¤©æ²’æœ‰è§€çœ‹ç´€éŒ„ï¼‰
    </div>
  `;

  // å–å¾—ç™»å…¥
  const { data:auth } = await supabase.auth.getUser();
  if (!auth?.user) {
    document.getElementById('learnCurveEmpty').style.display='block';
    return;
  }

  // å¾ä½ å»ºç«‹çš„æª¢è¦–æŠ“æœ€è¿‘ 7 å¤©è³‡æ–™
  const { data, error } = await supabase
    .from('v_watch_events_last7')
    .select('*')
    .order('d');
  if (error) {
    console.warn('å­¸ç¿’æ›²ç·šè³‡æ–™è®€å–å¤±æ•—:', error);
    document.getElementById('learnCurveEmpty').style.display='block';
    return;
  }

  // å»ºç«‹æœ€è¿‘ä¸ƒå¤©æ—¥æœŸ (YYYY-MM-DD)
  const days = [...Array(7)].map((_,i)=>{
    const d=new Date();d.setDate(d.getDate()-6+i);
    return d.toISOString().slice(0,10);
  });
  const map=new Map((data||[]).map(r=>[r.d,r.events]));
  const labels=days.map(d=>d.slice(5)); // é¡¯ç¤º MM-DD
  const values=days.map(d=>map.get(d)||0);
  if(values.every(v=>v===0)){
    document.getElementById('learnCurveEmpty').style.display='block';
    return;
  }

  new Chart(document.getElementById('learnCurve'),{
    type:'line',
    data:{labels,
      datasets:[{label:'è§€çœ‹æ¬¡æ•¸',data:values,
        borderColor:'#2563eb',borderWidth:2,
        pointRadius:3,tension:.3,fill:false}]},
    options:{
      plugins:{legend:{display:false}},
      scales:{y:{beginAtZero:true,ticks:{precision:0}}}
    }
  });
}

drawLearningCurve();
</script>
<!-- ä»Šæ—¥è¤‡ç¿’è‡ªå‹•æ¨è–¦è£œé‡˜ -->
<script type="module">
import { supabase } from '../supa.js';

// å–å¾—ç›®å‰é€±æ¬¡ï¼ˆåŒä¸€å¹´ä¸­ç¬¬å¹¾é€±ï¼Œç”¨ä¾†æ¯é€±è®Šæ›ï¼‰
function getWeekNumber(d = new Date()) {
  d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
  const weekNo = Math.ceil(((d - yearStart) / 86400000 + yearStart.getUTCDay() + 1) / 7);
  return weekNo;
}

async function loadWeeklyRecommendations() {
  const recArea = document.querySelector('section.card:nth-of-type(2) .card-body'); // ç¬¬äºŒå¡Šå¡ç‰‡ã€Œä»Šæ—¥è¤‡ç¿’ã€
  if (!recArea) return;

  // åŠ è¼‰ä¸­æç¤º
  recArea.innerHTML = '<p class="muted">è¼‰å…¥æ¨è–¦ä¸­...</p>';

  const { data, error } = await supabase
    .from('video_meta')
    .select('slug,title,category,thumbnail_url')
    .eq('active', true)
    .order('created_at', { ascending: false });

  if (error || !data?.length) {
    recArea.innerHTML = '<p class="muted">ç›®å‰æ²’æœ‰æ¨è–¦å½±ç‰‡ã€‚</p>';
    return;
  }

  // ä»¥é€±æ¬¡ç‚ºç¨®å­ï¼ŒæŒ‘ 3 æ”¯è¼ªå‹•å½±ç‰‡
  const week = getWeekNumber();
  const shuffled = [...data].sort((a, b) => ((a.slug.charCodeAt(0) + week) % 37) - ((b.slug.charCodeAt(0) + week) % 37));
  const picks = shuffled.slice(0, 3);

  // é¡¯ç¤º
  recArea.innerHTML = picks.map(v => `
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
      <img src="${v.thumbnail_url || '../img/video-thumb.png'}" 
           style="width:60px;height:40px;object-fit:cover;border-radius:6px;">
      <div>
        <a href="../player.html?slug=${encodeURIComponent(v.slug)}"
           style="font-weight:600;color:#1e40af;text-decoration:none;">${v.title || v.slug}</a>
        <div class="muted">${v.category || 'æœªåˆ†é¡'}</div>
      </div>
    </div>
  `).join('');
}

loadWeeklyRecommendations();
</script>
<!-- æˆ‘çš„æ¸…å–®ï¼šæ”¶è—å½±ç‰‡åˆ—è¡¨è£œé‡˜ -->
<script type="module">
import { supabase } from '../supa.js';

async function loadFavorites() {
  const favBox = document.querySelector('section.card:nth-of-type(4) .card-body'); // ã€Œæˆ‘çš„æ¸…å–®ã€
  if (!favBox) return;
  favBox.innerHTML = '<p class="muted">è®€å–ä¸­...</p>';

  const { data:auth } = await supabase.auth.getUser();
  if (!auth?.user) {
    favBox.innerHTML = '<p class="muted">è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹æ”¶è—å½±ç‰‡ã€‚</p>';
    return;
  }

  const { data, error } = await supabase
    .from('favorite_videos')
    .select('video_slug, created_at')
    .eq('user_id', auth.user.id)
    .order('created_at', { ascending:false });

  if (error || !data?.length) {
    favBox.innerHTML = '<p class="muted">å°šæœªæ”¶è—ä»»ä½•å½±ç‰‡ã€‚</p>';
    return;
  }

  favBox.innerHTML = data.map(v => `
    <div style="margin-bottom:8px;">
      <a href="../player.html?slug=${encodeURIComponent(v.video_slug)}"
         style="text-decoration:none;color:#2563eb;font-weight:600;">${v.video_slug}</a>
      <span class="muted" style="margin-left:4px;">${new Date(v.created_at).toLocaleString()}</span>
    </div>
  `).join('');
}

loadFavorites();
</script>

</body>
</html>



































