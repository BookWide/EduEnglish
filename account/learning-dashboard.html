<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å­¸ç¿’æ§åˆ¶å°</title>

  <!-- ä½ çš„æ—¢æœ‰ CSS è«‹ä¿ç•™ï¼›ä¸‹æ–¹åªæ˜¯ä¿åº•æ¨£å¼ï¼Œè‹¥ä¸éœ€è¦å¯åˆª -->
  <style>
    :root{--fg:#1a1a1a;--muted:#6b7280;--accent:#0b53ff;--card:#fff;--bg:#f6f7fb;}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,"Microsoft JhengHei",sans-serif;}
    main{max-width:1100px;margin:28px auto;padding:0 16px;}
    h1{font-size:28px;margin:0 0 16px;}
    .grid{display:grid;gap:16px;}
    @media(min-width:860px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border-radius:14px;box-shadow:0 2px 10px rgba(10,22,70,.06);padding:16px}
    .card h2{font-size:18px;margin:0 0 8px}
    .empty{color:var(--muted);padding:8px 0}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:6px}
    .item{display:block;padding:10px 12px;border:1px solid #eee;border-radius:10px;text-decoration:none;color:inherit;background:#fff}
    .item:hover{border-color:#d8def0;background:#fbfdff}
    .title{font-weight:600}
    .meta{color:var(--muted);font-size:13px;margin-top:3px}
    .row{display:flex;gap:16px}
    .w50{flex:1}
    .chart-wrap{padding:10px 0}
  </style>

  <!-- Chart.js åƒ…ç”¨æ–¼å­¸ç¿’æ›²ç·š -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <main>
    <h1>å­¸ç¿’æ§åˆ¶å°</h1>

    <!-- ä¸Šæ’ï¼šçºŒçœ‹ + ä»Šæ—¥è¤‡ç¿’ -->
    <div class="grid">
      <section class="card">
        <h2>ç¹¼çºŒæ’­æ”¾</h2>
        <div id="continueBox" class="list">
          <div class="empty">è¼‰å…¥ä¸­â€¦</div>
        </div>
      </section>

      <section class="card">
        <h2>ä»Šæ—¥è¤‡ç¿’</h2>
        <div id="reviewBox" class="list">
          <div class="empty">è¼‰å…¥ä¸­â€¦</div>
        </div>
      </section>
    </div>

    <!-- ä¸‹æ’ï¼šæœ€è¿‘çœ‹é + æˆ‘çš„æ¸…å–® -->
    <div class="grid" style="margin-top:16px">
      <section class="card">
        <h2>æœ€è¿‘çœ‹é</h2>
        <div id="recentBox" class="list">
          <div class="empty">è¼‰å…¥ä¸­â€¦</div>
        </div>
      </section>

      <section class="card">
        <h2>æˆ‘çš„æ¸…å–®</h2>
        <div id="favBox" class="list">
          <div class="empty">è¼‰å…¥ä¸­â€¦</div>
        </div>
      </section>
    </div>

    <!-- å­¸ç¿’æ›²ç·š -->
    <section class="card" style="margin-top:16px">
      <h2>å­¸ç¿’æ›²ç·šï¼ˆæœ€è¿‘ 7 å¤©ï¼‰</h2>
      <div class="chart-wrap">
        <canvas id="learningChart" height="120"></canvas>
      </div>
    </section>
  </main>

  <!-- ä¸»ç¨‹å¼ï¼šä¸² Supabaseï¼ˆé‡é»ï¼šå¾ /account/ å›ä¸Šä¸€å±¤æ‰¾ supa.jsï¼‰ -->
  <script type="module">
    import { supabase } from '../supa.js';   // â† è«‹ç¢ºèªé€™å€‹æª”æ¡ˆå­˜åœ¨æ–¼å°ˆæ¡ˆæ ¹ç›®éŒ„

    console.log('[dashboard] boot');

    const $ = (s, e=document) => e.querySelector(s);
    const continueBox = $('#continueBox');
    const recentBox   = $('#recentBox');
    const favBox      = $('#favBox');
    const reviewBox   = $('#reviewBox');
    const chartEl     = $('#learningChart');

    const pct = x => Math.round((x||0)*100);
    const ago = iso => {
      const d=new Date(iso), diff=(Date.now()-d.getTime())/1000;
      if(diff<60) return 'å‰›å‰›';
      if(diff<3600) return Math.floor(diff/60)+' åˆ†é˜å‰';
      if(diff<86400) return Math.floor(diff/3600)+' å°æ™‚å‰';
      return Math.floor(diff/86400)+' å¤©å‰';
    };
    const todayIso = () => new Date().toISOString().split('T')[0];

    async function me(){
      const { data, error } = await supabase.auth.getUser();
      if(error || !data?.user){ console.warn('[dashboard] no user', error); }
      return data?.user ?? null;
    }

    // 1) çºŒçœ‹ï¼ˆæœªçœ‹å®Œï¼‰
    async function loadContinue(){
      const user = await me();
      if(!user){ continueBox.innerHTML='<div class="empty">è«‹å…ˆç™»å…¥</div>'; return; }
      const { data, error } = await supabase
        .from('watch_logs')
        .select('video_slug, progress_pct, updated_at')
        .eq('user_id', user.id)
        .lt('progress_pct', 0.9)
        .order('updated_at', { ascending:false })
        .limit(8);
      if(error){ continueBox.innerHTML='<div class="empty">è®€å–å¤±æ•—</div>'; return; }
      if(!data?.length){ continueBox.innerHTML='<div class="empty">ç›®å‰æ²’æœ‰æœªçœ‹å®Œçš„å½±ç‰‡ã€‚</div>'; return; }
      continueBox.innerHTML = data.map(r=>{
        const slug=r.video_slug||'';
        return `<a class="item" href="./player.html?slug=${encodeURIComponent(slug)}">
          <div class="title">${slug||'(æœªå‘½å)'}</div>
          <div class="meta">å·²çœ‹ ${pct(r.progress_pct)}% Â· ${ago(r.updated_at)}</div>
        </a>`;
      }).join('');
    }

    // 2) æœ€è¿‘çœ‹éï¼ˆä¸é™å®Œæˆï¼‰
    async function loadRecent(){
      const user = await me();
      if(!user){ recentBox.innerHTML='<div class="empty">è«‹å…ˆç™»å…¥</div>'; return; }
      const { data, error } = await supabase
        .from('watch_logs')
        .select('video_slug, progress_pct, updated_at')
        .eq('user_id', user.id)
        .order('updated_at', { ascending:false })
        .limit(10);
      if(error){ recentBox.innerHTML='<div class="empty">è®€å–å¤±æ•—</div>'; return; }
      if(!data?.length){ recentBox.innerHTML='<div class="empty">å°šç„¡è§€çœ‹ç´€éŒ„ã€‚</div>'; return; }
      recentBox.innerHTML = data.map(r=>{
        const slug=r.video_slug||'';
        return `<a class="item" href="./player.html?slug=${encodeURIComponent(slug)}">
          <div class="title">${slug||'(æœªå‘½å)'}</div>
          <div class="meta">${ago(r.updated_at)} Â· é€²åº¦ ${pct(r.progress_pct)}%</div>
        </a>`;
      }).join('');
    }

    // 3) æˆ‘çš„æ¸…å–®ï¼ˆfavoritesï¼‰
    async function loadFavorites(){
      const user = await me();
      if(!user){ favBox.innerHTML='<div class="empty">è«‹å…ˆç™»å…¥</div>'; return; }
      const { data, error } = await supabase
        .from('favorites')  // è‹¥è¡¨å°šæœªå»ºç«‹ï¼Œå°±æœƒé¡¯ç¤ºç©ºæ¸…å–®
        .select('video_slug, created_at')
        .eq('user_id', user.id)
        .order('created_at', { ascending:false })
        .limit(10);
      if(error || !data?.length){
        favBox.innerHTML='<div class="empty">å°šæœªæ”¶è—ä»»ä½•å½±ç‰‡ã€‚</div>'; return;
      }
      favBox.innerHTML = data.map(r=>{
        const slug=r.video_slug||'';
        return `<a class="item" href="./player.html?slug=${encodeURIComponent(slug)}">
          <div class="title">${slug||'(æœªå‘½å)'}</div>
          <div class="meta">æ”¶è—æ–¼ ${new Date(r.created_at).toLocaleDateString()}</div>
        </a>`;
      }).join('');
    }

    // 4) ä»Šæ—¥è¤‡ç¿’ï¼ˆreview_tasksï¼‰
    async function loadReview(){
      const user = await me();
      if(!user){ reviewBox.innerHTML='<div class="empty">è«‹å…ˆç™»å…¥</div>'; return; }
      const { data, error } = await supabase
        .from('review_tasks')     // è‹¥å°šæœªå»ºè¡¨ï¼Œæœƒç›´æ¥é¡¯ç¤ºç©º
        .select('title, video_slug, due_date, status, updated_at')
        .eq('user_id', user.id)
        .lte('due_date', todayIso())
        .neq('status','done')
        .order('due_date', { ascending:true })
        .limit(20);
      if(error || !data?.length){
        reviewBox.innerHTML='<div class="empty">ä»Šæ—¥æ²’æœ‰åˆ°æœŸçš„è¤‡ç¿’é …ç›®ã€‚</div>'; return;
      }
      reviewBox.innerHTML = data.map(r=>{
        const title = r.title || r.video_slug || '(æœªå‘½å)';
        const slug  = r.video_slug || '';
        const due   = new Date(r.due_date).toLocaleDateString();
        const href  = slug ? `./player.html?slug=${encodeURIComponent(slug)}#review` : '#';
        return `<a class="item" href="${href}">
          <div class="title">ğŸ§  ${title}</div>
          <div class="meta">åˆ°æœŸï¼š${due}${r.updated_at?(' Â· æ›´æ–°æ–¼ '+ago(r.updated_at)) : ''}</div>
        </a>`;
      }).join('');
    }

    // 5) å­¸ç¿’æ›²ç·šï¼ˆæœ€è¿‘ 7 å¤©è§€çœ‹æ¬¡æ•¸ï¼‰
    async function loadCurve(){
      const user = await me();
      if(!user || !chartEl) return;
      const { data, error } = await supabase
        .from('watch_logs')
        .select('updated_at')
        .eq('user_id', user.id)
        .order('updated_at',{ascending:true});
      if(error || !data?.length) return;

      const counts = {};
      for(const r of data){
        const d=new Date(r.updated_at).toISOString().split('T')[0];
        counts[d]=(counts[d]||0)+1;
      }
      const keys=Object.keys(counts).sort();
      const labels=keys.slice(-7);
      const values=labels.map(k=>counts[k]);

      new Chart(chartEl.getContext('2d'),{
        type:'line',
        data:{labels,datasets:[{label:'æ¯æ—¥è§€çœ‹æ¬¡æ•¸',data:values,borderColor:'#0b53ff',tension:.2,fill:false}]},
        options:{scales:{y:{beginAtZero:true,ticks:{stepSize:1}}}}
      });
    }

    (async function init(){
      await loadContinue();
      await loadRecent();
      await loadFavorites();
      await loadReview();
      await loadCurve();
      console.log('[dashboard] ready');
    })();
  </script>
</body>
</html>






