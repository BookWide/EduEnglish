<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å­¸ç¿’æ§åˆ¶å°</title>
  <style>
    :root {
      --card-bg:#fff;
      --muted:#6b7280;
      --border:#e5e7eb;
      --brand:#2563eb;
    }
    body{
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji;
      margin:0; background:#f4f6fb; color:#111827;
    }
    .wrap{ max-width:1080px; margin:32px auto 80px; padding:0 16px; }
    .nav{ display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
    .back{
      display:inline-flex; align-items:center; gap:.5rem;
      background:#eef2ff; color:#1e40af; border:1px solid #c7d2fe;
      text-decoration:none; padding:8px 12px; border-radius:10px; font-weight:600;
    }
    h1{ margin:8px 0 16px; font-size:28px; letter-spacing:.04em; }
    .grid{
      display:grid; grid-template-columns:1fr 1fr; gap:20px;
    }
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background:var(--card-bg); border:1px solid var(--border);
      border-radius:16px; padding:16px 16px; box-shadow:0 1px 0 rgba(0,0,0,.02);
    }
    .card h2{ margin:0 0 10px; font-size:20px; }
    .muted{ color:var(--muted); }
    .list{ margin:8px 0 0; padding-left:18px; }
    .list li{ margin:8px 0; }

    .pill{
      display:inline-block; padding:4px 10px; border-radius:999px;
      background:var(--brand); color:#fff; font-size:12px; font-weight:700;
      vertical-align:middle;
    }

    .link-card{
      display:block; padding:12px 14px; border-radius:12px;
      background:#f9fafb; color:inherit; text-decoration:none;
      border:1px solid var(--border); transition:.15s;
    }
    .link-card:hover{ background:#f3f4f6; border-color:#d1d5db; }
    .title-line{ font-weight:700; font-size:17px; margin-bottom:6px; }
    .sub-line{ color:#374151; font-size:14px; }

    .mail{ color:#374151; }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- ä¸Šæ–¹å·¥å…·åˆ— -->
    <div class="nav">
      <a class="back" href="../index.html">â† å›é¦–é </a>
      <div class="mail" id="userEmail"></div>
    </div>

    <h1>å­¸ç¿’æ§åˆ¶å°</h1>

    <div class="grid">

      <!-- ç¹¼çºŒæ’­æ”¾ -->
      <section class="card">
        <h2>
          ç¹¼çºŒæ’­æ”¾
          <span id="continueBadge" class="pill" style="display:none">æœªå®Œæˆ</span>
        </h2>
        <div id="continueBody" class="muted">ç›®å‰æ²’æœ‰æœªçœ‹å®Œçš„å½±ç‰‡ã€‚</div>
      </section>

      <!-- ä»Šæ—¥è¤‡ç¿’ -->
      <section class="card">
        <h2>ä»Šæ—¥è¤‡ç¿’</h2>
        <div class="muted" id="reviewToday">ä»Šæ—¥æ²’æœ‰åˆ°æœŸçš„è¤‡ç¿’é …ç›®ã€‚</div>
      </section>

      <!-- æœ€è¿‘çœ‹é -->
      <section class="card">
        <h2>æœ€è¿‘çœ‹é</h2>
        <ul id="recentList" class="list muted">
          <li>å°šç„¡è§€çœ‹ç´€éŒ„ã€‚</li>
        </ul>
      </section>

      <!-- æˆ‘çš„æ¸…å–® -->
      <section class="card">
        <h2>æˆ‘çš„æ¸…å–®</h2>
        <div class="muted" id="favBox">å°šæœªæ”¶è—ä»»ä½•å½±ç‰‡ã€‚</div>
      </section>

      <!-- å­¸ç¿’æ›²ç·šï¼ˆæœ€è¿‘ 7 å¤©ï¼‰ -->
      <section class="card" style="grid-column:1/-1">
        <h2>å­¸ç¿’æ›²ç·šï¼ˆæœ€è¿‘ 7 å¤©ï¼‰</h2>
        <div class="muted" id="learnCurveWrap">ï¼ˆé ç•™ï¼›ä¹‹å¾Œæ”¹ç‚º Chart.js æŠ˜ç·šåœ–ï¼‰</div>
      </section>
    </div>
  </div>

  <!-- ä¸»é‚è¼¯ï¼šç™»å…¥å®ˆé–€ + ç¹¼çºŒæ’­æ”¾ / æœ€è¿‘çœ‹é -->
  <script type="module">
    import { supabase } from '../supa.js';

    const emailEl   = document.getElementById('userEmail');
    const contBody  = document.getElementById('continueBody');
    const contBadge = document.getElementById('continueBadge');
    const recentUl  = document.getElementById('recentList');

    const fmtDate = (iso) => {
      const d = new Date(iso);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      return `${y}/${m}/${day} ${hh}:${mm}`;
    };

    // 1) å–å¾—ç™»å…¥ï¼ˆå®ˆé–€ï¼‰
    const { data:authData, error:authErr } = await supabase.auth.getUser();
    const user = authData?.user || null;
    if (!user) {
      alert('è«‹å…ˆç™»å…¥å¾Œå†ä½¿ç”¨å­¸ç¿’æ§åˆ¶å°');
      location.href = '../index.html';
      throw new Error('No session');
    }
    emailEl.textContent = user.email ?? '';

    // 2) æ’ˆ watch_logsï¼ˆRLS åƒ…å¯çœ‹åˆ°è‡ªå·±çš„ï¼‰
    const { data:logs, error:logErr } = await supabase
      .from('watch_logs')
      .select('video_slug, progress_pct, updated_at')
      .order('updated_at', { ascending:false })
      .limit(30);

    if (logErr) {
      console.warn('watch_logs è®€å–å¤±æ•—ï¼š', logErr.message || logErr);
    }

    if (!logs || logs.length === 0) {
      contBody.textContent = 'ç›®å‰æ²’æœ‰æœªçœ‹å®Œçš„å½±ç‰‡ã€‚';
      recentUl.innerHTML = '<li>å°šç„¡è§€çœ‹ç´€éŒ„ã€‚</li>';
    } else {
      // A. ç¹¼çºŒæ’­æ”¾ï¼šæ‰¾ç¬¬ä¸€å€‹é€²åº¦ < 100 çš„æ¢ç›®ï¼›è‹¥éƒ½ 100%ï¼Œå°±ç”¨æœ€æ–°ä¸€ç­†
      const cont = logs.find(l => (l.progress_pct ?? 0) < 100) ?? logs[0];
      const pct  = Math.round(cont.progress_pct ?? 0);
      const slug = cont.video_slug;
      const videoUrl = `../player.html?slug=${encodeURIComponent(slug)}`;

      contBody.innerHTML = `
        <a class="link-card" href="${videoUrl}">
          <div class="title-line">ğŸ¬ ${slug}</div>
          <div class="sub-line">ä¸Šæ¬¡é€²åº¦ <b>${pct}%</b>ã€€æ›´æ–°ï¼š${fmtDate(cont.updated_at)}</div>
        </a>
      `;
      contBadge.style.display = (pct >= 100) ? 'none' : 'inline-block';

      // B. æœ€è¿‘çœ‹éï¼šåˆ— 6 ç­†
      const items = logs.slice(0, 6).map(r => {
        const p = Math.round(r.progress_pct ?? 0);
        const s = r.video_slug;
        const url = `../player.html?slug=${encodeURIComponent(s)}`;
        return `
          <li>
            <a href="${url}" style="text-decoration:none;color:inherit;"><b>ğŸ ${s}</b></a>
            <span class="muted">ã€€é€²åº¦ ${p}%ãƒ»${fmtDate(r.updated_at)}</span>
          </li>
        `;
      }).join('');
      recentUl.innerHTML = items;
    }
  </script>

  <!-- Chart.js æŠ˜ç·šåœ–ï¼šå­¸ç¿’æ›²ç·šï¼ˆæœ€è¿‘ 7 å¤©ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { supabase } from '../supa.js';

    async function drawLearningCurve() {
      const wrap = document.getElementById('learnCurveWrap');
      if (!wrap) return;

      wrap.innerHTML = `
        <div style="width:100%;max-width:520px;margin:20px auto;">
          <canvas id="learnCurve"></canvas>
        </div>
        <div id="learnCurveEmpty" style="text-align:center;color:#888;font-size:.9rem;display:none;">
          å°šç„¡è³‡æ–™ï¼ˆéå» 7 å¤©æ²’æœ‰è§€çœ‹ç´€éŒ„ï¼‰
        </div>
      `;

      const { data:auth } = await supabase.auth.getUser();
      if (!auth?.user) {
        document.getElementById('learnCurveEmpty').style.display='block';
        return;
      }

      // æœ€è¿‘ 7 å¤©çš„èµ·å§‹ï¼ˆä»Šå¤©å¾€å› 6 å¤©ï¼‰
      const start = new Date();
      start.setDate(start.getDate() - 6);
      start.setHours(0,0,0,0);

      const { data:logs, error } = await supabase
        .from('watch_logs')
        .select('updated_at')
        .gte('updated_at', start.toISOString())
        .order('updated_at', { ascending:true });

      if (error || !logs || logs.length === 0) {
        document.getElementById('learnCurveEmpty').style.display='block';
        return;
      }

      // å»ºç«‹æ—¥æœŸ -> æ¬¡æ•¸ map
      const days = [...Array(7)].map((_,i)=>{
        const d=new Date(start);
        d.setDate(start.getDate()+i);
        return d.toISOString().slice(0,10);
      });
      const map = new Map();
      logs.forEach(r => {
        const d = new Date(r.updated_at);
        const key = d.toISOString().slice(0,10);
        map.set(key, (map.get(key) || 0) + 1);
      });

      const labels = days.map(d => d.slice(5)); // MM-DD
      const values = days.map(d => map.get(d) || 0);

      if (values.every(v => v === 0)) {
        document.getElementById('learnCurveEmpty').style.display='block';
        return;
      }

      new Chart(document.getElementById('learnCurve'),{
        type:'line',
        data:{
          labels,
          datasets:[{
            label:'è§€çœ‹æ¬¡æ•¸',
            data:values,
            borderWidth:2,
            pointRadius:3,
            tension:.3,
            fill:false
          }]
        },
        options:{
          plugins:{legend:{display:false}},
          scales:{
            y:{beginAtZero:true,ticks:{precision:0}},
            x:{ticks:{autoSkip:true,maxTicksLimit:7}}
          }
        }
      });
    }

    drawLearningCurve();
  </script>

  <!-- ä»Šæ—¥è¤‡ç¿’ï¼šæ¯é€±è¼ªæ›æ¨è–¦ 3 æ”¯å½±ç‰‡ -->
  <script type="module">
    import { supabase } from '../supa.js';

    const SUPA_ASSET_BASE =
      'https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/assets';

    function normalizeSlug(slug) {
      if (!slug) return '';
      if (slug === 'story-mid-autumn-festival') return 'mid-autumn';
      if (slug === 'story-hou-yi-ten-suns') return 'houyi';
      return slug;
    }

    function resolveThumb(v) {
      const slug = normalizeSlug(v.slug);
      const cat  = v.category || 'story';

      // story é¡å‹ï¼šassets/story/{slug}.jpg
      if (cat === 'story') {
        return `${SUPA_ASSET_BASE}/story/${slug}.jpg`;
      }

      // pro é¡å‹ï¼šä¾‹å¦‚ pro-movie / pro-music / pro-news
      if (cat && cat.startsWith('pro-')) {
        const sub = cat.split('-')[1] || 'movie';
        return `${SUPA_ASSET_BASE}/pro/${sub}/${slug}.jpg`;
      }

      // å…¶é¤˜æš«ç”¨é è¨­åœ–
      return '../img/video-thumb.png';
    }

    function getWeekNumber(d = new Date()) {
      d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      const weekNo = Math.ceil(((d - yearStart) / 86400000 + yearStart.getUTCDay() + 1) / 7);
      return weekNo;
    }

    async function loadWeeklyRecommendations() {
      const recArea = document.getElementById('reviewToday');
      if (!recArea) return;

      recArea.textContent = 'è¼‰å…¥æ¨è–¦ä¸­â€¦';

      const { data, error } = await supabase
        .from('video_meta')
        .select('slug,title,category,thumbnail_url,active')
        .eq('active', true)
        .order('created_at', { ascending: false });

      if (error || !data || data.length === 0) {
        recArea.textContent = 'ç›®å‰æ²’æœ‰æ¨è–¦å½±ç‰‡ã€‚';
        return;
      }

      const week = getWeekNumber();
      const shuffled = [...data].sort((a, b) =>
        ((a.slug.charCodeAt(0) + week) % 37) - ((b.slug.charCodeAt(0) + week) % 37)
      );
      const picks = shuffled.slice(0, 3);

      recArea.innerHTML = picks.map(v => {
        const realSlug = normalizeSlug(v.slug);
        const thumb = resolveThumb(v);
        return `
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
          <img src="${thumb}"
               style="width:60px;height:40px;object-fit:cover;border-radius:6px;">
          <div>
            <a href="../player.html?slug=${encodeURIComponent(realSlug)}"
               style="font-weight:600;color:#1e40af;text-decoration:none;">${v.title || realSlug}</a>
            <div class="muted">${v.category || 'story'}</div>
          </div>
        </div>
      `;
      }).join('');
    }

    loadWeeklyRecommendations();
  </script>

  <!-- æˆ‘çš„æ¸…å–®ï¼šfavorite_videos -->
  <script type="module">
    import { supabase } from '../supa.js';

    async function loadFavorites() {
      const favBox = document.getElementById('favBox');
      if (!favBox) return;

      favBox.textContent = 'è®€å–ä¸­â€¦';

      const { data:auth } = await supabase.auth.getUser();
      if (!auth?.user) {
        favBox.textContent = 'è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹æ”¶è—å½±ç‰‡ã€‚';
        return;
      }

      const { data, error } = await supabase
        .from('favorite_videos')
        .select('video_slug, created_at')
        .eq('user_id', auth.user.id)
        .order('created_at', { ascending:false });

      if (error || !data || data.length === 0) {
        favBox.textContent = 'å°šæœªæ”¶è—ä»»ä½•å½±ç‰‡ã€‚';
        return;
      }

      favBox.innerHTML = data.map(v => `
        <div style="margin-bottom:8px;">
          <a href="../player.html?slug=${encodeURIComponent(v.video_slug)}"
             style="text-decoration:none;color:#2563eb;font-weight:600;">${v.video_slug}</a>
          <span class="muted" style="margin-left:4px;">${new Date(v.created_at).toLocaleString()}</span>
        </div>
      `).join('');
    }

    loadFavorites();
  </script>

</body>
</html>









































