<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>學習控制台</title>

  <!-- 你原本的 CSS / UI 樣式（保留） -->
  <link rel="stylesheet" href="../styles.css" />

  <!-- Chart.js（只為學習曲線用） -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* 只控制學習曲線卡片的尺寸位置，不動其他區塊 */
    .learning-curve-card {
      /* 原本卡片樣式保留，這裡確保在頁面最下方即可 */
    }
    .learning-curve-wrap {
      width: 30%;              /* 縮小為原來 30% */
      min-width: 280px;        /* 手機太小時給個下限 */
      margin: 12px auto 8px;   /* 置中、靠底 */
    }
    .learning-curve-empty {
      text-align: center;
      color: #999;
      font-size: 0.95rem;
      padding: 10px 0 18px;
    }
  </style>
</head>
<body>
  <main class="wrap">
    <!-- =========================
         你的原本四個卡片：繼續播放 / 今日複習 / 最近看過 / 我的清單
         （這裡省略；照你現有檔案內容即可，無需變動）
         ========================= -->

    <!-- 學習曲線（最近 7 天） -->
    <section class="card learning-curve-card">
      <div class="card-head">
        <h2>學習曲線（最近 7 天）</h2>
      </div>

      <div class="card-body">
        <!-- 圖表容器：縮小為 30% 並置中 -->
        <div class="learning-curve-wrap">
          <canvas id="learnCurve" height="160"></canvas>
        </div>
        <!-- 若無資料，這段會被顯示；有資料會被隱藏 -->
        <div id="learnCurveEmpty" class="learning-curve-empty" style="display:none;">
          尚無資料（過去 7 天沒有觀看紀錄）
        </div>
      </div>
    </section>
  </main>

  <!-- 你專案原本的 Supabase 封裝（保留此路徑） -->
  <script type="module">
    import { supabase } from '../supa.js';

    // 產生最近 7 天（含今天）的日期字串（台北時區），回傳陣列：['10/15','10/16',...]
    function buildLast7DaysLabels() {
      const labels = [];
      const tz = 'Asia/Taipei';
      for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        // 用台北時區格式化到 MM/DD
        const fmt = new Intl.DateTimeFormat('zh-TW', {
          timeZone: tz, month: '2-digit', day: '2-digit'
        }).format(d);
        labels.push(fmt);
      }
      return labels;
    }

    // 把 view 回來的日期（YYYY-MM-DD）轉成與 labels 相同格式（MM/DD）
    function ymdToMMDD(ymd) {
      // ymd 可能已是「YYYY-MM-DD」（view 裡 date(updated_at at time zone 'Asia/Taipei')）
      const [y, m, d] = ymd.split('-');
      return `${m}/${d}`;
    }

    async function drawLearningCurve() {
      // 先確認登入；若未登入就不畫
      const { data: auth } = await supabase.auth.getUser();
      if (!auth?.user) {
        // 未登入就保持預設（可視需要導向登入）
        document.getElementById('learnCurveEmpty').style.display = 'block';
        return;
      }

      // 從你建立的檢視取資料（過去 7 天 / 目前使用者 / 已套 RLS）
      // 這個 view 名稱就是你之前建立的：public.v_watch_events_last7
      const { data, error } = await supabase
        .from('v_watch_events_last7')
        .select('*')
        .order('d');        // 由舊到新

      const canvas = document.getElementById('learnCurve');
      const empty = document.getElementById('learnCurveEmpty');

      if (error) {
        console.warn('load v_watch_events_last7 error:', error);
        empty.textContent = '載入失敗。';
        empty.style.display = 'block';
        return;
      }

      // 準備 labels（最近 7 天，每天一個點）
      const labels = buildLast7DaysLabels();

      // 轉成 { 'MM/DD': 次數 } 的快取
      const map = {};
      (data || []).forEach(row => {
        const key = ymdToMMDD(row.d);
        map[key] = row.events ?? 0;
      });

      // 依 labels 組成 dataset（缺的日子補 0）
      const points = labels.map(lab => map[lab] ?? 0);

      const noData = points.every(v => v === 0);
      if (noData) {
        empty.style.display = 'block';
        canvas.style.display = 'none';
        return;
      } else {
        empty.style.display = 'none';
        canvas.style.display = 'block';
      }

      // 真的開始畫圖
      const ctx = canvas.getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: '每日觀看次數',
            data: points,
            tension: 0.3,
            borderWidth: 2,
            pointRadius: 3,
            fill: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,     // 由容器高度控制
          plugins: {
            legend: { display: false },
            tooltip: { mode: 'index', intersect: false }
          },
          scales: {
            x: { grid: { display: false }},
            y: {
              beginAtZero: true,
              ticks: { precision: 0 }
            }
          }
        }
      });
    }

    // 畫圖
    drawLearningCurve();
  </script>
</body>
</html>
















