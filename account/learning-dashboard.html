<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>學習曲線（最近 30 天）｜BookWide</title>
  <style>
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      background:#f4f6fb;
      color:#111827;
    }
    .wrap{
      max-width:1080px;
      margin:24px auto 40px;
      padding:0 16px;
    }
    h1{
      margin:0 0 16px;
      font-size:24px;
      letter-spacing:.08em;
    }
    .card{
      background:#fff;
      border-radius:18px;
      box-shadow:0 10px 30px rgba(15,23,42,.08);
      border:1px solid rgba(148,163,184,.25);
      padding:18px 18px 14px;
    }

    /* 上方每日綠圈 */
    .day-strip{
      display:flex;
      align-items:flex-start;
      gap:10px;
      overflow-x:auto;
      padding:4px 0 8px;
      margin-bottom:10px;
    }
    .day-item{
      flex:0 0 auto;
      text-align:center;
      font-size:11px;
      color:#4b5563;
    }
    .day-circle{
      width:32px;
      height:32px;
      border-radius:999px;
      border:3px solid #22c55e;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      font-weight:600;
      color:#16a34a;
      margin-bottom:4px;
      background:#ecfdf3;
    }
    .day-date{
      white-space:nowrap;
    }

    /* 下方折線圖容器 */
    .chart-box{
      border-radius:16px;
      background:#fff;
      padding:10px 4px 4px;
    }
    .chart-title-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 8px 4px;
      font-size:12px;
      color:#6b7280;
    }
    .chart-title-row span:last-child{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      background:#eff6ff;
      color:#1d4ed8;
    }
    canvas{
      width:100%;
      max-height:280px;
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>學習曲線（最近 30 天）</h1>

  <section class="card">
    <!-- 上：每日整體分數 -->
    <div id="dayStrip" class="day-strip"></div>

    <!-- 下：五分類折線圖 -->
    <div class="chart-box">
      <div class="chart-title-row">
        <span>完成度（5 天平滑平均）</span>
        <span>點選圖例可顯示 / 隱藏分類</span>
      </div>
      <canvas id="learnChart"></canvas>
    </div>
  </section>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  /******************************************************************
   * 1. 這裡目前用「假資料 Demo」，
   *    之後你要接 watch_logs 真實資料，只要把 days / rawCategories 替換掉即可
   ******************************************************************/
  const days = Array.from({length:30}, (_,i)=>{
    const d = new Date();
    d.setDate(d.getDate() - (29 - i)); // 由 30 天前 → 今天
    const mm = d.getMonth()+1;
    const dd = d.getDate();
    return `${mm}/${dd}`;
  });

  // 原始完成度（0–100），之後可由 Supabase watch_logs 算出來替換
  const rawCategories = {
    story: Array.from({length:30}, ()=> 20 + Math.random()*80),
    music: Array.from({length:30}, ()=> 20 + Math.random()*80),
    movie: Array.from({length:30}, ()=> 20 + Math.random()*80),
    news:  Array.from({length:30}, ()=> 20 + Math.random()*80),
    pro:   Array.from({length:30}, ()=> 20 + Math.random()*80),
  };

  /******************************************************************
   * 2. 5 天移動平均（平滑）
   ******************************************************************/
  function movingAverage(arr, windowSize){
    const result = [];
    for(let i=0;i<arr.length;i++){
      let start = Math.max(0, i - windowSize + 1);
      let sum = 0;
      let count = 0;
      for(let j=start;j<=i;j++){
        sum += arr[j];
        count++;
      }
      result.push(sum / count);
    }
    return result;
  }

  const windowSize = 5; // 5 天平滑
  const categories = {
    story: movingAverage(rawCategories.story, windowSize),
    music: movingAverage(rawCategories.music, windowSize),
    movie: movingAverage(rawCategories.movie, windowSize),
    news:  movingAverage(rawCategories.news, windowSize),
    pro:   movingAverage(rawCategories.pro, windowSize),
  };

  /******************************************************************
   * 3. 上方綠圈：每日「整體平均」分數
   ******************************************************************/
  const dayStrip = document.getElementById("dayStrip");
  for(let i=0;i<days.length;i++){
    // 五分類平均值
    const avg = (
      rawCategories.story[i] +
      rawCategories.music[i] +
      rawCategories.movie[i] +
      rawCategories.news[i]  +
      rawCategories.pro[i]
    ) / 5;

    const score = Math.round(avg); // 0–100

    const div = document.createElement("div");
    div.className = "day-item";
    div.innerHTML = `
      <div class="day-circle">${score}</div>
      <div class="day-date">${days[i]}</div>
    `;
    dayStrip.appendChild(div);
  }

  /******************************************************************
   * 4. Chart.js：五分類可顯示 / 隱藏，Y 軸 0–100%，平滑線
   ******************************************************************/
  const ctx = document.getElementById("learnChart").getContext("2d");

  const COLORS = {
    story:"#3b82f6",
    music:"#10b981",
    movie:"#6366f1",
    news:"#f59e0b",
    pro:"#ec4899",
  };

  const chart = new Chart(ctx,{
    type:"line",
    data:{
      labels:days,
      datasets:[
        {
          label:"Story",
          data:categories.story,
          borderColor:COLORS.story,
          backgroundColor:COLORS.story,
          tension:0.35,
          pointRadius:3,
          pointHoverRadius:4,
          pointHitRadius:8,
        },
        {
          label:"Music",
          data:categories.music,
          borderColor:COLORS.music,
          backgroundColor:COLORS.music,
          tension:0.35,
          pointRadius:3,
          pointHoverRadius:4,
          pointHitRadius:8,
        },
        {
          label:"Movie",
          data:categories.movie,
          borderColor:COLORS.movie,
          backgroundColor:COLORS.movie,
          tension:0.35,
          pointRadius:3,
          pointHoverRadius:4,
          pointHitRadius:8,
        },
        {
          label:"News",
          data:categories.news,
          borderColor:COLORS.news,
          backgroundColor:COLORS.news,
          tension:0.35,
          pointRadius:3,
          pointHoverRadius:4,
          pointHitRadius:8,
        },
        {
          label:"Pro",
          data:categories.pro,
          borderColor:COLORS.pro,
          backgroundColor:COLORS.pro,
          tension:0.35,
          pointRadius:3,
          pointHoverRadius:4,
          pointHitRadius:8,
        },
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      interaction:{
        mode:"nearest",
        intersect:false
      },
      plugins:{
        legend:{
          display:true,
          position:"bottom",
          labels:{
            usePointStyle:true,
            padding:16,
            font:{size:11}
          }
          // 不用特別寫 onClick，Chart.js 內建就可以顯示 / 隱藏資料集
        },
        tooltip:{
          callbacks:{
            label:(ctx)=>{
              const v = ctx.parsed.y ?? 0;
              return `${ctx.dataset.label}: ${Math.round(v)}%`;
            }
          }
        }
      },
      scales:{
        x:{
          grid:{display:false},
          ticks:{
            maxRotation:45,
            minRotation:45,
            autoSkip:true,
            maxTicksLimit:10
          }
        },
        y:{
          beginAtZero:true,
          suggestedMax:100,
          ticks:{
            stepSize:25,
            callback:(v)=> v+"%"
          },
          grid:{
            color:"#e5e7eb",
            lineWidth:0.8
          }
        }
      }
    }
  });
</script>
</body>
</html>






























































