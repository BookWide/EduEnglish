<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>學習控制台</title>
  <link rel="stylesheet" href="../style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
</head>
<body>
  <a href="../index.html" style="margin-left:1rem;">← 回首頁</a>
  <h1>學習控制台</h1>

  <main class="wrap">
    <!-- === 繼續播放 === -->
    <section id="continue-card" class="card">
      <h2>繼續播放 <span id="progress-label" style="font-size:0.8em;color:#666;">未完成 0%</span></h2>
      <div id="continue-info" style="margin-top:.3em;">目前尚無影片紀錄。</div>
    </section>

    <!-- === 今日複習 === -->
    <section class="card">
      <h2>今日複習</h2>
      <p>今日沒有到期的複習項目。</p>
    </section>

    <!-- === 最近看過 === -->
    <section class="card">
      <h2>最近看過</h2>
      <ul id="recent-list" style="padding-left:1.2em;"></ul>
    </section>

    <!-- === 學習曲線（最近 7 天） === -->
    <section class="card">
      <h2>學習曲線（最近 7 天）</h2>
      <canvas id="chart7" height="120"></canvas>
    </section>
  </main>

  <!-- ===== 主程式區 ===== -->
  <script type="module">
    import { supabase } from '../supa.js';

    /* --------------------------
       1️⃣ 取得使用者登入狀態
    --------------------------- */
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      alert('請先登入後再查看控制台');
      location.href = '../index.html';
      throw new Error('No session');
    }

    /* --------------------------
       2️⃣ 繼續播放與最近看過
    --------------------------- */
    const { data: logs, error } = await supabase
      .from('watch_logs')
      .select('video_slug, updated_at, progress')
      .eq('user_id', user.id)
      .order('updated_at', { ascending: false })
      .limit(10);

    const recentList = document.getElementById('recent-list');
    const contInfo = document.getElementById('continue-info');
    if (error) {
      console.warn(error);
      contInfo.textContent = '載入失敗。';
    } else if (!logs.length) {
      contInfo.textContent = '尚未觀看影片。';
    } else {
      // 最近看過
      recentList.innerHTML = logs.map(l => `
        <li>${l.video_slug}　
          <small>進度 ${l.progress ?? 0}%　
          ${new Date(l.updated_at).toLocaleString('zh-TW')}</small>
        </li>`).join('');

      // 繼續播放 (第一筆)
      const last = logs[0];
      contInfo.innerHTML = `
        上次看到：<strong>${last.video_slug}</strong><br>
        進度：${last.progress ?? 0}%　
        更新：${new Date(last.updated_at).toLocaleString('zh-TW')}
      `;
      document.getElementById('progress-label').textContent = `未完成 ${last.progress ?? 0}%`;

      // 讓整塊卡片可點
      document.querySelector('#continue-card')?.addEventListener('click', () => {
        location.href = `/EduEnglish/player.html?slug=${encodeURIComponent(last.video_slug)}`;
      });
    }

    /* --------------------------
       3️⃣ 學習曲線（最近7天）
    --------------------------- */
    const { data: chartData, error: e2 } = await supabase
      .from('v_watch_events_last7')
      .select('*')
      .order('d', { ascending: true });

    if (!e2 && chartData?.length) {
      const days = [...Array(7)].map((_, i) => {
        const d = new Date(); d.setDate(d.getDate() - (6 - i));
        return d.toISOString().slice(0, 10);
      });
      const map = new Map(chartData.map(r => [r.d, r.events]));
      const labels = days;
      const values = days.map(d => map.get(d) ?? 0);

      new Chart(document.getElementById('chart7'), {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: '觀看事件數',
            data: values,
            borderWidth: 2,
            tension: .3,
            fill: false
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
      });
    }
  </script>
</body>
</html>













