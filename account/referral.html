import { serve } from "https://deno.land/std@0.224.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

function json(status: number, body: unknown) {
  return new Response(JSON.stringify(body), {
    status,
    headers: { "Content-Type": "application/json; charset=utf-8" },
  });
}

// 跟你前端一致：沒有 ref_code 欄位時，用 seed 算穩定 5 碼
function stable5FromSeed(seed: string) {
  const s = String(seed || "");
  let h = 2166136261;
  for (let i = 0; i < s.length; i++) {
    h ^= s.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  const n = Math.abs(h) % 90000 + 10000;
  return String(n);
}

function mustEnv(name: string) {
  const v = Deno.env.get(name);
  if (!v) throw new Error(`Missing env: ${name}`);
  return v;
}

// 嘗試用「包含 original_cents」的 select；若欄位不存在就 fallback
async function selectOrdersWithFallback(supabase: any, referral_code: string) {
  const baseQuery = supabase
    .from("orders")
    .select("id, paid_at, buyer_id, referral_code, total_cents, original_cents")
    .eq("referral_code", referral_code)
    .not("paid_at", "is", null)
    .order("paid_at", { ascending: false });

  const r1 = await baseQuery;
  if (!r1.error) return { rows: r1.data as any[], usedOriginal: true };

  // fallback：沒有 original_cents 欄位
  const r2 = await supabase
    .from("orders")
    .select("id, paid_at, buyer_id, referral_code, total_cents")
    .eq("referral_code", referral_code)
    .not("paid_at", "is", null)
    .order("paid_at", { ascending: false });

  if (r2.error) throw r2.error;
  return { rows: r2.data as any[], usedOriginal: false };
}

serve(async (req) => {
  try {
    if (req.method !== "POST") return json(405, { ok: false, message: "Method Not Allowed" });

    const { referral_code, include_orders } = await req.json().catch(() => ({}));
    if (!referral_code) return json(400, { ok: false, message: "missing referral_code" });

    // 用「使用者 JWT」取出目前登入者
    const url = mustEnv("SUPABASE_URL");
    const anon = mustEnv("SUPABASE_ANON_KEY");
    const authClient = createClient(url, anon, {
      global: { headers: { Authorization: req.headers.get("Authorization") || "" } },
    });
    const { data: userRes, error: userErr } = await authClient.auth.getUser();
    if (userErr || !userRes?.user) return json(401, { ok: false, message: "unauthorized" });

    const user = userRes.user;
    const userId = user.id;

    // 用 SERVICE_ROLE 查 profiles / orders（繞過 RLS）
    const service = createClient(url, mustEnv("SUPABASE_SERVICE_ROLE_KEY"));

    // 取出「自己的推薦碼」：profiles.ref_code 或 profiles.referral_code；若無則用 email/userId 算
    let myCode = "";
    let email = user.email || "";

    // profiles 可能只有 email 或沒有 ref_code；用 try-catch 多策略
    {
      const tries = ["email, ref_code", "email, referral_code", "email"];
      for (const sel of tries) {
        const r = await service.from("profiles").select(sel).eq("id", userId).maybeSingle();
        if (!r.error && r.data) {
          email = r.data.email || email;
          myCode = String(r.data.ref_code || r.data.referral_code || "").trim();
          break;
        }
      }
    }
    if (!myCode) myCode = stable5FromSeed(email || userId);

    // ✅ 商用安全：只能查自己的推薦碼
    if (String(referral_code).trim() !== myCode) {
      return json(403, { ok: false, message: "forbidden: can only query your own referral_code" });
    }

    // 取「成功推薦」：paid_at not null & referral_code = myCode
    const { rows, usedOriginal } = await selectOrdersWithFallback(service, myCode);

    // ✅ 排除自推：buyer_id == 自己
    const filtered = rows.filter((r) => String(r.buyer_id || "") !== String(userId));

    // 分潤基準：若有 original_cents 則用 original_cents，否則用 total_cents
    const orders = filtered.map((r) => {
      const base = Number(r.original_cents ?? r.total_cents ?? 0);
      const commission = Math.round(base * 0.1);
      return {
        id: r.id,
        paid_at: r.paid_at,
        total_cents: Number(r.total_cents ?? 0),
        base_cents: base,
        commission_cents: commission,
      };
    });

    const count = orders.length;
    const commission_cents = orders.reduce((s, o) => s + (Number(o.commission_cents) || 0), 0);

    return json(200, {
      ok: true,
      referral_code: myCode,
      count,
      sum_twd: Math.round(commission_cents / 100),
      used_original_cents: usedOriginal,
      orders: include_orders ? orders : undefined,
    });
  } catch (e) {
    return json(500, { ok: false, message: String(e?.message || e) });
  }
});
































































