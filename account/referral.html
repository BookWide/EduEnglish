<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>推薦分潤｜BookWide</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#f4f6fb;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --brand:#2563eb;
      --brand2:#1d4ed8;
      --soft:#eef2ff;
      --radius:18px;
      --shadow:0 14px 40px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","Microsoft JhengHei",sans-serif;}
    a{color:inherit;text-decoration:none}
    .topbar{
      height:64px;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 18px;
      position:sticky; top:0; z-index:10;
      background:rgba(244,246,251,.85);
      backdrop-filter:saturate(160%) blur(10px);
      border-bottom:1px solid rgba(229,231,235,.6);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:800;
    }
    .dot{width:14px;height:14px;border-radius:999px;background:var(--brand); box-shadow:0 0 0 6px rgba(37,99,235,.12)}
    .actions{display:flex; gap:10px; align-items:center}
    .pill{
      height:40px; padding:0 14px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      display:inline-flex; align-items:center; justify-content:center;
      font-weight:700;
      cursor:pointer;
    }
    .pill.primary{
      background:var(--brand);
      color:#fff;
      border-color:transparent;
    }
    .wrap{max-width:1180px;margin:0 auto;padding:22px 18px 34px}
    h1{font-size:56px;letter-spacing:.5px;margin:22px 0 10px}
    .lead{color:var(--muted);line-height:1.7;max-width:760px;margin:0 0 18px}
    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 980px){
      h1{font-size:42px}
      .grid{grid-template-columns:1fr}
    }
    .card{
      background:var(--card);
      border:1px solid rgba(229,231,235,.9);
      border-radius:24px;
      box-shadow:var(--shadow);
      padding:18px;
    }
    .card h2{
      margin:0 0 10px;
      font-size:18px;
      letter-spacing:.4px;
    }
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .input{
      flex:1;
      min-width:260px;
      height:46px;
      border:1px solid var(--line);
      border-radius:14px;
      padding:0 14px;
      font-size:15px;
      background:#fff;
      outline:none;
    }
    .btn{
      height:46px;
      padding:0 16px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-weight:800;
    }
    .btn.primary{
      border-color:transparent;
      background:var(--brand);
      color:#fff;
    }
    .btn:active{transform:translateY(1px)}
    .codeBox{
      margin-top:12px;
      border-radius:18px;
      background:linear-gradient(180deg, rgba(37,99,235,.08), rgba(37,99,235,.03));
      border:1px dashed rgba(37,99,235,.35);
      padding:14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      flex-wrap:wrap;
    }
    .codeLeft{display:flex; align-items:center; gap:12px; flex-wrap:wrap}
    .label{color:var(--muted); font-weight:800}
    .chip{
      display:inline-flex; align-items:center; justify-content:center;
      height:40px; padding:0 14px;
      border-radius:999px;
      background:#111827;
      color:#fff;
      font-weight:900;
      letter-spacing:2px;
      font-size:16px;
      min-width:96px;
    }
    .status{
      color:var(--muted);
      font-weight:800;
    }
    .metrics{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 560px){
      .metrics{grid-template-columns:1fr}
    }
    .metricCard{
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      background:#fff;
    }
    .metricTitle{color:var(--muted); font-weight:900; margin-bottom:8px}
    .metricVal{font-size:40px; font-weight:950; letter-spacing:.4px}
    .metricVal small{font-size:18px; font-weight:900; color:var(--muted)}
    .loading{
      margin-top:14px;
      height:44px;
      border-radius:14px;
      border:1px solid var(--line);
      background:linear-gradient(90deg, rgba(37,99,235,.12), rgba(37,99,235,.03));
      display:flex; align-items:center;
      padding:0 14px;
      color:var(--muted);
      font-weight:900;
    }
    .tips{
      margin-top:12px;
      color:var(--muted);
      font-size:14px;
      line-height:1.6;
    }
    .tips b{color:var(--ink)}
    .sideList{margin:10px 0 0 18px; color:var(--muted); line-height:1.9; font-weight:700}
    .foot{margin-top:18px; text-align:center; color:#94a3b8; font-weight:800}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <span class="dot"></span>
      <span>BookWide</span>
    </div>
    <div class="actions">
      <a class="pill" href="../index.html">回首頁</a>
      <a class="pill" href="../pricing.html?plan=family">家庭方案</a>
      <a class="pill primary" href="../pricing.html">訂閱</a>
    </div>
  </div>

  <div class="wrap">
    <h1>推薦分潤</h1>
    <p class="lead">
      分享你的專屬連結給朋友／家人。<br>
      被推薦人享 <b>10% 折扣</b>；當對方付款成功後，你可累積 <b>10% 分潤</b>（以訂單 <b>實付金額</b> 計算）。<br>
      <span style="color:#475569;font-weight:800">（自推：不給折扣，也不計分潤）</span>
    </p>

    <div class="grid">
      <!-- Left -->
      <div class="card">
        <h2>專屬推薦連結（自動帶入推薦碼）</h2>

        <div class="row">
          <input id="link" class="input" readonly />
          <button id="btnCopyLink" class="btn primary" type="button">複製連結</button>
          <button id="btnHow" class="btn" type="button">怎麼分享給家人？</button>
        </div>

        <div class="codeBox">
          <div class="codeLeft">
            <span class="label">推薦碼：</span>
            <span id="codeChip" class="chip">—</span>
            <button id="btnCopyCode" class="btn" type="button">複製推薦碼</button>
          </div>
          <div class="status" id="loginStatus">登入狀態：—</div>
        </div>

        <div class="metrics">
          <div class="metricCard">
            <div class="metricTitle">成功推薦</div>
            <div class="metricVal"><span id="mCount">0</span> <small>位</small></div>
          </div>
          <div class="metricCard">
            <div class="metricTitle">累積分潤</div>
            <div class="metricVal"><span id="mAmount">0</span> <small>元</small></div>
          </div>
        </div>

        <div class="loading" id="loadingBar">正在讀取統計…</div>

        <div class="tips">
          小提醒：你的朋友透過連結進到 pricing / checkout 後，系統會自動帶入推薦碼；付款成功後分潤會自動累積。<br>
          若你看到金額沒有更新，通常是因為訂單尚未 <b>paid</b> 或後端尚未回寫訂單狀態。
        </div>
      </div>

      <!-- Right -->
      <div class="card">
        <h2>建議你這樣分享</h2>
        <ol class="sideList">
          <li>先按「複製連結」</li>
          <li>貼到 LINE／WeChat／Email／任何聊天軟體</li>
          <li>對方打開後會自動帶入推薦碼</li>
          <li>付款成功後，你的分潤會自動累積</li>
        </ol>

        <div class="tips" style="margin-top:14px">
          <b>統計依據（容錯）</b><br>
          會優先用 orders 表的 <b>ref_code / referral_code</b> 比對推薦碼；<br>
          成功定義：status ∈ {paid, active, success}，且買家不是自己（避免自推）。<br>
          分潤金額：優先使用 <b>commission_cents</b>；若沒有則用 <b>round(total_cents×10%)</b> 推算。
        </div>
      </div>
    </div>

    <div class="foot">BookWide · account/referral.html · v20251227-patch</div>
  </div>

  <!-- Prefer your shared supa.js if present -->
  <script src="../shared/supa.js"></script>

  <script>
    const $ = (id) => document.getElementById(id);

    function fmtInt(n){
      const x = Number(n||0);
      return isFinite(x) ? x.toLocaleString('zh-Hant-TW') : '0';
    }

    async function copyText(txt, btn){
      try{
        await navigator.clipboard.writeText(txt);
        const old = btn.textContent;
        btn.textContent = '已複製';
        setTimeout(()=>btn.textContent = old, 1200);
      }catch(e){
        const ta = document.createElement('textarea');
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
      }
    }

    function getSB(){
      if (window.BW && BW.sb) return BW.sb;

      const url = localStorage.getItem('SUPABASE_URL') || localStorage.getItem('supabase_url') || '';
      const anon = localStorage.getItem('SUPABASE_ANON_KEY') || localStorage.getItem('supabase_anon') || '';
      if (url && anon && window.supabase) return window.supabase.createClient(url, anon);

      return null;
    }

    async function requireAuthIfPossible(){
      if (window.BW && typeof BW.requireAuth === 'function') {
        await BW.requireAuth();
      }
    }

    function fiveDigitFromSeed(seed){
      let h = 2166136261 >>> 0;
      for (let i=0;i<seed.length;i++){
        h ^= seed.charCodeAt(i);
        h = Math.imul(h, 16777619) >>> 0;
      }
      const n = (h % 90000) + 10000;
      return String(n);
    }

    function getAuthFromLocal(){
      const email = (localStorage.getItem('auth_email') || '').trim();
      const uid   = (localStorage.getItem('auth_uid') || '').trim();
      return { email, uid };
    }

    async function ensureReferralCode(sb, user){
      try{
        const { data: prof, error } = await sb.from('profiles')
          .select('id,email,referral_code')
          .eq('id', user.id)
          .maybeSingle();
        if (!error && prof && prof.referral_code) return String(prof.referral_code);
      }catch(e){}

      const seed = (user.email || user.id || '').toLowerCase();
      const code = fiveDigitFromSeed(seed);

      try{
        await sb.from('referrals').upsert({ code, owner_id: user.id }, { onConflict: 'code' });
      }catch(e){}

      try{
        await sb.from('profiles').update({ referral_code: code }).eq('id', user.id);
      }catch(e){}

      return code;
    }

    function buildShareLink(code){
      const u = new URL('../pricing.html', location.href);
      u.searchParams.set('ref', code);
      return u.href;
    }

    function isSuccessStatus(s){
      const v = String(s||'').toLowerCase();
      return v === 'paid' || v === 'active' || v === 'success';
    }

    async function loadStats(sb, myUserId, code){
      const cols = [
        'id',
        'buyer_id',
        'status',
        'ref_code',
        'referral_code',
        'commission_cents',
        'total_cents',
        'created_at'
      ].join(',');

      const { data, error } = await sb
        .from('orders')
        .select(cols)
        .or(`ref_code.eq.${code},referral_code.eq.${code}`)
        .order('created_at', { ascending: false })
        .limit(2000);

      if (error) throw error;

      const rows = (data || [])
        .filter(r => isSuccessStatus(r.status))
        .filter(r => String(r.buyer_id||'') && String(r.buyer_id) !== String(myUserId));

      const buyers = new Set(rows.map(r => String(r.buyer_id)));
      const count = buyers.size;

      let sumCents = 0;
      for (const r of rows){
        const cc = Number(r.commission_cents || 0);
        if (cc && isFinite(cc)) sumCents += cc;
        else {
          const tc = Number(r.total_cents || 0);
          if (tc && isFinite(tc)) sumCents += Math.round(tc * 0.10);
        }
      }

      return { count, amount: Math.round(sumCents / 100) };
    }

    (async function main(){
      try{ await requireAuthIfPossible(); }catch(_){}

      const sb = getSB();
      if (!sb) {
        $('loadingBar').textContent = '找不到 Supabase 設定（缺少 shared/supa.js 或本機設定）。';
        return;
      }

      let user = null;
      try{
        const { data } = await sb.auth.getUser();
        user = data?.user || null;
      }catch(e){}

      if (!user) {
        const { uid, email } = getAuthFromLocal();
        if (uid) user = { id: uid, email };
      }

      if (!user || !user.id) {
        $('loginStatus').textContent = '登入狀態：未登入';
        $('loadingBar').textContent = '請先登入後再查看推薦分潤。';
        $('codeChip').textContent = '—';
        $('link').value = buildShareLink('00000');
        return;
      }

      $('loginStatus').textContent = '登入狀態：已登入';

      const code = await ensureReferralCode(sb, user);
      $('codeChip').textContent = code;
      const link = buildShareLink(code);
      $('link').value = link;

      $('btnCopyLink').addEventListener('click', () => copyText(link, $('btnCopyLink')));
      $('btnCopyCode').addEventListener('click', () => copyText(code, $('btnCopyCode')));
      $('btnHow').addEventListener('click', () => {
        alert('分享方式：\n1) 按「複製連結」\n2) 貼到 LINE / WeChat / Email\n3) 對方開啟後自動帶入推薦碼\n4) 付款成功後分潤會自動累積');
      });

      try{
        const s = await loadStats(sb, user.id, code);
        $('mCount').textContent = fmtInt(s.count);
        $('mAmount').textContent = fmtInt(s.amount);
        $('loadingBar').style.display = 'none';
      }catch(e){
        $('loadingBar').textContent = '讀取統計失敗（可能是 RLS/欄位/權限限制）。';
        console.error(e);
      }
    })();
  </script>
</body>
</html>

















































































