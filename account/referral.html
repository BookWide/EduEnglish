<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>推薦分潤｜BookWide</title>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#f4f6fb;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --brand:#2563eb;
      --soft:#eef2ff;
      --radius:18px;
      --shadow:0 14px 40px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);
      font-family:system-ui,-apple-system,"Segoe UI","Noto Sans TC","Microsoft JhengHei",sans-serif}
    a{text-decoration:none;color:inherit}
    .topbar{height:64px;display:flex;align-items:center;justify-content:space-between;
      padding:0 18px;position:sticky;top:0;background:rgba(244,246,251,.9);
      border-bottom:1px solid var(--line)}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .dot{width:14px;height:14px;border-radius:50%;background:var(--brand)}
    .pill{height:40px;padding:0 14px;border-radius:999px;border:1px solid var(--line);
      display:inline-flex;align-items:center;font-weight:800;background:#fff}
    .pill.primary{background:var(--brand);color:#fff;border:none}
    .wrap{max-width:1180px;margin:0 auto;padding:22px 18px}
    h1{font-size:48px;margin:18px 0}
    .lead{color:var(--muted);line-height:1.7}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:18px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);
      border-radius:24px;box-shadow:var(--shadow);padding:18px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .input{flex:1;min-width:260px;height:46px;border:1px solid var(--line);
      border-radius:14px;padding:0 14px}
    .btn{height:46px;padding:0 16px;border-radius:14px;
      border:1px solid var(--line);background:#fff;font-weight:900;cursor:pointer}
    .btn.primary{background:var(--brand);color:#fff;border:none}
    .codeBox{margin-top:12px;border-radius:18px;padding:14px;
      border:1px dashed var(--brand);background:linear-gradient(180deg,#eef2ff,#fff);
      display:flex;justify-content:space-between;flex-wrap:wrap;gap:12px}
    .chip{min-width:96px;height:40px;border-radius:999px;
      background:#111827;color:#fff;display:inline-flex;
      align-items:center;justify-content:center;font-weight:900;letter-spacing:2px}
    .metrics{margin-top:14px;display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .metric{border:1px solid var(--line);border-radius:18px;padding:14px}
    .metric .v{font-size:38px;font-weight:900}
    .loading{margin-top:14px;padding:12px;border-radius:14px;
      border:1px solid var(--line);background:#f8fafc;font-weight:900;color:var(--muted)}
    .foot{text-align:center;margin-top:18px;color:#94a3b8;font-weight:800}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand"><span class="dot"></span>BookWide</div>
    <div class="row">
      <a class="pill" href="../index.html">回首頁</a>
      <a class="pill primary" href="../pricing.html">訂閱</a>
    </div>
  </div>

  <div class="wrap">
    <h1>推薦分潤</h1>
    <p class="lead">
      被推薦人享 <b>10% 折扣</b>；付款成功後你可獲得 <b>10% 分潤</b>（以實付金額計）。
      <br><b>自推不計</b>
    </p>

    <div class="grid">
      <!-- Left -->
      <div class="card">
        <h3>專屬推薦連結</h3>
        <div class="row">
          <input id="link" class="input" readonly>
          <button id="copyLink" class="btn primary">複製連結</button>
        </div>

        <div class="codeBox">
          <div class="row">
            <b>推薦碼</b>
            <span id="code" class="chip">—</span>
            <button id="copyCode" class="btn">複製</button>
          </div>
          <div id="loginStatus">登入狀態：—</div>
        </div>

        <div class="metrics">
          <div class="metric">
            <div>成功推薦</div>
            <div class="v"><span id="cnt">0</span> 位</div>
          </div>
          <div class="metric">
            <div>累積分潤</div>
            <div class="v"><span id="amt">0</span> 元</div>
          </div>
        </div>

        <div id="loading" class="loading">讀取中…</div>
      </div>

      <!-- Right -->
      <div class="card">
        <h3>分享方式</h3>
        <ol>
          <li>複製連結</li>
          <li>貼給朋友</li>
          <li>對方付款成功</li>
          <li>你自動累積分潤</li>
        </ol>
      </div>
    </div>

    <div class="foot">BookWide · referral.html · fixed</div>
  </div>

  <!-- 共用 supa -->
  <script src="../shared/supa.js"></script>

  <script>
    const $ = id => document.getElementById(id);

    function fiveCode(seed){
      let h=0; for(let c of seed) h=(h*31+c.charCodeAt(0))>>>0;
      return String((h%90000)+10000);
    }

    function copy(t){
      navigator.clipboard.writeText(t).catch(()=>{});
    }

    function getSB(){
      if(window.BW?.sb) return BW.sb;
      const u=localStorage.getItem('SUPABASE_URL');
      const k=localStorage.getItem('SUPABASE_ANON_KEY');
      if(u&&k&&window.supabase) return supabase.createClient(u,k);
      return null;
    }

    async function main(){
      const sb=getSB();
      if(!sb){ $('loading').textContent='Supabase 未設定'; return; }

      const {data:{user}} = await sb.auth.getUser();

      if(!user){
        $('loginStatus').textContent='登入狀態：未登入';
        $('code').textContent='—';
        $('link').value=new URL('../pricing.html',location.href).href;
        $('loading').textContent='請登入後查看分潤';
        return;
      }

      $('loginStatus').textContent='登入狀態：已登入';

      let code;
      const {data:prof}=await sb.from('profiles')
        .select('referral_code').eq('id',user.id).maybeSingle();

      if(prof?.referral_code) code=prof.referral_code;
      else{
        code=fiveCode(user.email||user.id);
        await sb.from('referrals').upsert({code,owner_id:user.id});
        await sb.from('profiles').update({referral_code:code}).eq('id',user.id);
      }

      $('code').textContent=code;
      const link=new URL('../pricing.html',location.href);
      link.searchParams.set('ref',code);
      $('link').value=link.href;

      $('copyLink').onclick=()=>copy(link.href);
      $('copyCode').onclick=()=>copy(code);

      const {data:rows}=await sb.from('orders')
        .select('buyer_id,status,commission_cents,total_cents')
        .eq('referral_code',code);

      let buyers=new Set(), sum=0;
      (rows||[]).forEach(r=>{
        if(['paid','active','success'].includes((r.status||'').toLowerCase())
           && r.buyer_id!==user.id){
          buyers.add(r.buyer_id);
          sum += r.commission_cents
            ? r.commission_cents
            : Math.round((r.total_cents||0)*0.1);
        }
      });

      $('cnt').textContent=buyers.size;
      $('amt').textContent=Math.round(sum/100);
      $('loading').style.display='none';
    }

    main();
  </script>
</body>
</html>



















































































