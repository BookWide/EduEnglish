<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>推薦分潤 | BookWide</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#f7f9fc;color:#15202b}
    .wrap{max-width:960px;margin:40px auto;padding:0 16px}
    .card-box{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 2px 8px rgba(15,23,42,.04)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="mb-3"><a href="./account.html">← 回首頁</a></div>
    <h1 class="fw-bolder mb-4">推薦分潤</h1>

    <div class="alert alert-secondary">將專屬連結分享給朋友，當他們註冊並訂閱課程，你都能獲得分潤獎勵。</div>

    <div class="card-box p-4">
      <div class="mb-3">
        <label class="form-label">你的專屬連結</label>
        <div class="input-group">
          <input id="linkBox" class="form-control mono" readonly value="">
          <button id="copyBtn" class="btn btn-dark" type="button">複製</button>
        </div>
      </div>

      <div class="mb-2">
        <span class="me-2">推薦碼：</span>
        <span id="refCode" class="badge bg-dark fs-6">—</span>
      </div>

      <ul class="mt-3 small text-muted">
        <li>使用自己的推薦碼下單：只享折扣，不給分潤。</li>
        <li>他人經你的推薦碼下單：折扣 + 分潤 均適用。</li>
        <li>異常或濫用行為（例如同帳號自推），將不計入分潤。</li>
      </ul>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supa.js';

    const linkBox = document.getElementById('linkBox');
    const copyBtn = document.getElementById('copyBtn');
    const refCodeUI = document.getElementById('refCode');

    function deriveCodeFromUUID(uuid){
      // 固定可復現的 5 碼：取 UUID 的數字部分最後 5 碼，不足則補 Date 雜湊
      let digits = (uuid||'').replace(/\D/g,'');
      if(digits.length < 5){
        digits = (digits + String(Date.now())).replace(/\D/g,'');
      }
      return digits.slice(-5);
    }

    async function ensureRefCode(user){
      // 讀自己的 profiles.ref_code；若無→產生→寫回
      const { data: row, error } = await supabase
        .from('profiles')
        .select('ref_code')
        .eq('id', user.id)
        .single();

      let code = row?.ref_code || '';
      if(!code){
        code = deriveCodeFromUUID(user.id);
        // upsert 自己這筆（若你的 RLS 僅允許更新自己的列，這樣是安全的）
        await supabase.from('profiles')
          .upsert({ id: user.id, email: user.email || null, ref_code: code }, { onConflict:'id' });
      }
      return code;
    }

    function setLink(code){
      const url = new URL('https://bookwide.github.io/EduEnglish/pricing.html');
      url.searchParams.set('ref', code);
      linkBox.value = url.toString();
      refCodeUI.textContent = code;
    }

    async function init(){
      const { data:auth } = await supabase.auth.getUser();
      if(!auth?.user){
        linkBox.value = '請先登入以取得您的推薦連結';
        copyBtn.disabled = true;
        return;
      }
      const code = await ensureRefCode(auth.user);
      setLink(code);
    }

    copyBtn.addEventListener('click', ()=>{
      linkBox.select();
      document.execCommand?.('copy');
      navigator.clipboard?.writeText(linkBox.value);
      copyBtn.textContent = '已複製';
      setTimeout(()=>copyBtn.textContent='複製',1200);
    });

    init();
  </script>
</body>
</html>
























