<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>學習控制台（診斷版）</title>
  <style>
    body{font-family:"Noto Sans TC",sans-serif;background:#f6f7fb;color:#1f2937;margin:0;padding:20px;}
    h1{margin:0 0 20px}
    section{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:16px;margin-bottom:14px}
    pre{background:#111;color:#0f0;padding:10px;border-radius:8px;white-space:pre-wrap;word-break:break-word;max-height:300px;overflow:auto}
  </style>
</head>
<body>
  <h1>學習控制台（診斷版）</h1>

  <section>
    <h3>狀態</h3>
    <div id="status">初始化中…</div>
  </section>

  <section>
    <h3>最近看過</h3>
    <div id="recent">讀取中…</div>
  </section>

  <section>
    <h3>診斷輸出</h3>
    <pre id="log"></pre>
  </section>

  <script type="module">
    import { supabase } from '../supa.js';
    const S = document.querySelector('#status');
    const R = document.querySelector('#recent');
    const L = document.querySelector('#log');
    const log = (...a)=>{console.log(...a);L.textContent+=a.map(x=>typeof x==='object'?JSON.stringify(x,null,2):x).join(' ')+'\\n';};

    async function main(){
      const {data:{session},error} = await supabase.auth.getSession();
      if(error){S.textContent='auth錯誤';log(error);return;}
      const user=session?.user;
      if(!user){S.textContent='❌ 尚未登入';return;}
      S.textContent='✅ 已登入 '+user.email;

      let rows=[];
      try{
        const r1=await supabase.from('watch_logs').select('video_slug,progress_pct,updated_at,email,user_id').eq('user_id',user.id).order('updated_at',{ascending:false}).limit(10);
        if(r1.error)log('user_id查錯',r1.error);else rows=r1.data||[];
        if(rows.length===0){
          const r2=await supabase.from('watch_logs').select('video_slug,progress_pct,updated_at,email').eq('email',user.email).order('updated_at',{ascending:false}).limit(10);
          if(r2.error)log('email查錯',r2.error);else rows=r2.data||[];
        }
      }catch(e){log('例外',e);}
      log('watch_logs筆數',rows.length,rows);
      if(rows.length===0){R.textContent='尚無觀看紀錄或被RLS擋';return;}

      // 片名補上 index.json
      let map={};
      try{
        const res=await fetch('../index.json',{cache:'no-store'});
        if(res.ok){
          const j=await res.json();
          if(Array.isArray(j))for(const it of j)if(it.slug)map[it.slug]=it.title||it.name||it.slug;
        }
      }catch(e){log('index.json讀取失敗',e);}

      R.innerHTML='';
      rows.forEach(r=>{
        const title=map[r.video_slug]||r.video_slug;
        const p=Math.round(r.progress_pct||0);
        const div=document.createElement('div');
        div.textContent=`${title} 進度${p}% (${r.updated_at})`;
        R.appendChild(div);
      });
    }
    main();
  </script>
</body>
</html>
