<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>帳號／個人資料</title>

  <!-- Supabase Config (請改成你的專案資料) -->
  <script>
    window.SB_URL  = window.SB_URL  || "https://jeajrwpmrgczimmrflxo.supabase.co";
    window.SB_ANON = window.SB_ANON || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
  </script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { background:#0f172a; color:#fff; font-family:sans-serif; padding:2em; }
    .card { background:#1e293b; padding:1.5em; border-radius:1em; max-width:600px; margin:auto; }
    input,button { padding:0.5em; border-radius:0.5em; border:none; width:100%; margin:0.3em 0; }
    button { background:#3b82f6; color:white; cursor:pointer; }
    img { border-radius:50%; width:100px; height:100px; object-fit:cover; display:block; margin:auto; }
    h1 { text-align:center; }
  </style>
</head>

<body>
  <div class="card">
    <h1>個人資料</h1>
    <img id="avatar_preview" src="" alt="頭像預覽">
    <input type="file" id="avatar_file" accept="image/*">
    <input id="full_name" placeholder="姓名 / 暱稱">
    <input id="phone" placeholder="聯絡電話">
    <input id="line_id" placeholder="LINE ID">
    <input id="wechat_id" placeholder="WeChat ID">
    <input id="address" placeholder="地址">
    <button id="saveProfile">完成並儲存</button>
    <button id="reloadBtn">重新載入</button>
  </div>

  <script>
    const supabase = window.supabase.createClient(window.SB_URL, window.SB_ANON);
    window.__profile = {
      async loadProfile() {
        const user = (await supabase.auth.getUser()).data.user;
        if (!user) return alert("請先登入");
        const { data, error } = await supabase.from("profiles").select("*").eq("id", user.id).maybeSingle();
        if (error) return console.error(error);
        if (!data) return console.warn("No profile found.");
        for (const key of ["full_name","phone","line_id","wechat_id","address"]) {
          const el = document.getElementById(key);
          if (el) el.value = data[key] || "";
        }
        if (data.avatar_url) document.getElementById("avatar_preview").src = data.avatar_url;
        console.log("Profile loaded:", data);
      },

      async saveProfile() {
        const user = (await supabase.auth.getUser()).data.user;
        if (!user) return alert("請先登入");
        let avatar_url = null;
        const fileInput = document.getElementById("avatar_file");
        if (fileInput.files.length > 0) {
          const file = fileInput.files[0];
          const filePath = `${user.id}/${file.name}`;
          const { error: uploadError } = await supabase.storage.from("avatars").upload(filePath, file, { upsert: true });
          if (uploadError) return alert("上傳失敗：" + uploadError.message);
          const { data } = supabase.storage.from("avatars").getPublicUrl(filePath);
          avatar_url = data.publicUrl;
        }
        const updateData = {
          id: user.id,
          full_name: document.getElementById("full_name").value,
          phone: document.getElementById("phone").value,
          line_id: document.getElementById("line_id").value,
          wechat_id: document.getElementById("wechat_id").value,
          address: document.getElementById("address").value,
        };
        if (avatar_url) updateData.avatar_url = avatar_url;
        const { error } = await supabase.from("profiles").upsert(updateData);
        if (error) return alert("儲存失敗：" + error.message);
        alert("✅ 已保存！");
        console.log("Profile saved:", updateData);
      }
    };

    document.getElementById("saveProfile").addEventListener("click", e => window.__profile.saveProfile(e));
    document.getElementById("reloadBtn").addEventListener("click", e => window.__profile.loadProfile(e));
    window.addEventListener("DOMContentLoaded", () => window.__profile.loadProfile());
  </script>
  <!-- ====== Profile Page Quick Patch (drop-in) ====== -->
<style>
  :root{
    --bg:#0f172a;          /* 背景色（深藍） */
    --panel:#111827;       /* 卡片色 */
    --text:#e5e7eb;        /* 文字色 */
    --muted:#9ca3af;       /* 次要文字 */
    --primary:#3b82f6;     /* 主色（按鈕/重點） */
    --primary-900:#1e3a8a;
    --border:#1f2937;
    --radius:18px;
  }
  html,body{
    background:var(--bg);
    color:var(--text);
    font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,
                 "Helvetica Neue","Noto Sans","Microsoft JhengHei",Arial,sans-serif;
    margin:0;
  }
  .profile-wrap{
    max-width: 760px;
    margin: 28px auto 46px;
    padding: 0 16px;
  }
  .profile-card{
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 28px;
    box-shadow: 0 10px 30px rgba(0,0,0,.25);
  }
  .profile-title{
    font-size: 40px;
    font-weight: 800;
    text-align: center;
    margin: 4px 0 22px;
    letter-spacing: .06em;
  }
  .avatar-box{
    display:flex; align-items:center; justify-content:center; margin: 4px 0 18px;
  }
  .avatar{
    width: 120px; height:120px; border-radius: 999px;
    object-fit: cover; border: 3px solid rgba(255,255,255,.1);
    box-shadow: 0 6px 18px rgba(0,0,0,.35);
  }

  /* 上傳按鈕（隱藏原生 input[file]，改用漂亮的 label） */
  .upload-row{
    display:flex; gap:10px; align-items:center; justify-content:center; margin: 8px 0 20px;
    flex-wrap: wrap;
  }
  input[type="file"].hidden-file{ position:absolute; left:-9999px; }
  .btn-upload{
    background: transparent; border:1px dashed var(--border); color:var(--text);
    padding:10px 14px; border-radius: 12px; cursor:pointer;
  }
  .hint{ color:var(--muted); font-size: 14px; }

  /* 欄位樣式：不用改 HTML，也能變漂亮 */
  .fields{ display: grid; grid-template-columns: 1fr; gap: 12px; margin-top:4px; }
  @media (min-width:720px){ .fields{ grid-template-columns: 1fr; } }
  .fields input[type="text"],
  .fields input[type="tel"],
  .fields input[type="number"],
  .fields input[type="email"]{
    width:100%; box-sizing:border-box;
    background:#0b1220; color:var(--text);
    border:1px solid var(--border); border-radius:12px;
    padding:14px 16px; outline:none; font-size:16px;
    transition: border-color .15s, box-shadow .15s;
  }
  .fields input:focus{
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(59,130,246,.15);
  }

  /* 按鈕 */
  .actions{ display:grid; gap:10px; margin-top:16px; }
  .btn{
    width:100%; border:0; border-radius:12px; padding:14px 18px; font-size:16px; font-weight:700;
    cursor:pointer; transition: transform .04s ease, opacity .15s;
  }
  .btn-primary{
    background: var(--primary); color: #fff;
  }
  .btn-primary:active{ transform: translateY(1px); }
  .btn-secondary{
    background: transparent; color:#e5e7eb; border:1px solid var(--border);
  }
  .btn-secondary:active{ transform: translateY(1px); }

  /* 小提示條 */
  .toast{
    position: fixed; left: 50%; bottom: 20px; transform: translateX(-50%);
    background: rgba(17,24,39,.95); color:#e5e7eb; border:1px solid var(--border);
    padding:10px 14px; border-radius:12px;
    box-shadow:0 8px 24px rgba(0,0,0,.35);
    opacity:0; pointer-events:none; transition:opacity .2s, transform .2s;
  }
  .toast.show{ opacity:1; transform: translateX(-50%) translateY(-6px); }
</style>

<div class="profile-wrap">
  <div class="profile-card">
    <div class="profile-title">個人資料</div>

    <div class="avatar-box">
      <!-- 你的頭像 img 加上 id="avatarImg" 即可預覽 -->
      <img id="avatarImg" class="avatar" src="" alt="avatar" onerror="this.src=this.dataset.fallback" data-fallback="https://dummyimage.com/240x240/1f2937/e5e7eb&text=Avatar"/>
    </div>

    <div class="upload-row">
      <!-- 把原本的 input[type=file] 加上 class="hidden-file" 與 id="avatarInput" -->
      <input id="avatarInput" type="file" accept="image/*" class="hidden-file">
      <label class="btn-upload" for="avatarInput">選擇檔案</label>
      <span id="fileName" class="hint">未選擇任何檔案</span>
    </div>

    <!-- 這一塊不用改你原本 input 的 name / value，只需把它們包在 .fields 裡即可；或直接保持原本結構也會被套樣式 -->
    <div class="fields" id="profileFields">
      <!-- 你的原本 input 放這（會自動吃到樣式） -->
      <!-- 範例： <input type="text" value="RAYMOND"> -->
    </div>

    <div class="actions">
      <!-- 把你的「完成並儲存」、「重新載入」按鈕加上相同 class 即可得到樣式 -->
      <button id="btnSave" class="btn btn-primary">完成並儲存</button>
      <button id="btnReload" class="btn btn-secondary">重新載入</button>
    </div>
  </div>
</div>

<div id="toast" class="toast">已儲存完成</div>

<script>
  // ========== 頭像即時預覽 ==========
  const avatarInput = document.getElementById('avatarInput');
  const avatarImg   = document.getElementById('avatarImg');
  const fileNameEl  = document.getElementById('fileName');
  if (avatarInput && avatarImg){
    avatarInput.addEventListener('change', (e)=>{
      const f = e.target.files?.[0];
      if(!f){ fileNameEl.textContent = '未選擇任何檔案'; return; }
      fileNameEl.textContent = f.name.length>38 ? f.name.slice(0,35)+'…' : f.name;
      const reader = new FileReader();
      reader.onload = ev => avatarImg.src = ev.target.result;
      reader.readAsDataURL(f);
    });
  }

  // ========== 讓現有 input 自動吃到樣式 ==========
  // 若你原本的 input 不在 .fields 中，這段會把它們搬進 .fields（不破壞 value）
  (function autoMountFields(){
    const fields = document.getElementById('profileFields');
    if(!fields) return;
    // 抓出頁面上可輸入的 input（排除 file 與 button）
    const all = Array.from(document.querySelectorAll('input'))
      .filter(el => !['file','button','submit'].includes(el.type));
    // 已存在 .fields 中就不搬
    all.forEach(el => {
      if (!fields.contains(el)) fields.appendChild(el);
      el.autocomplete = 'on';
    });
  })();

</body>
</html>




