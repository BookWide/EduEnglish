<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>個人資料｜BookWide</title>
  <style>
    :root{--bg:#fff;--fg:#111;--line:#e5e7eb;--brand:#2563eb;--muted:#6b7280}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","PingFang TC","Noto Sans CJK TC","微軟正黑體",sans-serif}
    header{display:flex;gap:12px;align-items:center;padding:16px 18px;border-bottom:1px solid var(--line)}
    a.back{color:var(--brand);text-decoration:none;border:1px solid var(--brand);border-radius:10px;padding:.4rem .7rem}
    .wrap{max-width:860px;margin:20px auto;padding:0 16px}
    .card{border:1px solid var(--line);border-radius:14px;background:#fff;padding:16px}
    .row{display:grid;gap:14px;grid-template-columns:1fr 1fr}
    @media (max-width:820px){ .row{grid-template-columns:1fr} }
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,button{font:inherit}
    .input{width:100%;border:1px solid var(--line);border-radius:10px;padding:.6rem .75rem;background:#fff}
    .btn{border:1px solid var(--brand);background:var(--brand);color:#fff;border-radius:10px;padding:.6rem .9rem;cursor:pointer}
    .btn.outline{background:#fff;color:var(--brand)}
    .grid-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:14px}
    .hint{color:var(--muted);font-size:13px}
    .avatar{width:120px;height:120px;border-radius:999px;object-fit:cover;border:1px solid var(--line);background:#f7f7f7}
    .center{display:flex;align-items:center;gap:14px}
    .muted{color:var(--muted)}
    .ok{color:#16a34a}
    .err{color:#b91c1c}
  </style>
</head>
<body>
  <header>
    <a class="back" href="../index.html">← 回首頁</a>
    <h1 style="margin:0;font-size:18px">個人資料</h1>
    <div id="userEmail" class="hint" style="margin-left:auto"></div>
  </header>

  <main class="wrap">
    <!-- 個人資料卡片（原本那張） -->
    <div class="card">
      <div class="center" style="margin-bottom:14px">
        <img id="avatarPreview" class="avatar" alt="avatar" src="">
        <div>
          <label>頭像上傳（建議 400×400 JPG/PNG）</label>
          <input id="avatarFile" type="file" accept="image/*" class="input" />
          <div class="hint">將會上傳到 <code>avatars/{userId}/avatar.jpg</code></div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>姓名 / 暱稱（display_name）</label>
          <input id="display_name" class="input" placeholder="RAYMOND / pmktools">
        </div>
        <div>
          <label>聯絡電話（phone）</label>
          <input id="phone" class="input" placeholder="0932-xxxxxx">
        </div>

        <div>
          <label>LINE ID（line_id）</label>
          <input id="line_id" class="input" placeholder="myLineId">
        </div>
        <div>
          <label>WeChat ID（wechat_id）</label>
          <input id="wechat_id" class="input" placeholder="myWeChatId">
        </div>

        <div class="row" style="grid-template-columns:1fr">
          <div>
            <label>地址（address）</label>
            <input id="address" class="input" placeholder="台中市……">
          </div>
        </div>
      </div>

      <div class="grid-actions">
        <button id="btnReload" class="btn outline">重新載入</button>
        <button id="btnSave" class="btn">完成並儲存</button>
      </div>

      <div id="msg" class="hint" style="margin-top:10px"></div>
    </div>

    <!-- 變更密碼卡片（新加的） -->
    <div class="card" style="margin-top:16px">
      <h2 style="margin:0 0 8px;font-size:16px">變更登入密碼</h2>
      <p class="hint" style="margin:0 0 12px;">
        忘記目前密碼時，可先在登入頁使用「寄送登入連結」，從信箱點擊登入後，再於此處設定新的登入密碼。
      </p>

      <div class="row" style="grid-template-columns:1fr">
        <div>
          <label>新登入密碼</label>
          <input id="newPwd" type="password" class="input" placeholder="請輸入新密碼">
        </div>
        <div>
          <label>再次確認新密碼</label>
          <input id="newPwd2" type="password" class="input" placeholder="請再輸入一次新密碼">
        </div>
      </div>

      <div class="grid-actions">
        <button id="btnChangePwd" class="btn">儲存新密碼</button>
      </div>

      <div id="pwdMsg" class="hint" style="margin-top:10px"></div>
    </div>
  </main>

  <script type="module">
    // 盡量相容你的 supa.js：優先拿 named export，若沒有則用 BW.supa
    import * as SupaMod from '../supa.js';  // 路徑依你的專案結構，如在同層改成 './supa.js'
    const supabase = (SupaMod && (SupaMod.supabase || (SupaMod.BW && SupaMod.BW.supa)));
    if (!supabase) {
      alert('找不到 Supabase 連線（supa.js），請確認路徑與輸出。');
      throw new Error('supabase not found');
    }

    const $ = (q, root = document) => root.querySelector(q);
    const msg = $('#msg');

    // 1) 必須登入；若未登入導回首頁
    const { data: userData } = await supabase.auth.getUser();
    const user = userData?.user ?? null;
    if (!user) {
      location.href = '../index.html?denied=signin';
    }
    $('#userEmail').textContent = user?.email || '';

    // 2) 載入 profiles（如沒有資料只回 null，不報錯）
    async function loadProfile() {
      msg.textContent = '載入中…';
      const { data, error } = await supabase
        .from('profiles')
        .select('id,display_name,phone,line_id,wechat_id,address,avatar_url')
        .eq('id', user.id)
        .maybeSingle();

      if (error) {
        msg.innerHTML = `<span class="err">讀取失敗：</span>${error.message}`;
        return;
      }

      $('#display_name').value = data?.display_name ?? '';
      $('#phone').value        = data?.phone ?? '';
      $('#line_id').value      = data?.line_id ?? '';
      $('#wechat_id').value    = data?.wechat_id ?? '';
      $('#address').value      = data?.address ?? '';
      $('#avatarPreview').src  = data?.avatar_url || '';

      msg.textContent = '就緒。';
    }

    // 3) 儲存個人資料（先檢查是否有那列 → 有就 update，沒有就 insert）
    async function saveProfile() {
      msg.textContent = '儲存中…';
      $('#btnSave').disabled = true;

      try {
        // (A) 如有選頭像檔，先上傳
        const file = $('#avatarFile').files[0];
        let avatar_url = null;
        if (file) {
          const path = `${user.id}/avatar.jpg`;
          const up = await supabase.storage.from('avatars').upload(path, file, { upsert: true });
          if (up.error) throw up.error;

          const { data: pub } = supabase.storage.from('avatars').getPublicUrl(path);
          avatar_url = pub?.publicUrl || null;
          if (avatar_url) $('#avatarPreview').src = avatar_url;
        }

        // (B) 組更新資料
        const updateData = {
          display_name: $('#display_name').value.trim() || null,
          phone:        $('#phone').value.trim() || null,
          line_id:      $('#line_id').value.trim() || null,
          wechat_id:    $('#wechat_id').value.trim() || null,
          address:      $('#address').value.trim() || null,
          ...(avatar_url ? { avatar_url } : {}),
          updated_at: new Date().toISOString(),
        };

        // (C) 先查是否已有那列
        const { data: exist } = await supabase
          .from('profiles')
          .select('id')
          .eq('id', user.id)
          .maybeSingle();

        let err = null;
        if (exist) {
          ({ error: err } = await supabase.from('profiles').update(updateData).eq('id', user.id));
        } else {
          ({ error: err } = await supabase.from('profiles').insert({ id: user.id, ...updateData }));
        }

        if (err) throw err;

        msg.innerHTML = '<span class="ok">✅ 已保存！</span>';
      } catch (e) {
        console.error(e);
        msg.innerHTML = `<span class="err">儲存失敗：</span>${e.message || e}`;
      } finally {
        $('#btnSave').disabled = false;
      }
    }

    // 4) 變更登入密碼（不需要舊密碼，因為已登入）
    async function changePassword() {
      const pwdMsg = $('#pwdMsg');
      const btn    = $('#btnChangePwd');
      pwdMsg.textContent = '';
      pwdMsg.style.color = getComputedStyle(document.documentElement)
        .getPropertyValue('--muted') || '#6b7280';

      const p1 = $('#newPwd').value;
      const p2 = $('#newPwd2').value;

      if (!p1 || !p2) {
        pwdMsg.style.color = '#b91c1c';
        pwdMsg.textContent = '請輸入兩次新密碼。';
        return;
      }
      if (p1 !== p2) {
        pwdMsg.style.color = '#b91c1c';
        pwdMsg.textContent = '兩次輸入不一致。';
        return;
      }

      btn.disabled = true;
      pwdMsg.textContent = '正在更新密碼…';

      try {
        const { error } = await supabase.auth.updateUser({ password: p1 });
        if (error) {
          console.error('change password error', error);
          pwdMsg.style.color = '#b91c1c';
          pwdMsg.textContent = error.message || '變更失敗，請稍後再試。';
          return;
        }
        pwdMsg.style.color = '#16a34a';
        pwdMsg.textContent = '密碼已更新，下次登入請使用新密碼。';
        $('#newPwd').value = '';
        $('#newPwd2').value = '';
      } catch (e) {
        console.error('change password exception', e);
        pwdMsg.style.color = '#b91c1c';
        pwdMsg.textContent = String(e);
      } finally {
        btn.disabled = false;
      }
    }

    // 事件綁定
    $('#btnReload').addEventListener('click', loadProfile);
    $('#btnSave').addEventListener('click', saveProfile);
    $('#btnChangePwd').addEventListener('click', changePassword);

    // 首次載入
    loadProfile();
  </script>
</body>
</html>














