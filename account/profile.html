<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>個人資料</title>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; background: #fff; color: #000; }
    header { display: flex; align-items: center; background: #f5f5f5; border-bottom: 1px solid #ccc; padding: 10px 20px; }
    header a { text-decoration: none; color: #333; font-weight: bold; margin-right: 15px; }
    h1 { font-size: 22px; margin: 0; }

    .container { max-width: 800px; margin: 40px auto; padding: 20px; border: 1px solid #ddd; border-radius: 10px; background: #fafafa; }
    .row { display: flex; align-items: center; margin-bottom: 15px; }
    .row label { width: 120px; font-weight: bold; }
    .row input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
    .avatar { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
    .avatar img { width: 120px; height: 120px; border-radius: 50%; border: 2px solid #ccc; object-fit: cover; margin-bottom: 10px; }

    button { padding: 10px 20px; border: none; border-radius: 5px; background: #007bff; color: #fff; cursor: pointer; margin-right: 10px; }
    button:hover { background: #0056b3; }

    .toast { position: fixed; right: 20px; bottom: 20px; background: #333; color: #fff; padding: 10px 15px; border-radius: 5px; opacity: 0; transition: opacity 0.3s ease; }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>
  <header>
    <a href="https://bookwide.github.io/EduEnglish/">← 回首頁</a>
    <h1>個人資料</h1>
  </header>

  <div class="container">
    <div class="avatar">
      <img id="avatar" src="https://placehold.co/120x120" alt="頭像" />
      <input type="file" id="fileAvatar" accept="image/*" />
    </div>

    <div class="row"><label>姓名：</label><input id="fullName" type="text" placeholder="請輸入姓名"></div>
    <div class="row"><label>聯絡電話：</label><input id="phone" type="text" placeholder="09xx-xxx-xxx"></div>
    <div class="row"><label>LINE ID：</label><input id="lineId" type="text" placeholder="請輸入 LINE ID"></div>
    <div class="row"><label>WeChat ID：</label><input id="wechat" type="text" placeholder="請輸入 WeChat ID"></div>
    <div class="row"><label>地址：</label><input id="address" type="text" placeholder="請輸入通訊地址"></div>

    <div style="margin-top:20px;">
      <button id="btnSave">完成並儲存</button>
      <button id="btnReload">重新載入</button>
    </div>
  </div>

  <div id="toast" class="toast">已儲存</div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const SUPABASE_URL = 'https://jeajrwpmrgczimmrflxo.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = (id) => document.getElementById(id);
    const toast = (msg) => {
      const t = $('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 1500);
    };

    const avatar = $('avatar');
    const fileAvatar = $('fileAvatar');
    fileAvatar.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => (avatar.src = reader.result);
      reader.readAsDataURL(file);
    });

    const user = (await supabase.auth.getUser()).data.user;
    if (!user) {
      alert('請先登入');
      throw new Error('Not logged in');
    }

    async function load() {
      const { data } = await supabase.from('profiles').select('*').eq('user_id', user.id).single();
      if (data) {
        $('fullName').value = data.full_name || '';
        $('phone').value = data.phone || '';
        $('lineId').value = data.line_id || '';
        $('wechat').value = data.wechat_id || '';
        $('address').value = data.address || '';
      }
    }

    async function save() {
      const payload = {
        user_id: user.id,
        full_name: $('fullName').value.trim(),
        phone: $('phone').value.trim(),
        line_id: $('lineId').value.trim(),
        wechat_id: $('wechat').value.trim(),
        address: $('address').value.trim(),
        updated_at: new Date().toISOString(),
      };

      const { error } = await supabase.from('profiles').upsert(payload, { onConflict: 'user_id' });
      if (error) {
        console.error(error);
        toast('儲存失敗');
      } else {
        toast('已儲存');
      }
    }

    $('btnSave').addEventListener('click', save);
    $('btnReload').addEventListener('click', load);

    load();
  </script>
</body>
</html>




