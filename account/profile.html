<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>個人資料</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#1f2937; --panel-2:#111827;
      --text:#e5e7eb; --muted:#94a3b8; --line:#273244;
      --primary:#3b82f6; --primary-700:#1d4ed8; --ok:#10b981;
      --warn:#f59e0b; --danger:#ef4444;
      --radius:16px;
    }
    html,body{background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue","Noto Sans","Microsoft JhengHei",sans-serif;margin:0}
    .wrap{max-width:880px;margin:40px auto;padding:0 20px}
    .card{
      background:linear-gradient(180deg,var(--panel),var(--panel-2));
      border:1px solid var(--line); border-radius:var(--radius);
      padding:28px 24px; box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    h1{margin:0 0 8px 0; text-align:center; font-size:36px; letter-spacing:4px}
    .sub{color:var(--muted); text-align:center; margin-bottom:24px; font-size:14px}
    .avatar-zone{display:flex;align-items:center;gap:18px;justify-content:center;margin:6px 0 18px}
    .avatar{
      width:128px;height:128px;border-radius:999px;overflow:hidden;
      border:3px solid #0005; box-shadow:0 6px 24px #0007; background:#000;
    }
    .avatar img{width:100%;height:100%;object-fit:cover}
    .hint{color:var(--muted); font-size:12px; text-align:center}

    .form{display:grid;grid-template-columns:1fr;gap:14px;margin-top:8px}
    .row{display:flex;flex-direction:column;gap:8px}
    .label{font-size:13px;color:#cbd5e1}
    .input{
      width:100%; background:#0b1220; color:var(--text);
      border:1px solid var(--line); border-radius:12px; padding:14px 14px;
      outline:none; transition:border .15s ease, box-shadow .15s ease;
    }
    .input:focus{border-color:#4f79ff; box-shadow:0 0 0 4px #1d4ed830}
    .btns{display:flex;gap:12px;margin-top:8px}
    .btn{
      flex:1; border:0; border-radius:12px; padding:14px 18px; cursor:pointer;
      font-weight:700; font-size:16px;
    }
    .btn-primary{background:var(--primary); color:#fff}
    .btn-primary:active{transform:translateY(1px)}
    .btn-ghost{background:#0b1220; color:#d1d5db; border:1px solid var(--line)}
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:24px; background:#06121d; color:#c6f6d5; border:1px solid #134e4a;
      padding:12px 18px; border-radius:12px; display:none; box-shadow:0 10px 30px #0008; z-index:50;
    }
    .toast.show{display:block; animation:fade 2s ease}
    @keyframes fade{0%{opacity:0; transform:translate(-50%,8px)} 15%{opacity:1; transform:translate(-50%,0)} 85%{opacity:1} 100%{opacity:0}}
    .divider{height:1px;background:var(--line);margin:8px 0 4px}
    .topbar{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .home{color:var(--muted); text-decoration:none; font-size:14px}
    .home:hover{color:#cbd5e1}
    @media(min-width:720px){
      .form{grid-template-columns:1fr 1fr}
      .row.span2{grid-column:1/3}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="home" href="../index.html">← 回首頁</a>
    </div>

    <div class="card">
      <h1>個人資料</h1>
      <div class="sub">可更換頭像（僅預覽），儲存流程不變。</div>

      <div class="avatar-zone">
        <div class="avatar"><img id="avatarImg" src="" alt="avatar" /></div>
      </div>
      <div class="avatar-zone">
        <input type="file" id="fileAvatar" accept="image/*"/>
      </div>
      <div class="hint">可上傳頭像；僅影響本頁預覽。既有儲存邏輯不變。</div>

      <div class="divider"></div>

      <div class="form">
        <div class="row">
          <label class="label" for="name">姓名</label>
          <input id="name" class="input" placeholder="姓名" />
        </div>

        <div class="row">
          <label class="label" for="phone">聯絡電話</label>
          <input id="phone" class="input" placeholder="09xx-xxx-xxx" />
        </div>

        <div class="row">
          <label class="label" for="line">LINE ID</label>
          <input id="line" class="input" placeholder="LINE ID" />
        </div>

        <div class="row">
          <label class="label" for="taxid">身分／客編（選填）</label>
          <input id="taxid" class="input" placeholder="身分證後四碼、或客編…" />
        </div>

        <div class="row span2">
          <label class="label" for="address">通訊地址</label>
          <input id="address" class="input" placeholder="寄送或聯絡地址" />
        </div>

        <div class="row span2 btns">
          <button id="btnSave" class="btn btn-primary">完成並儲存</button>
          <button id="btnReload" class="btn btn-ghost">重新載入</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- 如果你的站點已經在全域載入 Supabase JS 並創建了 window.supabase，以下程式會直接沿用 -->
  <script>
    // --- 可視化：本地頭像預覽（不影響你原本上傳流程） ---
    (function () {
      const file = document.getElementById('fileAvatar');
      const img  = document.getElementById('avatarImg');
      file.addEventListener('change', () => {
        const f = file.files?.[0];
        if (!f) return;
        const url = URL.createObjectURL(f);
        img.src = url;
      });
    })();

    // --- UI 輔助 ---
    const qs = (s)=>document.querySelector(s);
    const toast = (msg)=>{
      const el = document.getElementById('toast');
      el.textContent = msg; el.classList.add('show');
      setTimeout(()=>el.classList.remove('show'), 1800);
    };

    // --- 欄位對應（保留原本 id，僅樣式不同） ---
    const $name    = qs('#name');
    const $phone   = qs('#phone');
    const $line    = qs('#line');
    const $taxid   = qs('#taxid');
    const $address = qs('#address');
    const $avatar  = qs('#fileAvatar');
    const $avatarImg = qs('#avatarImg');

    // === 資料載入與儲存（維持你原有的 supabase 邏輯；只是包一層函式）
    // 重要：若你的 profiles 鍵名是「id」而非「user_id」，把下列 user_id 全部改成 id。
    async function getCurrentUser() {
      if (!window.supabase) { console.warn('supabase 尚未注入：將只顯示表單樣式'); return null; }
      const { data: { user } } = await supabase.auth.getUser();
      return user || null;
    }

    async function loadProfile() {
      const user = await getCurrentUser();
      if (!user) return;

      // 讀取頭像：若你原本有存 URL，可自行改成從 profiles 欄位帶出
      // 下面這段只是將預設頭像置入（若你已有頭像 URL，改成 $avatarImg.src = yourUrl）
      if (!$avatarImg.src) {
        $avatarImg.src = 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=512&h=512&fit=crop';
      }

      // 讀取 profiles（鍵名依你的表設計調整）
      const { data, error } = await supabase
        .from('profiles')
        .select('*')
        .eq('user_id', user.id)   // ← 如果你的鍵是 id，改成 .eq('id', user.id)
        .maybeSingle();

      if (error) { console.error(error); toast('讀取失敗'); return; }

      if (data) {
        $name.value    = data.name    ?? '';
        $phone.value   = data.phone   ?? '';
        $line.value    = data.line_id ?? '';
        $taxid.value   = data.tax_id  ?? '';
        $address.value = data.address ?? '';
        if (data.avatar_url) $avatarImg.src = data.avatar_url;
      } else {
        // 沒資料則清空
        $name.value = $phone.value = $line.value = $taxid.value = $address.value = '';
      }
    }

    async function saveProfile() {
      const user = await getCurrentUser();
      if (!user) return;

      // 你原本的頭像上傳流程若有用 Storage，請在這裡呼叫，
      // 例如：上傳後取得 publicURL -> avatarUrl，再一起 upsert。
      let avatarUrl;
      // if ($avatar.files?.[0]) { ... 上傳至 storage，取得 avatarUrl ... }

      const payload = {
        user_id: user.id,               // 若你的鍵為 id → 改成 id:user.id
        name: $name.value.trim(),
        phone: $phone.value.trim(),
        line_id: $line.value.trim(),
        tax_id: $taxid.value.trim(),
        address: $address.value.trim(),
      };
      if (avatarUrl) payload.avatar_url = avatarUrl;

      const { error } = await supabase
        .from('profiles')
        .upsert(payload, { onConflict: 'user_id' }); // 若鍵為 id → { onConflict: 'id' }

      if (error) { console.error(error); toast('儲存失敗'); }
      else toast('已儲存完成');
    }

    // 綁定
    document.getElementById('btnSave')?.addEventListener('click', async ()=>{
      try { await saveProfile(); } catch(e){ console.error(e); toast('儲存失敗'); }
    });
    document.getElementById('btnReload')?.addEventListener('click', async ()=>{
      try { await loadProfile(); toast('已重新載入'); } catch(e){ console.error(e); }
    });

    // 初始載入
    (async()=>{ try { await loadProfile(); } catch(e){ console.error(e); }})();
  </script>
</body>
</html>
