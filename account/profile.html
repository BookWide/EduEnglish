<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide | 個人資料</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --panel-2:#0b1220; --border:#1f2937;
      --text:#e5e7eb; --muted:#9ca3af; --accent:#3b82f6; --accent-2:#60a5fa;
      --btn:#2563eb; --btn-2:#1d4ed8; --pill:#1f2a3a; --ok:#22c55e;
      --input:#0B1220;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue","Noto Sans","Microsoft JhengHei",Arial,sans-serif}
    a{color:var(--muted);text-decoration:none}
    .wrap{max-width:880px;margin:28px auto;padding:0 18px}
    .topbar{display:flex;align-items:center;gap:10px;margin-bottom:12px}
    .back{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:8px;border:1px solid var(--border)}
    .back:hover{background:var(--panel)}
    h1{font-size:34px;margin:8px 0 18px 0;letter-spacing:.06em}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--border);border-radius:18px;padding:26px 24px}
    .center{display:flex;flex-direction:column;align-items:center}
    .avatar{width:140px;height:140px;border-radius:50%;object-fit:cover;border:3px solid #0b2447;background:#0b2447;box-shadow:0 0 0 4px rgba(59,130,246,.15)}
    .note{color:var(--muted);font-size:13px;margin:10px 0 18px 0}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .grid .full{grid-column:1/-1}
    label{display:block;color:var(--muted);font-size:13px;margin:6px 4px}
    input[type="text"]{width:100%;padding:14px 16px;border-radius:12px;border:1px solid var(--border);background:var(--input);color:var(--text);outline:none}
    input[type="text"]::placeholder{color:#6b7280}
    input[type="file"]{color:var(--muted)}
    .btn{width:100%;padding:16px;border-radius:12px;border:0;background:var(--btn);color:#fff;font-weight:700;cursor:pointer}
    .btn:hover{background:var(--btn-2)}
    .btn-ghost{width:100%;padding:14px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--text);cursor:pointer}
    .actions{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    .footer-pills{display:flex;flex-wrap:wrap;gap:10px;margin-top:18px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border:1px solid var(--border);border-radius:12px;background:var(--pill);color:#cbd5e1}
    .ok{color:var(--ok)}
    @media (max-width:760px){
      .grid{grid-template-columns:1fr}
      .actions{grid-template-columns:1fr}
    }
    /* toast */
    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%) translateY(20px);padding:10px 14px;border-radius:10px;background:#0b1220;border:1px solid var(--border);color:#d1fae5;opacity:0;pointer-events:none;transition:.25s}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="back" href="../index.html">← 回首頁</a>
    </div>

    <h1>個人資料</h1>

    <div class="card">
      <div class="center">
        <img id="avatar" class="avatar" alt="avatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140'%3E%3Crect width='100%25' height='100%25' rx='70' ry='70' fill='%23121a2a'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' fill='%235c708c' font-size='22' font-family='sans-serif'%3Eavatar%3C/text%3E%3C/svg%3E">
        <div style="margin-top:12px">
          <input id="file" type="file" accept="image/*">
        </div>
        <div class="note">可上傳頭像（僅頁內預覽），儲存流程不變。</div>
      </div>

      <div class="grid">
        <div class="full">
          <label for="name">姓名</label>
          <input id="name" type="text" placeholder="姓名">
        </div>

        <div class="full">
          <label for="phone">聯絡電話</label>
          <input id="phone" type="text" placeholder="09xx-xxx-xxx 或市話">
        </div>

        <div>
          <label for="line">LINE ID</label>
          <input id="line" type="text" placeholder="LINE ID">
        </div>
        <div>
          <label for="code">身分 / 客編（選填）</label>
          <input id="code" type="text" placeholder="身分證後四碼，或客編…">
        </div>

        <div class="full">
          <label for="addr">通訊地址</label>
          <input id="addr" type="text" placeholder="寄送或聯絡地址">
        </div>
      </div>

      <div class="actions">
        <button id="btnSave" class="btn">完成並儲存</button>
        <button id="btnReload" class="btn-ghost">重新載入</button>
      </div>

      <div class="footer-pills" id="footerPills"></div>
    </div>
  </div>

  <div id="toast" class="toast">已完成</div>

  <script>
  (function(){
    // 1) 取得使用者識別（優先 Supabase 登入 → 再退而求其次用 local token → 最後 guest）
    async function detectUserIdentity(){
      // 1-1 若頁面已引入 supabase-js 且有 session，直接拿 user
      try{
        if (window.supabase && window.supabase.auth) {
          const { data } = await window.supabase.auth.getUser();
          if (data && data.user) {
            return { uid: data.user.id, email: data.user.email || "" };
          }
        }
      }catch(e){/* 忽略 */}

      // 1-2 從 localStorage 的 supabase auth token 抓（通常 key 長這樣：sb-xxxxx-auth-token）
      for (let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if (!k) continue;
        if (k.includes('sb-') && k.includes('auth-token')) {
          try{
            const sess = JSON.parse(localStorage.getItem(k) || '{}');
            const user = sess?.user || sess?.currentSession?.user || sess?.session?.user;
            if (user?.id) return { uid: user.id, email: user.email || "" };
          }catch(e){}
        }
      }

      // 1-3 URL 若帶 uid 也尊重
      const usp = new URLSearchParams(location.search);
      const uidFromUrl = usp.get('uid');
      if (uidFromUrl) return { uid: uidFromUrl, email: "" };

      // 1-4 皆無 → guest（同裝置共用）
      return { uid: 'guest', email: '' };
    }

    // 2) localStorage key（每位使用者各自一份）
    let PROFILE_KEY = 'bw_profile_v1:guest';

    // 3) DOM
    const elAvatar = document.getElementById('avatar');
    const elFile   = document.getElementById('file');
    const elName   = document.getElementById('name');
    const elPhone  = document.getElementById('phone');
    const elLine   = document.getElementById('line');
    const elCode   = document.getElementById('code');
    const elAddr   = document.getElementById('addr');
    const btnSave  = document.getElementById('btnSave');
    const btnReload= document.getElementById('btnReload');
    const footerPills = document.getElementById('footerPills');
    const toast   = document.getElementById('toast');

    function showToast(msg='已完成'){
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'), 1400);
    }

    // 4) 載入 / 儲存
    function loadProfile(){
      const raw = localStorage.getItem(PROFILE_KEY);
      if (!raw) return;
      try{
        const obj = JSON.parse(raw);
        elName.value  = obj.name  || '';
        elPhone.value = obj.phone || '';
        elLine.value  = obj.line  || '';
        elCode.value  = obj.code  || '';
        elAddr.value  = obj.addr  || '';
        if (obj.avatarDataUrl) elAvatar.src = obj.avatarDataUrl;
        paintPills(obj);
      }catch(e){}
    }

    function saveProfile(){
      const obj = {
        name:  elName.value.trim(),
        phone: elPhone.value.trim(),
        line:  elLine.value.trim(),
        code:  elCode.value.trim(),
        addr:  elAddr.value.trim(),
        avatarDataUrl: elAvatar.src && elAvatar.src.startsWith('data:image') ? elAvatar.src : ''
      };
      localStorage.setItem(PROFILE_KEY, JSON.stringify(obj));
      paintPills(obj);
      showToast('已儲存完成');
    }

    function paintPills(obj){
      footerPills.innerHTML = '';
      const pill = (label,val)=> {
        const d = document.createElement('div');
        d.className='pill';
        d.innerHTML = `<span style="opacity:.7">${label}</span> <strong>${val||'—'}</strong>`;
        return d;
      };
      footerPills.append(
        pill('名稱', obj.name||''),
        pill('聯絡電話', obj.phone||'')
      );
    }

    // 5) 事件
    elFile.addEventListener('change', (e)=>{
      const f = e.target.files?.[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = ev => { elAvatar.src = ev.target.result; };
      reader.readAsDataURL(f);
    });

    btnSave.addEventListener('click', saveProfile);
    btnReload.addEventListener('click', loadProfile);

    // 6) 啟動：解析使用者並載入
    (async ()=>{
      const who = await detectUserIdentity();
      PROFILE_KEY = `bw_profile_v1:${who.uid || 'guest'}`;
      loadProfile();
    })();
  })();
  </script>
</body>
</html>



