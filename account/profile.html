<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>個人資料｜BookWide</title>
  <style>
    :root{--bg:#fff;--fg:#111;--line:#e5e7eb;--brand:#2563eb;--muted:#6b7280}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","PingFang TC","Noto Sans CJK TC","微軟正黑體",sans-serif}
    header{display:flex;gap:12px;align-items:center;padding:16px 18px;border-bottom:1px solid var(--line)}
    a.back{color:var(--brand);text-decoration:none;border:1px solid var(--brand);border-radius:10px;padding:.4rem .7rem}
    .wrap{max-width:860px;margin:20px auto;padding:0 16px}
    .card{border:1px solid var(--line);border-radius:14px;background:#fff;padding:16px}
    .row{display:grid;gap:14px;grid-template-columns:1fr 1fr}
    @media (max-width:820px){ .row{grid-template-columns:1fr} }
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,button{font:inherit}
    .input{width:100%;border:1px solid var(--line);border-radius:10px;padding:.6rem .75rem;background:#fff}
    .btn{border:1px solid var(--brand);background:var(--brand);color:#fff;border-radius:10px;padding:.6rem .9rem;cursor:pointer}
    .btn.outline{background:#fff;color:var(--brand)}
    .grid-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:14px}
    .hint{color:var(--muted);font-size:13px}
    .avatar{width:120px;height:120px;border-radius:999px;object-fit:cover;border:1px solid var(--line);background:#f7f7f7}
    .center{display:flex;align-items:center;gap:14px}
    .muted{color:var(--muted)}
    .ok{color:#16a34a}
    .err{color:#b91c1c}
  </style>
</head>
<body>
  <header>
    <a class="back" href="../index.html">← 回首頁</a>
    <h1 style="margin:0;font-size:18px">個人資料</h1>
    <div id="userEmail" class="hint" style="margin-left:auto"></div>
  </header>

  <main class="wrap">
    <div class="card">
      <div class="center" style="margin-bottom:14px">
        <img id="avatarPreview" class="avatar" alt="avatar" src="">
        <div>
          <label>頭像上傳（建議 400×400 JPG/PNG）</label>
          <input id="avatarFile" type="file" accept="image/*" class="input" />
          <div class="hint">將會上傳到 <code>avatars/{userId}/avatar.jpg</code></div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>姓名 / 暱稱（display_name）</label>
          <input id="display_name" class="input" placeholder="RAYMOND / pmktools">
        </div>
        <div>
          <label>聯絡電話（phone）</label>
          <input id="phone" class="input" placeholder="0932-xxxxxx">
        </div>

        <div>
          <label>LINE ID（line_id）</label>
          <input id="line_id" class="input" placeholder="myLineId">
        </div>
        <div>
          <label>WeChat ID（wechat_id）</label>
          <input id="wechat_id" class="input" placeholder="myWeChatId">
        </div>

        <div class="row" style="grid-template-columns:1fr">
          <div>
            <label>地址（address）</label>
            <input id="address" class="input" placeholder="台中市……">
          </div>
        </div>
      </div>

      <div class="grid-actions">
        <button id="btnReload" class="btn outline">重新載入</button>
        <button id="btnSave" class="btn">完成並儲存</button>
      </div>

      <div id="msg" class="hint" style="margin-top:10px"></div>
    </div>
  
<!-- ===== BookWide Placement (3-minute) ===== -->
<section class="card" id="bwPlacementCard" style="margin-top:16px;">
  <h3 style="margin:0 0 10px 0;">程度測驗（3 分鐘）</h3>
  <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
    <button id="bwBtnPlacement" class="btn primary" type="button">開始測驗</button>
    <button id="bwBtnPlacementReset" class="btn" type="button">清除結果</button>
    <div id="bwPlacementStatus" style="color:#64748b;"></div>
  </div>
  <div id="bwPlacementResult" style="margin-top:10px; display:none;">
    <div style="font-size:18px; font-weight:800;">你的程度：<span id="bwPlacementLevel">—</span></div>
    <div style="margin-top:6px; color:#475569;">
      建議從 <b>Talk Week <span id="bwPlacementStartWeek">—</span></b> 開始（可在 Talk 內再切換週次）。
    </div>
    <div id="bwPlacementComment" style="margin-top:10px; background:#f1f5f9; padding:12px; border-radius:12px; line-height:1.6;"></div>
  </div>
</section>

<!-- Placement Modal -->
<div id="bwPlacementModal" class="modal" aria-hidden="true" style="display:none;">
  <div class="modal-backdrop" data-close="1"></div>
  <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="bwPlacementTitle">
    <div class="modal-head">
      <div>
        <div id="bwPlacementTitle" style="font-weight:800; font-size:18px;">程度測驗</div>
        <div style="color:#64748b; font-size:13px;">約 3 分鐘，完成後會自動套用到「今日口說任務」建議。</div>
      </div>
      <button class="icon-btn" data-close="1" aria-label="Close">✕</button>
    </div>
    <div class="modal-body">
      <div id="bwPlacementQWrap"></div>
      <div id="bwPlacementErr" style="display:none; color:#ef4444; margin-top:10px;"></div>
    </div>
    <div class="modal-foot">
      <button id="bwPlacementPrev" class="btn" type="button">上一步</button>
      <button id="bwPlacementNext" class="btn primary" type="button">下一步</button>
    </div>
  </div>
</div>

<style>
/* minimal modal styling (won't break your layout) */
#bwPlacementModal .modal-backdrop{position:fixed; inset:0; background:rgba(15,23,42,.42); z-index:9998;}
#bwPlacementModal .modal-panel{position:fixed; z-index:9999; top:50%; left:50%; transform:translate(-50%,-50%); width:min(860px,92vw); max-height:min(86vh,720px); overflow:hidden; background:#fff; border-radius:18px; box-shadow:0 20px 70px rgba(15,23,42,.25); display:flex; flex-direction:column;}
#bwPlacementModal .modal-head{display:flex; align-items:flex-start; justify-content:space-between; padding:14px 14px 10px 14px; border-bottom:1px solid #e5e7eb;}
#bwPlacementModal .modal-body{padding:14px; overflow:auto;}
#bwPlacementModal .modal-foot{display:flex; gap:10px; justify-content:flex-end; padding:12px 14px; border-top:1px solid #e5e7eb;}
#bwPlacementModal .icon-btn{border:0; background:transparent; font-size:18px; cursor:pointer; padding:6px 10px; border-radius:10px;}
#bwPlacementModal .qcard{border:1px solid #e5e7eb; border-radius:14px; padding:12px; background:#fff;}
#bwPlacementModal .qtitle{font-weight:800; margin:0 0 10px 0;}
#bwPlacementModal .opt{display:flex; gap:10px; align-items:flex-start; padding:10px; border-radius:12px; border:1px solid #e5e7eb; cursor:pointer; margin-bottom:10px;}
#bwPlacementModal .opt:hover{background:#f8fafc;}
#bwPlacementModal .opt input{margin-top:3px;}
</style>

</main>

  <script type="module">
    // 盡量相容你的 supa.js：優先拿 named export，若沒有則用 BW.supa
    import * as SupaMod from '../supa.js';  // 路徑依你的專案結構，如在同層改成 './supa.js'
    const supabase = (SupaMod && (SupaMod.supabase || (SupaMod.BW && SupaMod.BW.supa)));
    if (!supabase) {
      alert('找不到 Supabase 連線（supa.js），請確認路徑與輸出。');
      throw new Error('supabase not found');
    }

    const $ = (q, root = document) => root.querySelector(q);
    const msg = $('#msg');

    // 1) 需要登入；若未登入導回首頁
    const { data: userData } = await supabase.auth.getUser();
    const user = userData?.user ?? null;
    if (!user) {
      location.href = '../index.html?denied=signin';
    }
    $('#userEmail').textContent = user?.email || '';

    // 2) 載入 profiles（如沒有資料只回 null，不報錯）
    async function loadProfile() {
      msg.textContent = '載入中…';
      const { data, error } = await supabase
        .from('profiles')
        .select('id,display_name,phone,line_id,wechat_id,address,avatar_url')
        .eq('id', user.id)
        .maybeSingle();

      if (error) {
        msg.innerHTML = `<span class="err">讀取失敗：</span>${error.message}`;
        return;
      }

      $('#display_name').value = data?.display_name ?? '';
      $('#phone').value        = data?.phone ?? '';
      $('#line_id').value      = data?.line_id ?? '';
      $('#wechat_id').value    = data?.wechat_id ?? '';
      $('#address').value      = data?.address ?? '';
      $('#avatarPreview').src  = data?.avatar_url || '';

      msg.textContent = '就緒。';
    }

    // 3) 儲存（先檢查是否有那列 → 有就 update，沒有就 insert）
    async function saveProfile() {
      msg.textContent = '儲存中…';
      $('#btnSave').disabled = true;

      try {
        // (A) 如有選頭像檔，先上傳
        const file = $('#avatarFile').files[0];
        let avatar_url = null;
        if (file) {
          const path = `${user.id}/avatar.jpg`;
          const up = await supabase.storage.from('avatars').upload(path, file, { upsert: true });
          if (up.error) throw up.error;

          // 你可選擇存絕對 URL 或僅存路徑，這裡寫入 public URL，方便前端直接顯示
          const { data: pub } = supabase.storage.from('avatars').getPublicUrl(path);
          avatar_url = pub?.publicUrl || null;
          if (avatar_url) $('#avatarPreview').src = avatar_url;
        }

        // (B) 組更新資料
        const updateData = {
          display_name: $('#display_name').value.trim() || null,
          phone:        $('#phone').value.trim() || null,
          line_id:      $('#line_id').value.trim() || null,
          wechat_id:    $('#wechat_id').value.trim() || null,
          address:      $('#address').value.trim() || null,
          ...(avatar_url ? { avatar_url } : {}),
          updated_at: new Date().toISOString(),
        };

        // (C) 先查是否已有那列
        const { data: exist } = await supabase
          .from('profiles')
          .select('id')
          .eq('id', user.id)
          .maybeSingle();

        let err = null;
        if (exist) {
          // 只更新自己的那列 → 符合 RLS
          ({ error: err } = await supabase.from('profiles').update(updateData).eq('id', user.id));
        } else {
          // 第一次：插入自己的那列（需有 with check: id = auth.uid() 的 RLS policy）
          ({ error: err } = await supabase.from('profiles').insert({ id: user.id, ...updateData }));
        }

        if (err) throw err;

        msg.innerHTML = '<span class="ok">✅ 已保存！</span>';
      } catch (e) {
        console.error(e);
        msg.innerHTML = `<span class="err">儲存失敗：</span>${e.message || e}`;
      } finally {
        $('#btnSave').disabled = false;
      }
    }

    // 事件綁定
    $('#btnReload').addEventListener('click', loadProfile);
    $('#btnSave').addEventListener('click', saveProfile);

    // 首次載入
    loadProfile();
  </script>

<script type="module">
import { supabase } from "../supa.js";

const LS_LEVEL = "BW_PLACEMENT_LEVEL";
const LS_SCORE = "BW_PLACEMENT_SCORE";
const LS_META  = "BW_PLACEMENT_META";
const LS_ACTIVE_WEEK = "BW_TALK_ACTIVE_WEEK";

const $ = (id)=>document.getElementById(id);

const btnStart = $("bwBtnPlacement");
const btnReset = $("bwBtnPlacementReset");
const statusEl = $("bwPlacementStatus");
const resBox = $("bwPlacementResult");
const levelEl = $("bwPlacementLevel");
const startWeekEl = $("bwPlacementStartWeek");
const commentEl = $("bwPlacementComment");

const modal = $("bwPlacementModal");
const qWrap = $("bwPlacementQWrap");
const errEl = $("bwPlacementErr");
const btnPrev = $("bwPlacementPrev");
const btnNext = $("bwPlacementNext");

function cefrToStartWeek(level){
  const map = {A1:1, A2:10, B1:19, B2:28, C1:37, C2:46};
  return map[level] || 1;
}
function commentFor(level){
  const bank = {
    A1:"你適合從最常見的生活情境（點餐、問路、入住）開始。目標是：敢開口、句型固定、不要追求完美。",
    A2:"你已經能應付常見生活溝通。接下來重點是：把句子拉長（因為＋所以）、學會追問與確認。",
    B1:"你可以完成多數情境對話。接下來練：更自然的轉折、禮貌語氣、把想法說清楚（理由＋例子）。",
    B2:"你已能在工作/旅遊多數場合流暢溝通。接下來練：更精準用字、同義改寫、即興回應速度。",
    C1:"你可以處理較抽象議題與會議討論。接下來練：論點架構、反駁與讓步、總結與主持語。",
    C2:"你接近母語者流暢度。接下來練：風格化表達、幽默/修辭、專業領域的深度討論。"
  };
  return bank[level] || bank.A1;
}

function openModal(){
  modal.style.display="block";
  modal.setAttribute("aria-hidden","false");
  errEl.style.display="none";
}
function closeModal(){
  modal.style.display="none";
  modal.setAttribute("aria-hidden","true");
}

modal.addEventListener("click",(e)=>{
  const t = e.target;
  if(t && t.dataset && t.dataset.close==="1") closeModal();
});

async function loadPlacement(){
  const tryUrls = ["/data/placement.json","/talk/placement.json","placement.json"];
  let lastErr=null;
  for(const url of tryUrls){
    try{
      const r = await fetch(url, {cache:"no-store"});
      if(!r.ok) throw new Error(url+" "+r.status);
      return await r.json();
    }catch(err){ lastErr = err; }
  }
  throw lastErr || new Error("placement.json not found");
}

let placement = null;
let step = 0;
let answers = {}; // qid -> optionId

function renderStep(){
  const q = placement.questions[step];
  qWrap.innerHTML = "";
  const card = document.createElement("div");
  card.className="qcard";
  card.innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
      <div style="font-weight:800;">Q${step+1}/${placement.questions.length}</div>
      <div style="color:#64748b; font-size:13px;">${q.domain || ""}</div>
    </div>
    <div class="qtitle">${q.prompt}</div>
  `;
  const opts = document.createElement("div");
  (q.options||[]).forEach(opt=>{
    const row = document.createElement("label");
    row.className="opt";
    const checked = answers[q.id]===opt.id ? "checked" : "";
    row.innerHTML = `
      <input type="radio" name="bwopt" value="${opt.id}" ${checked}/>
      <div>
        <div style="font-weight:700;">${opt.label}</div>
        ${opt.example ? `<div style="color:#64748b; font-size:13px; margin-top:4px;">${opt.example}</div>` : ""}
      </div>
    `;
    row.addEventListener("click", ()=>{
      answers[q.id]=opt.id;
      // fast UI update
      const radios = row.parentElement.querySelectorAll('input[type="radio"]');
      radios.forEach(r=>r.checked=false);
      row.querySelector('input[type="radio"]').checked=true;
    });
    opts.appendChild(row);
  });
  card.appendChild(opts);
  qWrap.appendChild(card);

  btnPrev.disabled = step===0;
  btnNext.textContent = (step===placement.questions.length-1) ? "完成並計分" : "下一步";
}

function computeResult(){
  let score=0;
  let max=0;
  const detail=[];
  for(const q of placement.questions){
    const pick = answers[q.id];
    const opt = (q.options||[]).find(o=>o.id===pick);
    const pts = opt?.points ?? 0;
    score += pts;
    max += (q.options||[]).reduce((m,o)=>Math.max(m, o.points??0), 0);
    detail.push({qid:q.id, pick, pts});
  }
  // thresholds are defined in placement.json; fallback simple mapping
  let level = "A1";
  const th = placement.thresholds || [];
  for(const t of th){
    if(score >= t.min) level = t.level;
  }
  return {level, score, max, detail};
}

async function persistResult(res){
  const startWeek = cefrToStartWeek(res.level);

  // local
  localStorage.setItem(LS_LEVEL, res.level);
  localStorage.setItem(LS_SCORE, String(res.score));
  localStorage.setItem(LS_META, JSON.stringify({max:res.max, detail:res.detail, at:new Date().toISOString()}));
  localStorage.setItem(LS_ACTIVE_WEEK, String(startWeek));

  // try supabase (best effort, no blocking)
  try{
    const { data: { user } } = await supabase.auth.getUser();
    if(user){
      const payload = {
        placement_level: res.level,
        placement_score: res.score,
        placement_meta: { max: res.max, detail: res.detail },
        placement_at: new Date().toISOString(),
        talk_active_week: startWeek
      };
      // if your profiles table doesn't have these columns, it will throw; we catch and ignore.
      await supabase.from("profiles").update(payload).eq("id", user.id);
    }
  }catch(e){
    console.warn("placement save (profiles) skipped:", e?.message || e);
  }

  // update UI
  resBox.style.display="block";
  levelEl.textContent = res.level;
  startWeekEl.textContent = String(startWeek);
  commentEl.textContent = commentFor(res.level);
  statusEl.textContent = "已完成測驗（已套用到 Talk 建議週次）";
}

function hydrateFromLocal(){
  const level = localStorage.getItem(LS_LEVEL);
  const score = localStorage.getItem(LS_SCORE);
  if(level){
    resBox.style.display="block";
    levelEl.textContent = level;
    startWeekEl.textContent = String(cefrToStartWeek(level));
    commentEl.textContent = commentFor(level);
    statusEl.textContent = score ? `目前結果：${level}（score ${score}）` : `目前結果：${level}`;
  }else{
    statusEl.textContent = "尚未測驗";
  }
}

btnStart?.addEventListener("click", async ()=>{
  try{
    statusEl.textContent = "載入題目中…";
    placement = await loadPlacement();
    step = 0;
    answers = {};
    openModal();
    renderStep();
    statusEl.textContent = "開始作答";
  }catch(e){
    statusEl.textContent = "載入失敗";
    alert("載入 placement.json 失敗：\n"+(e?.message||e));
  }
});

btnReset?.addEventListener("click", ()=>{
  localStorage.removeItem(LS_LEVEL);
  localStorage.removeItem(LS_SCORE);
  localStorage.removeItem(LS_META);
  // don't force week; let user keep
  resBox.style.display="none";
  statusEl.textContent = "已清除";
});

btnPrev?.addEventListener("click", ()=>{
  if(step>0){ step--; renderStep(); }
});
btnNext?.addEventListener("click", async ()=>{
  const q = placement.questions[step];
  if(!answers[q.id]){
    errEl.textContent = "請先選一個選項。";
    errEl.style.display="block";
    return;
  }
  errEl.style.display="none";
  if(step < placement.questions.length-1){
    step++; renderStep();
  }else{
    const res = computeResult();
    await persistResult(res);
    closeModal();
  }
});

hydrateFromLocal();
</script>
</body>
</html>













