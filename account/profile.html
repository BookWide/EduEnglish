<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>帳號／個人資料</title>

  <!-- Supabase Config (請改成你的專案資料) -->
  <script>
    window.SB_URL  = window.SB_URL  || "https://jeajrwpmrgczimmrflxo.supabase.co";
    window.SB_ANON = window.SB_ANON || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
  </script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { background:#0f172a; color:#fff; font-family:sans-serif; padding:2em; }
    .card { background:#1e293b; padding:1.5em; border-radius:1em; max-width:600px; margin:auto; }
    input,button { padding:0.5em; border-radius:0.5em; border:none; width:100%; margin:0.3em 0; }
    button { background:#3b82f6; color:white; cursor:pointer; }
    img { border-radius:50%; width:100px; height:100px; object-fit:cover; display:block; margin:auto; }
    h1 { text-align:center; }
  </style>
</head>

<body>
  <div class="card">
    <h1>個人資料</h1>
    <img id="avatar_preview" src="" alt="頭像預覽">
    <input type="file" id="avatar_file" accept="image/*">
    <input id="full_name" placeholder="姓名 / 暱稱">
    <input id="phone" placeholder="聯絡電話">
    <input id="line_id" placeholder="LINE ID">
    <input id="wechat_id" placeholder="WeChat ID">
    <input id="address" placeholder="地址">
    <button id="saveProfile">完成並儲存</button>
    <button id="reloadBtn">重新載入</button>
  </div>

  <script>
    const supabase = window.supabase.createClient(window.SB_URL, window.SB_ANON);
    window.__profile = {
      async loadProfile() {
        const user = (await supabase.auth.getUser()).data.user;
        if (!user) return alert("請先登入");
        const { data, error } = await supabase.from("profiles").select("*").eq("id", user.id).maybeSingle();
        if (error) return console.error(error);
        if (!data) return console.warn("No profile found.");
        for (const key of ["full_name","phone","line_id","wechat_id","address"]) {
          const el = document.getElementById(key);
          if (el) el.value = data[key] || "";
        }
        if (data.avatar_url) document.getElementById("avatar_preview").src = data.avatar_url;
        console.log("Profile loaded:", data);
      },

      async saveProfile() {
        const user = (await supabase.auth.getUser()).data.user;
        if (!user) return alert("請先登入");
        let avatar_url = null;
        const fileInput = document.getElementById("avatar_file");
        if (fileInput.files.length > 0) {
          const file = fileInput.files[0];
          const filePath = `${user.id}/${file.name}`;
          const { error: uploadError } = await supabase.storage.from("avatars").upload(filePath, file, { upsert: true });
          if (uploadError) return alert("上傳失敗：" + uploadError.message);
          const { data } = supabase.storage.from("avatars").getPublicUrl(filePath);
          avatar_url = data.publicUrl;
        }
        const updateData = {
          id: user.id,
          full_name: document.getElementById("full_name").value,
          phone: document.getElementById("phone").value,
          line_id: document.getElementById("line_id").value,
          wechat_id: document.getElementById("wechat_id").value,
          address: document.getElementById("address").value,
        };
        if (avatar_url) updateData.avatar_url = avatar_url;
        const { error } = await supabase.from("profiles").upsert(updateData);
        if (error) return alert("儲存失敗：" + error.message);
        alert("✅ 已保存！");
        console.log("Profile saved:", updateData);
      }
    };

    document.getElementById("saveProfile").addEventListener("click", e => window.__profile.saveProfile(e));
    document.getElementById("reloadBtn").addEventListener("click", e => window.__profile.loadProfile(e));
    window.addEventListener("DOMContentLoaded", () => window.__profile.loadProfile());
  </script>
</body>
  <!-- === Profile UI Patch · show name/phone outside the white card (non-invasive) === -->
<style id="profile-ui-patch">
  /* 頂部資訊條：只做視覺，不改原有結構與功能 */
  .profile-topbar{
    position:sticky; top:0; z-index:50;
    background:#0f172a; color:#e6f0ff;
    border-bottom:1px solid rgba(255,255,255,.08);
    padding:10px 14px; font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC";
  }
  .profile-topbar .wrap{
    max-width:980px; margin:0 auto; display:flex; gap:14px; align-items:center; flex-wrap:wrap;
  }
  .profile-chip{
    background:#0b223d; border:1px solid #1e3a5f; color:#eaf2ff;
    padding:6px 10px; border-radius:10px; font-size:14px; display:flex; gap:8px; align-items:center;
  }
  .profile-chip .k{opacity:.75}
  .profile-chip .v{font-weight:700}
  /* 讓白色內容卡與頂部資訊條有呼吸空間（不改你原本卡片樣式） */
  .profile-card-spacer{ height:8px; }
</style>

<div id="profileTopbar" class="profile-topbar" style="display:none">
  <div class="wrap">
    <div class="profile-chip" id="chipName"><span class="k">名稱</span><span class="v">—</span></div>
    <div class="profile-chip" id="chipPhone"><span class="k">聯絡電話</span><span class="v">—</span></div>
    <!-- 可選：顯示登入信箱 -->
    <div class="profile-chip" id="chipEmail" style="display:none"><span class="k">Email</span><span class="v">—</span></div>
  </div>
</div>
<div class="profile-card-spacer" aria-hidden="true"></div>

<script>
(function(){
  // 找欄位（不動你的 DOM；盡量相容你舊版的 id/name/label）
  function byCandidates(cands){
    for(const sel of cands){
      const el = document.querySelector(sel);
      if (el) return el;
    }
    return null;
  }
  function byLabelText(kw){
    const labs = Array.from(document.querySelectorAll('label'));
    for(const lb of labs){
      const t = (lb.textContent||'').trim();
      if (!t) continue;
      if (t.includes(kw)){
        // for/id 配對
        const forId = lb.getAttribute('for');
        if (forId){
          const el = document.getElementById(forId);
          if (el) return el;
        }
        // label 後面緊鄰 input
        let n = lb.nextElementSibling;
        while(n && n.tagName!=='INPUT' && n.tagName!=='TEXTAREA') n = n.nextElementSibling;
        if (n && (n.tagName==='INPUT' || n.tagName==='TEXTAREA')) return n;
      }
    }
    return null;
  }

  // 盡量猜測你的欄位
  const nameI  = byCandidates(['#full_name','#name','#username','[name="full_name"]','[name="name"]']) || byLabelText('名稱');
  const phoneI = byCandidates(['#phone','#tel','[name="phone"]','[name="tel"]']) || byLabelText('聯絡電話');
  const emailI = byCandidates(['#email','[name="email"]']) || byLabelText('電子郵件');

  const chipName  = document.querySelector('#chipName .v');
  const chipPhone = document.querySelector('#chipPhone .v');
  const chipEmail = document.querySelector('#chipEmail .v');
  const chipEmailWrap = document.getElementById('chipEmail');
  const topbar = document.getElementById('profileTopbar');

  function val(el){ return (el && (el.value ?? el.textContent) || '').trim(); }
  function safe(v){ return v || '—'; }

  async function maybeAuthEmail(){
    try{
      if (window.supabase?.auth?.getUser){
        const { data } = await window.supabase.auth.getUser();
        return data?.user?.email || '';
      }
    }catch(_){}
    return '';
  }

  async function sync(){
    const nameV  = val(nameI);
    const phoneV = val(phoneI);
    let emailV   = val(emailI);

    // 若頁面沒有 email 欄位，嘗試從 Supabase 取，但完全不強制
    if (!emailV){
      emailV = await maybeAuthEmail();
    }

    if (chipName)  chipName.textContent  = safe(nameV);
    if (chipPhone) chipPhone.textContent = safe(phoneV);
    if (chipEmail) chipEmail.textContent = safe(emailV);

    // 只要有任一值，就顯示上方資訊條
    if (nameV || phoneV || emailV){
      topbar.style.display = 'block';
      if (emailV) chipEmailWrap.style.display = '';
    }else{
      topbar.style.display = 'none';
      chipEmailWrap.style.display = 'none';
    }
  }

  // 初次同步
  sync();

  // 即時更新（使用者輸入時立刻反映）
  [nameI, phoneI, emailI].forEach(el=>{
    if(!el) return;
    el.addEventListener('input', sync, {passive:true});
    el.addEventListener('change', sync, {passive:true});
  });

  // 部分頁面是載入後才把資料塞進 input（例如資料庫讀取完成），這裡輪詢幾次保險
  let tries = 10;
  const iv = setInterval(()=>{
    sync();
    if(--tries<=0) clearInterval(iv);
  }, 500);
})();
</script>
<!-- === /Profile UI Patch === -->

</html>


