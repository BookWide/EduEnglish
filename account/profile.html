<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>個人資料</title>
  <style>
    :root{
      --bg:#0b1623; --panel:#0f1e2b; --muted:#a8b3c2; --text:#e8edf2;
      --primary:#3b82f6; --primary-900:#1e3a8a; --ok:#10b981; --warn:#f59e0b;
      --border:#1e2a36; --chip:#132230;
    }
    html,body{margin:0;background:var(--bg);color:var(--text);font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue","Noto Sans","Microsoft JhengHei",sans-serif}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    .topbar{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    .back{color:#dbe6ff;text-decoration:none;background:#16263a;border:1px solid var(--border);padding:8px 12px;border-radius:10px}
    h1{font-size:32px;margin:6px 0 18px 0;letter-spacing:2px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:24px}
    .center{display:flex;flex-direction:column;align-items:center}
    .avatar{width:160px;height:160px;border-radius:50%;border:6px solid #17314a;background:#0b1623;display:grid;place-items:center;color:#9fb4c9;font-weight:700;margin-top:6px;object-fit:cover}
    .row{display:flex;gap:16px;flex-wrap:wrap;margin-top:22px}
    .col{flex:1 1 320px;min-width:280px}
    label{display:block;font-size:13px;color:var(--muted);margin:0 0 6px 2px}
    input{width:100%;padding:14px 14px;border-radius:12px;border:1px solid var(--border);background:#0c1a25;color:var(--text);outline:none}
    input::placeholder{color:#7f91a3}
    .hint{color:var(--muted);font-size:12px;margin-top:8px;text-align:center}
    .btns{display:flex;gap:12px;flex-wrap:wrap;margin-top:22px}
    .btn{flex:1 1 220px;padding:16px 18px;border-radius:12px;border:1px solid var(--border);background:var(--primary);color:#fff;font-weight:700;text-align:center;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .btn.ghost{background:#112031}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:18px}
    .chip{background:var(--chip);border:1px solid var(--border);color:#c9d7e8;padding:6px 10px;border-radius:999px;font-size:12px}
    .toast{position:fixed;right:18px;bottom:18px;background:#102334;border:1px solid var(--border);color:#eaf7ff;padding:12px 16px;border-radius:12px;opacity:0;transform:translateY(10px);transition:.25s}
    .toast.show{opacity:1;transform:translateY(0)}
    .danger{color:#ffd1d1}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="back" href="/EduEnglish/index.html">← 回首頁</a>
      <h1>個人資料</h1>
    </div>

    <div class="card">
      <div class="center">
        <img id="imgAvatar" class="avatar" alt="avatar" />
        <div style="margin-top:10px">
          <input id="fileAvatar" type="file" accept="image/*" />
        </div>
        <div class="hint">可上傳頭像（僅頁內預覽），儲存流程不變。</div>
      </div>

      <div class="row">
        <div class="col">
          <label for="name">姓名</label>
          <input id="name" placeholder="姓名" autocomplete="name" />
        </div>
        <div class="col">
          <label for="phone">聯絡電話</label>
          <input id="phone" placeholder="09xx-xxx-xxx 或市話" inputmode="tel" />
        </div>
        <div class="col">
          <label for="line">LINE ID</label>
          <input id="line" placeholder="LINE ID" autocomplete="off" />
        </div>
        <div class="col">
          <label for="customer">身分 / 客編（選填）</label>
          <input id="customer" placeholder="身分證後四碼，或客編…" />
        </div>
        <div class="col" style="flex-basis:100%">
          <label for="address">通訊地址</label>
          <input id="address" placeholder="寄送或聯絡地址" autocomplete="street-address" />
        </div>
      </div>

      <div class="btns">
        <button id="btnSave" class="btn">完成並儲存</button>
        <button id="btnReload" class="btn ghost">重新載入</button>
      </div>

      <div class="chips" id="chipBar">
        <!-- 會顯示：姓名 / 聯絡電話 兩顆膠囊 -->
      </div>
      <div class="hint" id="authHint"></div>
    </div>
  </div>

  <div id="toast" class="toast">已儲存</div>

  <!-- ===== Supabase 連線 + 讀寫 ===== -->
  <script type="module">
    /***** 必改：你的 Supabase 專案資訊 *****/
    const SUPABASE_URL = 'https://jeajrwpmrgczimmrflxo.supabase.co';   // ← 改成你的
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do';              // ← 改成你的

    // 載入 supabase-js（ESM，無需打包）
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const sb = createClient(SUPABASE_URL, SUPABASE_ANON);

    // ===== DOM =====
    const imgAvatar = document.getElementById('imgAvatar');
    const fileAvatar = document.getElementById('fileAvatar');
    const nameEl = document.getElementById('name');
    const phoneEl = document.getElementById('phone');
    const lineEl = document.getElementById('line');
    const customerEl = document.getElementById('customer');
    const addressEl = document.getElementById('address');
    const btnSave = document.getElementById('btnSave');
    const btnReload = document.getElementById('btnReload');
    const chipBar = document.getElementById('chipBar');
    const toast = document.getElementById('toast');
    const authHint = document.getElementById('authHint');

    // 小工具
    const showToast = (msg) => {
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'), 1500);
    };
    const b64Preview = (file) => new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });

    // Avatar 本地預覽
    fileAvatar.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0];
      if (!f) return;
      const dataUrl = await b64Preview(f);
      imgAvatar.src = dataUrl;
    });

    // 讀取使用者 + Profile
    async function loadProfile(){
      chipBar.innerHTML = '';
      imgAvatar.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160"><rect width="160" height="160" rx="80" fill="%230b1623"/><text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" fill="%239fb4c9" font-size="26" font-family="sans-serif">avatar</text></svg>';

      const { data: { user }, error: authErr } = await sb.auth.getUser();
      if (authErr || !user){
        authHint.innerHTML = '<span class="danger">尚未登入，請先登入帳號。</span>';
        btnSave.disabled = true;
        return;
      }
      authHint.textContent = '';

      // 讀 profiles
      const { data, error } = await sb
        .from('profiles')
        .select('*')
        .eq('id', user.id)
        .maybeSingle();

      if (error) {
        showToast('讀取失敗');
        console.error(error);
        return;
      }
      // 填入
      nameEl.value = data?.name ?? '';
      phoneEl.value = data?.phone ?? '';
      lineEl.value = data?.line_id ?? '';
      customerEl.value = data?.customer_code ?? '';
      addressEl.value = data?.address ?? '';
      if (data?.avatar_url) imgAvatar.src = data.avatar_url;

      // 下方兩顆膠囊
      if (nameEl.value) chipBar.insertAdjacentHTML('beforeend', `<span class="chip">名稱　${nameEl.value}</span>`);
      if (phoneEl.value) chipBar.insertAdjacentHTML('beforeend', `<span class="chip">聯絡電話　${phoneEl.value}</span>`);
    }

    // 儲存（upsert）
    btnSave.addEventListener('click', async ()=>{
      const { data: { user }, error: authErr } = await sb.auth.getUser();
      if (authErr || !user) return showToast('尚未登入');

      const payload = {
        id: user.id,              // 一律用 auth.user.id 當主鍵
        name: nameEl.value.trim(),
        phone: phoneEl.value.trim(),
        line_id: lineEl.value.trim(),
        customer_code: customerEl.value.trim(),
        address: addressEl.value.trim(),
        // avatar_url 僅做預覽，不上傳；若你要上傳到 storage 再另行處理
      };

      const { error } = await sb
        .from('profiles')
        .upsert(payload, { onConflict: 'id' });

      if (error){
        console.error(error);
        showToast('儲存失敗');
      }else{
        showToast('已儲存');
        await loadProfile();
      }
    });

    btnReload.addEventListener('click', loadProfile);

    // 啟動
    loadProfile();
  </script>
  <script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // 這兩個用你專案的值（你現在用的就填一樣）
  const SUPABASE_URL = "jeajrwpmrgczimmrflxo";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ====== 這裡對應你的 input 元件 id（改成你頁面上的 id 即可）======
  const el = {
    full_name:  document.getElementById('fullName')   || document.getElementById('name'),
    phone:      document.getElementById('phone'),
    line_id:    document.getElementById('lineId'),
    customer:   document.getElementById('customer'),     // 身分/客編(選填)
    address:    document.getElementById('address'),
    avatarUrl:  document.getElementById('avatarUrl'),    // 若沒這欄可刪
    btnSave:    document.getElementById('btnSave'),
    btnReload:  document.getElementById('btnReload'),
    toast:      document.getElementById('toast'),        // 有就用，沒有就 alert
  };

  const say = (m)=> el.toast ? (el.toast.textContent=m, el.toast.classList.add('show'), setTimeout(()=>el.toast.classList.remove('show'),1600)) : alert(m);

  // 取得登入者
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) { say('尚未登入'); throw new Error('not logged in'); }

  // 進頁載入
  await load();

  // 綁定
  el.btnSave && el.btnSave.addEventListener('click', save);
  el.btnReload && el.btnReload.addEventListener('click', load);

  async function load() {
    const { data, error } = await supabase
      .from('profiles')
      .select('*')
      .eq('user_id', user.id)
      .single();

    if (error && error.code !== 'PGRST116') { console.error(error); say('載入失敗'); return; }

    if (data) {
      if (el.full_name) el.full_name.value = data.full_name ?? '';
      if (el.phone)     el.phone.value     = data.phone ?? '';
      if (el.line_id)   el.line_id.value   = data.line_id ?? '';
      if (el.customer)  el.customer.value  = data.customer_code ?? '';
      if (el.address)   el.address.value   = data.address ?? '';
      if (el.avatarUrl) el.avatarUrl.value = data.avatar_url ?? '';
    } else {
      // 沒資料就清空
      if (el.full_name) el.full_name.value = '';
      if (el.phone)     el.phone.value = '';
      if (el.line_id)   el.line_id.value = '';
      if (el.customer)  el.customer.value = '';
      if (el.address)   el.address.value = '';
      if (el.avatarUrl) el.avatarUrl.value = '';
    }
  }

  async function save() {
    const payload = {
      user_id: user.id,                            // 關鍵：寫回自己的那筆
      full_name:    el.full_name?.value?.trim() ?? null,
      phone:        el.phone?.value?.trim() ?? null,
      line_id:      el.line_id?.value?.trim() ?? null,
      customer_code:el.customer?.value?.trim() ?? null,
      address:      el.address?.value?.trim() ?? null,
      avatar_url:   el.avatarUrl?.value?.trim() ?? null,
      updated_at:   new Date().toISOString(),
    };

    const { error } = await supabase
      .from('profiles')
      .upsert(payload, { onConflict: 'user_id' }); // 不改結構，用 user_id 當唯一鍵

    if (error) { console.error(error); say('儲存失敗'); return; }
    say('已儲存');
  }
</script>

</body>
</html>




