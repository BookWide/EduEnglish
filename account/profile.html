<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>帳號／個人資料</title>

  <script>
    window.SB_URL  = "https://jeajrwpmrgczimmrflxo.supabase.co";
    window.SB_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      background:#fff;
      color:#000;
      font-family:'Segoe UI', sans-serif;
      padding:1.5em;
    }
    .card {
      background:#fff;
      padding:1.5em;
      border-radius:1em;
      max-width:600px;
      margin:auto;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    a.back-link {
      display:inline-block;
      margin-bottom:1em;
      color:#000;
      text-decoration:none;
      font-weight:600;
    }
    a.back-link:hover {
      text-decoration:underline;
    }
    h1 {
      text-align:center;
      margin-bottom:1em;
    }
    img {
      border-radius:50%;
      width:100px;
      height:100px;
      object-fit:cover;
      display:block;
      margin:0 auto 0.8em;
    }
    .form-row {
      display:flex;
      align-items:center;
      margin-bottom:0.5em;
      flex-wrap:wrap;
    }
    .form-row label {
      width:90px;
      font-weight:600;
      color:#111;
      margin-bottom:0.3em;
    }
    .form-row input {
      flex:1;
      padding:0.4em 0.6em;
      border:1px solid #ccc;
      border-radius:0.5em;
      font-size:1em;
      color:#000;
      background:#fff;
    }
    input[type="file"] {
      margin-top:0.5em;
    }
    button {
      display:block;
      width:100%;
      padding:0.6em;
      border:none;
      border-radius:0.5em;
      margin-top:0.8em;
      font-weight:600;
      background:#000;
      color:#fff;
      cursor:pointer;
    }
    button:hover {
      background:#333;
    }
    @media(max-width:480px){
      .form-row label {
        width:100%;
      }
    }
  </style>
</head>

<body>
  <div class="card">
    <a href="https://bookwide.github.io/EduEnglish/" class="back-link">← 回首頁</a>
    <h1>個人資料</h1>

    <img id="avatar_preview" src="" alt="頭像預覽">
    <input type="file" id="avatar_file" accept="image/*">

    <div class="form-row">
      <label>姓名：</label>
      <input id="full_name" placeholder="姓名 / 暱稱">
    </div>

    <div class="form-row">
      <label>聯絡電話：</label>
      <input id="phone" placeholder="聯絡電話">
    </div>

    <div class="form-row">
      <label>LINE ID：</label>
      <input id="line_id" placeholder="請輸入 LINE ID">
    </div>

    <div class="form-row">
      <label>WeChat ID：</label>
      <input id="wechat_id" placeholder="請輸入 WeChat ID">
    </div>

    <div class="form-row">
      <label>地址：</label>
      <input id="address" placeholder="請輸入地址">
    </div>

    
    <!-- 我的訂閱（僅顯示，使用 profiles.expires_at / last_sign_in_at） -->
    <div class="card" style="margin:1.2em auto 1.2em; padding:1em; border:1px solid #e5e7eb">
      <h2 style="text-align:left; margin:0 0 .6em 0; font-size:1.15em">我的訂閱</h2>
      <div class="form-row"><label>狀態：</label>
        <div id="sub_status" style="font-weight:700">—</div>
      </div>
      <div class="form-row"><label>方案：</label>
        <div id="sub_plan">—</div>
      </div>
      <div class="form-row"><label>到期日：</label>
        <div id="sub_expires">—</div>
      </div>
      <div class="form-row"><label>剩餘天數：</label>
        <div id="sub_days">—</div>
      </div>
      <div class="form-row"><label>最後登入：</label>
        <div id="sub_last_login">—</div>
      </div>
      <div style="display:flex; gap:.6em; margin-top:.8em">
        <button id="btnRenew" style="flex:1;background:#0ea5e9">立即續訂 / 訂閱</button>
        <a href="https://bookwide.github.io/EduEnglish/pricing.html" 
           style="flex:1;display:block;text-align:center;padding:.6em;border-radius:.5em;border:1px solid #111;color:#111;text-decoration:none">方案價格</a>
      </div>
    </div>

    <button id="saveProfile">完成並儲存</button>
    <button id="reloadBtn">重新載入</button>
  </div>

  <script>
    const supabase = window.supabase.createClient(window.SB_URL, window.SB_ANON);
    window.__profile = {
      async loadProfile() {
        const user = (await supabase.auth.getUser()).data.user;
        if (!user) return alert("請先登入");
        const { data, error } = await supabase.from("profiles").select("*").eq("id", user.id).maybeSingle();
        if (error) return console.error(error);
        if (!data) return console.warn("No profile found.");
        for (const key of ["full_name","phone","line_id","wechat_id","address"]) {
          const el = document.getElementById(key);
          if (el) el.value = data[key] || "";
        }
        if (data.avatar_url) document.getElementById("avatar_preview").src = data.avatar_url;
        console.log("Profile loaded:", data);

      // --- 訂閱顯示工具 ---
      function fmtDate(d){ try{ if(!d) return "—"; const x=new Date(d); if(isNaN(+x)) return "—"; return x.toISOString().slice(0,10);}catch(e){return "—"} }
      function daysLeft(d){ try{ if(!d) return null; const x=new Date(d).getTime(); const n=Date.now(); return Math.ceil((x-n)/86400000);}catch(e){return null} }
      function setText(id, val){ const el=document.getElementById(id); if(el) el.textContent = (val ?? "—"); }

        // 訂閱資訊 (使用 profiles 的欄位：expires_at / last_sign_in_at / plan)
        const expires = data.expires_at || data.expires || null;
        const plan = data.plan || data.plan_name || data.tier || null;
        const dl = daysLeft(expires);
        const active = expires && (new Date(expires).getTime() > Date.now());
        setText('sub_status', active ? '✅ 使用中' : '⛔ 已到期 / 未訂閱');
        setText('sub_plan', plan || '—');
        setText('sub_expires', fmtDate(expires));
        setText('sub_days', (dl==null || isNaN(dl)) ? '—' : (dl>=0 ? dl + ' 天' : (Math.abs(dl) + ' 天前到期')));
        setText('sub_last_login', fmtDate(data.last_sign_in_at));

      },

      async saveProfile() {
        const user = (await supabase.auth.getUser()).data.user;
        if (!user) return alert("請先登入");
        let avatar_url = null;
        const fileInput = document.getElementById("avatar_file");
        if (fileInput.files.length > 0) {
          const file = fileInput.files[0];
          const filePath = `${user.id}/${file.name}`;
          const { error: uploadError } = await supabase.storage.from("avatars").upload(filePath, file, { upsert: true });
          if (uploadError) return alert("上傳失敗：" + uploadError.message);
          const { data } = supabase.storage.from("avatars").getPublicUrl(filePath);
          avatar_url = data.publicUrl;
        }
        const updateData = {
          id: user.id,
          full_name: document.getElementById("full_name").value,
          phone: document.getElementById("phone").value,
          line_id: document.getElementById("line_id").value,
          wechat_id: document.getElementById("wechat_id").value,
          address: document.getElementById("address").value,
        };
        if (avatar_url) updateData.avatar_url = avatar_url;
        const { error } = await supabase.from("profiles").upsert(updateData);
        if (error) return alert("儲存失敗：" + error.message);
        alert("✅ 已保存！");
        console.log("Profile saved:", updateData);
      }
    };

    document.getElementById("saveProfile").addEventListener("click", e => window.__profile.saveProfile(e));
    document.getElementById("reloadBtn").addEventListener("click", e => window.__profile.loadProfile(e));
document.getElementById("btnRenew").addEventListener("click",()=>{ location.href="https://bookwide.github.io/EduEnglish/pricing.html"; });
    window.addEventListener("DOMContentLoaded", () => window.__profile.loadProfile());
  </script>
</body>
</html>









