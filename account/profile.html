<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>個人資料</title>
  <style>
    :root{
      --bg:#0f1a27;
      --panel:#162231;
      --muted:#a8b3c7;
      --text:#eaf0f7;
      --accent:#3b82f6;
      --input:#0e1724;
      --input-border:#243248;
      --btn:#3b82f6;
      --btn-2:#1f2a3a;
      --success:#16a34a;
    }
    html,body{background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,"Microsoft JhengHei",Arial;margin:0}
    .wrap{max-width:860px;margin:48px auto;padding:0 18px}
    .card{background:var(--panel);border-radius:22px;box-shadow:0 10px 30px rgba(3,10,24,.35);padding:36px 26px}
    h1{font-size:40px;letter-spacing:4px;text-align:center;margin:8px 0 26px}
    .avatar-holder{display:flex;justify-content:center;align-items:center;margin-top:6px;margin-bottom:18px}
    .avatar{width:140px;height:140px;border-radius:999px;object-fit:cover;border:5px solid rgba(255,255,255,.08);box-shadow:0 10px 25px rgba(0,0,0,.35)}
    .uploader{display:flex;justify-content:center;gap:10px;margin:10px 0 14px}
    .uploader input[type="file"]{color:var(--muted)}
    .form{max-width:720px;margin:0 auto}
    label{display:block;color:var(--muted);font-size:14px;margin:12px 2px 6px}
    input[type="text"], input[type="tel"]{
      width:100%;padding:14px 16px;border-radius:12px;
      background:var(--input);border:1px solid var(--input-border);color:var(--text);
      outline:none;transition:border-color .2s, box-shadow .2s;
    }
    input[type="text"]:focus, input[type="tel"]:focus{
      border-color:var(--accent); box-shadow:0 0 0 4px rgb(59 130 246 / .15);
    }
    .btn{
      width:100%;padding:16px 18px;border-radius:12px;border:0;font-weight:700;cursor:pointer;
      font-size:16px;margin-top:14px;background:var(--btn);color:#e7f1ff;
      box-shadow:0 8px 18px rgba(59,130,246,.25);
    }
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:var(--btn-2);color:var(--text);box-shadow:none;border:1px solid var(--input-border)}
    .hint{color:var(--muted);font-size:12px;margin-top:10px;text-align:center}
    label.phone-label{display:block;color:var(--text);font-size:14px;margin-top:8px;margin-bottom:4px;letter-spacing:.5px}
    #toast{
      position:fixed;left:50%;top:28px;transform:translateX(-50%);
      background:rgba(22,163,74,.95);color:#eafff3;padding:10px 14px;border-radius:999px;
      font-size:14px;box-shadow:0 10px 25px rgba(0,0,0,.25);opacity:0;pointer-events:none;
      transition:opacity .25s ease, transform .25s ease;
    }
    #toast.show{opacity:1;transform:translate(-50%, 0)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>個人資料</h1>

      <div class="avatar-holder">
        <img id="avatar" class="avatar" src="https://images.unsplash.com/photo-1524504388940-b1c1722653e1?q=80&w=400&auto=format&fit=crop" alt="avatar" />
      </div>

      <div class="uploader">
        <input id="file" type="file" accept="image/*" />
        <span class="hint">可上傳頭像；僅影響本頁預覽，既有儲存流程不變</span>
      </div>

      <div class="form">
        <label for="name">姓名</label>
        <input id="name" type="text" placeholder="請輸入姓名" />

        <label for="phone" class="phone-label">聯絡電話</label>
        <input id="phone" type="tel" placeholder="例如：0912-345-678" />

        <label for="lineId">LINE ID</label>
        <input id="lineId" type="text" placeholder="LINE ID" />

        <label for="idNo">身分 / 客編（選填）</label>
        <input id="idNo" type="text" placeholder="可留空" />

        <label for="address">通訊地址</label>
        <input id="address" type="text" placeholder="縣市區 / 路名 / 門牌" />

        <button id="btnSave" class="btn">完成並儲存</button>
        <button id="btnReload" class="btn secondary">重新載入</button>
      </div>
    </div>
  </div>

  <div id="toast">已儲存完成</div>

  <script>
    // 本地頭像預覽（不影響既有儲存流程）
    document.getElementById('file')?.addEventListener('change', (e) => {
      const f = e.target.files?.[0]; if (!f) return;
      const rdr = new FileReader();
      rdr.onload = ev => document.getElementById('avatar').src = ev.target.result;
      rdr.readAsDataURL(f);
    });

    // 簡易 Toast，沿用你的 API 名稱 showToast
    const toastEl = document.getElementById('toast');
    const showToast = (msg='已儲存完成') => {
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      setTimeout(()=>toastEl.classList.remove('show'), 1600);
    };

    // 維持舊 ID 與事件：btnSave / btnReload
    document.getElementById('btnSave')?.addEventListener('click', async () => {
      // TODO: 放回你的 Supabase / API 寫入程式
      showToast('已儲存完成');
    });
    document.getElementById('btnReload')?.addEventListener('click', () => location.reload());

    // 示範填值（若你已有載入流程，這段可移除）
    (function demoFill(){
      const setIfEmpty = (id, val) => { const el=document.getElementById(id); if(el && !el.value) el.value = val; };
      setIfEmpty('name','china');
      setIfEmpty('phone','13812946300');
      setIfEmpty('lineId','LINE ID');
      setIfEmpty('idNo','13812946300');
      setIfEmpty('address','rwerw');
    })();
  </script>
  <!-- Supabase SDK（2.x） -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ====== 你的專案參數（必填）======
  const SUPABASE_URL = 'https://YOUR-PROJECT.supabase.co';
  const SUPABASE_ANON_KEY = 'YOUR-ANON-KEY';
  // =================================
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // 元件快取（請對應你的實際 ID）
  const $ = (id) => document.getElementById(id);
  const el = {
    name: $('name'),
    phone: $('phone'),
    lineId: $('lineId'),
    taxId: $('taxId'),
    address: $('address'),
    avatar: $('avatar'),
    file: $('fileInput'),
    btnSave: $('btnSave'),
    btnReload: $('btnReload'),
  };

  // 簡易 Toast（若你已有 showToast，就用你的）
  function showToast(msg) {
    let t = document.getElementById('toast');
    if (!t) {
      t = document.createElement('div');
      t.id = 'toast';
      t.style.cssText =
        'position:fixed;top:16px;left:50%;transform:translateX(-50%);background:#10b981;color:#001b09;padding:10px 14px;border-radius:999px;font-weight:700;z-index:9999';
      document.body.appendChild(t);
    }
    t.textContent = msg;
    t.style.display = 'block';
    setTimeout(() => (t.style.display = 'none'), 1500);
  }

  // 取得登入者（未登入導回你的首頁或登入頁）
  async function getUserOrRedirect() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      location.href = '../index.html'; // 依你的路徑調整
      return null;
    }
    return user;
  }

  // 上傳頭像到 storage/avatars，回傳公開網址
  async function uploadAvatar(userId, file) {
    const ext = file.name.split('.').pop();
    const path = `${userId}/${Date.now()}.${ext || 'jpg'}`;

    // 同名覆蓋避免殘檔
    const { error: upErr } = await supabase.storage.from('avatars').upload(path, file, {
      upsert: true,
      cacheControl: '3600'
    });
    if (upErr) throw upErr;

    const { data } = supabase.storage.from('avatars').getPublicUrl(path);
    return data.publicUrl;
  }

  // 載入自己資料
  async function loadProfile(userId) {
    const { data, error } = await supabase
      .from('profiles')
      .select('name, phone, line_id, tax_id, address, avatar_url')
      .eq('user_id', userId)
      .maybeSingle();

    if (error) console.warn(error);

    if (data) {
      if (el.name)    el.name.value    = data.name     ?? '';
      if (el.phone)   el.phone.value   = data.phone    ?? '';
      if (el.lineId)  el.lineId.value  = data.line_id  ?? '';
      if (el.taxId)   el.taxId.value   = data.tax_id   ?? '';
      if (el.address) el.address.value = data.address  ?? '';
      if (el.avatar && data.avatar_url) el.avatar.src  = data.avatar_url;
    }
  }

  // 儲存（upsert by user_id）
  async function saveProfile(userId, extra = {}) {
    const payload = {
      user_id : userId,
      name    : el.name?.value?.trim()    ?? '',
      phone   : el.phone?.value?.trim()   ?? '',
      line_id : el.lineId?.value?.trim()  ?? '',
      tax_id  : el.taxId?.value?.trim()   ?? '',
      address : el.address?.value?.trim() ?? '',
      ...extra
    };

    const { error } = await supabase.from('profiles').upsert(payload, { onConflict: 'user_id' });
    if (error) throw error;
  }

  // 事件掛載
  document.addEventListener('DOMContentLoaded', async () => {
    const user = await getUserOrRedirect();
    if (!user) return;

    await loadProfile(user.id);

    // 上傳頭像預覽 + 存檔
    el.file?.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      try {
        const url = await uploadAvatar(user.id, file);
        if (el.avatar) el.avatar.src = url;
        await saveProfile(user.id, { avatar_url: url });
        showToast('頭像已更新');
      } catch (err) {
        console.error(err);
        showToast('頭像更新失敗');
      }
    });

    // 儲存
    el.btnSave?.addEventListener('click', async () => {
      try {
        await saveProfile(user.id);
        showToast('已儲存完成');
      } catch (err) {
        console.error(err);
        showToast('儲存失敗，請稍後再試');
      }
    });

    // 重新載入
    el.btnReload?.addEventListener('click', () => location.reload());
  });
</script>

</body>
</html>





