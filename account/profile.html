<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>帳號／個人資料</title>

  <!-- 1) 你的 Supabase 專案金鑰（請改成你的；若你的站上已全域定義可刪除這段） -->
  <script>
    window.SB_URL  = window.SB_URL  || "https://YOUR-PROJECT.supabase.co";
    window.SB_ANON = window.SB_ANON || "YOUR-ANON-KEY";
  </script>

  <!-- 2) Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --fg:#e5e7eb; --acc:#2563eb; --bd:#334155 }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--fg)}
    header{padding:16px 20px;border-bottom:1px solid var(--bd)}
    header h1{margin:0;font-size:18px}
    main{max-width:920px;margin:20px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:18px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .row{display:flex;gap:14px;align-items:center}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=text], input[type=email]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--bd);background:#0b1220;color:var(--fg)}
    input[type=file]{width:100%}
    .actions{margin-top:16px;display:flex;gap:10px;justify-content:flex-end}
    button{padding:10px 14px;border-radius:10px;border:1px solid var(--bd);background:var(--acc);color:#fff;cursor:pointer}
    button.ghost{background:transparent;color:var(--fg)}
    .avatar{width:96px;height:96px;border-radius:50%;border:1px solid var(--bd);object-fit:cover;background:#0b1220}
    .muted{color:var(--muted);font-size:12px}
    .two{display:grid;grid-template-columns:120px 1fr;gap:16px;align-items:center}
    @media (max-width:720px){ .grid{grid-template-columns:1fr} .two{grid-template-columns:1fr} header h1{font-size:16px} }
  </style>
</head>
<body>
  <header><h1>帳號／個人資料</h1></header>
  <main>
    <div class="card">
      <div class="two" style="margin-bottom:18px">
        <img id="avatar_preview" class="avatar" alt="頭像預覽">
        <div>
          <label for="avatar_file">大頭貼（上傳圖片）</label>
          <input id="avatar_file" type="file" accept=".jpg,.jpeg,.png,.webp,image/*">
          <div class="muted">支援 jpg / png / webp，建議 &lt; 2MB</div>
        </div>
      </div>

      <div class="grid">
        <div>
          <label for="full_name">暱稱 / 顯示名</label>
          <input id="full_name" type="text" placeholder="您的顯示名稱">
        </div>
        <div>
          <label for="nickname">備註暱稱（可留白）</label>
          <input id="nickname" type="text" placeholder="備註用暱稱">
        </div>
        <div>
          <label for="phone">聯絡電話</label>
          <input id="phone" type="text" placeholder="例：0912-345-678">
        </div>
        <div>
          <label for="line_id">LINE ID</label>
          <input id="line_id" type="text" placeholder="您的 LINE ID">
        </div>
        <div>
          <label for="wechat_id">WeChat ID</label>
          <input id="wechat_id" type="text" placeholder="您的 WeChat ID">
        </div>
        <div>
          <label for="address">通訊地址</label>
          <input id="address" type="text" placeholder="您的地址">
        </div>
      </div>

      <div class="actions">
        <button class="ghost" id="reloadBtn">重新載入</button>
        <button id="saveProfile">完成並儲存</button>
      </div>
    </div>
    <p class="muted" style="margin-top:10px">若頁面顯示「請先登入」，代表目前尚未登入。</p>
  </main>

  <script>
    // 3) 建立 Supabase client（若全域已有就沿用）
    (function ensureClient(){
      if (!window.supabase) {
        if (window.Supabase?.createClient) {
          window.supabase = window.Supabase.createClient(window.SB_URL, window.SB_ANON);
        } else if (window.supabase?.createClient) {
          window.supabase = window.supabase.createClient(window.SB_URL, window.SB_ANON);
        } else if (window.createClient) {
          window.supabase = window.createClient(window.SB_URL, window.SB_ANON);
        }
      }
    })();
  </script>

  <script>
  (async () => {
    const $ = (id) => document.getElementById(id);
    const setVal = (id, v) => { if ($(id)) $(id).value = v ?? ''; };

    // 0) 確認登入
    const { data: { user }, error: userErr } = await supabase.auth.getUser();
    if (userErr || !user) {
      alert('請先登入再編輯個人資料'); 
      return;
    }

    // 1) 載入自己的 profile → 填入表單 & 頭像
    async function loadProfile() {
      const { data, error } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', user.id)
        .maybeSingle();
      if (error) { console.error(error); return; }

      setVal('full_name',  data?.full_name);
      setVal('nickname',   data?.nickname);
      setVal('phone',      data?.phone);
      setVal('line_id',    data?.line_id);
      setVal('wechat_id',  data?.wechat_id);
      setVal('address',    data?.address);

      if (data?.avatar_url && $('avatar_preview')) $('avatar_preview').src = data.avatar_url;
    }

    // 2) 若有選檔 → 上傳到 avatars → 取公開連結
    async function uploadAvatarIfPicked() {
      const fileInput = $('avatar_file');
      if (!fileInput || !fileInput.files || fileInput.files.length === 0) return null;

      const file = fileInput.files[0];
      const ext  = (file.name.split('.').pop() || 'png').toLowerCase();
      const path = `${user.id}/${Date.now()}.${ext}`;

      const { error: upErr } = await supabase.storage
        .from('avatars')
        .upload(path, file, { upsert: true });
      if (upErr) { alert('頭像上傳失敗：' + upErr.message); return null; }

      const { data } = supabase.storage.from('avatars').getPublicUrl(path);
      return data?.publicUrl || null;
    }

    // 3) 儲存（只能寫自己的 id；RLS 會保護）
    async function saveProfile() {
      const avatarUrl = await uploadAvatarIfPicked();

      const payload = {
        id:         user.id,
        full_name:  $('full_name')?.value?.trim()  || null,
        nickname:   $('nickname')?.value?.trim()   || null,
        phone:      $('phone')?.value?.trim()      || null,
        line_id:    $('line_id')?.value?.trim()    || null,
        wechat_id:  $('wechat_id')?.value?.trim()  || null,
        address:    $('address')?.value?.trim()    || null,
      };
      if (avatarUrl) payload.avatar_url = avatarUrl;

      const { error } = await supabase.from('profiles').upsert(payload);
      if (error) { alert('儲存失敗：' + error.message); return; }

      alert('已保存');
      if (avatarUrl && $('avatar_preview')) $('avatar_preview').src = avatarUrl;
      if ($('avatar_file')) $('avatar_file').value = '';
    }

    // 綁定
    $('saveProfile')?.addEventListener('click', (e)=>{ e.preventDefault(); saveProfile(); });
    $('reloadBtn')?.addEventListener('click', (e)=>{ e.preventDefault(); loadProfile(); });

    // 首次載入
    loadProfile();
  })();
  </script>
</body>
</html>
