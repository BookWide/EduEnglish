<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>個人資料</title>

  <!-- Supabase Config (請改為你的專案資料；若全站已有可刪) -->
  <script>
    window.SB_URL  = window.SB_URL  || "https://jeajrwpmrgczimmrflxo.supabase.co";
    window.SB_ANON = window.SB_ANON || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0f172a; --fg:#e5e7eb; --muted:#94a3b8;
      --card:#162033; --bd:#2b3b55; --btn:#3b82f6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .wrap{max-width:720px; margin:32px auto; padding:0 16px;}
    .card{
      background:var(--card); border:1px solid var(--bd); border-radius:16px;
      padding:24px; box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .title{
      margin:0 0 18px 0; text-align:center; font-size:28px; letter-spacing:.08em;
      line-height:1.2;
    }
    .avatar-wrap{display:flex; flex-direction:column; align-items:center; gap:10px; margin-bottom:20px;}
    .avatar{width:120px;height:120px;border-radius:50%;border:2px solid var(--bd);object-fit:cover;background:#0b1220}
    label{display:block;font-size:13px;color:var(--muted);margin:10px 4px 6px}
    input[type=text], input[type=email]{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--bd);
      background:#0b1220; color:var(--fg); line-height:1.4; font-size:15px;
    }
    input[type=file]{width:100%}
    .actions{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:18px}
    button{
      padding:12px 16px; border-radius:12px; border:1px solid var(--bd);
      background:var(--btn); color:white; cursor:pointer; font-weight:600;
    }
    button.secondary{background:transparent; color:var(--fg)}
    .muted{color:var(--muted); font-size:12px; text-align:center; margin-top:6px}
    @media (max-width:540px){
      .wrap{margin:20px auto}
      .title{font-size:24px; margin-bottom:14px}
      .avatar{width:96px;height:96px}
      .actions{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 class="title">個人資料</h1>

      <div class="avatar-wrap">
        <img id="avatar_preview" class="avatar" alt="頭像預覽">
        <div style="width:100%">
          <label for="avatar_file">大頭貼（上傳圖片）</label>
          <input id="avatar_file" type="file" accept=".jpg,.jpeg,.png,.webp,image/*">
          <div class="muted">支援 jpg / png / webp，建議 &lt; 2MB</div>
        </div>
      </div>

      <label for="full_name">暱稱／顯示名</label>
      <input id="full_name" type="text" placeholder="您的顯示名稱">

      <label for="phone">聯絡電話</label>
      <input id="phone" type="text" placeholder="例如：0912-345-678">

      <label for="line_id">LINE ID</label>
      <input id="line_id" type="text" placeholder="您的 LINE ID">

      <label for="wechat_id">WeChat ID</label>
      <input id="wechat_id" type="text" placeholder="您的 WeChat ID">

      <label for="address">通訊地址</label>
      <input id="address" type="text" placeholder="您的地址">

      <div class="actions">
        <button id="saveProfile">完成並儲存</button>
        <button id="reloadBtn" class="secondary">重新載入</button>
      </div>
      <div class="muted">若顯示「請先登入」，代表目前尚未登入。</div>
    </div>
  </div>

  <script>
    // 建立 Supabase client（若全域已有會覆蓋成同一組）
    const supabase = (window.supabase?.createClient)
      ? window.supabase
      : (window.Supabase?.createClient
          ? window.Supabase.createClient(window.SB_URL, window.SB_ANON)
          : (window.createClient ? window.createClient(window.SB_URL, window.SB_ANON) : null));
    if (!window.supabase || !window.supabase.auth) {
      window.supabase = window.Supabase?.createClient(window.SB_URL, window.SB_ANON) || window.supabase;
    }
  </script>

  <script>
  (async () => {
    const $ = (id) => document.getElementById(id);
    const setVal = (id, v) => { const el = $(id); if (el) el.value = v ?? ''; };

    // 0) 確認登入
    const { data: { user }, error: userErr } = await supabase.auth.getUser();
    if (userErr || !user) { alert('請先登入再編輯個人資料'); return; }

    // 1) 載入自己的 profile → 填入表單 & 頭像
    async function loadProfile() {
      const { data, error } = await supabase.from('profiles').select('*').eq('id', user.id).maybeSingle();
      if (error) { console.error(error); return; }
      setVal('full_name',  data?.full_name);
      setVal('phone',      data?.phone);
      setVal('line_id',    data?.line_id);
      setVal('wechat_id',  data?.wechat_id);
      setVal('address',    data?.address);
      if (data?.avatar_url && $('avatar_preview')) $('avatar_preview').src = data.avatar_url;
    }

    // 2) 若有選檔 → 上傳到 avatars → 取公開連結
    async function uploadAvatarIfPicked() {
      const fileInput = $('avatar_file');
      if (!fileInput || !fileInput.files || fileInput.files.length === 0) return null;
      const file = fileInput.files[0];
      const ext  = (file.name.split('.').pop() || 'png').toLowerCase();
      const path = `${user.id}/${Date.now()}.${ext}`;
      const { error: upErr } = await supabase.storage.from('avatars').upload(path, file, { upsert: true });
      if (upErr) { alert('頭像上傳失敗：' + upErr.message); return null; }
      const { data } = supabase.storage.from('avatars').getPublicUrl(path);
      return data?.publicUrl || null;
    }

    // 3) 儲存（只能寫自己的 id；RLS 會保護）
    async function saveProfile(e) {
      if (e) e.preventDefault();
      const avatarUrl = await uploadAvatarIfPicked();
      const payload = {
        id:        user.id,
        full_name: $('full_name')?.value?.trim()  || null,
        phone:     $('phone')?.value?.trim()      || null,
        line_id:   $('line_id')?.value?.trim()    || null,
        wechat_id: $('wechat_id')?.value?.trim()  || null,
        address:   $('address')?.value?.trim()    || null,
      };
      if (avatarUrl) payload.avatar_url = avatarUrl;
      const { error } = await supabase.from('profiles').upsert(payload);
      if (error) { alert('儲存失敗：' + error.message); return; }
      alert('✅ 已保存！');
      if (avatarUrl && $('avatar_preview')) $('avatar_preview').src = avatarUrl;
      if ($('avatar_file')) $('avatar_file').value = '';
    }

    // 綁定
    $('saveProfile')?.addEventListener('click', saveProfile);
    $('reloadBtn')?.addEventListener('click', (e)=>{ e.preventDefault(); loadProfile(); });

    // 初次載入
    loadProfile();
    // 提供 Console 便捷
    window.__profile = { loadProfile, saveProfile };
  })();
  </script>
</body>
</html>


