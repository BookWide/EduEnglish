<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å€‹äººè³‡æ–™</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#1f2937; --panel-2:#111827;
      --text:#e5e7eb; --muted:#94a3b8; --line:#273244;
      --primary:#3b82f6; --primary-700:#1d4ed8; --ok:#10b981;
      --warn:#f59e0b; --danger:#ef4444;
      --radius:16px;
    }
    html,body{background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue","Noto Sans","Microsoft JhengHei",sans-serif;margin:0}
    .wrap{max-width:880px;margin:40px auto;padding:0 20px}
    .card{
      background:linear-gradient(180deg,var(--panel),var(--panel-2));
      border:1px solid var(--line); border-radius:var(--radius);
      padding:28px 24px; box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    h1{margin:0 0 8px 0; text-align:center; font-size:36px; letter-spacing:4px}
    .sub{color:var(--muted); text-align:center; margin-bottom:24px; font-size:14px}
    .avatar-zone{display:flex;align-items:center;gap:18px;justify-content:center;margin:6px 0 18px}
    .avatar{
      width:128px;height:128px;border-radius:999px;overflow:hidden;
      border:3px solid #0005; box-shadow:0 6px 24px #0007; background:#000;
    }
    .avatar img{width:100%;height:100%;object-fit:cover}
    .hint{color:var(--muted); font-size:12px; text-align:center}

    .form{display:grid;grid-template-columns:1fr;gap:14px;margin-top:8px}
    .row{display:flex;flex-direction:column;gap:8px}
    .label{font-size:13px;color:#cbd5e1}
    .input{
      width:100%; background:#0b1220; color:var(--text);
      border:1px solid var(--line); border-radius:12px; padding:14px 14px;
      outline:none; transition:border .15s ease, box-shadow .15s ease;
    }
    .input:focus{border-color:#4f79ff; box-shadow:0 0 0 4px #1d4ed830}
    .btns{display:flex;gap:12px;margin-top:8px}
    .btn{
      flex:1; border:0; border-radius:12px; padding:14px 18px; cursor:pointer;
      font-weight:700; font-size:16px;
    }
    .btn-primary{background:var(--primary); color:#fff}
    .btn-primary:active{transform:translateY(1px)}
    .btn-ghost{background:#0b1220; color:#d1d5db; border:1px solid var(--line)}
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:24px; background:#06121d; color:#c6f6d5; border:1px solid #134e4a;
      padding:12px 18px; border-radius:12px; display:none; box-shadow:0 10px 30px #0008; z-index:50;
    }
    .toast.show{display:block; animation:fade 2s ease}
    @keyframes fade{0%{opacity:0; transform:translate(-50%,8px)} 15%{opacity:1; transform:translate(-50%,0)} 85%{opacity:1} 100%{opacity:0}}
    .divider{height:1px;background:var(--line);margin:8px 0 4px}
    .topbar{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .home{color:var(--muted); text-decoration:none; font-size:14px}
    .home:hover{color:#cbd5e1}
    @media(min-width:720px){
      .form{grid-template-columns:1fr 1fr}
      .row.span2{grid-column:1/3}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="home" href="../index.html">â† å›é¦–é </a>
    </div>

    <div class="card">
      <h1>å€‹äººè³‡æ–™</h1>
      <div class="sub">å¯æ›´æ›é ­åƒï¼ˆåƒ…é è¦½ï¼‰ï¼Œå„²å­˜æµç¨‹ä¸è®Šã€‚</div>

      <div class="avatar-zone">
        <div class="avatar"><img id="avatarImg" src="" alt="avatar" /></div>
      </div>
      <div class="avatar-zone">
        <input type="file" id="fileAvatar" accept="image/*"/>
      </div>
      <div class="hint">å¯ä¸Šå‚³é ­åƒï¼›åƒ…å½±éŸ¿æœ¬é é è¦½ã€‚æ—¢æœ‰å„²å­˜é‚è¼¯ä¸è®Šã€‚</div>

      <div class="divider"></div>

      <div class="form">
        <div class="row">
          <label class="label" for="name">å§“å</label>
          <input id="name" class="input" placeholder="å§“å" />
        </div>

        <div class="row">
          <label class="label" for="phone">è¯çµ¡é›»è©±</label>
          <input id="phone" class="input" placeholder="09xx-xxx-xxx" />
        </div>

        <div class="row">
          <label class="label" for="line">LINE ID</label>
          <input id="line" class="input" placeholder="LINE ID" />
        </div>

        <div class="row">
          <label class="label" for="taxid">èº«åˆ†ï¼å®¢ç·¨ï¼ˆé¸å¡«ï¼‰</label>
          <input id="taxid" class="input" placeholder="èº«åˆ†è­‰å¾Œå››ç¢¼ã€æˆ–å®¢ç·¨â€¦" />
        </div>

        <div class="row span2">
          <label class="label" for="address">é€šè¨Šåœ°å€</label>
          <input id="address" class="input" placeholder="å¯„é€æˆ–è¯çµ¡åœ°å€" />
        </div>

        <div class="row span2 btns">
          <button id="btnSave" class="btn btn-primary">å®Œæˆä¸¦å„²å­˜</button>
          <button id="btnReload" class="btn btn-ghost">é‡æ–°è¼‰å…¥</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- å¦‚æœä½ çš„ç«™é»å·²ç¶“åœ¨å…¨åŸŸè¼‰å…¥ Supabase JS ä¸¦å‰µå»ºäº† window.supabaseï¼Œä»¥ä¸‹ç¨‹å¼æœƒç›´æ¥æ²¿ç”¨ -->
  <script>
    // --- å¯è¦–åŒ–ï¼šæœ¬åœ°é ­åƒé è¦½ï¼ˆä¸å½±éŸ¿ä½ åŸæœ¬ä¸Šå‚³æµç¨‹ï¼‰ ---
    (function () {
      const file = document.getElementById('fileAvatar');
      const img  = document.getElementById('avatarImg');
      file.addEventListener('change', () => {
        const f = file.files?.[0];
        if (!f) return;
        const url = URL.createObjectURL(f);
        img.src = url;
      });
    })();

    // --- UI è¼”åŠ© ---
    const qs = (s)=>document.querySelector(s);
    const toast = (msg)=>{
      const el = document.getElementById('toast');
      el.textContent = msg; el.classList.add('show');
      setTimeout(()=>el.classList.remove('show'), 1800);
    };

    // --- æ¬„ä½å°æ‡‰ï¼ˆä¿ç•™åŸæœ¬ idï¼Œåƒ…æ¨£å¼ä¸åŒï¼‰ ---
    const $name    = qs('#name');
    const $phone   = qs('#phone');
    const $line    = qs('#line');
    const $taxid   = qs('#taxid');
    const $address = qs('#address');
    const $avatar  = qs('#fileAvatar');
    const $avatarImg = qs('#avatarImg');

    // === è³‡æ–™è¼‰å…¥èˆ‡å„²å­˜ï¼ˆç¶­æŒä½ åŸæœ‰çš„ supabase é‚è¼¯ï¼›åªæ˜¯åŒ…ä¸€å±¤å‡½å¼ï¼‰
    // é‡è¦ï¼šè‹¥ä½ çš„ profiles éµåæ˜¯ã€Œidã€è€Œéã€Œuser_idã€ï¼ŒæŠŠä¸‹åˆ— user_id å…¨éƒ¨æ”¹æˆ idã€‚
    async function getCurrentUser() {
      if (!window.supabase) { console.warn('supabase å°šæœªæ³¨å…¥ï¼šå°‡åªé¡¯ç¤ºè¡¨å–®æ¨£å¼'); return null; }
      const { data: { user } } = await supabase.auth.getUser();
      return user || null;
    }

    async function loadProfile() {
      const user = await getCurrentUser();
      if (!user) return;

      // è®€å–é ­åƒï¼šè‹¥ä½ åŸæœ¬æœ‰å­˜ URLï¼Œå¯è‡ªè¡Œæ”¹æˆå¾ profiles æ¬„ä½å¸¶å‡º
      // ä¸‹é¢é€™æ®µåªæ˜¯å°‡é è¨­é ­åƒç½®å…¥ï¼ˆè‹¥ä½ å·²æœ‰é ­åƒ URLï¼Œæ”¹æˆ $avatarImg.src = yourUrlï¼‰
      if (!$avatarImg.src) {
        $avatarImg.src = 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=512&h=512&fit=crop';
      }

      // è®€å– profilesï¼ˆéµåä¾ä½ çš„è¡¨è¨­è¨ˆèª¿æ•´ï¼‰
      const { data, error } = await supabase
        .from('profiles')
        .select('*')
        .eq('user_id', user.id)   // â† å¦‚æœä½ çš„éµæ˜¯ idï¼Œæ”¹æˆ .eq('id', user.id)
        .maybeSingle();

      if (error) { console.error(error); toast('è®€å–å¤±æ•—'); return; }

      if (data) {
        $name.value    = data.name    ?? '';
        $phone.value   = data.phone   ?? '';
        $line.value    = data.line_id ?? '';
        $taxid.value   = data.tax_id  ?? '';
        $address.value = data.address ?? '';
        if (data.avatar_url) $avatarImg.src = data.avatar_url;
      } else {
        // æ²’è³‡æ–™å‰‡æ¸…ç©º
        $name.value = $phone.value = $line.value = $taxid.value = $address.value = '';
      }
    }

    async function saveProfile() {
      const user = await getCurrentUser();
      if (!user) return;

      // ä½ åŸæœ¬çš„é ­åƒä¸Šå‚³æµç¨‹è‹¥æœ‰ç”¨ Storageï¼Œè«‹åœ¨é€™è£¡å‘¼å«ï¼Œ
      // ä¾‹å¦‚ï¼šä¸Šå‚³å¾Œå–å¾— publicURL -> avatarUrlï¼Œå†ä¸€èµ· upsertã€‚
      let avatarUrl;
      // if ($avatar.files?.[0]) { ... ä¸Šå‚³è‡³ storageï¼Œå–å¾— avatarUrl ... }

      const payload = {
        user_id: user.id,               // è‹¥ä½ çš„éµç‚º id â†’ æ”¹æˆ id:user.id
        name: $name.value.trim(),
        phone: $phone.value.trim(),
        line_id: $line.value.trim(),
        tax_id: $taxid.value.trim(),
        address: $address.value.trim(),
      };
      if (avatarUrl) payload.avatar_url = avatarUrl;

      const { error } = await supabase
        .from('profiles')
        .upsert(payload, { onConflict: 'user_id' }); // è‹¥éµç‚º id â†’ { onConflict: 'id' }

      if (error) { console.error(error); toast('å„²å­˜å¤±æ•—'); }
      else toast('å·²å„²å­˜å®Œæˆ');
    }

    // ç¶å®š
    document.getElementById('btnSave')?.addEventListener('click', async ()=>{
      try { await saveProfile(); } catch(e){ console.error(e); toast('å„²å­˜å¤±æ•—'); }
    });
    document.getElementById('btnReload')?.addEventListener('click', async ()=>{
      try { await loadProfile(); toast('å·²é‡æ–°è¼‰å…¥'); } catch(e){ console.error(e); }
    });

    // åˆå§‹è¼‰å…¥
    (async()=>{ try { await loadProfile(); } catch(e){ console.error(e); }})();
  </script>
  <script>
/* ===== Quick Patch: å…è¨±ç©ºç™½å„²å­˜ + ç„¡å”¯ä¸€éµæ™‚çš„ updateâ†’insert ===== */
(function () {
  const $ = (s) => document.querySelector(s);
  const $name = $('#name'), $phone = $('#phone'), $line = $('#line'),
        $taxid = $('#taxid'), $address = $('#address');

  // å–ç›®å‰ç™»å…¥è€…
  async function getUser() {
    if (!window.supabase) { alert('Supabase å°šæœªè¼‰å…¥'); throw new Error('no supabase'); }
    const { data: { user }, error } = await supabase.auth.getUser();
    if (error || !user) { alert('å°šæœªç™»å…¥'); throw error || new Error('no user'); }
    return user;
  }

  // ä¸»è¦ï¼šå…è¨±ç©ºç™½ä¹Ÿå„²å­˜ï¼›è‹¥ç„¡è³‡æ–™å…ˆ update å¤±æ•—æ™‚å† insert
  async function saveEvenIfEmpty() {
    const user = await getUser();

    // ğŸ‘‰ è‹¥ä½ çš„ profiles éµæ˜¯ idï¼Œæ”¹æˆ id: user.id ä¸¦æŠŠä¸‹é¢ eq('id', â€¦) ä¸€ä½µæ”¹æ‰
    const payload = {
      user_id: user.id,
      name   : ($name.value ?? '').trim(),
      phone  : ($phone.value ?? '').trim(),
      line_id: ($line.value ?? '').trim(),
      tax_id : ($taxid.value ?? '').trim(),
      address: ($address.value ?? '').trim(),
    };

    // 1) å…ˆè©¦è‘— update
    let { error: upErr, count } = await supabase
      .from('profiles')
      .update(payload)
      .eq('user_id', user.id)                // â† è‹¥éµæ˜¯ idï¼Œæ”¹æˆ .eq('id', user.id)
      .select('user_id', { count: 'exact', head: true });

    if (upErr) {
      console.error('[profiles.update] error', upErr);
      alert('å„²å­˜å¤±æ•—ï¼ˆupdateï¼‰');
      return;
    }

    // 2) æ²’æœ‰è³‡æ–™æ‰æ’å…¥
    if (!count) {
      const { error: insErr } = await supabase
        .from('profiles')
        .insert(payload);

      if (insErr) {
        console.error('[profiles.insert] error', insErr);
        alert('å„²å­˜å¤±æ•—ï¼ˆinsertï¼‰');
        return;
      }
    }

    // æˆåŠŸ
    const t = document.getElementById('toast');
    if (t) { t.textContent = 'å·²å„²å­˜å®Œæˆ'; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1600); }
  }

  // æŠŠä½ çš„å„²å­˜æŒ‰éˆ•äº‹ä»¶ã€Œè¦†è“‹ã€ç‚ºé€™å€‹å®¹éŒ¯ç‰ˆ
  document.getElementById('btnSave')?.addEventListener('click', (e) => {
    e.preventDefault();
    saveEvenIfEmpty().catch(console.error);
  });
})();
</script>

</body>
</html>
