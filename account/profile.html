<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>個人資料</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #1f2937;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --line: #273244;
      --primary: #3b82f6;
      --radius: 16px;
    }
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:"Microsoft JhengHei","Noto Sans TC",system-ui,sans-serif}
    .wrap{max-width:880px;margin:40px auto;padding:0 20px}
    .card{background:var(--panel);border-radius:var(--radius);padding:32px;
      box-shadow:0 6px 20px rgba(0,0,0,.25)}
    h1{text-align:center;font-size:32px;margin:0 0 10px}
    .avatar{display:flex;justify-content:center;gap:18px;align-items:center;margin:10px 0 18px}
    .avatar img{width:140px;height:140px;border-radius:50%;border:3px solid #0005;object-fit:cover}
    .hint{color:var(--muted);font-size:13px;text-align:center;margin-top:-4px;margin-bottom:12px}
    label{display:block;color:var(--muted);font-size:14px;margin-top:10px}
    input[type="text"],input[type="tel"]{
      width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);
      background:#0b1220;color:var(--text);margin-top:6px
    }
    input[type="file"]{color:var(--muted)}
    button{width:100%;border:none;border-radius:10px;padding:14px;font-size:16px;
      font-weight:700;cursor:pointer;margin-top:14px}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-ghost{background:#0b1220;color:#ccc;border:1px solid var(--line)}
    .toast{position:fixed;left:50%;bottom:30px;transform:translateX(-50%);
      background:#06121d;color:#baf;padding:10px 18px;border-radius:10px;display:none}
    .toast.show{display:block}
    a.back{color:var(--muted);text-decoration:none;display:inline-block;margin-bottom:20px}
    a.back:hover{color:#cbd5e1}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:720px){.row{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <a href="../index.html" class="back">← 回首頁</a>
    <div class="card">
      <h1>個人資料</h1>

      <div class="avatar">
        <img id="avatarImg" src="https://via.placeholder.com/140?text=avatar" alt="avatar" />
        <div>
          <input type="file" id="fileAvatar" accept="image/*" />
        </div>
      </div>
      <div class="hint">可上傳頭像（僅預覽），儲存流程不變。若儲存成功會把圖片網址寫入此帳號的個人資料。</div>

      <div class="row">
        <div>
          <label>姓名</label>
          <input id="name" type="text" placeholder="姓名" />
        </div>
        <div>
          <label>聯絡電話</label>
          <input id="phone" type="tel" placeholder="09xx-xxx-xxx" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>LINE ID</label>
          <input id="line" type="text" placeholder="LINE ID" />
        </div>
        <div>
          <label>身分／客編（選填）</label>
          <input id="taxid" type="text" placeholder="身分證後四碼或客編…" />
        </div>
      </div>

      <label>通訊地址</label>
      <input id="address" type="text" placeholder="寄送或聯絡地址" />

      <button id="btnSave" class="btn-primary">完成並儲存</button>
      <button id="btnReload" class="btn-ghost">重新載入</button>
    </div>
  </div>

  <div id="toast" class="toast">已儲存完成</div>

  <!-- Supabase v2（UMD） -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script>
    /* ======= 改成你的專案設定 ======= */
    const SUPABASE_URL = "https://你的project.supabase.co";          // ← 改成你的
    const SUPABASE_KEY = "你的public anon key";                     // ← 改成你的
    const AVATAR_BUCKET = "avatars";                                // 需先在 Storage 建立（建議 public）

    /* ======= 初始化 ======= */
    window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const $ = (id)=>document.getElementById(id);
    const toast = (msg)=>{ const t=$("toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1600); };

    let currentUser = null;
    let latestAvatarUrl = "";   // 目前預覽/上傳完成後的網址（一起寫入 profiles）

    async function getAuthedUser(){
      const { data, error } = await supabase.auth.getUser();
      if(error || !data?.user){ alert("尚未登入，請先登入帳號"); throw error || new Error("no user"); }
      return data.user;
    }

    async function loadProfile(){
      currentUser = await getAuthedUser();
      const { data, error } = await supabase.from("profiles")
        .select("*").eq("user_id", currentUser.id).maybeSingle();
      if(error){ console.warn(error); }

      if(data){
        $("name").value = data.name || "";
        $("phone").value = data.phone || "";
        $("line").value = data.line_id || "";
        $("taxid").value = data.tax_id || "";
        $("address").value = data.address || "";
        if(data.avatar_url){
          latestAvatarUrl = data.avatar_url;
          $("avatarImg").src = data.avatar_url;
        }
      }else{
        // 沒有紀錄也沒關係，維持空白即可
      }
    }

    // 上傳頭像（立即上傳，完成後只更新 latestAvatarUrl；按下「完成並儲存」時才 upsert 個資）
    $("fileAvatar").addEventListener("change", async (e)=>{
      const file = e.target.files?.[0];
      if(!file || !currentUser) return;

      // 先做本機預覽（避免等上傳）
      const local = URL.createObjectURL(file);
      $("avatarImg").src = local;

      // 檔名：避免快取與覆蓋，帶上時間戳
      const path = `${currentUser.id}/${Date.now()}_${file.name.replace(/\s+/g,"_")}`;

      // 上傳到 avatars bucket
      const { error: upErr } = await supabase.storage.from(AVATAR_BUCKET).upload(path, file, {
        cacheControl: "3600",
        upsert: false,
        contentType: file.type || "image/jpeg",
      });
      if(upErr){
        console.error(upErr);
        toast("頭像上傳失敗");
        return;
      }

      // 取得公開網址（bucket 建議設為 public；否則可改用 createSignedUrl）
      const { data: pub, error: pubErr } = supabase.storage.from(AVATAR_BUCKET).getPublicUrl(path);
      if(pubErr){
        console.error(pubErr);
        toast("取得頭像網址失敗");
        return;
      }

      latestAvatarUrl = pub.publicUrl;
      // 改用真正的 CDN 網址（避免 blob 預覽）
      $("avatarImg").src = latestAvatarUrl;
      toast("頭像已上傳");
    });

    // 儲存個資（含 avatar_url）
    async function saveProfile(){
      const payload = {
        user_id : currentUser.id,
        name    : $("name").value.trim(),
        phone   : $("phone").value.trim(),
        line_id : $("line").value.trim(),
        tax_id  : $("taxid").value.trim(),
        address : $("address").value.trim(),
        avatar_url: latestAvatarUrl || null
      };
      const { error } = await supabase.from("profiles")
        .upsert(payload, { onConflict: "user_id" });
      if(error){ console.error(error); toast("儲存失敗"); return; }
      toast("已儲存完成");
    }

    $("btnSave").addEventListener("click", saveProfile);
    $("btnReload").addEventListener("click", loadProfile);

    // 首次載入
    loadProfile();
  </script>
</body>
</html>


