<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>BookWide | 看影片、做測驗、背單字，一頁完成</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="BookWide 用故事、音樂、電影、新聞、專業主題帶你學英文，逐句播放、雙語字幕、單字卡與分區測驗，完整練到聽讀寫。">
  <link rel="icon" href="bookwide-logo-64.png">
  <style>
    :root{--nav-bg:#0b1324;--nav-ink:#eaf1ff;--nav-muted:#a8b6d3;--nav-pill:#1a2650;--nav-badge:#1c3adf;--chip:#eef2fb;--panel:#f4f7fb;--border:#e4e9f2;--accent:#275cf5;--chip:#eef2fb;}
    *{box-sizing:border-box} html,body{height:100%;margin:0;font-family:ui-sans-serif,system-ui,"Noto Sans TC",Arial}
    a{color:inherit;text-decoration:none} img{max-width:100%;display:block}
    .nav{position:sticky;top:0;z-index:50;background:var(--nav-bg);color:var(--nav-ink);border-bottom:1px solid rgba(255,255,255,.06)}
    .nav .bar{max-width:1200px;margin:0 auto;padding:14px 16px;display:flex;align-items:center;gap:14px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:20px}
    .badge{font-size:12px;padding:2px 8px;border-radius:999px;background:var(--nav-pill);color:#dfe8ff;border:1px solid rgba(255,255,255,.15)}
    .nav-spacer{flex:1}
    .nav a.btn,.nav button.btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:transparent;cursor:pointer}
    .nav a.btn:hover,.nav button.btn:hover{background:rgba(255,255,255,.06)}

    /* 服務導覽 dropdown */
    .svc-dropdown-wrap{ position:relative; 
...
    .lead{font-size:16px;color:#555;margin:8px 0 18px}
    .feat-row{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px}
    .feat{background:#f5f7ff;border-radius:999px;padding:4px 10px;font-size:13px;color:#334}
    .feat .name{font-weight:600;margin-right:2px;display:inline-block}
    .feat .muted{opacity:.8;display:inline-block}

    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 18px}
    .tab{background:var(--chip);border:1px solid var(--border);color:#111;padding:8px 12px;border-radius:999px;cursor:pointer}
    .tab.on{background:#0b53ff;color:#fff;border-color:#0b53ff}
    .level-bar{display:flex;flex-wrap:wrap;gap:8px;margin:0 0 10px}
    .level-pill{border-radius:999px;padding:6px 14px;border:1px solid var(--border);background:#fff;color:#444;font-size:14px;cursor:pointer}
    .level-pill.on{background:#111;color:#fff;border-color:#111}
    .searchbar{display:flex;gap:8px;align-items:center;margin:6px 0 12px}
    .searchbar input{flex:1;height:40px;border-radius:10px;border:1px solid var(--border);padding:0 12px;background:#fff;color:#111}
    .searchbar button{height:40px;padding:0 16px;border-radius:10px;border:1px solid var(--border);background:#fff}
    .searchbar button:hover{background:#f7f8ff}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px;margin:18px 0 40px}
    .card{display:flex;flex-direction:column;background:#fff;border-radius:16px;border:1px solid #e1e6f0;overflow:hidden;box-shadow:0 6px 18px rgba(15,35,95,.06);transition:transform .15s,box-shadow .15s}
    .card:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(15,35,95,.12)}
    .thumb-wrap{position:relative}
    .thumb{aspect-ratio:16/9;background:#000;overflow:hidden}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .pill{position:absolute;left:10px;bottom:10px;background:rgba(10,22,59,.88);border-radius:999px;padding:4px 10px;font-size:12px;color:#fff}
    .pad{padding:10px 12px 12px}
    .title{font-weight:600;font-size:15px;margin-bottom:6px;color:#111;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .meta{font-size:12px;color:#667;display:flex;justify-content:space-between;gap:6px}
    .meta span{white-space:nowrap}

    #siteFooter{margin:10px 0 24px;font-size:12px;color:#777;text-align:center}

    @media (max-width:768px){
      .hero{margin-top:14px}
      .hero h1{font-size:22px}
      .lead{font-size:14px}
    }
  </style>
</head>
<body>
  <header class="nav">
    <!-- 這裡保留你原本的導航與登入狀態顯示 ... -->
  </header>

  <main>
    <!-- 你的 hero、功能介紹區塊 ... -->

    <section id="catalogSection">
      <!-- 類別 tabs -->
      <div class="tabs" id="tabBar">
        <div class="tab on" data-cat="all">全部</div>
        <div class="tab" data-cat="story">故事</div>
        <div class="tab" data-cat="music">音樂</div>
        <div class="tab" data-cat="movie">電影</div>
        <div class="tab" data-cat="news">新聞</div>
        <div class="tab" data-cat="pro">專業行業</div>
      </div>
      <div class="level-bar" id="levelBar">
        <button class="level-pill on" data-level="all">全部程度</button>
        <button class="level-pill" data-level="basic">初級</button>
        <button class="level-pill" data-level="intermediate">中級</button>
        <button class="level-pill" data-level="advanced">進階</button>
      </div>
      <div class="searchbar">
        <input id="kw" type="search" placeholder="搜尋標題、關鍵字…">
        <button class="btn" id="btnSearch">搜尋</button>
      </div>
    </section>

    <section id="catalog" class="grid"></section>

    <footer id="siteFooter">© <span id="y"></span> BookWide · 建議使用最新 Chrome / Edge / Safari。</footer>
  </main>

  <!-- Auth Modal ... -->

  <script type="module">
    const $ = (s) => document.querySelector(s);

    const grid    = $('#catalog');
    const tabsEl  = $('#tabBar');
    const levelEl = $('#levelBar');
    const kwInput = $('#kw');
    const btnSearch = $('#btnSearch');

    const BASE = '/EduEnglish';
    const PATHS = {
      story: `${BASE}/data/story/story-index.json`,
      music: `${BASE}/data/music/music-index.json`,
      movie: `${BASE}/data/movie/movie-index.json`,
      news:  `${BASE}/data/news/news-index.json`,
      pro:   `${BASE}/data/pro/pro-index.json`,
    };

    const tagName = (cat) => ({story:'故事', music:'音樂', movie:'電影', news:'新聞', pro:'專業行業'})[cat] || '教材';

    function cardHTML(it){
      const href  = `${BASE}/player.html?cat=${encodeURIComponent(it.cat)}&slug=${encodeURIComponent(it.slug)}`;
      const cover = it.cover && it.cover.trim()
        ? it.cover
        : (it.youtubeId ? `https://img.youtube.com/vi/${it.youtubeId}/hqdefault.jpg` : `${BASE}/img/placeholder.jpg`);
      return `<a class="card" href="${href}">
        <div class="thumb-wrap">
          <div class="thumb"><img src="${cover}" alt="${it.title||it.slug}" onerror="this.style.opacity=.6"></div>
          <div class="pill">${tagName(it.cat)}</div>
        </div>
        <div class="pad">
          <div class="title">${it.title || it.slug}</div>
          <div class="meta"><span>時長 ${it.mins||'–'} 分</span><span>程度 ${it.level||'–'}</span></div>
        </div>
      </a>`;
    }

    function render(list){ grid.innerHTML = list.map(cardHTML).join(''); }

    let CATALOG = [];

    function ensureDefaultTab(){
      const on = tabsEl?.querySelector('.tab.on');
      if (!on) tabsEl?.querySelector('[data-cat="all"]')?.classList.add('on');
    }

    function filterAndRender(){
      ensureDefaultTab();
      const active = tabsEl?.querySelector('.tab.on')?.dataset.cat || 'all';
      const activeLevel = levelEl?.querySelector('.level-pill.on')?.dataset.level || 'all';
      const q = (kwInput?.value || '').trim().toLowerCase();

      let pool = (active === 'all') ? CATALOG : CATALOG.filter(x => x.cat === active);

      // 難度過濾（全部 / 初級 / 中級 / 進階）
      if (activeLevel !== 'all') {
        pool = pool.filter(x => {
          const lv = (x.level || '').toString().toLowerCase();
          if (!lv) return false;
          if (activeLevel === 'basic') {
            return lv.includes('basic') || lv.includes('beginner') || lv.includes('初級');
          }
          if (activeLevel === 'intermediate') {
            return lv.includes('intermediate') || lv.includes('中級');
          }
          if (activeLevel === 'advanced') {
            return lv.includes('advanced') || lv.includes('upper') || lv.includes('進階') || lv.includes('高級');
          }
          return true;
        });
      }

      if (q) {
        pool = pool.filter(x =>
          (x.title + ' ' + (x.topic||'') + ' ' + (x.slug||'') + ' ' + (x.tags||[]).join(' '))
            .toLowerCase()
            .includes(q)
        );
      }
      render(pool);
    }

    // tab & 程度 & 搜尋事件
    tabsEl?.addEventListener('click', (e)=>{
      const tab = e.target.closest('.tab'); if(!tab) return;
      tabsEl.querySelectorAll('.tab').forEach(t => t.classList.remove('on'));
      tab.classList.add('on');
      filterAndRender();
    });
    levelEl?.addEventListener('click', (e)=>{
      const pill = e.target.closest('.level-pill'); if(!pill) return;
      levelEl.querySelectorAll('.level-pill').forEach(p => p.classList.remove('on'));
      pill.classList.add('on');
      filterAndRender();
    });
    btnSearch?.addEventListener('click', filterAndRender);
    kwInput?.addEventListener('keydown', e => { if (e.key === 'Enter') filterAndRender(); });

    // 靜態 JSON 讀取（維持相容）
    async function loadIndex(url, cat){
      try{
        const res = await fetch(url);
        if (!res.ok) return [];
        const arr = await res.json();
        return (Array.isArray(arr) ? arr : (arr.items || [])).map(x => ({
          cat,
          slug: x.slug,
          title: x.title,
          cover: x.cover,
          mins: x.mins,
          level: x.level || x.difficulty || null,
          topic: x.topic,
          tags:  x.tags
        }));
      }catch(e){
        console.error('[BW-index] 靜態 JSON 讀取失敗', url, e);
        return [];
      }
    }

    // Supabase 讀取（優先）
    async function loadFromSupabase(){
      try{
        if (!window.supa) {
          console.warn('[BW-index] 未找到 Supabase 客戶端');
          return [];
        }
        const { data, error } = await window.supa
          .from('videos')
          .select('category, slug, title, cover_path, duration_sec, is_public'); // 保持跟原本一樣欄位

        if (error) {
          console.error('[BW-index] Supabase 語料讀取錯誤', error);
          return [];
        }
        const list = [];
        const { publicUrlFromPath } = window.bwStorage || {};
        for(const r of data){
          const cover = await publicUrlFromPath(r.cover_path);
          list.push({
            cat: r.category,
            slug: r.slug,
            title: r.title || r.slug,
            cover: cover || null,
            mins: (r.duration_sec ? Math.max(1, Math.round(r.duration_sec/60)) : '–'),
            level: (r.level || r.difficulty || 'Intermediate') // 若未來資料表有 level / difficulty 欄位可改為 r.level
          });
        }
        return list;
      }catch{
        return [];
      }
    }

    (async () => {
      const y = document.querySelector('#y'); 
      if (y) y.textContent = new Date().getFullYear();

      let supaList = await loadFromSupabase();

      if (supaList && supaList.length) {
        CATALOG = supaList;
      } else {
        const lists = await Promise.all(Object.entries(PATHS).map(([cat, url]) => loadIndex(url, cat)));
        CATALOG = lists.flat();
      }

      filterAndRender();
      setTimeout(filterAndRender,0);
    })();
  </script>
</body>
</html>
