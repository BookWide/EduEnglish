<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide · Admin 主控台</title>
  <link rel="icon" href="data:,">
  <style>
    :root{--bg:#0f172a;--card:#111827;--text:#e5e7eb;--muted:#9ca3af;--accent:#10b981;--danger:#ef4444;--line:#1f2937;--chip:#0b5;--chip-off:#777;}
    html,body{margin:0;padding:0;background:#0b1220;color:var(--text);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Ubuntu,"Helvetica Neue",Arial;}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    .nav{display:flex;align-items:center;justify-content:space-between;padding:12px 24px;background:#0a1020;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:10}
    .brand{font-weight:700;font-size:20px}
    .menu{display:flex;gap:16px;align-items:center}
    .btn{background:#1f2937;border:1px solid #263244;color:#e5e7eb;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn:hover{background:#243041}
    .pill{display:inline-flex;align-items:center;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:6px}
    .pill-on{background:var(--accent);color:#04160f}
    .pill-off{background:#334155;color:#cbd5e1}
    .badge{background:var(--accent);color:#032012;border-radius:999px;display:inline-flex;align-items:center;justify-content:center;padding:0 8px;min-width:22px;height:22px;margin-left:6px;font-size:12px;font-weight:700}
    .grid{display:grid;gap:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
    h1{margin:0 0 8px;font-size:22px}
    h2{margin:0 0 14px;font-size:18px}
    .muted{color:var(--muted)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .field{display:flex;align-items:center;gap:8px;background:#0c1528;border:1px solid #1e293b;border-radius:10px;padding:8px 10px}
    .field input{background:transparent;border:0;outline:0;color:var(--text);min-width:260px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid #1e293b;vertical-align:middle}
    th{color:#cbd5e1;text-align:left;font-weight:600}
    td .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;vertical-align:-1px}
    .dot-on{background:var(--accent)}
    .dot-off{background:#64748b}
    .right{display:flex;gap:8px;align-items:center}
    .link{color:#93c5fd}
    .foot{margin-top:16px;color:#8ca3bf;font-size:12px}
    .hide{display:none!important}
    @media (max-width:820px){ .field input{min-width:140px} th:nth-child(4),td:nth-child(4){display:none} }
  </style>
</head>
<body>
  <nav class="nav">
    <div class="brand">BookWide <span class="muted">Beta</span></div>
    <div class="menu">
      <div id="menu-profile" class="muted">未登入</div>
      <button id="menu-admin" class="btn hide">Admin 主控台 <span id="badge-online" class="badge">0</span></button>
    </div>
  </nav>

  <main class="wrap grid">
    <!-- Hero / 入口區 -->
    <section class="card">
      <h1>看影片・做測驗・背單字——一頁完成</h1>
      <div class="muted">這是首頁示意，保留你的服務導覽動線。</div>
      <div class="right" style="margin-top:10px">
        <a class="btn" href="#" id="try-mid">試看：故事《Mid-Autumn》</a>
        <a class="btn" href="#" id="goto-teach">瀏覽教材</a>
      </div>
    </section>

    <!-- Admin 主控台 -->
    <section class="card" id="admin-panel">
      <div class="right" style="justify-content:space-between">
        <h2>Admin 主控台</h2>
        <div class="toolbar">
          <label class="field"><input id="q" placeholder="搜尋 Email / 名稱…" /></label>
          <button id="btn-refresh" class="btn">重新整理</button>
        </div>
      </div>

      <div class="muted" style="margin:6px 0 14px">
        使用者清單（Email／顯示名稱／管理員／最後登入／到期日・在線）。時間以台灣時間（Asia/Taipei）顯示。
      </div>

      <div class="table">
        <table id="tbl">
          <thead>
            <tr>
              <th>Email</th>
              <th>顯示名稱</th>
              <th>管理員</th>
              <th>最後登入</th>
              <th>到期日 / 在線</th>
            </tr>
          </thead>
          <tbody id="rows"><tr><td class="muted" colspan="5">讀取中…</td></tr></tbody>
        </table>
      </div>
      <div class="foot" id="foot-note">最近載入：—</div>
    </section>
  </main>

  <!-- Supabase CDN -->
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <script>
  // ====== 1) 你的 Supabase 設定（請替換為你的專案） ==========================
  const SUPABASE_URL  = 'https://YOUR-PROJECT.supabase.co';      // ← 換成你的
  const SUPABASE_KEY  = 'YOUR-ANON-KEY';                          // ← 換成你的
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
  });

  // ====== 2) 共用工具 =======================================================
  const TPE = 'Asia/Taipei';
  const ONLINE_WINDOW_MIN = 10;      // 視為在線的時間窗（分鐘）
  const HEARTBEAT_MIN     = 2;       // 心跳頻率（分鐘）

  const $ = (sel,root=document)=>root.querySelector(sel);
  const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
  const fmtTPE = ts=>{
    if(!ts) return '';
    try{
      const d = new Date(ts);
      return d.toLocaleString('zh-TW',{timeZone:TPE,hour12:false});
    }catch(e){ return ts }
  };
  const nowUTC = ()=>new Date().toISOString();

  // ====== 3) Admin 行為微調（不改結構） =====================================
  function setOnlineBadge(n){ $('#badge-online').textContent = String(n) }
  function showAdminMenu(isAdmin){ $('#menu-admin').classList.toggle('hide', !isAdmin) }
  $('#menu-admin').addEventListener('click',()=>$('#admin-panel').scrollIntoView({behavior:'smooth'}));

  // ====== 4) 載入目前使用者 + 心跳更新 last_seen =============================
  let currentProfile = null;

  async function getCurrentProfile(){
    const { data:{ user } } = await supabaseClient.auth.getUser();
    if(!user){ $('#menu-profile').textContent='未登入'; return null }
    const { data, error } = await supabaseClient
      .from('profiles')
      .select('id,email,full_name,display_name,is_admin,last_sign_in_at,last_seen')
      .eq('id', user.id).maybeSingle();
    if(error){ console.error(error); return null }
    currentProfile = data||null;
    const name = currentProfile?.display_name || currentProfile?.full_name || (user.email||'');
    $('#menu-profile').textContent = name;
    showAdminMenu(!!currentProfile?.is_admin);
    return currentProfile;
  }

  async function heartbeat(){
    if(!currentProfile) return;
    const { error } = await supabaseClient
      .from('profiles')
      .update({ last_seen: nowUTC() })
      .eq('id', currentProfile.id);
    if(error) console.warn('heartbeat error:', error.message);
  }

  function startHeartbeat(){
    heartbeat(); // 立即一次
    setInterval(heartbeat, HEARTBEAT_MIN*60*1000);
  }

  // ====== 5) 載入使用者清單，計算在線，渲染表格 ==============================
  async function loadAdminList(){
    const kw = $('#q').value.trim().toLowerCase();
    const { data, error } = await supabaseClient
      .from('profiles')
      .select('id,email,full_name,display_name,is_admin,last_sign_in_at,last_seen')
      .order('last_seen',{ ascending:false });

    if(error){ renderError(error.message); return }

    let rows = data || [];
    if(kw){
      rows = rows.filter(r=>{
        const dn = (r.display_name||r.full_name||'').toLowerCase();
        const em = (r.email||'').toLowerCase();
        return dn.includes(kw) || em.includes(kw);
      });
    }
    renderRows(rows);
    $('#foot-note').textContent = '最近載入：' + fmtTPE(Date.now());
    updateOnlineBadgeFromRows(rows);
  }

  function renderError(msg){
    $('#rows').innerHTML = `<tr><td colspan="5" class="muted">讀取失敗：${msg}</td></tr>`;
  }

  function onlineJudge(ts){
    const base = ts ? new Date(ts).getTime() : 0;
    const win  = ONLINE_WINDOW_MIN*60*1000;
    return base && (Date.now()-base) <= win;
  }

  function renderRows(rows){
    const tb = $('#rows'); tb.innerHTML = '';
    if(!rows.length){ tb.innerHTML = '<tr><td class="muted" colspan="5">沒有資料</td></tr>'; return }

    rows.forEach(r=>{
      const name = r.display_name || r.full_name || '';
      const email = r.email || '';
      const last  = fmtTPE(r.last_seen || r.last_sign_in_at || '');
      // 到期日：如你有真正的付費到期欄位，改成該欄位；這裡示意一律顯示 2025-11-15
      const expire = '2025-11-15';
      const isOn = onlineJudge(r.last_seen || r.last_sign_in_at);
      const dot = `<span class="dot ${isOn?'dot-on':'dot-off'}"></span>${isOn?'在線':'離線'}`;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><a class="link" href="mailto:${email}">${email}</a></td>
        <td>${name||'—'}</td>
        <td>${r.is_admin ? '✓' : ''}</td>
        <td>${last||'—'}</td>
        <td>${expire}　${dot}</td>`;
      tb.appendChild(tr);
    });
  }

  function updateOnlineBadgeFromRows(rows){
    let n = 0;
    const win = ONLINE_WINDOW_MIN*60*1000;
    rows.forEach(r=>{
      const t = new Date(r.last_seen || r.last_sign_in_at).getTime();
      if(t && (Date.now()-t)<=win) n++;
    });
    setOnlineBadge(n);
  }

  // ====== 6) 事件綁定 =======================================================
  $('#btn-refresh').addEventListener('click', loadAdminList);
  $('#q').addEventListener('input', ()=>{ clearTimeout(window.__qTimer); window.__qTimer=setTimeout(loadAdminList,200) });

  // ====== 7) 啟動流程 ========================================================
  (async ()=>{
    await getCurrentProfile();
    if(currentProfile){ startHeartbeat() }  // 登入才送心跳
    await loadAdminList();
  })();
  </script>
</body>
</html>


















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































