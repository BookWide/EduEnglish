<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BookWide</title>
  <link rel="icon" href="./img/favicon.png" />
  <style>
    :root{
      --bg:#0b1220;
      --fg:#e6ecff;
      --muted:#a9b3c9;
      --primary:#2f6bff;
      --card:#0f172a;
      --btn:#1f2937;
      --split:#1b2335;
      --hover:#192037;
      --ok:#16a34a;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",Arial,sans-serif}
    a{color:var(--fg);text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .bar{display:flex;align-items:center;gap:14px;padding:10px 0}
    .brand{font-size:28px;font-weight:800;letter-spacing:.5px}
    .spacer{flex:1}
    .btn{background:var(--btn);border:1px solid var(--split);padding:8px 14px;border-radius:10px}
    .btn:hover{background:var(--hover)}
    .acct{position:relative}
    .acct-badge{background:#1f2a44;border:1px solid var(--split);border-radius:12px;padding:8px 12px;display:flex;align-items:center;gap:10px;cursor:pointer}
    .acct-mail{color:var(--muted);font-size:13px}
    .acct-menu{position:absolute;right:0;top:calc(100% + 8px);width:260px;background:var(--card);border:1px solid var(--split);
      border-radius:14px;padding:10px;display:none;box-shadow:0 20px 50px rgba(0,0,0,.35)}
    .acct-hd{display:flex;align-items:center;gap:12px;padding:8px 10px}
    .avatar{width:38px;height:38px;border-radius:50%;object-fit:cover;border:1px solid var(--split);background:#203}
    .acct-name{font-weight:700}
    .acct-mail2{font-size:13px;color:var(--muted)}
    .acct-split{height:1px;background:var(--split);margin:8px 6px}
    .acct-item{display:block;padding:10px 12px;border-radius:10px}
    .acct-item:hover{background:var(--hover)}
    .ok{background:var(--ok);border-color:#12843b}
    /* hero */
    .hero{margin-top:8px;padding:26px 18px;background:linear-gradient(180deg,#0a1328 0%, #0b1220 60%);border-radius:18px;border:1px solid var(--split)}
    .title{font-size:40px;font-weight:900;letter-spacing:2px;margin:0 0 10px}
    .desc{color:var(--muted);margin-bottom:14px}
    .cta{display:flex;gap:10px}
    .link{padding:10px 14px;background:var(--primary);border-radius:10px}
    .link:hover{filter:brightness(1.05)}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- NAV -->
    <div class="bar">
      <div class="brand">BookWide <span style="font-size:12px;color:#9fb1ff;background:#2038ff22;padding:2px 8px;border-radius:20px;border:1px solid #2038ff45">Beta</span></div>
      <div class="spacer"></div>

      <!-- （原本外層的「方案價格」按鈕已移除） -->

      <!-- 登入按鈕（未登入時顯示） -->
      <a id="btnLogin" class="btn" href="./login.html">登入</a>

      <!-- 帳號下拉（登入時顯示） -->
      <div id="acctWrap" class="acct" style="display:none">
        <div id="acctBtn" class="acct-badge" aria-haspopup="menu" aria-expanded="false">
          <img id="acctAvatar" class="avatar" src="./img/avatar-default.svg" alt="avatar">
          <div>
            <div id="acctName" style="font-weight:700">—</div>
            <div id="acctMail" class="acct-mail">—</div>
          </div>
        </div>

        <div id="acctDropdown" class="acct-menu" role="menu" aria-label="account menu">

          <!-- ✅ 新增：方案價格（登入後才顯示） -->
          <a class="acct-item acct-plan" href="./pricing.html" role="menuitem" style="display:none">方案價格</a>

          <div class="acct-hd">
            <img id="avatarBig" class="avatar" src="./img/avatar-default.svg" alt="avatar big">
            <div>
              <div id="nameBig" class="acct-name">—</div>
              <div id="mailBig" class="acct-mail2">—</div>
            </div>
          </div>

          <div class="acct-split"></div>

          <a class="acct-item" href="./account/profile.html" role="menuitem">個人資料</a>
          <a class="acct-item" href="./account/learning-dashboard.html" role="menuitem">學習控制台</a>
          <a class="acct-item" href="./account/orders.html" role="menuitem">我的訂閱</a>
          <a class="acct-item" href="./account/referral.html" role="menuitem">推廣分潤</a>

          <div class="acct-split"></div>
          <a id="btnLogout" class="acct-item" role="menuitem">登出</a>
        </div>
      </div>
    </div>

    <!-- HERO -->
    <section class="hero">
      <h1 class="title">看影片・做測驗・背單字 —— 一頁完成</h1>
      <p class="desc">BookWide 用 故事・音樂・電影・新聞・專業主題 帶你學英文，逐句播放、雙語字幕、單字卡與分區測驗，完整練到聽讀寫。</p>
      <div class="cta">
        <a class="link" href="./videos/index.html">瀏覽教材</a>
        <!-- 方案價格已放到帳號下拉 -->
      </div>
    </section>

  </div>

  <script type="module">
    import { supabase } from './supa.js';

    // ====== 快速選取 ======
    const $ = (s, el=document) => el.querySelector(s);
    const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));

    // ====== 顯示元素 ======
    const btnLogin   = $('#btnLogin');
    const acctWrap   = $('#acctWrap');
    const acctBtn    = $('#acctBtn');
    const dropdown   = $('#acctDropdown');

    const acctAvatar = $('#acctAvatar');
    const acctName   = $('#acctName');
    const acctMail   = $('#acctMail');

    const avatarBig  = $('#avatarBig');
    const nameBig    = $('#nameBig');
    const mailBig    = $('#mailBig');

    const btnLogout  = $('#btnLogout');

    // 下拉顯示/隱藏
    let open = false;
    const toggleMenu = (show) => {
      open = (show ?? !open);
      dropdown.style.display = open ? 'block' : 'none';
      acctBtn.setAttribute('aria-expanded', String(open));
    };
    acctBtn.addEventListener('click', (e)=>{
      e.stopPropagation();
      toggleMenu();
    });
    document.addEventListener('click', ()=> toggleMenu(false));

    // 未登入導去登入（可帶 next 回來）
    function gotoLogin(){
      const next = encodeURIComponent(location.pathname + location.search);
      location.href = `./login.html?next=${next}`;
    }

    // 登出
    btnLogout.addEventListener('click', async ()=>{
      try{
        await supabase.auth.signOut();
      }finally{
        location.reload();
      }
    });

    // 根據使用者狀態繪製 UI
    function paintUser(u){
      if(u){
        // 顯示帳號區、隱藏登入
        btnLogin.style.display = 'none';
        acctWrap.style.display = 'block';

        const email = u.email ?? '';
        const name = (u.user_metadata?.full_name || u.user_metadata?.name || email.split('@')[0] || '會員');
        const avatar = (u.user_metadata?.avatar_url || u.user_metadata?.picture || './img/avatar-default.svg');

        acctName.textContent = name;
        acctMail.textContent = email;
        acctAvatar.src = avatar;

        nameBig.textContent = name;
        mailBig.textContent = email;
        avatarBig.src = avatar;

        // ✅ 顯示「方案價格」
        document.querySelector('.acct-item.acct-plan')?.style.setProperty('display','block');

      }else{
        // 顯示登入、隱藏帳號區
        btnLogin.style.display = '';
        acctWrap.style.display = 'none';

        // 隱藏「方案價格」
        document.querySelector('.acct-item.acct-plan')?.style.setProperty('display','none');
      }
    }

    // 初始化：抓目前 session
    const { data: { session } } = await supabase.auth.getSession();
    paintUser(session?.user || null);

    // 監聽登入/登出
    supabase.auth.onAuthStateChange((_event, session)=>{
      paintUser(session?.user || null);
    });

    // 未登入時點選登入 → 帶 next 參數
    btnLogin.addEventListener('click', (e)=>{
      // 直接讓 <a> 走 href（這裡只為了保證會帶 next）
      e.preventDefault();
      gotoLogin();
    });
  </script>
</body>
</html>











