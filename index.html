<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide — 看影片・做測驗・背單字</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#0f172a;--card:#111827;--ink:#e5e7eb;--muted:#9ca3af;
      --ok:#10b981;--warn:#f59e0b;--brand:#60a5fa;--line:#1f2937;
      --shadow:0 10px 30px rgba(0,0,0,.25);
      --radius:16px;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;}
    a{color:inherit;text-decoration:none}
    .container{max-width:1200px;margin:auto;padding:20px}
    header.nav{position:sticky;top:0;z-index:10;background:rgba(15,23,42,.75);backdrop-filter:saturate(150%) blur(8px);border-bottom:1px solid #111;border-bottom-color:var(--line)}
    .bar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 20px}
    .logo{display:flex;align-items:center;gap:10px;font-weight:700;letter-spacing:.4px}
    .beta{font-size:12px;background:var(--line);padding:2px 8px;border-radius:999px;color:var(--muted)}
    .menu{display:flex;align-items:center;gap:10px}
    .btn{display:inline-flex;align-items:center;gap:8px;background:var(--card);border:1px solid var(--line);padding:10px 14px;border-radius:10px}
    .btn:hover{border-color:#283244}
    .btn.primary{background:#1f2937}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:var(--card);color:var(--muted)}
    .hero{background:linear-gradient(180deg,rgba(16,24,40,.25),transparent 40%);border-radius:var(--radius);box-shadow:var(--shadow);padding:28px;margin-top:18px}
    .hero h1{margin:0 0 12px;font-size:34px}
    .hero p{margin:0 0 18px;color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#1e293b;border:1px solid #243041;border-radius:999px;padding:12px 16px}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:16px;margin-top:22px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
    .card h3{margin:6px 0 6px}
    .search{display:flex;gap:12px;align-items:center;margin:18px 0}
    .search input{flex:1 1 auto;background:#0b1220;border:1px solid #1c2432;border-radius:10px;padding:10px 12px;color:var(--ink)}
    .search .btn{padding:10px 14px}
    footer{color:var(--muted);padding:40px 0}
    /* Account dropdown */
    .account{position:relative}
    .dd{position:absolute;right:0;top:calc(100% + 8px);min-width:260px;background:#0b1220;border:1px solid #1b2331;border-radius:14px;box-shadow:var(--shadow);padding:10px;display:none}
    .dd.open{display:block}
    .dd .header{display:flex;align-items:center;gap:10px;padding:10px 12px 12px;border-bottom:1px solid #172031;margin-bottom:8px}
    .dd a{display:block;padding:12px;border-radius:8px;color:var(--ink)}
    .dd a:hover{background:#111a2a}
    .tag{font-size:12px;color:var(--muted)}
    /* modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5)}
    .modal.open{display:flex}
    .modal .panel{width:min(92vw,420px);background:#0b1220;border:1px solid #1b2331;border-radius:16px;box-shadow:var(--shadow);padding:18px}
    .row{display:flex;flex-direction:column;gap:6px;margin:10px 0}
    .row input{background:#0b1220;border:1px solid #1b2331;border-radius:10px;padding:12px;color:var(--ink)}
    .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
    .hide{display:none !important}
  </style>
</head>
<body>

  <!-- 頂部導覽 -->
  <header class="nav">
    <div class="bar container">
      <div class="logo">
        <span style="display:inline-block;width:36px;height:36px;border-radius:10px;background:#1e293b;border:1px solid #2a3850"></span>
        <div>
          <div>BookWide <span class="beta">Beta</span></div>
        </div>
      </div>

      <div class="menu">
        <div class="account" id="account">
          <button class="btn" id="btnAccount">
            <span id="accLabel">登入</span>
          </button>
          <!-- 下拉選單 -->
          <div class="dd" id="ddMenu" aria-hidden="true">
            <div class="header">
              <div style="width:36px;height:36px;border-radius:999px;background:#1e293b;border:1px solid #283244"></div>
              <div style="min-width:0">
                <div id="ddName" style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">—</div>
                <div id="ddEmail" class="tag" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">—</div>
              </div>
            </div>

            <a href="pricing.html">方案價格</a>
            <a href="profile.html">個人資料</a>
            <a href="billing.html">我的訂閱</a>
            <a href="dashboard.html">學習控制台</a>
            <a href="referral.html">推廣分潤</a>

            <!-- 只有管理員才會顯示 -->
            <a href="admin.html" id="menu-admin" class="hide" target="_blank" rel="noopener">Admin 主控台</a>

            <a href="#" id="btnSignout" class="hide">登出</a>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- 主內容 -->
  <main class="container">
    <section class="hero">
      <div class="pill">看影片・做測驗・背單字 —— 一頁完成</div>
      <h1>BookWide 用 故事・音樂・電影・新聞・專業主題 帶你學英文。</h1>
      <p>逐句播放、雙語字幕、單字卡與分區測驗，完整練到聽讀寫。</p>
      <div style="display:flex;gap:10px;margin-top:10px">
        <a class="btn primary" href="player.html?cat=story&id=mid-autumn">試看：故事〈Mid-Autumn〉</a>
        <a class="btn" href="materials.html">瀏覽教材</a>
      </div>
    </section>

    <div class="grid">
      <div class="card"><div class="chip">逐句播放</div><h3>跟著文本走，不迷路</h3></div>
      <div class="card"><div class="chip">雙語字幕</div><h3>英文在上，中文在下</h3></div>
      <div class="card"><div class="chip">分區測驗</div><h3>Vocabulary / Grammar / Reading</h3></div>
      <div class="card"><div class="chip">單字卡</div><h3>填空、朗讀、快跳段</h3></div>
    </div>

    <div class="search">
      <input id="q" placeholder="搜尋標題、關鍵字…" />
      <button class="btn">搜尋</button>
    </div>
  </main>

  <footer class="container">© 2025 BookWide</footer>

  <!-- 登入 Modal -->
  <div class="modal" id="loginModal" aria-hidden="true">
    <div class="panel">
      <h3 style="margin:6px 0 4px">登入</h3>
      <div class="row">
        <label>Email</label>
        <input id="loginEmail" type="email" placeholder="you@example.com" />
      </div>
      <div class="row">
        <label>密碼</label>
        <input id="loginPass" type="password" placeholder="••••••••" />
      </div>
      <div class="actions">
        <button class="btn" id="cancelLogin">取消</button>
        <button class="btn primary" id="doLogin">送出</button>
      </div>
      <div id="loginMsg" class="tag" style="margin-top:8px"></div>
    </div>
  </div>

  <!-- Supabase 共用設定 -->
  <script type="module" src="supa.js"></script>

  <!-- 頁面控制邏輯 -->
  <script type="module">
    import { supabase } from './supa.js';

    const btnAccount = document.getElementById('btnAccount');
    const ddMenu     = document.getElementById('ddMenu');
    const accLabel   = document.getElementById('accLabel');
    const ddName     = document.getElementById('ddName');
    const ddEmail    = document.getElementById('ddEmail');
    const btnSignout = document.getElementById('btnSignout');
    const menuAdmin  = document.getElementById('menu-admin');

    const loginModal = document.getElementById('loginModal');
    const loginEmail = document.getElementById('loginEmail');
    const loginPass  = document.getElementById('loginPass');
    const doLogin    = document.getElementById('doLogin');
    const cancelLogin= document.getElementById('cancelLogin');
    const loginMsg   = document.getElementById('loginMsg');

    // 打開 / 關閉帳號下拉
    btnAccount.addEventListener('click', async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        openLogin();
        return;
      }
      ddMenu.classList.toggle('open');
      ddMenu.setAttribute('aria-hidden', ddMenu.classList.contains('open') ? 'false' : 'true');
    });

    // 點外面關閉
    document.addEventListener('click', (e)=>{
      if (!ddMenu.contains(e.target) && !btnAccount.contains(e.target)) {
        ddMenu.classList.remove('open');
        ddMenu.setAttribute('aria-hidden','true');
      }
    });

    // 登入 Modal 控制
    function openLogin(){ loginModal.classList.add('open'); loginModal.setAttribute('aria-hidden','false'); }
    function closeLogin(){ loginModal.classList.remove('open'); loginModal.setAttribute('aria-hidden','true'); loginMsg.textContent=''; }
    cancelLogin.addEventListener('click',closeLogin);

    doLogin.addEventListener('click', async ()=>{
      loginMsg.textContent = '登入中…';
      const email = loginEmail.value.trim();
      const pass  = loginPass.value;
      const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
      if (error){ loginMsg.textContent = '登入失敗：' + error.message; return; }
      loginMsg.textContent = 'OK，正在載入…';
      closeLogin();
      await refreshUI();
    });

    btnSignout.addEventListener('click', async (e)=>{
      e.preventDefault();
      await supabase.auth.signOut();
      await refreshUI();
      ddMenu.classList.remove('open');
    });

    // 判斷是否管理員（任一條件成立即視為 admin）
    async function isAdmin(user){
      if (!user) return false;

      // 1) user_metadata
      const meta = user.user_metadata || {};
      if (meta.is_admin === true) return true;

      // 2) profiles.is_admin
      try{
        const { data: p } = await supabase
          .from('profiles')
          .select('is_admin')
          .eq('id', user.id)
          .maybeSingle();
        if (p && p.is_admin === true) return true;
      }catch(e){ /* ignore */ }

      // 3) admins 表（以 email 為 key）
      try{
        const { data: rows } = await supabase
          .from('admins')
          .select('email, disabled')
          .eq('email', user.email)
          .limit(1);
        if (rows && rows.length && rows[0].disabled !== true) return true;
      }catch(e){ /* ignore */ }

      return false;
    }

    // 更新帳號 UI
    async function refreshUI(){
      const { data: { session } } = await supabase.auth.getSession();

      if (!session){
        accLabel.textContent = '登入';
        ddName.textContent   = '—';
        ddEmail.textContent  = '—';
        btnSignout.classList.add('hide');
        menuAdmin.classList.add('hide');
        return;
      }

      const user = session.user;
      accLabel.textContent = user.email || '我的帳號';
      ddName.textContent   = user.user_metadata?.full_name || (user.email?.split('@')[0] ?? 'Account');
      ddEmail.textContent  = user.email ?? '';

      btnSignout.classList.remove('hide');

      // 權限：是否顯示 Admin 主控台
      const ok = await isAdmin(user);
      if (ok) menuAdmin.classList.remove('hide');
      else    menuAdmin.classList.add('hide');
    }

    // 首次載入
    await refreshUI();

    // 監聽 Session 變化
    supabase.auth.onAuthStateChange((_evt, _session)=>{ refreshUI(); });

  </script>
</body>
</html>









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































