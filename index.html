<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BookWide｜英語教材清單（統合版）</title>
<style>
  :root { --bg:#0b1220; --card:#101a2f; --muted:#9fb0c9; --chip:#1a2947; --accent:#4da3ff; }
  *{box-sizing:border-box} html,body{margin:0;padding:0;background:var(--bg);color:#fff;font-family:system-ui,-apple-system,"Noto Sans TC",Segoe UI,Roboto}
  a{color:inherit;text-decoration:none}
  header{display:flex;align-items:center;gap:12px;padding:18px 20px}
  header h1{margin:0;font-size:20px;font-weight:700;letter-spacing:.5px}
  .searchbar{flex:1;max-width:720px}
  .searchbar input{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #304061;background:#0f1729;color:#fff}
  .tabs{display:flex;gap:10px;padding:0 20px 10px}
  .tab{padding:8px 12px;border-radius:999px;background:var(--chip);cursor:pointer;color:#cfe3ff;border:1px solid #2a3b5f;font-size:13px}
  .tab.active{background:#2b64b1;color:#fff;border-color:#3876c7}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;padding:10px 20px 80px}
  .card{background:var(--card);border:1px solid #203154;border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
  .thumb{position:relative;aspect-ratio:16/9;background:#0a1222}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .badge{position:absolute;left:10px;bottom:10px;padding:4px 8px;border-radius:999px;background:rgba(0,0,0,.55);font-size:12px;border:1px solid #2a3b5f}
  .meta{padding:12px 12px 14px}
  .title{font-size:15px;font-weight:700;line-height:1.35;margin:0 0 6px}
  .sub{font-size:12px;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap}
  .hide{display:none!important}
  .topnote{margin:6px 20px 2px;color:#cfe3ff99;font-size:13px}
  /* 簡易回到首頁／登入區留白位，不綁你現有登入模組，直接保留鉤子 */
  .account{margin-left:auto;display:flex;gap:8px}
  .btn{padding:8px 10px;border:1px solid #2a3b5f;background:var(--chip);border-radius:10px;font-size:13px}
  .btn:hover{filter:brightness(1.1);cursor:pointer}
</style>
</head>
<body>
<header>
  <h1>BookWide</h1>
  <div class="searchbar"><input id="q" placeholder="搜尋 標題、主題、關鍵字…" /></div>
  <div class="account">
    <button class="btn" id="btn-admin" title="後台管理（僅管理員顯示）">管理入口</button>
    <button class="btn" id="btn-login">登入</button>
  </div>
</header>

<div class="topnote">看影片、做測驗、背單字 —— 一頁完成</div>
<div class="tabs" id="tabs"></div>
<div class="grid" id="grid"></div>

<script>
/* -----------------------------
   基本設定（五大類 / 路徑 / JSON）
-------------------------------- */
const CATS = [
  { key:'story',  name:'故事',  color:'故事' },
  { key:'music',  name:'音樂',  color:'音樂' },
  { key:'movie',  name:'電影',  color:'電影' },
  { key:'news',   name:'新聞',  color:'新聞' },
  { key:'pro',    name:'專業行業', color:'專業' },
];

function getBase() {
  // 取目前目錄為 BASE，例如 …/EduEnglish/
  const p = location.pathname;
  // 去掉檔名
  const base = p.replace(/[^\/]*$/, '');
  return base.endsWith('/') ? base : base + '/';
}
const BASE = getBase(); // e.g. /EduEnglish/
const DATA_BASE = BASE + 'data/'; // e.g. /EduEnglish/data/

/* -----------------------------
   資料載入（統一欄位）
   每類皆讀：data/{cat}/{cat}-index.json
   欄位：slug, title, mp4, youtubeId, artist, level, topic, cover
-------------------------------- */
async function loadCategory(cat) {
  const url = `${DATA_BASE}${cat}/${cat}-index.json`;
  const res = await fetch(url, { cache:'no-store' });
  if (!res.ok) throw new Error('fetch json fail ' + url);
  const j = await res.json();
  // 兼容 items 或 直接陣列
  return Array.isArray(j) ? j : (j.items || []);
}

/* -----------------------------
   封面決定邏輯（cover → YouTube → mp4 snapshot）
-------------------------------- */
function coverFromYoutube(id){
  return `https://img.youtube.com/vi/${id}/hqdefault.jpg`;
}

function buildThumbImg(item, cat){
  const img = new Image();
  img.alt = item.title || '';
  // 1) 明確 cover
  if (item.cover && item.cover.trim()){
    img.src = item.cover.trim();
    return img;
  }
  // 2) YouTube 縮圖
  if (item.youtubeId && item.youtubeId.trim()){
    img.src = coverFromYoutube(item.youtubeId.trim());
    return img;
  }
  // 3) mp4 snapshot（延遲產生）
  img.src = BASE + 'img/placeholder.jpg'; // 你專案已有 placeholder 的話；若沒有會顯黑底
  img.dataset.mp4 = (item.mp4 || '').trim();
  img.dataset.cat = cat;
  img.loading = 'lazy';
  return img;
}

/* -----------------------------
   卡片渲染
-------------------------------- */
function renderCards(cat, items){
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  const frag = document.createDocumentFragment();

  items.forEach(it=>{
    const card = document.createElement('article');
    card.className = 'card';
    // 封面
    const thumb = document.createElement('div');
    thumb.className = 'thumb';
    const img = buildThumbImg(it, cat);
    thumb.appendChild(img);
    // 角標
    const badge = document.createElement('div');
    badge.className = 'badge';
    badge.textContent = CATS.find(c=>c.key===cat)?.name || cat;
    thumb.appendChild(badge);
    // 文案
    const meta = document.createElement('div');
    meta.className = 'meta';
    const h3 = document.createElement('h3');
    h3.className = 'title';
    h3.textContent = it.title || it.slug || '(未命名)';
    const sub = document.createElement('div');
    sub.className = 'sub';
    if (it.artist) sub.append(`作者 `+it.artist);
    if (it.level) sub.append(`  ·  程度 `+it.level);
    if (it.topic) sub.append(`  ·  主題 `+it.topic);

    meta.append(h3, sub);
    card.append(thumb, meta);

    // 卡片點擊：開播放器
    card.addEventListener('click', ()=>{
      // 依你的 player.html 規格：?cat=xxx&slug=yyy
      const url = `${BASE}player.html?cat=${encodeURIComponent(cat)}&slug=${encodeURIComponent(it.slug||'')}`;
      location.href = url;
    });

    frag.append(card);
  });

  grid.append(frag);
  // 啟動 mp4 snapshot 延遲生成
  startSnapshotObserver();
}

/* -----------------------------
   延遲產生 mp4 首幀封面（避免首頁超載）
-------------------------------- */
let snapshotObserver = null;
function startSnapshotObserver(){
  if (snapshotObserver) snapshotObserver.disconnect();
  const opts = {root:null,threshold:0.25};
  snapshotObserver = new IntersectionObserver(async (entries, obs)=>{
    for (const e of entries){
      if (!e.isIntersecting) continue;
      const img = e.target;
      const mp4 = img.dataset.mp4;
      if (!mp4){ obs.unobserve(img); continue; }
      try{
        const url = mp4.startsWith('http') ? mp4 : (BASE + mp4.replace(/^\//,''));
        const poster = await snapshotFromMp4(url, 1); // 第 1 秒
        if (poster) img.src = poster;
      }catch(err){ /* 靜默失敗顯示 placeholder */ }
      delete img.dataset.mp4;
      obs.unobserve(img);
    }
  }, opts);

  document.querySelectorAll('img[data-mp4]').forEach(el=>snapshotObserver.observe(el));
}

// 取 mp4 某秒封面
function snapshotFromMp4(url, sec=1){
  return new Promise((resolve)=>{
    const v = document.createElement('video');
    v.crossOrigin = 'anonymous';
    v.preload = 'metadata';
    v.src = url;
    const done = (blobUrl)=>{
      try{ URL.revokeObjectURL(blobUrl); }catch{}
    };
    v.addEventListener('loadedmetadata', ()=>{
      const t = Math.min(sec, (v.duration||sec));
      v.currentTime = t;
    }, {once:true});
    v.addEventListener('seeked', ()=>{
      const c = document.createElement('canvas');
      c.width = v.videoWidth; c.height = v.videoHeight;
      const ctx = c.getContext('2d');
      ctx.drawImage(v,0,0,c.width,c.height);
      const data = c.toDataURL('image/jpeg', .8);
      resolve(data);
    }, {once:true});
    v.addEventListener('error', ()=>resolve(''), {once:true});
  });
}

/* -----------------------------
   Tab / 搜尋
-------------------------------- */
let currentCat = CATS[0].key;
let rawItemsByCat = {};

function buildTabs(){
  const wrap = document.getElementById('tabs');
  wrap.innerHTML = '';
  CATS.forEach(c=>{
    const b = document.createElement('button');
    b.className = 'tab' + (c.key===currentCat?' active':'');
    b.textContent = c.name;
    b.addEventListener('click', ()=>switchCat(c.key));
    wrap.appendChild(b);
  });
}
async function switchCat(cat){
  currentCat = cat;
  buildTabs();
  if (!rawItemsByCat[cat]){
    rawItemsByCat[cat] = await loadCategory(cat);
  }
  applyFilter();
}

function applyFilter(){
  const q = (document.getElementById('q').value||'').trim().toLowerCase();
  const list = (rawItemsByCat[currentCat]||[]).filter(it=>{
    const hay = [
      it.title, it.slug, it.artist, it.level, it.topic
    ].filter(Boolean).join(' ').toLowerCase();
    return !q || hay.includes(q);
  });
  renderCards(currentCat, list);
}
document.getElementById('q').addEventListener('input', ()=>applyFilter());

/* -----------------------------
   管理員入口（保持相容：若偵測到 is_admin 才顯示）
   - 若你頁面已注入 Supabase client，可改寫 isAdmin() 來讀 profiles.is_admin
-------------------------------- */
function isAdmin(){
  // 簡易相容：若全域變數或 localStorage 標記；或你之後用 Supabase 判斷
  if (window.BW_IS_ADMIN === true) return true;
  if (localStorage.getItem('BW_IS_ADMIN') === '1') return true;
  return false;
}
(function setupAdminBtn(){
  const btn = document.getElementById('btn-admin');
  if (!isAdmin()) btn.classList.add('hide');
  btn.addEventListener('click', ()=>location.href = BASE + 'grant-admin.html');
})();
document.getElementById('btn-login').addEventListener('click', ()=>{
  // 保留鉤子：這裡呼叫你現有的登入流程；若已整合 Supabase，可在這裡打開登入 modal
  alert('請接上你的登入流程（此統合版僅保留鉤子）');
});

/* -----------------------------
   啟動
-------------------------------- */
(async function boot(){
  buildTabs();
  await switchCat(currentCat);
})();
</script>
</body>
</html>



























