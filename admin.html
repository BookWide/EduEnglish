<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BookWide Admin 多語打包 + 上傳 v20251106</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<!-- 若頁面已有 supabase-js 可省略；沒有也沒關係，只是跳過上傳 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{--fg:#111;--bg:#fff;--line:#e5e5e5;--muted:#666;--prim:#1a73e8}
  html,body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Hiragino Sans","Microsoft JhengHei",Arial}
  .wrap{max-width:1024px;margin:24px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 8px} .sub{color:var(--muted);margin:0 0 20px}
  .card{border:1px solid var(--line);border-radius:10px;margin:16px 0;overflow:hidden;background:#fff}
  .card-hd{padding:14px 16px;border-bottom:1px solid var(--line);font-weight:600}
  .card-bd{padding:16px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  label{display:block;font-weight:600;margin:8px 0 6px}
  input[type=text],select,textarea{width:100%;box-sizing:border-box;border:1px solid var(--line);border-radius:8px;padding:10px 12px}
  textarea{min-height:120px;white-space:pre-wrap}
  .muted{color:var(--muted);font-size:12px}
  .hr{height:1px;background:var(--line);margin:16px 0}
  .btn{display:inline-flex;align-items:center;gap:8px;background:var(--prim);color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn.secondary{background:#222}
  details{border:1px dashed var(--line);border-radius:10px;padding:10px 12px;background:#fafafa}
  details[open]{background:#f5f7ff}
  details summary{cursor:pointer;font-weight:600;margin:-10px -12px 8px;padding:10px 12px}
  .drop{border:2px dashed var(--line);border-radius:12px;padding:18px;text-align:center;color:#888}
  .right{display:flex;gap:8px;justify-content:flex-end}
</style>
</head>
<body>
<div class="wrap">
  <h1>BookWide Admin 多語打包</h1>
  <p class="sub">保留 MP4 上傳區＋新增 EN/ZH/JA／Vocab；ZIP 內含 index/cues/vocab/quiz/ai（Quiz 80、AI 15）。</p>

  <!-- MP4 上傳 + 基本欄位 -->
  <div class="card">
    <div class="card-hd">MP4 上傳自動化（slug 檔名；完成即送 JSON ZIP）</div>
    <div class="card-bd">
      <div class="row">
        <div>
          <label>分類 category</label>
          <select id="bw-cat">
            <option value="story">story</option>
            <option value="music" selected>music</option>
            <option value="movie">movie</option>
            <option value="news">news</option>
            <option value="pro">pro</option>
          </select>
        </div>
        <div>
          <label>Slug（不含空白與副檔名）</label>
          <input id="bw-slug" type="text" value="alittlelove" placeholder="例如：alittlelove">
        </div>
      </div>

      <div class="row">
        <div>
          <label>顯示標題（可空）</label>
          <input id="bw-title" type="text" value="A Little Love" placeholder="顯示名稱（可空）">
        </div>
        <div>
          <label>封面檔名（預設 cover.jpg）</label>
          <input id="bw-cover" type="text" value="cover.jpg" placeholder="cover.jpg">
        </div>
      </div>

      <div class="row3">
        <div>
          <label>RMS 閾值</label>
          <input id="bw-rms" type="text" value="0.008"><div class="muted">僅寫入 index.json</div>
        </div>
        <div>
          <label>最短靜音（秒）</label>
          <input id="bw-minsil" type="text" value="0.25"><div class="muted">僅寫入 index.json</div>
        </div>
        <div>
          <label>吸附窗口 ±（秒）</label>
          <input id="bw-snap" type="text" value="1.5"><div class="muted">僅寫入 index.json</div>
        </div>
      </div>

      <div class="hr"></div>

      <!-- MP4 / Cover 檔案（可拖拉） -->
      <label>MP4 檔（可拖拉到框內，或點選檔案）</label>
      <div id="mp4Drop" class="drop">將檔案拖曳到此處，或 <input id="mp4File" type="file" accept="video/mp4" /></div>
      <div style="height:8px"></div>
      <label>封面圖（可拖拉）</label>
      <div id="coverDrop" class="drop">將封面拖曳到此處，或 <input id="coverFile" type="file" accept="image/*" /></div>

      <div class="hr"></div>

      <!-- 多語輸入 -->
      <details open>
        <summary>多語字幕與單字（EN / ZH / JA）</summary>
        <label>EN 字幕（每行一筆）</label>
        <textarea id="bw-en" placeholder="每行一筆英文台詞"></textarea>
        <label>ZH 字幕（對齊 EN 行數；可留空）</label>
        <textarea id="bw-zh" placeholder="每行一筆中文台詞（可空）"></textarea>
        <label>JA 字幕（對齊 EN 行數；可留空）</label>
        <textarea id="bw-ja" placeholder="每行一筆日文台詞（可空）"></textarea>
        <label>Vocab（每行：word | pos | zh | ja）</label>
        <textarea id="bw-vocab" placeholder="festival | n. | 節慶 | 祭り"></textarea>
      </details>

      <div class="hr"></div>

      <div class="right">
        <button class="btn secondary" id="demo">載入示例</button>
        <button class="btn" id="action">上傳（若可）並下載 JSON ZIP</button>
      </div>
      <p class="muted">下載後放到 GitHub：<code>/data/&lt;category&gt;/&lt;slug&gt;/</code>。</p>
    </div>
  </div>
</div>

<script>
const hasSupabase = !!window.supabase;
let mp4Blob=null, coverBlob=null;

document.getElementById('mp4File').addEventListener('change',e=> mp4Blob=e.target.files?.[0]||null);
document.getElementById('coverFile').addEventListener('change',e=> coverBlob=e.target.files?.[0]||null);
function wireDrop(el, onFile){
  el.addEventListener('dragover',ev=>{ev.preventDefault(); el.style.borderColor='#1a73e8'});
  el.addEventListener('dragleave',()=> el.style.borderColor='#e5e5e5');
  el.addEventListener('drop',ev=>{
    ev.preventDefault(); el.style.borderColor='#e5e5e5';
    const f=ev.dataTransfer.files?.[0]; if(f) onFile(f);
  });
}
wireDrop(document.getElementById('mp4Drop'),f=>{mp4Blob=f;});
wireDrop(document.getElementById('coverDrop'),f=>{coverBlob=f;});

function lines(id){
  return (document.getElementById(id).value||'')
    .replace(/\r/g,'')
    .split('\n').map(s=>s.trim()).filter(Boolean);
}
function padTo(arr,n){const a=arr.slice(); while(a.length<n)a.push(''); return a;}
function buildCuesFromLines(){
  const EN=lines('bw-en'), ZH=lines('bw-zh'), JA=lines('bw-ja');
  const zh=padTo(ZH,EN.length), ja=padTo(JA,EN.length);
  const CHUNK=8;
  return EN.map((en,i)=>({time:{s:i*CHUNK,e:(i+1)*CHUNK}, en, zh:zh[i]||'', ja:ja[i]||''}));
}
function parseVocab(){
  return lines('bw-vocab').map(s=>{
    const p=s.split('|').map(x=>x.trim());
    return {word:p[0]||'',pos:p[1]||'',zh:p[2]||'',ja:p[3]||''};
  }).filter(x=>x.word && x.pos);
}
function buildIndex(){
  const cat = document.getElementById('bw-cat').value;
  const slug= document.getElementById('bw-slug').value.trim();
  const title=document.getElementById('bw-title').value.trim();
  const cover=document.getElementById('bw-cover').value.trim()||'cover.jpg';
  return {
    schema:'bw-index@1.0',
    title: title || slug,
    category:cat, slug,
    video:`https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/videos/${cat}/${slug}.mp4`,
    cover:`https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/assets/${cat}/${slug}/${cover}`,
    cues:{ zh:`./cues-${slug}.json`, ja:`./cues-${slug}.json`},
    vocab:`./vocab-${slug}.json`,
    quiz:`./quiz-${slug}.json`,
    ai:`./ai-${slug}.json`,
    params:{
      rms:document.getElementById('bw-rms').value.trim(),
      min_silence:document.getElementById('bw-minsil').value.trim(),
      snap:document.getElementById('bw-snap').value.trim()
    },
    is_public:true
  };
}
function buildQuiz(vocab,need=80){
  if(!vocab.length) return [];
  const pool=[...vocab]; while(pool.length<need) pool.push(...vocab);
  const out=[];
  for(let i=0;i<need;i++){
    const v=pool[i%pool.length];
    const distract=[];
    for(let j=i+1;j<i+4;j++){ const w=pool[j%pool.length]; distract.push(w.zh||w.word); }
    const choices=[v.zh||v.word,...distract].slice(0,4).sort(()=>Math.random()-0.5);
    out.push({type:'mc',q:`What is the meaning of "${v.word}"?`,choices,answer:choices.indexOf(v.zh||v.word)});
  }
  return out;
}
function buildAI(need=15){
  const base=['Describe the festival.','What will you do this year?','Share a memory about the moon.','Tell us your favorite food for this festival.','How do people celebrate in your hometown?'];
  return {schema:'bw-ai@1.0',topics:Array.from({length:need},(_,i)=>({title:`Topic ${i+1}`,prompt:base[i%base.length],hint:'',sample:''}))};
}

async function downloadZip(){
  const cat=document.getElementById('bw-cat').value;
  const slug=document.getElementById('bw-slug').value.trim();
  if(!slug){ alert('請填 slug'); return; }

  const cuesDoc={schema:'bw-cues@1.1',cues:buildCuesFromLines()};
  const vocabDoc={schema:'bw-vocab@1.1',words:parseVocab()};
  const quiz=buildQuiz(vocabDoc.words,80);
  const ai=buildAI(15);
  const index=buildIndex();

  const zip=new JSZip();
  const dir=zip.folder(`${cat}/${slug}`);
  dir.file(`index-${slug}.json`,JSON.stringify(index,null,2));
  dir.file(`cues-${slug}.json`,JSON.stringify(cuesDoc,null,2));
  dir.file(`vocab-${slug}.json`,JSON.stringify(vocabDoc,null,2));
  dir.file(`quiz-${slug}.json`,JSON.stringify(quiz,null,2));
  dir.file(`ai-${slug}.json`,JSON.stringify(ai,null,2));

  const blob=await zip.generateAsync({type:'blob'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`data_${slug}.zip`;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),20000);
}

async function uploadIfPossible(){
  if(!hasSupabase || !window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) return; // 沒設定就跳過
  const client = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
  const cat=document.getElementById('bw-cat').value;
  const slug=document.getElementById('bw-slug').value.trim();
  if(mp4Blob){
    await client.storage.from('videos').upload(`${cat}/${slug}.mp4`, mp4Blob, {upsert:true,contentType:'video/mp4'});
  }
  if(coverBlob){
    const coverName=document.getElementById('bw-cover').value.trim()||'cover.jpg';
    await client.storage.from('assets').upload(`${cat}/${slug}/${coverName}`, coverBlob, {upsert:true,contentType:coverBlob.type||'image/jpeg'});
  }
}

document.getElementById('action').addEventListener('click', async ()=>{
  // 先嘗試上傳（若有設定 supabase），不影響後續 ZIP 下載
  try{ await uploadIfPossible(); }catch(e){ console.warn('[BW] 上傳略過/失敗：', e?.message||e); }
  await downloadZip();
});

document.getElementById('demo').addEventListener('click', ()=>{
  document.getElementById('bw-slug').value='alittlelove';
  document.getElementById('bw-title').value='A Little Love';
  document.getElementById('bw-cover').value='cover.jpg';
  document.getElementById('bw-en').value =
`One day, the suns appeared.
The world turned hot.
People stayed in the shade.
A hero raised his bow.
He shot down the suns.`;
  document.getElementById('bw-zh').value =
`有一天，太陽們出現了。
世界變得很熱。
人們躲在陰影裡。
一位英雄拉起弓。
他射下了那些太陽。`;
  document.getElementById('bw-ja').value =
`ある日、太陽たちが現れた。
世界は暑くなった。
人々は日陰に隠れた。
英雄が弓を引いた。
彼は太陽たちを射落とした。`;
  document.getElementById('bw-vocab').value =
`lantern | n. | 燈籠 | ちょうちん
festival | n. | 節慶 | 祭り
archer | n. | 弓箭手 | 弓兵
immortal | adj. | 不死的 | 不死の
moon | n. | 月亮 | 月`;
});
</script>
</body>
</html>






































































