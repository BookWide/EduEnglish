<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin · 三分頁 · v20251106-three-tabs-fixlayout-v2</title>
  <script type="module" src="./supa.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <style>
    :root{ --bg:#ffffff; --fg:#111; --muted:#6b7280; --muted-2:#9ca3af; --line:#e5e7eb;
           --brand:#2563eb; --chip:#eef2ff; --ok:#16a34a; --warn:#f59e0b; --card:#fafafa; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","PingFang TC","Noto Sans CJK TC","微軟正黑體",sans-serif}
    header{padding:18px 20px;border-bottom:1px solid var(--line);display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .title{font-size:22px;font-weight:700;margin-right:auto}
    .chip{display:inline-block;padding:.35rem .6rem;border-radius:999px;background:var(--chip);color:var(--brand);font-size:12px}
    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab-btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:.5rem 1rem;cursor:pointer}
    .tab-btn.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0 16px}
    .input, select, textarea{border:1px solid var(--line);border-radius:10px;padding:.55rem .8rem;background:#fff}
    .btn{border:1px solid var(--brand);background:var(--brand);color:#fff;border-radius:10px;padding:.55rem .9rem;cursor:pointer}
    .btn.outline{background:#fff;color:var(--brand)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
    .table th,.table td{padding:.75rem .8rem;border-bottom:1px solid var(--line);text-align:left}
    .table th{background:var(--card);font-weight:600;color:#222}
    .muted{color:var(--muted)} .hint{color:var(--muted-2);font-size:13px}
    .hr{height:1px;background:var(--line);margin:18px 0}
    .row{display:grid;gap:12px}
    .grid-2{grid-template-columns:65% 35%} .grid-3{grid-template-columns:1fr 1fr 1fr}
    @media (max-width:1200px){ .grid-2{grid-template-columns:1fr} }
    @media (max-width:820px){ .grid-3{grid-template-columns:1fr} }
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px;max-width:100%;overflow:auto}
    footer{padding:22px 20px;color:var(--muted);border-top:1px solid var(--line);text-align:center;margin-top:28px}
    .pill{display:inline-block;padding:.25rem .55rem;border-radius:999px;border:1px solid var(--line);font-size:12px}
    .pill.ok{color:#16a34a;border-color:#16a34a} .pill.warn{color:#f59e0b;border-color:#f59e0b}
    .progress{height:10px;background:#eef2ff;border-radius:99px;overflow:hidden}
    .bar{height:100%;width:0;background:#2563eb;transition:width .2s}
    code{background:#f6f8fa;border:1px solid #eaeef2;border-radius:6px;padding:2px 6px}
    textarea{min-height:130px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .grid-preview{display:grid;grid-template-columns:50% 50%;gap:12px}
    .grid-preview .block{background:#f8fafc;border:1px solid var(--line);border-radius:12px;padding:8px}
    .grid-preview h4{margin:0 0 6px;font-size:13px;color:#374151;display:flex;align-items:center;gap:6px}
    .grid-preview textarea{width:100%;min-height:160px;background:#fff}
    .full{grid-column:1 / -1}
  </style>
</head>
<body>
  <header>
    <div class="title">BookWide Admin 主控台</div>
    <span class="chip">三分頁 · 內嵌 Supabase · v20251106</span>
    <nav class="tabs">
      <button class="tab-btn active" data-tab="users">使用者清單</button>
      <button class="tab-btn" data-tab="roles">授權 / 暫停管理員</button>
      <button class="tab-btn" data-tab="mp4">MP4 上傳</button>
    </nav>
  </header>

  <main class="wrap">
    <!-- 使用者清單 -->
    <section id="panel-users">
      <div class="toolbar">
        <input id="q" class="input" style="min-width:260px" placeholder="搜尋 Email / 顯示名稱…" />
        <button id="btnRefresh" class="btn outline">重新整理</button>
        <span class="hint">顯示資料來自 <b>public.profiles</b> · 台灣時區 (Asia/Taipei) · 10 分鐘內視為「在線」。</span>
      </div>
      <table class="table" id="usersTable">
        <thead><tr>
          <th>Email</th><th>顯示名稱</th><th>最後登入（台灣）</th><th>最近在線（台灣）</th><th>管理員</th><th>狀態</th><th>到期日</th>
        </tr></thead>
        <tbody><tr><td colspan="7" class="muted">載入中…</td></tr></tbody>
      </table>
    </section>

    <!-- 權限管理 -->
    <section id="panel-roles" style="display:none">
      <div class="card">
        <div class="row grid-3">
          <div><label class="muted">Email</label><input id="roleEmail" class="input" placeholder="user@example.com"></div>
          <div>
            <label class="muted">動作</label>
            <select id="roleAction" class="input">
              <option value="grant-admin">授予管理員</option>
              <option value="revoke-admin">移除管理員</option>
              <option value="pause">暫停登入</option>
              <option value="unpause">解除暫停</option>
            </select>
          </div>
          <div style="display:flex;align-items:flex-end"><button id="btnApplyRole" class="btn">套用</button></div>
        </div>
        <div class="hr"></div>
        <div class="hint">此區直接更新 <b>public.profiles</b> 欄位：<code>is_admin</code> / <code>is_paused</code>。</div>
        <div id="roleMsg" class="muted" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- MP4 上傳 -->
    <section id="panel-mp4" style="display:none">
      <div class="row grid-2">
        <!-- 左：表單 -->
        <div class="card">
          <h3 style="margin:6px 0 14px">MP4 上傳自動化（含字幕匯入、JSON 預覽）</h3>
          <div class="row grid-3">
            <div>
              <label class="muted">分類</label>
              <select id="cat" class="input">
                <option value="story">story</option><option value="music" selected>music</option>
                <option value="movie">movie</option><option value="news">news</option>
                <option value="pro">pro</option>
              </select>
            </div>
            <div><label class="muted">Slug（不含空白與副檔名）</label><input id="slug" class="input" placeholder="applesong"></div>
            <div><label class="muted">顯示標題（可空）</label><input id="title" class="input" placeholder="A Little Love"></div>
          </div>

          <div class="row grid-3" style="margin-top:10px">
            <div><label class="muted">MP4 檔</label><input id="mp4File" type="file" accept="video/mp4" class="input"></div>
            <div><label class="muted">封面（可選，建議 JPG）</label><input id="coverFile" type="file" accept="image/*" class="input"></div>
            <div><label class="muted">字幕檔（可選，支援 .txt / .srt / .vtt / .json）</label><input id="subFile" type="file" accept=".txt,.srt,.vtt,.json" class="input"></div>
          </div>

          <div class="row grid-3" style="margin-top:10px">
            <div>
              <label class="muted">中/日 產生模式</label>
              <div style="display:flex;gap:12px;align-items:center">
                <label style="display:flex;gap:6px;align-items:center"><input id="modeSimple" type="radio" name="mtmode" checked> 簡易（只產生 en，zh/ja 留空）</label>
                <label style="display:flex;gap:6px;align-items:center"><input id="modeMT" type="radio" name="mtmode"> 機翻（透過 Edge Function）</label>
              </div>
              <div class="hint" style="margin-top:6px">
                若啟用機翻，會逐句以 <code>functions/v1/&lt;名稱&gt;</code> 呼叫 Supabase Edge Function（預設 <code>mt-translate</code>），
                請在 Supabase 設好 OPENAI_API_KEY 等環境變數。
              </div>
            </div>
            <div><label class="muted">機翻 Edge Function 名稱（可空）</label><input id="edgeFn" class="input" placeholder="mt-translate" value="mt-translate"></div>
            <div><label class="muted">吸附窗（s）</label><input id="snapWin" class="input" type="number" step="0.05" value="0.25"></div>
          </div>

          <div style="margin-top:12px"><button class="btn outline" id="btnPreview">預覽 JSON（5 件）</button></div>

          <!-- 五列預覽：50%×2 + 全寬一列 -->
          <div style="margin-top:12px">
            <div class="grid-preview">
              <div class="block">
                <h4>index-<span id="fnSlug1">slug</span>.json（影片資訊）</h4>
                <textarea id="boxIndex" class="mono" placeholder="index-<slug>.json 預覽"></textarea>
              </div>
              <div class="block">
                <h4>cues-<span id="fnSlug2">slug</span>.json（三語字幕）</h4>
                <textarea id="boxCues" class="mono" placeholder="cues-*.json"></textarea>
              </div>
              <div class="block">
                <h4>quiz-<span id="fnSlug3">slug</span>.json（80 題）</h4>
                <textarea id="boxQuiz" class="mono" placeholder="quiz-*.json（AI 15 題）"></textarea>
              </div>
              <div class="block">
                <h4>vocab-<span id="fnSlug4">slug</span>.json（20 詞）</h4>
                <textarea id="boxVocab" class="mono" placeholder="vocab-*.json"></textarea>
              </div>
              <div class="block full">
                <h4>ai-<span id="fnSlug5">slug</span>.json（AI 問答模板 15 題）</h4>
                <textarea id="boxAI" class="mono" placeholder="ai-*.json"></textarea>
              </div>
            </div>
          </div>

          <div class="hint" style="margin-top:10px">字幕：.txt 視為「每行一句」；.srt/.vtt 會解析時間。三語同檔 cues = <code>[{ time, en, ja, zh }]</code>。</div>
        </div>

        <!-- 右：上傳 -->
        <div class="card">
          <h3 style="margin:6px 0 14px">Supabase 上傳（影片＋封面）</h3>
          <div class="muted">優先使用 <code>window.BW?.supa</code>。若沒有，請手動填入以下設定建立連線。</div>
          <div class="row grid-2" style="margin-top:8px">
            <div><label class="muted">Supabase URL（可空）</label><input id="sbUrl" class="input" placeholder="https://xxxx.supabase.co"></div>
            <div><label class="muted">Supabase anon key（可空）</label><input id="sbKey" class="input" placeholder="ey..."></div>
          </div>
          <div class="row grid-3" style="margin-top:8px">
            <div><label class="muted">影片桶名</label><input id="bucketVideo" class="input" value="videos"></div>
            <div><label class="muted">封面桶名</label><input id="bucketAsset" class="input" value="assets"></div>
            <div style="display:flex;align-items:flex-end"><button class="btn" id="btnSupaUpload">上傳到 Supabase（影片＋封面）</button></div>
          </div>
          <pre id="supaStatus" class="muted" style="background:#0b10221a;padding:10px;border-radius:8px;margin-top:8px;white-space:pre-wrap"></pre>
          <div class="progress" style="margin-top:6px"><div id="supaBar2" class="bar"></div></div>
          <div id="supaPct2" class="muted" style="margin-top:4px">0%</div>

          <div class="hr"></div>
          <h3 style="margin:6px 0 14px">GitHub 上傳設定（僅本機暫存，不會保留）</h3>
          <div class="row grid-3">
            <div><label class="muted">Owner（使用者或組織）</label><input id="ghOwner" class="input" value="bookwide"></div>
            <div><label class="muted">Repo</label><input id="ghRepo" class="input" value="EduEnglish"></div>
            <div><label class="muted">Branch</label><input id="ghBranch" class="input" value="main"></div>
          </div>
          <div class="row grid-3" style="margin-top:8px">
            <div><label class="muted">Base Path（可留空，例：data/）</label><input id="ghBase" class="input" value="data/"></div>
            <div><label class="muted">Commit 訊息</label><input id="ghMsg" class="input" value="Add JSON templates"></div>
            <div><label class="muted">GitHub Token（Classic PAT：包含 repo、workflow）</label><input id="ghTok" class="input" placeholder="ghp_xxx"></div>
          </div>
          <div style="margin-top:10px;display:flex;align-items:center;gap:10px">
            <button class="btn" id="btnUploadGithub">上傳到 GitHub（5 件）</button>
            <div class="hint">路徑：<code>basePath/data/{category}/{slug}/</code>（index-<slug>.json）</div>
          </div>
          <pre id="ghStatus" class="muted" style="background:#0b10221a;padding:10px;border-radius:8px;margin-top:8px;white-space:pre-wrap"></pre>
          <div class="progress" style="margin-top:6px"><div id="ghBar2" class="bar"></div></div>
          <div id="ghPct2" class="muted" style="margin-top:4px">0%</div>
        </div>
      </div>
      <footer style="text-align:center;margin-top:14px" class="hint">BookWide Admin · MP4 分頁（字幕 + JSON 預覽 + GitHub + Supabase）</footer>
    </section>
  </main>

  <footer>BookWide Admin · 內嵌 Supabase 版 · v20251106-three-tabs-fixlayout-v2</footer>

  <!-- tabs + profiles + roles -->
  <script type="module">
    const ready = () => new Promise(r=>{ if (window.BW && window.BW.supa) return r(); const t=setInterval(()=>{ if(window.BW && window.BW.supa){clearInterval(t); r();}},50)});
    await ready();
    await BW.requireAdmin();
    BW.startHeartbeat(2);

    const supa = BW.supa;
    const $ = (q,root=document)=>root.querySelector(q);
    const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));
    const fmtTW = ts => !ts?'':new Date(ts).toLocaleString('zh-TW',{timeZone:'Asia/Taipei',hour12:false});
    const pill = (ok,t,cls)=>{ t=(t!==undefined)?t:(ok?'在線':'離線'); cls=cls||(ok?'pill ok':'pill'); return '<span class="'+cls+'">'+t+'</span>'; };

    $$('.tab-btn').forEach(b=>{
      b.addEventListener('click',()=>{
        $$('.tab-btn').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        const t=b.getAttribute('data-tab');
        $('#panel-users').style.display = (t==='users')?'':'none';
        $('#panel-roles').style.display = (t==='roles')?'':'none';
        $('#panel-mp4').style.display   = (t==='mp4')  ?'':'none';
      });
    });

    async function loadProfiles(){
      const tbody = $('#usersTable tbody'); tbody.innerHTML='<tr><td class="muted" colspan="7">載入中…</td></tr>';
      const cols='email, display_name, is_admin, is_paused, last_sign_in_at, last_seen_at, expires_at';
      const r=await supa.from('profiles').select(cols).order('email',{ascending:true});
      if(r.error){ tbody.innerHTML='<tr><td class="muted" colspan="7">讀取失敗：'+r.error.message+'</td></tr>'; return; }
      const q = ($('#q').value||'').trim().toLowerCase();
      const rows=(r.data||[]).filter(x=> !q || ( (x.email||'').toLowerCase().includes(q) || (x.display_name||'').toLowerCase().includes(q) ));
      if(!rows.length){ tbody.innerHTML='<tr><td class="muted" colspan="7">沒有符合的資料</td></tr>'; return; }
      tbody.innerHTML=rows.map(x=>{
        const online = BW.isOnlineWithin(x.last_seen_at, 10);
        const status = x.is_paused ? '<span class="pill warn">暫停</span>' : '<span class="pill ok">正常</span>';
        return '<tr>'
          + '<td>'+(x.email||'')+'</td>'
          + '<td>'+(x.display_name||'')+'</td>'
          + '<td>'+(fmtTW(x.last_sign_in_at)||'')+'</td>'
          + '<td>'+(fmtTW(x.last_seen_at)||'')+' &nbsp; '+pill(online)+'</td>'
          + '<td>'+(x.is_admin?'<span class="pill ok">是</span>':'<span class="pill">否</span>')+'</td>'
          + '<td>'+status+'</td>'
          + '<td>'+(x.expires_at||'')+'</td>'
          + '</tr>';
      }).join('');
    }
    $('#btnRefresh').addEventListener('click',loadProfiles);
    $('#q').addEventListener('input',loadProfiles);
    loadProfiles();

    $('#btnApplyRole').addEventListener('click',async ()=>{
      const email=$('#roleEmail').value.trim(); const act=$('#roleAction').value; const msg=$('#roleMsg');
      if(!email){ msg.textContent='請輸入 Email'; return; }
      const q=await supa.from('profiles').select('id,is_admin').eq('email',email).maybeSingle();
      if(q.error){ msg.textContent='查詢失敗：'+q.error.message; return; } if(!q.data){ msg.textContent='找不到該使用者'; return; }
      let payload={},info='';
      if(act==='grant-admin'){payload={is_admin:true};info='已授予管理員';}
      if(act==='revoke-admin'){payload={is_admin:false};info='已移除管理員';}
      if(act==='pause'){payload={is_paused:true};info='已暫停登入';}
      if(act==='unpause'){payload={is_paused:false};info='已解除暫停';}
      const u=await supa.from('profiles').update(payload).eq('id',q.data.id);
      if(u.error){ msg.textContent='更新失敗：'+u.error.message; return; }
      msg.textContent=email+' '+info; loadProfiles();
    });
  </script>

  <!-- MP4 page logic -->
  <script>
  (function(){
    const qs = (s,root)=> (root||document).querySelector(s);
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
    const b64 = (s)=>btoa(unescape(encodeURIComponent(s)));
    const pad = n=>String(n).padStart(2,'0');
    const sec2mmss = t=>{ t=Math.max(0, Math.round(t)); return pad(Math.floor(t/60))+':'+pad(t%60); };

    function setProgress(barEl, pctEl, p){ p=Math.max(0,Math.min(100,Math.round(p))); if(barEl) barEl.style.width=p+'%'; if(pctEl) pctEl.textContent=p+'%'; }
    const supaBar=qs('#supaBar2'), supaPct=qs('#supaPct2');
    const ghBar  =qs('#ghBar2'),   ghPct  =qs('#ghPct2');

    async function parseSubtitleFile(file){
      if(!file) return [];
      const name=file.name.toLowerCase();
      const text=await file.text();
      if(name.endsWith('.json')){
        try{ const arr=JSON.parse(text); if(Array.isArray(arr)&&arr.length&&('time' in arr[0])){ return arr.map(x=>({time:x.time,en:x.en||'',ja:x.ja||'',zh:x.zh||''})); } }catch(e){}
      }
      if(name.endsWith('.srt')||name.endsWith('.vtt')){
        const lines=text.replace(/\r/g,'').split('\n');
        const out=[]; let cur=null;
        const timeRe=/(\d\d:\d\d:\d\d)[,\.](\d\d\d)\s*-->\s*(\d\d:\d\d:\d\d)[,\.](\d\d\d)/;
        for(const ln of lines){
          const m=timeRe.exec(ln);
          if(m){ const t=m[1]; cur={time:t.slice(0,5), en:''}; continue; }
          if(!ln.trim()){ if(cur){ out.push({...cur,ja:'',zh:''}); cur=null; } }
          else if(cur){ cur.en = (cur.en?cur.en+' ':'') + ln.trim(); }
        }
        if(cur) out.push({...cur,ja:'',zh:''});
        return out;
      }
      const arr = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      return arr.map((line,i)=>({ time: sec2mmss(i*4), en: line, ja:'', zh:'' }));
    }

    function buildJSON({cat,slug,title,cues}){
      const index = {
        slug, title,
        video: `videos/${cat}/${slug}.mp4`,
        cover: `assets/${cat}/${slug}/cover.jpg`,
        category: cat,
        updatedAt: new Date().toISOString()
      };
      const quiz = { title:"Lesson", topics: Array.from({length:15},(_,i)=>({title:`Topic ${i+1}`,prompt:"",hint:"",sample:""})) };
      const vocab = { words: [] };
      const ai    = { tasks: [] };
      return { index, cues, quiz, vocab, ai };
    }

    async function mtTranslateArray(fnName, arr, to){
      if(!fnName) return arr.map(()=>'');
      try{
        const url = `${location.origin}/functions/v1/${fnName}`;
        const out=[];
        for(const s of arr){
          const r= await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({text:s, from:'en', to})});
          if(!r.ok){ out.push(''); continue; }
          const j= await r.json().catch(()=>null);
          out.push(j?.text || '');
          await sleep(120);
        }
        return out;
      }catch(e){ return arr.map(()=> '') }
    }

    function setSlugLabels(slug){
      ['fnSlug1','fnSlug2','fnSlug3','fnSlug4','fnSlug5'].forEach(id=>{
        const el = qs('#'+id); if(el) el.textContent = slug || 'slug';
      });
    }

    qs('#btnPreview')?.addEventListener('click', async ()=>{
      const cat=qs('#cat').value.trim();
      const slug=qs('#slug').value.trim();
      const title=qs('#title').value.trim();
      setSlugLabels(slug);
      const sub=qs('#subFile').files[0];

      const cuesEN = await parseSubtitleFile(sub);
      let cues = cuesEN.map(x=>({...x}));

      if(qs('#modeMT').checked && cues.length){
        const fn=qs('#edgeFn').value.trim();
        const enArr = cues.map(x=>x.en);
        const zhArr = await mtTranslateArray(fn, enArr, 'zh');
        const jaArr = await mtTranslateArray(fn, enArr, 'ja');
        cues = cues.map((x,i)=>({...x, zh: zhArr[i]||'', ja: jaArr[i]||'' }));
      }

      const {index,cues:outCues,quiz,vocab,ai} = buildJSON({cat,slug,title,cues});
      qs('#boxIndex').value = JSON.stringify(index, null, 2);
      qs('#boxCues').value  = JSON.stringify(outCues, null, 2);
      qs('#boxQuiz').value  = JSON.stringify(quiz, null, 2);
      qs('#boxVocab').value = JSON.stringify(vocab, null, 2);
      qs('#boxAI').value    = JSON.stringify(ai, null, 2);
    });

    function getSupaClient(){
      if(window.BW && window.BW.supa && window.BW.supa.createClient) return window.BW.supa.createClient();
      const url=qs('#sbUrl').value.trim(); const key=qs('#sbKey').value.trim();
      if(!url || !key) return null;
      return supabase.createClient(url,key);
    }
    async function supaUpload(bucket, path, file, client){
      const { data, error } = await client.storage.from(bucket).upload(path, file, { upsert:true, contentType:file.type||undefined });
      if(error) throw error;
      const { data:pub } = client.storage.from(bucket).getPublicUrl(path);
      return pub.publicUrl;
    }

    qs('#btnSupaUpload')?.addEventListener('click', async ()=>{
      const st=qs('#supaStatus'); st.textContent='';
      const cat=qs('#cat').value.trim();
      const slug=qs('#slug').value.trim();
      const mp4=qs('#mp4File').files[0];
      const cover=qs('#coverFile').files[0];
      if(!mp4){ st.textContent='[錯誤] 請先選擇 MP4 檔。'; return; }

      const client=getSupaClient();
      if(!client){ st.textContent='[錯誤] 找不到 Supabase 連線（BW.supa 或手動 URL/KEY）。'; return; }

      const bucketV=qs('#bucketVideo').value.trim()||'videos';
      const bucketA=qs('#bucketAsset').value.trim()||'assets';
      const pathV = `${cat}/${slug}.mp4`;
      const pathC = `${cat}/${slug}/cover.jpg`;

      try{
        setProgress(supaBar,supaPct,10);
        st.textContent+='[1/2] 上傳影片中...\n';
        const vUrl = await supaUpload(bucketV, pathV, mp4, client);
        st.textContent+=`    影片 URL → ${vUrl}\n`;
        setProgress(supaBar,supaPct,70);

        let cUrl='';
        if(cover){
          st.textContent+='[2/2] 上傳封面中...\n';
          cUrl = await supaUpload(bucketA, pathC, cover, client);
          st.textContent+=`    封面 URL → ${cUrl}\n`;
        }else{
          st.textContent+='[2/2] 未選封面，略過。\n';
        }
        setProgress(supaBar,supaPct,100);

        if(qs('#boxIndex').value){
          try{
            const idx=JSON.parse(qs('#boxIndex').value);
            if(vUrl) idx.video = vUrl;
            if(cUrl) idx.cover = cUrl;
            qs('#boxIndex').value = JSON.stringify(idx,null,2);
          }catch(e){}
        }
        st.textContent+='完成。';
      }catch(e){
        st.textContent+=`[失敗] ${e.message||e}`;
        setProgress(supaBar,supaPct,0);
      }
    });

    async function ghPutFile({owner,repo,branch,token,path,content,message}){
      const url=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
      const body={ message, branch, content: b64(content) };
      const r = await fetch(url, {method:'PUT', headers:{'Authorization':`token ${token}`,'Content-Type':'application/json'}, body:JSON.stringify(body)});
      if(!r.ok){ const t=await r.text(); throw new Error(`HTTP ${r.status} – ${t}`); }
      return await r.json();
    }
    async function ghPutFileWithProgress(doPut, files, onStep){
      let i=0;
      for(const f of files){
        i++; await doPut(f);
        onStep && onStep(Math.min(100, Math.round(i / files.length * 100)));
      }
    }

    function parseBox(id){ try{ return JSON.parse(qs(id).value||''); }catch(e){ return null; } }
    function err(st,msg){ st.textContent += '[錯誤] '+msg+'\n'; }
    function validatePreview(st){
      const index = parseBox('#boxIndex');
      const cues  = parseBox('#boxCues');
      const quiz  = parseBox('#boxQuiz');
      const vocab = parseBox('#boxVocab');
      const ai    = parseBox('#boxAI');
      if(!index||!cues||!quiz||!vocab||!ai){ err(st,'五份 JSON 需全部產生（請先按「預覽 JSON」）'); return false; }
      const needIndex=['slug','category','video','cover','updatedAt'];
      for(const k of needIndex){ if(!(k in index)){ err(st,'index 缺少欄位：'+k); return false; } }
      if(!/^[a-z0-9\-_.]+$/i.test(index.slug)){ err(st,'slug 僅允許英數與 - _ .'); return false; }
      if(!['story','music','movie','news','pro'].includes(index.category)){ err(st,'category 非法'); return false; }
      if(!Array.isArray(cues) || cues.length===0){ err(st,'cues 需為非空陣列'); return false; }
      for(let i=0;i<Math.min(cues.length,5);i++){ const c=cues[i]; if(!c||typeof c.time!=='string'||typeof c.en!=='string'){ err(st,'cues 項缺 time/en 字串'); return false; } }
      if(!(quiz && Array.isArray(quiz.topics) && quiz.topics.length>=1)){ err(st,'quiz 結構錯誤（topics 陣列缺失）'); return false; }
      if(!(vocab && Array.isArray(vocab.words))){ err(st,'vocab 應包含 words 陣列'); return false; }
      if(!(Array.isArray(ai.tasks) || Array.isArray(ai.topics))){ err(st,'ai 應包含 tasks 或 topics 陣列'); return false; }
      return true;
    }

    qs('#btnUploadGithub')?.addEventListener('click', async ()=>{
      const st=qs('#ghStatus'); st.textContent='';
      if(!validatePreview(st)){ setProgress(ghBar,ghPct,0); return; }

      const owner=qs('#ghOwner').value.trim();
      const repo=qs('#ghRepo').value.trim();
      const branch=qs('#ghBranch').value.trim();
      const base=(qs('#ghBase').value||'').trim();
      const token=qs('#ghTok').value.trim();
      const msg=qs('#ghMsg').value.trim()||'Add JSON';
      if(!owner||!repo||!branch||!token){ st.textContent='[錯誤] 請填 owner / repo / branch / token'; return; }

      const cat=qs('#cat').value.trim();
      const slug=qs('#slug').value.trim();

      const index = qs('#boxIndex').value;
      const cues  = qs('#boxCues').value;
      const quiz  = qs('#boxQuiz').value;
      const vocab = qs('#boxVocab').value;
      const ai    = qs('#boxAI').value;

      const root = `${base ? base.replace(/\/?$/,'/') : ''}data/${cat}/${slug}`;
      const files = [
        {name:`${root}/index-${slug}.json`, content:index},
        {name:`${root}/cues-${slug}.json`,  content:cues},
        {name:`${root}/quiz-${slug}.json`,  content:quiz},
        {name:`${root}/vocab-${slug}.json`, content:vocab},
        {name:`${root}/ai-${slug}.json`,    content:ai},
      ];

      try{
        setProgress(ghBar,ghPct,0);
        let i=0;
        await ghPutFileWithProgress(async(f)=>{
          i++; st.textContent+=`[${i}/5] 上傳 ${f.name}...\n`;
          await ghPutFile({owner,repo,branch,token,path:f.name,content:f.content,message:msg});
          await sleep(180);
        }, files, p=>setProgress(ghBar,ghPct,p));
        st.textContent+='完成。';
      }catch(e){
        st.textContent+=`[失敗] ${e.message||e}`;
        setProgress(ghBar,ghPct,0);
      }
    });
  })();
  </script>
</body>
</html>




















































































