<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>BookWide Admin 多語打包（Forward Fix）v20251106</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --fg:#111; --bg:#fff; --muted:#5c5c5c; --line:#e5e5e5; --primary:#1a73e8; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:15px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Hiragino Sans","Microsoft JhengHei",Arial,sans-serif;}
    .wrap{max-width:1024px;margin:24px auto;padding:0 16px;}
    h1{font-size:22px;margin:0 0 8px;}
    .sub{color:var(--muted);font-size:13px;margin:0 0 24px;}
    .card{border:1px solid var(--line);border-radius:10px;background:#fff;margin:16px 0;overflow:hidden;}
    .card-hd{padding:14px 16px;border-bottom:1px solid var(--line);font-weight:600;}
    .card-bd{padding:16px;}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
    label{display:block;font-weight:600;margin:8px 0 6px;}
    input[type=text],select,textarea{width:100%;box-sizing:border-box;border:1px solid var(--line);border-radius:8px;padding:10px 12px;background:#fff;color:var(--fg);}
    textarea{min-height:120px;white-space:pre-wrap}
    .muted{color:var(--muted);font-size:12px;margin-top:4px}
    .btn{display:inline-flex;align-items:center;gap:8px;background:var(--primary);color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-secondary{background:#222}
    .chip{display:inline-block;background:#eef3fe;color:#2b65d9;border-radius:999px;padding:2px 8px;font-size:12px;margin-left:8px}
    details{border:1px dashed var(--line);border-radius:10px;padding:10px 12px;background:#fafafa}
    details[open]{background:#f5f7ff}
    details summary{cursor:pointer;font-weight:600;margin:-10px -12px 8px;padding:10px 12px}
    .hint{background:#fff9e6;border:1px solid #ffe5a0;padding:8px 12px;border-radius:8px;color:#8a6400}
    .hr{height:1px;background:var(--line);margin:16px 0}
    .right{display:flex;gap:8px;justify-content:flex-end}
    .note{font-size:12px;color:var(--muted)}
    code{background:#f1f3f5;padding:2px 6px;border-radius:6px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
<body>
<div class="wrap">
  <h1>BookWide Admin 多語打包 <span class="chip">Forward Fix v20251106</span></h1>
  <p class="sub">保持白底黑字與現有流程；新增 EN / ZH / JA 多語輸入，ZIP 內建 <code>index-*.json</code>、<code>cues-*.json</code>、<code>vocab-*.json</code>、<code>quiz-*.json</code>、<code>ai-*.json</code>（Quiz 80、AI 15）。</p>

  <!-- 基本設定 -->
  <div class="card">
    <div class="card-hd">MP4 上傳自動化（slug 檔名；完成即送 JSON ZIP）</div>
    <div class="card-bd">
      <div class="row">
        <div>
          <label>分類 category</label>
          <select id="cat">
            <option value="story">story</option>
            <option value="music" selected>music</option>
            <option value="movie">movie</option>
            <option value="news">news</option>
            <option value="pro">pro</option>
          </select>
        </div>
        <div>
          <label>Slug（不含空白與副檔名）</label>
          <input id="slug" type="text" placeholder="例如：alittlelove" value="alittlelove">
        </div>
      </div>

      <div class="row">
        <div>
          <label>顯示標題（可空）</label>
          <input id="title" type="text" placeholder="顯示名稱（可空）" value="A Little Love">
        </div>
        <div>
          <label>封面（相對路徑；預設 <code>cover.jpg</code>）</label>
          <input id="cover" type="text" placeholder="cover.jpg" value="cover.jpg">
        </div>
      </div>

      <div class="row3">
        <div>
          <label>RMS 閾值</label>
          <input id="rms" type="text" value="0.008">
          <div class="note">僅寫入 index.json 供紀錄</div>
        </div>
        <div>
          <label>最短靜音（秒）</label>
          <input id="minsil" type="text" value="0.25">
          <div class="note">僅寫入 index.json 供紀錄</div>
        </div>
        <div>
          <label>吸附窗口 ±（秒）</label>
          <input id="snap" type="text" value="1.5">
          <div class="note">僅寫入 index.json 供紀錄</div>
        </div>
      </div>

      <div class="hr"></div>

      <!-- 多語輸入（可折疊） -->
      <details open>
        <summary>多語字幕與單字（EN / ZH / JA）</summary>

        <label>EN 字幕（每行一筆）</label>
        <textarea id="en" placeholder="每行一筆英文台詞"></textarea>

        <label>ZH 字幕（對齊 EN 行數；可留空）</label>
        <textarea id="zh" placeholder="每行一筆中文台詞（可空，會自動補空）"></textarea>

        <label>JA 字幕（對齊 EN 行數；可留空）</label>
        <textarea id="ja" placeholder="每行一筆日文台詞（可空，會自動補空）"></textarea>

        <label>Vocab（每行：<code>word | pos | zh | ja</code>）</label>
        <textarea id="vocab" placeholder="festival | n. | 節慶 | 祭り"></textarea>

        <p class="hint">說明：以 EN 行數為基準，自動與 ZH/JA 對齊。若 ZH/JA 行數不足，會自動補空字串，不會出錯。</p>
      </details>

      <div class="hr"></div>

      <div class="right">
        <button class="btn" id="btnMake">上傳並寫入資料表 → 產生 ZIP</button>
        <button class="btn btn-secondary" id="btnDemo">載入示例</button>
      </div>

      <p class="muted">
        下載後放到 GitHub：<code>/data/&lt;category&gt;/&lt;slug&gt;/</code>。檔名包含前綴（index-*.json、cues-*.json、vocab-*.json、quiz-*.json、ai-*.json）。
      </p>
    </div>
  </div>
</div>

<script>
// ====== Forward Fix 基礎 ======
const BW_DATA_VERSION = 'bw-cues@1.1'; // cues/vocab schema 標示

function lines(id){
  return (document.getElementById(id)?.value || '')
    .replace(/\r/g,'')
    .split('\n')
    .map(s=>s.trim())
    .filter(Boolean);
}
function padTo(arr, n){ const a = arr.slice(); while(a.length<n) a.push(''); return a; }
function alignTriplet(en, zh, ja){ return {en, zh:padTo(zh,en.length), ja:padTo(ja,en.length)}; }

function buildCuesFromLines(){
  const CHUNK = 8; // 每行預設 8 秒
  const en = lines('en'), zh = lines('zh'), ja = lines('ja');
  const {en:EN, zh:ZH, ja:JA} = alignTriplet(en, zh, ja);
  const cues = [];
  for(let i=0;i<EN.length;i++){
    cues.push({
      time:{ s: i*CHUNK, e:(i+1)*CHUNK },
      en: EN[i] || '', zh: ZH[i] || '', ja: JA[i] || ''
    });
  }
  return cues;
}

function safeSplit4(line){
  const p = (line||'').split('|').map(s=>s.trim());
  return [p[0]||'', p[1]||'', p[2]||'', p[3]||''];
}
function buildVocab(){
  const arr = lines('vocab');
  const out = [];
  for(const raw of arr){
    const [word,pos,zh,ja] = safeSplit4(raw);
    if(!word || !pos) continue;
    out.push({word,pos,zh,ja});
  }
  return out;
}

function buildIndex(){
  const cat = document.getElementById('cat').value;
  const slug = document.getElementById('slug').value.trim();
  const title = document.getElementById('title').value.trim();
  const cover = document.getElementById('cover').value.trim() || 'cover.jpg';
  const index = {
    schema: 'bw-index@1.0',
    title: title || slug,
    category: cat, slug,
    video: `https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/videos/${cat}/${slug}.mp4`,
    cover: `https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/assets/${cat}/${slug}/` + cover,
    cues: { zh:'./cues-'+slug+'.json', ja:'./cues-'+slug+'.json' }, // 單檔含多語
    vocab: './vocab-'+slug+'.json',
    quiz: './quiz-'+slug+'.json',
    ai: './ai-'+slug+'.json',
    params: {
      rms: document.getElementById('rms').value.trim(),
      min_silence: document.getElementById('minsil').value.trim(),
      snap: document.getElementById('snap').value.trim()
    },
    is_public: true
  };
  return index;
}

function buildQuizFromVocab(vocab, need=80){
  // 簡單出題：英-義 單選
  if(!Array.isArray(vocab) || vocab.length===0) return [];
  const pool = [...vocab];
  while(pool.length < need) pool.push(...vocab);
  const out = [];
  for(let i=0;i<need;i++){
    const v = pool[i % pool.length];
    const distract = [];
    // 取其他詞的 zh 作為干擾
    for(let j=i+1;j<i+4;j++){
      const w = pool[j % pool.length];
      distract.push(w.zh || w.word);
    }
    const choices = [v.zh || v.word, ...distract].slice(0,4).sort(()=>Math.random()-0.5);
    const answer = choices.indexOf(v.zh || v.word);
    out.push({ type:'mc', q:`What is the meaning of "${v.word}"?`, choices, answer });
  }
  return out;
}

function buildAI(need=15){
  // 英文 prompt，方便後續翻譯
  const base = [
    'Describe the festival.',
    'What will you do this year?',
    'Share a memory about the moon.',
    'Tell us your favorite food for this festival.',
    'How do people celebrate in your hometown?'
  ];
  const out = [];
  for(let i=0;i<need;i++){
    out.push({ title:`Topic ${i+1}`, prompt: base[i % base.length], hint:'', sample:'' });
  }
  return { schema:'bw-ai@1.0', topics: out };
}

// --- ZIP ---
async function afterMakeZip(zipBlob){
  // 你若要改成：上傳到 Supabase → 改寫成上傳即可。
  const slug = document.getElementById('slug').value.trim() || 'demo';
  const a = document.createElement('a');
  a.href = URL.createObjectURL(zipBlob);
  a.download = `data_${slug}.zip`;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 20000);
}

async function makeZip(){
  const cat = document.getElementById('cat').value;
  const slug = document.getElementById('slug').value.trim();
  if(!slug){ alert('請填 slug'); return; }

  const cues = buildCuesFromLines();             // 多語
  const vocab = buildVocab();                    // 含 ja
  const index = buildIndex();
  const quiz  = buildQuizFromVocab(vocab, 80);
  const ai    = buildAI(15);

  // 標示 schema（向前修護）
  const cuesDoc  = { schema: BW_DATA_VERSION, cues };
  const vocabDoc = { schema: 'bw-vocab@1.1', words: vocab };

  const zip = new JSZip();
  const dir = zip.folder(`${cat}/${slug}`);
  dir.file(`index-${slug}.json`, JSON.stringify(index, null, 2));
  dir.file(`cues-${slug}.json`,  JSON.stringify(cuesDoc, null, 2));
  dir.file(`vocab-${slug}.json`, JSON.stringify(vocabDoc, null, 2));
  dir.file(`quiz-${slug}.json`,  JSON.stringify(quiz, null, 2));
  dir.file(`ai-${slug}.json`,    JSON.stringify(ai, null, 2));

  const blob = await zip.generateAsync({type:'blob'});
  await afterMakeZip(blob);
}

// Demo 資料
function loadDemo(){
  document.getElementById('slug').value = 'alittlelove';
  document.getElementById('title').value = 'A Little Love';
  document.getElementById('cover').value = 'cover.jpg';
  document.getElementById('en').value =
`One day, the suns appeared.
The world turned hot.
People stayed in the shade.
A hero raised his bow.
He shot down the suns.`;
  document.getElementById('zh').value =
`有一天，太陽們出現了。
世界變得很熱。
人們躲在陰影裡。
一位英雄拉起弓。
他射下了那些太陽。`;
  document.getElementById('ja').value =
`ある日、太陽たちが現れた。
世界は暑くなった。
人々は日陰に隠れた。
英雄が弓を引いた。
彼は太陽たちを射落とした。`;
  document.getElementById('vocab').value =
`lantern | n. | 燈籠 | ちょうちん
festival | n. | 節慶 | 祭り
archer | n. | 弓箭手 | 弓兵
immortal | adj. | 不死的 | 不死の
moon | n. | 月亮 | 月`;
}

document.getElementById('btnMake').addEventListener('click', makeZip);
document.getElementById('btnDemo').addEventListener('click', loadDemo);
</script>
</body>
</html>





































































