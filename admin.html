<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BookWide Admin · v20251107-full-tabs-all</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<style>
  :root{--brand:#2563eb;--ok:#16a34a;--warn:#f59e0b;--err:#ef4444;--muted:#6b7280}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; background:#fafafa; color:#111827}
  header{display:flex; align-items:center; gap:12px; padding:14px 18px; background:#fff; border-bottom:1px solid #e5e7eb;}
  header h1{font-size:18px; margin:0; font-weight:700}
  .tabs{display:flex; gap:8px; margin-left:auto}
  .tabs button{border:1px solid #d1d5db; background:#fff; padding:8px 12px; border-radius:8px; cursor:pointer}
  .tabs button.active{background:#eef2ff; border-color:#c7d2fe; color:#1d4ed8; font-weight:600}
  main{max-width:1180px; margin:24px auto; padding:0 16px}
  section{display:none; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:18px; }
  section.active{display:block}
  h2{font-size:18px; margin:0 0 14px}
  .row{display:flex; gap:14px; flex-wrap:wrap}
  .col{flex:1 1 320px}
  label{display:block; font-size:13px; color:#374151; margin:8px 0 6px}
  input[type=text],input[type=number],select,textarea{
    width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:10px; background:#fff; font-size:14px;
  }
  textarea{min-height:120px; font-family:ui-monospace,Consolas,monospace}
  .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:999px; border:0; cursor:pointer; font-weight:600}
  .btn.primary{background:var(--brand); color:#fff}
  .btn.ok{background:var(--ok); color:#fff}
  .btn.danger{background:var(--err); color:#fff}
  .btn.ghost{background:#fff; border:1px solid #d1d5db}
  .muted{color:var(--muted); font-size:12px}
  .pill{display:inline-block; font-size:12px; padding:3px 8px; border-radius:999px; background:#eef2ff; color:#1d4ed8; margin-left:6px}
  .bar{height:6px; background:#e5e7eb; border-radius:3px; overflow:hidden}
  .bar>i{display:block; height:6px; width:0}
  .bar.ok>i{background:var(--ok)}
  .bar.blue>i{background:var(--brand)}
  pre.log{background:#f9fafb; padding:10px; border-radius:10px; font-size:12px; white-space:pre-wrap; border:1px solid #e5e7eb}
  .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:14px}
  table{width:100%; border-collapse:collapse; border:1px solid #e5e7eb;}
  th,td{padding:10px 8px; border-bottom:1px solid #eef2f7; font-size:14px; text-align:left; vertical-align:top}
  th{background:#f8fafc; color:#334155; position:sticky; top:0; z-index:1}
  .chip{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px}
  .chip.ok{background:#dcfce7; color:#166534}
  .chip.warn{background:#fff7ed; color:#9a3412}
  .chip.muted{background:#f3f4f6; color:#374151}
  .flex{display:flex; align-items:center; gap:8px}
  .right{margin-left:auto}
</style>
</head>
<body>
<header>
  <h1>BookWide Admin 主控台</h1>
  <span class="pill">v20251107-full-tabs-all</span>
  <div class="right flex">
    <!-- 全域 Supabase 連線（可留空：若頁面已有 window.BW.supa） -->
    <span class="muted">Supabase：</span>
    <input id="gSupaUrl" type="text" placeholder="https://xxxx.supabase.co" style="width:280px">
    <input id="gSupaKey" type="text" placeholder="anon key" style="width:260px">
    <button id="btnSaveSupa" class="btn ghost">保存連線</button>
  </div>
  <div class="tabs">
    <button class="active" data-tab="tab3">MP4 上傳 + JSON + GitHub + Supabase</button>
    <button data-tab="tab1">使用者清單</button>
    <button data-tab="tab2">授權 / 暫停管理員</button>
  </div>
</header>

<main>
  <!-- TAB 3: MP4 + 字幕 + JSON + GitHub + Supabase -->
  <section id="tab3" class="active">
    <h2>MP4 上傳自動化（含字幕匯入、JSON 預覽、GitHub/Supabase 上傳）</h2>

    <div class="grid">
      <div class="col">
        <label>分類</label>
        <select id="cat">
          <option value="story">story</option>
          <option value="music" selected>music</option>
          <option value="movie">movie</option>
          <option value="news">news</option>
          <option value="pro">pro</option>
        </select>
      </div>
      <div class="col">
        <label>Slug（不含空白與副檔名）</label>
        <input id="slug" type="text" placeholder="例如 applesong" />
      </div>
      <div class="col">
        <label>顯示標題（可空）</label>
        <input id="title" type="text" placeholder="例如 A Little Love" />
      </div>
    </div>

    <div class="grid" style="margin-top:10px">
      <div class="col">
        <label>MP4 檔（可拖拉到此處）</label>
        <input id="mp4File" type="file" accept="video/mp4" />
      </div>
      <div class="col">
        <label>封面（可選）</label>
        <input id="coverFile" type="file" accept="image/*" />
      </div>
      <div class="col">
        <label>字幕檔（可選，支援 TXT / SRT / VTT / JSON）</label>
        <input id="subFile" type="file" accept=".txt,.srt,.vtt,.json" />
      </div>
    </div>

    <div class="grid" style="margin-top:10px">
      <div class="col">
        <label>中/日文產生模式</label>
        <div>
          <label><input type="radio" name="mt" value="simple" checked /> 簡易（只產生 en，zh/ja 先留空）</label><br/>
          <label><input type="radio" name="mt" value="edge" /> 機翻（Edge Function 名稱）：</label>
          <input id="edgeFn" type="text" value="mt-translate" />
          <div class="muted">（保留欄位，之後接上你現有的 Edge Function 即可）</div>
        </div>
      </div>
      <div class="col">
        <label>吸附窗參數（可選）</label>
        <div class="row" style="gap:8px">
          <div class="col">
            <label>RMS 門檻</label>
            <input id="rms" type="number" value="0.008" step="0.001">
          </div>
          <div class="col">
            <label>最短靜音（秒）</label>
            <input id="minSil" type="number" value="0.25" step="0.05">
          </div>
          <div class="col">
            <label>窗口(±s)</label>
            <input id="win" type="number" value="1.5" step="0.1">
          </div>
        </div>
      </div>
    </div>

    <div style="margin-top:14px">
      <button id="btnPreview" class="btn ghost">預覽 JSON（5 件）</button>
    </div>

    <div class="grid" style="margin-top:12px">
      <div class="col">
        <label>index-*.json</label>
        <textarea id="boxIndex" placeholder="index"></textarea>
      </div>
      <div class="col">
        <label>cues-*.json（en/zh/ja 三語同檔）</label>
        <textarea id="boxCues" placeholder="cues"></textarea>
      </div>
      <div class="col">
        <label>vocab-*.json</label>
        <textarea id="boxVocab" placeholder="vocab"></textarea>
      </div>
      <div class="col">
        <label>quiz-*.json</label>
        <textarea id="boxQuiz" placeholder="quiz"></textarea>
      </div>
      <div class="col">
        <label>ai-*.json（15 題）</label>
        <textarea id="boxAI" placeholder="ai 15 題"></textarea>
      </div>
    </div>

    <hr style="margin:18px 0"/>

    <!-- Supabase -->
    <h2>Supabase 上傳（影片＋封面）</h2>
    <div class="grid">
      <div class="col">
        <label>Supabase URL（可空，優先使用 header 的全域設定或 window.BW?.supa）</label>
        <input id="supaUrl" type="text" placeholder="https://xxxx.supabase.co">
      </div>
      <div class="col">
        <label>Supabase anon key（可空）</label>
        <input id="supaKey" type="text" placeholder="eyJhbGciOi...">
      </div>
      <div class="col">
        <label>影片桶名</label>
        <input id="bucketVideo" type="text" value="videos">
      </div>
      <div class="col">
        <label>封面桶名</label>
        <input id="bucketAsset" type="text" value="assets">
      </div>
    </div>

    <div style="margin-top:12px">
      <button id="btnSupaUpload" class="btn ok">上傳到 Supabase（影片＋封面）</button>
    </div>

    <div id="supaStatus" style="margin-top:10px"></div>

    <hr style="margin:18px 0"/>

    <!-- GitHub upload -->
    <h2>GitHub 上傳設定（僅本機暫存，不會保存）</h2>
    <div class="grid">
      <div class="col">
        <label>Owner（使用者或組織）</label>
        <input id="ghOwner" type="text" value="bookwide">
      </div>
      <div class="col">
        <label>Repo</label>
        <input id="ghRepo" type="text" value="EduEnglish">
      </div>
      <div class="col">
        <label>Branch</label>
        <input id="ghBranch" type="text" value="main">
      </div>
      <div class="col">
        <label>Base Path（可留空；例如 data/）</label>
        <input id="ghBase" type="text" value="data/">
      </div>
      <div class="col">
        <label>Commit 訊息</label>
        <input id="ghMsg" type="text" value="Add JSON templates">
      </div>
      <div class="col">
        <label>GitHub Token（Classic PAT，需含 repo + workflow）</label>
        <input id="ghTok" type="text" placeholder="ghp_xxx">
      </div>
    </div>
    <div style="margin-top:12px">
      <button id="btnGH" class="btn primary">上傳到 GitHub（5 件）</button>
      <span class="muted">路徑：basePath/data/{category}/{slug}/</span>
    </div>
    <pre id="ghLog" class="log" style="margin-top:10px"></pre>
  </section>

  <!-- TAB 1: 使用者清單 -->
  <section id="tab1">
    <div class="flex">
      <h2>使用者清單（public.profiles）</h2>
      <button id="btnReloadUsers" class="btn ghost right">重新整理</button>
    </div>
    <div class="row">
      <div class="col">
        <label>搜尋 Email / 顯示名稱</label>
        <input id="uSearch" type="text" placeholder="關鍵字...">
      </div>
      <div class="col">
        <label>每頁筆數</label>
        <input id="uLimit" type="number" value="200" min="10" step="10">
      </div>
    </div>
    <div id="usersWrap" style="margin-top:12px; max-height:60vh; overflow:auto; border:1px solid #e5e7eb; border-radius:10px;">
      <table id="usersTbl">
        <thead>
          <tr>
            <th>Email</th>
            <th>顯示名稱</th>
            <th>最後登入（台灣）</th>
            <th>最近在線（台灣）</th>
            <th>管理員</th>
            <th>狀態</th>
            <th>到期日</th>
          </tr>
        </thead>
        <tbody id="usersTbody"></tbody>
      </table>
    </div>
    <div class="muted" style="margin-top:6px">欄位預設：<span class="kbd">email</span>、<span class="kbd">display_name</span>、<span class="kbd">last_signin_at</span>、<span class="kbd">last_seen_at</span>、<span class="kbd">is_admin</span>、<span class="kbd">status</span>、<span class="kbd">expires_at</span>（可按實際 schema 調整程式內欄位對映）。</div>
  </section>

  <!-- TAB 2: 授權 / 暫停管理員 -->
  <section id="tab2">
    <h2>授權 / 暫停管理員</h2>
    <div class="row">
      <div class="col">
        <label>目標 Email</label>
        <input id="mEmail" type="text" placeholder="someone@example.com">
      </div>
      <div class="col">
        <label>切換管理員</label>
        <div class="flex">
          <button id="btnSetAdmin" class="btn ok">設為管理員</button>
          <button id="btnUnsetAdmin" class="btn ghost">取消管理員</button>
        </div>
      </div>
      <div class="col">
        <label>帳號狀態</label>
        <div class="flex">
          <button id="btnActivate" class="btn ok">啟用</button>
          <button id="btnSuspend" class="btn danger">停用</button>
        </div>
      </div>
      <div class="col">
        <label>到期日（ISO）</label>
        <input id="mExpire" type="text" placeholder="2026-12-31T23:59:59Z">
      </div>
      <div class="col">
        <label>&nbsp;</label>
        <button id="btnSetExpire" class="btn ghost">設定到期日</button>
      </div>
    </div>
    <pre id="mLog" class="log" style="margin-top:10px"></pre>
  </section>
</main>

<!-- Supabase 客戶端（前端 CDN 版） -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<script>
/* ---------- Tab 切換 ---------- */
const $=sel=>document.querySelector(sel);
const $$=sel=>document.querySelectorAll(sel);
$$('.tabs button').forEach(b=>b.addEventListener('click',()=>setTab(b.dataset.tab)));
function setTab(id){
  $$('.tabs button').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
  $$('main section').forEach(s=>s.classList.toggle('active', s.id===id));
}

/* ---------- 全域 Supabase 連線設定（header） ---------- */
(function loadSupaHeader(){
  const s=JSON.parse(localStorage.getItem('BW_SUPA')||'{}');
  if(s.url) $('#gSupaUrl').value=s.url;
  if(s.key) $('#gSupaKey').value=s.key;
})();
$('#btnSaveSupa').addEventListener('click',()=>{
  localStorage.setItem('BW_SUPA', JSON.stringify({url:$('#gSupaUrl').value.trim(), key:$('#gSupaKey').value.trim()}));
  alert('已保存 Supabase 連線到本機（localStorage）');
});

/* ---------- 取得 Supabase client ---------- */
function getSupa(){
  const auto = (window.BW && window.BW.supa) ? window.BW.supa : null;
  const sLocal = JSON.parse(localStorage.getItem('BW_SUPA')||'{}');
  const url = ($('#gSupaUrl').value.trim() || auto?.url || sLocal.url);
  const key = ($('#gSupaKey').value.trim() || auto?.anonKey || sLocal.key);
  if(!url || !key) return null;
  return supabase.createClient(url, key, {auth:{persistSession:false}});
}

/* ---------- 使用者清單 ---------- */
async function fetchUsers(){
  const sb=getSupa(); if(!sb){ alert('請先在上方填 Supabase URL / Key'); return; }
  const q = $('#uSearch').value.trim();
  const limit = Math.max(10, +$('#uLimit').value||200);
  let req = sb.from('profiles')
              .select('email, display_name, last_signin_at, last_seen_at, is_admin, status, expires_at')
              .order('last_seen_at', {ascending:false})
              .limit(limit);
  if(q){
    req = req.ilike('email', `%${q}%`).or(`display_name.ilike.%${q}%`);
  }
  const {data, error} = await req;
  if(error){ alert(error.message); return; }
  const tbody=$('#usersTbody'); tbody.innerHTML='';
  const tz = Intl.DateTimeFormat('zh-TW',{timeZone:'Asia/Taipei', dateStyle:'short', timeStyle:'medium'});
  data.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${r.email||''}</td>
      <td>${r.display_name||''}</td>
      <td>${r.last_signin_at? tz.format(new Date(r.last_signin_at)) : ''}</td>
      <td>${r.last_seen_at?   tz.format(new Date(r.last_seen_at))   : ''}</td>
      <td>${r.is_admin?'<span class="chip ok">已授權</span>':'<span class="chip muted">一般</span>'}</td>
      <td>${r.status==='suspended' ? '<span class="chip warn">停用</span>' : '<span class="chip ok">啟用</span>'}</td>
      <td>${r.expires_at? tz.format(new Date(r.expires_at)) : ''}</td>
    `;
    tbody.appendChild(tr);
  });
}
$('#btnReloadUsers').addEventListener('click', fetchUsers);
$('#uSearch').addEventListener('keydown',e=>{ if(e.key==='Enter') fetchUsers(); });

/* ---------- 管理員/狀態/到期日 操作 ---------- */
async function mutateProfile(patch){
  const sb=getSupa(); if(!sb){ alert('缺 Supabase URL/Key'); return; }
  const email = $('#mEmail').value.trim(); if(!email){ alert('請輸入 Email'); return; }
  const {error} = await sb.from('profiles').update(patch).eq('email', email);
  if(error) throw error;
}
function logM(s){ $('#mLog').textContent += s+'\n'; }
$('#btnSetAdmin').addEventListener('click', async ()=>{
  try{ await mutateProfile({is_admin:true}); logM('✅ 設為管理員'); }catch(e){ logM('❌ '+e.message); }
});
$('#btnUnsetAdmin').addEventListener('click', async ()=>{
  try{ await mutateProfile({is_admin:false}); logM('✅ 取消管理員'); }catch(e){ logM('❌ '+e.message); }
});
$('#btnActivate').addEventListener('click', async ()=>{
  try{ await mutateProfile({status:'active'}); logM('✅ 設為啟用'); }catch(e){ logM('❌ '+e.message); }
});
$('#btnSuspend').addEventListener('click', async ()=>{
  try{ await mutateProfile({status:'suspended'}); logM('✅ 設為停用'); }catch(e){ logM('❌ '+e.message); }
});
$('#btnSetExpire').addEventListener('click', async ()=>{
  const dt=$('#mExpire').value.trim(); if(!dt){ alert('請填 ISO 時間'); return; }
  try{ await mutateProfile({expires_at:dt}); logM('✅ 已設定到期日'); }catch(e){ logM('❌ '+e.message); }
});

/* ---------- 工具：字幕/JSON/上傳（承接你上一版需求） ---------- */
const textEl = el => (el?.value||'').trim();
function srtTimeToSec(t){ if(!t) return 0; const m=t.replace(',', '.').match(/(\d+):(\d+):(\d+(?:\.\d+)?)/); if(!m) return 0; return (+m[1])*3600+(+m[2])*60+(+m[3]); }
function parseSRT(s){ const blocks=s.replace(/\r/g,'').trim().split(/\n\n+/); const out=[]; for(const b of blocks){ const lines=b.split('\n'); if(lines.length<2) continue; let i=0; if(/^\d+$/.test(lines[0])) i=1; const ts=lines[i]||''; const mm=ts.match(/(\d+:\d+:\d+[.,]\d+)\s*-->\s*(\d+:\d+:\d+[.,]\d+)/); if(!mm) continue; const ssec=srtTimeToSec(mm[1]), esec=srtTimeToSec(mm[2]); const txt=lines.slice(i+1).join(' ').trim(); out.push({s:ssec,e:esec,en:txt,zh:'',ja:'',t:txt}); } return out; }
function parseVTT(v){ return parseSRT(v.replace(/^WEBVTT[^\n]*\n/,'')); }
function parseTXT(t){ const lines=t.replace(/\r/g,'').split('\n').map(l=>l.trim()).filter(Boolean); const out=[]; let s=0; for(const ln of lines){ out.push({s,e:s+4,en:ln,zh:'',ja:'',t:ln}); s+=4; } return out; }
function ensureCuesLang(cues){ return cues.map(x=>({s:+(x.s||0), e:+(x.e||Math.max((+x.s||0)+3,(+x.s||0))), en:x.en??x.t??'', zh:x.zh??'', ja:x.ja??'', t:x.en??x.t??'' })); }
async function readFileString(file){ if(!file) return ''; return await file.text(); }
function buildIndex({cat,slug,title,videoUrl='',coverUrl=''}){return{slug, title:title||slug, category:cat, video:videoUrl, cover:coverUrl, updated_at:new Date().toISOString()}}
function buildVocab(cues){ const set=new Set(); for(const c of cues){ (c.en||'').split(/[^A-Za-z'-]+/).forEach(w=>{ if(w&&w.length>=4) set.add(w.toLowerCase()); }); } return {vocab:[...set].slice(0,20).map(w=>({word:w,meaning:"",example:""}))}; }
function buildQuiz(cues){ const arr=[]; for(let i=0;i<Math.min(5,cues.length);i++){ arr.push({type:"mc",q:"What does this line mean?",ref:cues[i].en||'',options:["Statement","Question","Feeling","Action"],answer:0}); } return {quiz:arr}; }
function buildAI15(slug,title){ const base=["Describe the song.","What do you like about it?","Share your memory.","Who do you sing with?","What is the main message?","Find two rhymes.","Paraphrase one line.","What feeling does it give?","Create a new verse.","Which word is repeated?","Who is speaking?","When does it happen?","Where does it happen?","What is the conflict?","How does it end?"]; return {title:(title||slug||'Lesson'), topics: base.map((p,i)=>({title:`Topic ${i+1}`,prompt:p,hint:"",sample:""}))}; }

$('#btnPreview').addEventListener('click', async ()=>{
  const cat=textEl($('#cat')); const slug=textEl($('#slug')); if(!slug){ alert('請先輸入 Slug'); return; }
  const title=textEl($('#title'));
  let cues=[]; const f=$('#subFile').files[0];
  if(f){ const s=await readFileString(f); if(f.name.endsWith('.srt')) cues=parseSRT(s); else if(f.name.endsWith('.vtt')) cues=parseVTT(s); else if(f.name.endsWith('.json')){ try{cues=JSON.parse(s)}catch{} } else cues=parseTXT(s); }
  if(!cues.length){ cues=[{s:0,e:4,en:"Line 01 (edit me)",zh:"",ja:"",t:"Line 01 (edit me)"},
                         {s:4,e:8,en:"Line 02 (edit me)",zh:"",ja:"",t:"Line 02 (edit me)"},
                         {s:8,e:12,en:"Line 03 (edit me)",zh:"",ja:"",t:"Line 03 (edit me)"}]; }
  cues=ensureCuesLang(cues);
  $('#boxIndex').value=JSON.stringify(buildIndex({cat,slug,title}),null,2);
  $('#boxCues').value =JSON.stringify(cues,null,2);
  $('#boxVocab').value=JSON.stringify(buildVocab(cues),null,2);
  $('#boxQuiz').value =JSON.stringify(buildQuiz(cues),null,2);
  $('#boxAI').value   =JSON.stringify(buildAI15(slug,title),null,2);
  alert('已產生 5 件 JSON 預覽。');
});

/* Supabase 上傳（含進度） */
function supaPublicUrl(root,bucket,path){ return `${root}/storage/v1/object/public/${bucket}/${encodeURI(path)}`; }
function resolveSupaPair(localUrlId, localKeyId){
  const auto = (window.BW && window.BW.supa) ? window.BW.supa : null;
  const head = JSON.parse(localStorage.getItem('BW_SUPA')||'{}');
  const url = ($(localUrlId).value.trim() || $('#gSupaUrl').value.trim() || auto?.url || head.url);
  const key = ($(localKeyId).value.trim() || $('#gSupaKey').value.trim() || auto?.anonKey || head.key);
  return {url,key};
}
$('#btnSupaUpload').addEventListener('click', async ()=>{
  const st=$('#supaStatus'); st.innerHTML='';
  const mp4=$('#mp4File').files[0]; if(!mp4){ st.innerHTML='<div style="color:var(--err)">[錯誤] 請先選擇 MP4 檔。</div>'; return; }
  const cat=textEl($('#cat')); const slug=(textEl($('#slug'))||mp4.name.replace(/\.\w+$/,'')); $('#slug').value=slug;
  const {url:keyUrl,key:keyKey} = {url:'',key:''}; // placeholder
  const pair=resolveSupaPair('#supaUrl','#supaKey'); if(!pair.url||!pair.key){ st.innerHTML='<div style="color:var(--err)">[錯誤] 找不到 Supabase 連線。</div>'; return; }
  const bucketV=textEl($('#bucketVideo'))||'videos'; const bucketA=textEl($('#bucketAsset'))||'assets';
  const pathV=`${cat}/${slug}.mp4`; const cover=$('#coverFile').files[0]; const pathC=`${cat}/${slug}/cover.jpg`;
  st.innerHTML=`
    <div style="margin:6px 0 10px"><b>影片上傳進度：</b> <span id="pv">0%</span>
      <div class="bar ok" style="margin-top:4px"><i id="barV"></i></div>
    </div>
    <div style="margin:6px 0 10px"><b>封面上傳進度：</b> <span id="pc">0%</span>
      <div class="bar blue" style="margin-top:4px"><i id="barC"></i></div>
    </div>
    <pre id="slog" class="log"></pre>
  `;
  const log=m=>$('#slog').textContent+=m+'\n';

  // 影片
  try{
    const vUrl=await new Promise((resolve,reject)=>{
      const xhr=new XMLHttpRequest();
      xhr.open('POST', `${pair.url}/storage/v1/object/${bucketV}/${encodeURI(pathV)}`);
      xhr.setRequestHeader('Authorization', `Bearer ${pair.key}`);
      xhr.upload.onprogress=(e)=>{ if(e.lengthComputable){ const p=Math.round(e.loaded/e.total*100); $('#pv').textContent=p+'%'; $('#barV').style.width=p+'%'; } };
      xhr.onload=()=>{ if(xhr.status===200||xhr.status===201){ const pub=supaPublicUrl(pair.url,bucketV,pathV); log(`影片完成：${pub}`); resolve(pub); } else reject(xhr.responseText||xhr.statusText) };
      xhr.onerror=()=>reject('影片上傳失敗');
      const form=new FormData(); form.append('file', mp4); xhr.send(form);
    });
    try{ const idx=JSON.parse($('#boxIndex').value||'{}'); idx.video=vUrl; $('#boxIndex').value=JSON.stringify(idx,null,2);}catch{}
  }catch(e){ log('❌ '+e); }

  // 封面
  if(cover){
    try{
      const cUrl=await new Promise((resolve,reject)=>{
        const xhr=new XMLHttpRequest();
        xhr.open('POST', `${pair.url}/storage/v1/object/${bucketA}/${encodeURI(pathC)}`);
        xhr.setRequestHeader('Authorization', `Bearer ${pair.key}`);
        xhr.upload.onprogress=(e)=>{ if(e.lengthComputable){ const p=Math.round(e.loaded/e.total*100); $('#pc').textContent=p+'%'; $('#barC').style.width=p+'%'; } };
        xhr.onload=()=>{ if(xhr.status===200||xhr.status===201){ const pub=supaPublicUrl(pair.url,bucketA,pathC); log(`封面完成：${pub}`); resolve(pub); } else reject(xhr.responseText||xhr.statusText) };
        xhr.onerror=()=>reject('封面上傳失敗');
        const form=new FormData(); form.append('file', cover); xhr.send(form);
      });
      try{ const idx=JSON.parse($('#boxIndex').value||'{}'); idx.cover=cUrl; $('#boxIndex').value=JSON.stringify(idx,null,2);}catch{}
    }catch(e){ log('❌ '+e); }
  }else{ log('未選封面，略過。'); }

  log('✅ 上傳流程結束。');
});

/* GitHub 上傳（Classic PAT） */
async function ghPutFile({owner,repo,branch,token,path,content,message}){
  const url=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(path)}`;
  const body={ message, branch, content: btoa(unescape(encodeURIComponent(content))) };
  const r = await fetch(url,{method:'PUT', headers:{'Authorization':'token '+token, 'Content-Type':'application/json'}, body:JSON.stringify(body)});
  if(!r.ok){ throw new Error(`PUT ${path} 失敗：${r.status} ${await r.text()}`); }
  return await r.json();
}
$('#btnGH').addEventListener('click', async ()=>{
  const logEl=$('#ghLog'); logEl.textContent='';
  const owner=textEl($('#ghOwner')), repo=textEl($('#ghRepo')), branch=textEl($('#ghBranch'));
  const token=textEl($('#ghTok')), base=textEl($('#ghBase'))||'';
  const cat=textEl($('#cat')), slug=textEl($('#slug')); if(!slug){ alert('缺 slug'); return; }
  const msg=textEl($('#ghMsg'))||'Add JSON templates';
  const dir=`${base.replace(/\/?$/,'/')}${cat}/${slug}/`;
  const files=[
    {name:`index-${slug}.json`, box:'#boxIndex'},
    {name:`cues-${slug}.json`,  box:'#boxCues'},
    {name:`vocab-${slug}.json`, box:'#boxVocab'},
    {name:`quiz-${slug}.json`,  box:'#boxQuiz'},
    {name:`ai-${slug}.json`,    box:'#boxAI'}
  ];
  try{
    for(const f of files){
      const content=textEl($(f.box))||'{}'; const path=`${dir}${f.name}`;
      logEl.textContent += `↑ ${path} ...\n`;
      await ghPutFile({owner,repo,branch,token,path,content,message:msg});
      logEl.textContent += `✔ 完成：${path}\n`;
    }
    logEl.textContent += '✅ 全部完成！\n';
  }catch(e){ logEl.textContent += '❌ '+(e.message||e)+'\n'; }
});

/* 初次載入：若你有先填 header Supabase，就能直接點「重新整理」 */
window.addEventListener('load', ()=>{ /* 不自動打 API，讓你先填連線；按「重新整理」即可載入 */ });
</script>
</body>
</html>


















































































