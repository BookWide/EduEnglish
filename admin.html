<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BookWide Admin 主控台（白底內嵌版）</title>
<style>
  body{margin:0;background:#fff;color:#111;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;font-size:16px;line-height:1.6}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid #ddd;padding:12px 18px;z-index:5}
  .tabs{display:flex;gap:10px;margin-top:8px}
  .tab{padding:10px 14px;border:1px solid #ddd;border-radius:10px;background:#f7f7f7;cursor:pointer}
  .tab.active{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
  main{max-width:1100px;margin:auto;padding:20px}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
  .chip{display:inline-block;padding:3px 7px;border:1px solid #ddd;border-radius:999px;font-size:12px;background:#f1f5f9}
  footer{text-align:center;color:#888;font-size:12px;margin:20px 0}
</style>

<!-- ✅ 內嵌 Supabase 初始化（取代 supa.js） -->
<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
  const SUPABASE_URL = 'https://jeajrwpmrgczimmrflxo.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzA2NzMwNjUsImV4cCI6MjA0NjI0OTA2NX0.tn4GPXbc6A2QWJKJrmUm7WbmQawMpUoxqkOVevqMc50';
  window.supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession:true, autoRefreshToken:true } });
</script>
</head>

<body>
<header>
  <h1>BookWide Admin 主控台</h1>
  <div class="tabs">
    <button class="tab active" data-tab="users">使用者清單</button>
    <button class="tab" data-tab="roles">授權／暫停管理員</button>
    <button class="tab" data-tab="mp4">MP4 上傳自動化</button>
  </div>
</header>

<main>
  <section id="panel-users">
    <h3>使用者清單</h3>
    <table id="userTable">
      <thead><tr><th>Email</th><th>名稱</th><th>狀態</th><th>最後登入</th><th>最近在線</th><th>到期日</th></tr></thead>
      <tbody><tr><td colspan="6">載入中…</td></tr></tbody>
    </table>
  </section>

  <section id="panel-roles" style="display:none">
    <h3>授權／暫停管理員</h3>
    <table id="roleTable">
      <thead><tr><th>Email</th><th>名稱</th><th>管理員</th><th>停權</th><th>暫停</th></tr></thead>
      <tbody><tr><td colspan="5">載入中…</td></tr></tbody>
    </table>
  </section>

  <section id="panel-mp4" style="display:none">
    <h3>MP4 上傳自動化</h3>
    <p class="chip">此區可接你原有上傳功能</p>
  </section>
</main>

<footer>BookWide Admin · 內嵌 Supabase 版 · v20251104</footer>

<script type="module">
  const $=s=>document.querySelector(s),$$=s=>[...document.querySelectorAll(s)];
  const fmt=v=>v?new Date(v).toLocaleString('zh-TW',{timeZone:'Asia/Taipei',hour12:false}):'—';
  const COLS='id,email,display_name,is_admin,is_suspended,is_paused,last_sign_in_at,last_seen_at,expires_at';
  $$('.tab').forEach(b=>b.onclick=()=>{$$('.tab').forEach(x=>x.classList.remove('active'));b.classList.add('active');['users','roles','mp4'].forEach(k=>$('#panel-'+k).style.display='none');$('#panel-'+b.dataset.tab).style.display='block';});
  async function loadUsers(){const t=$('#userTable tbody');t.innerHTML='<tr><td colspan=6>載入中…</td></tr>';const r=await window.supa.from('profiles').select(COLS).order('email',{ascending:true});if(r.error){t.innerHTML='<tr><td colspan=6>錯誤:'+r.error.message+'</td></tr>';return;}t.innerHTML=r.data.map(x=>`<tr><td>${x.email}</td><td>${x.display_name||''}</td><td>${x.is_suspended?'停權':x.is_paused?'暫停':x.is_admin?'管理員':'正常'}</td><td>${fmt(x.last_sign_in_at)}</td><td>${fmt(x.last_seen_at)}</td><td>${x.expires_at||'—'}</td></tr>`).join('');}
  async function loadRoles(){const t=$('#roleTable tbody');const r=await window.supa.from('profiles').select(COLS).order('email',{ascending:true});if(r.error){t.innerHTML='<tr><td colspan=5>錯誤:'+r.error.message+'</td></tr>';return;}t.innerHTML=r.data.map(x=>`<tr><td>${x.email}</td><td>${x.display_name||''}</td><td><input type=checkbox ${x.is_admin?'checked':''} data-id='${x.id}' data-k='is_admin'></td><td><input type=checkbox ${x.is_suspended?'checked':''} data-id='${x.id}' data-k='is_suspended'></td><td><input type=checkbox ${x.is_paused?'checked':''} data-id='${x.id}' data-k='is_paused'></td></tr>`).join('');$$('#roleTable input[type=checkbox]').forEach(el=>el.onchange=async()=>{el.disabled=true;const{error}=await window.supa.from('profiles').update({[el.dataset.k]:el.checked}).eq('id',el.dataset.id);if(error)alert('更新失敗:'+error.message);el.disabled=false;});}
  loadUsers();loadRoles();
</script>
</body></html>












