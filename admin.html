<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin 主控台 · 白底三分頁 · v20251104</title>
  <style>
    :root{
      --accent:#0b6cff;
      --accent-weak:#e8f1ff;
      --ok:#1aa251;
      --bad:#e5484d;
      --muted:#64748b;
      --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#fff;color:#0f172a;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans TC',sans-serif;}
    header{position:sticky;top:0;background:#fff;z-index:10;border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{font-size:20px;margin:0 0 8px 0}
    .sub{color:var(--muted);font-size:13px}
    .tabs{display:flex;gap:8px;margin-top:12px}
    .tab{padding:10px 14px;border:1px solid var(--border);border-radius:999px;background:#fff;font-weight:600;cursor:pointer}
    .tab[aria-selected="true"]{background:var(--accent);border-color:var(--accent);color:#fff}
    main>.pane{display:none}
    main>.pane[aria-hidden="false"]{display:block}
    .card{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[type="text"],input[type="file"],select{border:1px solid var(--border);border-radius:8px;padding:8px 10px;font:inherit}
    button{border:1px solid var(--border);border-radius:10px;padding:8px 12px;background:#fff;font-weight:600;cursor:pointer}
    button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    button.ghost{background:#fff}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-top:1px solid var(--border);padding:10px;text-align:left;font-size:14px}
    th{font-size:12px;color:var(--muted);font-weight:700}
    .chip{display:inline-flex;align-items:center;gap:6px;font-size:12px;border-radius:999px;padding:4px 8px;border:1px solid var(--border);}
    .chip.ok{background:#ecfdf3;color:#065f46;border-color:#a7f3d0}
    .chip.warn{background:#fff7ed;color:#9a3412;border-color:#fed7aa}
    .chip.bad{background:#fef2f2;color:#991b1b;border-color:#fecaca}
    .chip.neu{background:#f8fafc;color:#475569}
    footer{border-top:1px solid var(--border);margin-top:20px;color:var(--muted);font-size:12px}
    .right{margin-left:auto}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .hint{color:var(--muted);font-size:12px}
    .hidden{display:none!important}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .danger{color:var(--bad)}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>BookWide Admin 主控台</h1>
      <div class="row">
        <div class="sub">顯示資料來自 <code class="mono">public.profiles</code> · 時間以台灣時區顯示（Asia/Taipei） · 每 10 分鐘內視為「在線」。</div>
        <div class="right" id="guardBadge"><span class="chip neu">正在驗證管理員身分…</span></div>
      </div>
      <div class="tabs" role="tablist" aria-label="主控台分頁">
        <button class="tab" role="tab" aria-controls="pane-users"      id="tab-users"      aria-selected="true">使用者清單</button>
        <button class="tab" role="tab" aria-controls="pane-roles"      id="tab-roles"      aria-selected="false">授權 / 暫停管理員</button>
        <button class="tab" role="tab" aria-controls="pane-mp4"        id="tab-mp4"        aria-selected="false">MP4 上傳自動化</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- 使用者清單 -->
    <section id="pane-users" class="pane" aria-hidden="false">
      <div class="card">
        <div class="toolbar">
          <input id="q" type="text" placeholder="搜尋 Email / 顯示名稱…" style="min-width:260px">
          <button id="btnRefresh" class="primary">重新整理</button>
          <span class="right hint">每次整理會即時讀取 <code class="mono">public.profiles</code> 與 <code class="mono">public.admins</code>。</span>
        </div>
        <table id="tbl">
          <thead>
            <tr>
              <th>Email</th>
              <th>顯示名稱</th>
              <th>最後登入（台灣）</th>
              <th>最近在線（台灣）</th>
              <th>管理員</th>
              <th>狀態</th>
              <th>到期日</th>
            </tr>
          </thead>
          <tbody><tr><td colspan="7" class="hint">載入中…</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- 授權 / 暫停管理員（簡化：只顯示、不寫入） -->
    <section id="pane-roles" class="pane" aria-hidden="true">
      <div class="card">
        <div class="toolbar">
          <div class="hint">此分頁顯示目前 <code class="mono">public.admins</code> 成員。實作寫入可再開放（避免誤操作）。</div>
          <button id="btnReloadAdmins" class="right">重新讀取</button>
        </div>
        <table id="tblAdmins">
          <thead><tr><th>Admin UUID</th><th>備註</th></tr></thead>
          <tbody><tr><td colspan="2" class="hint">載入中…</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- MP4 上傳自動化 -->
    <section id="pane-mp4" class="pane" aria-hidden="true">
      <div class="card">
        <div class="toolbar"><strong>MP4 上傳自動化</strong><span class="hint">會上傳至 Storage <code class="mono">videos</code>，路徑 <code class="mono">videos/{category}/{slug}.mp4</code>，封面 <code class="mono">assets/{category}/{slug}/cover.jpg</code></span></div>
        <div class="row" style="margin-top:8px">
          <label>分類
            <select id="vCategory">
              <option value="story">story</option>
              <option value="music">music</option>
              <option value="movie">movie</option>
              <option value="news">news</option>
              <option value="pro">pro</option>
            </select>
          </label>
          <label>Slug（檔名）<input id="vSlug" type="text" placeholder="ex: mid-autumn" /></label>
          <label>封面（可選）<input id="vCover" type="file" accept="image/*" /></label>
        </div>
        <div class="row" style="margin-top:8px">
          <label>MP4 檔 <input id="vFile" type="file" accept="video/mp4" /></label>
          <button id="btnUpload" class="primary">上傳</button>
          <span id="upMsg" class="hint"></span>
        </div>
        <ul class="hint" style="margin-top:10px">
          <li>需先於 Supabase Storage 建立 <code class="mono">videos</code> bucket，並允許 authenticated 上傳。</li>
          <li>上傳後會顯示公開 URL，可直接貼到你的資料 JSON。</li>
        </ul>
      </div>
    </section>

    <footer class="wrap sub">BookWide Admin · 內嵌 Supabase 版 · v20251104</footer>
  </main>

  <!-- === 內嵌 Supabase 初始化（請替換 URL 與 ANON KEY） ====================== -->
  <script type="module">
    /*****⚠️ 重要：把下面兩個常數改成你自己的 Supabase 專案設定 *****/
    const SUPABASE_URL = 'https://jeajrwpmrgczimmrflxo.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do';
    const supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
';
    /*******************************************************************/

    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // 建立 client（偵測 URL session for GitHub Pages）
    const supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });

    // ===== 小工具 =====
    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
    const tzTW = new Intl.DateTimeFormat('zh-TW', { timeZone:'Asia/Taipei', hour12:false,
      year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'});
    const fmt = (iso)=> iso ? tzTW.format(new Date(iso)) : '—';
    const within10m = (iso)=> !!iso && (Date.now() - new Date(iso).getTime()) <= 10*60*1000;

    // ====== Access Guard：需為 public.admins 成員 ======
    async function ensureAdmin(){
      const { data: { user } } = await supa.auth.getUser();
      if(!user){
        $('#guardBadge').innerHTML = '<span class="chip bad">拒絕訪問：請先登入</span>';
        blockAll('尚未登入，無法進入管理後台。');
        return false;
      }
      // 以 admins 表判定（避免依賴 SQL function）
      const { data, error } = await supa.from('admins').select('id').eq('id', user.id).maybeSingle();
      if(error){
        $('#guardBadge').innerHTML = '<span class="chip bad">連線錯誤</span>';
        blockAll('讀取 admins 失敗：'+(error?.message||error));
        return false;
      }
      if(!data){
        $('#guardBadge').innerHTML = '<span class="chip bad">拒絕訪問</span>';
        blockAll('你不是管理員。若需要權限，請把你的 UUID 加入 public.admins。');
        return false;
      }
      $('#guardBadge').innerHTML = '<span class="chip ok">已驗證管理員</span>';
      return true;
    }

    function blockAll(msg){
      document.querySelector('main').innerHTML = \`
        <div class="card" style="margin-top:16px">
          <h2 class="danger" style="margin:0 0 8px 0">拒絕訪問</h2>
          <p class="sub">\${msg}</p>
          <div class="row" style="margin-top:8px">
            <button id="btnSignOut">登出</button>
            <a class="tab" href="./index.html" style="text-decoration:none">回首頁</a>
          </div>
        </div>\`;
      $('#btnSignOut')?.addEventListener('click', ()=>supa.auth.signOut().then(()=>location.reload()));
    }

    // ====== 分頁切換 ======
    function setupTabs(){
      $$('.tab').forEach(btn=>btn.addEventListener('click',()=>{
        const id = btn.id.replace('tab-','pane-');
        $$('.tab').forEach(b=>b.setAttribute('aria-selected', String(b===btn)));
        $$('main .pane').forEach(p=>p.setAttribute('aria-hidden', String(p.id!==id)));
      }));
    }

    // ====== 使用者清單 ======
    async function loadUsers(){
      const q = $('#q').value.trim().toLowerCase();
      const tbody = $('#tbl tbody');
      tbody.innerHTML = '<tr><td colspan="7" class="hint">載入中…</td></tr>';

      // 讀 profiles + admins（前端組合）
      const [prof, admins] = await Promise.all([
        supa.from('profiles').select('id,email,display_name,last_sign_in_at,last_seen_at,expires_at').order('email',{ascending:true}),
        supa.from('admins').select('id')
      ]);

      if(prof.error){ tbody.innerHTML = '<tr><td colspan="7" class="danger">讀取失敗：'+prof.error.message+'</td></tr>'; return; }
      if(admins.error){ tbody.innerHTML = '<tr><td colspan="7" class="danger">讀取失敗：'+admins.error.message+'</td></tr>'; return; }

      const adminSet = new Set((admins.data||[]).map(x=>x.id));
      const rows = (prof.data||[]).filter(r=>{
        if(!q) return true;
        return (r.email||'').toLowerCase().includes(q) || (r.display_name||'').toLowerCase().includes(q);
      }).map(r=>{
        const online = within10m(r.last_seen_at);
        const isAdmin = adminSet.has(r.id);
        const statusChip = online ? '<span class="chip ok">在線</span>' : '<span class="chip neu">離線</span>';
        const adminChip = isAdmin ? '<span class="chip ok">是</span>' : '<span class="chip neu">否</span>';
        const stateChip = '<span class="chip ok">正常</span>';
        return \`<tr>
            <td>\${r.email||'—'}</td>
            <td>\${r.display_name||'—'}</td>
            <td>\${fmt(r.last_sign_in_at)}</td>
            <td>\${fmt(r.last_seen_at)} \${statusChip}</td>
            <td>\${adminChip}</td>
            <td>\${stateChip}</td>
            <td>\${r.expires_at || '—'}</td>
          </tr>\`;
      });

      tbody.innerHTML = rows.length? rows.join('') : '<tr><td colspan="7" class="hint">沒有符合的資料</td></tr>';
    }

    // ====== Admin 清單 ======
    async function loadAdmins(){
      const tbody = $('#tblAdmins tbody');
      tbody.innerHTML = '<tr><td colspan="2" class="hint">載入中…</td></tr>';
      const { data, error } = await supa.from('admins').select('id, note').order('id');
      if(error){ tbody.innerHTML = '<tr><td colspan="2" class="danger">讀取失敗：'+error.message+'</td></tr>'; return; }
      tbody.innerHTML = (data||[]).map(a=>\`<tr><td class="mono">\${a.id}</td><td>\${a.note||''}</td></tr>\`).join('') || '<tr><td colspan="2" class="hint">目前沒有成員</td></tr>';
    }

    // ====== MP4 上傳 ======
    async function uploadVideo(){
      const cat = $('#vCategory').value.trim();
      const slug = $('#vSlug').value.trim();
      const file = $('#vFile').files[0];
      const cover = $('#vCover').files[0];
      const msg = $('#upMsg');
      msg.textContent = '';

      if(!slug || !file){ msg.textContent = '請選擇 MP4 並填寫 slug。'; return; }

      const bucket = supa.storage.from('videos');
      const mp4Path = \`videos/\${cat}/\${slug}.mp4\`;
      msg.textContent = '上傳中…（MP4）';
      const up1 = await bucket.upload(mp4Path, file, { upsert:true, contentType:'video/mp4' });
      if(up1.error){ msg.textContent = '上傳失敗：'+up1.error.message; return; }

      let coverURL = '';
      if(cover){
        const coverPath = \`assets/\${cat}/\${slug}/cover.jpg\`;
        msg.textContent = '上傳中…（封面）';
        const up2 = await bucket.upload(coverPath, cover, { upsert:true, contentType: cover.type||'image/jpeg' });
        if(up2.error){ msg.textContent = '封面上傳失敗：'+up2.error.message; return; }
        const { data } = bucket.getPublicUrl(coverPath);
        coverURL = data.publicUrl;
      }

      const { data } = bucket.getPublicUrl(mp4Path);
      const mp4URL = data.publicUrl;

      msg.innerHTML = '完成！影片：<a href="'+mp4URL+'" target="_blank">'+mp4URL+'</a>' + (coverURL? ' · 封面：<a href="'+coverURL+'" target="_blank">'+coverURL+'</a>':'');
    }

    // ====== 事件 ======
    $('#btnRefresh').addEventListener('click', loadUsers);
    $('#q').addEventListener('input', ()=>{ loadUsers(); });
    $('#btnReloadAdmins').addEventListener('click', loadAdmins);
    $('#btnUpload').addEventListener('click', uploadVideo);

    setupTabs();

    // ====== 啟動：先驗證 admin，再載入面板 ======
    (async ()=>{
      const ok = await ensureAdmin();
      if(!ok) return;
      await Promise.all([loadUsers(), loadAdmins()]);
    })();
  </script>
</body>
</html>













