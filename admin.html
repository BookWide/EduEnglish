<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BookWide Admin 主控台</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <style>
    body{background:#0B1220;color:#e8eefc}
    header, .tabs{display:flex;align-items:center;gap:.75rem}
    header{justify-content:space-between;margin:14px 8px}
    .btn-back{display:inline-flex;align-items:center;gap:.5rem}
    .pill{background:#132038;border:1px solid #1d2a45;padding:.45rem .8rem;border-radius:999px}
    .tabs .active{background:#1f3a8a}
    .muted{color:#9db0d3}
    table thead th{color:#9db0d3}
    #uploadPane{display:none}
    .tag{border:1px solid #294472;background:#15223d;padding:.12rem .5rem;border-radius:.4rem}
    .ok{color:#5eead4}
    .no{color:#fda4af}
    .chip{font-size:.85rem;border:1px solid #2b3e66;border-radius:999px;padding:.1rem .5rem;background:#111c34}
    .nowrap{white-space:nowrap}
    .w-160{width:160px}
    .w-200{width:200px}
    .w-240{width:240px}
    .right{float:right}
  </style>

  <!-- 自行初始化 Supabase（不動 index.html） -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.45.4'

    // 你既有的 supabase URL / KEY（跟 supa.js 一致）
    const SUPABASE_URL = window.SUPABASE_URL || '<YOUR_SUPABASE_URL>'
    const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || '<YOUR_SUPABASE_ANON_KEY>'

    // 若外部已建立就不覆蓋；否則在此建立
    if (!window.supabase) {
      window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: { persistSession: true, autoRefreshToken: true }
      })
    }

    // ====== 一些小工具 ======
    const $ = (sel, parent=document) => parent.querySelector(sel)
    const $$ = (sel, parent=document) => [...parent.querySelectorAll(sel)]

    // ====== Admin 驗證（先看 URL 是否跳過）======
    async function ensureAdmin() {
      const p = new URLSearchParams(location.search)
      if (p.get('skipAdmin') === '1') return true

      const { data: u } = await supabase.auth.getUser()
      if (!u?.user) {
        alert('請先登入'); location.href = './index.html'; return false
      }

      // 先嘗試 RPC is_admin()
      let isAdmin = false
      try {
        const r = await supabase.rpc('is_admin')
        if (!r.error) isAdmin = !!r.data
      } catch(_) {}

      // 若沒 RPC，fallback 用 profiles 判斷
      if (!isAdmin) {
        const r2 = await supabase.from('profiles')
          .select('id,is_admin').eq('id', u.user.id).maybeSingle()
        if (r2.error) {
          console.warn('[admin check] fallback error', r2.error)
        }
        isAdmin = !!r2.data?.is_admin
      }

      if (!isAdmin) {
        alert('您沒有管理員權限'); location.href = './index.html'; return false
      }
      return true
    }

    // ====== UI：Tab 切換 ======
    function switchTab(target) {
      if (target === 'users') {
        $('#usersBtn').classList.add('active')
        $('#uploadBtn').classList.remove('active')
        $('#usersPane').style.display = ''
        $('#uploadPane').style.display = 'none'
      } else {
        $('#usersBtn').classList.remove('active')
        $('#uploadBtn').classList.add('active')
        $('#usersPane').style.display = 'none'
        $('#uploadPane').style.display = ''
      }
    }

    // ====== 載入使用者清單（只取存在欄位，避免 suspended 之類錯誤）======
    async function loadUsers(keyword='') {
      const q = supabase.from('profiles')
        .select('id,email,display_name,is_admin,last_sign_in_at,last_seen', { count: 'exact' })
        .order('last_sign_in_at', { ascending: false })
        .limit(200)

      let { data, error } = await q
      if (error) { $('#usersTbody').innerHTML =
          `<tr><td colspan="6" class="muted">讀取失敗：${error.message}</td></tr>`; return }

      if (keyword) {
        const k = keyword.toLowerCase()
        data = data.filter(r =>
          (r.email||'').toLowerCase().includes(k) ||
          (r.display_name||'').toLowerCase().includes(k)
        )
      }

      if (!data.length) {
        $('#usersTbody').innerHTML = `<tr><td colspan="6" class="muted">無資料</td></tr>`; return
      }

      $('#usersTbody').innerHTML = data.map(r => `
        <tr>
          <td class="w-240">${r.email ?? ''}</td>
          <td class="w-160">${r.display_name ?? ''}</td>
          <td class="w-200 nowrap">${fmt(r.last_sign_in_at)}</td>
          <td class="w-200 nowrap">${fmt(r.last_seen)}</td>
          <td><span class="chip">${r.is_admin ? '<span class="ok">管理員</span>' : '一般'}</span></td>
          <td>
            ${r.is_admin ? '<span class="tag">✔</span>' : '<span class="tag">—</span>'}
          </td>
        </tr>
      `).join('')
    }

    function fmt(ts) {
      if (!ts) return ''
      try {
        const d = new Date(ts)
        return d.toISOString().replace('T',' ').slice(0, 19) + ' +00:00'
      } catch { return ts }
    }

    // ====== MP4 上傳：先做 UI 與切頁（你要串 Storage 再補 handler）======
    function initUploader() {
      $('#filePick').addEventListener('change', () => {
        const f = $('#filePick').files?.[0]
        if (!f) return
        $('#uploadInfo').textContent = `已選擇：${f.name} (${(f.size/1024/1024).toFixed(2)} MB)`
      })

      $('#btnDoUpload').addEventListener('click', async () => {
        const f = $('#filePick').files?.[0]
        if (!f) { alert('請先選擇檔案'); return }
        // 這裡接你原本的上傳流程（Supabase Storage / Edge Function）
        alert('這裡接你的上傳流程（Storage / Edge Function）。先幫你把分頁與選檔接好。')
      })
    }

    // ====== 搜尋 ======
    function initSearch() {
      let t
      $('#keyword').addEventListener('input', e => {
        clearTimeout(t)
        t = setTimeout(() => loadUsers(e.target.value.trim()), 250)
      })
      $('#btnRefresh').addEventListener('click', () => loadUsers($('#keyword').value.trim()))
    }

    // ====== 回首頁（不登出）======
    function initBack() {
      $('#btnBack').addEventListener('click', () => location.href = './index.html')
    }

    // ====== 啟動 ======
    window.addEventListener('DOMContentLoaded', async () => {
      initBack()

      const ok = await ensureAdmin()
      if (!ok) return

      // Tabs
      $('#usersBtn').addEventListener('click', () => switchTab('users'))
      $('#uploadBtn').addEventListener('click', () => switchTab('upload'))
      switchTab('users')

      initSearch()
      initUploader()
      loadUsers()
    })
  </script>
</head>
<body>
  <header>
    <button class="btn-back pill" id="btnBack">← 回首頁</button>
    <div class="tabs">
      <button class="pill active" id="usersBtn">使用者清單</button>
      <button class="pill" id="uploadBtn">MP4 上傳自動化</button>
    </div>
    <span class="muted">單檔版 · 不動 index.html</span>
  </header>

  <!-- 使用者清單 -->
  <main id="usersPane" class="container">
    <div class="grid">
      <div>
        <input id="keyword" type="search" placeholder="搜尋 Email / 顯示名稱…" />
      </div>
      <div>
        <button id="btnRefresh" class="right">重新整理</button>
      </div>
    </div>

    <table role="grid">
      <thead>
        <tr>
          <th>Email</th>
          <th>顯示名稱</th>
          <th>最後登入（UTC）</th>
          <th>最近在線（UTC）</th>
          <th>身分</th>
          <th>管理員</th>
        </tr>
      </thead>
      <tbody id="usersTbody">
        <tr><td colspan="6" class="muted">載入中…</td></tr>
      </tbody>
    </table>
    <p class="muted">符合 RLS：僅管理員可查看所有人資料。</p>
  </main>

  <!-- MP4 上傳 -->
  <main id="uploadPane" class="container">
    <article>
      <header><strong>MP4 上傳自動化</strong></header>
      <p class="muted">先把分頁與按鈕接好；實際上傳可串 Supabase Storage 或 Edge Function。</p>
      <input type="file" id="filePick" accept="video/mp4" />
      <p id="uploadInfo" class="muted"></p>
      <button id="btnDoUpload">開始上傳</button>
    </article>
  </main>
</body>
</html>







