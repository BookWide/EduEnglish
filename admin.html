<!doctype html>
<html lang="zh-Hant">
<meta name="bw-fn-base" content="https://bookwide.functions.supabase.co/functions/v1">


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin · 三分頁 · v20251106-three-tabs-v3</title>
  <script type="module" src="./supa.js?v=20251109g"></script>
  <!-- 修正 UMD 連結空白 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <style>
    :root{ --bg:#fff; --fg:#111; --muted:#6b7280; --line:#e5e7eb; --brand:#2563eb; --ok:#16a34a; --warn:#f59e0b; --card:#fafafa;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"PingFang TC","Noto Sans TC","微軟正黑體",sans-serif}
    header{padding:18px 20px;border-bottom:1px solid var(--line);display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .title{font-size:22px;font-weight:700;margin-right:auto}
    .chip{padding:.35rem .6rem;border-radius:999px;background:#eef2ff;color:#1d4ed8;font-size:12px}
    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab-btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:.5rem 1rem;cursor:pointer}
    .tab-btn.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    .wrap{max-width:1100px;margin:22px auto;padding:0 16px}
    .row{display:grid;gap:14px}
    .grid-2{grid-template-columns: 1fr 1fr}
    @media (max-width:1100px){ .grid-2{grid-template-columns:1fr} }
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px}
    .input, select, textarea{border:1px solid var(--line);border-radius:10px;padding:.6rem .8rem;background:#fff}
    textarea{height:240px;resize:vertical;white-space:pre-wrap;overflow:auto}
    .btn{border:1px solid var(--brand);background:var(--brand);color:#fff;border-radius:10px;padding:.55rem .9rem;cursor:pointer}
    .btn.outline{background:#fff;color:var(--brand)}
    .hint{color:#6b7280;font-size:13px}
    .progress{height:10px;background:#eef2ff;border-radius:99px;overflow:hidden}
    .bar{height:100%;width:0;background:#2563eb;transition:width .2s}
    .pill{display:inline-block;padding:.2rem .5rem;border-radius:999px;border:1px solid var(--line);font-size:12px}
    .pill.ok{color:#16a34a;border-color:#16a34a} .pill.warn{color:#f59e0b;border-color:#f59e0b}
    /* Accordion */
    .acc{border:1px solid var(--line);border-radius:12px;background:#f8fafc}
    .acc .hd{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;cursor:pointer;user-select:none}
    .acc .hd h4{margin:0;font-size:14px}
    .acc .bd{padding:12px;display:block}
    .acc.collapsed .bd{display:none}
    .chev{width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:7px solid #6b7280;transition:transform .2s}
    .acc.collapsed .chev{transform:rotate(-90deg)}
    .stack{display:grid;gap:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0 12px}
    .table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
    .table th,.table td{padding:.7rem .8rem;border-bottom:1px solid var(--line);text-align:left}
    .table th{background:var(--card);font-weight:600}
    .right{display:flex;gap:10px;align-items:center;justify-content:flex-end}
  
/* === Bigger, resizable JSON preview areas === */
.json-preview{
  width:100%;
  height:420px;
  resize:vertical;
  overflow:auto;
  white-space:pre;
  font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
  background:#ffffff;
  color:#111111;
  border:1px solid #cbd5e1;
  border-radius:10px;
  padding:12px;
  line-height:1.5;
}

/* Stretch containers of preview areas */
#panelCues, #panelVocab, #panelAI, #panelQuiz, #panelIndex {
  width:100%;
}

</style>
</head>
<body>
  <header>
    <div class="title">BookWide Admin 主控台</div>
    <span class="chip">三分頁 · 內嵌 Supabase · v20251106</span>
    <nav class="tabs">
      <button class="tab-btn active" data-tab="users">使用者清單</button>
      <button class="tab-btn" data-tab="roles">授權 / 暫停管理員</button>
      <button class="tab-btn" data-tab="mp4">MP4 上傳</button>
    </nav>
  </header>

  <main class="wrap">
    <!-- 使用者清單 -->
    <section id="panel-users">
      <div class="toolbar">
        <input id="q" class="input" style="min-width:260px" placeholder="搜尋 Email / 顯示名稱…" />
        <button id="btnRefresh" class="btn outline">重新整理</button>
        <span class="hint">資料表：public.profiles · 台灣時區顯示 · 10 分鐘內視為「在線」。</span>
      </div>
      <table class="table" id="usersTable">
        <thead><tr><th>Email</th><th>顯示名稱</th><th>最後登入</th><th>最近在線</th><th>管理員</th><th>狀態</th><th>到期日</th></tr></thead>
        <tbody><tr><td colspan="7" class="hint">載入中…</td></tr></tbody>
      </table>
    </section>

    <!-- 權限管理 -->
    <section id="panel-roles" style="display:none">
      <div class="card">
        <div class="row grid-2">
          <div><label class="hint">Email</label><input id="roleEmail" class="input" placeholder="user@example.com"></div>
          <div>
            <label class="hint">動作</label>
            <select id="roleAction" class="input">
              <option value="grant-admin">授予管理員</option>
              <option value="revoke-admin">移除管理員</option>
              <option value="pause">暫停登入</option>
              <option value="unpause">解除暫停</option>
            </select>
          </div>
        </div>
        <div class="right" style="margin-top:10px"><button id="btnApplyRole" class="btn">套用</button></div>
        <div class="hint" style="margin-top:6px">更新欄位：<code>is_admin</code> / <code>is_paused</code></div>
        <div id="roleMsg" class="hint" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- MP4 上傳 -->
    <section id="panel-mp4" style="display:none">
      <div class="row grid-2">
        <!-- 左：表單 + 預覽 -->
        <div class="card">
          <h3 style="margin:6px 0 14px">MP4 上傳自動化（含字幕匯入、JSON 預覽）</h3>

          <div class="row grid-2">
            <div>
              <label class="hint">分類</label>
              <select id="cat" class="input"><option>story</option><option selected>music</option><option>movie</option><option>news</option><option>pro</option></select>
            </div>
            <div><label class="hint">Slug</label><input id="slug" class="input" placeholder="applesong"></div>
          </div>

          <div class="row grid-2" style="margin-top:8px">
            <div><label class="hint">顯示標題（可空）</label><input id="title" class="input" placeholder="A Little Love"></div>
            <div><label class="hint">吸附窗（s）</label><input id="snapWin" class="input" type="number" step="0.05" value="0.25"></div>
          </div>

          <div class="row grid-2" style="margin-top:8px">
            <div><label class="hint">MP4 檔</label><input id="mp4File" type="file" accept="video/mp4" class="input"></div>
            <div><label class="hint">封面（建議 JPG）</label><input id="coverFile" type="file" accept="image/*" class="input"></div>
          </div>
          <div style="margin-top:8px"><label class="hint">字幕（.txt / .srt / .vtt / .json）</label><input id="subFile" type="file" accept=".txt,.srt,.vtt,.json" class="input" style="width:100%"></div>

          <div class="row grid-2" style="margin-top:10px">
            <div>
              <label class="hint">中/日 產生模式</label>
              <div style="display:flex;gap:12px;align-items:center;margin-top:6px">
                <label style="display:flex;gap:6px;align-items:center"><input id="modeSimple" type="radio" name="mtmode" checked> 簡易（只產生 en）</label>
                <label style="display:flex;gap:6px;align-items:center"><input id="modeMT" type="radio" name="mtmode"> 機翻（透過 Edge Function）</label>
              </div>
            </div>
            <div>
              <label class="hint">Edge Function 名稱（預設 mt-translate）</label>
              <input id="edgeFn" class="input" placeholder="mt-translate" value="mt-translate">
              <div class="hint" style="margin-top:6px">Functions 連線：<code id="fnBase">未偵測</code>　<button class="btn outline" id="btnTestFn" style="padding:.25rem .6rem">測試</button> <span id="fnMsg" class="hint"></span></div>
            </div>
          </div>

          <div class="right" style="margin-top:10px;gap:8px">
            <button class="btn outline" id="btnCollapseAll">全部收合</button>
            <button class="btn outline" id="btnExpandAll">全部展開</button>
            <button class="btn" id="btnPreview">預覽 JSON（5 件）</button>
          </div>

          <div class="stack" style="margin-top:10px">
            <div class="acc" id="accIndex">
              <div class="hd"><h4>index-<span id="fnSlug1">slug</span>.json（影片資訊）</h4><div class="chev"></div></div>
              <div class="bd"><textarea id="boxIndex" class="json-preview" placeholder="index-<slug>.json 預覽"></textarea></div>
            </div>
            <div class="acc" id="accCues">
              <div class="hd"><h4>cues-<span id="fnSlug2">slug</span>.json（三語字幕）</h4><div class="chev"></div></div>
              <div class="bd"><textarea id="boxCues" placeholder="cues-*.json" class="json-preview"></textarea></div>
            </div>
            <div class="acc" id="accQuiz">
              <div class="hd"><h4>quiz-<span id="fnSlug3">slug</span>.json（80 題）</h4><div class="chev"></div></div>
              <div class="bd"><textarea id="boxQuiz" placeholder="quiz-*.json" class="json-preview"></textarea></div>
            </div>
            <div class="acc" id="accVocab">
              <div class="hd"><h4>vocab-<span id="fnSlug4">slug</span>.json（20 詞：英/中/日/定義/例句）</h4><div class="chev"></div></div>
              <div class="bd"><textarea id="boxVocab" placeholder="vocab-*.json" class="json-preview"></textarea></div>
            </div>
            <div class="acc" id="accAI">
              <div class="hd"><h4>ai-<span id="fnSlug5">slug</span>.json（AI 問答模板 15 題）</h4><div class="chev"></div></div>
              <div class="bd"><textarea id="boxAI" placeholder="ai-*.json" class="json-preview"></textarea></div>
            </div>
          </div>

          <div class="hint" style="margin-top:10px">字幕：.txt 視為「每行一句」；.srt/.vtt 會解析時間。三語同檔格式：<code>[{ time, en, ja, zh }]</code>。</div>
        </div>

        <!-- 右：Supabase / GitHub -->
        <div class="card">
          <h3 style="margin:6px 0 14px">Supabase 上傳（影片＋封面）</h3>
          <div class="row grid-2">
            <div><label class="hint">Supabase URL（可空）</label><input id="sbUrl" class="input" placeholder="https://xxxx.supabase.co"></div>
            <div><label class="hint">Supabase anon key（可空）</label><input id="sbKey" class="input" placeholder="ey..."></div>
          </div>
          <div class="row grid-2">
            <div><label class="hint">影片桶名</label><input id="bucketVideo" class="input" value="videos"></div>
            <div><label class="hint">封面桶名</label><input id="bucketAsset" class="input" value="assets"></div>
          </div>
          <div class="right" style="margin-top:6px"><button class="btn" id="btnSupaUpload">上傳到 Supabase（影片＋封面）</button></div>
          <pre id="supaStatus" class="hint" style="background:#0b10221a;padding:10px;border-radius:8px;margin-top:8px;white-space:pre-wrap"></pre>
          <div class="progress" style="margin-top:6px"><div id="supaBar2" class="bar"></div></div>
          <div id="supaPct2" class="hint" style="margin-top:4px">0%</div>

          <div style="margin:16px 0;height:1px;background:var(--line)"></div>

          <h3 style="margin:6px 0 10px">GitHub 上傳（5 件 JSON）</h3>
          <div class="row grid-2">
            <div><label class="hint">Owner</label><input id="ghOwner" class="input" value="bookwide"></div>
            <div><label class="hint">Repo</label><input id="ghRepo" class="input" value="EduEnglish"></div>
          </div>
          <div class="row grid-2">
            <div><label class="hint">Branch</label><input id="ghBranch" class="input" value="main"></div>
            <div><label class="hint">Base Path（例：data/）</label><input id="ghBase" class="input" value="data/"></div>
          </div>
          <div class="row grid-2">
            <div><label class="hint">Commit 訊息</label><input id="ghMsg" class="input" value="Add JSON templates"></div>
            <div><label class="hint">GitHub Token（Classic PAT）</label><input id="ghTok" class="input" placeholder="ghp_xxx"></div>
          </div>
          <div class="right" style="margin-top:6px"><button class="btn" id="btnUploadGithub">上傳到 GitHub（5 件）</button></div>
          <pre id="ghStatus" class="hint" style="background:#0b10221a;padding:10px;border-radius:8px;margin-top:8px;white-space:pre-wrap"></pre>
          <div class="progress" style="margin-top:6px"><div id="ghBar2" class="bar"></div></div>
          <div id="ghPct2" class="hint" style="margin-top:4px">0%</div>
        </div>
      </div>
    </section>
  </main>

  <footer style="padding:22px 20px;border-top:1px solid var(--line);text-align:center;color:#6b7280">BookWide Admin · v20251106-three-tabs-v3</footer>

  <!-- 主邏輯（已改：測試 payload、預覽用批次機翻、移除 translateBatch） -->
  <script type="module">
    const ready = () => new Promise(r=>{ if (window.BW && window.BW.supa) return r(); const t=setInterval(()=>{ if(window.BW && window.BW.supa){clearInterval(t); r();}},50)});
    await ready();
    await BW.requireAdmin();
    BW.startHeartbeat(2);

    const supa = BW.supa;
    const $ = (q,root=document)=>root.querySelector(q);
    const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));
    const fmtTW = ts => !ts?'':new Date(ts).toLocaleString('zh-TW',{timeZone:'Asia/Taipei',hour12:false});
    const pill = (ok,t,cls)=>{ t=(t!==undefined)?t:(ok?'在線':'離線'); cls=cls||(ok?'pill ok':'pill'); return '<span class="'+cls+'">'+t+'</span>'; };

    // Tabs
    $$('.tab-btn').forEach(b=>b.addEventListener('click',()=>{
      $$('.tab-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active');
      const t=b.getAttribute('data-tab');
      $('#panel-users').style.display = (t==='users')?'':'none';
      $('#panel-roles').style.display = (t==='roles')?'':'none';
      $('#panel-mp4').style.display   = (t==='mp4')  ?'':'none';
    }));

    // Users
    async function loadProfiles(){
      const tbody = $('#usersTable tbody'); tbody.innerHTML='<tr><td class="hint" colspan="7">載入中…</td></tr>';
      const cols='email, display_name, is_admin, is_paused, last_sign_in_at, last_seen_at, expires_at';
      const r=await supa.from('profiles').select(cols).order('email',{ascending:true});
      if(r.error){ tbody.innerHTML='<tr><td class="hint" colspan="7">讀取失敗：'+r.error.message+'</td></tr>'; return; }
      const q = ($('#q').value||'').trim().toLowerCase();
      const rows=(r.data||[]).filter(x=> !q || ( (x.email||'').toLowerCase().includes(q) || (x.display_name||'').toLowerCase().includes(q) ));
      if(!rows.length){ tbody.innerHTML='<tr><td class="hint" colspan="7">沒有符合的資料</td></tr>'; return; }
      tbody.innerHTML=rows.map(x=>{
        const online = BW.isOnlineWithin(x.last_seen_at, 10);
        const status = x.is_paused ? '<span class="pill warn">暫停</span>' : '<span class="pill ok">正常</span>';
        return '<tr>'
          + '<td>'+(x.email||'')+'</td>'
          + '<td>'+(x.display_name||'')+'</td>'
          + '<td>'+(fmtTW(x.last_sign_in_at)||'')+'</td>'
          + '<td>'+(fmtTW(x.last_seen_at)||'')+' &nbsp; '+pill(online)+'</td>'
          + '<td>'+(x.is_admin?'<span class="pill ok">是</span>':'<span class="pill">否</span>')+'</td>'
          + '<td>'+status+'</td>'
          + '<td>'+(x.expires_at||'')+'</td>'
          + '</tr>';
      }).join('');
    }
    $('#btnRefresh').addEventListener('click',loadProfiles);
    $('#q').addEventListener('input',loadProfiles);
    loadProfiles();

    // ========== MP4 分頁輔助 ==========

    const qs=(s,r)=> (r||document).querySelector(s);
    const qsa=(s,r)=> Array.from((r||document).querySelectorAll(s));
    const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
    const b64=(s)=>btoa(unescape(encodeURIComponent(s)));

    // Accordion
    qsa('.acc .hd').forEach(hd=>{
      hd.addEventListener('click',()=> hd.parentElement.classList.toggle('collapsed'));
    });
    qs('#btnCollapseAll')?.addEventListener('click',()=> qsa('.acc').forEach(a=>a.classList.add('collapsed')));
    qs('#btnExpandAll')?.addEventListener('click',()=> qsa('.acc').forEach(a=>a.classList.remove('collapsed')));

    // Functions base
    function computeFnBase(){
      let url = (window.BW?.url) || qs('#sbUrl')?.value || '';
      if(!url && window.BW?.supa?.url) url = window.BW.supa.url;
      let base='';
      try{ const u=new URL(url); base=`${u.protocol}//${u.host.replace('.supabase.co','.functions.supabase.co')}`; }catch(e){}
      qs('#fnBase').textContent = base || '未偵測';
      return base;
    }
    computeFnBase();
    qs('#sbUrl')?.addEventListener('input', computeFnBase);

    async function callEdge(fn, payload){
      const base = computeFnBase();
      if(!base){ throw new Error('未偵測到 Supabase Functions 端點'); }
      const url = `${base}/${fn}`;
      const headers={'Content-Type':'application/json'};
      try{
        const s = await window.BW?.auth?.getSession?.();
        const jwt = s?.session?.access_token;
        if(jwt) headers['Authorization'] = `Bearer ${jwt}`;
      }catch(e){}
      const r=await fetch(url,{method:'POST',headers,body:JSON.stringify(payload)});
      if(!r.ok){ const t=await r.text(); throw new Error(`Functions HTTP ${r.status} – ${t}`); }
      return await r.json();
    }

    function setSlugLabels(slug){
      ['fnSlug1','fnSlug2','fnSlug3','fnSlug4','fnSlug5'].forEach(id=>{ const el=qs('#'+id); if(el) el.textContent=slug||'slug'; });
    }

    function mmss(i, step=4){ const s=i*step; const m=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${m}:${ss}`; }

    async function parseSubtitleFile(file){
      if(!file) return [];
      const name=file.name.toLowerCase();
      const text=await file.text();
      if(name.endsWith('.json')){
        try{ const arr=JSON.parse(text); if(Array.isArray(arr)&&arr.length&&('time' in arr[0])) return arr.map(x=>({time:x.time,en:x.en||'',ja:x.ja||'',zh:x.zh||''})); }catch(e){}
      }
      if(name.endsWith('.srt')||name.endsWith('.vtt')){
        const lines=text.replace(/\r/g,'').split('\n');
        const out=[]; let cur=null;
        const timeRe=/(\d\d:\d\d:\d\d)[,\.](\d\d\d)\s*-->\s*(\d\d:\d\d:\d\d)[,\.](\d\d\d)/;
        for(const ln of lines){
          const m=timeRe.exec(ln);
          if(m){ cur={time:m[1].slice(0,5), en:''}; continue; }
          if(!ln.trim()){ if(cur){ out.push({...cur,ja:'',zh:''}); cur=null; } }
          else if(cur){ cur.en = (cur.en?cur.en+' ':'') + ln.trim(); }
        }
        if(cur) out.push({...cur,ja:'',zh:''});
        return out;
      }
      const arr=text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      return arr.map((line,i)=>({ time:mmss(i), en:line, ja:'', zh:'' }));
    }

    function tokenizeEn(s){ return (s||'').toLowerCase().replace(/[^a-z0-9' ]/g,' ').split(/\s+/).filter(Boolean); }
    const STOP=new Set(['the','a','an','to','is','are','am','be','and','or','of','in','on','for','with','that','this','it','as','at','by','from','i','you','he','she','we','they','was','were','been','do','did','does','so','but','if','not','no','yes','me','my','your','our','their']);
    function topWords(cues,n=40){
      const freq=new Map();
      for(const c of cues){ for(const w of tokenizeEn(c.en)){ if(w.length<3||STOP.has(w)) continue; freq.set(w,(freq.get(w)||0)+1); } }
      return Array.from(freq.entries()).sort((a,b)=>b[1]-a[1]).slice(0,n).map(x=>x[0]);
    }
    function buildVocabFromCues(cues){
      const keys=topWords(cues,40);
      const set=new Set(); const out=[];
      for(const k of keys){
        if(set.has(k)) continue; set.add(k);
        const sample=(cues.find(c=>c.en.toLowerCase().includes(k))?.en)||(`I use "${k}" in a sentence.`);
        out.push({ en:k, zh:"", ja:"", def_en:"", example_en: sample });
        if(out.length>=20) break;
      }
      return out;
    }

    // 「測試」按鈕：改用 {lines:[...]}
    qs('#btnTestFn')?.addEventListener('click', async ()=>{
      const msg=qs('#fnMsg'); msg.textContent='測試中…';
      try{
        const fn=(qs('#edgeFn').value||'mt-translate').trim();
        const j=await callEdge(fn,{ lines: ['Hello world'] });
        msg.textContent = j?.ok ? ('OK：'+(j.result || 'Edge 連線成功')) : '失敗';
      }catch(e){ msg.textContent='失敗：'+(e.message||e); }
    });

    // 預覽 JSON：改一次送陣列到 Edge 取得 zh/ja
    qs('#btnPreview')?.addEventListener('click', async ()=>{
      const cat=qs('#cat').value.trim(), slug=qs('#slug').value.trim(), title=qs('#title').value.trim();
      setSlugLabels(slug);
      const sub=qs('#subFile').files[0];
      const cuesEN=await parseSubtitleFile(sub);
      let zhArr=[], jaArr=[];

      if(qs('#modeMT').checked && cuesEN.length){
        const enArr=cuesEN.map(x=>x.en);
        try{
          // 利用末段 helper：translateViaEdge（一次回 zh/ja）
          const { zh, ja } = await translateViaEdge(enArr);
          zhArr = zh; jaArr = ja;
        }catch(e){ qs('#fnMsg').textContent='機翻失敗：'+(e.message||e); }
      }

      // 20 詞彙
      const vocab20 = buildVocabFromCues(cuesEN).map(v=>({ ...v, zh:'', ja:'' }));

      const index = { slug, title, video:`videos/${cat}/${slug}.mp4`, cover:`assets/${cat}/${slug}.cover.jpg`, category:cat, updatedAt:new Date().toISOString() };
      const topics = Array.from({length:20},(_,i)=>({title:`Topic ${i+1}`,prompt:"",hint:"",sample:""}));
      const quiz = { title:"Lesson", topics };
      const cues = cuesEN.map((x,i)=>({...x, zh: zhArr[i]||x.zh||'', ja: jaArr[i]||x.ja||'' }));
      const ai = { tasks: Array.from({length:15},(_,i)=>({q:`Question ${i+1}`,a:""})) };

      qs('#boxIndex').value = JSON.stringify(index, null, 2);
      qs('#boxCues').value  = JSON.stringify(cues,  null, 2);
      qs('#boxQuiz').value  = JSON.stringify(quiz,  null, 2);
      qs('#boxVocab').value = JSON.stringify({words:vocab20}, null, 2);
      qs('#boxAI').value    = JSON.stringify(ai,    null, 2);
    });

    // Supabase upload
    function getClient(){
      if(window.BW?.supa?.createClient) return window.BW.supa.createClient();
      const url=qs('#sbUrl').value.trim(); const key=qs('#sbKey').value.trim();
      if(!url || !key) return null;
      return supabase.createClient(url,key);
    }
    async function supaUpload(bucket, path, file, client){
      const { error } = await client.storage.from(bucket).upload(path, file, { upsert:true, contentType:file.type||undefined });
      if(error) throw error;
      const { data:pub } = client.storage.from(bucket).getPublicUrl(path);
      return pub.publicUrl;
    }
    function setProgress(bar,pct,p){ p=Math.max(0,Math.min(100,Math.round(p))); if(bar) bar.style.width=p+'%'; if(pct) pct.textContent=p+'%'; }
    const supaBar=qs('#supaBar2'), supaPct=qs('#supaPct2');
    qs('#btnSupaUpload')?.addEventListener('click', async ()=>{
      const st=qs('#supaStatus'); st.textContent='';
      const cat=qs('#cat').value.trim(), slug=qs('#slug').value.trim();
      const mp4=qs('#mp4File').files[0], cover=qs('#coverFile').files[0];
      if(!mp4){ st.textContent='[錯誤] 請先選擇 MP4 檔。'; return; }
      const c=getClient(); if(!c){ st.textContent='[錯誤] 找不到 Supabase 連線（BW.supa 或手動 URL/KEY）。'; return; }
      const vBucket=qs('#bucketVideo').value.trim()||'videos', aBucket=qs('#bucketAsset').value.trim()||'assets';
      try{
        setProgress(supaBar,supaPct,10); st.textContent+='[1/2] 上傳影片中...\n';
        const vUrl=await supaUpload(vBucket, `${cat}/${slug}.mp4`, mp4, c);
        st.textContent+=`    影片 URL → ${vUrl}\n`; setProgress(supaBar,supaPct,70);
        let cUrl=''; if(cover){ st.textContent+='[2/2] 上傳封面中...\n'; cUrl=await supaUpload(aBucket, `${cat}/${slug}/cover.jpg`, cover, c); st.textContent+=`    封面 URL → ${cUrl}\n`; } else { st.textContent+='[2/2] 未選封面，略過。\n'; }
        setProgress(supaBar,supaPct,100);
        if(qs('#boxIndex').value){ try{ const idx=JSON.parse(qs('#boxIndex').value); if(vUrl) idx.video=vUrl; if(cUrl) idx.cover=cUrl; qs('#boxIndex').value=JSON.stringify(idx,null,2);}catch(e){} }
        st.textContent+='完成。';
      }catch(e){ st.textContent+=`[失敗] ${e.message||e}`; setProgress(supaBar,supaPct,0); }
    });

    // GitHub upload
    // === GitHub folder helpers (auto-create) ===
function encodePath(p){ return String(p).split('/').filter(Boolean).map(encodeURIComponent).join('/'); }

async function ghExists({owner,repo,branch,token,path}){
  const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(path)}?ref=${encodeURIComponent(branch)}`;
  const r = await fetch(url, { headers:{ 'Authorization': `Bearer ${token}`, 'Accept':'application/vnd.github+json', 'X-GitHub-Api-Version':'2022-11-28' } });
  return r.ok;
}

async function ensureFoldersExist(owner,repo,branch,token,dirPath){
  const parts = String(dirPath).split('/').filter(Boolean);
  let curr = '';
  for (const p of parts){
    curr = curr ? `${curr}/${p}` : p;
    if (!(await ghExists({owner,repo,branch,token,path:curr}))){
      await ghPut({ owner,repo,branch,token, path: `${curr}/.keep`, content: 'keep', message: `init ${curr}` });
    }
  }
}

async function ghPut({owner,repo,branch,token,path,content,message}){
  // 先嘗試取得舊檔 sha（若不存在會是 null）
  let sha = null;
  try{
    const getUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(path)}?ref=${encodeURIComponent(branch)}`;
    const r1 = await fetch(getUrl, { headers:{
      'Authorization': `Bearer ${token}`,
      'Accept': 'application/vnd.github+json',
      'X-GitHub-Api-Version':'2022-11-28'
    }});
    if (r1.ok){
      const j = await r1.json();
      sha = j && j.sha || null;
    }
  }catch(_){}

  const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(path)}`;
  const body = { message, branch, content: btoa(unescape(encodeURIComponent(content))) };
  if (sha) body.sha = sha;

  const r = await fetch(url, {
    method:'PUT',
    headers:{
      'Authorization': `Bearer ${token}`,
      'Accept': 'application/vnd.github+json',
      'Content-Type':'application/json',
      'X-GitHub-Api-Version':'2022-11-28'
    },
    body: JSON.stringify(body)
  });
  if (!r.ok){
    const t = await r.text();
    throw new Error(`HTTP ${r.status} – ${t}`);
  }
  return await r.json();
}function parseBox(id){ try{ return JSON.parse(qs(id).value||''); }catch(e){ return null; } }
    function validateAll(st){
      const index=parseBox('#boxIndex'), cues=parseBox('#boxCues'), quiz=parseBox('#boxQuiz'), vocab=parseBox('#boxVocab'), ai=parseBox('#boxAI');
      if(!index||!cues||!quiz||!vocab||!ai){ st.textContent='[錯誤] 五份 JSON 需全部產生（請先按「預覽 JSON」）'; return false; }
      return true;
    }
    const ghBar=qs('#ghBar2'), ghPct=qs('#ghPct2');
    qs('#btnUploadGithub')?.addEventListener('click', async ()=>{
      const st=qs('#ghStatus'); st.textContent='';
      if(!validateAll(st)){ setProgress(ghBar,ghPct,0); return; }
      const owner=qs('#ghOwner').value.trim(), repo=qs('#ghRepo').value.trim(), branch=qs('#ghBranch').value.trim(), base=(qs('#ghBase').value||'').trim(), token=qs('#ghTok').value.trim();
      const msg=qs('#ghMsg').value.trim()||'Add JSON';
      if(!owner||!repo||!branch||!token){ st.textContent='[錯誤] 請填 owner / repo / branch / token'; return; }
      const slugVal=qs('#slug').value.trim(); if(!slugVal){ st.textContent='[錯誤] Slug 不可空（請在左側填寫 slug 並重新產生 JSON）'; return; }
      const cat=qs('#cat').value.trim(), slug=qs('#slug').value.trim();
      const root = (base ? base.replace(/\/$/,'') : 'data') + `/${cat}/${slug}`;
      await ensureFoldersExist(owner, repo, branch, token, root);
      const files=[
        {name:`${root}/index-${slug}.json`, data:qs('#boxIndex').value},
        {name:`${root}/cues-${slug}.json`,  data:qs('#boxCues').value},
        {name:`${root}/quiz-${slug}.json`,  data:qs('#boxQuiz').value},
        {name:`${root}/vocab-${slug}.json`, data:qs('#boxVocab').value},
        {name:`${root}/ai-${slug}.json`,    data:qs('#boxAI').value},
      ];
      let i=0;
      try{
        for(const f of files){ i++; st.textContent+=`[${i}/5] 上傳 ${f.name}...\n`; await ghPut({owner,repo,branch,token,path:f.name,content:f.data,message:msg}); ghBar.style.width=`${Math.round(i/5*100)}%`; ghPct.textContent=`${Math.round(i/5*100)}%`; await sleep(150); }
        st.textContent+='完成。';
      }catch(e){ st.textContent+=`[失敗] ${e.message||e}`; ghBar.style.width='0%'; ghPct.textContent='0%'; }
    });
  </script>

  <!-- 批次機翻 Helper（保留；被預覽流程呼叫） -->
  <script>
    
  /** 你的 function 端點（維持你專案的實際 URL） */
  const EDGE_URL = "https://jeajrwpmrgczimmrflxo.functions.supabase.co/functions/v1/mt-translate";

  /** 呼叫 Edge Function：輸入英文陣列 -> 回傳 { zh:[], ja:[] } */
  async function translateViaEdge(enLines) {
    const res = await fetch(EDGE_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Accept": "application/json"            // ←① 新增這行
      },
      body: JSON.stringify({
        lines: enLines,
        to: ["zh", "ja"]                         // ←② 新增這行（一定要有）
      })
    });
    const json = await res.json();
    if (!json.ok) throw new Error(json.error || "Edge translation failed");
    // 你的 Edge 目前回傳 results 陣列；這裡轉成 { zh:[], ja:[] } 方便後面使用
    const zh = (json.results?.find(r => r.lang === "zh")?.lines) || [];
    const ja = (json.results?.find(r => r.lang === "ja")?.lines) || [];
    return { zh, ja };
  }
</script>

<!-- BW Single-Edge Final v20251108: force single mt-translate -->
<script>
(function(){
  window.MT_FN = 'mt-translate';

  const _origCallEdge = typeof window.callEdge === 'function' ? window.callEdge : null;
  if (_origCallEdge && !_origCallEdge.__bwWrapped) {
    const wrapped = async function(fn, payload){
      try { return await _origCallEdge(window.MT_FN, payload); }
      catch (e) { throw e; }
    };
    wrapped.__bwWrapped = true;
    window.callEdge = wrapped;
  }

  window.BW_EDGE = window.BW_EDGE || {};
  if (typeof window.BW_EDGE.translate !== 'function') {
    window.BW_EDGE.translate = async function(lines, to){
      if (typeof window.callEdge === 'function') {
        return await window.callEdge(window.MT_FN, { lines: Array.isArray(lines)?lines:[], to: to||['zh','ja'] });
      }
      const meta = document.querySelector('meta[name="bw-fn-base"]');
      let base = meta && meta.content ? meta.content.trim() : '';
      if (!base) {
        try {
          const url = (window.BW && window.BW.supa && window.BW.supa.url) || '';
          if (url) {
            const u = new URL(url);
            base = u.protocol + '//' + u.host.replace('.supabase.co', '.functions.supabase.co') + '/functions/v1';
          }
        } catch(e){}
      }
      if (!base) throw new Error('未偵測到 Functions 端點，請在 <head> 放入 <meta name="bw-fn-base" content="https://.../functions/v1">');
      const url = base.replace(/\/+$/,'') + '/' + window.MT_FN;
      const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ lines: Array.isArray(lines)?lines:[], to: to||['zh','ja'] }) });
      const j = await res.json().catch(()=>({}));
      if (!res.ok) throw new Error('Edge 失敗：' + (j?.error?.message || j?.message || res.status));
      return j;
    };
  }

  console.info('[BW Single-Edge v20251108] Ready →', window.MT_FN);
})();
</script>

  <script type="module">
/* ---------------------------------------------------------
 * BookWide Admin – 自動產生五份 JSON（含 OpenAI 機翻）
 * 版本：v2025-11-10-mt-final
 * 只依賴你的 Edge Function: /functions/v1/mt-translate
 * --------------------------------------------------------- */

const MT_URL = "https://jeajrwpmrgczimmrflxo.functions.supabase.co/functions/v1/mt-translate";
/* 你可以保留上面這行或改成從輸入框讀取 */

const ui = {
  // 你現有的 textarea / 輸出容器，若 id 不同可自行改名
  cues:   document.querySelector('#out-cues')    || document.querySelector('[data-name="cues"]'),
  vocab:  document.querySelector('#out-vocab')   || document.querySelector('[data-name="vocab"]'),
  quiz:   document.querySelector('#out-quiz')    || document.querySelector('[data-name="quiz"]'),
  ai:     document.querySelector('#out-ai')      || document.querySelector('[data-name="ai"]'),
  index:  document.querySelector('#out-index')   || document.querySelector('[data-name="index"]'),
  log:    document.querySelector('#out-log')     || document.querySelector('[data-name="log"]')
};

function logln(msg) {
  if (!ui.log) return;
  const t = typeof msg === 'string' ? msg : JSON.stringify(msg, null, 2);
  ui.log.value = (ui.log.value || '') + t + '\n';
}

async function translateLines(enLines, to = ['zh','ja']) {
  const resp = await fetch(MT_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ lines: enLines, to })
  });
  const data = await resp.json().catch(() => ({}));
  if (!resp.ok || !data.ok) {
    throw new Error(data?.error?.message || `HTTP ${resp.status}`);
  }
  // 最簡對接：直接拿 data.zh / data.ja
  return { zh: data.zh || [], ja: data.ja || [], input: data.input || enLines };
}

/* -------------------- 工具：時間字串 -------------------- */
function secToClock(s) {
  s = Math.max(0, Math.round(Number(s) || 0));
  const mm = String(Math.floor(s / 60)).padStart(2, '0');
  const ss = String(s % 60).padStart(2, '0');
  return `${mm}:${ss}`;
}

/* -------------------- 產生 cues（三語字幕） -------------------- */
/** @param {Array<{time:string,en:string}>} enCues */
async function buildCues(enCues) {
  const enLines = enCues.map(x => x.en || "");
  const { zh, ja } = await translateLines(enLines);
  const cues = enCues.map((row, i) => ({
    time: row.time,
    en: row.en || "",
    zh: zh[i] || row.en || "",
    ja: ja[i] || row.en || ""
  }));
  return cues;
}

/* -------------------- 產生 vocab（20詞） -------------------- */
/** 從字幕挑 20 個常見詞（很簡單的示意規則，你可換自己的抽詞邏輯） */
function pickTopWords(enCues, n = 20) {
  const txt = enCues.map(x => x.en).join(' ').toLowerCase();
  const bag = Object.create(null);
  txt.replace(/[a-zA-Z']+/g, w => {
    if (w.length < 2) return '';
    bag[w] = (bag[w] || 0) + 1;
    return '';
  });
  const stop = new Set(['the','a','an','to','and','is','are','am','of','in','on','at','for','it','this','that','you','i','we','they','he','she','be','with']);
  return Object.entries(bag)
    .filter(([w]) => !stop.has(w))
    .sort((a,b) => b[1]-a[1])
    .slice(0, n)
    .map(([w]) => w);
}

async function buildVocab(enCues, wordsEn) {
  // 例句：就用「第一個含該詞的字幕行」當 example_en
  const examplesEn = wordsEn.map(w => (enCues.find(x => new RegExp(`\\b${w}\\b`, 'i').test(x.en))?.en) || '');
  const trWords   = await translateLines(wordsEn);
  const trExs     = await translateLines(examplesEn);

  const vocab = {
    words: wordsEn.map((en, i) => ({
      en,
      zh: trWords.zh[i] || en,
      ja: trWords.ja[i] || en,
      def_en: "",                    // 若要英文字典可在這裡再做
      example_en: examplesEn[i] || "",
      example_zh: trExs.zh[i] || (examplesEn[i] || ""),
      example_ja: trExs.ja[i] || (examplesEn[i] || "")
    }))
  };
  return vocab;
}

/* -------------------- 產生 quiz（固定 20×4 類 = 80 題） -------------------- */
function buildQuiz(enCues, vocab) {
  // 範例：四種題型示意（你可替換為你既有規則）
  const pick = (arr, n) => arr.slice(0, n);
  const words = vocab.words.map(w => w.en);

  const Q = [];

  // 1) 單字中譯（20）
  pick(vocab.words, 20).forEach((w,i) => {
    Q.push({
      type: "word_zh",
      q: `「${w.en}」的中文是？`,
      a: w.zh, choices: shuffleUnique([w.zh, ...randFrom(vocab.words, 3).map(x=>x.zh)]),
      ref: w.example_en || ""
    });
  });
  // 2) 單字日譯（20）
  pick(vocab.words, 20).forEach((w,i) => {
    Q.push({
      type: "word_ja",
      q: `「${w.en}」的日文是？`,
      a: w.ja, choices: shuffleUnique([w.ja, ...randFrom(vocab.words, 3).map(x=>x.ja)]),
      ref: w.example_en || ""
    });
  });
  // 3) 句子中譯（20）
  pick(enCues, 20).forEach(row => {
    Q.push({
      type: "sent_zh",
      q: `下列英文的中文：\n${row.en}`,
      a: row.zh || "",
      choices: shuffleUnique([row.zh, ...randFrom(enCues, 3).map(x=>x.zh || "")])
    });
  });
  // 4) 句子日譯（20）
  pick(enCues, 20).forEach(row => {
    Q.push({
      type: "sent_ja",
      q: `下列英文的日文：\n${row.en}`,
      a: row.ja || "",
      choices: shuffleUnique([row.ja, ...randFrom(enCues, 3).map(x=>x.ja || "")])
    });
  });

  return { questions: Q };

  function shuffleUnique(list){
    const a = [...new Set(list.filter(Boolean))];
    for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
    return a.slice(0,4);
  }
  function randFrom(arr, n){
    const idx = Array.from({length: arr.length}, (_,i)=>i);
    for(let i=idx.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [idx[i],idx[j]]=[idx[j],idx[i]]; }
    return idx.slice(0,n).map(i=>arr[i]);
  }
}

/* -------------------- 產生 AI（固定 15 題模板） -------------------- */
function buildAI(enCues, vocab) {
  // 單純給出 15 個練習任務；你可以換成你的既有題庫格式
  const tasks = [];
  const take = (arr, n) => arr.slice(0, n);

  take(vocab.words, 5).forEach(w => {
    tasks.push({
      kind: "word_explain",
      prompt: `請用中文解釋英文字「${w.en}」，並各舉 1 個中/日例句。`
    });
  });
  take(enCues, 5).forEach(s => {
    tasks.push({
      kind: "sentence_rewrite",
      prompt: `請將這句英文改寫成 2 種更自然的說法，並各附中/日對譯：\n${s.en}`
    });
  });
  tasks.push({ kind: "role_speaking", prompt: "請扮演英語會話老師，設計 3 段含本課單字的對話（含中/日對照）。" });
  tasks.push({ kind: "listening_tips", prompt: "請提出 5 個針對本課音檔的聽力技巧與注意事項（中/日皆可讀）。" });
  tasks.push({ kind: "quiz_mix", prompt: "請用本課單字與句子，產出 5 題混合選擇題（附中/日翻譯與解析）。" });

  // 補足到 15
  while (tasks.length < 15) {
    tasks.push({ kind: "free_talk", prompt: "請就本課主題出 3 個開放口說題，附中/日提示。" });
  }
  return { tasks };
}

/* -------------------- 產生 index.json -------------------- */
/** @param {{category:string, slug:string, title:string, cover:string, video:string}} meta */
function buildIndex(meta) {
  return {
    category: meta.category, // story/music/movie/news/pro
    slug:     meta.slug,     // e.g., applesong
    title:    meta.title,
    cover:    meta.cover,    // Supabase Storage public URL
    video:    meta.video,    // Supabase Storage public URL
    updatedAt: new Date().toISOString()
  };
}

/* -------------------- 綁定「一鍵產生」 -------------------- */
/* 你原本應已有「預覽/上傳」按鈕；這裡僅示意綁一個總流程函式 */
window.generateAllJSON = async function generateAllJSON(enCues, meta) {
  /**
   * enCues 形如：
   * [ { time:"00:00", en:"..." }, { time:"00:04", en:"..." }, ... ]
   * meta 形如：
   * { category:"music", slug:"applesong", title:"Apple Song", cover:"...", video:"..." }
   */
  try {
    logln("== 開始產生 JSON ==");
    // 1) 三語字幕
    const cues = await buildCues(enCues);
    // 2) vocab 20詞
    const top20 = pickTopWords(cues.map(x => ({ en: x.en })));
    const vocab = await buildVocab(cues, top20);
    // 3) quiz 80 題
    const quiz = buildQuiz(cues, vocab);
    // 4) AI 15 題模板
    const ai = buildAI(cues, vocab);
    // 5) index
    const index = buildIndex(meta);

    // 寫到輸出區域
    if (ui.cues)  ui.cues.value  = JSON.stringify(cues,  null, 2);
    if (ui.vocab) ui.vocab.value = JSON.stringify(vocab, null, 2);
    if (ui.quiz)  ui.quiz.value  = JSON.stringify(quiz,  null, 2);
    if (ui.ai)    ui.ai.value    = JSON.stringify(ai,    null, 2);
    if (ui.index) ui.index.value = JSON.stringify(index, null, 2);

    logln("== 全部完成 ✅ ==");
    return { cues, vocab, quiz, ai, index };
  } catch (e) {
    console.error(e);
    logln(`❌ 產生失敗：${e.message || e}`);
    alert(`產生失敗：${e.message || e}`);
    throw e;
  }
};

/* 範例：如果你要從「純英文逐行 + 每4秒一行」快速做 enCues，可用： */
window.buildCuesFromLines = function(lines, stepSec = 4){
  const out = [];
  for (let i=0;i<lines.length;i++){
    out.push({ time: secToClock(i*stepSec), en: (lines[i]||"").trim() });
  }
  return out;
};

</script>

</body>
</html>







































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































