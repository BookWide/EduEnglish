<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BookWide Admin · 三分頁 + Edge 機翻 + 使用者清單連 Supabase · v20251109-3</title>
  <meta name="bw-fn-base" content="">
  <style>
    :root{--bg:#fff;--fg:#111;--muted:#64748b;--line:#e5e7eb;--brand:#2563eb;--ok:#16a34a;--warn:#f59e0b;--bad:#ef4444;--card:#f8fafc}
    html,body{background:var(--bg);color:var(--fg);font:14px/1.6 ui-sans-serif,system-ui,"PingFang TC","Noto Sans TC",Segoe UI,Roboto}
    .shell{max-width:1200px;margin:18px auto;padding:0 12px}
    h1{font-size:20px;margin:12px 0}
    h2{font-size:16px;margin:10px 0}
    .tabs{display:flex;gap:12px;margin:8px 0 16px}
    .tabbtn{border:1px solid var(--line);background:#fff;color:#111;border-radius:12px;padding:10px 16px;cursor:pointer}
    .tabbtn.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    .panel{display:none}
    .panel.active{display:block}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;margin:10px 0}
    .row{display:grid;grid-template-columns:140px 1fr;gap:10px;align-items:center;margin:8px 0}
    .row>label{color:#334155}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;font:inherit}
    textarea{min-height:140px;white-space:pre; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Courier New", monospace}
    .stack{display:flex;gap:8px;flex-wrap:wrap}
    .btn{background:#1e293b;color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn.brand{background:var(--brand)}
    .btn.ghost{background:#e2e8f0;color:#111}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .muted{color:var(--muted);font-size:12px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:left;vertical-align:top}
    .right{justify-content:flex-end}
    .log{font-family:ui-monospace,Menlo,monospace;background:#0b1020;color:#9fe7ff;padding:10px;border-radius:8px;white-space:pre-wrap;min-height:92px}
    .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:3px 10px;font-size:12px}
    .pill.ok{background:#dcfce7;color:#166534}
    .pill.bad{background:#fee2e2;color:#991b1b}
    .pill.warn{background:#fef3c7;color:#9a3412}
    .sep{height:1px;background:var(--line);margin:10px 0}
    .hint{font-size:12px;color:var(--muted)}
    .footer{margin-top:10px;color:var(--muted);text-align:center}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
</head>
<body>
<div class="shell">
  <h1>BookWide Admin 主控台</h1>
  <div class="tabs">
    <button class="tabbtn active" data-tab="users">使用者清單</button>
    <button class="tabbtn" data-tab="admins">授權／暫停管理員</button>
    <button class="tabbtn" data-tab="mp4">MP4 上傳</button>
  </div>

  <!-- 使用者清單 -->
  <div id="panel-users" class="panel active">
    <div class="card">
      <h2>使用者清單</h2>
      <div class="grid3">
        <input id="searchEmail" placeholder="搜尋 Email / 顯示名稱..."/>
        <button class="btn ghost" id="btnReloadUsers">重新整理</button>
        <div></div>
      </div>
      <div class="grid2">
        <div class="row"><label>Supabase URL</label><input id="sbpUrl" placeholder="https://xxxx.supabase.co"/></div>
        <div class="row"><label>Anon Key</label><input id="sbpKey" placeholder="eyJhbGciOi..." /></div>
      </div>
      <div class="hint">資料表：<code>public.profiles</code> · 台灣時區顯示 · 10 分鐘內視為「在線」。</div>
    </div>
    <div class="card">
      <table class="table" id="tblUsers">
        <thead>
          <tr>
            <th>Email</th>
            <th>顯示名稱</th>
            <th>最後登入</th>
            <th>最近在線</th>
            <th>管理員</th>
            <th>狀態</th>
            <th>到期日</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="footer" id="usersFooter">尚未載入</div>
    </div>
  </div>

  <!-- 授權／暫停管理員 -->
  <div id="panel-admins" class="panel">
    <div class="card">
      <h2>授權／暫停管理員</h2>
      <div class="grid3">
        <input id="newAdminEmail" placeholder="輸入 Email 授權為管理員"/>
        <button class="btn brand" id="btnGrant">授權</button>
        <button class="btn ghost" id="btnRevoke">暫停 / 取消授權</button>
      </div>
      <div class="sep"></div>
      <p class="muted">（此分頁預留位，等你確認欄位與政策後我可直接接上 Supabase）</p>
    </div>
  </div>

  <!-- MP4 上傳（含 Edge 機翻） -->
  <div id="panel-mp4" class="panel">
    <div class="card">
      <h2>MP4 上傳自動化（含字幕匯入 · JSON 預覽）</h2>

      <div class="row">
        <label>分類</label>
        <select id="category">
          <option value="music">music</option>
          <option value="story">story</option>
          <option value="movie">movie</option>
          <option value="news">news</option>
          <option value="pro">pro</option>
        </select>
      </div>
      <div class="row">
        <label>Slug（可空）</label>
        <input id="slug" placeholder="未填則自動以檔名/標題推斷"/>
      </div>
      <div class="row">
        <label>顯示標題（可空）</label>
        <input id="title" placeholder="例：A Little Love"/>
      </div>
      <div class="row">
        <label>MP4 檔</label>
        <input id="mp4" type="file" accept="video/mp4"/>
      </div>
      <div class="row">
        <label>封面（JPG）</label>
        <input id="cover" type="file" accept="image/jpeg,image/jpg,image/png"/>
      </div>
      <div class="row">
        <label>字幕（.txt/.srt/.vtt/.json）</label>
        <input id="subs" type="file" accept=".txt,.srt,.vtt,.json"/>
      </div>

      <div class="card">
        <h2>Edge Function 機翻（啟用可產生中/日）</h2>
        <div class="row">
          <label>Functions Base</label>
          <input id="fnBase" placeholder="https://xxxx.supabase.co/functions/v1"/>
        </div>
        <div class="row">
          <label>Function 名稱</label>
          <input id="fnName" value="mt-translate"/>
        </div>
        <div class="row">
          <label>測試</label>
          <button class="btn ghost" id="btnFnTest">測試連線</button>
        </div>
        <p class="muted">說明：預覽 JSON 時若「偵測到可用的 Edge Function」，會用它翻成 zh/ja；否則退回本地假機翻。</p>
        <div class="log" id="fnLog"></div>
      </div>

      <div class="stack">
        <button class="btn brand" id="btnPreview">預覽 JSON（5 件）</button>
        <button class="btn ghost" id="btnCollapse">全部收合</button>
        <button class="btn ghost" id="btnExpand">全部展開</button>
      </div>

      <h2>index-slug.json（影片資訊）</h2>
      <textarea id="jsonIndex"></textarea>
      <h2>cues-slug.json（三語字幕）</h2>
      <textarea id="jsonCues"></textarea>
      <h2>quiz-slug.json（80 題模板）</h2>
      <textarea id="jsonQuiz"></textarea>
      <h2>vocab-slug.json（20 詞模板）</h2>
      <textarea id="jsonVocab"></textarea>
      <h2>ai-slug.json（AI 問答模板 15 題）</h2>
      <textarea id="jsonAI"></textarea>
    </div>

    <div class="card">
      <h2>Supabase 上傳（影片 + 封面）</h2>
      <div class="row"><label>Supabase URL</label><input id="sbUrl" placeholder="https://xxxx.supabase.co"/></div>
      <div class="row"><label>Anon Key</label><input id="sbKey" placeholder="eyJhbGciOi..."/></div>
      <div class="grid2">
        <div class="row"><label>影片桶名</label><input id="bucketVideo" value="videos"/></div>
        <div class="row"><label>封面桶名</label><input id="bucketCover" value="assets"/></div>
      </div>
      <div class="stack">
        <button class="btn brand" id="btnUploadSB">上傳到 Supabase（影片 + 封面）</button>
      </div>
      <div class="log" id="sbLog"></div>
    </div>

    <div class="card">
      <h2>GitHub 上傳（5 件 JSON）</h2>
      <div class="row"><label>Owner</label><input id="ghOwner" value="bookwide"/></div>
      <div class="row"><label>Repo</label><input id="ghRepo" value="EduEnglish"/></div>
      <div class="row"><label>Branch</label><input id="ghBranch" value="main"/></div>
      <div class="row"><label>Base Path（例：data/）</label><input id="ghBase" value="data/"/></div>
      <div class="row"><label>GitHub Token</label><input id="ghToken" type="password" placeholder="ghp_xxx"/></div>
      <div class="row"><label>Commit 訊息</label><input id="ghMsg" value="Add JSON templates"/></div>
      <div class="stack"><button class="btn brand" id="btnUploadGH">上傳到 GitHub（5 件）</button></div>
      <div class="log" id="ghLog"></div>
      <p class="muted">統一路徑：影片 <code>videos/${category}/${slug}.mp4</code> · 封面 <code>assets/${category}/${slug}.cover.jpg</code></p>
    </div>
  </div>
</div>

<script>
const $ =(q)=>document.querySelector(q);
const j =(o)=>JSON.stringify(o,null,2);
const nowISO = ()=>new Date().toISOString();
const b64 = (s)=>btoa(unescape(encodeURIComponent(s)));
const TWfmt = (d)=>{
  if(!d) return "";
  const dt = new Date(d);
  return new Intl.DateTimeFormat('zh-TW',{
    timeZone:'Asia/Taipei',year:'numeric',month:'2-digit',day:'2-digit',
    hour:'2-digit',minute:'2-digit',second:'2-digit'
  }).format(dt);
};

// Tabs
document.querySelectorAll(".tabbtn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".tabbtn").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".panel").forEach(p=>p.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById("panel-"+btn.dataset.tab).classList.add("active");
  });
});

// ========== 使用者清單：接 Supabase public.profiles ==========
let sbp = null;
function initProfilesClient(){
  const url = $("#sbpUrl").value.trim();
  const key = $("#sbpKey").value.trim();
  if(!/^https?:\/\//.test(url) || !key) return null;
  // 快取在 localStorage
  localStorage.setItem("bw_sbp_url",url);
  localStorage.setItem("bw_sbp_key",key);
  return supabase.createClient(url,key);
}
function pill(text,type){
  const span = document.createElement("span");
  span.className = "pill " + (type||"");
  span.textContent = text;
  return span;
}
async function reloadUsers(){
  sbp = initProfilesClient();
  const tbody = $("#tblUsers tbody");
  const foot = $("#usersFooter");
  tbody.innerHTML = "";
  if(!sbp){ foot.textContent = "請填 Supabase URL / Anon Key"; return; }
  foot.textContent = "載入中...";

  // 查詢欄位盡量涵蓋你的實際 schema
  const sel = "email, display_name, username, name, last_login, last_sign_in_at, last_seen, is_admin, admin, role, status, state, expiry_date, subscription_end, expire_at";
  const { data, error } = await sbp.from("profiles").select(sel).order("last_login",{ascending:false}).limit(500);
  if(error){ foot.textContent = "查詢失敗：" + error.message; return; }

  const q = $("#searchEmail").value.trim().toLowerCase();
  const now = Date.now();
  let count = 0;

  for(const r of data){
    const email = r.email || "";
    const display = r.display_name || r.username || r.name || "";
    const lastLogin = r.last_login || r.last_sign_in_at || null;
    const lastSeen  = r.last_seen || null;
    const isAdmin   = [true,"true","1","admin"].includes(String(r.is_admin ?? r.admin ?? r.role).toLowerCase());
    const statusTxt = r.status || r.state || "正常";
    const exp = r.expiry_date || r.subscription_end || r.expire_at || null;

    if(q && !(email.toLowerCase().includes(q) || display.toLowerCase().includes(q))) continue;

    const tr = document.createElement("tr");
    const online = lastSeen ? (now - new Date(lastSeen).getTime()) <= 10*60*1000 : false;

    tr.innerHTML = `
      <td>${email}</td>
      <td>${display}</td>
      <td>${TWfmt(lastLogin)||""}</td>
      <td>${TWfmt(lastSeen)||""}</td>
      <td></td>
      <td></td>
      <td>${exp? TWfmt(exp).slice(0,10):""}</td>
    `;
    // 管理員
    tr.children[4].appendChild(pill(isAdmin? "是":"否", isAdmin?"ok":"warn"));
    // 狀態 / 在線
    const st = document.createElement("div");
    st.appendChild(pill(online? "在線":"離線", online?"ok":"bad"));
    st.appendChild(document.createTextNode(" "));
    st.appendChild(pill(statusTxt, "ok"));
    tr.children[5].appendChild(st);

    tbody.appendChild(tr);
    count++;
  }
  foot.textContent = `共 ${count} 筆 · 台灣時區 · 10 分鐘內視為在線`;
}
$("#btnReloadUsers").addEventListener("click", reloadUsers);
$("#searchEmail").addEventListener("input", ()=>{ reloadUsers(); });

// 從 localStorage 恢復
(function(){
  const u = localStorage.getItem("bw_sbp_url"); if(u) $("#sbpUrl").value = u;
  const k = localStorage.getItem("bw_sbp_key"); if(k) $("#sbpKey").value = k;
})();

// ========== MP4 + Edge 機翻 既有流程（略：主要保留功能） ==========
function getSlug(){
  const txt = id=>document.getElementById(id)?.value?.trim()||"";
  const file = id=>document.getElementById(id)?.files?.[0]||null;
  const name = f=>f? f.name.replace(/\.[^.]+$/,""):"";
  const hint = window.BW_SLUG || txt("slug") || name(file("subs")) || name(file("mp4")) || name(file("cover")) || txt("title") || "demo";
  return hint.trim();
}
function catSlug(){
  const cat = $("#category").value;
  const slug = getSlug();
  $("#slug").value = slug;
  window.BW_SLUG = slug;
  return {cat,slug};
}
async function readSubsText(file){
  if(!file) return [];
  const text = await file.text();
  const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const out=[];
  for(const s of lines){
    if(/^\d+$/.test(s)) continue;
    if(/^\d{2}:\d{2}:\d{2}/.test(s)) continue;
    out.push(s);
  }
  return out.slice(0,200);
}
async function callEdgeTranslate(lines){
  const base = $("#fnBase").value.trim().replace(/\/+$/,"");
  const fn   = $("#fnName").value.trim()||"mt-translate";
  if(!base) return null;
  try{
    const res = await fetch(`${base}/${fn}`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ lines, to:["zh","ja"] })
    });
    const js = await res.json();
    if(!res.ok || js.ok===false) throw new Error(js?.error?.message||"Edge 失敗");
    if(js.results && Array.isArray(js.results)){
      const zh = js.results.find(r=>r.lang==="zh")?.lines||[];
      const ja = js.results.find(r=>r.lang==="ja")?.lines||[];
      return { zh, ja, via:"edge" };
    }
    return { zh: js.zh||[], ja: js.ja||[], via:"edge" };
  }catch(e){
    $("#fnLog").textContent = `[Edge] 失敗：${e.message}`;
    return null;
  }
}
$("#btnFnTest").addEventListener("click", async ()=>{
  const r = await callEdgeTranslate(["Hello world"]);
  $("#fnLog").textContent = r? `OK：已連線（${r.via}），範例 zh="${r.zh[0]||""}"` : "失敗：請確認 Functions Base / 名稱是否正確";
});
function makeQuiz80(slug){const items=[];for(let i=1;i<=80;i++)items.push({id:i,q:`Q${i}`,a:["A","B","C","D"],answer:0});return{slug,items};}
function makeVocab20(slug,en){return{slug,words:en.slice(0,20).map((s,i)=>({en:(s.split(/\s+/)[0]||`word${i+1}`).toLowerCase(),zh:"",ja:"",def_en:"",example_en:s}))};}
function makeAI15(slug,en){const items=[];for(let i=1;i<=15;i++)items.push({id:i,q:"Question",a:""});return{slug,items};}
$("#btnPreview").addEventListener("click", async ()=>{
  const {cat,slug} = catSlug();
  const title = $("#title").value.trim() || slug;
  const subsF = $("#subs").files?.[0]||null;
  const en = await readSubsText(subsF);
  let zh = [], ja = [];
  const edge = await callEdgeTranslate(en);
  if(edge){ zh = edge.zh; ja = edge.ja; $("#fnLog").textContent = "已使用 Edge 機翻"; }
  else { zh = en.map(s=>`中文：${s}`); ja = en.map(s=>`日本語：${s}`); }
  const indexJson = { slug, title, video:`videos/${cat}/${slug}.mp4`, cover:`assets/${cat}/${slug}.cover.jpg`, category:cat, updatedAt:nowISO() };
  const cuesJson = en.map((s,i)=>({ time:`00:${String(i).padStart(2,"0")}`, en:s, zh: zh[i]||"", ja: ja[i]||"" }));
  const quizJson = makeQuiz80(slug);
  const vocabJson = makeVocab20(slug, en);
  const aiJson = makeAI15(slug, en);
  $("#jsonIndex").value = j(indexJson);
  $("#jsonCues").value  = j(cuesJson);
  $("#jsonQuiz").value  = j(quizJson);
  $("#jsonVocab").value = j(vocabJson);
  $("#jsonAI").value    = j(aiJson);
});
$("#btnCollapse").addEventListener("click",()=>["#jsonIndex","#jsonCues","#jsonQuiz","#jsonVocab","#jsonAI"].forEach(q=>{const ta=$(q);ta.rows=4;ta.style.minHeight="80px";}));
$("#btnExpand").addEventListener("click",()=>["#jsonIndex","#jsonCues","#jsonQuiz","#jsonVocab","#jsonAI"].forEach(q=>{const ta=$(q);ta.style.minHeight="240px";ta.rows=18;}));

// Supabase Storage 上傳（影片 + 封面）
$("#btnUploadSB").addEventListener("click", async ()=>{
  const log=$("#sbLog");log.textContent="";
  const base=$("#sbUrl").value.trim().replace(/\/+$/,"");const key=$("#sbKey").value.trim();
  if(!/^https?:\/\//.test(base)||!key){log.textContent="請填 Supabase URL 與 anon key";return;}
  const {cat,slug}=catSlug();const vidB=$("#bucketVideo").value.trim()||"videos";const covB=$("#bucketCover").value.trim()||"assets";
  const mp4=$("#mp4").files?.[0]||null;const jpg=$("#cover").files?.[0]||null;
  try{
    if(mp4){const u=`${base}/storage/v1/object/${vidB}/${cat}/${slug}.mp4`;await fetch(u+"?upsert=true",{method:"POST",headers:{apikey:key,authorization:`Bearer ${key}`},body:mp4});log.textContent+=`[1/2] 上傳影片中...\n  ${u}\n\n`;}else{log.textContent+=`[1/2] 略過影片（未選檔）\n\n`;}
    if(jpg){const u2=`${base}/storage/v1/object/${covB}/${cat}/${slug}.cover.jpg`;await fetch(u2+"?upsert=true",{method:"POST",headers:{apikey:key,authorization:`Bearer ${key}`},body:jpg});log.textContent+=`[2/2] 上傳封面中...\n  ${u2}\n完成。`;}else{log.textContent+=`[2/2] 略過封面（未選檔）\n完成。`;}
  }catch(e){log.textContent+=`\n[錯誤] ${e?.message||e}`;}
});

// GitHub 上傳（五件 JSON）
$("#btnUploadGH").addEventListener("click", async ()=>{
  const glog=$("#ghLog");glog.textContent="";
  const owner=$("#ghOwner").value.trim();const repo=$("#ghRepo").value.trim();const branch=$("#ghBranch").value.trim()||"main";const base=$("#ghBase").value.trim()||"data/";const token=$("#ghToken").value.trim();const msg=$("#ghMsg").value.trim()||"Add JSON templates";
  const {slug}=catSlug(); if(!slug){glog.textContent="【錯誤】slug 不可空（請先預覽 JSON 以產生 slug）";return;}
  if(!owner||!repo||!token){glog.textContent="請填 Owner/Repo/Token";return;}
  const files=[
    {name:`index-${slug}.json`,content:$("#jsonIndex").value.trim()},
    {name:`cues-${slug}.json`,content:$("#jsonCues").value.trim()},
    {name:`quiz-${slug}.json`,content:$("#jsonQuiz").value.trim()},
    {name:`vocab-${slug}.json`,content:$("#jsonVocab").value.trim()},
    {name:`ai-${slug}.json`,content:$("#jsonAI").value.trim()},
  ];
  if(files.some(f=>!f.content)){glog.textContent="請先按『預覽 JSON（5 件）』，再上傳 GitHub。";return;}
  async function putFile(path,text){const api=`https://api.github.com/repos/${owner}/${repo}/contents/${path}`;const res=await fetch(api,{method:"PUT",headers:{"Authorization":`token ${token}`,"Content-Type":"application/json"},body:JSON.stringify({message:msg,branch,content:b64(text)})});if(!res.ok){throw new Error(`${res.status} ${res.statusText} → ${await res.text()}`);}return await res.json();}
  try{for(const f of files){const path=`${base.replace(/\/?$/,"/")}${f.name}`.replace(/\/+/g,"/");await putFile(path,f.content);glog.textContent+=`已上傳：${path}\n`;}glog.textContent+="完成。";}catch(e){glog.textContent+=`\n[錯誤] ${e?.message||e}`;}
});
</script>
</body>
</html>


























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































