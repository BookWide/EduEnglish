<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin · 三分頁 · v20251106-three-tabs-v3a</title>
  <script type="module" src="./supa.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <style>
    :root{ --bg:#fff; --fg:#111; --muted:#6b7280; --line:#e5e7eb; --brand:#2563eb; --ok:#16a34a; --warn:#f59e0b; --card:#fafafa;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"PingFang TC","Noto Sans TC","微軟正黑體",sans-serif}
    header{padding:18px 20px;border-bottom:1px solid var(--line);display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .title{font-size:22px;font-weight:700;margin-right:auto}
    .chip{padding:.35rem .6rem;border-radius:999px;background:#eef2ff;color:#1d4ed8;font-size:12px}
    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab-btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:.5rem 1rem;cursor:pointer}
    .tab-btn.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    .wrap{max-width:1100px;margin:22px auto;padding:0 16px}
    .row{display:grid;gap:14px}
    .grid-2{grid-template-columns: 1fr 1fr}
    @media (max-width:1100px){ .grid-2{grid-template-columns:1fr} }
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px}
    .input, select, textarea{border:1px solid var(--line);border-radius:10px;padding:.6rem .8rem;background:#fff}
    textarea{height:320px;resize:vertical;white-space:pre-wrap;overflow:auto}
    .btn{border:1px solid var(--brand);background:var(--brand);color:#fff;border-radius:10px;padding:.55rem .9rem;cursor:pointer}
    .btn.outline{background:#fff;color:var(--brand)}
    .hint{color:#6b7280;font-size:13px}
    .progress{height:10px;background:#eef2ff;border-radius:99px;overflow:hidden}
    .bar{height:100%;width:0;background:#2563eb;transition:width .2s}
    .pill{display:inline-block;padding:.2rem .5rem;border-radius:999px;border:1px solid var(--line);font-size:12px}
    .pill.ok{color:#16a34a;border-color:#16a34a} .pill.warn{color:#f59e0b;border-color:#f59e0b}
    /* Accordion */
    .acc{border:1px solid var(--line);border-radius:12px;background:#f8fafc}
    .acc .hd{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;cursor:pointer;user-select:none}
    .acc .hd h4{margin:0;font-size:14px}
    .acc .bd{padding:12px;display:block}
    .acc.collapsed .bd{display:none}
    .chev{width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:7px solid #6b7280;transition:transform .2s}
    .acc.collapsed .chev{transform:rotate(-90deg)}
    .stack{display:grid;gap:12px}
    .right{display:flex;gap:10px;align-items:center;justify-content:flex-end}
  </style>
</head>
<body>
  <header>
    <div class="title">BookWide Admin 主控台</div>
    <span class="chip">三分頁 · 內嵌 Supabase · v20251106</span>
    <nav class="tabs">
      <button class="tab-btn active" data-tab="mp4">MP4 上傳</button>
      <button class="tab-btn" data-tab="users">使用者清單</button>
      <button class="tab-btn" data-tab="roles">授權 / 暫停管理員</button>
    </nav>
  </header>

  <main class="wrap">
    <!-- MP4 上傳 -->
    <section id="panel-mp4">
      <div class="row grid-2">
        <!-- 左：表單 + 預覽 -->
        <div class="card">
          <h3 style="margin:6px 0 14px">MP4 上傳自動化（含字幕匯入、JSON 預覽）</h3>

          <div class="row grid-2">
            <div>
              <label class="hint">分類</label>
              <select id="cat" class="input"><option>story</option><option selected>music</option><option>movie</option><option>news</option><option>pro</option></select>
            </div>
            <div><label class="hint">Slug（不可空）</label><input id="slug" class="input" placeholder="applesong"></div>
          </div>

          <div class="row grid-2" style="margin-top:8px">
            <div><label class="hint">顯示標題（可空）</label><input id="title" class="input" placeholder="A Little Love"></div>
            <div><label class="hint">吸附窗（s）</label><input id="snapWin" class="input" type="number" step="0.05" value="0.25"></div>
          </div>

          <div class="row grid-2" style="margin-top:8px">
            <div><label class="hint">MP4 檔</label><input id="mp4File" type="file" accept="video/mp4" class="input"></div>
            <div><label class="hint">封面（建議 JPG）</label><input id="coverFile" type="file" accept="image/*" class="input"></div>
          </div>
          <div style="margin-top:8px"><label class="hint">字幕（.txt / .srt / .vtt / .json）</label><input id="subFile" type="file" accept=".txt,.srt,.vtt,.json" class="input" style="width:100%"></div>

          <div class="row grid-2" style="margin-top:10px">
            <div>
              <label class="hint">中/日 產生模式</label>
              <div style="display:flex;gap:12px;align-items:center;margin-top:6px">
                <label style="display:flex;gap:6px;align-items:center"><input id="modeSimple" type="radio" name="mtmode" checked> 簡易（只產生 en）</label>
                <label style="display:flex;gap:6px;align-items:center"><input id="modeMT" type="radio" name="mtmode"> 機翻（透過 Edge Function）</label>
              </div>
              <div class="hint" style="margin-top:6px">※ 若字幕檔本身已是「<code>[{time,en,ja,zh}]</code>」三語 JSON，就不用勾機翻。</div>
            </div>
            <div>
              <label class="hint">Edge Function 名稱（預設 mt-translate）</label>
              <input id="edgeFn" class="input" placeholder="mt-translate" value="mt-translate">
              <div class="hint" style="margin-top:6px">Functions 網域：<code id="fnBase">未偵測</code>　<button class="btn outline" id="btnTestFn" style="padding:.25rem .6rem">測試</button> <span id="fnMsg" class="hint"></span></div>
            </div>
          </div>

          <div class="right" style="margin-top:10px;gap:8px">
            <button class="btn outline" id="btnCollapseAll">全部收合</button>
            <button class="btn outline" id="btnExpandAll">全部展開</button>
            <button class="btn" id="btnPreview">預覽 JSON（5 件）</button>
          </div>

          <div class="stack" style="margin-top:10px">
            <div class="acc" id="accIndex">
              <div class="hd"><h4>index-<span id="fnSlug1">slug</span>.json（影片資訊）</h4><div class="chev"></div></div>
              <div class="bd"><textarea id="boxIndex" placeholder="index-<slug>.json 預覽"></textarea></div>
            </div>
            <div class="acc" id="accCues">
              <div class="hd"><h4>cues-<span id="fnSlug2">slug</span>.json（三語字幕）</h4><div class="chev"></div></div>
              <div class="bd"><textarea id="boxCues" placeholder="cues-*.json"></textarea></div>
            </div>
            <div class="acc" id="accQuiz">
              <div class="hd"><h4>quiz-<span id="fnSlug3">slug</span>.json（80 題）</h4><div class="chev"></div></div>
              <div class="bd"><textarea id="boxQuiz" placeholder="quiz-*.json"></textarea></div>
            </div>
            <div class="acc" id="accVocab">
              <div class="hd"><h4>vocab-<span id="fnSlug4">slug</span>.json（20 詞：英/中/日/定義/例句）</h4><div class="chev"></div></div>
              <div class="bd"><textarea id="boxVocab" placeholder="vocab-*.json"></textarea></div>
            </div>
            <div class="acc" id="accAI">
              <div class="hd"><h4>ai-<span id="fnSlug5">slug</span>.json（AI 問答模板 15 題）</h4><div class="chev"></div></div>
              <div class="bd"><textarea id="boxAI" placeholder="ai-*.json"></textarea></div>
            </div>
          </div>
        </div>

        <!-- 右：Supabase / GitHub -->
        <div class="card">
          <h3 style="margin:6px 0 14px">Supabase 上傳（影片＋封面）</h3>
          <div class="row grid-2">
            <div><label class="hint">Supabase URL（可空）</label><input id="sbUrl" class="input" placeholder="https://xxxx.supabase.co"></div>
            <div><label class="hint">Supabase anon key（可空）</label><input id="sbKey" class="input" placeholder="ey..."></div>
          </div>
          <div class="row grid-2">
            <div><label class="hint">影片桶名</label><input id="bucketVideo" class="input" value="videos"></div>
            <div><label class="hint">封面桶名</label><input id="bucketAsset" class="input" value="assets"></div>
          </div>
          <div class="right" style="margin-top:6px"><button class="btn" id="btnSupaUpload">上傳到 Supabase（影片＋封面）</button></div>
          <pre id="supaStatus" class="hint" style="background:#0b10221a;padding:10px;border-radius:8px;margin-top:8px;white-space:pre-wrap"></pre>
          <div class="progress" style="margin-top:6px"><div id="supaBar2" class="bar"></div></div>
          <div id="supaPct2" class="hint" style="margin-top:4px">0%</div>

          <div style="margin:16px 0;height:1px;background:var(--line)"></div>

          <h3 style="margin:6px 0 10px">GitHub 上傳（5 件 JSON）</h3>
          <div class="row grid-2">
            <div><label class="hint">Owner</label><input id="ghOwner" class="input" value="bookwide"></div>
            <div><label class="hint">Repo</label><input id="ghRepo" class="input" value="EduEnglish"></div>
          </div>
          <div class="row grid-2">
            <div><label class="hint">Branch</label><input id="ghBranch" class="input" value="main"></div>
            <div><label class="hint">Base Path（例：data/ 或留空）</label><input id="ghBase" class="input" value="data/"></div>
          </div>
          <div class="row grid-2">
            <div><label class="hint">Commit 訊息</label><input id="ghMsg" class="input" value="Add JSON templates"></div>
            <div><label class="hint">GitHub Token（Classic PAT）</label><input id="ghTok" class="input" placeholder="ghp_xxx"></div>
          </div>
          <div class="right" style="margin-top:6px"><button class="btn" id="btnUploadGithub">上傳到 GitHub（5 件）</button></div>
          <pre id="ghStatus" class="hint" style="background:#0b10221a;padding:10px;border-radius:8px;margin-top:8px;white-space:pre-wrap"></pre>
          <div class="progress" style="margin-top:6px"><div id="ghBar2" class="bar"></div></div>
          <div id="ghPct2" class="hint" style="margin-top:4px">0%</div>
        </div>
      </div>
    </section>

    <section id="panel-users" style="display:none"></section>
    <section id="panel-roles" style="display:none"></section>
  </main>

  <script>
  (function(){
    const qs=(s,r)=> (r||document).querySelector(s);
    const $$=(s,r)=> Array.from((r||document).querySelectorAll(s));
    const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
    const b64=(s)=>btoa(unescape(encodeURIComponent(s)));

    // Tabs
    $$('.tab-btn').forEach(b=>b.addEventListener('click',()=>{
      $$('.tab-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active');
      const t=b.getAttribute('data-tab');
      qs('#panel-users').style.display = (t==='users')?'':'none';
      qs('#panel-roles').style.display = (t==='roles')?'':'none';
      qs('#panel-mp4').style.display   = (t==='mp4')  ?'':'none';
    }));

    // Accordion
    $$('.acc .hd').forEach(hd=>{ hd.addEventListener('click',()=> hd.parentElement.classList.toggle('collapsed')); });
    qs('#btnCollapseAll')?.addEventListener('click',()=> $$('.acc').forEach(a=>a.classList.add('collapsed')));
    qs('#btnExpandAll')?.addEventListener('click',()=> $$('.acc').forEach(a=>a.classList.remove('collapsed')));

    function computeFnBase(){
      let url = qs('#sbUrl')?.value || window.BW?.url || window.BW?.supa?.url || '';
      let base=''; try{ const u=new URL(url); base=`${u.protocol}//${u.host.replace('.supabase.co','.functions.supabase.co')}`; }catch(e){}
      qs('#fnBase').textContent=base||'未偵測'; return base;
    }
    computeFnBase();
    qs('#sbUrl')?.addEventListener('input', computeFnBase);

    async function callEdge(fn, payload){
      const base=computeFnBase(); if(!base) throw new Error('未偵測到 Functions 網域');
      const url=`${base}/${fn}`;
      const headers={'Content-Type':'application/json'};
      try{ const s=await window.BW?.auth?.getSession?.(); const jwt=s?.session?.access_token; if(jwt) headers['Authorization']='Bearer '+jwt; }catch(e){}
      const r=await fetch(url,{method:'POST',headers,body:JSON.stringify(payload)});
      if(!r.ok){ const t=await r.text(); throw new Error(`Functions HTTP ${r.status} – ${t}`); }
      return await r.json();
    }

    function setSlugLabels(slug){ ['fnSlug1','fnSlug2','fnSlug3','fnSlug4','fnSlug5'].forEach(id=>{ const el=qs('#'+id); if(el) el.textContent=slug||'slug'; }); }
    function mmss(i, step=4){ const s=i*step; const m=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${m}:${ss}`; }

    async function parseSubtitleFile(file){
      if(!file) return [];
      const name=file.name.toLowerCase(); const text=await file.text();
      if(name.endsWith('.json')){ try{ const arr=JSON.parse(text); if(Array.isArray(arr)&&arr.length&&('time' in arr[0])) return arr.map(x=>({time:x.time,en:x.en||'',ja:x.ja||'',zh:x.zh||''})); }catch(e){} }
      if(name.endsWith('.srt')||name.endsWith('.vtt')){
        const lines=text.replace(/\r/g,'').split('\n'); const out=[]; let cur=null;
        const timeRe=/(\d\d:\d\d:\d\d)[,\.](\d\d\d)\s*-->\s*(\d\d:\d\d:\d\d)[,\.](\d\d\d)/;
        for(const ln of lines){
          const m=timeRe.exec(ln);
          if(m){ cur={time:m[1].slice(0,5), en:''}; continue; }
          if(!ln.trim()){ if(cur){ out.push({...cur,ja:'',zh:''}); cur=null; } }
          else if(cur){ cur.en=(cur.en?cur.en+' ':'')+ln.trim(); }
        }
        if(cur) out.push({...cur,ja:'',zh:''});
        return out;
      }
      const arr=text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      return arr.map((line,i)=>({ time:mmss(i), en:line, ja:'', zh:'' }));
    }

    function tokenizeEn(s){ return (s||'').toLowerCase().replace(/[^a-z0-9' ]/g,' ').split(/\s+/).filter(Boolean); }
    const STOP=new Set(['the','a','an','to','is','are','am','be','and','or','of','in','on','for','with','that','this','it','as','at','by','from','i','you','he','she','we','they','was','were','been','do','did','does','so','but','if','not','no','yes','me','my','your','our','their']);
    function topWords(cues,n=40){ const f=new Map(); for(const c of cues){ for(const w of tokenizeEn(c.en)){ if(w.length<3||STOP.has(w)) continue; f.set(w,(f.get(w)||0)+1); } } return Array.from(f.entries()).sort((a,b)=>b[1]-a[1]).slice(0,n).map(x=>x[0]); }
    function buildVocabFromCues(cues){
      const keys=topWords(cues,60); const set=new Set(); const out=[];
      for(const k of keys){ if(set.has(k)) continue; set.add(k); const sample=(cues.find(c=>c.en.toLowerCase().includes(k))?.en)||(`I use "${k}" in a sentence.`); out.push({ en:k, zh:"", ja:"", def_en:"", example_en: sample }); if(out.length>=20) break; }
      return out;
    }

    async function translateBatch(fn, texts, to){
      const out=[];
      for(const t of texts){ try{ const j=await callEdge(fn,{text:t,from:'en',to}); out.push(j?.text||''); }catch(e){ out.push(''); } await sleep(120); }
      return out;
    }

    qs('#btnTestFn')?.addEventListener('click', async ()=>{
      const msg=qs('#fnMsg'); msg.textContent='測試中…';
      try{ const fn=(qs('#edgeFn').value||'mt-translate').trim(); const j=await callEdge(fn,{text:'Hello',from:'en',to:'zh'}); msg.textContent=j?.text?('OK：'+j.text):'OK'; }
      catch(e){ msg.textContent='失敗：'+(e.message||e); }
    });

    qs('#btnPreview')?.addEventListener('click', async ()=>{
      const cat=qs('#cat').value.trim(), slug=qs('#slug').value.trim(), title=qs('#title').value.trim(); setSlugLabels(slug);
      if(!slug){ alert('Slug 不可空'); return; }
      const sub=qs('#subFile').files[0]; const cuesEN=await parseSubtitleFile(sub);
      let zhArr=[], jaArr=[];
      if(qs('#modeMT').checked && cuesEN.length){
        const fn=(qs('#edgeFn').value||'mt-translate').trim(); const enArr=cuesEN.map(x=>x.en);
        try{ zhArr=await translateBatch(fn,enArr,'zh'); jaArr=await translateBatch(fn,enArr,'ja'); } catch(e){ qs('#fnMsg').textContent='機翻失敗：'+(e.message||e); }
      }
      const cues = cuesEN.map((x,i)=>({...x, zh: zhArr[i]||x.zh||'', ja: jaArr[i]||x.ja||'' }));
      const index={ slug, title, video:`videos/${cat}/${slug}.mp4`, cover:`assets/${cat}/${slug}/cover.jpg`, category:cat, updatedAt:new Date().toISOString() };
      const topics=Array.from({length:20},(_,i)=>({title:`Topic ${i+1}`,prompt:"",hint:"",sample:""}));
      const quiz={ title:"Lesson", topics };
      const vocab={ words: buildVocabFromCues(cues) };
      const ai={ tasks:Array.from({length:15},(_,i)=>({q:`Question ${i+1}`,a:""})) };
      qs('#boxIndex').value=JSON.stringify(index,null,2);
      qs('#boxCues').value =JSON.stringify(cues ,null,2);
      qs('#boxQuiz').value =JSON.stringify(quiz ,null,2);
      qs('#boxVocab').value=JSON.stringify(vocab,null,2);
      qs('#boxAI').value   =JSON.stringify(ai   ,null,2);
    });

    function getClient(){ if(window.BW?.supa?.createClient) return window.BW.supa.createClient(); const url=qs('#sbUrl').value.trim(); const key=qs('#sbKey').value.trim(); if(!url||!key) return null; return supabase.createClient(url,key); }
    async function supaUpload(bucket, path, file, client){ const { error }=await client.storage.from(bucket).upload(path,file,{upsert:true,contentType:file.type||undefined}); if(error) throw error; const { data:pub }=client.storage.from(bucket).getPublicUrl(path); return pub.publicUrl; }
    function setProgress(bar,pct,p){ p=Math.max(0,Math.min(100,Math.round(p))); if(bar) bar.style.width=p+'%'; if(pct) pct.textContent=p+'%'; }
    const supaBar=qs('#supaBar2'), supaPct=qs('#supaPct2');
    qs('#btnSupaUpload')?.addEventListener('click', async ()=>{
      const st=qs('#supaStatus'); st.textContent=''; const slug=qs('#slug').value.trim(), cat=qs('#cat').value.trim();
      if(!slug){ st.textContent='[錯誤] Slug 不可空。'; return; }
      const mp4=qs('#mp4File').files[0], cover=qs('#coverFile').files[0]; if(!mp4){ st.textContent='[錯誤] 請先選擇 MP4 檔。'; return; }
      const c=getClient(); if(!c){ st.textContent='[錯誤] 找不到 Supabase 連線（BW.supa 或手動 URL/KEY）。'; return; }
      const vBucket=qs('#bucketVideo').value.trim()||'videos', aBucket=qs('#bucketAsset').value.trim()||'assets';
      try{
        setProgress(supaBar,supaPct,10); st.textContent+='[1/2] 上傳影片中...\n'; const vUrl=await supaUpload(vBucket, `${cat}/${slug}.mp4`, mp4, c); st.textContent+=`    影片 URL → ${vUrl}\n`; setProgress(supaBar,supaPct,70);
        let cUrl=''; if(cover){ st.textContent+='[2/2] 上傳封面中...\n'; cUrl=await supaUpload(aBucket, `${cat}/${slug}/cover.jpg`, cover, c); st.textContent+=`    封面 URL → ${cUrl}\n`; } else { st.textContent+='[2/2] 未選封面，略過。\n'; }
        setProgress(supaBar,supaPct,100);
        if(qs('#boxIndex').value){ try{ const idx=JSON.parse(qs('#boxIndex').value); if(vUrl) idx.video=vUrl; if(cUrl) idx.cover=cUrl; qs('#boxIndex').value=JSON.stringify(idx,null,2);}catch(e){} }
        st.textContent+='完成。';
      }catch(e){ st.textContent+=`[失敗] ${e.message||e}`; setProgress(supaBar,supaPct,0); }
    });

    async function ghPut({owner,repo,branch,token,path,content,message}){
      const url=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
      const body={ message, branch, content: b64(content) };
      const r=await fetch(url,{method:'PUT',headers:{'Authorization':`token ${token}`,'Content-Type':'application/json'},body:JSON.stringify(body)});
      if(!r.ok){ const t=await r.text(); throw new Error(`HTTP ${r.status} – ${t}`); }
      return await r.json();
    }
    function parseBox(id){ try{ return JSON.parse(qs(id).value||''); }catch(e){ return null; } }
    function validateAll(st){
      const index=parseBox('#boxIndex'), cues=parseBox('#boxCues'), quiz=parseBox('#boxQuiz'), vocab=parseBox('#boxVocab'), ai=parseBox('#boxAI');
      if(!index||!cues||!quiz||!vocab||!ai){ st.textContent='[錯誤] 五份 JSON 需全部產生（請先按「預覽 JSON」）'; return false; }
      if(!index.slug){ st.textContent='[錯誤] index.json 缺少 slug（請回「預覽 JSON」重產）。'; return false; }
      return true;
    }
    const ghBar=qs('#ghBar2'), ghPct=qs('#ghPct2');
    qs('#btnUploadGithub')?.addEventListener('click', async ()=>{
      const st=qs('#ghStatus'); st.textContent=''; if(!validateAll(st)){ setProgress(ghBar,ghPct,0); return; }
      const owner=qs('#ghOwner').value.trim(), repo=qs('#ghRepo').value.trim(), branch=qs('#ghBranch').value.trim(), base=(qs('#ghBase').value||'').trim().replace(/\/$/,''), token=qs('#ghTok').value.trim();
      const msg=qs('#ghMsg').value.trim()||'Add JSON';
      if(!owner||!repo||!branch||!token){ st.textContent='[錯誤] 請填 owner / repo / branch / token'; return; }
      const cat=qs('#cat').value.trim(), slug=qs('#slug').value.trim();
      const root = (base ? base : 'data') + `/${cat}/${slug}`;
      const files=[
        {name:`${root}/index-${slug}.json`, data:qs('#boxIndex').value},
        {name:`${root}/cues-${slug}.json`,  data:qs('#boxCues').value},
        {name:`${root}/quiz-${slug}.json`,  data:qs('#boxQuiz').value},
        {name:`${root}/vocab-${slug}.json`, data:qs('#boxVocab').value},
        {name:`${root}/ai-${slug}.json`,    data:qs('#boxAI').value},
      ];
      let i=0;
      try{
        for(const f of files){ i++; st.textContent+=`[${i}/5] 上傳 ${f.name}...\n`; await ghPut({owner,repo,branch,token,path:f.name,content:f.data,message:msg}); ghBar.style.width=`${Math.round(i/5*100)}%`; ghPct.textContent=`${Math.round(i/5*100)}%`; await sleep(120); }
        st.textContent+='完成。';
      }catch(e){ st.textContent+=`[失敗] ${e.message||e}`; ghBar.style.width='0%'; ghPct.textContent='0%'; }
    });
  })();
  </script>
</body>
</html>





















































































