<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BookWide Admin · v20251107-full-tabs-supa</title>
<style>
  :root{--brand:#2563eb;--ok:#16a34a;--warn:#f59e0b;--err:#ef4444;--muted:#6b7280}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; background:#fafafa; color:#111827}
  header{display:flex; align-items:center; gap:12px; padding:14px 18px; background:#fff; border-bottom:1px solid #e5e7eb;}
  header h1{font-size:18px; margin:0; font-weight:700}
  .tabs{display:flex; gap:8px; margin-left:auto}
  .tabs button{border:1px solid #d1d5db; background:#fff; padding:8px 12px; border-radius:8px; cursor:pointer}
  .tabs button.active{background:#eef2ff; border-color:#c7d2fe; color:#1d4ed8; font-weight:600}
  main{max-width:1180px; margin:24px auto; padding:0 16px}
  section{display:none; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:18px; }
  section.active{display:block}
  h2{font-size:18px; margin:0 0 14px}
  .row{display:flex; gap:14px; flex-wrap:wrap}
  .col{flex:1 1 320px}
  label{display:block; font-size:13px; color:#374151; margin:8px 0 6px}
  input[type=text],input[type=number],select,textarea{
    width:100%; box-sizing:border-box; padding:10px 12px; border:1px solid #d1d5db; border-radius:10px; background:#fff; font-size:14px;
  }
  textarea{min-height:120px; font-family:ui-monospace,Consolas,monospace}
  .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:999px; border:0; cursor:pointer; font-weight:600}
  .btn.primary{background:var(--brand); color:#fff}
  .btn.ok{background:var(--ok); color:#fff}
  .btn.ghost{background:#fff; border:1px solid #d1d5db}
  .muted{color:var(--muted); font-size:12px}
  .pill{display:inline-block; font-size:12px; padding:3px 8px; border-radius:999px; background:#eef2ff; color:#1d4ed8; margin-left:6px}
  .bar{height:6px; background:#e5e7eb; border-radius:3px; overflow:hidden}
  .bar>i{display:block; height:6px; width:0}
  .bar.ok>i{background:var(--ok)}
  .bar.blue>i{background:var(--brand)}
  pre.log{background:#f9fafb; padding:10px; border-radius:10px; font-size:12px; white-space:pre-wrap; border:1px solid #e5e7eb}
  .kbd{font:12px ui-monospace,Consolas,monospace; background:#111827; color:#fff; padding:2px 6px; border-radius:6px}
  .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:14px}
</style>
</head>
<body>
<header>
  <h1>BookWide Admin 主控台</h1>
  <span class="pill">v20251107-full-tabs-supa</span>
  <div class="tabs">
    <button class="active" data-tab="tab3">MP4 上傳 + JSON + GitHub + Supabase</button>
    <button data-tab="tab1">使用者清單</button>
    <button data-tab="tab2">授權 / 暫停管理員</button>
  </div>
</header>

<main>
  <!-- TAB 3: MP4 + 字幕 + JSON + GitHub + Supabase -->
  <section id="tab3" class="active">
    <h2>MP4 上傳自動化（含字幕匯入、JSON 預覽、GitHub/Supabase 上傳）</h2>

    <div class="grid">
      <div class="col">
        <label>分類</label>
        <select id="cat">
          <option value="story">story</option>
          <option value="music" selected>music</option>
          <option value="movie">movie</option>
          <option value="news">news</option>
          <option value="pro">pro</option>
        </select>
      </div>
      <div class="col">
        <label>Slug（不含空白與副檔名）</label>
        <input id="slug" type="text" placeholder="例如 applesong" />
      </div>
      <div class="col">
        <label>顯示標題（可空）</label>
        <input id="title" type="text" placeholder="例如 A Little Love" />
      </div>
    </div>

    <div class="grid" style="margin-top:10px">
      <div class="col">
        <label>MP4 檔（可拖拉到此處）</label>
        <input id="mp4File" type="file" accept="video/mp4" />
      </div>
      <div class="col">
        <label>封面（可選）</label>
        <input id="coverFile" type="file" accept="image/*" />
      </div>
      <div class="col">
        <label>字幕檔（可選，支援 TXT / SRT / VTT / JSON）</label>
        <input id="subFile" type="file" accept=".txt,.srt,.vtt,.json" />
      </div>
    </div>

    <div class="grid" style="margin-top:10px">
      <div class="col">
        <label>中/日文產生模式</label>
        <div>
          <label><input type="radio" name="mt" value="simple" checked /> 簡易（只產生 en，zh/ja 先留空）</label><br/>
          <label><input type="radio" name="mt" value="edge" /> 機翻（Edge Function 名稱）：</label>
          <input id="edgeFn" type="text" value="mt-translate" />
          <div class="muted">（保留欄位，之後接上你現有的 Edge Function 即可）</div>
        </div>
      </div>
      <div class="col">
        <label>吸附窗參數（可選）</label>
        <div class="row" style="gap:8px">
          <div class="col">
            <label>RMS 門檻</label>
            <input id="rms" type="number" value="0.008" step="0.001">
          </div>
          <div class="col">
            <label>最短靜音（秒）</label>
            <input id="minSil" type="number" value="0.25" step="0.05">
          </div>
          <div class="col">
            <label>窗口(±s)</label>
            <input id="win" type="number" value="1.5" step="0.1">
          </div>
        </div>
        <div class="muted">（這組僅作為參考/保留，不影響基本字幕匯入）</div>
      </div>
    </div>

    <div style="margin-top:14px">
      <button id="btnPreview" class="btn ghost">預覽 JSON（5 件）</button>
    </div>

    <div class="grid" style="margin-top:12px">
      <div class="col">
        <label>index-*.json</label>
        <textarea id="boxIndex" placeholder="index"></textarea>
      </div>
      <div class="col">
        <label>cues-*.json（en/zh/ja 三語同檔）</label>
        <textarea id="boxCues" placeholder="cues"></textarea>
      </div>
      <div class="col">
        <label>vocab-*.json</label>
        <textarea id="boxVocab" placeholder="vocab"></textarea>
      </div>
      <div class="col">
        <label>quiz-*.json</label>
        <textarea id="boxQuiz" placeholder="quiz"></textarea>
      </div>
      <div class="col">
        <label>ai-*.json（15 題）</label>
        <textarea id="boxAI" placeholder="ai 15 題"></textarea>
      </div>
    </div>

    <hr style="margin:18px 0"/>

    <!-- Supabase -->
    <h2>Supabase 上傳（影片＋封面）</h2>
    <div class="grid">
      <div class="col">
        <label>Supabase URL（可空，優先使用 window.BW?.supa）</label>
        <input id="supaUrl" type="text" placeholder="https://xxxx.supabase.co">
      </div>
      <div class="col">
        <label>Supabase anon key（可空）</label>
        <input id="supaKey" type="text" placeholder="eyJhbGciOi...">
      </div>
      <div class="col">
        <label>影片桶名</label>
        <input id="bucketVideo" type="text" value="videos">
      </div>
      <div class="col">
        <label>封面桶名</label>
        <input id="bucketAsset" type="text" value="assets">
      </div>
    </div>

    <div style="margin-top:12px">
      <button id="btnSupaUpload" class="btn ok">上傳到 Supabase（影片＋封面）</button>
    </div>

    <div id="supaStatus" style="margin-top:10px"></div>

    <hr style="margin:18px 0"/>

    <!-- GitHub upload -->
    <h2>GitHub 上傳設定（僅本機暫存，不會保存）</h2>
    <div class="grid">
      <div class="col">
        <label>Owner（使用者或組織）</label>
        <input id="ghOwner" type="text" value="bookwide">
      </div>
      <div class="col">
        <label>Repo</label>
        <input id="ghRepo" type="text" value="EduEnglish">
      </div>
      <div class="col">
        <label>Branch</label>
        <input id="ghBranch" type="text" value="main">
      </div>
      <div class="col">
        <label>Base Path（可留空；例如 data/）</label>
        <input id="ghBase" type="text" value="data/">
      </div>
      <div class="col">
        <label>Commit 訊息</label>
        <input id="ghMsg" type="text" value="Add JSON templates">
      </div>
      <div class="col">
        <label>GitHub Token（Classic PAT，需含 repo + workflow）</label>
        <input id="ghTok" type="text" placeholder="ghp_xxx">
      </div>
    </div>
    <div style="margin-top:12px">
      <button id="btnGH" class="btn primary">上傳到 GitHub（5 件）</button>
      <span class="muted">路徑：basePath/data/{category}/{slug}/</span>
    </div>
    <pre id="ghLog" class="log" style="margin-top:10px"></pre>
  </section>

  <!-- TAB 1: 使用者清單（占位，已接回頁籤） -->
  <section id="tab1">
    <h2>使用者清單</h2>
    <div class="muted">此分頁保留原先功能（拉 Supabase profiles）。你先把主流程跑通，我再幫你接回完整查詢。 </div>
  </section>

  <!-- TAB 2: 授權 / 暫停管理員（占位） -->
  <section id="tab2">
    <h2>授權 / 暫停管理員</h2>
    <div class="muted">此分頁保留原先功能（授權、暫停/啟用）。主流程完成後再補全。 </div>
  </section>
</main>

<script>
/* ---------- 小工具 ---------- */
const $=sel=>document.querySelector(sel);
const $$=sel=>document.querySelectorAll(sel);
const text = el => (el?.value||'').trim();
function setActiveTab(id){
  $$('.tabs button').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
  $$('main section').forEach(s=>s.classList.toggle('active', s.id===id));
}
$$('.tabs button').forEach(b=>b.addEventListener('click',()=>setActiveTab(b.dataset.tab)));

/* ---------- 字幕解析：TXT / SRT / VTT / JSON ---------- */
async function readFileString(file){
  if(!file) return '';
  return await file.text();
}
function srtTimeToSec(t){ // "00:01:23,456" or "00:01:23.456"
  if(!t) return 0;
  const m = t.replace(',', '.').match(/(\d+):(\d+):(\d+(?:\.\d+)?)/);
  if(!m) return 0;
  return (+m[1])*3600 + (+m[2])*60 + (+m[3]);
}
function parseSRT(s){
  const blocks = s.replace(/\r/g,'').trim().split(/\n\n+/);
  const out=[];
  for(const b of blocks){
    const lines=b.split('\n');
    if(lines.length<2) continue;
    let i=0;
    if(/^\d+$/.test(lines[0])) i=1;
    const ts=lines[i]||'';
    const mm=ts.match(/(\d+:\d+:\d+[.,]\d+)\s*-->\s*(\d+:\d+:\d+[.,]\d+)/);
    if(!mm) continue;
    const ssec=srtTimeToSec(mm[1]), esec=srtTimeToSec(mm[2]);
    const text = lines.slice(i+1).join(' ').trim();
    out.push({s:ssec,e:esec,en:text,zh:'',ja:'',t:text});
  }
  return out;
}
function parseVTT(v){ // 很像 SRT
  return parseSRT(v.replace(/^WEBVTT[^\n]*\n/,''));
}
function parseTXT(t){
  // 簡單：一行一句，時間以 4 秒遞增（可之後換成 RMS 切句）
  const lines=t.replace(/\r/g,'').split('\n').map(l=>l.trim()).filter(Boolean);
  const out=[];
  let s=0;
  for(const ln of lines){
    out.push({s, e:s+4, en:ln, zh:'', ja:'', t:ln});
    s+=4;
  }
  return out;
}
function ensureCuesLang(cues, mode){
  // mode: 'simple' -> zh/ja 留空； 'edge' -> 先留空（預留呼叫 Edge 的欄位）
  return cues.map(x=>({
    s:+(x.s||0), e:+(x.e||Math.max((+x.s||0)+3, (+x.s||0))), 
    en: x.en ?? x.t ?? '', 
    zh: x.zh ?? '', 
    ja: x.ja ?? '', 
    t: (x.en ?? x.t ?? '')
  }));
}

/* ---------- 產出 5 件 JSON ---------- */
function buildIndex({cat,slug,title,videoUrl='',coverUrl=''}){
  return {
    slug, title: title||slug,
    category: cat,
    video: videoUrl,
    cover: coverUrl,
    updated_at: new Date().toISOString()
  }
}
function buildVocab(cues){
  // 從英文句子抓可能的詞（非常簡化，給你後續人工編輯）
  const set=new Set();
  for(const c of cues){
    (c.en||'').split(/[^A-Za-z'-]+/).forEach(w=>{
      if(w && w.length>=4) set.add(w.toLowerCase());
    });
  }
  const arr=[...set].slice(0,20).map(w=>({word:w, meaning:"", example:""}));
  return {vocab:arr};
}
function buildQuiz(cues){
  // 依據 5 句抽 5 題（選擇題樣板）
  const arr=[];
  for(let i=0;i<Math.min(5,cues.length);i++){
    arr.push({
      type:"mc",
      q:`What does this line mean?`,
      ref:cues[i].en||'',
      options:["Statement","Question","Feeling","Action"],
      answer:0
    });
  }
  return {quiz:arr};
}
function buildAI15(slug,title){
  const topics=[];
  const base = [
    "Describe the song.",
    "What do you like about it?",
    "Share your memory.",
    "Who do you sing with?",
    "What is the main message?",
    "Find two rhymes.",
    "Paraphrase one line.",
    "What feeling does it give?",
    "Create a new verse.",
    "Which word is repeated?",
    "Who is speaking?",
    "When does it happen?",
    "Where does it happen?",
    "What is the conflict?",
    "How does it end?"
  ];
  for(let i=0;i<15;i++){
    topics.push({ title:`Topic ${i+1}`, prompt:base[i], hint:"", sample:"" });
  }
  return { title: (title||slug||'Lesson'), topics };
}

/* ---------- 預覽 JSON（5件） ---------- */
$('#btnPreview').addEventListener('click', async ()=>{
  const cat = text($('#cat'));
  const slug = text($('#slug'));
  if(!slug){ alert('請先輸入 Slug'); return; }

  const mode = (document.querySelector('input[name="mt"]:checked')?.value)||'simple';
  const title = text($('#title'));

  // 1) 字幕解析
  let cues=[];
  const f = $('#subFile').files[0];
  if(f){
    const s = await readFileString(f);
    if(f.name.endsWith('.srt')) cues = parseSRT(s);
    else if(f.name.endsWith('.vtt')) cues = parseVTT(s);
    else if(f.name.endsWith('.json')) { try{ cues = JSON.parse(s) }catch(e){ cues=[] } }
    else cues = parseTXT(s);
  }else{
    // 沒上傳字幕時，給三行模板，方便你後續編輯
    cues = [
      {s:0,e:4,en:"Line 01 (edit me)",zh:"",ja:"",t:"Line 01 (edit me)"},
      {s:4,e:8,en:"Line 02 (edit me)",zh:"",ja:"",t:"Line 02 (edit me)"},
      {s:8,e:12,en:"Line 03 (edit me)",zh:"",ja:"",t:"Line 03 (edit me)"},
    ];
  }
  cues = ensureCuesLang(cues, mode);

  // 2) 五件
  const idx = buildIndex({cat,slug,title});
  const vocab = buildVocab(cues);
  const quiz = buildQuiz(cues);
  const ai = buildAI15(slug,title);

  // 3) 回填 textarea
  $('#boxIndex').value = JSON.stringify(idx,null,2);
  $('#boxCues').value  = JSON.stringify(cues,null,2);
  $('#boxVocab').value = JSON.stringify(vocab,null,2);
  $('#boxQuiz').value  = JSON.stringify(quiz,null,2);
  $('#boxAI').value    = JSON.stringify(ai,null,2);

  alert('已產生 5 件 JSON 預覽，請向下捲動查看。');
});

/* ---------- Supabase：上傳（影片＋封面）＋進度條 ---------- */
// 這裡用 XHR 監聽進度（supabase-js 是 fetch 封裝，沒有原生 progress 事件）
function getSupaClient(){
  // 優先採用 window.BW?.supa（你現有頁面若已注入）
  const auto = (window.BW && window.BW.supa) ? window.BW.supa : null;
  const supabaseUrl = text($('#supaUrl')) || auto?.url;
  const supabaseKey = text($('#supaKey')) || auto?.anonKey;
  if(!supabaseUrl || !supabaseKey) return null;
  return {
    supabaseUrl, supabaseKey,
    publicUrl(bucket, path){ return `${supabaseUrl}/storage/v1/object/public/${bucket}/${encodeURI(path)}`; }
  };
}

$('#btnSupaUpload').addEventListener('click', async ()=>{
  const st=$('#supaStatus'); st.innerHTML='';
  const mp4 = $('#mp4File').files[0];
  if(!mp4){ st.innerHTML='<div style="color:var(--err)">[錯誤] 請先選擇 MP4 檔。</div>'; return; }

  const cat = text($('#cat'));
  const slug = text($('#slug')) || (mp4.name.replace(/\.\w+$/,''));
  $('#slug').value = slug;

  const client = getSupaClient();
  if(!client){ st.innerHTML='<div style="color:var(--err)">[錯誤] 找不到 Supabase 連線（BW.supa 或手動 URL/KEY）。</div>'; return; }

  const bucketV = text($('#bucketVideo'))||'videos';
  const bucketA = text($('#bucketAsset'))||'assets';
  const pathV = `${cat}/${slug}.mp4`;
  const cover = $('#coverFile').files[0];
  const pathC = `${cat}/${slug}/cover.jpg`;

  st.innerHTML = `
    <div style="margin:6px 0 10px"><b>影片上傳進度：</b> <span id="pv">0%</span>
      <div class="bar ok" style="margin-top:4px"><i id="barV"></i></div>
    </div>
    <div style="margin:6px 0 10px"><b>封面上傳進度：</b> <span id="pc">0%</span>
      <div class="bar blue" style="margin-top:4px"><i id="barC"></i></div>
    </div>
    <pre id="slog" class="log"></pre>
  `;
  const log = m => $('#slog').textContent += m+'\n';

  // 影片
  try{
    const vUrl = await new Promise((resolve,reject)=>{
      const xhr = new XMLHttpRequest();
      xhr.open('POST', `${client.supabaseUrl}/storage/v1/object/${bucketV}/${encodeURI(pathV)}`);
      xhr.setRequestHeader('Authorization', `Bearer ${client.supabaseKey}`);
      xhr.upload.onprogress=(e)=>{
        if(e.lengthComputable){
          const p = Math.round(e.loaded/e.total*100);
          $('#pv').textContent = p + '%';
          $('#barV').style.width = p + '%';
        }
      };
      xhr.onload = ()=>{
        if(xhr.status===200 || xhr.status===201){
          const pub = client.publicUrl(bucketV, pathV);
          log(`影片完成：${pub}`);
          resolve(pub);
        }else reject(xhr.responseText||xhr.statusText);
      };
      xhr.onerror=()=>reject('影片上傳失敗');
      const form = new FormData(); form.append('file', mp4); xhr.send(form);
    });

    // 回填 index.json 的 video
    try{
      const idx = JSON.parse($('#boxIndex').value||'{}');
      idx.video = vUrl; 
      $('#boxIndex').value = JSON.stringify(idx,null,2);
    }catch(e){}

  }catch(e){ log('❌ '+e); }

  // 封面
  if(cover){
    try{
      const cUrl = await new Promise((resolve,reject)=>{
        const xhr = new XMLHttpRequest();
        xhr.open('POST', `${client.supabaseUrl}/storage/v1/object/${bucketA}/${encodeURI(pathC)}`);
        xhr.setRequestHeader('Authorization', `Bearer ${client.supabaseKey}`);
        xhr.upload.onprogress=(e)=>{
          if(e.lengthComputable){
            const p = Math.round(e.loaded/e.total*100);
            $('#pc').textContent = p + '%';
            $('#barC').style.width = p + '%';
          }
        };
        xhr.onload = ()=>{
          if(xhr.status===200 || xhr.status===201){
            const pub = client.publicUrl(bucketA, pathC);
            log(`封面完成：${pub}`);
            resolve(pub);
          }else reject(xhr.responseText||xhr.statusText);
        };
        xhr.onerror=()=>reject('封面上傳失敗');
        const form = new FormData(); form.append('file', cover); xhr.send(form);
      });

      try{
        const idx = JSON.parse($('#boxIndex').value||'{}');
        idx.cover = cUrl; 
        $('#boxIndex').value = JSON.stringify(idx,null,2);
      }catch(e){}

    }catch(e){ log('❌ '+e); }
  }else{
    log('未選封面，略過。');
  }

  log('✅ 上傳流程結束。');
});

/* ---------- GitHub：PUT /repos/:owner/:repo/contents/:path ---------- */
async function ghPutFile({owner,repo,branch,token,path,content,message}){
  const url=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(path)}`;
  const body={ message, branch, content: btoa(unescape(encodeURIComponent(content))) };
  const r = await fetch(url, {
    method:'PUT',
    headers:{ 'Authorization':'token '+token, 'Content-Type':'application/json' },
    body: JSON.stringify(body)
  });
  if(!r.ok){
    const t=await r.text(); throw new Error(`PUT ${path} 失敗：${r.status} ${t}`);
  }
  return await r.json();
}
$('#btnGH').addEventListener('click', async ()=>{
  const logEl=$('#ghLog'); logEl.textContent='';
  const owner=text($('#ghOwner')), repo=text($('#ghRepo')), branch=text($('#ghBranch'));
  const token=text($('#ghTok')), base=text($('#ghBase'))||'';
  const cat=text($('#cat')), slug=text($('#slug')); if(!slug){ alert('缺 slug'); return; }
  const msg=text($('#ghMsg'))||'Add JSON templates';

  const dir = `${base.replace(/\/?$/,'/')}${cat}/${slug}/`;
  const files=[
    {name:`index-${slug}.json`, box:'#boxIndex'},
    {name:`cues-${slug}.json`,  box:'#boxCues'},
    {name:`vocab-${slug}.json`, box:'#boxVocab'},
    {name:`quiz-${slug}.json`,  box:'#boxQuiz'},
    {name:`ai-${slug}.json`,    box:'#boxAI'}
  ];
  try{
    for(const f of files){
      const content = text($(f.box))||'{}';
      const path = `${dir}${f.name}`;
      logEl.textContent += `↑ ${path} ...\n`;
      await ghPutFile({owner,repo,branch,token,path,content,message:msg});
      logEl.textContent += `✔ 完成：${path}\n`;
    }
    logEl.textContent += '✅ 全部完成！\n';
  }catch(e){
    logEl.textContent += '❌ '+(e.message||e)+'\n';
  }
});
</script>
</body>
</html>


















































































