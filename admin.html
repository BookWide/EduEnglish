<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="bw-fn-base" content="https://jeajrwpmrgczimmrflxo.functions.supabase.co/functions/v1">
<title>BookWide Admin 主控台</title>
<style>
body {font-family: 'Segoe UI', sans-serif; margin: 0; background: #f9f9f9; color: #222;}
header {background: white; border-bottom: 1px solid #ccc; padding: 10px 20px; display: flex; align-items: center; justify-content: space-between;}
button {padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer;}
.btn-blue {background: #2563eb; color: #fff;}
.btn-outline {background: #fff; border: 1px solid #ccc;}
.container {padding: 20px;}
textarea {width: 100%; height: 160px; font-family: monospace; white-space: pre;}
input, select {padding: 6px; border: 1px solid #ccc; border-radius: 6px;}
fieldset {margin-bottom: 20px; border: 1px solid #ddd; padding: 10px; border-radius: 8px; background: white;}
legend {font-weight: bold;}
</style>
</head>
<body>
<header>
  <h2>BookWide Admin 主控台</h2>
  <div>
    <button class="btn-outline">使用者清單</button>
    <button class="btn-outline">授權 / 暫停管理員</button>
    <button class="btn-blue">MP4 上傳</button>
  </div>
</header>
<div class="container">
  <fieldset>
    <legend>MP4 上傳自動化（含字幕匯入、JSON 預覽）</legend>
    <label>分類：</label>
    <select id="category">
      <option value="music">music</option>
      <option value="story">story</option>
      <option value="movie">movie</option>
      <option value="news">news</option>
      <option value="pro">pro</option>
    </select>
    <br><br>
    <label>Slug：</label>
    <input id="slug" placeholder="請輸入短代碼 (如 applesong)" style="width:200px">
    <br><br>
    <label>影片標題：</label>
    <input id="title" placeholder="顯示名稱" style="width:300px">
    <br><br>
    <label>MP4 檔案：</label>
    <input type="file" id="mp4File" accept="video/mp4">
    <br><br>
    <label>封面圖片：</label>
    <input type="file" id="coverFile" accept="image/*">
    <br><br>
    <button id="uploadBtn" class="btn-blue">上傳至 Supabase</button>
    <p id="uploadStatus"></p>
  </fieldset>
  <fieldset>
    <legend>Edge Function 測試</legend>
    <label>Edge Function 名稱：</label>
    <input id="fnName" value="mt-translate" style="width:200px">
    <br><br>
    <button id="testFn" class="btn-outline">測試</button>
    <p id="fnStatus"></p>
  </fieldset>
</div>
<script>
// ✅ 安全版 computeFnBase
function computeFnBase() {
  var metaEl = document.querySelector('meta[name="bw-fn-base"]');
  var meta = metaEl && metaEl.content ? metaEl.content.trim() : '';
  if (meta) {
    var baseMeta = meta.replace(/\/+$/, '');
    return baseMeta;
  }
  return '';
}

// ✅ 上傳處理
async function uploadToSupabase() {
  const slug = document.getElementById('slug').value.trim();
  const category = document.getElementById('category').value.trim();
  if (!slug || !category) {
    alert('請先輸入 slug 與分類');
    return;
  }

  const videoFile = document.getElementById('mp4File').files[0];
  const coverFile = document.getElementById('coverFile').files[0];
  if (!videoFile && !coverFile) {
    alert('請選擇 MP4 或封面檔至少一項');
    return;
  }

  const sbUrl = 'https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public';
  const videoPath = `videos/${category}/${slug}.mp4`;
  const coverPath = `assets/${category}/${slug}.cover.jpg`;
  const status = document.getElementById('uploadStatus');
  status.textContent = '上傳中...';

  try {
    if (videoFile) {
      status.textContent = '[1/2] 上傳影片中...';
      console.log('影片 URL →', sbUrl + '/' + videoPath);
    }
    if (coverFile) {
      status.textContent = '[2/2] 上傳封面中...';
      console.log('封面 URL →', sbUrl + '/' + coverPath);
    }
    status.textContent = '✅ 完成';
  } catch (e) {
    status.textContent = '❌ 上傳失敗: ' + e.message;
  }
}

// ✅ Edge Function 測試
async function testEdgeFn() {
  const base = computeFnBase();
  const fn = document.getElementById('fnName').value.trim();
  const url = base + '/' + fn;
  const status = document.getElementById('fnStatus');
  status.textContent = '測試中...';

  try {
    const res = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({lines:['Hello world'], to:['zh','ja']})});
    const data = await res.json();
    status.textContent = '✅ 成功: ' + JSON.stringify(data);
  } catch (err) {
    status.textContent = '❌ 錯誤: ' + err.message;
  }
}

document.getElementById('uploadBtn').onclick = uploadToSupabase;
document.getElementById('testFn').onclick = testEdgeFn;
</script>
</body>
</html>















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































