<!doctype html>
<html lang="zh-Hant">
<meta name="bw-fn-base" content="https://bookwide.functions.supabase.co/functions/v1">


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin Â· ä¸‰åˆ†é  Â· v20251106-three-tabs-v3</title>
  <script type="module" src="./supa.js?v=20251109g"></script>
  <!-- ä¿®æ­£ UMD é€£çµç©ºç™½ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <style>
    :root{ --bg:#fff; --fg:#111; --muted:#6b7280; --line:#e5e7eb; --brand:#2563eb; --ok:#16a34a; --warn:#f59e0b; --card:#fafafa;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"PingFang TC","Noto Sans TC","å¾®è»Ÿæ­£é»‘é«”",sans-serif}
    header{padding:18px 20px;border-bottom:1px solid var(--line);display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .title{font-size:22px;font-weight:700;margin-right:auto}
    .chip{padding:.35rem .6rem;border-radius:999px;background:#eef2ff;color:#1d4ed8;font-size:12px}
    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab-btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:.5rem 1rem;cursor:pointer}
    .tab-btn.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    .wrap{max-width:1100px;margin:22px auto;padding:0 16px}
    .row{display:grid;gap:14px}
    .grid-2{grid-template-columns: 1fr 1fr}
    @media (max-width:1100px){ .grid-2{grid-template-columns:1fr} }
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px}
    .input, select, textarea{border:1px solid var(--line);border-radius:10px;padding:.6rem .8rem;background:#fff}
    textarea{height:240px;resize:vertical;white-space:pre-wrap;overflow:auto}
    .btn{border:1px solid var(--brand);background:var(--brand);color:#fff;border-radius:10px;padding:.55rem .9rem;cursor:pointer}
    .btn.outline{background:#fff;color:var(--brand)}
    .hint{color:#6b7280;font-size:13px}
    .progress{height:10px;background:#eef2ff;border-radius:99px;overflow:hidden}
    .bar{height:100%;width:0;background:#2563eb;transition:width .2s}
    .pill{display:inline-block;padding:.2rem .5rem;border-radius:999px;border:1px solid var(--line);font-size:12px}
    .pill.ok{color:#16a34a;border-color:#16a34a} .pill.warn{color:#f59e0b;border-color:#f59e0b}
    /* Accordion */
    .acc{border:1px solid var(--line);border-radius:12px;background:#f8fafc}
    .acc .hd{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;cursor:pointer;user-select:none}
    .acc .hd h4{margin:0;font-size:14px}
    .acc .bd{padding:12px;display:block}
    .acc.collapsed .bd{display:none}
    .chev{width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:7px solid #6b7280;transition:transform .2s}
    .acc.collapsed .chev{transform:rotate(-90deg)}
    .stack{display:grid;gap:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0 12px}
    .table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
    .table th,.table td{padding:.7rem .8rem;border-bottom:1px solid var(--line);text-align:left}
    .table th{background:var(--card);font-weight:600}
    .right{display:flex;gap:10px;align-items:center;justify-content:flex-end}
  
/* === Bigger, resizable JSON preview areas === */
.json-preview{
  width:100%;
  height:420px;
  resize:vertical;
  overflow:auto;
  white-space:pre;
  font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
  background:#ffffff;
  color:#111111;
  border:1px solid #cbd5e1;
  border-radius:10px;
  padding:12px;
  line-height:1.5;
}

/* Stretch containers of preview areas */
#panelCues, #panelVocab, #panelAI, #panelQuiz, #panelIndex {
  width:100%;
}

</style>
</head>
<body>
  <header>
    <div class="title">BookWide Admin ä¸»æ§å°</div>
    <span class="chip">ä¸‰åˆ†é  Â· å…§åµŒ Supabase Â· v20251106</span>
    <nav class="tabs">
      <button class="tab-btn active" data-tab="users">ä½¿ç”¨è€…æ¸…å–®</button>
      <button class="tab-btn" data-tab="roles">æˆæ¬Š / æš«åœç®¡ç†å“¡</button>
      <button class="tab-btn" data-tab="mp4">MP4 ä¸Šå‚³</button>
    </nav>
  </header>

  <main class="wrap">
    <!-- ä½¿ç”¨è€…æ¸…å–® -->
    <section id="panel-users">
      <div class="toolbar">
        <input id="q" class="input" style="min-width:260px" placeholder="æœå°‹ Email / é¡¯ç¤ºåç¨±â€¦" />
        <button id="btnRefresh" class="btn outline">é‡æ–°æ•´ç†</button>
        <span class="hint">è³‡æ–™è¡¨ï¼špublic.profiles Â· å°ç£æ™‚å€é¡¯ç¤º Â· 10 åˆ†é˜å…§è¦–ç‚ºã€Œåœ¨ç·šã€ã€‚</span>
      </div>
      <table class="table" id="usersTable">
        <thead><tr><th>Email</th><th>é¡¯ç¤ºåç¨±</th><th>æœ€å¾Œç™»å…¥</th><th>æœ€è¿‘åœ¨ç·š</th><th>ç®¡ç†å“¡</th><th>ç‹€æ…‹</th><th>åˆ°æœŸæ—¥</th></tr></thead>
        <tbody><tr><td colspan="7" class="hint">è¼‰å…¥ä¸­â€¦</td></tr></tbody>
      </table>
    </section>

    <!-- æ¬Šé™ç®¡ç† -->
    <section id="panel-roles" style="display:none">
      <div class="card">
        <div class="row grid-2">
          <div><label class="hint">Email</label><input id="roleEmail" class="input" placeholder="user@example.com"></div>
          <div>
            <label class="hint">å‹•ä½œ</label>
            <select id="roleAction" class="input">
              <option value="grant-admin">æˆäºˆç®¡ç†å“¡</option>
              <option value="revoke-admin">ç§»é™¤ç®¡ç†å“¡</option>
              <option value="pause">æš«åœç™»å…¥</option>
              <option value="unpause">è§£é™¤æš«åœ</option>
            </select>
          </div>
        </div>
        <div class="right" style="margin-top:10px"><button id="btnApplyRole" class="btn">å¥—ç”¨</button></div>
        <div class="hint" style="margin-top:6px">æ›´æ–°æ¬„ä½ï¼š<code>is_admin</code> / <code>is_paused</code></div>
        <div id="roleMsg" class="hint" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- MP4 ä¸Šå‚³ -->
    <section id="panel-mp4" style="display:none">
      <div class="row grid-2">
        <!-- å·¦ï¼šè¡¨å–® + é è¦½ -->
        <div class="card">
          <h3 style="margin:6px 0 14px">MP4 ä¸Šå‚³è‡ªå‹•åŒ–ï¼ˆå«å­—å¹•åŒ¯å…¥ã€JSON é è¦½ï¼‰</h3>

          <div class="row grid-2">
            <div>
              <label class="hint">åˆ†é¡</label>
              <select id="cat" class="input"><option>story</option><option selected>music</option><option>movie</option><option>news</option><option>pro</option></select>
            </div>
            <div><label class="hint">Slug</label><input id="slug" class="input" placeholder="applesong"></div>
          </div>

          <div class="row grid-2" style="margin-top:8px">
            <div><label class="hint">é¡¯ç¤ºæ¨™é¡Œï¼ˆå¯ç©ºï¼‰</label><input id="title" class="input" placeholder="A Little Love"></div>
            <div><label class="hint">å¸é™„çª—ï¼ˆsï¼‰</label><input id="snapWin" class="input" type="number" step="0.05" value="0.25"></div>
          </div>

          <div class="row grid-2" style="margin-top:8px">
            <div><label class="hint">MP4 æª”</label><input id="mp4File" type="file" accept="video/mp4" class="input"></div>
            <div><label class="hint">å°é¢ï¼ˆå»ºè­° JPGï¼‰</label><input id="coverFile" type="file" accept="image/*" class="input"></div>
          </div>
          <div style="margin-top:8px"><label class="hint">å­—å¹•ï¼ˆ.txt / .srt / .vtt / .jsonï¼‰</label><input id="subFile" type="file" accept=".txt,.srt,.vtt,.json" class="input" style="width:100%"></div>

          <div class="row grid-2" style="margin-top:10px">
            <div>
              <label class="hint">ä¸­/æ—¥ ç”¢ç”Ÿæ¨¡å¼</label>
              <div style="display:flex;gap:12px;align-items:center;margin-top:6px">
                <label style="display:flex;gap:6px;align-items:center"><input id="modeSimple" type="radio" name="mtmode" checked> ç°¡æ˜“ï¼ˆåªç”¢ç”Ÿ enï¼‰</label>
                <label style="display:flex;gap:6px;align-items:center"><input id="modeMT" type="radio" name="mtmode"> æ©Ÿç¿»ï¼ˆé€é Edge Functionï¼‰</label>
              </div>
            </div>
            <div>
              <label class="hint">Edge Function åç¨±ï¼ˆé è¨­ mt-translateï¼‰</label>
              <input id="edgeFn" class="input" placeholder="mt-translate" value="mt-translate">
              <div class="hint" style="margin-top:6px">Functions é€£ç·šï¼š<code id="fnBase">æœªåµæ¸¬</code>ã€€<button class="btn outline" id="btnTestFn" style="padding:.25rem .6rem">æ¸¬è©¦</button> <span id="fnMsg" class="hint"></span></div>
            </div>
          </div>

          <div class="right" style="margin-top:10px;gap:8px">
            <button class="btn outline" id="btnCollapseAll">å…¨éƒ¨æ”¶åˆ</button>
            <button class="btn outline" id="btnExpandAll">å…¨éƒ¨å±•é–‹</button>
            <button class="btn" id="btnPreview">é è¦½ JSONï¼ˆ5 ä»¶ï¼‰</button>
          </div>

          <div class="stack" style="margin-top:10px">
            <div class="acc" id="accIndex">
              <div class="hd"><h4>index-<span id="fnSlug1">slug</span>.jsonï¼ˆå½±ç‰‡è³‡è¨Šï¼‰</h4><div class="chev"></div></div>
              <div class="bd"><textarea id="boxIndex" class="json-preview" placeholder="index-<slug>.json é è¦½"></textarea></div>
            </div>
            <div class="acc" id="accCues">
              <div class="hd"><h4>cues-<span id="fnSlug2">slug</span>.jsonï¼ˆä¸‰èªå­—å¹•ï¼‰</h4><div class="chev"></div></div>
              <div class="bd"><textarea id="boxCues" placeholder="cues-*.json" class="json-preview"></textarea></div>
            </div>
            <div class="acc" id="accQuiz">
              <div class="hd"><h4>quiz-<span id="fnSlug3">slug</span>.jsonï¼ˆ80 é¡Œï¼‰</h4><div class="chev"></div></div>
              <div class="bd"><textarea id="boxQuiz" placeholder="quiz-*.json" class="json-preview"></textarea></div>
            </div>
            <div class="acc" id="accVocab">
              <div class="hd"><h4>vocab-<span id="fnSlug4">slug</span>.jsonï¼ˆ20 è©ï¼šè‹±/ä¸­/æ—¥/å®šç¾©/ä¾‹å¥ï¼‰</h4><div class="chev"></div></div>
              <div class="bd"><textarea id="boxVocab" placeholder="vocab-*.json" class="json-preview"></textarea></div>
            </div>
            <div class="acc" id="accAI">
              <div class="hd"><h4>ai-<span id="fnSlug5">slug</span>.jsonï¼ˆAI å•ç­”æ¨¡æ¿ 15 é¡Œï¼‰</h4><div class="chev"></div></div>
              <div class="bd"><textarea id="boxAI" placeholder="ai-*.json" class="json-preview"></textarea></div>
            </div>
          </div>

          <div class="hint" style="margin-top:10px">å­—å¹•ï¼š.txt è¦–ç‚ºã€Œæ¯è¡Œä¸€å¥ã€ï¼›.srt/.vtt æœƒè§£ææ™‚é–“ã€‚ä¸‰èªåŒæª”æ ¼å¼ï¼š<code>[{ time, en, ja, zh }]</code>ã€‚</div>
        </div>

        <!-- å³ï¼šSupabase / GitHub -->
        <div class="card">
          <h3 style="margin:6px 0 14px">Supabase ä¸Šå‚³ï¼ˆå½±ç‰‡ï¼‹å°é¢ï¼‰</h3>
          <div class="row grid-2">
            <div><label class="hint">Supabase URLï¼ˆå¯ç©ºï¼‰</label><input id="sbUrl" class="input" placeholder="https://xxxx.supabase.co"></div>
            <div><label class="hint">Supabase anon keyï¼ˆå¯ç©ºï¼‰</label><input id="sbKey" class="input" placeholder="ey..."></div>
          </div>
          <div class="row grid-2">
            <div><label class="hint">å½±ç‰‡æ¡¶å</label><input id="bucketVideo" class="input" value="videos"></div>
            <div><label class="hint">å°é¢æ¡¶å</label><input id="bucketAsset" class="input" value="assets"></div>
          </div>
          <div class="right" style="margin-top:6px"><button class="btn" id="btnSupaUpload">ä¸Šå‚³åˆ° Supabaseï¼ˆå½±ç‰‡ï¼‹å°é¢ï¼‰</button></div>
          <pre id="supaStatus" class="hint" style="background:#0b10221a;padding:10px;border-radius:8px;margin-top:8px;white-space:pre-wrap"></pre>
          <div class="progress" style="margin-top:6px"><div id="supaBar2" class="bar"></div></div>
          <div id="supaPct2" class="hint" style="margin-top:4px">0%</div>

          <div style="margin:16px 0;height:1px;background:var(--line)"></div>

          <h3 style="margin:6px 0 10px">GitHub ä¸Šå‚³ï¼ˆ5 ä»¶ JSONï¼‰</h3>
          <div class="row grid-2">
            <div><label class="hint">Owner</label><input id="ghOwner" class="input" value="bookwide"></div>
            <div><label class="hint">Repo</label><input id="ghRepo" class="input" value="EduEnglish"></div>
          </div>
          <div class="row grid-2">
            <div><label class="hint">Branch</label><input id="ghBranch" class="input" value="main"></div>
            <div><label class="hint">Base Pathï¼ˆä¾‹ï¼šdata/ï¼‰</label><input id="ghBase" class="input" value="data/"></div>
          </div>
          <div class="row grid-2">
            <div><label class="hint">Commit è¨Šæ¯</label><input id="ghMsg" class="input" value="Add JSON templates"></div>
            <div><label class="hint">GitHub Tokenï¼ˆClassic PATï¼‰</label><input id="ghTok" class="input" placeholder="ghp_xxx"></div>
          </div>
          <div class="right" style="margin-top:6px"><button class="btn" id="btnUploadGithub">ä¸Šå‚³åˆ° GitHubï¼ˆ5 ä»¶ï¼‰</button></div>
          <pre id="ghStatus" class="hint" style="background:#0b10221a;padding:10px;border-radius:8px;margin-top:8px;white-space:pre-wrap"></pre>
          <div class="progress" style="margin-top:6px"><div id="ghBar2" class="bar"></div></div>
          <div id="ghPct2" class="hint" style="margin-top:4px">0%</div>
        </div>
      </div>
    </section>
  </main>

  <footer style="padding:22px 20px;border-top:1px solid var(--line);text-align:center;color:#6b7280">BookWide Admin Â· v20251106-three-tabs-v3</footer>

  <!-- ä¸»é‚è¼¯ï¼ˆå·²æ”¹ï¼šæ¸¬è©¦ payloadã€é è¦½ç”¨æ‰¹æ¬¡æ©Ÿç¿»ã€ç§»é™¤ translateBatchï¼‰ -->
  <script type="module">
    const ready = () => new Promise(r=>{ if (window.BW && window.BW.supa) return r(); const t=setInterval(()=>{ if(window.BW && window.BW.supa){clearInterval(t); r();}},50)});
    await ready();
    await BW.requireAdmin();
    BW.startHeartbeat(2);

    const supa = BW.supa;
    const $ = (q,root=document)=>root.querySelector(q);
    const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));
    const fmtTW = ts => !ts?'':new Date(ts).toLocaleString('zh-TW',{timeZone:'Asia/Taipei',hour12:false});
    const pill = (ok,t,cls)=>{ t=(t!==undefined)?t:(ok?'åœ¨ç·š':'é›¢ç·š'); cls=cls||(ok?'pill ok':'pill'); return '<span class="'+cls+'">'+t+'</span>'; };

    // Tabs
    $$('.tab-btn').forEach(b=>b.addEventListener('click',()=>{
      $$('.tab-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active');
      const t=b.getAttribute('data-tab');
      $('#panel-users').style.display = (t==='users')?'':'none';
      $('#panel-roles').style.display = (t==='roles')?'':'none';
      $('#panel-mp4').style.display   = (t==='mp4')  ?'':'none';
    }));

    // Users
    async function loadProfiles(){
      const tbody = $('#usersTable tbody'); tbody.innerHTML='<tr><td class="hint" colspan="7">è¼‰å…¥ä¸­â€¦</td></tr>';
      const cols='email, display_name, is_admin, is_paused, last_sign_in_at, last_seen_at, expires_at';
      const r=await supa.from('profiles').select(cols).order('email',{ascending:true});
      if(r.error){ tbody.innerHTML='<tr><td class="hint" colspan="7">è®€å–å¤±æ•—ï¼š'+r.error.message+'</td></tr>'; return; }
      const q = ($('#q').value||'').trim().toLowerCase();
      const rows=(r.data||[]).filter(x=> !q || ( (x.email||'').toLowerCase().includes(q) || (x.display_name||'').toLowerCase().includes(q) ));
      if(!rows.length){ tbody.innerHTML='<tr><td class="hint" colspan="7">æ²’æœ‰ç¬¦åˆçš„è³‡æ–™</td></tr>'; return; }
      tbody.innerHTML=rows.map(x=>{
        const online = BW.isOnlineWithin(x.last_seen_at, 10);
        const status = x.is_paused ? '<span class="pill warn">æš«åœ</span>' : '<span class="pill ok">æ­£å¸¸</span>';
        return '<tr>'
          + '<td>'+(x.email||'')+'</td>'
          + '<td>'+(x.display_name||'')+'</td>'
          + '<td>'+(fmtTW(x.last_sign_in_at)||'')+'</td>'
          + '<td>'+(fmtTW(x.last_seen_at)||'')+' &nbsp; '+pill(online)+'</td>'
          + '<td>'+(x.is_admin?'<span class="pill ok">æ˜¯</span>':'<span class="pill">å¦</span>')+'</td>'
          + '<td>'+status+'</td>'
          + '<td>'+(x.expires_at||'')+'</td>'
          + '</tr>';
      }).join('');
    }
    $('#btnRefresh').addEventListener('click',loadProfiles);
    $('#q').addEventListener('input',loadProfiles);
    loadProfiles();

    // ========== MP4 åˆ†é è¼”åŠ© ==========

    const qs=(s,r)=> (r||document).querySelector(s);
    const qsa=(s,r)=> Array.from((r||document).querySelectorAll(s));
    const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
    const b64=(s)=>btoa(unescape(encodeURIComponent(s)));

    // Accordion
    qsa('.acc .hd').forEach(hd=>{
      hd.addEventListener('click',()=> hd.parentElement.classList.toggle('collapsed'));
    });
    qs('#btnCollapseAll')?.addEventListener('click',()=> qsa('.acc').forEach(a=>a.classList.add('collapsed')));
    qs('#btnExpandAll')?.addEventListener('click',()=> qsa('.acc').forEach(a=>a.classList.remove('collapsed')));

    // Functions base
    function computeFnBase(){
      let url = (window.BW?.url) || qs('#sbUrl')?.value || '';
      if(!url && window.BW?.supa?.url) url = window.BW.supa.url;
      let base='';
      try{ const u=new URL(url); base=`${u.protocol}//${u.host.replace('.supabase.co','.functions.supabase.co')}`; }catch(e){}
      qs('#fnBase').textContent = base || 'æœªåµæ¸¬';
      return base;
    }
    computeFnBase();
    qs('#sbUrl')?.addEventListener('input', computeFnBase);

    async function callEdge(fn, payload){
      const base = computeFnBase();
      if(!base){ throw new Error('æœªåµæ¸¬åˆ° Supabase Functions ç«¯é»'); }
      const url = `${base}/${fn}`;
      const headers={'Content-Type':'application/json'};
      try{
        const s = await window.BW?.auth?.getSession?.();
        const jwt = s?.session?.access_token;
        if(jwt) headers['Authorization'] = `Bearer ${jwt}`;
      }catch(e){}
      const r=await fetch(url,{method:'POST',headers,body:JSON.stringify(payload)});
      if(!r.ok){ const t=await r.text(); throw new Error(`Functions HTTP ${r.status} â€“ ${t}`); }
      return await r.json();
    }

    function setSlugLabels(slug){
      ['fnSlug1','fnSlug2','fnSlug3','fnSlug4','fnSlug5'].forEach(id=>{ const el=qs('#'+id); if(el) el.textContent=slug||'slug'; });
    }

    function mmss(i, step=4){ const s=i*step; const m=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${m}:${ss}`; }

    async function parseSubtitleFile(file){
      if(!file) return [];
      const name=file.name.toLowerCase();
      const text=await file.text();
      if(name.endsWith('.json')){
        try{ const arr=JSON.parse(text); if(Array.isArray(arr)&&arr.length&&('time' in arr[0])) return arr.map(x=>({time:x.time,en:x.en||'',ja:x.ja||'',zh:x.zh||''})); }catch(e){}
      }
      if(name.endsWith('.srt')||name.endsWith('.vtt')){
        const lines=text.replace(/\r/g,'').split('\n');
        const out=[]; let cur=null;
        const timeRe=/(\d\d:\d\d:\d\d)[,\.](\d\d\d)\s*-->\s*(\d\d:\d\d:\d\d)[,\.](\d\d\d)/;
        for(const ln of lines){
          const m=timeRe.exec(ln);
          if(m){ cur={time:m[1].slice(0,5), en:''}; continue; }
          if(!ln.trim()){ if(cur){ out.push({...cur,ja:'',zh:''}); cur=null; } }
          else if(cur){ cur.en = (cur.en?cur.en+' ':'') + ln.trim(); }
        }
        if(cur) out.push({...cur,ja:'',zh:''});
        return out;
      }
      const arr=text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      return arr.map((line,i)=>({ time:mmss(i), en:line, ja:'', zh:'' }));
    }

    function tokenizeEn(s){ return (s||'').toLowerCase().replace(/[^a-z0-9' ]/g,' ').split(/\s+/).filter(Boolean); }
    const STOP=new Set(['the','a','an','to','is','are','am','be','and','or','of','in','on','for','with','that','this','it','as','at','by','from','i','you','he','she','we','they','was','were','been','do','did','does','so','but','if','not','no','yes','me','my','your','our','their']);
    function topWords(cues,n=40){
      const freq=new Map();
      for(const c of cues){ for(const w of tokenizeEn(c.en)){ if(w.length<3||STOP.has(w)) continue; freq.set(w,(freq.get(w)||0)+1); } }
      return Array.from(freq.entries()).sort((a,b)=>b[1]-a[1]).slice(0,n).map(x=>x[0]);
    }
    function buildVocabFromCues(cues){
      const keys=topWords(cues,40);
      const set=new Set(); const out=[];
      for(const k of keys){
        if(set.has(k)) continue; set.add(k);
        const sample=(cues.find(c=>c.en.toLowerCase().includes(k))?.en)||(`I use "${k}" in a sentence.`);
        out.push({ en:k, zh:"", ja:"", def_en:"", example_en: sample });
        if(out.length>=20) break;
      }
      return out;
    }

    // ã€Œæ¸¬è©¦ã€æŒ‰éˆ•ï¼šæ”¹ç”¨ {lines:[...]}
    qs('#btnTestFn')?.addEventListener('click', async ()=>{
      const msg=qs('#fnMsg'); msg.textContent='æ¸¬è©¦ä¸­â€¦';
      try{
        const fn=(qs('#edgeFn').value||'mt-translate').trim();
        const j=await callEdge(fn,{ lines: ['Hello world'] });
        msg.textContent = j?.ok ? ('OKï¼š'+(j.result || 'Edge é€£ç·šæˆåŠŸ')) : 'å¤±æ•—';
      }catch(e){ msg.textContent='å¤±æ•—ï¼š'+(e.message||e); }
    });

    // é è¦½ JSONï¼šæ”¹ä¸€æ¬¡é€é™£åˆ—åˆ° Edge å–å¾— zh/ja
    qs('#btnPreview')?.addEventListener('click', async ()=>{
      const cat=qs('#cat').value.trim(), slug=qs('#slug').value.trim(), title=qs('#title').value.trim();
      setSlugLabels(slug);
      const sub=qs('#subFile').files[0];
      const cuesEN=await parseSubtitleFile(sub);
      let zhArr=[], jaArr=[];

      if(qs('#modeMT').checked && cuesEN.length){
        const enArr=cuesEN.map(x=>x.en);
        try{
          // åˆ©ç”¨æœ«æ®µ helperï¼štranslateViaEdgeï¼ˆä¸€æ¬¡å› zh/jaï¼‰
          const { zh, ja } = await translateViaEdge(enArr);
          zhArr = zh; jaArr = ja;
        }catch(e){ qs('#fnMsg').textContent='æ©Ÿç¿»å¤±æ•—ï¼š'+(e.message||e); }
      }

      // 20 è©å½™
      const vocab20 = buildVocabFromCues(cuesEN).map(v=>({ ...v, zh:'', ja:'' }));

      const index = { slug, title, video:`videos/${cat}/${slug}.mp4`, cover:`assets/${cat}/${slug}.cover.jpg`, category:cat, updatedAt:new Date().toISOString() };
      const topics = Array.from({length:20},(_,i)=>({title:`Topic ${i+1}`,prompt:"",hint:"",sample:""}));
      const quiz = { title:"Lesson", topics };
      const cues = cuesEN.map((x,i)=>({...x, zh: zhArr[i]||x.zh||'', ja: jaArr[i]||x.ja||'' }));
      const ai = { tasks: Array.from({length:15},(_,i)=>({q:`Question ${i+1}`,a:""})) };

      qs('#boxIndex').value = JSON.stringify(index, null, 2);
      qs('#boxCues').value  = JSON.stringify(cues,  null, 2);
      qs('#boxQuiz').value  = JSON.stringify(quiz,  null, 2);
      qs('#boxVocab').value = JSON.stringify({words:vocab20}, null, 2);
      qs('#boxAI').value    = JSON.stringify(ai,    null, 2);
    });

    // Supabase upload
    function getClient(){
      if(window.BW?.supa?.createClient) return window.BW.supa.createClient();
      const url=qs('#sbUrl').value.trim(); const key=qs('#sbKey').value.trim();
      if(!url || !key) return null;
      return supabase.createClient(url,key);
    }
    async function supaUpload(bucket, path, file, client){
      const { error } = await client.storage.from(bucket).upload(path, file, { upsert:true, contentType:file.type||undefined });
      if(error) throw error;
      const { data:pub } = client.storage.from(bucket).getPublicUrl(path);
      return pub.publicUrl;
    }
    function setProgress(bar,pct,p){ p=Math.max(0,Math.min(100,Math.round(p))); if(bar) bar.style.width=p+'%'; if(pct) pct.textContent=p+'%'; }
    const supaBar=qs('#supaBar2'), supaPct=qs('#supaPct2');
    qs('#btnSupaUpload')?.addEventListener('click', async ()=>{
      const st=qs('#supaStatus'); st.textContent='';
      const cat=qs('#cat').value.trim(), slug=qs('#slug').value.trim();
      const mp4=qs('#mp4File').files[0], cover=qs('#coverFile').files[0];
      if(!mp4){ st.textContent='[éŒ¯èª¤] è«‹å…ˆé¸æ“‡ MP4 æª”ã€‚'; return; }
      const c=getClient(); if(!c){ st.textContent='[éŒ¯èª¤] æ‰¾ä¸åˆ° Supabase é€£ç·šï¼ˆBW.supa æˆ–æ‰‹å‹• URL/KEYï¼‰ã€‚'; return; }
      const vBucket=qs('#bucketVideo').value.trim()||'videos', aBucket=qs('#bucketAsset').value.trim()||'assets';
      try{
        setProgress(supaBar,supaPct,10); st.textContent+='[1/2] ä¸Šå‚³å½±ç‰‡ä¸­...\n';
        const vUrl=await supaUpload(vBucket, `${cat}/${slug}.mp4`, mp4, c);
        st.textContent+=`    å½±ç‰‡ URL â†’ ${vUrl}\n`; setProgress(supaBar,supaPct,70);
        let cUrl=''; if(cover){ st.textContent+='[2/2] ä¸Šå‚³å°é¢ä¸­...\n'; cUrl=await supaUpload(aBucket, `${cat}/${slug}/cover.jpg`, cover, c); st.textContent+=`    å°é¢ URL â†’ ${cUrl}\n`; } else { st.textContent+='[2/2] æœªé¸å°é¢ï¼Œç•¥éã€‚\n'; }
        setProgress(supaBar,supaPct,100);
        if(qs('#boxIndex').value){ try{ const idx=JSON.parse(qs('#boxIndex').value); if(vUrl) idx.video=vUrl; if(cUrl) idx.cover=cUrl; qs('#boxIndex').value=JSON.stringify(idx,null,2);}catch(e){} }
        st.textContent+='å®Œæˆã€‚';
      }catch(e){ st.textContent+=`[å¤±æ•—] ${e.message||e}`; setProgress(supaBar,supaPct,0); }
    });

    // GitHub upload
    // === GitHub folder helpers (auto-create) ===
function encodePath(p){ return String(p).split('/').filter(Boolean).map(encodeURIComponent).join('/'); }

async function ghExists({owner,repo,branch,token,path}){
  const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(path)}?ref=${encodeURIComponent(branch)}`;
  const r = await fetch(url, { headers:{ 'Authorization': `Bearer ${token}`, 'Accept':'application/vnd.github+json', 'X-GitHub-Api-Version':'2022-11-28' } });
  return r.ok;
}

async function ensureFoldersExist(owner,repo,branch,token,dirPath){
  const parts = String(dirPath).split('/').filter(Boolean);
  let curr = '';
  for (const p of parts){
    curr = curr ? `${curr}/${p}` : p;
    if (!(await ghExists({owner,repo,branch,token,path:curr}))){
      await ghPut({ owner,repo,branch,token, path: `${curr}/.keep`, content: 'keep', message: `init ${curr}` });
    }
  }
}

async function ghPut({owner,repo,branch,token,path,content,message}){
  // å…ˆå˜—è©¦å–å¾—èˆŠæª” shaï¼ˆè‹¥ä¸å­˜åœ¨æœƒæ˜¯ nullï¼‰
  let sha = null;
  try{
    const getUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(path)}?ref=${encodeURIComponent(branch)}`;
    const r1 = await fetch(getUrl, { headers:{
      'Authorization': `Bearer ${token}`,
      'Accept': 'application/vnd.github+json',
      'X-GitHub-Api-Version':'2022-11-28'
    }});
    if (r1.ok){
      const j = await r1.json();
      sha = j && j.sha || null;
    }
  }catch(_){}

  const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(path)}`;
  const body = { message, branch, content: btoa(unescape(encodeURIComponent(content))) };
  if (sha) body.sha = sha;

  const r = await fetch(url, {
    method:'PUT',
    headers:{
      'Authorization': `Bearer ${token}`,
      'Accept': 'application/vnd.github+json',
      'Content-Type':'application/json',
      'X-GitHub-Api-Version':'2022-11-28'
    },
    body: JSON.stringify(body)
  });
  if (!r.ok){
    const t = await r.text();
    throw new Error(`HTTP ${r.status} â€“ ${t}`);
  }
  return await r.json();
}function parseBox(id){ try{ return JSON.parse(qs(id).value||''); }catch(e){ return null; } }
    function validateAll(st){
      const index=parseBox('#boxIndex'), cues=parseBox('#boxCues'), quiz=parseBox('#boxQuiz'), vocab=parseBox('#boxVocab'), ai=parseBox('#boxAI');
      if(!index||!cues||!quiz||!vocab||!ai){ st.textContent='[éŒ¯èª¤] äº”ä»½ JSON éœ€å…¨éƒ¨ç”¢ç”Ÿï¼ˆè«‹å…ˆæŒ‰ã€Œé è¦½ JSONã€ï¼‰'; return false; }
      return true;
    }
    const ghBar=qs('#ghBar2'), ghPct=qs('#ghPct2');
    qs('#btnUploadGithub')?.addEventListener('click', async ()=>{
      const st=qs('#ghStatus'); st.textContent='';
      if(!validateAll(st)){ setProgress(ghBar,ghPct,0); return; }
      const owner=qs('#ghOwner').value.trim(), repo=qs('#ghRepo').value.trim(), branch=qs('#ghBranch').value.trim(), base=(qs('#ghBase').value||'').trim(), token=qs('#ghTok').value.trim();
      const msg=qs('#ghMsg').value.trim()||'Add JSON';
      if(!owner||!repo||!branch||!token){ st.textContent='[éŒ¯èª¤] è«‹å¡« owner / repo / branch / token'; return; }
      const slugVal=qs('#slug').value.trim(); if(!slugVal){ st.textContent='[éŒ¯èª¤] Slug ä¸å¯ç©ºï¼ˆè«‹åœ¨å·¦å´å¡«å¯« slug ä¸¦é‡æ–°ç”¢ç”Ÿ JSONï¼‰'; return; }
      const cat=qs('#cat').value.trim(), slug=qs('#slug').value.trim();
      const root = (base ? base.replace(/\/$/,'') : 'data') + `/${cat}/${slug}`;
      await ensureFoldersExist(owner, repo, branch, token, root);
      const files=[
        {name:`${root}/index-${slug}.json`, data:qs('#boxIndex').value},
        {name:`${root}/cues-${slug}.json`,  data:qs('#boxCues').value},
        {name:`${root}/quiz-${slug}.json`,  data:qs('#boxQuiz').value},
        {name:`${root}/vocab-${slug}.json`, data:qs('#boxVocab').value},
        {name:`${root}/ai-${slug}.json`,    data:qs('#boxAI').value},
      ];
      let i=0;
      try{
        for(const f of files){ i++; st.textContent+=`[${i}/5] ä¸Šå‚³ ${f.name}...\n`; await ghPut({owner,repo,branch,token,path:f.name,content:f.data,message:msg}); ghBar.style.width=`${Math.round(i/5*100)}%`; ghPct.textContent=`${Math.round(i/5*100)}%`; await sleep(150); }
        st.textContent+='å®Œæˆã€‚';
      }catch(e){ st.textContent+=`[å¤±æ•—] ${e.message||e}`; ghBar.style.width='0%'; ghPct.textContent='0%'; }
    });
  </script>

  <!-- æ‰¹æ¬¡æ©Ÿç¿» Helperï¼ˆä¿ç•™ï¼›è¢«é è¦½æµç¨‹å‘¼å«ï¼‰ -->
  <script>
    
  /** ä½ çš„ function ç«¯é»ï¼ˆç¶­æŒä½ å°ˆæ¡ˆçš„å¯¦éš› URLï¼‰ */
  const EDGE_URL = "https://jeajrwpmrgczimmrflxo.functions.supabase.co/functions/v1/mt-translate";

  /** å‘¼å« Edge Functionï¼šè¼¸å…¥è‹±æ–‡é™£åˆ— -> å›å‚³ { zh:[], ja:[] } */
  async function translateViaEdge(enLines) {
    const res = await fetch(EDGE_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Accept": "application/json"            // â†â‘  æ–°å¢é€™è¡Œ
      },
      body: JSON.stringify({
        lines: enLines,
        to: ["zh", "ja"]                         // â†â‘¡ æ–°å¢é€™è¡Œï¼ˆä¸€å®šè¦æœ‰ï¼‰
      })
    });
    const json = await res.json();
    if (!json.ok) throw new Error(json.error || "Edge translation failed");
    // ä½ çš„ Edge ç›®å‰å›å‚³ results é™£åˆ—ï¼›é€™è£¡è½‰æˆ { zh:[], ja:[] } æ–¹ä¾¿å¾Œé¢ä½¿ç”¨
    const zh = (json.results?.find(r => r.lang === "zh")?.lines) || [];
    const ja = (json.results?.find(r => r.lang === "ja")?.lines) || [];
    return { zh, ja };
  }
</script>

<!-- BW Single-Edge Final v20251108: force single mt-translate -->
<script>
(function(){
  window.MT_FN = 'mt-translate';

  const _origCallEdge = typeof window.callEdge === 'function' ? window.callEdge : null;
  if (_origCallEdge && !_origCallEdge.__bwWrapped) {
    const wrapped = async function(fn, payload){
      try { return await _origCallEdge(window.MT_FN, payload); }
      catch (e) { throw e; }
    };
    wrapped.__bwWrapped = true;
    window.callEdge = wrapped;
  }

  window.BW_EDGE = window.BW_EDGE || {};
  if (typeof window.BW_EDGE.translate !== 'function') {
    window.BW_EDGE.translate = async function(lines, to){
      if (typeof window.callEdge === 'function') {
        return await window.callEdge(window.MT_FN, { lines: Array.isArray(lines)?lines:[], to: to||['zh','ja'] });
      }
      const meta = document.querySelector('meta[name="bw-fn-base"]');
      let base = meta && meta.content ? meta.content.trim() : '';
      if (!base) {
        try {
          const url = (window.BW && window.BW.supa && window.BW.supa.url) || '';
          if (url) {
            const u = new URL(url);
            base = u.protocol + '//' + u.host.replace('.supabase.co', '.functions.supabase.co') + '/functions/v1';
          }
        } catch(e){}
      }
      if (!base) throw new Error('æœªåµæ¸¬åˆ° Functions ç«¯é»ï¼Œè«‹åœ¨ <head> æ”¾å…¥ <meta name="bw-fn-base" content="https://.../functions/v1">');
      const url = base.replace(/\/+$/,'') + '/' + window.MT_FN;
      const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ lines: Array.isArray(lines)?lines:[], to: to||['zh','ja'] }) });
      const j = await res.json().catch(()=>({}));
      if (!res.ok) throw new Error('Edge å¤±æ•—ï¼š' + (j?.error?.message || j?.message || res.status));
      return j;
    };
  }

  console.info('[BW Single-Edge v20251108] Ready â†’', window.MT_FN);
})();
</script>


<!-- ===== BookWide: TTS æ‰¹é‡ç”Ÿæˆå·¥å…· (2025-11-12) ===== -->
<style>
  .bw-tts-card{
    margin: 24px 0; padding: 16px 14px; border: 1px dashed #ffd24a;
    background: rgba(255,210,74,.08); border-radius: 14px;
  }
  .bw-tts-row{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
  .bw-tts-row label{ font-size:14px; opacity:.9; }
  .bw-tts-input{ padding:6px 10px; border:1px solid #334155; border-radius:10px; background:#0b1324; color:#e5e7eb; }
  .bw-tts-btn{
    padding:8px 14px; border-radius:12px; border:1px solid #3c7cff; background:#0e1a36; color:#dbeafe;
    cursor:pointer;
  }
  .bw-tts-btn:hover{ background:#13224a; }
  .bw-tts-log{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    background:#0b0f1a; border:1px solid #223; border-radius:10px; padding:10px; margin-top:12px; max-height:240px; overflow:auto; font-size:12px; }
  .bw-tts-badge{ padding:2px 8px; border-radius:999px; border:1px solid #3c7cff; color:#9ec5ff; font-size:12px; }
  @media (max-width:768px){
    .bw-tts-row{ gap:10px; }
    .bw-tts-input{ flex:1 1 160px; }
  }
</style>

<section id="tts-batch-tools" class="bw-tts-card">
  <div class="bw-tts-row" style="justify-content:space-between; margin-bottom:10px;">
    <div style="display:flex; gap:10px; align-items:center;">
      <strong style="color:#ffd24a;">ğŸ”Š æ‰¹é‡ TTS ç”¢ç”Ÿï¼ˆä¸Šå‚³åˆ° assets/audioï¼‰</strong>
      <span class="bw-tts-badge">ja / en / zh</span>
    </div>
    <small style="opacity:.75;">è‹¥å·²å­˜åœ¨åŒå mp3 æœƒè‡ªå‹•è¦†è“‹ï¼ˆupsertï¼‰</small>
  </div>

  <div class="bw-tts-row" style="margin-bottom:10px;">
    <label>åˆ†é¡</label>
    <select id="ttsCat" class="bw-tts-input">
      <option value="story">story</option>
      <option value="music">music</option>
      <option value="movie">movie</option>
      <option value="news">news</option>
      <option value="pro">pro</option>
    </select>

    <label>Slug</label>
    <input id="ttsSlug" class="bw-tts-input" placeholder="ä¾‹å¦‚ï¼šhouyi" style="min-width:160px;">

    <label>èªè¨€</label>
    <label><input type="checkbox" class="ttsLang" value="ja" checked> æ—¥æ–‡ ja-JP</label>
    <label><input type="checkbox" class="ttsLang" value="en"> è‹±æ–‡ en-US</label>
    <label><input type="checkbox" class="ttsLang" value="zh"> ä¸­æ–‡ zh-TW</label>

    <button id="btnRunTTS" class="bw-tts-btn">ç”¢ç”ŸéŸ³æª” â†’ ä¸Šå‚³ Supabase</button>
  </div>

  <div class="bw-tts-row" style="gap:8px; margin-bottom:6px; opacity:.8;">
    <small>æœƒå‘¼å« Edge Functionï¼š<code>/functions/v1/tts-batch</code>ï¼ˆBody: <code>{ cat, category, slug, lang }</code>ï¼‰</small>
  </div>

  <pre id="ttsLog" class="bw-tts-log">ready.</pre>
</section>

<script>
(function(){
  const elCat  = document.getElementById('ttsCat');
  const elSlug = document.getElementById('ttsSlug');
  const elBtn  = document.getElementById('btnRunTTS');
  const elLog  = document.getElementById('ttsLog');
  const langCbs= Array.from(document.querySelectorAll('.ttsLang'));

  // Try to reuse existing globals
  const SUPA_URL = window.SUPABASE_URL || window.SUPA_URL || (typeof SUPABASE_URL !== 'undefined' ? SUPABASE_URL : '');
  if (!SUPA_URL){
    elLog.textContent += "\n[!] ç„¡æ³•æ‰¾åˆ° SUPABASE_URL è®Šæ•¸ï¼Œè«‹åœ¨é é¢ä¸­å®šç¾© SUPABASE_URLã€‚";
  }

  function log(msg){
    elLog.textContent += "\\n" + msg;
    elLog.scrollTop = elLog.scrollHeight;
  }

  function langFolder(v){
    if (!v) return 'ja';
    if (v.startsWith('ja')) return 'ja';
    if (v.startsWith('zh')) return 'zh';
    return 'en';
  }

  async function runOnce(cat, slug, lang){
    const body = { cat, category: cat, slug, lang };
    const url  = `${SUPA_URL}/functions/v1/tts-batch`;
    log(`â†’ POST ${url} :: ${JSON.stringify(body)}`);
    const r = await fetch(url, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    const text = await r.text();
    if (!r.ok){
      log(`âœ— ${lang} å¤±æ•—ï¼šHTTP ${r.status} ${text}`);
      throw new Error(text);
    }
    log(`âœ“ ${lang} å®Œæˆï¼š${text}`);
    const folder = langFolder(lang);
    const probe = `${SUPA_URL}/storage/v1/object/public/assets/audio/${cat}/${slug}/${folder}/00.mp3`;
    log(`   è©¦æ’­é¦–æª”ï¼š${probe}`);
  }

  elBtn?.addEventListener('click', async ()=>{
    const cat  = (elCat.value || 'story').trim();
    const slug = (elSlug.value || '').trim();
    if (!slug){ alert('è«‹å¡«å…¥ slug'); return; }
    const langs = langCbs.filter(cb=>cb.checked).map(cb=>cb.value);
    if (!langs.length){ alert('è«‹è‡³å°‘å‹¾é¸ 1 ç¨®èªè¨€'); return; }

    elBtn.disabled = true; elBtn.textContent = 'è™•ç†ä¸­â€¦';
    log(`=== é–‹å§‹ï¼š${cat}/${slug} ===`);
    for (const l of langs){
      try { await runOnce(cat, slug, l); }
      catch(e){ /* keep going next */ }
    }
    log(`=== çµæŸ ===`);
    elBtn.disabled = false; elBtn.textContent = 'ç”¢ç”ŸéŸ³æª” â†’ ä¸Šå‚³ Supabase';
  });

  // å¦‚æœä½ çš„é é¢å·²æœ‰ slug/category æ¬„ä½ï¼Œè©¦è‘—è‡ªå‹•å¸¶å…¥
  try {
    const existCat  = document.querySelector('#category, [name="category"]');
    const existSlug = document.querySelector('#slug, [name="slug"]');
    if (existCat && !elCat.value)  elCat.value  = existCat.value || 'story';
    if (existSlug && !elSlug.value) elSlug.value = existSlug.value || '';
  } catch(e){}
})();
</script>
<!-- ===== /BookWide: TTS æ‰¹é‡ç”Ÿæˆå·¥å…· ===== -->

</body>
</html>















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































<script type="module">
// === BW Admin Full-Wired v20251110 ===
const qs = sel => document.querySelector(sel);

function getFnBase(){
  const m = document.querySelector('meta[name="bw-fn-base"]');
  const base = (m?.content||'').replace(/\/+$/,'');
  if(!base) throw new Error('Functions base not found (<meta name="bw-fn-base">)');
  return base;
}
async function getJWT(){
  try{
    if (window.supabase?.auth?.getSession) {
      const { data } = await window.supabase.auth.getSession();
      return data?.session?.access_token || null;
    }
    if (window.BW?.supa?.auth?.getSession) {
      const { data } = await window.BW.supa.auth.getSession();
      return data?.session?.access_token || null;
    }
  }catch(e){}
  return null;
}
async function callEdgeTranslate(lines, to=['zh','ja']){
  const fn = (qs('#edgeFn')?.value || 'mt-translate').trim();
  const url = `${getFnBase()}/${fn}`;
  const headers = {'Content-Type':'application/json'};
  const jwt = await getJWT();
  if (jwt) headers.Authorization = `Bearer ${jwt}`;
  const r = await fetch(url, { method:'POST', headers, body: JSON.stringify({ lines, to }) });
  const j = await r.json().catch(()=>({}));
  if (!r.ok || j?.ok===false) throw new Error(j?.error?.message || `HTTP ${r.status}`);
  // æ”¯æ´ä½ çš„ Edge å…©ç¨®å›å‚³ï¼š{zh,ja} æˆ– {results:[{lang,lines}...]}
  const zh = j.zh || j.results?.find(x=>x.lang==='zh')?.lines || [];
  const ja = j.ja || j.results?.find(x=>x.lang==='ja')?.lines || [];
  return { zh, ja, input: j.input || lines };
}

// ---------- subtitle parsing helpers (very simple) ----------
function parseSubFile(file){
  return new Promise((resolve,reject)=>{
    if(!file) return resolve([]);
    const reader=new FileReader();
    reader.onload = () => {
      const txt = String(reader.result||'');
      const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      resolve(lines.map((en,i)=>({ time: toClock(i*4), en })));
    };
    reader.onerror=()=>reject(reader.error);
    reader.readAsText(file);
  });
}
function toClock(s){ s=Math.max(0,Math.round(+s||0)); const mm=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${mm}:${ss}`; }

// ---------- build five JSON ----------
function buildIndex({title,category,slug,video,cover}){
  return { title, category, slug, video, cover,
    cues:{ zh:`./cues-${slug}.json`},
    vocab:`./vocab-${slug}.json`,
    quiz:`./quiz-${slug}.json`,
    ai:`./ai-${slug}.json`,
    is_public:true };
}
function topWords(enLines, limit=20){
  const stop=new Set("the a an to is are am was were be been being i you he she it we they me my your our their his her its this that these those of for and or but if not no yes in on at by from with as do does did have has had can will would should could just really very there here then than so because while after before into out up down over under again more most some any every each few many much own same other another".split(" "));
  const freq={};
  for(const ln of enLines){
    for(const raw of ln.toLowerCase().replace(/[^a-z' ]/g,' ').split(' ')){
      const w=raw.trim();
      if(!w||w.length<3||stop.has(w)) continue;
      freq[w]=(freq[w]||0)+1;
    }
  }
  return Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,limit).map(x=>x[0]);
}
function buildVocab(enLines, zh, ja){
  const words=topWords(enLines,20);
  const pickLine=(w)=> enLines.find(l=>l.toLowerCase().includes(w)) || `${w} ${enLines[0]||''}`;
  return words.map(w=>({ en:w, zh:"", ja:"", def_en:"", example_en: pickLine(w) }));
}
function buildQuiz(enLines, zh, ja){
  const stop=new Set("the a an to is are am was were be been being i you he she it we they me my your our their his her its this that these those of for and or but if not no yes in on at by from with as do does did have has had can will would should could just really very there here then than so because while after before into out up down over under again more most some any every each few many much own same other another".split(" "));
  const words = topWords(enLines,20);
  const quiz=[];
  // 20 MCQ
  for(const w of words){
    const opts=[w, w+'s', w+'ing', w+'ly'].sort(()=>Math.random()-0.5);
    quiz.push({ section:"Vocabulary", type:"MCQ", question:"Choose the word that appears in the song: ____", options:opts, answer:w, explanation:`'${w}' appears in lyrics.`});
  }
  // 20 Fill-in
  const chooseBlank=(ln)=>{
    const toks=(ln.match(/[A-Za-z']+/g)||[]).filter(t=>t.length>=3 && !stop.has(t.toLowerCase()));
    if(!toks.length) return null; const t=toks[Math.floor(Math.random()*toks.length)];
    return [ln.replace(t,'____'), t];
  };
  let c=0;
  for(const ln of enLines){
    if(c>=20) break;
    const r=chooseBlank(ln); if(!r) continue; c++;
    quiz.push({ section:"Fill-in-the-blank", type:"SA", question:r[0], answer:r[1], explanation:"" });
  }
  // 20 T/F
  for(const w of words){
    quiz.push({ section:"True/False", type:"MCQ", question:`The word '${w}' appears in the song.`, options:["True","False"], answer:"True", explanation:"" });
  }
  // 20 Short Answer
  for(let i=0;i<20;i++){
    quiz.push({ section:"Short Answer", type:"SA", question:`What is one key word or idea from line ${i+1}?`, answer:"", explanation:"" });
  }
  return quiz;
}
function buildAI(){
  return { topics: Array.from({length:15}, (_,i)=>({ title:`Topic ${i+1}`, prompt:"Talk about the meaning or emotion of this lyric line.", hint:"Use simple words and 2-3 sentences.", sample:"" })) };
}

// ---------- preview wiring ----------
qs('#btnPreview')?.addEventListener('click', async ()=>{
  const cat = qs('#cat')?.value?.trim() || 'music';
  const slug = qs('#slug')?.value?.trim() || 'applesong';
  const title= qs('#title')?.value?.trim() || slug;
  const sub = qs('#subFile')?.files?.[0] || null;
  // 1. parse EN lines
  const cuesEN = await parseSubFile(sub);
  if(!cuesEN.length){ alert('è«‹å…ˆé¸æ“‡å­—å¹•/æ­Œè©æª”'); return; }
  const enLines = cuesEN.map(x=>x.en);
  // 2. translate if checked
  let zh=[], ja=[];
  if (qs('#modeMT')?.checked){
    try{ ({zh,ja} = await callEdgeTranslate(enLines)); }catch(e){ alert('æ©Ÿç¿»å¤±æ•—ï¼š'+(e.message||e)); }
  }
  // 3. build cues
  const cues = cuesEN.map((r,i)=>({ time:r.time, en:r.en, zh: zh[i]||"", ja: ja[i]||"" }));
  // 4. vocab/quiz/ai/index
  const vocab = buildVocab(enLines, zh, ja);
  const quiz  = buildQuiz(enLines, zh, ja);
  const ai    = buildAI();
  const meta  = { title, category:cat, slug, video:"", cover:"" };
  const index = buildIndex(meta);
  // 5. show in preview textareas
  const set = (id,obj)=>{ const el=qs(id); if(el) el.value = JSON.stringify(obj, null, 2); };
  set('#out-index', index);
  set('#out-cues', cues);
  set('#out-vocab', vocab);
  set('#out-quiz', quiz);
  set('#out-ai', ai);
  alert('é è¦½å·²ç”¢ç”Ÿï¼ˆ5 ä»¶ï¼‰');
});

// ---------- GitHub upload wiring ----------
async function ghExists({owner,repo,branch,token,path}){
  const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(path)}?ref=${encodeURIComponent(branch)}`;
  const r = await fetch(url, { headers:{
    'Authorization': `Bearer ${token}`,
    'Accept': 'application/vnd.github+json',
    'X-GitHub-Api-Version':'2022-11-28'
  }});
  return r.ok;
}
async function ghPut({owner,repo,branch,token,path,content,message}){
  // get sha
  let sha=null;
  try{
    const getUrl=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(path)}?ref=${encodeURIComponent(branch)}`;
    const r1=await fetch(getUrl,{ headers:{'Authorization':`Bearer ${token}`,'Accept':'application/vnd.github+json','X-GitHub-Api-Version':'2022-11-28'}});
    if(r1.ok){ const j=await r1.json(); sha=j?.sha||null; }
  }catch(_){}
  const url=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(path)}`;
  const body={ message, content:btoa(unescape(encodeURIComponent(typeof content==='string'?content:JSON.stringify(content,null,2)))), branch };
  if (sha) body.sha = sha;
  const r=await fetch(url,{ method:'PUT', headers:{
    'Authorization': `Bearer ${token}`,
    'Accept':'application/vnd.github+json',
    'X-GitHub-Api-Version':'2022-11-28',
    'Content-Type':'application/json'
  }, body: JSON.stringify(body) });
  if(!r.ok){ const t=await r.text(); throw new Error(`HTTP ${r.status} â€“ ${t}`); }
  return await r.json();
}
function joinPath(base, rel){
  const a = String(base||'').replace(/^\/+|\/+$/g,'');
  const b = String(rel||'').replace(/^\/+/,'');
  return (a? (a+'/'+b): b);
}
qs('#btnUploadGithub')?.addEventListener('click', async ()=>{
  const owner = qs('#ghOwner')?.value?.trim();
  const repo  = qs('#ghRepo')?.value?.trim();
  const branch= qs('#ghBranch')?.value?.trim() || 'main';
  const base  = qs('#ghBase')?.value || '';
  const msg   = qs('#ghMsg')?.value || 'Add JSON';
  const token = qs('#ghTok')?.value?.trim();
  if(!owner||!repo||!token){ alert('è«‹å¡« Owner/Repo/Token'); return; }
  // read preview areas
  const getObj = (id)=>{ try{ return JSON.parse(qs(id).value); }catch(_){ return null; } };
  const index = getObj('#out-index');
  const cues  = getObj('#out-cues');
  const vocab = getObj('#out-vocab');
  const quiz  = getObj('#out-quiz');
  const ai    = getObj('#out-ai');
  if(!index||!cues||!vocab||!quiz||!ai){ alert('è«‹å…ˆæŒ‰ã€Œé è¦½ JSONï¼ˆ5 ä»¶ï¼‰ã€ç”¢ç”Ÿå…§å®¹'); return; }
  const cat=index.category, slug=index.slug;
  const dir = joinPath(base, `data/${cat}/${slug}`.replace(/^data\//,'')); // é˜²é‡è¤‡ data/
  const files=[
    ['index-'+slug+'.json', index],
    ['cues-'+slug+'.json', cues],
    ['vocab-'+slug+'.json', vocab],
    ['quiz-'+slug+'.json', quiz],
    ['ai-'+slug+'.json', ai],
  ];
  // ensure folders (by creating .keep)
  const keepPath = joinPath(dir, '.keep');
  try{ await ghPut({owner,repo,branch,token,path:keepPath,content:'keep',message:`init ${dir}`}); }catch(_){}
  // upload files
  let ok=0, fail=0, log=[];
  for(let i=0;i<files.length;i++){
    const [name, obj] = files[i];
    const path = joinPath(dir, name);
    try{
      await ghPut({ owner,repo,branch,token, path, content: obj, message: msg });
      ok++; log.push(`[${i+1}/5] OK ${path}`);
    }catch(e){
      fail++; log.push(`[${i+1}/5] å¤±æ•— ${path} â€“ ${e.message}`);
    }
  }
  alert(`GitHub ä¸Šå‚³å®Œæˆï¼šOK ${ok} / å¤±æ•— ${fail}\n` + log.join('\n'));
});
</script>
