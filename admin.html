<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BookWide Admin ¬∑ admin_final.html</title>
<style>
:root{
  --bg:#0b1324;--panel:#121a2e;--bd:#1e2945;--fg:#e7eeff;--muted:#9fb0d0;
  --primary:#3c7cff;--green:#1ec28b;--amber:#ffc043;--red:#ff6b6b;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,'Noto Sans TC',sans-serif}
.wrap{max-width:1200px;margin:28px auto;padding:0 16px}
h1{margin:0 0 16px;font-size:22px}
.tabs{display:flex;gap:8px;margin:6px 0 16px}
.tab{padding:10px 14px;border:1px solid var(--bd);background:var(--panel);border-radius:12px;cursor:pointer}
.tab.active{background:#172448;border-color:#2a3962}
.panel{display:none;border:1px solid var(--bd);background:var(--panel);border-radius:14px;padding:16px}
.panel.active{display:block}
.row{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin:8px 0}
input[type=text],input[type=file],select{background:#0f1730;border:1px solid var(--bd);color:var(--fg);border-radius:10px;padding:10px 12px;min-width:220px;outline:none}
.btn{background:var(--primary);color:#fff;border:0;border-radius:12px;padding:10px 14px;cursor:pointer}
.btn.gray{background:#2a3656} .btn.green{background:var(--green)} .btn.red{background:var(--red)}
.badge{display:inline-block;background:#172447;border:1px solid #263356;border-radius:999px;padding:6px 10px;margin-left:6px;color:#cfe0ff}
.hr{height:1px;background:#1b2545;margin:14px 0}
.codebox{background:#0f172a;border:1px solid #1e293b;border-radius:12px;padding:12px;white-space:pre-wrap;min-height:120px;max-height:360px;overflow:auto}
table{width:100%;border-collapse:collapse;background:#0f1730;border:1px solid var(--bd);border-radius:12px;overflow:hidden}
th,td{padding:10px;border-bottom:1px solid #1d2745;text-align:left;font-size:14px}
th{background:#152048}
.switch{appearance:none;width:42px;height:24px;border-radius:999px;background:#3b4a74;position:relative;outline:none;cursor:pointer}
.switch:checked{background:#2fbf71} .switch::after{content:'';position:absolute;top:3px;left:3px;width:18px;height:18px;background:#fff;border-radius:999px;transition:.2s} .switch:checked::after{left:21px}
.tip{font-size:13px;color:var(--muted)}
small.muted{color:var(--muted)}
@media (max-width:900px){ .row> * {min-width:unset} }
</style>
</head>
<body>
<div class="wrap">
  <h1>BookWide Admin <span class="badge">‰∏âÂàÜÈ†Å ¬∑ TTS ÊâπÊ¨°</span></h1>
  <div class="tabs">
    <div class="tab active" data-tab="t1">‰ΩøÁî®ËÄÖÊ∏ÖÂñÆ</div>
    <div class="tab" data-tab="t2">ÊéàÊ¨äÔºèÊö´ÂÅúÁÆ°ÁêÜÂì°ÔºàÂê´ TTSÔºâ</div>
    <div class="tab" data-tab="t3">MP4 ‰∏äÂÇ≥</div>
  </div>

  <!-- Tab 1: ‰ΩøÁî®ËÄÖÊ∏ÖÂñÆ -->
  <section id="t1" class="panel active">
    <div class="row">
      <input id="q" type="text" placeholder="ÊêúÂ∞ã email / name‚Ä¶" />
      <button class="btn gray" id="btnRefreshUsers">ÈáçÊñ∞Êï¥ÁêÜ</button>
      <span class="badge">profiles ¬∑ Âç≥ÊôÇËÆÄÂèñ</span>
    </div>
    <div class="hr"></div>
    <table id="tblUsers">
      <thead><tr><th>Email</th><th>ÂêçÁ®±</th><th>ÁÆ°ÁêÜÂì°</th><th>Êö´ÂÅú</th><th>ÊúÄËøëÁôªÂÖ•</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="hr"></div>
    <div id="logUsers" class="codebox"></div>
  </section>

  <!-- Tab 2: ÊéàÊ¨äÔºèÊö´ÂÅúÁÆ°ÁêÜÂì° + TTS ÊâπÊ¨° -->
  <section id="t2" class="panel">
    <h2 style="margin:4px 0 10px">ÊéàÊ¨äÔºèÊö´ÂÅúÁÆ°ÁêÜÂì°</h2>
    <div class="row">
      <input id="roleEmail" type="text" placeholder="user@example.com"/>
      <select id="roleAction">
        <option value="grant_admin">Êéà‰∫àÁÆ°ÁêÜÂì°</option>
        <option value="revoke_admin">Êí§Èä∑ÁÆ°ÁêÜÂì°</option>
        <option value="pause_user">Êö´ÂÅú‰ΩøÁî®ËÄÖ</option>
        <option value="resume_user">ÊÅ¢Âæ©‰ΩøÁî®ËÄÖ</option>
      </select>
      <button class="btn gray" id="btnRoleApply">Â•óÁî®</button>
      <span class="badge">v20251112</span>
    </div>

    <div class="hr"></div>

    <h3 style="margin:6px 0 8px">üîä TTS ÊâπÊ¨°Áî¢Áîü MP3Ôºà‰∏äÂÇ≥Âà∞ <code>assets/audio/</code>Ôºâ</h3>
    <div class="tip">‰∏ÄÊ¨°Âè™Âãæ‰∏ÄÁ®ÆË™ûË®ÄÔºà‰Ω†Ë™™Ë¶ÅÂàÜ‰∏âÊ¨°ÊÖ¢ÊÖ¢‰∏ãÔºâ„ÄÇ‰æÜÊ∫êÂ≠óÂπïÔºö<code>/EduEnglish/data/&lt;cat&gt;/cues-&lt;slug&gt;.json</code></div>
    <div class="row">
      <label>ÂàÜÈ°û</label>
      <select id="ttsCat">
        <option value="story">story</option>
        <option value="music">music</option>
        <option value="movie">movie</option>
        <option value="news">news</option>
        <option value="pro">pro</option>
      </select>
      <label>Slug</label>
      <input id="ttsSlug" type="text" placeholder="‰æãÂ¶ÇÔºöhouyi" value="houyi"/>
      <label class="tip">Ë™ûË®ÄÔºö</label>
      <label><input type="checkbox" id="chkJa"> Êó•Êñá ja-JP</label>
      <label><input type="checkbox" id="chkEn"> Ëã±Êñá en-US</label>
      <label><input type="checkbox" id="chkZh"> ‰∏≠Êñá zh-TW</label>
      <button class="btn" id="btnBatch">Áî¢ÁîüÈü≥Ê™î ‚Üí ‰∏äÂÇ≥ Supabase</button>
    </div>
    <div class="hr"></div>
    <div class="tip"><b>ÁãÄÊÖãËº∏Âá∫</b>ÔºàÊúÄÊñ∞Âú®ÊúÄ‰∏äÔºâÔºö</div>
    <div id="log" class="codebox"></div>
  </section>

  <!-- Tab 3: MP4 ‰∏äÂÇ≥ -->
  <section id="t3" class="panel">
    <h2 style="margin:4px 0 10px">MP4 ‰∏äÂÇ≥</h2>
    <div class="row">
      <label>ÂàÜÈ°û</label>
      <select id="vCat">
        <option value="story">story</option>
        <option value="music">music</option>
        <option value="movie">movie</option>
        <option value="news">news</option>
        <option value="pro">pro</option>
      </select>
      <label>Slug</label>
      <input id="vSlug" type="text" placeholder="‰æãÂ¶ÇÔºöhouyi" value="houyi"/>
      <label>ÂΩ±Áâá (mp4)</label>
      <input id="fileMp4" type="file" accept="video/mp4"/>
      <label>Â∞ÅÈù¢ (jpg/png)</label>
      <input id="fileCover" type="file" accept="image/*"/>
      <button class="btn" id="btnUpload">‰∏äÂÇ≥</button>
    </div>
    <div class="tip">ÂΩ±Áâá ‚Üí <code>videos/&lt;cat&gt;/&lt;slug&gt;.mp4</code>ÔºõÂ∞ÅÈù¢ ‚Üí <code>assets/&lt;cat&gt;/&lt;slug&gt;.cover.jpg</code></div>
    <div class="hr"></div>
    <div id="logUp" class="codebox"></div>
  </section>
</div>

<script>
/* ===== Âü∫Êú¨Ë®≠ÂÆö ===== */
const SUPABASE_URL = "{SUPABASE_URL}";
const SUPABASE_ANON_KEY = "{SUPABASE_ANON_KEY}";

const $ = (s)=>document.querySelector(s);
function log(boxSel, msg, kind='ok') {
  const box = $(boxSel); if(!box) return;
  const t = new Date().toTimeString().slice(0,8);
  const color = kind==='err' ? '#ff6b6b' : (kind==='warn' ? '#ffc043' : '#86efac');
  box.insertAdjacentHTML('afterbegin', `<div style="color:${color}">[${t}] ${msg}</div>`);
}
function switchTab(t){
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  document.getElementById(t.dataset.tab).classList.add('active');
}
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>switchTab(t)));

/* ===== ‰ΩøÁî®ËÄÖÊ∏ÖÂñÆ ===== */
async function fetchUsers(){
  const q = $('#q').value.trim();
  let url = `${SUPABASE_URL}/rest/v1/profiles?select=email,display_name,is_admin,is_paused,last_sign_in_at,updated_at&order=updated_at.desc`;
  if(q) url += `&or=(email.ilike.*${encodeURIComponent(q)}*,display_name.ilike.*${encodeURIComponent(q)}*)`;
  const res = await fetch(url, { headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}` } });
  if(!res.ok){ log('#logUsers', `ËÆÄÂèñÂ§±ÊïóÔºö${res.status} ${await res.text()}`, 'err'); return; }
  const rows = await res.json();
  const tb = $('#tblUsers tbody'); tb.innerHTML='';
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.email||''}</td>
      <td>${r.display_name||''}</td>
      <td><input type="checkbox" class="swAdmin switch" ${r.is_admin?'checked':''} data-email="${r.email}"></td>
      <td><input type="checkbox" class="swPause switch" ${r.is_paused?'checked':''} data-email="${r.email}"></td>
      <td>${r.last_sign_in_at||''}</td>`;
    tb.appendChild(tr);
  });
}
async function updateFlag(email, field, val){
  const url = `${SUPABASE_URL}/rest/v1/profiles?email=eq.${encodeURIComponent(email)}`;
  const res = await fetch(url, {
    method:'PATCH',
    headers:{ apikey: SUPABASE_ANON_KEY, Authorization:`Bearer ${SUPABASE_ANON_KEY}`, 'Content-Type':'application/json', 'Prefer':'return=representation' },
    body: JSON.stringify({ [field]: val, updated_at: new Date().toISOString() })
  });
  if(!res.ok) log('#logUsers', `Êõ¥Êñ∞Â§±ÊïóÔºö${await res.text()}`, 'err');
  else log('#logUsers', `Â∑≤Êõ¥Êñ∞ ${email} ‚Üí ${field}=${val}`, 'ok');
}
$('#btnRefreshUsers').addEventListener('click', fetchUsers);
$('#q').addEventListener('keydown', e=>{ if(e.key==='Enter') fetchUsers(); });
$('#tblUsers').addEventListener('change', e=>{
  const t = e.target;
  if(t.classList.contains('swAdmin')) updateFlag(t.dataset.email,'is_admin',t.checked);
  if(t.classList.contains('swPause')) updateFlag(t.dataset.email,'is_paused',t.checked);
});

/* ===== ÊéàÊ¨äÂãï‰Ωú ===== */
$('#btnRoleApply').addEventListener('click', async ()=> {
  const email = $('#roleEmail').value.trim();
  const act   = $('#roleAction').value;
  if(!email){ log('#log', 'Ë´ãËº∏ÂÖ• Email', 'warn'); return; }
  let field=null, val=null;
  if(act==='grant_admin'){ field='is_admin'; val=true; }
  if(act==='revoke_admin'){ field='is_admin'; val=false; }
  if(act==='pause_user')  { field='is_paused'; val=true; }
  if(act==='resume_user') { field='is_paused'; val=false; }
  if(!field){ log('#log','Êú™Áü•Âãï‰Ωú','warn'); return; }
  try{
    const url = `${SUPABASE_URL}/rest/v1/profiles?email=eq.${encodeURIComponent(email)}`;
    const r = await fetch(url, {
      method:'PATCH',
      headers:{ apikey: SUPABASE_ANON_KEY, Authorization:`Bearer ${SUPABASE_ANON_KEY}`, 'Content-Type':'application/json','Prefer':'return=representation' },
      body: JSON.stringify({ [field]: val, updated_at: new Date().toISOString() })
    });
    const txt = await r.text();
    log('#log', `Êõ¥Êñ∞ ${email} ‚Üí ${field}=${val} ¬∑ status ${r.status} ¬∑ ${txt}`, r.ok?'ok':'err');
  }catch(e){ log('#log', `Êõ¥Êñ∞ÈåØË™§Ôºö${e}`, 'err'); }
});

/* ===== TTS ÊâπÊ¨°Ôºà‰∏ÄÊ¨°Âè™ÂÖÅË®±Âãæ‰∏ÄÁ®ÆË™ûË®ÄÔºâ ===== */
function pickSingleLang(){
  const langs=[];
  if($('#chkJa')?.checked) langs.push('ja-JP');
  if($('#chkEn')?.checked) langs.push('en-US');
  if($('#chkZh')?.checked) langs.push('zh-TW');
  if(langs.length===0) { log('#log','Ë´ãÂãæÈÅ∏‰∏ÄÁ®ÆË™ûË®Ä','err'); return null; }
  if(langs.length>1)   { log('#log','Ë´ã‰∏ÄÊ¨°Âè™Âãæ‰∏ÄÁ®ÆË™ûË®ÄÔºà‰Ω†Ë¶ÅÂàÜ‰∏âÊ¨°Ë∑ëÔºâ','err'); return null; }
  return langs[0];
}
async function fetchCues(cat, slug){
  const url = `/EduEnglish/data/${cat}/cues-${slug}.json`;
  const r = await fetch(url, { cache:'no-store' });
  if(!r.ok) throw new Error(`ËÆÄÂèñÂ≠óÂπïÂ§±ÊïóÔºö${url} (${r.status})`);
  return r.json();
}
function cuesToItems(cues, lang){
  const field = lang.startsWith('ja') ? 'ja' : lang.startsWith('zh') ? 'zh' : 'en';
  return (cues||[]).map((row,i)=>({ index:i, text:String(row[field]||'').trim() })).filter(x=>x.text);
}
async function callTTSBatch({cat,slug,lang,items}){
  const FN = `${SUPABASE_URL}/functions/v1/tts-batch`;
  const r = await fetch(FN, {
    method:'POST',
    headers:{ 'Content-Type':'application/json', apikey: SUPABASE_ANON_KEY, Authorization:`Bearer ${SUPABASE_ANON_KEY}` },
    body: JSON.stringify({ cat, slug, lang, items })
  });
  if(!r.ok){ const err = await r.text().catch(()=>r.statusText); throw new Error(`tts-batch Â§±Êïó (${lang})Ôºö${err}`); }
  return r.json();
}
$('#btnBatch').addEventListener('click', async ()=> {
  try{
    const cat  = $('#ttsCat')?.value || 'story';
    const slug = $('#ttsSlug')?.value?.trim();
    if(!slug){ log('#log','Ë´ãËº∏ÂÖ• slug','err'); return; }
    const lang = pickSingleLang(); if(!lang) return;
    if(!SUPABASE_URL || !SUPABASE_ANON_KEY){ log('#log','Áº∫ SUPABASE_URL / SUPABASE_ANON_KEY','err'); return; }

    log('#log', `ËÆÄÂèñÂ≠óÂπïÔºö/EduEnglish/data/${cat}/cues-${slug}.json`);
    const cues = await fetchCues(cat, slug);
    const items = cuesToItems(cues, lang);
    if(!items.length){ log('#log', `(${lang}) Ê≤íÊúâÂèØËΩâÁöÑÂÖßÂÆπ`, 'err'); return; }

    log('#log', `ÈñãÂßãÁî¢Áîü ${lang}Ôºà${items.length} Âè•Ôºâ‚Ä¶`);
    await callTTSBatch({ cat, slug, lang, items });

    const sub = lang.startsWith('ja') ? 'ja' : lang.startsWith('zh') ? 'zh' : 'en';
    const probe = `${SUPABASE_URL}/storage/v1/object/public/assets/audio/${cat}/${slug}/${sub}/00.mp3`;
    log('#log', `ÂÆåÊàê ${lang} ‚Üí Ë©¶Êí≠Ôºö${probe}`);
  }catch(e){ log('#log', String(e), 'err'); }
});

/* ===== MP4 / Â∞ÅÈù¢‰∏äÂÇ≥Âà∞ Storage ===== */
async function uploadStorage(bucket, path, bytes, type){
  const url = `${SUPABASE_URL}/storage/v1/object/${bucket}/${path}`;
  const res = await fetch(url, { method:'PUT', headers:{ Authorization:`Bearer ${SUPABASE_ANON_KEY}`, 'Content-Type': type, 'x-upsert':'true' }, body: bytes });
  if(!res.ok) throw new Error(await res.text());
  return `${SUPABASE_URL}/storage/v1/object/public/${bucket}/${path}`;
}
$('#btnUpload').addEventListener('click', async ()=> {
  const cat = $('#vCat').value;
  const slug= $('#vSlug').value.trim();
  const fMp4 = $('#fileMp4').files[0];
  const fCover = $('#fileCover').files[0];
  if(!slug){ log('#logUp','Ë´ãËº∏ÂÖ• slug','err'); return; }
  if(!fMp4 && !fCover){ log('#logUp','Ë´ãËá≥Â∞ëÈÅ∏‰∏ÄÂÄãÊ™îÊ°à','err'); return; }
  try{
    if(fMp4){
      const p = `videos/${cat}/${slug}.mp4`; const buf = await fMp4.arrayBuffer();
      const url = await uploadStorage('videos', p, buf, 'video/mp4');
      log('#logUp', `ÂΩ±ÁâáÂ∑≤‰∏äÂÇ≥Ôºö${url}`);
    }
    if(fCover){
      const ext = (fCover.name.split('.').pop()||'jpg').toLowerCase();
      const p = `assets/${cat}/${slug}.cover.${ext}`; const buf = await fCover.arrayBuffer();
      const url = await uploadStorage('assets', p, buf, fCover.type||'image/jpeg');
      log('#logUp', `Â∞ÅÈù¢Â∑≤‰∏äÂÇ≥Ôºö${url}`);
    }
  }catch(e){ log('#logUp', `‰∏äÂÇ≥Â§±ÊïóÔºö${e.message||e}`, 'err'); }
});

/* ===== ÂïüÂãï ===== */
window.addEventListener('load', ()=>{ fetchUsers(); log('#logUsers','‰ΩøÁî®ËÄÖÊ∏ÖÂñÆËºâÂÖ•ÂÆåÊàê','ok'); });
</script>
</body>
</html>

































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































<script type="module">
// === BW Admin Full-Wired v20251110 ===
const qs = sel => document.querySelector(sel);

function getFnBase(){
  const m = document.querySelector('meta[name="bw-fn-base"]');
  const base = (m?.content||'').replace(/\/+$/,'');
  if(!base) throw new Error('Functions base not found (<meta name="bw-fn-base">)');
  return base;
}
async function getJWT(){
  try{
    if (window.supabase?.auth?.getSession) {
      const { data } = await window.supabase.auth.getSession();
      return data?.session?.access_token || null;
    }
    if (window.BW?.supa?.auth?.getSession) {
      const { data } = await window.BW.supa.auth.getSession();
      return data?.session?.access_token || null;
    }
  }catch(e){}
  return null;
}
async function callEdgeTranslate(lines, to=['zh','ja']){
  const fn = (qs('#edgeFn')?.value || 'mt-translate').trim();
  const url = `${getFnBase()}/${fn}`;
  const headers = {'Content-Type':'application/json'};
  const jwt = await getJWT();
  if (jwt) headers.Authorization = `Bearer ${jwt}`;
  const r = await fetch(url, { method:'POST', headers, body: JSON.stringify({ lines, to }) });
  const j = await r.json().catch(()=>({}));
  if (!r.ok || j?.ok===false) throw new Error(j?.error?.message || `HTTP ${r.status}`);
  // ÊîØÊè¥‰Ω†ÁöÑ Edge ÂÖ©Á®ÆÂõûÂÇ≥Ôºö{zh,ja} Êàñ {results:[{lang,lines}...]}
  const zh = j.zh || j.results?.find(x=>x.lang==='zh')?.lines || [];
  const ja = j.ja || j.results?.find(x=>x.lang==='ja')?.lines || [];
  return { zh, ja, input: j.input || lines };
}

// ---------- subtitle parsing helpers (very simple) ----------
function parseSubFile(file){
  return new Promise((resolve,reject)=>{
    if(!file) return resolve([]);
    const reader=new FileReader();
    reader.onload = () => {
      const txt = String(reader.result||'');
      const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      resolve(lines.map((en,i)=>({ time: toClock(i*4), en })));
    };
    reader.onerror=()=>reject(reader.error);
    reader.readAsText(file);
  });
}
function toClock(s){ s=Math.max(0,Math.round(+s||0)); const mm=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${mm}:${ss}`; }

// ---------- build five JSON ----------
function buildIndex({title,category,slug,video,cover}){
  return { title, category, slug, video, cover,
    cues:{ zh:`./cues-${slug}.json`},
    vocab:`./vocab-${slug}.json`,
    quiz:`./quiz-${slug}.json`,
    ai:`./ai-${slug}.json`,
    is_public:true };
}
function topWords(enLines, limit=20){
  const stop=new Set("the a an to is are am was were be been being i you he she it we they me my your our their his her its this that these those of for and or but if not no yes in on at by from with as do does did have has had can will would should could just really very there here then than so because while after before into out up down over under again more most some any every each few many much own same other another".split(" "));
  const freq={};
  for(const ln of enLines){
    for(const raw of ln.toLowerCase().replace(/[^a-z' ]/g,' ').split(' ')){
      const w=raw.trim();
      if(!w||w.length<3||stop.has(w)) continue;
      freq[w]=(freq[w]||0)+1;
    }
  }
  return Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,limit).map(x=>x[0]);
}
function buildVocab(enLines, zh, ja){
  const words=topWords(enLines,20);
  const pickLine=(w)=> enLines.find(l=>l.toLowerCase().includes(w)) || `${w} ${enLines[0]||''}`;
  return words.map(w=>({ en:w, zh:"", ja:"", def_en:"", example_en: pickLine(w) }));
}
function buildQuiz(enLines, zh, ja){
  const stop=new Set("the a an to is are am was were be been being i you he she it we they me my your our their his her its this that these those of for and or but if not no yes in on at by from with as do does did have has had can will would should could just really very there here then than so because while after before into out up down over under again more most some any every each few many much own same other another".split(" "));
  const words = topWords(enLines,20);
  const quiz=[];
  // 20 MCQ
  for(const w of words){
    const opts=[w, w+'s', w+'ing', w+'ly'].sort(()=>Math.random()-0.5);
    quiz.push({ section:"Vocabulary", type:"MCQ", question:"Choose the word that appears in the song: ____", options:opts, answer:w, explanation:`'${w}' appears in lyrics.`});
  }
  // 20 Fill-in
  const chooseBlank=(ln)=>{
    const toks=(ln.match(/[A-Za-z']+/g)||[]).filter(t=>t.length>=3 && !stop.has(t.toLowerCase()));
    if(!toks.length) return null; const t=toks[Math.floor(Math.random()*toks.length)];
    return [ln.replace(t,'____'), t];
  };
  let c=0;
  for(const ln of enLines){
    if(c>=20) break;
    const r=chooseBlank(ln); if(!r) continue; c++;
    quiz.push({ section:"Fill-in-the-blank", type:"SA", question:r[0], answer:r[1], explanation:"" });
  }
  // 20 T/F
  for(const w of words){
    quiz.push({ section:"True/False", type:"MCQ", question:`The word '${w}' appears in the song.`, options:["True","False"], answer:"True", explanation:"" });
  }
  // 20 Short Answer
  for(let i=0;i<20;i++){
    quiz.push({ section:"Short Answer", type:"SA", question:`What is one key word or idea from line ${i+1}?`, answer:"", explanation:"" });
  }
  return quiz;
}
function buildAI(){
  return { topics: Array.from({length:15}, (_,i)=>({ title:`Topic ${i+1}`, prompt:"Talk about the meaning or emotion of this lyric line.", hint:"Use simple words and 2-3 sentences.", sample:"" })) };
}

// ---------- preview wiring ----------
qs('#btnPreview')?.addEventListener('click', async ()=>{
  const cat = qs('#cat')?.value?.trim() || 'music';
  const slug = qs('#slug')?.value?.trim() || 'applesong';
  const title= qs('#title')?.value?.trim() || slug;
  const sub = qs('#subFile')?.files?.[0] || null;
  // 1. parse EN lines
  const cuesEN = await parseSubFile(sub);
  if(!cuesEN.length){ alert('Ë´ãÂÖàÈÅ∏ÊìáÂ≠óÂπï/Ê≠åË©ûÊ™î'); return; }
  const enLines = cuesEN.map(x=>x.en);
  // 2. translate if checked
  let zh=[], ja=[];
  if (qs('#modeMT')?.checked){
    try{ ({zh,ja} = await callEdgeTranslate(enLines)); }catch(e){ alert('Ê©üÁøªÂ§±ÊïóÔºö'+(e.message||e)); }
  }
  // 3. build cues
  const cues = cuesEN.map((r,i)=>({ time:r.time, en:r.en, zh: zh[i]||"", ja: ja[i]||"" }));
  // 4. vocab/quiz/ai/index
  const vocab = buildVocab(enLines, zh, ja);
  const quiz  = buildQuiz(enLines, zh, ja);
  const ai    = buildAI();
  const meta  = { title, category:cat, slug, video:"", cover:"" };
  const index = buildIndex(meta);
  // 5. show in preview textareas
  const set = (id,obj)=>{ const el=qs(id); if(el) el.value = JSON.stringify(obj, null, 2); };
  set('#out-index', index);
  set('#out-cues', cues);
  set('#out-vocab', vocab);
  set('#out-quiz', quiz);
  set('#out-ai', ai);
  alert('È†êË¶ΩÂ∑≤Áî¢ÁîüÔºà5 ‰ª∂Ôºâ');
});

// ---------- GitHub upload wiring ----------
async function ghExists({owner,repo,branch,token,path}){
  const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(path)}?ref=${encodeURIComponent(branch)}`;
  const r = await fetch(url, { headers:{
    'Authorization': `Bearer ${token}`,
    'Accept': 'application/vnd.github+json',
    'X-GitHub-Api-Version':'2022-11-28'
  }});
  return r.ok;
}
async function ghPut({owner,repo,branch,token,path,content,message}){
  // get sha
  let sha=null;
  try{
    const getUrl=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(path)}?ref=${encodeURIComponent(branch)}`;
    const r1=await fetch(getUrl,{ headers:{'Authorization':`Bearer ${token}`,'Accept':'application/vnd.github+json','X-GitHub-Api-Version':'2022-11-28'}});
    if(r1.ok){ const j=await r1.json(); sha=j?.sha||null; }
  }catch(_){}
  const url=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(path)}`;
  const body={ message, content:btoa(unescape(encodeURIComponent(typeof content==='string'?content:JSON.stringify(content,null,2)))), branch };
  if (sha) body.sha = sha;
  const r=await fetch(url,{ method:'PUT', headers:{
    'Authorization': `Bearer ${token}`,
    'Accept':'application/vnd.github+json',
    'X-GitHub-Api-Version':'2022-11-28',
    'Content-Type':'application/json'
  }, body: JSON.stringify(body) });
  if(!r.ok){ const t=await r.text(); throw new Error(`HTTP ${r.status} ‚Äì ${t}`); }
  return await r.json();
}
function joinPath(base, rel){
  const a = String(base||'').replace(/^\/+|\/+$/g,'');
  const b = String(rel||'').replace(/^\/+/,'');
  return (a? (a+'/'+b): b);
}
qs('#btnUploadGithub')?.addEventListener('click', async ()=>{
  const owner = qs('#ghOwner')?.value?.trim();
  const repo  = qs('#ghRepo')?.value?.trim();
  const branch= qs('#ghBranch')?.value?.trim() || 'main';
  const base  = qs('#ghBase')?.value || '';
  const msg   = qs('#ghMsg')?.value || 'Add JSON';
  const token = qs('#ghTok')?.value?.trim();
  if(!owner||!repo||!token){ alert('Ë´ãÂ°´ Owner/Repo/Token'); return; }
  // read preview areas
  const getObj = (id)=>{ try{ return JSON.parse(qs(id).value); }catch(_){ return null; } };
  const index = getObj('#out-index');
  const cues  = getObj('#out-cues');
  const vocab = getObj('#out-vocab');
  const quiz  = getObj('#out-quiz');
  const ai    = getObj('#out-ai');
  if(!index||!cues||!vocab||!quiz||!ai){ alert('Ë´ãÂÖàÊåâ„ÄåÈ†êË¶Ω JSONÔºà5 ‰ª∂Ôºâ„ÄçÁî¢ÁîüÂÖßÂÆπ'); return; }
  const cat=index.category, slug=index.slug;
  const dir = joinPath(base, `data/${cat}/${slug}`.replace(/^data\//,'')); // Èò≤ÈáçË§á data/
  const files=[
    ['index-'+slug+'.json', index],
    ['cues-'+slug+'.json', cues],
    ['vocab-'+slug+'.json', vocab],
    ['quiz-'+slug+'.json', quiz],
    ['ai-'+slug+'.json', ai],
  ];
  // ensure folders (by creating .keep)
  const keepPath = joinPath(dir, '.keep');
  try{ await ghPut({owner,repo,branch,token,path:keepPath,content:'keep',message:`init ${dir}`}); }catch(_){}
  // upload files
  let ok=0, fail=0, log=[];
  for(let i=0;i<files.length;i++){
    const [name, obj] = files[i];
    const path = joinPath(dir, name);
    try{
      await ghPut({ owner,repo,branch,token, path, content: obj, message: msg });
      ok++; log.push(`[${i+1}/5] OK ${path}`);
    }catch(e){
      fail++; log.push(`[${i+1}/5] Â§±Êïó ${path} ‚Äì ${e.message}`);
    }
  }
  alert(`GitHub ‰∏äÂÇ≥ÂÆåÊàêÔºöOK ${ok} / Â§±Êïó ${fail}\n` + log.join('\n'));
});
</script>
