<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin 主控台</title>
  <style>
    :root{
      --bg:#0f1720; --panel:#0b1220; --card:#0e1526; --text:#e6edf3; --muted:#93a4b8;
      --primary:#60a5fa; --accent:#34d399; --warn:#f59e0b; --danger:#ef4444; --ok:#22c55e;
      --chip:#111827; --line:#1f2937;
    }
    html,body{height:100%;}
    body{
      margin:0; font-family: ui-sans-serif,system-ui,"PingFang TC","Noto Sans TC",Segoe UI,Roboto,Helvetica,Arial;
      background:linear-gradient(180deg,var(--bg),#0a1322 60%,#07101f);
      color:var(--text);
    }
    a{color:var(--primary); text-decoration:none}
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(8px);
      background:rgba(7,16,31,.6);
      border-bottom:1px solid #0b1a2f;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:16px 20px;}
    .topbar{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .back{
      display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;
      background:#0a1528;border:1px solid #11213d;color:#cfe5ff
    }
    .title{font-size:20px;font-weight:700;margin-left:8px}
    .badge{font-size:12px;padding:2px 8px;border-radius:100px;background:#13223d;color:#a9c7ff;border:1px solid #1b2d50}

    .tabs{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap}
    .tab-btn{
      padding:10px 14px;border-radius:12px;border:1px solid #143055;background:#0b172a;color:#d9e6ff;cursor:pointer
    }
    .tab-btn.active{background:#0e1d35;border-color:#1c3b6a;box-shadow:0 0 0 1px #1c3b6a inset}
    .panel{
      margin-top:16px;background:#091326;border:1px solid #122341;border-radius:16px;overflow:hidden
    }
    .panel-hd{padding:14px 16px;border-bottom:1px solid #122341;background:#0a172c;color:#cfe5ff;font-weight:600}
    .panel-bd{padding:16px}

    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .input, select, .btn{
      height:40px;border-radius:10px;border:1px solid #1c2d45;background:#0b1426;color:var(--text);padding:0 12px
    }
    .btn{cursor:pointer}
    .btn.primary{background:#11315d;border-color:#1c3b6a}
    .btn.ok{background:#0f2d1f;border-color:#145236;color:#c7f7e4}
    .btn.warn{background:#2a1f0e;border-color:#6a4b17;color:#ffd89e}
    .btn.danger{background:#2a0f14;border-color:#6a1724;color:#ffc6ce}
    .btn.ghost{background:#0b1426;border-color:#1c2d45}
    .chip{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #21314c;background:#0c1528;color:#cfe5ff}

    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px 12px;border-bottom:1px solid #13233b;font-size:14px;vertical-align:top}
    th{color:#a9c7ff;text-align:left;background:#0b162c;position:sticky;top:0}
    tr:hover td{background:#0a162b}
    .muted{color:#94a7bd}
    .row-actions{display:flex;gap:8px;flex-wrap:wrap}
    .note{margin-top:12px;color:#9fb4cc;font-size:13px}
    .hint{font-size:12px;color:#90a3bc}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:840px){ .grid.cols-3{grid-template-columns:1fr} .grid.cols-2{grid-template-columns:1fr} }
    .log{background:#0a1326;border:1px dashed #1d2f51;border-radius:12px;padding:10px 12px;white-space:pre-wrap;max-height:220px;overflow:auto}
    .right{margin-left:auto}
  </style>

  <!-- 初始化 supabase：確保 window.supabase 存在 -->
  <script type="module">
    import { supabase } from './supa.js';
    window.supabase = window.supabase ?? supabase;
  </script>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <a class="back" href="./index.html">← 回首頁</a>
        <div class="title">BookWide Admin 主控台</div>
        <span class="badge">單檔版・不動 index.html</span>
        <div class="right muted hint" id="who"></div>
      </div>

      <div class="tabs">
        <button class="tab-btn active" data-tab="users">使用者清單</button>
        <button class="tab-btn" data-tab="grant">授權 / 暫停管理員</button>
        <button class="tab-btn" data-tab="mp4">MP4 上傳自動化</button>
      </div>
    </div>
  </header>

  <main class="wrap">

    <!-- 使用者清單 -->
    <section class="panel" data-pane="users">
      <div class="panel-hd">使用者清單</div>
      <div class="panel-bd">
        <div class="toolbar">
          <input id="q" class="input" placeholder="搜尋 Email / 顯示名稱…" />
          <button id="btnReload" class="btn primary">重新整理</button>
          <span class="muted hint">最後登入與「最近在線」以台灣時間顯示；10 分鐘內視為在線。</span>
        </div>

        <table>
          <thead>
            <tr>
              <th style="width:28%">Email</th>
              <th style="width:22%">顯示名稱</th>
              <th style="width:16%">最後登入（台灣）</th>
              <th style="width:16%">最近在線（台灣）</th>
              <th style="width:6%">身份</th>
              <th style="width:6%">管理員</th>
              <th style="width:6%">暫停</th>
            </tr>
          </thead>
          <tbody id="userRows">
            <tr><td colspan="7" class="muted">載入中…</td></tr>
          </tbody>
        </table>

        <div class="note">符合 RLS：僅管理員可查看所有人資料。</div>
      </div>
    </section>

    <!-- 授權 / 暫停管理員 -->
    <section class="panel" data-pane="grant" hidden>
      <div class="panel-hd">授權 / 暫停管理員</div>
      <div class="panel-bd">
        <div class="grid cols-3">
          <div>
            <div class="hint">Email（精確比對）</div>
            <input id="g_email" class="input" placeholder="someone@example.com" />
          </div>
          <div>
            <div class="hint">到期日（選填）</div>
            <input id="g_exp" class="input" type="date" />
          </div>
          <div class="grid" style="grid-template-columns:repeat(2,minmax(0,1fr))">
            <button id="btnSetAdmin" class="btn ok">設為管理員</button>
            <button id="btnUnsetAdmin" class="btn ghost">取消管理員</button>
            <button id="btnSuspend" class="btn warn">暫停</button>
            <button id="btnUnsuspend" class="btn ghost">解除暫停</button>
          </div>
        </div>
        <div class="note">寫入 <span class="chip">profiles</span> 欄位：<code>is_admin</code>、<code>suspended</code>、<code>expires_at</code>。</div>
      </div>
    </section>

    <!-- MP4 上傳自動化 -->
    <section class="panel" data-pane="mp4" hidden>
      <div class="panel-hd">MP4 上傳自動化</div>
      <div class="panel-bd">
        <div class="grid cols-2">
          <div>
            <div class="hint">分類</div>
            <select id="cat" class="input">
              <option value="story">story</option>
              <option value="music">music</option>
              <option value="movie">movie</option>
              <option value="news">news</option>
              <option value="pro">pro</option>
            </select>
          </div>
          <div>
            <div class="hint">Slug（不含空白與副檔名）</div>
            <input id="slug" class="input" placeholder="mid-autumn" />
          </div>

          <div>
            <div class="hint">MP4 檔</div>
            <input id="mp4" class="input" type="file" accept="video/mp4" />
          </div>
          <div>
            <div class="hint">封面（可選）</div>
            <input id="cover" class="input" type="file" accept="image/*" />
          </div>
        </div>

        <div class="toolbar" style="margin-top:12px">
          <button id="btnUpload" class="btn primary">上傳</button>
          <button id="btnResetForm" class="btn ghost">重設表單</button>
        </div>

        <div class="hint" style="margin-top:10px">
          會上傳到 Storage：<code>videos/{category}/{slug}.mp4</code>、<code>data/{category}/{slug}/cover.jpg</code>，
          並建立 <span class="chip">assets</span> 紀錄。
        </div>

        <div class="log" id="log" style="margin-top:12px">就緒。</div>
      </div>
    </section>

  </main>

  <script type="module">
    // ------------------- 小工具 -------------------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => [...document.querySelectorAll(sel)];

    const tzTaipei = (isoOrNull) => {
      if(!isoOrNull) return '—';
      try{
        const dt = new Date(isoOrNull);
        return dt.toLocaleString('zh-TW',{ timeZone:'Asia/Taipei', hour12:false });
      }catch{ return '—';}
    };
    const displayNameOf = (r) => r?.display_name || r?.full_name || r?.nickname || r?.email || '—';
    const onlineBadge = (lastSeenAt) => {
      if(!lastSeenAt) return '<span class="chip">離線</span>';
      const diff = Date.now() - new Date(lastSeenAt).getTime();
      return diff <= 10*60*1000
        ? '<span class="chip" style="border-color:#1e5a39;background:#0c1f17;color:#aef7cf">在線</span>'
        : '<span class="chip">離線</span>';
    };

    // ------------------- 分頁 -------------------
    const panes = {users:$('[data-pane="users"]'),grant:$('[data-pane="grant"]'),mp4:$('[data-pane="mp4"]')};
    $$('.tab-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        $$('.tab-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const key = btn.dataset.tab;
        for(const k in panes){ panes[k].hidden = (k!==key); }
        if(key==='users') loadUsers();
      });
    });

    // ------------------- 管理員驗證 -------------------
    let currentUser=null, currentProfile=null;
    async function ensureAdmin(){
      const { data: { user }, error } = await supabase.auth.getUser();
      if(error || !user){ alert('請先登入'); location.href = './index.html?login=1'; return false; }
      currentUser=user;

      // 以多欄位兼容不同 schema
      const { data:prof, error:pe } = await supabase
        .from('profiles')
        .select('id,email,display_name,full_name,nickname,is_admin,suspended,expires_at,last_sign_in_at,last_seen_at')
        .eq('id', user.id)
        .maybeSingle();

      if(pe){ alert('讀取個人資料失敗：'+pe.message); return false; }
      currentProfile=prof||{ email: user.email, is_admin:false };

      $('#who').textContent = `目前登入：${ currentProfile.email || user.email }`;
      if(!currentProfile.is_admin){
        alert('您沒有管理員權限'); location.href='./index.html'; return false;
      }
      return true;
    }

    // ------------------- 使用者清單 -------------------
    $('#btnReload').addEventListener('click', loadUsers);
    $('#q').addEventListener('input', ()=>loadUsers(true));

    async function loadUsers(skipAdminCheck=false){
      if(!skipAdminCheck){
        if(!currentProfile?.is_admin) return;
      }
      const q = $('#q').value?.trim().toLowerCase();
      const tbody = $('#userRows');
      tbody.innerHTML = `<tr><td colspan="7" class="muted">載入中…</td></tr>`;

      const { data, error } = await supabase
        .from('profiles')
        .select('id,email,display_name,full_name,nickname,is_admin,suspended,expires_at,last_sign_in_at,last_seen_at')
        .order('email', { ascending:true });

      if(error){
        tbody.innerHTML = `<tr><td colspan="7" class="muted">讀取失敗：${error.message}</td></tr>`;
        return;
      }
      let rows = data || [];
      if(q){
        const hit = (s)=> (s||'').toLowerCase().includes(q);
        rows = rows.filter(r => hit(r.email) || hit(displayNameOf(r)));
      }
      if(!rows.length){
        tbody.innerHTML = `<tr><td colspan="7" class="muted">沒有符合的資料</td></tr>`;
        return;
      }
      tbody.innerHTML = rows.map(r=>{
        const lastLogin = tzTaipei(r.last_sign_in_at);
        const lastSeen  = tzTaipei(r.last_seen_at);
        return `<tr>
          <td>${r.email||'—'}</td>
          <td>${displayNameOf(r)}</td>
          <td>${lastLogin}</td>
          <td>${lastSeen}　${onlineBadge(r.last_seen_at)}</td>
          <td>${r.suspended ? '<span class="chip" style="border-color:#6a1b1b;background:#2a0f14;color:#ffb3bd">暫停</span>' : '<span class="chip">正常</span>'}</td>
          <td>${r.is_admin ? '✔' : ''}</td>
          <td>${r.suspended ? '✔' : ''}</td>
        </tr>`;
      }).join('');
    }

    // ------------------- 授權/暫停 -------------------
    async function findProfileByEmail(email){
      const { data, error } = await supabase.from('profiles')
        .select('id,email,is_admin,suspended,expires_at')
        .eq('email', email)
        .maybeSingle();
      if(error) throw error;
      if(!data) throw new Error('找不到此 Email 的使用者');
      return data;
    }
    async function updateProfile(id, patch){
      const { error } = await supabase.from('profiles').update(patch).eq('id', id);
      if(error) throw error;
    }
    $('#btnSetAdmin').addEventListener('click', async ()=>{
      try{
        const email=$('#g_email').value.trim(); if(!email) return alert('請輸入 Email');
        const prof = await findProfileByEmail(email);
        const exp = $('#g_exp').value ? new Date($('#g_exp').value).toISOString() : null;
        await updateProfile(prof.id,{ is_admin:true, ...(exp?{expires_at:exp}:{}) });
        alert('已設為管理員'); loadUsers(true);
      }catch(e){ alert(e.message||e); }
    });
    $('#btnUnsetAdmin').addEventListener('click', async ()=>{
      try{
        const email=$('#g_email').value.trim(); if(!email) return alert('請輸入 Email');
        const prof = await findProfileByEmail(email);
        await updateProfile(prof.id,{ is_admin:false });
        alert('已取消管理員'); loadUsers(true);
      }catch(e){ alert(e.message||e); }
    });
    $('#btnSuspend').addEventListener('click', async ()=>{
      try{
        const email=$('#g_email').value.trim(); if(!email) return alert('請輸入 Email');
        const prof = await findProfileByEmail(email);
        await updateProfile(prof.id,{ suspended:true });
        alert('已暫停'); loadUsers(true);
      }catch(e){ alert(e.message||e); }
    });
    $('#btnUnsuspend').addEventListener('click', async ()=>{
      try{
        const email=$('#g_email').value.trim(); if(!email) return alert('請輸入 Email');
        const prof = await findProfileByEmail(email);
        await updateProfile(prof.id,{ suspended:false });
        alert('已解除暫停'); loadUsers(true);
      }catch(e){ alert(e.message||e); }
    });

    // ------------------- MP4 上傳 -------------------
    const log = (s)=>{ const el=$('#log'); el.textContent += (el.textContent?'\\n':'')+s; el.scrollTop=el.scrollHeight; };
    const clearForm = ()=>{
      $('#slug').value=''; $('#mp4').value=''; $('#cover').value=''; $('#cat').value='story';
    };
    $('#btnResetForm').addEventListener('click', clearForm);

    $('#btnUpload').addEventListener('click', async ()=>{
      try{
        $('#log').textContent='就緒。';
        const category = $('#cat').value;
        const slug = $('#slug').value.trim();
        const mp4 = $('#mp4').files[0];
        const cover = $('#cover').files[0];

        if(!slug) return alert('請輸入 slug');
        if(!mp4) return alert('請選擇 MP4 檔案');

        const mp4Path = `videos/${category}/${slug}.mp4`;
        log('開始上傳：'+mp4Path);
        const { data:up1, error:e1 } = await supabase.storage.from('public').upload(mp4Path, mp4, { upsert:true });
        if(e1) throw e1;

        let coverUrl=null;
        if(cover){
          const coverPath = `data/${category}/${slug}/cover.jpg`;
          log('上傳封面：'+coverPath);
          const { error:e2 } = await supabase.storage.from('public').upload(coverPath, cover, { upsert:true });
          if(e2) throw e2;
          const { data:pub2 } = await supabase.storage.from('public').getPublicUrl(coverPath);
          coverUrl = pub2?.publicUrl || null;
        }

        const { data:pub1 } = await supabase.storage.from('public').getPublicUrl(mp4Path);
        const mp4Url = pub1?.publicUrl || null;

        // 建立 assets 記錄（若你已有更完整 schema，可在此擴充）
        const payload = {
          category, slug, mp4_url: mp4Url, cover_url: coverUrl,
          created_at: new Date().toISOString()
        };
        log('寫入 assets：'+JSON.stringify(payload,null,2));
        const { error:e3 } = await supabase.from('assets').insert(payload);
        if(e3) throw e3;

        log('完成 ✓');
        clearForm(); // ← 上傳成功後清空表單
      }catch(e){
        log('失敗：'+(e.message||e));
        alert('上傳失敗：'+(e.message||e));
      }
    });

    // ------------------- 啟動 -------------------
    (async ()=>{
      const ok = await ensureAdmin();
      if(!ok) return;
      loadUsers();
    })();
  </script>
</body>
</html>










