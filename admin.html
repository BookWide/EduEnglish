<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BookWide Admin ¬∑ v20251112 ¬∑ Full (Users / Roles+TTS / MP4 Upload)</title>
<style>
  :root{
    --bg:#0b1324; --panel:#121a2e; --muted:#a7b2cc; --primary:#3c7cff;
    --green:#1ec28b; --red:#ff6b6b; --amber:#ffc043; --bd:#1f2942; --code:#0f172a;
  }
  html,body{background:var(--bg);color:#e7eeff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,'Noto Sans TC',sans-serif;margin:0}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 18px}
  .tabs{display:flex;gap:8px;margin:4px 0 16px}
  .tab{padding:10px 14px;border:1px solid var(--bd);background:var(--panel);border-radius:10px;cursor:pointer}
  .tab.active{background:#132246;border-color:#2c3a63;color:#fff}
  .panel{display:none;border:1px solid var(--bd);background:var(--panel);border-radius:14px;padding:16px}
  .panel.active{display:block}
  .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin:6px 0}
  label{font-size:14px;color:#c7d3ee}
  input[type="text"],input[type="number"],select{
    background:#0f1730;border:1px solid var(--bd);color:#e7eeff;border-radius:10px;
    padding:10px 12px;min-width:220px;outline:none
  }
  input[type="file"]{color:#cfe0ff}
  .btn{background:var(--primary);color:#fff;border:0;border-radius:12px;padding:10px 14px;cursor:pointer}
  .btn.gray{background:#263150;color:#cfe0ff}
  .btn.green{background:var(--green)}
  .btn.red{background:var(--red)}
  .muted{color:var(--muted);font-size:13px}
  .badge{display:inline-block;background:#172447;border:1px solid #263356;border-radius:999px;padding:6px 10px;margin-left:6px;color:#cfe0ff}
  .codebox{background:var(--code);border:1px solid #1e293b;border-radius:12px;padding:12px;white-space:pre-wrap;min-height:120px;max-height:360px;overflow:auto}
  .hr{height:1px;background:#1c2745;margin:14px 0}
  .chk{display:inline-flex;align-items:center;gap:6px;margin-right:14px}
  .tip{font-size:13px;color:#cbd5f1}
  .ok{color:var(--green)} .warn{color:var(--amber)} .err{color:var(--red)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  table{width:100%;border-collapse:collapse;background:#0f1730;border:1px solid var(--bd);border-radius:12px;overflow:hidden}
  th,td{padding:10px;border-bottom:1px solid #1d2745;text-align:left;font-size:14px}
  th{background:#152048}
  tr:last-child td{border-bottom:0}
  .switch{appearance:none;width:42px;height:24px;border-radius:999px;background:#3b4a74;position:relative;outline:none;cursor:pointer}
  .switch:checked{background:#2fbf71}
  .switch::after{content:"";position:absolute;top:3px;left:3px;width:18px;height:18px;background:#fff;border-radius:999px;transition:.2s}
  .switch:checked::after{left:21px}
</style>
</head>
<body>
<div class="wrap">
  <h1>‰∏ªÊéßÂè∞</h1>
  <div class="tabs">
    <div class="tab active"  data-tab="t1">‰ΩøÁî®ËÄÖÊ∏ÖÂñÆ</div>
    <div class="tab"         data-tab="t2">ÊéàÊ¨äÔºèÊö´ÂÅúÁÆ°ÁêÜÂì° + TTS</div>
    <div class="tab"         data-tab="t3">MP4 ‰∏äÂÇ≥</div>
  </div>

  <!-- ÂàÜÈ†Å 1Ôºö‰ΩøÁî®ËÄÖÊ∏ÖÂñÆ -->
  <section id="t1" class="panel active">
    <div class="row">
      <input id="q" type="text" placeholder="ÊêúÂ∞ã email / name‚Ä¶" />
      <button class="btn gray" id="btnRefreshUsers">ÈáçÊñ∞Êï¥ÁêÜ</button>
      <span class="badge">profiles Âç≥ÊôÇËÆÄÂèñ</span>
    </div>
    <div class="row muted">ÂàáÊèõ„ÄåÁÆ°ÁêÜÂì° / Êö´ÂÅú„ÄçÊúÉÁõ¥Êé•Êõ¥Êñ∞Ë≥áÊñôÂ∫´„ÄÇ</div>
    <div class="hr"></div>
    <table id="tblUsers">
      <thead>
        <tr>
          <th>Email</th><th>ÂêçÁ®±</th><th>ÁÆ°ÁêÜÂì°</th><th>Êö´ÂÅú</th><th>ÊúÄËøëÁôªÂÖ•</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="hr"></div>
    <div id="logUsers" class="codebox"></div>
  </section>

  <!-- ÂàÜÈ†Å 2ÔºöÊéàÊ¨äÔºèÊö´ÂÅú + TTS -->
  <section id="t2" class="panel">
    <h2 style="margin:4px 0 12px">ÊéàÊ¨äÔºèÊö´ÂÅúÁÆ°ÁêÜÂì°</h2>
    <div class="row grid">
      <div>
        <label>Email</label><br/>
        <input id="roleEmail" type="text" placeholder="user@example.com"/>
      </div>
      <div>
        <label>Âãï‰Ωú</label><br/>
        <select id="roleAction">
          <option value="grant_admin">Êéà‰∫àÁÆ°ÁêÜÂì°</option>
          <option value="revoke_admin">Êí§Èä∑ÁÆ°ÁêÜÂì°</option>
          <option value="pause_user">Êö´ÂÅú‰ΩøÁî®ËÄÖ</option>
          <option value="resume_user">ÊÅ¢Âæ©‰ΩøÁî®ËÄÖ</option>
        </select>
        <button class="btn gray" id="btnRoleApply">Â•óÁî®</button>
        <span class="badge">three-tabs ¬∑ v20251112</span>
      </div>
    </div>

    <div class="hr"></div>

    <h3 style="margin:6px 0 8px">üîä ÊâπÈáè TTS Áî¢ÁîüÔºà‰∏äÂÇ≥Âà∞ <code>assets/audio/</code>Ôºâ</h3>
    <div class="tip">Ëã•Â∑≤ÊúâÂêåÂêç mp3 ÊúÉËá™ÂãïË¶ÜËìãÔºàupsertÔºâ ¬∑ cues ‰æÜÊ∫êÔºö<code>/EduEnglish/data/{cat}/cues-{slug}.json</code></div>

    <div class="row" style="margin-top:10px">
      <label>ÂàÜÈ°û</label>
      <select id="ttsCat">
        <option value="story">story</option><option value="music">music</option>
        <option value="movie">movie</option><option value="news">news</option>
        <option value="pro">pro</option>
      </select>

      <label>Slug</label>
      <input id="ttsSlug" type="text" placeholder="‰æãÂ¶ÇÔºöhouyi" value="houyi"/>

      <label>Ë™ûË®Ä</label>
      <label class="chk"><input type="checkbox" id="chkJa" checked> Êó•Êñá ja-JP</label>
      <label class="chk"><input type="checkbox" id="chkEn" checked> Ëã±Êñá en-US</label>
      <label class="chk"><input type="checkbox" id="chkZh" checked> ‰∏≠Êñá zh-TW</label>

      <button class="btn" id="btnBatch">Áî¢ÁîüÈü≥Ê™î ‚Üí ‰∏äÂÇ≥ Supabase</button>
    </div>

    <div class="hr"></div>

    <h3 style="margin:6px 0 8px">üß™ Edge Function Ê∏¨Ë©¶ÂçÄ</h3>
    <div class="row">
      <button class="btn green" id="btnTestOnce">Ê∏¨Ë©¶ tts-onceÔºàÂñÆÂè•Ôºâ</button>
      <button class="btn green" id="btnTestBatch">Ê∏¨Ë©¶ tts-batchÔºàdemo ÊâπÊ¨° + ÂØ´ÂÖ• StorageÔºâ</button>
      <span class="muted">Áî®‰æÜÁ¢∫Ë™ç CORS„ÄÅÈáëÈë∞„ÄÅStorage Ê¨äÈôêÊòØÂê¶Ê≠£Â∏∏„ÄÇ</span>
    </div>

    <div class="hr"></div>
    <div class="tip"><b>ÁãÄÊÖãËº∏Âá∫</b>ÔºàÊúÄÊñ∞Âú®ÊúÄ‰∏äÔºâÔºö<span id="envWarn" class="warn"></span></div>
    <div id="log" class="codebox"></div>
  </section>

  <!-- ÂàÜÈ†Å 3ÔºöMP4 ‰∏äÂÇ≥ -->
  <section id="t3" class="panel">
    <h2 style="margin:4px 0 12px">MP4 ‰∏äÂÇ≥</h2>
    <div class="row">
      <label>ÂàÜÈ°û</label>
      <select id="vCat">
        <option value="story">story</option><option value="music">music</option>
        <option value="movie">movie</option><option value="news">news</option>
        <option value="pro">pro</option>
      </select>

      <label>Slug</label>
      <input id="vSlug" type="text" placeholder="‰æãÂ¶ÇÔºöhouyi" value="houyi"/>

      <label>ÂΩ±Áâá (mp4)</label>
      <input id="fileMp4" type="file" accept="video/mp4" />

      <label>Â∞ÅÈù¢ (jpg/png)</label>
      <input id="fileCover" type="file" accept="image/*" />

      <button class="btn" id="btnUpload">‰∏äÂÇ≥</button>
    </div>
    <div class="tip">ÂΩ±ÁâáÊúÉÂØ´ÂÖ•Ôºö<code>videos/&lt;cat&gt;/&lt;slug&gt;.mp4</code>ÔºõÂ∞ÅÈù¢ÊúÉÂØ´ÂÖ•Ôºö<code>assets/&lt;cat&gt;/&lt;slug&gt;.cover.jpg</code></div>
    <div class="hr"></div>
    <div id="logUp" class="codebox"></div>
  </section>
</div>

<script>
/* ===== Âü∫Êú¨Ë®≠ÂÆö ===== */
const SUPABASE_URL = 'https://jeajrwpmrgczimmrflxo.supabase.co';
const SUPABASE_ANON_KEY =
 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do';

const u = localStorage.getItem('SUPA_URL'); const k = localStorage.getItem('SUPA_KEY');
const SUPA_URL = (u && u.startsWith('http')) ? u : SUPABASE_URL;
const SUPA_KEY = (k && k.length > 20)       ? k : SUPABASE_ANON_KEY;

/* ===== UI Â∞èÂ∑•ÂÖ∑ ===== */
const $ = s => document.querySelector(s);
function log(boxId,msg,cls=''){ const el=document.createElement('div'); el.textContent=`[${new Date().toLocaleTimeString()}] ${msg}`; if(cls)el.className=cls; $(boxId).prepend(el); }
function needEnv(){
  const miss=[]; if(!SUPA_URL) miss.push('SUPABASE_URL'); if(!SUPA_KEY) miss.push('SUPABASE_ANON_KEY');
  $('#envWarn').textContent = miss.length?`Áº∫Â∞ë ${miss.join(' / ')}`:'';
  return miss.length>0;
}

/* ===== ÂàÜÈ†ÅÂàáÊèõ ===== */
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active'));
    t.classList.add('active'); document.getElementById(t.dataset.tab).classList.add('active');
  });
});

/* ===== ÂàÜÈ†Å‰∏ÄÔºö‰ΩøÁî®ËÄÖÊ∏ÖÂñÆ ===== */
async function fetchUsers(){
  const q = $('#q').value.trim();
  // ËÆÄ profilesÔºõÂèØ‰æùÈúÄÊ±ÇÂä†Ê¨Ñ‰Ωç
  let url = `${SUPA_URL}/rest/v1/profiles?select=email,display_name,is_admin,is_paused,last_sign_in_at,updated_at&order=updated_at.desc`;
  if(q){
    // ilike ‰ªª‰∏ÄÊ¨Ñ‰Ωç
    url += `&or=(email.ilike.*${encodeURIComponent(q)}*,display_name.ilike.*${encodeURIComponent(q)}*)`;
  }
  const res = await fetch(url,{ headers:{ apikey:SUPA_KEY, Authorization:`Bearer ${SUPA_KEY}` } });
  if(!res.ok){ log('#logUsers',`ËÆÄÂèñÂ§±ÊïóÔºö${res.status} ${await res.text()}`,'err'); return; }
  const rows = await res.json();
  const tbody = $('#tblUsers tbody'); tbody.innerHTML='';
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${r.email||''}</td>
      <td>${r.display_name||''}</td>
      <td><input type="checkbox" class="swAdmin switch" ${r.is_admin?'checked':''} data-email="${r.email}"></td>
      <td><input type="checkbox" class="swPause switch" ${r.is_paused?'checked':''} data-email="${r.email}"></td>
      <td>${r.last_sign_in_at||''}</td>`;
    tbody.appendChild(tr);
  });
}
async function updateFlag(email, field, val){
  const res = await fetch(`${SUPA_URL}/rest/v1/profiles?email=eq.${encodeURIComponent(email)}`,{
    method:'PATCH',
    headers:{
      apikey:SUPA_KEY, Authorization:`Bearer ${SUPA_KEY}`,
      'Content-Type':'application/json', 'Prefer':'return=representation'
    },
    body: JSON.stringify({ [field]: val, updated_at:new Date().toISOString() })
  });
  if(!res.ok){ log('#logUsers',`Êõ¥Êñ∞Â§±ÊïóÔºö${await res.text()}`,'err'); }
  else{ log('#logUsers',`Â∑≤Êõ¥Êñ∞ ${email} ‚Üí ${field}=${val}`,'ok'); }
}
$('#btnRefreshUsers').addEventListener('click', fetchUsers);
$('#q').addEventListener('keydown', e=>{ if(e.key==='Enter') fetchUsers(); });
$('#tblUsers').addEventListener('change', e=>{
  const t=e.target;
  if(t.classList.contains('swAdmin')) updateFlag(t.dataset.email,'is_admin',t.checked);
  if(t.classList.contains('swPause')) updateFlag(t.dataset.email,'is_paused',t.checked);
});

/* ===== ÂàÜÈ†Å‰∫åÔºöÊéàÊ¨äÔºèÊö´ÂÅú ===== */
$('#btnRoleApply').addEventListener('click', async ()=>{
  const email=$('#roleEmail').value.trim(); const act=$('#roleAction').value;
  if(!email){ log('#log','Ë´ãËº∏ÂÖ• Email','warn'); return; }
  let field=null,val=null;
  if(act==='grant_admin'){ field='is_admin'; val=true; }
  if(act==='revoke_admin'){ field='is_admin'; val=false; }
  if(act==='pause_user'){ field='is_paused'; val=true; }
  if(act==='resume_user'){ field='is_paused'; val=false; }
  if(!field){ log('#log','Êú™Áü•Âãï‰Ωú','warn'); return; }

  try{
    const res = await fetch(`${SUPA_URL}/rest/v1/profiles?email=eq.${encodeURIComponent(email)}`,{
      method:'PATCH',
      headers:{ apikey:SUPA_KEY, Authorization:`Bearer ${SUPA_KEY}`, 'Content-Type':'application/json','Prefer':'return=representation' },
      body: JSON.stringify({ [field]: val, updated_at:new Date().toISOString() })
    });
    const txt = await res.text();
    log('#log', `Êõ¥Êñ∞ ${email} ‚Üí ${field}=${val} ¬∑ status ${res.status} ¬∑ ${txt}`, res.ok?'ok':'err');
  }catch(e){ log('#log',`Êõ¥Êñ∞ÈåØË™§Ôºö${e}`,'err'); }
});

/* ===== ÂàÜÈ†Å‰∫åÔºöTTS ¬∑ Ê≠£ÂºèÊâπÊ¨° ===== */
$('#btnBatch').addEventListener('click', async ()=>{
  if(needEnv()){ log('#log','Áí∞Â¢ÉËÆäÊï∏Áº∫Â§±ÔºåÁÑ°Ê≥ïÂëºÂè´ Edge Function','err'); return; }
  const cat=$('#ttsCat').value, slug=$('#ttsSlug').value.trim();
  const langs=[]; if($('#chkJa').checked)langs.push('ja-JP'); if($('#chkEn').checked)langs.push('en-US'); if($('#chkZh').checked)langs.push('zh-TW');
  if(!slug){ log('#log','Ë´ãËº∏ÂÖ• slug','warn'); return; } if(!langs.length){ log('#log','Ë´ãËá≥Â∞ëÂãæÈÅ∏‰∏ÄÁ®ÆË™ûË®Ä','warn'); return; }

  const body={cat,slug,langs};
  const FN=`${SUPA_URL}/functions/v1/tts-batch`;
  log('#log',`ÂëºÂè´ tts-batchÔºö${FN} ¬∑ body=${JSON.stringify(body)}`,'muted');
  try{
    const res=await fetch(FN,{method:'POST',headers:{apikey:SUPA_KEY,Authorization:`Bearer ${SUPA_KEY}`,'Content-Type':'application/json'},body:JSON.stringify(body)});
    const txt=await res.text(); log('#log',`status ${res.status} ¬∑ ${txt}`,res.ok?'ok':'err');
  }catch(e){ log('#log',`ÂëºÂè´Â§±ÊïóÔºö${e}`,'err'); }
});

/* ===== ÂàÜÈ†Å‰∫åÔºöTTS ¬∑ Ê∏¨Ë©¶ once/batch ===== */
$('#btnTestOnce').addEventListener('click', async ()=>{
  if(needEnv()){ log('#log','Áí∞Â¢ÉËÆäÊï∏Áº∫Â§±','err'); return; }
  const FN=`${SUPA_URL}/functions/v1/tts-once`;
  const body={lang:'ja-JP',text:'„Åì„Çå„ÅØ„ÉÜ„Çπ„ÉàÈü≥Â£∞„Åß„Åô„ÄÇ'};
  try{
    const res=await fetch(FN,{method:'POST',headers:{apikey:SUPA_KEY,Authorization:`Bearer ${SUPA_KEY}`,'Content-Type':'application/json'},body:JSON.stringify(body)});
    if(!res.ok){ log('#log',`status ${res.status} ¬∑ ${await res.text()}`,'err'); return; }
    const blob=await res.blob(); const url=URL.createObjectURL(blob); const au=new Audio(url); au.onended=()=>URL.revokeObjectURL(url); au.play();
    log('#log','tts-once ÊàêÂäüÊí≠ÊîæÔºà‰∏çÂØ´ÂÖ• StorageÔºâ','ok');
  }catch(e){ log('#log',`tts-once Â§±ÊïóÔºö${e}`,'err'); }
});
$('#btnTestBatch').addEventListener('click', async ()=>{
  if(needEnv()){ log('#log','Áí∞Â¢ÉËÆäÊï∏Áº∫Â§±','err'); return; }
  const FN=`${SUPA_URL}/functions/v1/tts-batch`; const body={cat:'story',slug:'test',langs:['ja-JP'],demo:true};
  log('#log','È†êÊúüÂØ´ÂÖ•Ôºöassets/audio/story/test/ja/00.mp3','muted');
  try{
    const res=await fetch(FN,{method:'POST',headers:{apikey:SUPA_KEY,Authorization:`Bearer ${SUPA_KEY}`,'Content-Type':'application/json'},body:JSON.stringify(body)});
    const txt=await res.text(); log('#log',`status ${res.status} ¬∑ ${txt}`,res.ok?'ok':'err');
  }catch(e){ log('#log',`tts-batch Â§±ÊïóÔºö${e}`,'err'); }
});

/* ===== ÂàÜÈ†Å‰∏âÔºöMP4 ‰∏äÂÇ≥ ===== */
async function uploadStorage(bucket, path, bytes, type){
  const url=`${SUPA_URL}/storage/v1/object/${bucket}/${path}`;
  const res=await fetch(url,{method:'PUT',headers:{Authorization:`Bearer ${SUPA_KEY}`,'Content-Type':type,'x-upsert':'true'},body:bytes});
  if(!res.ok) throw new Error(await res.text());
  return `${SUPA_URL}/storage/v1/object/public/${bucket}/${path}`;
}
$('#btnUpload').addEventListener('click', async ()=>{
  const cat=$('#vCat').value, slug=$('#vSlug').value.trim();
  const fMp4=$('#fileMp4').files[0], fCover=$('#fileCover').files[0];
  if(!slug){ log('#logUp','Ë´ãËº∏ÂÖ• slug','warn'); return; }
  if(!fMp4 && !fCover){ log('#logUp','Ëá≥Â∞ëÈÅ∏‰∏ÄÂÄãÊ™îÊ°à','warn'); return; }
  try{
    if(fMp4){
      const p=`videos/${cat}/${slug}.mp4`;
      const url=await uploadStorage('videos',p,await fMp4.arrayBuffer(),'video/mp4');
      log('#logUp',`ÂΩ±ÁâáÂ∑≤‰∏äÂÇ≥Ôºö${url}`,'ok');
    }
    if(fCover){
      const ext=(fCover.name.split('.').pop()||'jpg').toLowerCase();
      const p=`assets/${cat}/${slug}.cover.${ext}`;
      const url=await uploadStorage('assets',p,await fCover.arrayBuffer(),fCover.type||'image/jpeg');
      log('#logUp',`Â∞ÅÈù¢Â∑≤‰∏äÂÇ≥Ôºö${url}`,'ok');
    }
  }catch(e){ log('#logUp',`‰∏äÂÇ≥Â§±ÊïóÔºö${e.message||e}`,'err'); }
});

/* ===== ÂàùÂßã ===== */
window.addEventListener('load',()=>{
  needEnv();
  fetchUsers();
  log('#logUsers','‰ΩøÁî®ËÄÖÊ∏ÖÂñÆËºâÂÖ•ÂÆåÊàê','ok');
  log('#log','Ready ¬∑ Edge Function Ê∏¨Ë©¶ / Ê≠£ÂºèÊâπÈáèÂèØÁî®','ok');
});
</script>
</body>
</html>
























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































<script type="module">
// === BW Admin Full-Wired v20251110 ===
const qs = sel => document.querySelector(sel);

function getFnBase(){
  const m = document.querySelector('meta[name="bw-fn-base"]');
  const base = (m?.content||'').replace(/\/+$/,'');
  if(!base) throw new Error('Functions base not found (<meta name="bw-fn-base">)');
  return base;
}
async function getJWT(){
  try{
    if (window.supabase?.auth?.getSession) {
      const { data } = await window.supabase.auth.getSession();
      return data?.session?.access_token || null;
    }
    if (window.BW?.supa?.auth?.getSession) {
      const { data } = await window.BW.supa.auth.getSession();
      return data?.session?.access_token || null;
    }
  }catch(e){}
  return null;
}
async function callEdgeTranslate(lines, to=['zh','ja']){
  const fn = (qs('#edgeFn')?.value || 'mt-translate').trim();
  const url = `${getFnBase()}/${fn}`;
  const headers = {'Content-Type':'application/json'};
  const jwt = await getJWT();
  if (jwt) headers.Authorization = `Bearer ${jwt}`;
  const r = await fetch(url, { method:'POST', headers, body: JSON.stringify({ lines, to }) });
  const j = await r.json().catch(()=>({}));
  if (!r.ok || j?.ok===false) throw new Error(j?.error?.message || `HTTP ${r.status}`);
  // ÊîØÊè¥‰Ω†ÁöÑ Edge ÂÖ©Á®ÆÂõûÂÇ≥Ôºö{zh,ja} Êàñ {results:[{lang,lines}...]}
  const zh = j.zh || j.results?.find(x=>x.lang==='zh')?.lines || [];
  const ja = j.ja || j.results?.find(x=>x.lang==='ja')?.lines || [];
  return { zh, ja, input: j.input || lines };
}

// ---------- subtitle parsing helpers (very simple) ----------
function parseSubFile(file){
  return new Promise((resolve,reject)=>{
    if(!file) return resolve([]);
    const reader=new FileReader();
    reader.onload = () => {
      const txt = String(reader.result||'');
      const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      resolve(lines.map((en,i)=>({ time: toClock(i*4), en })));
    };
    reader.onerror=()=>reject(reader.error);
    reader.readAsText(file);
  });
}
function toClock(s){ s=Math.max(0,Math.round(+s||0)); const mm=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${mm}:${ss}`; }

// ---------- build five JSON ----------
function buildIndex({title,category,slug,video,cover}){
  return { title, category, slug, video, cover,
    cues:{ zh:`./cues-${slug}.json`},
    vocab:`./vocab-${slug}.json`,
    quiz:`./quiz-${slug}.json`,
    ai:`./ai-${slug}.json`,
    is_public:true };
}
function topWords(enLines, limit=20){
  const stop=new Set("the a an to is are am was were be been being i you he she it we they me my your our their his her its this that these those of for and or but if not no yes in on at by from with as do does did have has had can will would should could just really very there here then than so because while after before into out up down over under again more most some any every each few many much own same other another".split(" "));
  const freq={};
  for(const ln of enLines){
    for(const raw of ln.toLowerCase().replace(/[^a-z' ]/g,' ').split(' ')){
      const w=raw.trim();
      if(!w||w.length<3||stop.has(w)) continue;
      freq[w]=(freq[w]||0)+1;
    }
  }
  return Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,limit).map(x=>x[0]);
}
function buildVocab(enLines, zh, ja){
  const words=topWords(enLines,20);
  const pickLine=(w)=> enLines.find(l=>l.toLowerCase().includes(w)) || `${w} ${enLines[0]||''}`;
  return words.map(w=>({ en:w, zh:"", ja:"", def_en:"", example_en: pickLine(w) }));
}
function buildQuiz(enLines, zh, ja){
  const stop=new Set("the a an to is are am was were be been being i you he she it we they me my your our their his her its this that these those of for and or but if not no yes in on at by from with as do does did have has had can will would should could just really very there here then than so because while after before into out up down over under again more most some any every each few many much own same other another".split(" "));
  const words = topWords(enLines,20);
  const quiz=[];
  // 20 MCQ
  for(const w of words){
    const opts=[w, w+'s', w+'ing', w+'ly'].sort(()=>Math.random()-0.5);
    quiz.push({ section:"Vocabulary", type:"MCQ", question:"Choose the word that appears in the song: ____", options:opts, answer:w, explanation:`'${w}' appears in lyrics.`});
  }
  // 20 Fill-in
  const chooseBlank=(ln)=>{
    const toks=(ln.match(/[A-Za-z']+/g)||[]).filter(t=>t.length>=3 && !stop.has(t.toLowerCase()));
    if(!toks.length) return null; const t=toks[Math.floor(Math.random()*toks.length)];
    return [ln.replace(t,'____'), t];
  };
  let c=0;
  for(const ln of enLines){
    if(c>=20) break;
    const r=chooseBlank(ln); if(!r) continue; c++;
    quiz.push({ section:"Fill-in-the-blank", type:"SA", question:r[0], answer:r[1], explanation:"" });
  }
  // 20 T/F
  for(const w of words){
    quiz.push({ section:"True/False", type:"MCQ", question:`The word '${w}' appears in the song.`, options:["True","False"], answer:"True", explanation:"" });
  }
  // 20 Short Answer
  for(let i=0;i<20;i++){
    quiz.push({ section:"Short Answer", type:"SA", question:`What is one key word or idea from line ${i+1}?`, answer:"", explanation:"" });
  }
  return quiz;
}
function buildAI(){
  return { topics: Array.from({length:15}, (_,i)=>({ title:`Topic ${i+1}`, prompt:"Talk about the meaning or emotion of this lyric line.", hint:"Use simple words and 2-3 sentences.", sample:"" })) };
}

// ---------- preview wiring ----------
qs('#btnPreview')?.addEventListener('click', async ()=>{
  const cat = qs('#cat')?.value?.trim() || 'music';
  const slug = qs('#slug')?.value?.trim() || 'applesong';
  const title= qs('#title')?.value?.trim() || slug;
  const sub = qs('#subFile')?.files?.[0] || null;
  // 1. parse EN lines
  const cuesEN = await parseSubFile(sub);
  if(!cuesEN.length){ alert('Ë´ãÂÖàÈÅ∏ÊìáÂ≠óÂπï/Ê≠åË©ûÊ™î'); return; }
  const enLines = cuesEN.map(x=>x.en);
  // 2. translate if checked
  let zh=[], ja=[];
  if (qs('#modeMT')?.checked){
    try{ ({zh,ja} = await callEdgeTranslate(enLines)); }catch(e){ alert('Ê©üÁøªÂ§±ÊïóÔºö'+(e.message||e)); }
  }
  // 3. build cues
  const cues = cuesEN.map((r,i)=>({ time:r.time, en:r.en, zh: zh[i]||"", ja: ja[i]||"" }));
  // 4. vocab/quiz/ai/index
  const vocab = buildVocab(enLines, zh, ja);
  const quiz  = buildQuiz(enLines, zh, ja);
  const ai    = buildAI();
  const meta  = { title, category:cat, slug, video:"", cover:"" };
  const index = buildIndex(meta);
  // 5. show in preview textareas
  const set = (id,obj)=>{ const el=qs(id); if(el) el.value = JSON.stringify(obj, null, 2); };
  set('#out-index', index);
  set('#out-cues', cues);
  set('#out-vocab', vocab);
  set('#out-quiz', quiz);
  set('#out-ai', ai);
  alert('È†êË¶ΩÂ∑≤Áî¢ÁîüÔºà5 ‰ª∂Ôºâ');
});

// ---------- GitHub upload wiring ----------
async function ghExists({owner,repo,branch,token,path}){
  const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(path)}?ref=${encodeURIComponent(branch)}`;
  const r = await fetch(url, { headers:{
    'Authorization': `Bearer ${token}`,
    'Accept': 'application/vnd.github+json',
    'X-GitHub-Api-Version':'2022-11-28'
  }});
  return r.ok;
}
async function ghPut({owner,repo,branch,token,path,content,message}){
  // get sha
  let sha=null;
  try{
    const getUrl=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(path)}?ref=${encodeURIComponent(branch)}`;
    const r1=await fetch(getUrl,{ headers:{'Authorization':`Bearer ${token}`,'Accept':'application/vnd.github+json','X-GitHub-Api-Version':'2022-11-28'}});
    if(r1.ok){ const j=await r1.json(); sha=j?.sha||null; }
  }catch(_){}
  const url=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(path)}`;
  const body={ message, content:btoa(unescape(encodeURIComponent(typeof content==='string'?content:JSON.stringify(content,null,2)))), branch };
  if (sha) body.sha = sha;
  const r=await fetch(url,{ method:'PUT', headers:{
    'Authorization': `Bearer ${token}`,
    'Accept':'application/vnd.github+json',
    'X-GitHub-Api-Version':'2022-11-28',
    'Content-Type':'application/json'
  }, body: JSON.stringify(body) });
  if(!r.ok){ const t=await r.text(); throw new Error(`HTTP ${r.status} ‚Äì ${t}`); }
  return await r.json();
}
function joinPath(base, rel){
  const a = String(base||'').replace(/^\/+|\/+$/g,'');
  const b = String(rel||'').replace(/^\/+/,'');
  return (a? (a+'/'+b): b);
}
qs('#btnUploadGithub')?.addEventListener('click', async ()=>{
  const owner = qs('#ghOwner')?.value?.trim();
  const repo  = qs('#ghRepo')?.value?.trim();
  const branch= qs('#ghBranch')?.value?.trim() || 'main';
  const base  = qs('#ghBase')?.value || '';
  const msg   = qs('#ghMsg')?.value || 'Add JSON';
  const token = qs('#ghTok')?.value?.trim();
  if(!owner||!repo||!token){ alert('Ë´ãÂ°´ Owner/Repo/Token'); return; }
  // read preview areas
  const getObj = (id)=>{ try{ return JSON.parse(qs(id).value); }catch(_){ return null; } };
  const index = getObj('#out-index');
  const cues  = getObj('#out-cues');
  const vocab = getObj('#out-vocab');
  const quiz  = getObj('#out-quiz');
  const ai    = getObj('#out-ai');
  if(!index||!cues||!vocab||!quiz||!ai){ alert('Ë´ãÂÖàÊåâ„ÄåÈ†êË¶Ω JSONÔºà5 ‰ª∂Ôºâ„ÄçÁî¢ÁîüÂÖßÂÆπ'); return; }
  const cat=index.category, slug=index.slug;
  const dir = joinPath(base, `data/${cat}/${slug}`.replace(/^data\//,'')); // Èò≤ÈáçË§á data/
  const files=[
    ['index-'+slug+'.json', index],
    ['cues-'+slug+'.json', cues],
    ['vocab-'+slug+'.json', vocab],
    ['quiz-'+slug+'.json', quiz],
    ['ai-'+slug+'.json', ai],
  ];
  // ensure folders (by creating .keep)
  const keepPath = joinPath(dir, '.keep');
  try{ await ghPut({owner,repo,branch,token,path:keepPath,content:'keep',message:`init ${dir}`}); }catch(_){}
  // upload files
  let ok=0, fail=0, log=[];
  for(let i=0;i<files.length;i++){
    const [name, obj] = files[i];
    const path = joinPath(dir, name);
    try{
      await ghPut({ owner,repo,branch,token, path, content: obj, message: msg });
      ok++; log.push(`[${i+1}/5] OK ${path}`);
    }catch(e){
      fail++; log.push(`[${i+1}/5] Â§±Êïó ${path} ‚Äì ${e.message}`);
    }
  }
  alert(`GitHub ‰∏äÂÇ≥ÂÆåÊàêÔºöOK ${ok} / Â§±Êïó ${fail}\n` + log.join('\n'));
});
</script>
