
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BookWide Admin 主控台（白底·三分頁）</title>
  <style>
    :root{
      --bg:#fff;--text:#111;--muted:#6b7280;--primary:#0ea5e9;--primary-ink:#fff;
      --line:#e5e7eb;--chip:#f1f5f9;--danger:#ef4444;--ok:#16a34a;--warn:#d97706;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.6 system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial}
    a{color:var(--primary);text-decoration:none}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);z-index:2}
    .top{max-width:1200px;margin:auto;padding:16px}
    h1{margin:0 0 4px 0;font-size:22px}
    .sub{color:var(--muted);font-size:14px}
    .bar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn.primary{background:var(--primary);color:var(--primary-ink);border-color:var(--primary)}
    .btn.small{padding:6px 10px;font-size:14px;border-radius:8px}
    .btn.ghost{background:var(--chip)}
    .tabs{display:flex;gap:8px;margin:10px 0}
    .tab{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:var(--chip);cursor:pointer}
    .tab.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    main{max-width:1200px;margin:18px auto;padding:0 16px 48px 16px}
    section{display:none}
    section.active{display:block}
    .card{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
    .card > header{background:#fafafa;border-bottom:1px solid var(--line)}
    .pad{padding:16px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-top:1px solid var(--line);padding:10px 8px;text-align:left;vertical-align:top}
    th{background:#fafafa;font-weight:600}
    .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--line);padding:4px 8px;border-radius:999px;font-size:12px}
    .chip.ok{border-color:#86efac;background:#ecfdf5}
    .chip.warn{border-color:#fde68a;background:#fffbeb}
    .chip.danger{border-color:#fecaca;background:#fef2f2}
    .row-actions{display:flex;gap:8px;flex-wrap:wrap}
    input[type="text"],select{border:1px solid var(--line);border-radius:10px;padding:10px;min-width:220px}
    input[type="file"]{font-size:14px}
    .grid{display:grid;gap:14px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:880px){.g2,.g3{grid-template-columns:1fr} input[type="text"],select{min-width:unset;width:100%}}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    .right{display:flex;justify-content:flex-end;gap:8px}
    .progress{height:8px;background:#f1f5f9;border-radius:999px;overflow:hidden}
    .progress > b{display:block;height:100%;background:var(--primary);width:0%}
    .hint{font-size:12px;color:var(--muted)}
  </style>
  <!-- Supabase 初始化：確保 window.supa 存在（沿用你的 supa.js） -->
  <script type="module">
    import { supabase } from './supa.js';
    window.supa = supabase;
  </script>
</head>
<body>
  <header>
    <div class="top">
      <h1>BookWide Admin 主控台</h1>
      <div class="sub">顯示 <b>public.profiles</b>｜時間以台灣時區顯示（Asia/Taipei）</div>
      <div class="tabs">
        <button class="tab active" data-tab="tab-users">使用者清單</button>
        <button class="tab" data-tab="tab-roles">授權／暫停管理員</button>
        <button class="tab" data-tab="tab-mp4">MP4 上傳自動化</button>
      </div>
    </div>
  </header>

  <main>
    <!-- 使用者清單 -->
    <section id="tab-users" class="active">
      <div class="card">
        <header class="pad">
          <div class="grid g3">
            <div><input id="q" type="text" placeholder="搜尋 Email / 顯示名稱…" /></div>
            <div class="muted">每 10 分鐘內視為「在線」。</div>
            <div class="right"><button id="btnReload" class="btn small">重新整理</button></div>
          </div>
        </header>
        <div class="pad">
          <div class="hint" id="infoLine"></div>
          <table>
            <thead>
              <tr>
                <th>Email</th>
                <th>顯示名稱</th>
                <th>最後登入（台灣）</th>
                <th>最近在線（台灣）</th>
                <th>管理員</th>
                <th>狀態</th>
                <th>到期日</th>
              </tr>
            </thead>
            <tbody id="usersTbody">
              <tr><td colspan="7" class="muted">載入中…</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- 授權 / 暫停管理員 -->
    <section id="tab-roles">
      <div class="card">
        <header class="pad"><b>管理員授權&停權 / 暫停</b></header>
        <div class="pad">
          <table>
            <thead>
              <tr>
                <th>Email</th>
                <th>顯示名稱</th>
                <th>管理員</th>
                <th>停權</th>
                <th>暫停</th>
                <th>動作</th>
              </tr>
            </thead>
            <tbody id="rolesTbody">
              <tr><td colspan="6" class="muted">載入中…</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- MP4 自動化 -->
    <section id="tab-mp4">
      <div class="card">
        <header class="pad"><b>MP4 上傳自動化</b></header>
        <div class="pad grid g2">
          <label>分類
            <select id="mp4Category">
              <option value="story">story</option>
              <option value="music">music</option>
              <option value="movie">movie</option>
              <option value="news">news</option>
              <option value="pro">pro</option>
            </select>
          </label>
          <label>Slug（不含空白與副檔名）
            <input id="mp4Slug" type="text" placeholder="例如：mid-autumn"/>
          </label>

          <label>MP4 檔
            <input id="mp4File" type="file" accept="video/mp4"/>
          </label>
          <label>封面（可選，jpg/png）
            <input id="coverFile" type="file" accept="image/*"/>
          </label>

          <div class="grid g2" style="grid-column:1/-1">
            <div>
              <div class="hint">會上傳到 <span class="mono">videos/{category}/{slug}.mp4</span>；封面存到 <span class="mono">assets/{category}/{slug}.cover.jpg</span></div>
            </div>
            <div class="right">
              <button id="btnUpload" class="btn primary">上傳</button>
              <button id="btnReset" class="btn ghost">重設表單</button>
            </div>
          </div>

          <div style="grid-column:1/-1">
            <div class="progress"><b id="pbar"></b></div>
            <div id="uploadLog" class="hint" style="margin-top:8px"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ——————————— 工具 ———————————
    const tz = 'Asia/Taipei';
    function ts2tw(x){
      if(!x) return '—';
      try{ return new Date(x).toLocaleString('zh-TW',{ timeZone: tz, hour12:false }); }
      catch(e){ return String(x) }
    }
    function el(q,root=document){ return root.querySelector(q) }
    function els(q,root=document){ return [...root.querySelectorAll(q)] }

    // ——————————— 分頁 ———————————
    els('.tab').forEach(b=>b.addEventListener('click', ()=>{
      els('.tab').forEach(x=>x.classList.remove('active'));
      els('main section').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      el('#'+b.dataset.tab).classList.add('active');
    }));

    // ——————————— 資料讀取（public.profiles） ———————————
    let cached = [];
    const COLUMNS = 'id,email,display_name,is_admin,is_suspended,is_paused,last_sign_in_at,last_seen_at,expires_at';

    async function loadProfiles(){
      el('#usersTbody').innerHTML = '<tr><td colspan="7" class="muted">載入中…</td></tr>';
      el('#rolesTbody').innerHTML = '<tr><td colspan="6" class="muted">載入中…</td></tr>';
      const r = await supa.from('profiles').select(COLUMNS).order('email',{ascending:true});
      if(r.error){
        alert('讀取失敗：'+r.error.message);
        return;
      }
      cached = r.data||[];
      renderUsers();
      renderRoles();
      el('#infoLine').textContent = `共 ${cached.length} 筆；台灣時間顯示。`;
    }

    function onlineChip(lastSeen){
      if(!lastSeen) return '<span class="chip">—</span>';
      const dt = new Date(lastSeen);
      const diffMin = (Date.now()-dt.getTime())/60000;
      if(diffMin <= 10) return '<span class="chip ok">在線</span>';
      if(diffMin <= 60) return '<span class="chip warn">一小時內</span>';
      return '<span class="chip">離線</span>';
    }

    function renderUsers(){
      const q = el('#q').value?.trim().toLowerCase();
      const rows = cached.filter(x=>{
        if(!q) return true;
        return (x.email||'').toLowerCase().includes(q) || (x.display_name||'').toLowerCase().includes(q);
      }).map(x=>`<tr>
        <td class="mono">${x.email||'—'}</td>
        <td>${x.display_name||'—'}</td>
        <td>${ts2tw(x.last_sign_in_at)}</td>
        <td>${onlineChip(x.last_seen_at)} <span class="muted">${ts2tw(x.last_seen_at)}</span></td>
        <td>${x.is_admin?'<span class="chip ok">Admin</span>':'<span class="chip">一般</span>'}</td>
        <td>${
          x.is_suspended ? '<span class="chip danger">停權</span>' :
          x.is_paused ? '<span class="chip warn">暫停</span>' : '<span class="chip ok">正常</span>'
        }</td>
        <td>${x.expires_at ? new Date(x.expires_at).toISOString().slice(0,10) : '—'}</td>
      </tr>`).join('');
      el('#usersTbody').innerHTML = rows || '<tr><td colspan="7" class="muted">沒有符合條件的資料</td></tr>';
    }

    function renderRoles(){
      const rows = cached.map(x=>`<tr data-id="${x.id}">
        <td class="mono">${x.email||'—'}</td>
        <td>${x.display_name||'—'}</td>
        <td><input type="checkbox" class="chk-admin" ${x.is_admin?'checked':''}></td>
        <td><input type="checkbox" class="chk-sus" ${x.is_suspended?'checked':''}></td>
        <td><input type="checkbox" class="chk-pause" ${x.is_paused?'checked':''}></td>
        <td class="row-actions"><button class="btn small save">儲存</button></td>
      </tr>`).join('');
      el('#rolesTbody').innerHTML = rows || '<tr><td colspan="6" class="muted">沒有資料</td></tr>';

      els('#rolesTbody .save').forEach(btn=>btn.addEventListener('click', async (ev)=>{
        const tr = ev.target.closest('tr');
        const id = tr.dataset.id;
        const is_admin = tr.querySelector('.chk-admin').checked;
        const is_suspended = tr.querySelector('.chk-sus').checked;
        const is_paused = tr.querySelector('.chk-pause').checked;
        const { error } = await supa.from('profiles').update({ is_admin, is_suspended, is_paused }).eq('id', id);
        if(error) return alert('更新失敗：'+error.message);
        alert('已更新');
        loadProfiles();
      }));
    }

    // 搜尋與重新整理
    el('#q').addEventListener('input', renderUsers);
    el('#btnReload').addEventListener('click', loadProfiles);

    // ——————————— MP4 自動化（僅前端 Storage 上傳） ———————————
    const VIDEOS_BUCKET = 'videos';
    const ASSETS_BUCKET = 'assets'; // 封面
    function setProgress(p){ el('#pbar').style.width = Math.max(0,Math.min(100,p)) + '%'; }

    el('#btnReset').addEventListener('click', ()=>{
      el('#mp4Slug').value='';
      el('#mp4File').value='';
      el('#coverFile').value='';
      setProgress(0); el('#uploadLog').textContent='';
    });

    el('#btnUpload').addEventListener('click', async()=>{
      const category = el('#mp4Category').value.trim();
      const slug = el('#mp4Slug').value.trim();
      const mp4 = el('#mp4File').files[0];
      const cover = el('#coverFile').files[0];

      if(!slug){ alert('請輸入 slug'); return; }
      if(!mp4){ alert('請選擇 MP4 檔'); return; }

      // 上傳 MP4
      try{
        setProgress(10);
        const mp4Path = `${category}/${slug}.mp4`;
        const up1 = await supa.storage.from(VIDEOS_BUCKET).upload(mp4Path, mp4, { upsert:true, cacheControl:'3600' });
        if(up1.error) throw up1.error;
        setProgress(60);
        let coverMsg = '（未上傳封面）';
        if(cover){
          const coverPath = `${category}/${slug}.cover.jpg`;
          const up2 = await supa.storage.from(ASSETS_BUCKET).upload(coverPath, cover, { upsert:true, cacheControl:'3600' });
          if(up2.error) throw up2.error;
          coverMsg = `封面：${coverPath}`;
        }
        setProgress(100);
        el('#uploadLog').innerHTML = `✅ 完成：<span class="mono">${VIDEOS_BUCKET}/${mp4Path}</span>；${coverMsg}`;
      }catch(err){
        setProgress(0);
        el('#uploadLog').textContent = '❌ 上傳失敗：' + err.message;
      }
    });

    // 啟動
    loadProfiles();
  </script>
</body>
</html>












