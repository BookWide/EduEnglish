
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BookWide Admin · v20251106-fix403-ai15-supa</title>
  <style>
    :root{--c:#1a73e8;--b:#0b57d0;--g:#18a957;--r:#d23f31}
    *{box-sizing:border-box} body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#fafafa;color:#111}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:12px 16px;z-index:9}
    h1{margin:0;font-size:20px}
    .container{max-width:1100px;margin:18px auto;padding:0 12px}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    label{font-size:12px;color:#666;display:block;margin-bottom:6px}
    input[type=text], input[type=number], select, textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;background:#fff}
    input[type=file]{padding:6px}
    textarea{min-height:110px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:14px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--c);color:#fff;background:var(--c);padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn.secondary{background:#fff;color:var(--c)}
    .btn.green{background:var(--g);border-color:var(--g)}
    .btn.gray{background:#f2f4f7;border-color:#e5e7eb;color:#111}
    .btn.red{background:var(--r);border-color:var(--r)}
    .muted{color:#777;font-size:12px}
    .pill{background:#eef4ff;color:#1a48b5;padding:2px 8px;border-radius:999px;font-size:12px}
    .hl{font-weight:700}
    .status{font-size:12px;white-space:pre-wrap;background:#0b10221a;padding:10px;border-radius:8px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .title{font-weight:700}
    .sticky-actions{position:sticky;bottom:0;background:#fff;border-top:1px solid #eee;padding:10px 12px;z-index:5}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .warn{color:#b15b00}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
</head>
<body>
<header class="row">
  <h1>BookWide Admin 主控台 <span class="pill">v20251106 · AI 15 題 · GitHub + 字幕支援 + Supabase 上傳</span></h1>
</header>

<div class="container grid g2">
  <!-- 左：基本資料 -->
  <section class="card">
    <div class="title">MP4 上傳自動化（含字幕匯入、JSON 預覽）</div>
    <div class="grid g3" style="margin-top:10px">
      <div>
        <label>分類</label>
        <select id="cat">
          <option value="story">story</option>
          <option value="music" selected>music</option>
          <option value="movie">movie</option>
          <option value="news">news</option>
          <option value="pro">pro</option>
        </select>
      </div>
      <div>
        <label>Slug（不含空白與副檔名）</label>
        <input id="slug" type="text" placeholder="例如 applesong" value="applesong" />
      </div>
      <div>
        <label>顯示標題（可空）</label>
        <input id="title" type="text" placeholder="顯示標題（可空）" value="A Little Love" />
      </div>
    </div>

    <div class="grid g3" style="margin-top:10px">
      <div>
        <label>MP4 檔</label>
        <input id="mp4File" type="file" accept="video/mp4" />
      </div>
      <div>
        <label>封面（可選，建議 JPG）</label>
        <input id="coverFile" type="file" accept="image/*" />
      </div>
      <div>
        <label>字幕檔（可選，支援 .txt / .srt / .vtt / .json）</label>
        <input id="subFile" type="file" accept=".txt,.srt,.vtt,.json" />
      </div>
    </div>

    <div class="grid g3" style="margin-top:10px">
      <div>
        <label>中/日 產生模式</label>
        <div class="row">
          <label class="row"><input id="modeSimple" type="radio" name="mtmode" checked />&nbsp;簡易（只產生 en，zh/ja 留空）</label>
          <label class="row"><input id="modeMT" type="radio" name="mtmode" />&nbsp;機翻（透過 Edge Function）</label>
        </div>
      </div>
      <div>
        <label>機翻 Edge Function 名稱（可空）</label>
        <input id="edgeFn" type="text" placeholder="例如：mt-translate" value="mt-translate" />
      </div>
      <div>
        <label>吸附窗（s）</label>
        <input id="snapWin" type="number" step="0.05" value="0.25" />
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn gray" id="btnPreview">預覽 JSON（5 件）</button>
    </div>

    <div style="margin-top:12px">
      <label>輸出預覽</label>
      <textarea id="boxIndex" class="mono" placeholder="index.json 預覽會出現在這裡"></textarea>
      <div class="grid g2" style="margin-top:8px">
        <textarea id="boxCues" class="mono" placeholder="cues-*.json"></textarea>
        <textarea id="boxQuiz" class="mono" placeholder="quiz-*.json（AI 15 題）"></textarea>
        <textarea id="boxVocab" class="mono" placeholder="vocab-*.json"></textarea>
        <textarea id="boxAI" class="mono" placeholder="ai-*.json"></textarea>
      </div>
    </div>
  </section>

  <!-- 右：上傳與整合 -->
  <section class="card">
    <div class="title">Supabase 上傳（影片＋封面）</div>
    <div class="muted">優先使用 <span class="mono">window.BW?.supa</span>。若沒有，請手動填入以下設定建立連線。</div>
    <div class="grid g2" style="margin-top:8px">
      <div>
        <label>Supabase URL（可空）</label>
        <input id="sbUrl" type="text" placeholder="https://xxxx.supabase.co" />
      </div>
      <div>
        <label>Supabase anon key（可空）</label>
        <input id="sbKey" type="text" placeholder="ey..." />
      </div>
    </div>
    <div class="grid g3" style="margin-top:8px">
      <div>
        <label>影片桶名</label>
        <input id="bucketVideo" type="text" value="videos" />
      </div>
      <div>
        <label>封面桶名</label>
        <input id="bucketAsset" type="text" value="assets" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn green" id="btnSupaUpload">上傳到 Supabase（影片＋封面）</button>
      </div>
    </div>
    <pre id="supaStatus" class="status" style="margin-top:8px"></pre>

    <hr style="margin:16px 0;border:none;border-top:1px solid #eee" />
    <div class="title">GitHub 上傳設定（僅本機暫存，不會保留）</div>
    <div class="grid g3" style="margin-top:8px">
      <div>
        <label>Owner（使用者或組織）</label>
        <input id="ghOwner" type="text" value="bookwide" />
      </div>
      <div>
        <label>Repo</label>
        <input id="ghRepo" type="text" value="EduEnglish" />
      </div>
      <div>
        <label>Branch</label>
        <input id="ghBranch" type="text" value="main" />
      </div>
    </div>
    <div class="grid g3" style="margin-top:8px">
      <div>
        <label>Base Path（可留空，例：data/）</label>
        <input id="ghBase" type="text" value="data/" />
      </div>
      <div>
        <label>Commit 訊息</label>
        <input id="ghMsg" type="text" value="Add JSON templates" />
      </div>
      <div>
        <label>GitHub Token（Classic PAT：包含 repo、workflow）</label>
        <input id="ghTok" type="text" placeholder="ghp_xxx" />
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="btnUploadGithub">上傳到 GitHub（5 件）</button>
      <div class="muted">路徑：<span class="mono">basePath/data/{category}/{slug}/</span></div>
    </div>
    <pre id="ghStatus" class="status" style="margin-top:8px"></pre>
  </section>
</div>

<div class="sticky-actions flex container">
  <div class="muted">提示：字幕 .txt 會視為「每行一句」；.srt/.vtt 會自動解析時間。三語同檔 cues = <span class="mono">[{ time, en, ja, zh }]</span>。</div>
  <div class="right"></div>
</div>

<script>
/* ------------------------- 小工具 ------------------------- */
const $ = (s)=>document.querySelector(s);
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
const b64 = (s)=>btoa(unescape(encodeURIComponent(s)));
function pad(n){return String(n).padStart(2,'0')}
function sec2mmss(t){ t=Math.max(0, Math.round(t)); return `${pad(Math.floor(t/60))}:${pad(t%60)}` }

/* 解析字幕：支援 txt / srt / vtt / json -> 回傳 [{time,en,ja,zh}] （只填 en） */
async function parseSubtitleFile(file){
  if(!file) return [];
  const name=file.name.toLowerCase();
  const text=await file.text();

  // 如果是 JSON，嘗試讀三語同檔
  if(name.endsWith('.json')){
    try{
      const arr=JSON.parse(text);
      if(Array.isArray(arr) && arr.length && ('time' in arr[0])){
        return arr.map(x=>({time:x.time,en:x.en||'',ja:x.ja||'',zh:x.zh||''}));
      }
    }catch(e){}
  }

  // .srt or .vtt
  if(name.endsWith('.srt')||name.endsWith('.vtt')){
    const lines=text.replace(/\r/g,'').split('\n');
    const out=[];
    let cur=null;
    const timeRe=/(\d\d:\d\d:\d\d)[,\.](\d\d\d)\s*-->\s*(\d\d:\d\d:\d\d)[,\.](\d\d\d)/;
    for(const ln of lines){
      const m=timeRe.exec(ln);
      if(m){
        const t=m[1]; // 取 start
        cur={time:t.slice(0,5), en:''};
        continue;
      }
      if(!ln.trim()){
        if(cur){ out.push({...cur,ja:'',zh:''}); cur=null; }
      }else if(cur){
        cur.en = (cur.en?cur.en+' ':'') + ln.trim();
      }
    }
    if(cur) out.push({...cur,ja:'',zh:''});
    return out;
  }

  // .txt：每行一句
  const arr = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const res = arr.map((line,i)=>({ time: sec2mmss(i*4), en: line, ja:'', zh:'' }));
  return res;
}

/* 產生五件 JSON：index / cues(三語同檔) / quiz(15題) / vocab / ai */
function buildJSON({cat,slug,title,cues}){
  const base=`${cat}/${slug}`;
  const index = {
    slug, title,
    video: `videos/${cat}/${slug}.mp4`,
    cover: `assets/${cat}/${slug}/cover.jpg`,
    category: cat,
    updatedAt: new Date().toISOString()
  };

  // cues 三語同檔
  const cues3 = cues;

  // quiz：AI 15 題（空白模板）
  const quiz = {
    title: "Lesson",
    topics: Array.from({length:15}, (_,i)=>({
      title:`Topic ${i+1}`,
      prompt:"",
      hint:"",
      sample:""
    }))
  };

  // vocab：先空模板
  const vocab = {
    words: [] // {en:"", zh:"", ja:""}
  };

  // ai：先空模板
  const ai = {
    tasks: []
  };

  return { index, cues3, quiz, vocab, ai };
}

/* 機翻（可選）：呼叫 Edge Function（POST JSON：{text, from:"en", to:"zh"|"ja"}） */
async function mtTranslateArray(fnName, arr, to){
  if(!fnName) return arr.map(s=>'');
  try{
    const url = `${location.origin}/functions/v1/${fnName}`; // 讓你在 Supabase Edge Functions 部署後可直接同網域測
    const out=[];
    for(const s of arr){
      const r= await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({text:s, from:'en', to})});
      if(!r.ok){ out.push(''); continue; }
      const j= await r.json().catch(()=>null);
      out.push(j?.text || '');
      await sleep(120);
    }
    return out;
  }catch(e){ return arr.map(()=> '') }
}

/* 綁定：預覽 JSON（5 件） */
$('#btnPreview').addEventListener('click', async ()=>{
  const cat=$('#cat').value.trim();
  const slug=$('#slug').value.trim();
  const title=$('#title').value.trim();
  const sub=$('#subFile').files[0];

  const cuesEN = await parseSubtitleFile(sub);
  let cues = cuesEN.map(x=>({...x}));

  // 機翻選項
  if($('#modeMT').checked && cues.length){
    const fn=$('#edgeFn').value.trim();
    const enArr = cues.map(x=>x.en);
    const zhArr = await mtTranslateArray(fn, enArr, 'zh');
    const jaArr = await mtTranslateArray(fn, enArr, 'ja');
    cues = cues.map((x,i)=>({...x, zh: zhArr[i]||'', ja: jaArr[i]||'' }));
  }

  const {index,cues3,quiz,vocab,ai} = buildJSON({cat,slug,title,cues});
  $('#boxIndex').value = JSON.stringify(index, null, 2);
  $('#boxCues').value  = JSON.stringify(cues3, null, 2);
  $('#boxQuiz').value  = JSON.stringify(quiz, null, 2);
  $('#boxVocab').value = JSON.stringify(vocab, null, 2);
  $('#boxAI').value    = JSON.stringify(ai, null, 2);
});

/* ------------------------- Supabase 上傳 ------------------------- */
function getSupaClient(){
  // 優先使用 window.BW.supa
  if (window.BW && window.BW.supa && window.BW.supa.createClient) {
    return window.BW.supa.createClient();
  }
  const url=$('#sbUrl').value.trim();
  const key=$('#sbKey').value.trim();
  if(!url || !key) return null;
  return supabase.createClient(url,key);
}

async function supaUpload(bucket, path, file, client){
  const { data, error } = await client.storage.from(bucket).upload(path, file, { upsert:true, contentType: file.type || undefined });
  if(error) throw error;
  // 轉 public URL（需桶設定為 public 或有政策）
  const { data:pub } = client.storage.from(bucket).getPublicUrl(path);
  return pub.publicUrl;
}

$('#btnSupaUpload').addEventListener('click', async ()=>{
  const st=$('#supaStatus'); st.textContent='';
  const cat=$('#cat').value.trim();
  const slug=$('#slug').value.trim();
  const mp4=$('#mp4File').files[0];
  const cover=$('#coverFile').files[0];
  if(!mp4){ st.textContent='[錯誤] 請先選擇 MP4 檔。'; return; }

  const client=getSupaClient();
  if(!client){ st.textContent='[錯誤] 找不到 Supabase 連線（BW.supa 或手動 URL/KEY）。'; return; }

  const bucketV=$('#bucketVideo').value.trim()||'videos';
  const bucketA=$('#bucketAsset').value.trim()||'assets';
  const pathV = `${cat}/${slug}.mp4`;
  const pathC = `${cat}/${slug}/cover.jpg`;

  try{
    st.textContent+='[1/2] 上傳影片中...\n';
    const vUrl = await supaUpload(bucketV, pathV, mp4, client);
    st.textContent+=`    影片 URL → ${vUrl}\n`;

    let cUrl='';
    if(cover){
      st.textContent+='[2/2] 上傳封面中...\n';
      cUrl = await supaUpload(bucketA, pathC, cover, client);
      st.textContent+=`    封面 URL → ${cUrl}\n`;
    }else{
      st.textContent+='[2/2] 未選封面，略過。\n';
    }

    // 若頁面有 index 預覽，補上 URL
    if($('#boxIndex').value){
      try{
        const idx=JSON.parse($('#boxIndex').value);
        if(vUrl) idx.video = vUrl;
        if(cUrl) idx.cover = cUrl;
        $('#boxIndex').value = JSON.stringify(idx,null,2);
      }catch(e){}
    }
    st.textContent+='完成。';
  }catch(e){
    st.textContent+=`[失敗] ${e.message||e}`;
  }
});

/* ------------------------- GitHub 上傳 ------------------------- */
async function ghPutFile({owner,repo,branch,token,path,content,message}){
  const url=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
  const body={ message, branch, content: b64(content) };
  const r = await fetch(url, {method:'PUT', headers:{'Authorization':`token ${token}`,'Content-Type':'application/json'}, body:JSON.stringify(body)});
  if(!r.ok){
    const t=await r.text();
    throw new Error(`HTTP ${r.status} – ${t}`);
  }
  return await r.json();
}

$('#btnUploadGithub').addEventListener('click', async ()=>{
  const st=$('#ghStatus'); st.textContent='';
  const owner=$('#ghOwner').value.trim();
  const repo=$('#ghRepo').value.trim();
  const branch=$('#ghBranch').value.trim();
  const base=($('#ghBase').value||'').trim();
  const token=$('#ghTok').value.trim();
  const msg=$('#ghMsg').value.trim()||'Add JSON';

  if(!owner||!repo||!branch||!token){ st.textContent='[錯誤] 請填 owner / repo / branch / token'; return; }

  const cat=$('#cat').value.trim();
  const slug=$('#slug').value.trim();

  const index = $('#boxIndex').value;
  const cues  = $('#boxCues').value;
  const quiz  = $('#boxQuiz').value;
  const vocab = $('#boxVocab').value;
  const ai    = $('#boxAI').value;
  if(!(index&&cues&&quiz&&vocab&&ai)){ st.textContent='[錯誤] 請先點「預覽 JSON」讓 5 件內容產生。'; return; }

  const root = `${base ? base.replace(/\/?$/,'/') : ''}data/${cat}/${slug}`;
  const files = [
    {name:`${root}/index.json`, content:index},
    {name:`${root}/cues-${slug}.json`, content:cues},
    {name:`${root}/quiz-${slug}.json`, content:quiz},
    {name:`${root}/vocab-${slug}.json`, content:vocab},
    {name:`${root}/ai-${slug}.json`, content:ai},
  ];

  try{
    let i=0;
    for(const f of files){
      i++;
      st.textContent+=`[${i}/5] 上傳 ${f.name}...\n`;
      await ghPutFile({owner,repo,branch,token,path:f.name,content:f.content,message:msg});
      await sleep(180);
    }
    st.textContent+='完成。';
  }catch(e){
    st.textContent+=`[失敗] ${e.message||e}`;
  }
});
</script>
</body>
</html>


















































































