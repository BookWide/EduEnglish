<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin Â· ä¸Šå‚³è‡ªå‹•åŒ–ï¼‹å­—å¹•åŒ¯å…¥ï¼ˆTXT/SRT/VTT/JSONï¼‰ï¼‹AI 15é¡Œï¼‹GitHub Â· v20251106_txtsub</title>
  <script type="module" src="./supa.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <style>
    :root{ --bg:#ffffff; --fg:#111; --muted:#6b7280; --muted-2:#9ca3af; --line:#e5e7eb;
           --brand:#2563eb; --chip:#eef2ff; --ok:#16a34a; --warn:#f59e0b; --card:#fafafa; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","PingFang TC","Noto Sans CJK TC","å¾®è»Ÿæ­£é»‘é«”",sans-serif}
    header{padding:18px 20px;border-bottom:1px solid var(--line);display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .title{font-size:22px;font-weight:700;margin-right:auto}
    .chip{display:inline-block;padding:.35rem .6rem;border-radius:999px;background:var(--chip);color:var(--brand);font-size:12px}
    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab-btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:.5rem 1rem;cursor:pointer}
    .tab-btn.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    .wrap{max-width:1120px;margin:24px auto;padding:0 16px}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0 16px}
    .input, select, textarea{border:1px solid var(--line);border-radius:10px;padding:.55rem .8rem;background:#fff;font-family:inherit;font-size:14px}
    .btn{border:1px solid var(--brand);background:var(--brand);color:#fff;border-radius:10px;padding:.55rem .9rem;cursor:pointer}
    .btn.outline{background:#fff;color:var(--brand)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
    .table th,.table td{padding:.75rem .8rem;border-bottom:1px solid var(--line);text-align:left}
    .table th{background:var(--card);font-weight:600;color:#222}
    .muted{color:var(--muted)} .hint{color:var(--muted-2);font-size:13px}
    .hr{height:1px;background:var(--line);margin:18px 0}
    .row{display:grid;gap:12px}
    .grid-2{grid-template-columns:1fr 1fr}
    .grid-3{grid-template-columns:1fr 1fr 1fr}
    @media (max-width:900px){ .grid-2,.grid-3{grid-template-columns:1fr} }
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px}
    footer{padding:22px 20px;color:var(--muted);border-top:1px solid var(--line);text-align:center;margin-top:28px}
    .drop{border:2px dashed var(--line);border-radius:12px;padding:18px;text-align:center;background:#fff}
    .progress{height:10px;background:#eef2ff;border-radius:99px;overflow:hidden}
    .bar{height:100%;width:0;background:#2563eb;transition:width .2s}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .jsonbox{width:100%;min-height:160px;white-space:pre;overflow:auto}
    .note{display:inline-block;padding:.2rem .5rem;border-radius:6px;background:#fff;border:1px solid var(--line);font-size:12px;color:#555}
  </style>
</head>
<body>
  <header>
    <div class="title">BookWide Admin ä¸»æ§å°</div>
    <span class="chip">v20251106 Â· AI 15 é¡Œ Â· GitHub Â· å­—å¹•æ”¯æ´</span>
    <nav class="tabs">
      <button class="tab-btn active" data-tab="users">ä½¿ç”¨è€…æ¸…å–®</button>
      <button class="tab-btn" data-tab="roles">æˆæ¬Šç®¡ç†</button>
      <button class="tab-btn" data-tab="mp4">MP4 ä¸Šå‚³ + JSON + GitHub</button>
    </nav>
  </header>

  <main class="wrap">
    <!-- 1) ä½¿ç”¨è€…æ¸…å–® -->
    <section id="panel-users">
      <div class="toolbar">
        <input id="q" class="input" style="min-width:260px" placeholder="æœå°‹ Email / é¡¯ç¤ºåç¨±â€¦" />
        <button id="btnRefresh" class="btn outline">é‡æ–°æ•´ç†</button>
        <span class="hint">è³‡æ–™è¡¨ï¼š<b>public.profiles</b> Â· å°ç£æ™‚å€ Â· æœ€è¿‘ 10 åˆ†é˜ã€Œåœ¨ç·šã€ã€‚</span>
      </div>
      <table class="table" id="usersTable">
        <thead><tr>
          <th>Email</th><th>é¡¯ç¤ºåç¨±</th><th>æœ€å¾Œç™»å…¥</th><th>æœ€è¿‘åœ¨ç·š</th><th>ç®¡ç†å“¡</th><th>ç‹€æ…‹</th><th>åˆ°æœŸæ—¥</th>
        </tr></thead>
        <tbody><tr><td colspan="7" class="muted">ç­‰å¾…è¼‰å…¥â€¦ï¼ˆéœ€ç™»å…¥ä¸”å…·ç®¡ç†å“¡ï¼‰</td></tr></tbody>
      </table>
    </section>

    <!-- 2) æˆæ¬Šç®¡ç† -->
    <section id="panel-roles" style="display:none">
      <div class="card">
        <div class="row grid-3">
          <div><label class="muted">Email</label><input id="roleEmail" class="input" placeholder="user@example.com"></div>
          <div>
            <label class="muted">å‹•ä½œ</label>
            <select id="roleAction" class="input">
              <option value="grant-admin">æˆäºˆç®¡ç†å“¡</option>
              <option value="revoke-admin">ç§»é™¤ç®¡ç†å“¡</option>
              <option value="pause">æš«åœç™»å…¥</option>
              <option value="unpause">è§£é™¤æš«åœ</option>
            </select>
          </div>
          <div style="display:flex;align-items:flex-end"><button id="btnApplyRole" class="btn">å¥—ç”¨</button></div>
        </div>
        <div class="hr"></div>
        <div class="hint">ç›´æ¥æ›´æ–° <b>public.profiles</b> æ¬„ä½ï¼š<code class="mono">is_admin</code> / <code class="mono">is_paused</code>ã€‚</div>
        <div id="roleMsg" class="muted" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- 3) MP4 + å­—å¹• + JSON + GitHub -->
    <section id="panel-mp4" style="display:none">
      <div class="card">
        <h3 style="margin:6px 0 10px">MP4 ä¸Šå‚³è‡ªå‹•åŒ–ï¼ˆå«å­—å¹•åŒ¯å…¥ã€JSON é è¦½ã€GitHub ä¸Šå‚³ï¼‰</h3>
        <div class="hint" style="margin-bottom:10px">
          <span class="note">å­—å¹•æ”¯æ´ï¼šTXT / SRT / VTT / JSONï¼ˆä¸‰èªåŒæª”ï¼‰</span>
          <span class="note" style="margin-left:6px">åŒ¯å…¥è‹±æ–‡ â†’ ç”¢å‡º en/zh/jaï¼ˆç°¡æ˜“/æ©Ÿç¿»äºŒé¸ä¸€ï¼‰</span>
        </div>

        <div class="row grid-3">
          <div><label class="muted">åˆ†é¡</label>
            <select id="cat" class="input">
              <option value="story">story</option>
              <option value="music" selected>music</option>
              <option value="movie">movie</option>
              <option value="news">news</option>
              <option value="pro">pro</option>
            </select></div>
          <div><label class="muted">Slugï¼ˆä¸å«ç©ºç™½èˆ‡å‰¯æª”åï¼‰</label>
            <input id="slug" class="input" placeholder="alittlelove"></div>
          <div><label class="muted">é¡¯ç¤ºæ¨™é¡Œï¼ˆå¯ç©ºï¼‰</label>
            <input id="title" class="input" placeholder="A Little Love"></div>
        </div>

        <div class="row grid-3" style="margin-top:12px">
          <div>
            <label class="muted">MP4 æª”ï¼ˆå¯æ‹–æ‹‰åˆ°æ¡†å…§ï¼‰</label>
            <div id="drop" class="drop">
              <input id="mp4File" type="file" accept="video/mp4" style="display:none">
              <div>å°‡æª”æ¡ˆæ‹–æ›³åˆ°æ­¤è™•ï¼Œæˆ– <button id="picker" class="btn outline" type="button">é¸æ“‡æª”æ¡ˆ</button></div>
              <div id="chosen" class="hint" style="margin-top:6px">å°šæœªé¸æª”</div>
              <div class="progress" style="margin-top:8px"><div id="bar" class="bar"></div></div>
            </div>
          </div>
          <div>
            <label class="muted">å°é¢ï¼ˆå¯é¸ï¼‰</label>
            <input id="coverFile" type="file" accept="image/*" class="input">
          </div>
          <div>
            <label class="muted">å­—å¹•æª”ï¼ˆå¯é¸ï¼‰</label>
            <input id="subFile" type="file" class="input" accept=".txt,.srt,.vtt,.json">
          </div>
        </div>

        <div class="row grid-3" style="margin-top:8px">
          <div>
            <label class="muted">å…¬é–‹ç‹€æ…‹</label>
            <select id="isPublic" class="input"><option value="true">å…¬é–‹</option><option value="false">éå…¬é–‹</option></select>
          </div>
          <div>
            <label class="muted">ä¸­/æ—¥æ–‡ç”¢ç”Ÿæ¨¡å¼</label>
            <div style="display:flex;gap:10px;align-items:center">
              <label class="hint"><input type="radio" name="mt" value="simple" checked> ç°¡æ˜“ï¼ˆåªç”¢ enï¼Œzh/ja ç•™ç©ºï¼‰</label>
              <label class="hint"><input type="radio" name="mt" value="edge"> æ©Ÿç¿»ï¼ˆEdge Functionï¼š<code class="mono">mt-translate</code>ï¼‰</label>
            </div>
          </div>
          <div>
            <label class="muted">è‡ªå‹•å°é½Šï¼ˆå¯é¸ï¼‰</label>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <label class="hint" style="display:flex;align-items:center;gap:6px"><input id="autoAlign" type="checkbox" checked> éœéŸ³å¸é™„</label>
              <label class="muted">RMS</label><input id="th" class="input" type="number" step="0.0001" value="0.008" style="width:110px">
              <label class="muted">æœ€çŸ­éœéŸ³</label><input id="sil" class="input" type="number" step="0.05" value="0.25" style="width:110px">
              <label class="muted">çª—å£(Â±s)</label><input id="win" class="input" type="number" step="0.1" value="1.5" style="width:110px">
            </div>
          </div>
        </div>

        <div class="row grid-3" style="margin-top:12px">
          <div style="display:flex;align-items:flex-end;gap:10px">
            <button id="btnBuild" class="btn outline">é è¦½ JSONï¼ˆ5 ä»¶ï¼‰</button>
            <a id="zipLink" class="btn outline" href="#" download style="display:none">ä¸‹è¼‰ JSON ZIP</a>
          </div>
          <div style="display:flex;align-items:flex-end">
            <span class="hint">é è¨­è·¯å¾‘ï¼š<code class="mono">data/{category}/{slug}/</code> Â· <b>cues ç‚ºä¸‰èªåŒæª”</b>ï¼ˆen/zh/jaï¼‰ã€‚</span>
          </div>
        </div>

        <div class="row grid-2" style="margin-top:12px">
          <div>
            <label class="muted">GitHub è¨­å®š</label>
            <div class="row grid-3">
              <input id="ghOwner" class="input" placeholder="Owner" value="bookwide">
              <input id="ghRepo" class="input" placeholder="Repo" value="EduEnglish">
              <input id="ghBranch" class="input" placeholder="Branch" value="main">
            </div>
            <div class="row grid-3" style="margin-top:8px">
              <input id="ghBase" class="input" placeholder="Base Pathï¼ˆå¯ç©ºï¼Œé è¨­ data/{cat}/{slug}/ ï¼‰">
              <input id="ghMsg" class="input" placeholder="Commit è¨Šæ¯" value="Add JSON templates">
              <input id="ghToken" class="input" placeholder="GitHub Tokenï¼ˆclassic ghp_â€¦ï¼‰">
            </div>
            <div style="display:flex;gap:10px;align-items:center;margin-top:8px">
              <button id="btnGhTest" class="btn outline">æ¸¬è©¦ Token</button>
              <button id="btnGhUpload" class="btn">ä¸Šå‚³åˆ° GitHubï¼ˆ5 æª”ï¼‰</button>
              <div id="ghStatus" class="hint"></div>
            </div>
          </div>
          <div>
            <label class="muted">ç”¢å‡ºé è¦½</label>
            <div class="hint">index / cues / vocab / quiz / ai</div>
          </div>
        </div>

        <div class="hr"></div>
        <div class="row grid-2">
          <div><label class="muted">index-*.json</label><textarea id="boxIndex" class="jsonbox mono" readonly></textarea></div>
          <div><label class="muted">cues-*.jsonï¼ˆen/zh/jaï¼‰</label><textarea id="boxCues" class="jsonbox mono" readonly></textarea></div>
          <div><label class="muted">vocab-*.json</label><textarea id="boxVocab" class="jsonbox mono" readonly></textarea></div>
          <div><label class="muted">quiz-*.jsonï¼ˆ80 é¡Œï¼‰</label><textarea id="boxQuiz" class="jsonbox mono" readonly></textarea></div>
          <div><label class="muted">ai-*.jsonï¼ˆå›ºå®š 15 é¡Œï¼‰</label><textarea id="boxAI" class="jsonbox mono" readonly></textarea></div>
        </div>

        <div class="hr"></div><div id="upMsg" class="muted">å°±ç·’ã€‚</div>
      </div>
    </section>
  </main>

  <footer>BookWide Admin Â· å…§åµŒç‰ˆ Â· v20251106_txtsub</footer>

<script type="module">
/* ------------ å°å·¥å…· ------------ */
const $=(q,r)=> (r||document).querySelector(q);
const $$=(q,r)=> Array.from((r||document).querySelectorAll(q));
const pad2=n=> String(n).padStart(2,'0');
const b64=s=> btoa(unescape(encodeURIComponent(s)));
const fmtTW=ts=> !ts?'':new Date(ts).toLocaleString('zh-TW',{timeZone:'Asia/Taipei',hour12:false});
function mmss(s){ s=Math.max(0,Math.round(s)); return `${pad2(Math.floor(s/60))}:${pad2(s%60)}`; }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* ------------ åˆ†é  ------------ */
$$('.tab-btn').forEach(btn=>btn.addEventListener('click',()=>{
  $$('.tab-btn').forEach(x=>x.classList.remove('active'));
  btn.classList.add('active');
  const t=btn.dataset.tab;
  $('#panel-users').style.display=(t==='users')?'':'none';
  $('#panel-roles').style.display=(t==='roles')?'':'none';
  $('#panel-mp4'  ).style.display=(t==='mp4')  ?'':'none';
}));

/* ------------ ä½¿ç”¨è€…æ¸…å–®ï¼ˆè‹¥æœ‰ supa.jsï¼‰------------ */
(async function initProfiles(){
  if(!(window.BW && window.BW.supa)) return;
  try{ await (BW.requireAdmin?BW.requireAdmin():Promise.resolve()); BW.startHeartbeat&&BW.startHeartbeat(2);}catch{}
  async function load(){
    const tbody=$('#usersTable tbody'); tbody.innerHTML='<tr><td class="muted" colspan="7">è¼‰å…¥ä¸­â€¦</td></tr>';
    const cols='email, display_name, is_admin, is_paused, last_sign_in_at, last_seen_at, expires_at';
    const r=await BW.supa.from('profiles').select(cols).order('email',{ascending:true});
    if(r.error){ tbody.innerHTML='<tr><td class="muted" colspan="7">è®€å–å¤±æ•—ï¼š'+r.error.message+'</td></tr>'; return; }
    const q=($('#q').value||'').trim().toLowerCase();
    const rows=(r.data||[]).filter(x=> !q || (x.email||'').toLowerCase().includes(q) || (x.display_name||'').toLowerCase().includes(q));
    if(!rows.length){ tbody.innerHTML='<tr><td class="muted" colspan="7">æ²’æœ‰ç¬¦åˆçš„è³‡æ–™</td></tr>'; return; }
    tbody.innerHTML=rows.map(x=>{
      const online = BW.isOnlineWithin ? BW.isOnlineWithin(x.last_seen_at,10) : false;
      return `<tr>
        <td>${x.email||''}</td>
        <td>${x.display_name||''}</td>
        <td>${fmtTW(x.last_sign_in_at)||''}</td>
        <td>${fmtTW(x.last_seen_at)||''}${online?' Â· åœ¨ç·š':''}</td>
        <td>${x.is_admin?'æ˜¯':'å¦'}</td>
        <td>${x.is_paused?'æš«åœ':'æ­£å¸¸'}</td>
        <td>${x.expires_at||''}</td>
      </tr>`;
    }).join('');
  }
  $('#btnRefresh').addEventListener('click',load); $('#q').addEventListener('input',load); load();
})();

/* ------------ MP4 / é€²åº¦æ¢ ------------ */
const drop=$('#drop'), picker=$('#picker'), mp4Input=$('#mp4File'), chosen=$('#chosen'), bar=$('.bar');
picker.addEventListener('click',()=>mp4Input.click());
drop?.addEventListener('dragover',e=>{e.preventDefault(); drop.classList.add('drag');});
drop?.addEventListener('dragleave',()=>drop.classList.remove('drag'));
drop?.addEventListener('drop',e=>{ e.preventDefault(); drop.classList.remove('drag'); const f=e.dataTransfer.files?.[0]; if(f){ mp4Input.files=e.dataTransfer.files; reflectChoose(); }});
mp4Input.addEventListener('change',reflectChoose);
function reflectChoose(){
  const f=mp4Input.files?.[0];
  if(!f){ chosen.textContent='å°šæœªé¸æª”'; return; }
  chosen.textContent=`${f.name} Â· ${(f.size/1024/1024).toFixed(2)} MB`;
  if(!$('#slug').value){ $('#slug').value=f.name.replace(/\.mp4$/i,'').replace(/\s+/g,'-').toLowerCase().slice(0,80); }
}
function setBar(p){ if(!bar) return; bar.style.width=Math.max(3,Math.min(100,p))+'%'; }
async function getVideoDuration(file){
  return new Promise(res=>{
    const v=document.createElement('video'); v.preload='metadata';
    v.onloadedmetadata=()=>{ res(Math.round(v.duration||0)); URL.revokeObjectURL(v.src); };
    v.onerror=()=>res(0); v.src=URL.createObjectURL(file);
  });
}

/* ------------ å­—å¹•è§£æï¼šTXT/SRT/VTT/JSON ------------ */
let subParsed = null;  // é™£åˆ—ï¼š[{time:"MM:SS", en:"...", zh:"", ja:""}]
$('#subFile').addEventListener('change', async (e)=>{
  subParsed = null;
  const f=e.target.files?.[0]; if(!f) return;
  const name=f.name.toLowerCase();
  try{
    if(name.endsWith('.json')){
      const j=JSON.parse(await f.text());
      // æ”¯æ´å…©ç¨®ï¼š[{time,en,zh,ja}] æˆ– [{s,e,t}]
      if(Array.isArray(j)){
        subParsed=j.map(x=>{
          if('time' in x) return {time:x.time, en:(x.en??String(x.t??'')).trim(), zh:(x.zh??''), ja:(x.ja??'')};
          const s=Number(x.s||0); return {time:mmss(s), en:String(x.t??'').trim(), zh:'', ja:''};
        });
      }else{
        throw new Error('JSON éœ€ç‚ºé™£åˆ—');
      }
    }else if(name.endsWith('.srt') || name.endsWith('.vtt')){
      subParsed = parseSrtVtt(await f.text());
    }else{ // .txt
      subParsed = parseTxt(await f.text());
    }
    $('#upMsg').textContent = `âœ… å·²åŒ¯å…¥å­—å¹•ï¼š${subParsed.length} å¥`;
  }catch(err){
    $('#upMsg').textContent = 'âŒ å­—å¹•è§£æå¤±æ•—ï¼š'+err.message;
  }
});

// SRT/VTT â†’ [{time,en,zh,ja}]
function parseSrtVtt(txt){
  // å»æ‰ WEBVTT é ­
  txt = txt.replace(/^[\ufeff\s]*WEBVTT[^\n]*\n/i,'');
  const blocks = txt.split(/\r?\n\r?\n+/).map(s=>s.trim()).filter(Boolean);
  const out=[];
  for(const b of blocks){
    const lines=b.split(/\r?\n/).filter(Boolean);
    // å¯èƒ½ç¬¬ä¸€è¡Œæ˜¯åºè™Ÿ
    if(/^\d+$/.test(lines[0])) lines.shift();
    const timeLine=lines.shift()||'';
    const m=timeLine.match(/(\d{1,2}:\d{2}:\d{2}[.,]\d{1,3}|\d{1,2}:\d{2}[.,]\d{1,3})\s*-->\s*(\d{1,2}:\d{2}:\d{2}[.,]\d{1,3}|\d{1,2}:\d{2}[.,]\d{1,3})/);
    if(!m) continue;
    const hhmmss=m[1].replace(',',':').split(':'); // å–èµ·å§‹
    let s=0;
    if(hhmmss.length===3){ s=Number(hhmmss[0])*60+Number(hhmmss[1]); }
    else{ s=Number(hhmmss[0]); }
    const text = lines.join(' ').replace(/<\/?[^>]+>/g,'').trim();
    if(text) out.push({time:mmss(s), en:text, zh:'', ja:''});
  }
  return out;
}
// TXT â†’ ä¸€è¡Œä¸€å¥ï¼ˆæ™‚é–“å‡åˆ†ï¼›è‹¥å–å¾—åˆ°å½±ç‰‡é•·åº¦æœƒç”¨ä¾†ä¼°æ™‚ï¼‰
function parseTxt(txt){
  const lines = txt.replace(/\r/g,'').split('\n').map(s=>s.trim()).filter(Boolean);
  const durGuess =  mp4Input.files?.[0] ? null : 120;
  const span = Math.max(2, Math.floor((durGuess||120)/Math.max(1,lines.length)));
  const out=[]; let t=0;
  for(const line of lines){ out.push({time:mmss(t), en:line, zh:'', ja:''}); t+=span; }
  return out;
}

/* ------------ AI å›ºå®š 15 é¡Œ ------------ */
function buildAI15(title){
  const base=[
    "Describe the song.","What do you like about it?","Share your memory.",
    "Who do you sing with?","Describe the melody.","What is the message?",
    "Which line do you like most?","How does it make you feel?","When do you listen to it?",
    "What images come to mind?","What new words did you learn?","Rewrite one line in your words.",
    "If you change the ending, what is it?","What will you do after hearing it?","Recommend this song to a friendâ€”why?"
  ];
  return {title:title||"Lesson", topics: base.map((p,i)=>({title:`Topic ${i+1}`,prompt:p,hint:"",sample:""}))};
}

/* ------------ å‡è³‡æ–™åº« for vocab/quiz ------------ */
const BANK = window.BANK || {
  commonVocab:[
    {"word":"festival","pos":"n.","zh":"ç¯€æ—¥","en":"a special day"},
    {"word":"lantern","pos":"n.","zh":"ç‡ˆç± ","en":"a light in a paper cover"},
    {"word":"moon","pos":"n.","zh":"æœˆäº®","en":"the moon in the sky"},
    {"word":"reunion","pos":"n.","zh":"åœ˜èš","en":"coming together again"},
    {"word":"share","pos":"v.","zh":"åˆ†äº«","en":"to give part of something"},
    {"word":"admire","pos":"v.","zh":"æ¬£è³","en":"to enjoy looking at"},
    {"word":"tradition","pos":"n.","zh":"å‚³çµ±","en":"a custom that people follow"},
    {"word":"poem","pos":"n.","zh":"è©©","en":"a piece of writing in verse"},
    {"word":"full","pos":"adj.","zh":"åœ“çš„/æ»¿çš„","en":"complete; not empty"},
    {"word":"lunar","pos":"adj.","zh":"æœˆçš„/é™°æ›†çš„","en":"related to the moon"}
  ],
  mcDistractors:["book","tree","car","computer","movie","city","phone","river","desk","game"]
};
function pick(arr,n){ const a=arr.slice(),o=[]; while(o.length<n&&a.length){ o.push(a.splice(Math.random()*a.length|0,1)[0]); } return o; }

/* ------------ ç”¢ç”Ÿ 5 ä»½ JSON ------------ */
async function buildFiveJsonBundle(){
  const cat=$('#cat').value.trim();
  const slug=$('#slug').value.trim();
  const title=($('#title').value||slug).trim();
  const isPublic=$('#isPublic').value==='true';
  const mtMode = (document.querySelector('input[name="mt"]:checked')?.value)||'simple';

  // å½±ç‰‡æ™‚é•·
  let duration = 120;
  try{ const f=mp4Input.files?.[0]; if(f) duration = await getVideoDuration(f); }catch{}

  // cues ä¾†æºï¼šå„ªå…ˆç”¨å­—å¹•ï¼›æ²’æœ‰å°±ç”¢ placeholder
  let cues=[];
  if(subParsed && subParsed.length){
    cues = subParsed.map(x=>({time:x.time, en:x.en||"", zh:x.zh||"", ja:x.ja||""}));
    // ç°¡æ˜“ï¼šåªä¿ç•™ enï¼Œzh/ja ç•™ç©ºï¼›æ©Ÿç¿»ï¼šå˜—è©¦ç¿»æˆ zh-TW / ja-JPï¼ˆå¤±æ•—å°±ç•™ç©ºä¸¦é¡¯ç¤ºéŒ¯èª¤ï¼‰
    if(mtMode==='edge'){
      try{
        const text = cues.map(c=>c.en).join('\n');
        const zh = await callEdgeTranslate(text,'zh-TW');
        const ja = await callEdgeTranslate(text,'ja-JP');
        const zhArr = zh.split('\n'); const jaArr = ja.split('\n');
        cues = cues.map((c,i)=>({time:c.time,en:c.en,zh:zhArr[i]||"",ja:jaArr[i]||""}));
      }catch(e){
        $('#upMsg').textContent='âš ï¸ æ©Ÿç¿»å¤±æ•—ï¼š'+e.message+'ï¼ˆå·²ä¿ç•™è‹±æ–‡ï¼Œzh/ja ç©ºç™½ï¼‰';
      }
    } // simple â†’ ä¸å‹•ï¼ˆåªç”¢ enï¼‰
  }else{
    // æ²’å­—å¹•ï¼šç”¢ 20 å¥ placeholder
    const total=20, span=Math.max(2, Math.floor((duration||120)/total));
    for(let i=0,t=0;i<total;i++){ cues.push({time:mmss(t), en:"", zh:`ç¬¬ ${pad2(i+1)} å¥ï¼ˆè«‹ç·¨è¼¯ï¼‰`, ja:""}); t+=span; }
  }

  // vocab
  const vocab = pick(BANK.commonVocab, 20).map(x=>({ time:0, word:x.word, pos:x.pos, zh:x.zh, en:x.en, sample:x.example||x.en }));

  // quizï¼ˆ80ï¼‰
  function mc(q, a, wr){ const opts=pick(wr,3).concat(a).sort(()=>Math.random()-0.5); return {section:"",type:"MCQ",question:q,options:opts,answer:a,explanation:""}; }
  const wr=BANK.mcDistractors.slice(); const quiz=[];
  for(let i=0;i<20;i++){ const v=vocab[i%vocab.length]; quiz.push(mc(`What is the meaning of "${v.word}"?`, v.zh, wr)); }
  while(quiz.length<80){ quiz.push(mc("The moon is very ____ tonight.","bright",["broken","tiny","thin"])); }

  // aiï¼ˆ15ï¼‰
  const ai = buildAI15(title);

  const indexJson = {
    title, category:cat, slug,
    video:"", cover:null,
    cues:`./cues-${slug}.json`, vocab:`./vocab-${slug}.json`, quiz:`./quiz-${slug}.json`, ai:`./ai-${slug}.json`,
    is_public:isPublic
  };

  return {
    category:cat, slug,
    files:{
      [`index-${slug}.json`]: JSON.stringify(indexJson,null,2),
      [`cues-${slug}.json` ]: JSON.stringify(cues,     null,2),
      [`vocab-${slug}.json`]: JSON.stringify(vocab,    null,2),
      [`quiz-${slug}.json` ]: JSON.stringify(quiz,     null,2),
      [`ai-${slug}.json`   ]: JSON.stringify(ai,       null,2),
    }
  };
}

/* Edge Functionï¼ˆå¯é¸ï¼‰ */
async function callEdgeTranslate(text, to){
  // ä½ å·²æœ‰çš„ Edge Function åç¨±ï¼ˆè‹¥æ²’æœ‰å°±æœƒæ‹‹éŒ¯ï¼Œä¸åšè‡ªå‹• fallbackï¼‰
  const fn = 'mt-translate';
  const url = (window.BW && BW.edgeUrl) ? `${BW.edgeUrl}/${fn}` : `/functions/v1/${fn}`;
  const r = await fetch(url,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({text,to}) });
  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  const j = await r.json();
  if(!j || !j.text) throw new Error('æ ¼å¼éŒ¯èª¤');
  return j.text;
}

/* ------------ é è¦½ + ZIP ------------ */
$('#btnBuild').addEventListener('click', async ()=>{
  $('#upMsg').textContent='ç”Ÿæˆä¸­â€¦';
  const b = await buildFiveJsonBundle();
  const names=Object.keys(b.files);
  $('#boxIndex').value=b.files[names.find(n=>n.startsWith('index-'))];
  $('#boxCues').value =b.files[names.find(n=>n.startsWith('cues-'))];
  $('#boxVocab').value=b.files[names.find(n=>n.startsWith('vocab-'))];
  $('#boxQuiz').value =b.files[names.find(n=>n.startsWith('quiz-'))];
  $('#boxAI').value   =b.files[names.find(n=>n.startsWith('ai-'))];

  const zip=new JSZip(); const dir=zip.folder(`data/${b.category}/${b.slug}`); names.forEach(n=>dir.file(n,b.files[n]));
  const blob=await zip.generateAsync({type:'blob'}); const url=URL.createObjectURL(blob);
  const a=$('#zipLink'); a.href=url; a.download=`${b.category}-${b.slug}-templates.zip`; a.style.display='inline-block';
  $('#upMsg').textContent='âœ… å·²ç”Ÿæˆé è¦½èˆ‡ ZIPã€‚';
});

/* ------------ GitHub ä¸Šå‚³ï¼ˆ403 ä¿®æ³•åŒå‰ï¼‰ ------------ */
function ghPath(cat,slug,filename,base){
  if(base && base.trim()){ let p=base.replace(/^\/+|\/+$/g,''); return `${p}/${filename}`; }
  return `data/${cat}/${slug}/${filename}`;
}
$('#btnGhTest').addEventListener('click', async ()=>{
  const owner=$('#ghOwner').value.trim(), repo=$('#ghRepo').value.trim(), token=$('#ghToken').value.trim(), branch=$('#ghBranch').value.trim();
  const out=$('#ghStatus'); if(!owner||!repo||!token){ out.textContent='è«‹å¡« owner/repo/token'; return; }
  out.textContent='æ¸¬è©¦ä¸­â€¦';
  try{
    const r=await fetch(`https://api.github.com/repos/${owner}/${repo}?${Date.now()}`,{headers:{Authorization:`token ${token}`,'Accept':'application/vnd.github+json'}});
    if(r.status!==200){ out.textContent=`âŒ å¤±æ•—ï¼š${r.status}`; return; }
    const b=await fetch(`https://api.github.com/repos/${owner}/${repo}/branches/${encodeURIComponent(branch)}`,{headers:{Authorization:`token ${token}`,'Accept':'application/vnd.github+json'}});
    if(b.status!==200){ out.textContent=`âŒ æ‰¾ä¸åˆ°åˆ†æ”¯ï¼š${branch}`; return; }
    out.textContent='âœ… OKï¼Œå¯ä¸Šå‚³';
  }catch(e){ out.textContent='âŒ æ¸¬è©¦éŒ¯èª¤ï¼š'+e.message; }
});
async function ghGetSha({owner,repo,path,token,branch}){
  const url=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path).replace(/%2F/g,'/')}?ref=${encodeURIComponent(branch)}`;
  const r=await fetch(url,{headers:{Authorization:`token ${token}`,'Accept':'application/vnd.github+json'}});
  if(r.status===404) return null;
  if(!r.ok) throw new Error(`GET ${path} å¤±æ•—ï¼š${r.status} ${await r.text()}`);
  const j=await r.json(); return j.sha||null;
}
async function ghPut({owner,repo,branch,token,path,content,message}){
  const base=`https://api.github.com/repos/${owner}/${repo}/contents/`+encodeURIComponent(path).replace(/%2F/g,'/');
  const sha=await ghGetSha({owner,repo,path,token,branch});
  const body={message:message||`Add ${path}`, content:b64(content), branch}; if(sha) body.sha=sha;
  const r=await fetch(base,{method:'PUT',headers:{Authorization:`token ${token}`,'Accept':'application/vnd.github+json','Content-Type':'application/json'},body:JSON.stringify(body)});
  if(r.status!==201 && r.status!==200) throw new Error(`PUT ${path} å¤±æ•—ï¼š${r.status} ${await r.text()}`);
  return r.json();
}
$('#btnGhUpload').addEventListener('click', async ()=>{
  const owner=$('#ghOwner').value.trim(), repo=$('#ghRepo').value.trim(), branch=$('#ghBranch').value.trim();
  const token=$('#ghToken').value.trim(), msg=$('#ghMsg').value.trim()||'Add JSON templates', base=$('#ghBase').value.trim();
  const out=$('#ghStatus'); if(!owner||!repo||!branch||!token){ out.textContent='è«‹å¡«é½Š owner / repo / branch / token'; return; }
  out.textContent='æº–å‚™ JSONâ€¦';
  try{
    const b=await buildFiveJsonBundle(); const cat=b.category, slug=b.slug, names=Object.keys(b.files);
    out.textContent=`é–‹å§‹ä¸Šå‚³åˆ° data/${cat}/${slug}/ â€¦ï¼ˆå…± ${names.length} æª”ï¼‰`;
    let ok=0;
    for(const n of names){
      const path=ghPath(cat,slug,n,base);
      await ghPut({owner,repo,branch,token,path,content:b.files[n],message:msg});
      ok++; out.textContent=`âœ… å·²ä¸Šå‚³ï¼š${ok}/${names.length} â€¦ ${path}`; await sleep(120);
    }
    out.textContent=`ğŸ‰ å®Œæˆï¼šdata/${cat}/${slug}/ï¼ˆ${names.length} æª”ï¼‰`;
  }catch(e){ console.error(e); out.textContent='âŒ ä¸Šå‚³å¤±æ•—ï¼š'+e.message; }
});
</script>
</body>
</html>

















































































