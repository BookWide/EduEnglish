<!DOCTYPE html>

<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>BookWide Admin · 上傳自動化＋對齊字幕（slug 檔名版）· v20251104-2</title>
<script src="./supa.js" type="module"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>
    :root{ --bg:#ffffff; --fg:#111; --muted:#6b7280; --muted-2:#9ca3af; --line:#e5e7eb;
           --brand:#2563eb; --chip:#eef2ff; --ok:#16a34a; --warn:#f59e0b; --card:#fafafa; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","PingFang TC","Noto Sans CJK TC","微軟正黑體",sans-serif}
    header{padding:18px 20px;border-bottom:1px solid var(--line);display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .title{font-size:22px;font-weight:700;margin-right:auto}
    .chip{display:inline-block;padding:.35rem .6rem;border-radius:999px;background:var(--chip);color:var(--brand);font-size:12px}
    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab-btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:.5rem 1rem;cursor:pointer}
    .tab-btn.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    .wrap{max-width:1120px;margin:24px auto;padding:0 16px}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0 16px}
    .input, select{border:1px solid var(--line);border-radius:10px;padding:.55rem .8rem;background:#fff}
    .btn{border:1px solid var(--brand);background:var(--brand);color:#fff;border-radius:10px;padding:.55rem .9rem;cursor:pointer}
    .btn.outline{background:#fff;color:var(--brand)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
    .table th,.table td{padding:.75rem .8rem;border-bottom:1px solid var(--line);text-align:left}
    .table th{background:var(--card);font-weight:600;color:#222}
    .muted{color:var(--muted)} .hint{color:var(--muted-2);font-size:13px}
    .hr{height:1px;background:var(--line);margin:18px 0}
    .row{display:grid;gap:12px} .grid-2{grid-template-columns:1fr 1fr} .grid-3{grid-template-columns:1fr 1fr 1fr}
    @media (max-width:820px){ .grid-2,.grid-3{grid-template-columns:1fr} }
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px}
    footer{padding:22px 20px;color:var(--muted);border-top:1px solid var(--line);text-align:center;margin-top:28px}
    .pill{display:inline-block;padding:.25rem .55rem;border-radius:999px;border:1px solid var(--line);font-size:12px}
    .pill.ok{color:#16a34a;border-color:#16a34a} .pill.warn{color:#f59e0b;border-color:#f59e0b}
    .drop{border:2px dashed var(--line);border-radius:12px;padding:18px;text-align:center;background:#fff}
    .drop.drag{border-color:#2563eb;background:#f8fbff}
    .progress{height:10px;background:#eef2ff;border-radius:99px;overflow:hidden}
    .bar{height:100%;width:0;background:#2563eb;transition:width .2s}
    code{background:#f6f8fa;border:1px solid #eaeef2;border-radius:6px;padding:2px 6px}
  </style>
</head>
<body>
<header>
<div class="title">BookWide Admin 主控台</div>
<span class="chip">白底 · 單檔 · 內嵌 Supabase</span>
<nav class="tabs">
<button class="tab-btn active" data-tab="users">使用者清單</button>
<button class="tab-btn" data-tab="roles">授權 / 暫停管理員</button>
<button class="tab-btn" data-tab="mp4">MP4 上傳自動化</button>
</nav>
</header>
<main class="wrap">
<section id="panel-users">
<div class="toolbar">
<input class="input" id="q" placeholder="搜尋 Email / 顯示名稱…" style="min-width:260px"/>
<button class="btn outline" id="btnRefresh">重新整理</button>
<span class="hint">顯示資料來自 <b>public.profiles</b> · 時間以台灣時區 (Asia/Taipei) 顯示 · 每 10 分鐘內視為「在線」。</span>
</div>
<table class="table" id="usersTable">
<thead><tr>
<th>Email</th><th>顯示名稱</th><th>最後登入（台灣）</th><th>最近在線（台灣）</th><th>管理員</th><th>狀態</th><th>到期日</th>
</tr></thead>
<tbody><tr><td class="muted" colspan="7">載入中…</td></tr></tbody>
</table>
</section>
<section id="panel-roles" style="display:none">
<div class="card">
<div class="row grid-3">
<div><label class="muted">Email</label><input class="input" id="roleEmail" placeholder="user@example.com"/></div>
<div>
<label class="muted">動作</label>
<select class="input" id="roleAction">
<option value="grant-admin">授予管理員</option>
<option value="revoke-admin">移除管理員</option>
<option value="pause">暫停登入</option>
<option value="unpause">解除暫停</option>
</select>
</div>
<div style="display:flex;align-items:flex-end"><button class="btn" id="btnApplyRole">套用</button></div>
</div>
<div class="hr"></div>
<div class="hint">此區直接更新 <b>public.profiles</b> 欄位：<code>is_admin</code> / <code>is_paused</code>。</div>
<div class="muted" id="roleMsg" style="margin-top:10px"></div>
</div>
</section>
<section id="panel-mp4" style="display:none"><div id="mp4_replaced_v20251106"><style>
#mp4_replaced_v20251106{margin:6px 0}
#mp4_replaced_v20251106 .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:820px){#mp4_replaced_v20251106 .grid2{grid-template-columns:1fr}}
#mp4_replaced_v20251106 .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:14px}
#mp4_replaced_v20251106 .title{font-weight:700;margin-bottom:6px}
#mp4_replaced_v20251106 .muted{color:#6b7280;font-size:12px}
#mp4_replaced_v20251106 .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
#mp4_replaced_v20251106 label{font-size:12px;color:#6b7280;display:block;margin-bottom:6px}
#mp4_replaced_v20251106 input[type=text], 
#mp4_replaced_v20251106 input[type=number],
#mp4_replaced_v20251106 select,
#mp4_replaced_v20251106 textarea{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
#mp4_replaced_v20251106 input[type=file]{padding:6px}
#mp4_replaced_v20251106 textarea{min-height:110px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
#mp4_replaced_v20251106 .btn{appearance:none;border:1px solid #2563eb;background:#2563eb;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
#mp4_replaced_v20251106 .btn.gray{background:#f2f4f7;border-color:#e5e7eb;color:#111}
#mp4_replaced_v20251106 .btn.green{background:#16a34a;border-color:#16a34a;color:#fff}
</style><div class="grid2"><section class="card">
<div class="title">MP4 上傳自動化（含字幕匯入、JSON 預覽）</div>
<div class="grid g3" style="margin-top:10px">
<div>
<label>分類</label>
<select id="cat">
<option value="story">story</option>
<option selected="" value="music">music</option>
<option value="movie">movie</option>
<option value="news">news</option>
<option value="pro">pro</option>
</select>
</div>
<div>
<label>Slug（不含空白與副檔名）</label>
<input id="slug" placeholder="例如 applesong" type="text" value="applesong"/>
</div>
<div>
<label>顯示標題（可空）</label>
<input id="title" placeholder="顯示標題（可空）" type="text" value="A Little Love"/>
</div>
</div>
<div class="grid g3" style="margin-top:10px">
<div>
<label>MP4 檔</label>
<input accept="video/mp4" id="mp4File" type="file"/>
</div>
<div>
<label>封面（可選，建議 JPG）</label>
<input accept="image/*" id="coverFile" type="file"/>
</div>
<div>
<label>字幕檔（可選，支援 .txt / .srt / .vtt / .json）</label>
<input accept=".txt,.srt,.vtt,.json" id="subFile" type="file"/>
</div>
</div>
<div class="grid g3" style="margin-top:10px">
<div>
<label>中/日 產生模式</label>
<div class="row">
<label class="row"><input checked="" id="modeSimple" name="mtmode" type="radio"/> 簡易（只產生 en，zh/ja 留空）</label>
<label class="row"><input id="modeMT" name="mtmode" type="radio"/> 機翻（透過 Edge Function）</label>
</div>
</div>
<div>
<label>機翻 Edge Function 名稱（可空）</label>
<input id="edgeFn" placeholder="例如：mt-translate" type="text" value="mt-translate"/>
</div>
<div>
<label>吸附窗（s）</label>
<input id="snapWin" step="0.05" type="number" value="0.25"/>
</div>
</div>
<div class="row" style="margin-top:12px">
<button class="btn gray" id="btnPreview">預覽 JSON（5 件）</button>
</div>
<div style="margin-top:12px">
<label>輸出預覽</label>
<textarea class="mono" id="boxIndex" placeholder="index.json 預覽會出現在這裡"></textarea>
<div class="grid g2" style="margin-top:8px">
<textarea class="mono" id="boxCues" placeholder="cues-*.json"></textarea>
<textarea class="mono" id="boxQuiz" placeholder="quiz-*.json（AI 15 題）"></textarea>
<textarea class="mono" id="boxVocab" placeholder="vocab-*.json"></textarea>
<textarea class="mono" id="boxAI" placeholder="ai-*.json"></textarea>
</div>
</div>
</section><section class="card">
<div class="title">Supabase 上傳（影片＋封面）</div>
<div class="muted">優先使用 <span class="mono">window.BW?.supa</span>。若沒有，請手動填入以下設定建立連線。</div>
<div class="grid g2" style="margin-top:8px">
<div>
<label>Supabase URL（可空）</label>
<input id="sbUrl" placeholder="https://xxxx.supabase.co" type="text"/>
</div>
<div>
<label>Supabase anon key（可空）</label>
<input id="sbKey" placeholder="ey..." type="text"/>
</div>
</div>
<div class="grid g3" style="margin-top:8px">
<div>
<label>影片桶名</label>
<input id="bucketVideo" type="text" value="videos"/>
</div>
<div>
<label>封面桶名</label>
<input id="bucketAsset" type="text" value="assets"/>
</div>
<div>
<label> </label>
<button class="btn green" id="btnSupaUpload">上傳到 Supabase（影片＋封面）</button>
</div>
</div>
<pre class="status" id="supaStatus" style="margin-top:8px"></pre>
<hr style="margin:16px 0;border:none;border-top:1px solid #eee"/>
<div class="title">GitHub 上傳設定（僅本機暫存，不會保留）</div>
<div class="grid g3" style="margin-top:8px">
<div>
<label>Owner（使用者或組織）</label>
<input id="ghOwner" type="text" value="bookwide"/>
</div>
<div>
<label>Repo</label>
<input id="ghRepo" type="text" value="EduEnglish"/>
</div>
<div>
<label>Branch</label>
<input id="ghBranch" type="text" value="main"/>
</div>
</div>
<div class="grid g3" style="margin-top:8px">
<div>
<label>Base Path（可留空，例：data/）</label>
<input id="ghBase" type="text" value="data/"/>
</div>
<div>
<label>Commit 訊息</label>
<input id="ghMsg" type="text" value="Add JSON templates"/>
</div>
<div>
<label>GitHub Token（Classic PAT：包含 repo、workflow）</label>
<input id="ghTok" placeholder="ghp_xxx" type="text"/>
</div>
</div>
<div class="row" style="margin-top:10px">
<button class="btn" id="btnUploadGithub">上傳到 GitHub（5 件）</button>
<div class="muted">路徑：<span class="mono">basePath/data/{category}/{slug}/</span></div>
</div>
<pre class="status" id="ghStatus" style="margin-top:8px"></pre>
</section></div><script>
/* ------------------------- 小工具 ------------------------- */
const $ = (s)=>document.querySelector(s);
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
const b64 = (s)=>btoa(unescape(encodeURIComponent(s)));
function pad(n){return String(n).padStart(2,'0')}
function sec2mmss(t){ t=Math.max(0, Math.round(t)); return `${pad(Math.floor(t/60))}:${pad(t%60)}` }

/* 解析字幕：支援 txt / srt / vtt / json -> 回傳 [{time,en,ja,zh}] （只填 en） */
async function parseSubtitleFile(file){
  if(!file) return [];
  const name=file.name.toLowerCase();
  const text=await file.text();

  // 如果是 JSON，嘗試讀三語同檔
  if(name.endsWith('.json')){
    try{
      const arr=JSON.parse(text);
      if(Array.isArray(arr) && arr.length && ('time' in arr[0])){
        return arr.map(x=>({time:x.time,en:x.en||'',ja:x.ja||'',zh:x.zh||''}));
      }
    }catch(e){}
  }

  // .srt or .vtt
  if(name.endsWith('.srt')||name.endsWith('.vtt')){
    const lines=text.replace(/\r/g,'').split('\n');
    const out=[];
    let cur=null;
    const timeRe=/(\d\d:\d\d:\d\d)[,\.](\d\d\d)\s*-->\s*(\d\d:\d\d:\d\d)[,\.](\d\d\d)/;
    for(const ln of lines){
      const m=timeRe.exec(ln);
      if(m){
        const t=m[1]; // 取 start
        cur={time:t.slice(0,5), en:''};
        continue;
      }
      if(!ln.trim()){
        if(cur){ out.push({...cur,ja:'',zh:''}); cur=null; }
      }else if(cur){
        cur.en = (cur.en?cur.en+' ':'') + ln.trim();
      }
    }
    if(cur) out.push({...cur,ja:'',zh:''});
    return out;
  }

  // .txt：每行一句
  const arr = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const res = arr.map((line,i)=>({ time: sec2mmss(i*4), en: line, ja:'', zh:'' }));
  return res;
}

/* 產生五件 JSON：index / cues(三語同檔) / quiz(15題) / vocab / ai */
function buildJSON({cat,slug,title,cues}){
  const base=`${cat}/${slug}`;
  const index = {
    slug, title,
    video: `videos/${cat}/${slug}.mp4`,
    cover: `assets/${cat}/${slug}/cover.jpg`,
    category: cat,
    updatedAt: new Date().toISOString()
  };

  // cues 三語同檔
  const cues3 = cues;

  // quiz：AI 15 題（空白模板）
  const quiz = {
    title: "Lesson",
    topics: Array.from({length:15}, (_,i)=>({
      title:`Topic ${i+1}`,
      prompt:"",
      hint:"",
      sample:""
    }))
  };

  // vocab：先空模板
  const vocab = {
    words: [] // {en:"", zh:"", ja:""}
  };

  // ai：先空模板
  const ai = {
    tasks: []
  };

  return { index, cues3, quiz, vocab, ai };
}

/* 機翻（可選）：呼叫 Edge Function（POST JSON：{text, from:"en", to:"zh"|"ja"}） */
async function mtTranslateArray(fnName, arr, to){
  if(!fnName) return arr.map(s=>'');
  try{
    const url = `${location.origin}/functions/v1/${fnName}`; // 讓你在 Supabase Edge Functions 部署後可直接同網域測
    const out=[];
    for(const s of arr){
      const r= await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({text:s, from:'en', to})});
      if(!r.ok){ out.push(''); continue; }
      const j= await r.json().catch(()=>null);
      out.push(j?.text || '');
      await sleep(120);
    }
    return out;
  }catch(e){ return arr.map(()=> '') }
}

/* 綁定：預覽 JSON（5 件） */
$('#btnPreview').addEventListener('click', async ()=>{
  const cat=$('#cat').value.trim();
  const slug=$('#slug').value.trim();
  const title=$('#title').value.trim();
  const sub=$('#subFile').files[0];

  const cuesEN = await parseSubtitleFile(sub);
  let cues = cuesEN.map(x=>({...x}));

  // 機翻選項
  if($('#modeMT').checked && cues.length){
    const fn=$('#edgeFn').value.trim();
    const enArr = cues.map(x=>x.en);
    const zhArr = await mtTranslateArray(fn, enArr, 'zh');
    const jaArr = await mtTranslateArray(fn, enArr, 'ja');
    cues = cues.map((x,i)=>({...x, zh: zhArr[i]||'', ja: jaArr[i]||'' }));
  }

  const {index,cues3,quiz,vocab,ai} = buildJSON({cat,slug,title,cues});
  $('#boxIndex').value = JSON.stringify(index, null, 2);
  $('#boxCues').value  = JSON.stringify(cues3, null, 2);
  $('#boxQuiz').value  = JSON.stringify(quiz, null, 2);
  $('#boxVocab').value = JSON.stringify(vocab, null, 2);
  $('#boxAI').value    = JSON.stringify(ai, null, 2);
});

/* ------------------------- Supabase 上傳 ------------------------- */
function getSupaClient(){
  // 優先使用 window.BW.supa
  if (window.BW && window.BW.supa && window.BW.supa.createClient) {
    return window.BW.supa.createClient();
  }
  const url=$('#sbUrl').value.trim();
  const key=$('#sbKey').value.trim();
  if(!url || !key) return null;
  return supabase.createClient(url,key);
}

async function supaUpload(bucket, path, file, client){
  const { data, error } = await client.storage.from(bucket).upload(path, file, { upsert:true, contentType: file.type || undefined });
  if(error) throw error;
  // 轉 public URL（需桶設定為 public 或有政策）
  const { data:pub } = client.storage.from(bucket).getPublicUrl(path);
  return pub.publicUrl;
}

$('#btnSupaUpload').addEventListener('click', async ()=>{
  const st=$('#supaStatus'); st.textContent='';
  const cat=$('#cat').value.trim();
  const slug=$('#slug').value.trim();
  const mp4=$('#mp4File').files[0];
  const cover=$('#coverFile').files[0];
  if(!mp4){ st.textContent='[錯誤] 請先選擇 MP4 檔。'; return; }

  const client=getSupaClient();
  if(!client){ st.textContent='[錯誤] 找不到 Supabase 連線（BW.supa 或手動 URL/KEY）。'; return; }

  const bucketV=$('#bucketVideo').value.trim()||'videos';
  const bucketA=$('#bucketAsset').value.trim()||'assets';
  const pathV = `${cat}/${slug}.mp4`;
  const pathC = `${cat}/${slug}/cover.jpg`;

  try{
    st.textContent+='[1/2] 上傳影片中...\n';
    const vUrl = await supaUpload(bucketV, pathV, mp4, client);
    st.textContent+=`    影片 URL → ${vUrl}\n`;

    let cUrl='';
    if(cover){
      st.textContent+='[2/2] 上傳封面中...\n';
      cUrl = await supaUpload(bucketA, pathC, cover, client);
      st.textContent+=`    封面 URL → ${cUrl}\n`;
    }else{
      st.textContent+='[2/2] 未選封面，略過。\n';
    }

    // 若頁面有 index 預覽，補上 URL
    if($('#boxIndex').value){
      try{
        const idx=JSON.parse($('#boxIndex').value);
        if(vUrl) idx.video = vUrl;
        if(cUrl) idx.cover = cUrl;
        $('#boxIndex').value = JSON.stringify(idx,null,2);
      }catch(e){}
    }
    st.textContent+='完成。';
  }catch(e){
    st.textContent+=`[失敗] ${e.message||e}`;
  }
});

/* ------------------------- GitHub 上傳 ------------------------- */
async function ghPutFile({owner,repo,branch,token,path,content,message}){
  const url=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
  const body={ message, branch, content: b64(content) };
  const r = await fetch(url, {method:'PUT', headers:{'Authorization':`token ${token}`,'Content-Type':'application/json'}, body:JSON.stringify(body)});
  if(!r.ok){
    const t=await r.text();
    throw new Error(`HTTP ${r.status} – ${t}`);
  }
  return await r.json();
}

$('#btnUploadGithub').addEventListener('click', async ()=>{
  const st=$('#ghStatus'); st.textContent='';
  const owner=$('#ghOwner').value.trim();
  const repo=$('#ghRepo').value.trim();
  const branch=$('#ghBranch').value.trim();
  const base=($('#ghBase').value||'').trim();
  const token=$('#ghTok').value.trim();
  const msg=$('#ghMsg').value.trim()||'Add JSON';

  if(!owner||!repo||!branch||!token){ st.textContent='[錯誤] 請填 owner / repo / branch / token'; return; }

  const cat=$('#cat').value.trim();
  const slug=$('#slug').value.trim();

  const index = $('#boxIndex').value;
  const cues  = $('#boxCues').value;
  const quiz  = $('#boxQuiz').value;
  const vocab = $('#boxVocab').value;
  const ai    = $('#boxAI').value;
  if(!(index&&cues&&quiz&&vocab&&ai)){ st.textContent='[錯誤] 請先點「預覽 JSON」讓 5 件內容產生。'; return; }

  const root = `${base ? base.replace(/\/?$/,'/') : ''}data/${cat}/${slug}`;
  const files = [
    {name:`${root}/index.json`, content:index},
    {name:`${root}/cues-${slug}.json`, content:cues},
    {name:`${root}/quiz-${slug}.json`, content:quiz},
    {name:`${root}/vocab-${slug}.json`, content:vocab},
    {name:`${root}/ai-${slug}.json`, content:ai},
  ];

  try{
    let i=0;
    for(const f of files){
      i++;
      st.textContent+=`[${i}/5] 上傳 ${f.name}...\n`;
      await ghPutFile({owner,repo,branch,token,path:f.name,content:f.content,message:msg});
      await sleep(180);
    }
    st.textContent+='完成。';
  }catch(e){
    st.textContent+=`[失敗] ${e.message||e}`;
  }
});
</script></div></section>
</main>
<footer>BookWide Admin · 內嵌 Supabase 版 · v20251104-slug2</footer>
<script type="module">
    const ready = () => new Promise(function(r){ if (window.BW && window.BW.supa) return r(); const t = setInterval(function(){ if(window.BW && window.BW.supa){clearInterval(t); r();}},50); });
    await ready();

    await BW.requireAdmin();
    BW.startHeartbeat(2);

    const supa = BW.supa;
    const $ = function(q,root){ return (root||document).querySelector(q); };
    const $$ = function(q,root){ return Array.prototype.slice.call((root||document).querySelectorAll(q)); };
    const fmtTW = function(ts){ return !ts?'':new Date(ts).toLocaleString('zh-TW',{timeZone:'Asia/Taipei',hour12:false}); };
    const pill = function(ok, t, cls){ t = (typeof t!=='undefined')?t:(ok?'在線':'離線'); cls = cls || (ok?'pill ok':'pill'); return '<span class="'+cls+'">'+t+'</span>'; };

    $$('.tab-btn').forEach(function(b){
      b.addEventListener('click',function(){
        $$('.tab-btn').forEach(function(x){ x.classList.remove('active'); });
        b.classList.add('active');
        const t=b.getAttribute('data-tab');
        $('#panel-users').style.display = (t==='users')?'':'none';
        $('#panel-roles').style.display = (t==='roles')?'':'none';
        $('#panel-mp4').style.display   = (t==='mp4')  ?'':'none';
      });
    });

    async function loadProfiles(){
      const tbody = $('#usersTable tbody'); tbody.innerHTML='<tr><td class="muted" colspan="7">載入中…</td></tr>';
      const cols='email, display_name, is_admin, is_paused, last_sign_in_at, last_seen_at, expires_at';
      const r=await supa.from('profiles').select(cols).order('email',{ascending:true});
      if(r.error){ tbody.innerHTML='<tr><td class="muted" colspan="7">讀取失敗：'+r.error.message+'</td></tr>'; return; }
      const q = ($('#q').value||'').trim().toLowerCase();
      const rows=(r.data||[]).filter(function(x){
        return !q || ( (x.email||'').toLowerCase().includes(q) || (x.display_name||'').toLowerCase().includes(q) );
      });
      if(!rows.length){ tbody.innerHTML='<tr><td class="muted" colspan="7">沒有符合的資料</td></tr>'; return; }
      tbody.innerHTML=rows.map(function(x){
        const online = BW.isOnlineWithin(x.last_seen_at, 10);
        const status = x.is_paused ? '<span class="pill warn">暫停</span>' : '<span class="pill ok">正常</span>';
        return '<tr>'
          + '<td>'+(x.email||'')+'</td>'
          + '<td>'+(x.display_name||'')+'</td>'
          + '<td>'+(fmtTW(x.last_sign_in_at)||'')+'</td>'
          + '<td>'+(fmtTW(x.last_seen_at)||'')+' &nbsp; '+pill(online)+'</td>'
          + '<td>'+(x.is_admin?'<span class="pill ok">是</span>':'<span class="pill">否</span>')+'</td>'
          + '<td>'+status+'</td>'
          + '<td>'+(x.expires_at||'')+'</td>'
          + '</tr>';
      }).join('');
    }
    $('#btnRefresh').addEventListener('click',loadProfiles); $('#q').addEventListener('input',loadProfiles);
    loadProfiles();

    $('#btnApplyRole').addEventListener('click',async function(){
      const email=$('#roleEmail').value.trim(); const act=$('#roleAction').value; const msg=$('#roleMsg');
      if(!email){ msg.textContent='請輸入 Email'; return; }
      const q=await supa.from('profiles').select('id,is_admin').eq('email',email).maybeSingle();
      if(q.error){ msg.textContent='查詢失敗：'+q.error.message; return; } if(!q.data){ msg.textContent='找不到該使用者'; return; }
      var payload={},info='';
      if(act==='grant-admin'){payload={is_admin:true};info='已授予管理員';}
      if(act==='revoke-admin'){payload={is_admin:false};info='已移除管理員';}
      if(act==='pause'){payload={is_paused:true};info='已暫停登入';}
      if(act==='unpause'){payload={is_paused:false};info='已解除暫停';}
      const u=await supa.from('profiles').update(payload).eq('id',q.data.id);
      if(u.error){ msg.textContent='更新失敗：'+u.error.message; return; }
      msg.textContent=email+' '+info; loadProfiles();
    });

    const drop = $('#drop'); const picker = $('#picker'); const mp4Input=$('#mp4File'); const chosen=$('#chosen');
    const bar = $('#bar'); const btnUpload = $('#btnUpload'); const upMsg = $('#upMsg'); const zipLink = $('#zipLink');

    drop.addEventListener('dragover',function(e){ e.preventDefault(); drop.classList.add('drag'); });
    drop.addEventListener('dragleave',function(){ drop.classList.remove('drag'); });
    drop.addEventListener('drop',function(e){
      e.preventDefault(); drop.classList.remove('drag');
      const f = e.dataTransfer.files && e.dataTransfer.files[0]; if(f){ mp4Input.files = e.dataTransfer.files; reflectChoose(); }
    });
    picker.addEventListener('click',function(){ mp4Input.click(); });
    mp4Input.addEventListener('change',reflectChoose);
    function reflectChoose(){
      const f=mp4Input.files && mp4Input.files[0];
      if(!f){ chosen.textContent='尚未選檔'; return; }
      chosen.textContent = f.name+' · '+(f.size/1024/1024).toFixed(2)+' MB';
      const slug = ($('#slug').value||'').trim();
      if(!slug){
        const base = f.name.replace(/\.mp4$/i,'').replace(/\s+/g,'-').toLowerCase();
        $('#slug').value = base.slice(0,80);
      }
    }
    function setBar(p){ bar.style.width = Math.max(3, Math.min(100, p)) + '%'; }
    async function getVideoDuration(file){
      return new Promise(function(resolve){
        const v=document.createElement('video'); v.preload='metadata';
        v.onloadedmetadata=function(){ resolve(Math.round(v.duration||0)); URL.revokeObjectURL(v.src); };
        v.onerror=function(){ resolve(0); }; v.src=URL.createObjectURL(file);
      });
    }
    async function ensureFolder(bucket, pathLike){
      try{ await supa.storage.from(bucket).list(pathLike); return true; }catch(e){ return true; }
    }

    function pad2(n){ return n.toString().padStart(2,'0'); }
    function pick(arr, n){
      const a=arr.slice(); const out=[];
      while(out.length<n && a.length){ out.push(a.splice(Math.floor(Math.random()*a.length),1)[0]); }
      return out;
    }
    const BANK = {
      commonVocab: [{"word":"festival","pos":"n.","zh":"節日","en":"a special day of celebration","example":"This festival brings families together."},{"word":"moon","pos":"n.","zh":"月亮","en":"Earth's natural satellite","example":"We admire the full moon."},{"word":"gather","pos":"v.","zh":"聚集","en":"come together","example":"Families gather for dinner."},{"word":"mooncake","pos":"n.","zh":"月餅","en":"round pastry for Mid-Autumn","example":"They share mooncakes."},{"word":"lantern","pos":"n.","zh":"燈籠","en":"a light in a cover","example":"Kids carry lanterns."},{"word":"legend","pos":"n.","zh":"傳說","en":"traditional story","example":"There is a legend about the moon."},{"word":"archer","pos":"n.","zh":"弓箭手","en":"a person skilled with a bow","example":"He was a brave archer."},{"word":"elixir","pos":"n.","zh":"仙丹","en":"magical drink","example":"The elixir grants immortality."},{"word":"immortal","pos":"adj.","zh":"不死的","en":"living forever","example":"She became immortal."},{"word":"reunion","pos":"n.","zh":"團圓","en":"coming together again","example":"The festival is for reunion."},{"word":"admire","pos":"v.","zh":"欣賞","en":"look at with pleasure","example":"They admire the bright moon."},{"word":"harvest","pos":"n.","zh":"收穫","en":"gathering crops","example":"People thank for the harvest."},{"word":"tradition","pos":"n.","zh":"傳統","en":"custom passed down","example":"Sharing mooncakes is a tradition."},{"word":"celebrate","pos":"v.","zh":"慶祝","en":"do something special","example":"People celebrate together."},{"word":"rabbit","pos":"n.","zh":"兔子","en":"small animal","example":"A rabbit appears in the legend."},{"word":"blessing","pos":"n.","zh":"祝福","en":"good wishes","example":"They ask for blessings."},{"word":"tea","pos":"n.","zh":"茶","en":"a popular drink","example":"People drink tea at night."},{"word":"poem","pos":"n.","zh":"詩","en":"a piece of writing","example":"They read poems about the moon."},{"word":"clear","pos":"adj.","zh":"晴朗的","en":"without clouds","example":"We hope for a clear sky."},{"word":"family","pos":"n.","zh":"家庭","en":"parents and children","example":"Family time matters."}],
      mcDistractors:["sun","star","cloud","tree","river","noodles","cheese","pepper","books","games","rainy","windy"]
    };
    function buildCues(durationSec){
      const total = 20; const span = Math.max(2, Math.floor((durationSec||120)/total));
      const cues=[]; var t=0;
      for(var i=0;i<total;i++){ var s=t, e=s+span; cues.push({ "s": s, "e": e, "t": "第 "+pad2(i+1)+" 句（請編輯）" }); t=e; }
      return cues;
    }
    function buildVocab(){
      const words=BANK.commonVocab.slice(); return pick(words,20).map(function(x){
        return { "word": x.word, "pos": x.pos, "zh": x.zh, "en": x.en, "sample": x.example || x.en };
      });
    }
    function makeMCQ(q, correct, wrongs){
      const ch=pick(wrongs,3); ch.push(correct);
      for(let i=ch.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); const tmp=ch[i]; ch[i]=ch[j]; ch[j]=tmp; }
      return {"type":"mc", "q":q, "choices":ch, "answer": ch.indexOf(correct)};
    }
    function buildQuizFromVocab(vocab, title){
      const wrongs=BANK.mcDistractors.slice(), quiz=[];
      for(let i=0;i<20;i++){ const v=vocab[i%vocab.length]; quiz.push(makeMCQ('What is the meaning of "'+v.word+'"?', v.zh, wrongs)); }
      const grammar=[
        makeMCQ("Lanterns ____ by children at night.","are carried",["carry","are carrying","carried"]),
        makeMCQ("People ____ mooncakes every year.","eat",["ate","are eaten","is eating"]),
        makeMCQ("This is the night ____ families meet.","when",["who","which","where"]),
        makeMCQ("He suggested that we ____ tea.","drink",["drank","to drink","drinking"]),
        makeMCQ("People enjoy ____ poems.","reading",["read","to read","reads"]),
      ]; while(grammar.length<20){ grammar.push(makeMCQ("The moon is very ____ tonight.","bright",["broken","tiny","thin"])); }
      Array.prototype.push.apply(quiz, grammar.slice(0,20));
      const reading=[
        makeMCQ('Why do families meet in "'+(title||'the story')+'"?',"For reunion",["For business","For exercise","For study"]),
        makeMCQ("They choose a park with a clear view. What do they want to see?","The full moon",["Sunrise","Fireworks","TV show"]),
        makeMCQ("Kids carry lanterns and guess riddles. What does this show?","They enjoy traditions",["They are bored","They hate the dark","They are studying"]),
      ]; while(reading.length<20){ reading.push(makeMCQ("People share tea and fruit. The mood is ____.","warm",["cold","tense","lonely"])); }
      Array.prototype.push.apply(quiz, reading.slice(0,20));
      const mixed=[
        makeMCQ("Which is NOT related to Mid-Autumn?","Christmas tree",["Mooncakes","Lanterns","Jade Rabbit"]),
        makeMCQ("Choose the collocation: admire the ____ moon.","full",["thin","broken","small"]),
        makeMCQ("The festival follows the ____ calendar.","lunar",["solar","school","work"]),
      ]; while(mixed.length<20){ mixed.push(makeMCQ("A polite gift is a box of ____.","mooncakes",["books","spoons","noodles"])); }
      Array.prototype.push.apply(quiz, mixed.slice(0,20)); return quiz;
    }
    async function fetchAudioBuffer(url){
      const ctx = new (window.AudioContext||window.webkitAudioContext)({sampleRate:44100});
      const r = await fetch(url, {mode:'cors'}); const b = await r.arrayBuffer();
      return await ctx.decodeAudioData(b);
    }
    function energyEnvelope(buf, frameSize, hop){
      frameSize = frameSize||1024; hop = hop||256;
      const ch = buf.getChannelData(0);
      const frames = Math.max(0, Math.floor((ch.length - frameSize) / hop));
      const env = new Float32Array(frames);
      for(let i=0;i<frames;i++){
        let sum=0; for(let j=0;j<frameSize;j++){ const v = ch[i*hop+j]; sum += v*v; }
        env[i]=Math.sqrt(sum/frameSize);
      } return {"env": env, "tStep": hop / buf.sampleRate};
    }
    function detectSilences(env, tStep, thresh, minSil){
      thresh = (typeof thresh==='number')?thresh:0.008;
      minSil = (typeof minSil==='number')?minSil:0.25;
      const minFrames = Math.max(1, Math.floor(minSil / tStep)); const segs=[]; let run=-1;
      for(let i=0;i<env.length;i++){
        if(env[i]<thresh){ if(run<0) run=i; }
        else if(run>=0){ const len=i-run; if(len>=minFrames) segs.push({"s":run*tStep,"e":i*tStep}); run=-1; }
      }
      if(run>=0){ const i=env.length; const len=i-run; if(len>=minFrames) segs.push({"s":run*tStep,"e":i*tStep}); }
      return segs;
    }
    function snapToSilence(cues, silences, win){
      win = (typeof win==='number')?win:1.5;
      function nearStart(t){ let best=null,d=Infinity; for(const s of silences){ const dd=Math.abs(t-s.s); if(dd<d && dd<=win){ d=dd; best=s; } } return best; }
      function nearEnd(t){ let best=null,d=Infinity; for(const s of silences){ const dd=Math.abs(t-s.e); if(dd<d && dd<=win){ d=dd; best=s; } } return best; }
      const out=cues.map(function(c){ return {"s":c.s,"e":c.e,"t":c.t}; });
      for(const c of out){ const sSil=nearEnd(c.s); const eSil=nearStart(c.e); if(sSil) c.s=Math.max(0,sSil.e); if(eSil) c.e=Math.max(c.s+0.05,eSil.s); }
      for(let i=1;i<out.length;i++){ if(out[i].s<out[i-1].e) out[i].s=out[i-1].e; if(out[i].e<=out[i].s) out[i].e=out[i].s+0.05; }
      return out;
    }

    async function makeZipJson(opts){
      const category = opts.category;
      const slug = opts.slug;
      const title = opts.title;
      const publicVideoUrl = opts.publicVideoUrl;
      const publicCoverUrl = opts.publicCoverUrl;
      const durationSec = opts.durationSec;

      const cuesName = "cues-"+slug+".json";
      const vocabName = "vocab-"+slug+".json";
      const quizName = "quiz-"+slug+".json";
      const aiName = "ai-"+slug+".json";
      const indexName = "index-"+slug+".json";

      const indexJson = {
        "title": title || slug,
        "category": category,
        "slug": slug,
        "video": publicVideoUrl,
        "cover": publicCoverUrl || null,
        "cues": { "zh": "./"+cuesName },
        "vocab": "./"+vocabName,
        "quiz": "./"+quizName,
        "ai": "./"+aiName,
        "is_public": true
      };

      let cuesZh = buildCues(durationSec||0);
      if(document.getElementById('autoAlign').checked){
        try{
          const th = parseFloat(document.getElementById('th').value||'0.008');
          const sil = parseFloat(document.getElementById('sil').value||'0.25');
          const win = parseFloat(document.getElementById('win').value||'1.5');
          const buf = await fetchAudioBuffer(publicVideoUrl);
          const o = energyEnvelope(buf);
          const sils = detectSilences(o.env, o.tStep, th, sil);
          cuesZh = snapToSilence(cuesZh, sils, win);
        }catch(e){
          console.warn('自動對齊失敗，改用平均切段', e);
        }
      }

      const vocab = buildVocab();
      const quiz = buildQuizFromVocab(vocab, title);
      const ai = { "title": title||"Lesson", "generated_at": new Date().toISOString(), "prompts": [
        "Describe the festival.", "What will you do this year?", "Share a memory about the moon."
      ]};

      const zip = new JSZip();
      const dir = zip.folder("data/"+category+"/"+slug);
      dir.file(indexName, JSON.stringify(indexJson, null, 2));
      dir.file(cuesName, JSON.stringify(cuesZh, null, 2));
      dir.file(vocabName, JSON.stringify(vocab, null, 2));
      dir.file(quizName, JSON.stringify(quiz, null, 2));
      dir.file(aiName, JSON.stringify(ai, null, 2));

      const blob = await zip.generateAsync({type:"blob"});
      return URL.createObjectURL(blob);
    }

    btnUpload.addEventListener('click', async function(){
      const cat=$('#cat').value.trim();
      const slug=$('#slug').value.trim();
      const title=$('#title').value.trim();
      const mp4=mp4Input.files && mp4Input.files[0];
      const cov=$('#coverFile').files[0];
      const isPublic=$('#isPublic').value==='true';
      if(!cat||!slug||!mp4){ upMsg.textContent='請選擇分類、輸入 slug 並選擇 MP4 檔'; return; }
      zipLink.style.display='none'; zipLink.removeAttribute('href');

      btnUpload.disabled=true; setBar(8); upMsg.textContent='開始上傳…';
      try{
        const mp4Rel=cat+'/'+slug+'.mp4'; const mp4Full='videos/'+mp4Rel;
        await ensureFolder('videos',cat);
        setBar(15);
        const up1=await supa.storage.from('videos').upload(mp4Rel,mp4,{"upsert":true,"contentType":"video/mp4"});
        if(up1.error) throw up1.error;
        setBar(55);
        let coverFull=null; if(cov){
          const rel=cat+'/'+slug+'/cover.jpg'; coverFull='assets/'+rel;
          await ensureFolder('assets',cat+'/'+slug);
          const up2=await supa.storage.from('assets').upload(rel,cov,{"upsert":true});
          if(up2.error) throw up2.error;
        }
        setBar(70);
        const duration=await getVideoDuration(mp4);
        const user=(await supa.auth.getUser()).data && (await supa.auth.getUser()).data.user || null;
        const rec={"category":cat,"slug":slug,"title":(title||null),"storage_path":mp4Full,"cover_path":coverFull,
                  "size_bytes":mp4.size||null,"duration_sec":duration||null,"is_public":isPublic,
                  "created_by":(user?user.id:null),"updated_at":new Date().toISOString()};
        const ins=await supa.from('videos').upsert(rec,{"onConflict":"category,slug"}).select('id').maybeSingle();
        if(ins.error) throw ins.error;
        setBar(85);
        const publicVideoUrl = supa.storage.url + '/object/public/' + mp4Full;
        const publicCoverUrl = coverFull ? (supa.storage.url + '/object/public/' + coverFull) : null;
        upMsg.textContent='產生 ZIP（含自動對齊）…';
        const url = await makeZipJson({"category":cat, "slug":slug, "title":title, "publicVideoUrl":publicVideoUrl, "publicCoverUrl":publicCoverUrl, "durationSec": duration});
        zipLink.href = url; zipLink.download = cat+'-'+slug+'-templates.zip'; zipLink.style.display='inline-block';
        setBar(100);
        upMsg.innerHTML='✅ 完成！已上傳並寫入資料表<br>影片：<code>'+mp4Full+'</code>'+(coverFull?('；封面：<code>'+coverFull+'</code>'):'')+'<br>長度：'+(duration||0)+' 秒，大小：'+(mp4.size/1024/1024).toFixed(2)+' MB · <b>請點「下載 JSON ZIP」</b>';
      }catch(err){ console.error(err); upMsg.textContent='上傳/寫入失敗：'+(err && (err.message||err)); setBar(0); }
      finally{ btnUpload.disabled=false; }
    });
  </script>
<!-- BEGIN: BookWide ZIP generator (houyi-format, 80Q + 15 AI) -->
<script type="module">
if (!window.BANK){
  window.BANK = {
    commonVocab: [
      {word:"festival",pos:"n.",zh:"節日",en:"a special day",example:"It is a traditional festival."},
      {word:"lantern",pos:"n.",zh:"燈籠",en:"a light in a paper cover"},
      {word:"moon",pos:"n.",zh:"月亮",en:"the moon in the sky"},
      {word:"reunion",pos:"n.",zh:"團聚",en:"the act of coming together"},
      {word:"share",pos:"v.",zh:"分享",en:"to give part of something"},
      {word:"admire",pos:"v.",zh:"欣賞",en:"to enjoy looking at"},
      {word:"tradition",pos:"n.",zh:"傳統",en:"a custom that people follow"},
      {word:"poem",pos:"n.",zh:"詩",en:"a piece of writing in verse"},
      {word:"full",pos:"adj.",zh:"圓的/滿的",en:"complete; not empty"},
      {word:"lunar",pos:"adj.",zh:"月的/陰曆的",en:"related to the moon"}
    ],
    mcDistractors: ["a book","a tree","a car","a computer","a movie","a city","a phone","a river","a desk","a game"]
  };
}

function secToMMSS(sec){ sec=Math.max(0,Math.round(sec)); const m=String(Math.floor(sec/60)).padStart(2,'0'); const s=String(sec%60).padStart(2,'0'); return `${m}:${s}`; }
function pad2(n){ return n.toString().padStart(2,'0'); }
function pick(arr, n){ const a=arr.slice(); const out=[]; while(out.length<n && a.length){ out.push(a.splice(Math.floor(Math.random()*a.length),1)[0]); } return out; }

function buildSegments(durationSec){
  const total = 20;
  const span  = Math.max(2, Math.floor((durationSec||120)/total));
  const segs  = [];
  let t=0;
  for(let i=0;i<total;i++){ const s=t, e=s+span; segs.push({ s, e, t: `第 ${pad2(i+1)} 句（請編輯）` }); t=e; }
  return segs;
}
function segmentsToHouyiCues(segs){
  return segs.map(c => ({ time: secToMMSS(c.s), en: "", zh: c.t }));
}

function buildVocabHouyi(){
  const words = window.BANK.commonVocab.slice();
  return pick(words, 20).map(x => ({
    time: 0, word: x.word, pos: x.pos, zh: x.zh, en: x.en, sample: x.example || x.en
  }));
}

function makeMCQ(q, correct, wrongs){
  const ch = pick(wrongs, 3); ch.push(correct);
  for(let i=ch.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [ch[i],ch[j]]=[ch[j],ch[i]]; }
  return { type:'mc', q, choices: ch, answer: ch.indexOf(correct) };
}

function buildQuizHouyiFromVocab(vocab, title){
  const wrongs = window.BANK.mcDistractors.slice();
  const raw = [];

  for(let i=0;i<20;i++){
    const v = vocab[i%vocab.length];
    raw.push(makeMCQ(`What is the meaning of "${v.word}"?`, v.zh, wrongs));
  }
  const grammar = [
    makeMCQ("Lanterns ____ by children at night.","are carried",["carry","are carrying","carried"]),
    makeMCQ("People ____ mooncakes every year.","eat",["ate","are eaten","is eating"]),
    makeMCQ("This is the night ____ families meet.","when",["who","which","where"]),
    makeMCQ("He suggested that we ____ tea.","drink",["drank","to drink","drinking"]),
    makeMCQ("People enjoy ____ poems.","reading",["read","to read","reads"]),
  ];
  while (grammar.length < 20) grammar.push(makeMCQ("The moon is very ____ tonight.","bright",["broken","tiny","thin"]));
  raw.push(...grammar.slice(0,20));

  const reading = [
    makeMCQ(`Why do families meet in "${title||'the story'}"?`,"For reunion",["For business","For exercise","For study"]),
    makeMCQ("They choose a park with a clear view. What do they want to see?","The full moon",["Sunrise","Fireworks","TV show"]),
    makeMCQ("Kids carry lanterns and guess riddles. What does this show?","They enjoy traditions",["They are bored","They hate the dark","They are studying"]),
  ];
  while (reading.length < 20) reading.push(makeMCQ("People share tea and fruit. The mood is ____.","warm",["cold","tense","lonely"]));
  raw.push(...reading.slice(0,20));

  const mixed = [
    makeMCQ("Which is NOT related to Mid-Autumn?","Christmas tree",["Mooncakes","Lanterns","Jade Rabbit"]),
    makeMCQ("Choose the collocation: admire the ____ moon.","full",["thin","broken","small"]),
    makeMCQ("The festival follows the ____ calendar.","lunar",["solar","school","work"]),
  ];
  while (mixed.length < 20) mixed.push(makeMCQ("A polite gift is a box of ____.","mooncakes",["books","spoons","noodles"]));
  raw.push(...mixed.slice(0,20));

  const sections = ["Vocabulary","Grammar","Reading","Mixed"];
  return raw.map((q, i) => ({
    section: sections[Math.floor(i/20)],
    type: "MCQ",
    question: q.q,
    options: q.choices,
    answer: q.choices[q.answer],
    explanation: ""
  }));
}

function buildAIHouyi(title){
  const prompts = [
    "Describe the festival.","What will you do this year?","Share a memory about the moon.",
    "What is your favorite song or activity?","Who do you celebrate with?","Describe the food you enjoy.",
    "How do you feel during the holiday?","Which tradition do you like most?","Describe the decorations.",
    "What do people do at night?","What stories do you know about this festival?","How is it different from others?",
    "Describe one interesting experience you had.","What does this festival mean to you?","What will you do next time to celebrate?"
  ];
  return {
    title: title || "Lesson",
    topics: prompts.map((p, i) => ({ title: `Topic ${i+1}`, prompt: p, hint: "", sample: "" }))
  };
}

async function makeZipJson(opts){
  const {category, slug, title, publicVideoUrl, publicCoverUrl, durationSec} = opts;

  let segs = buildSegments(durationSec||0);
  try{
    const auto = document.getElementById('autoAlign');
    if (auto && auto.checked && typeof fetchAudioBuffer === 'function'){
      const th  = parseFloat(document.getElementById('th')?.value||'0.008');
      const sil = parseFloat(document.getElementById('sil')?.value||'0.25');
      const win = parseFloat(document.getElementById('win')?.value||'1.5');
      const buf = await fetchAudioBuffer(publicVideoUrl);
      const o   = energyEnvelope(buf);
      const sils= detectSilences(o.env, o.tStep, th, sil);
      segs      = snapToSilence(segs, sils, win);
    }
  }catch(e){ console.warn('Auto align failed, fallback to uniform segments', e); }
  const cuesHouyi = segmentsToHouyiCues(segs);
  const vocabHouyi = buildVocabHouyi();
  const quizHouyi  = buildQuizHouyiFromVocab(vocabHouyi, title);
  const aiHouyi    = buildAIHouyi(title);

  const indexJson = {
    title: title || slug,
    category, slug,
    video: publicVideoUrl,
    cover: publicCoverUrl || null,
    cues: { zh: `./cues-${slug}.json` },
    vocab: `./vocab-${slug}.json`,
    quiz:  `./quiz-${slug}.json`,
    ai:    `./ai-${slug}.json`,
    is_public: true
  };

  const zip   = new JSZip();
  const dir   = zip.folder(`data/${category}/${slug}`);
  dir.file(`index-${slug}.json`, JSON.stringify(indexJson,  null, 2));
  dir.file(`cues-${slug}.json`,  JSON.stringify(cuesHouyi,  null, 2));
  dir.file(`vocab-${slug}.json`, JSON.stringify(vocabHouyi, null, 2));
  dir.file(`quiz-${slug}.json`,  JSON.stringify(quizHouyi,  null, 2));
  dir.file(`ai-${slug}.json`,    JSON.stringify(aiHouyi,    null, 2));

  const blob = await zip.generateAsync({type:"blob"});
  const url  = URL.createObjectURL(blob);
  window.__lastZipUrl = url;
  return url;
}
window.makeZipJson = makeZipJson;
</script>
<!-- END: BookWide ZIP generator -->
</body>
</html>

















































































