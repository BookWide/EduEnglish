<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin 主控台 · 白底版（不動 index.html）</title>

  <!-- ============ Supabase 初始化（務必在最前面） ============ -->
  <script type="module">
    import { supabase } from './supa.js';   // 與 admin.html 同層
    // 讓全域都能用（避免 console / 其它 script 抓不到）
    window.supabase = window.supabase ?? supabase;
  </script>

  <style>
    :root{
      --bg:#fff;
      --fg:#111;
      --muted:#666;
      --border:#e6e6e6;
      --primary:#0b57d0;
      --primary-weak:#e9f0fe;
      --danger:#c92a2a;
      --success:#0a7a33;
      --warning:#e0a100;
      --chip:#f3f4f6;
      --table-header:#fafafa;
    }
    *{ box-sizing:border-box; }
    html,body{
      margin:0; padding:0; background:var(--bg); color:var(--fg);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      line-height:1.5;
    }
    a{ color:var(--primary); text-decoration:none; }
    header{
      padding:18px 20px 0;
      border-bottom:1px solid var(--border);
      background:#fff;
      position:sticky; top:0; z-index:10;
    }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .title{ font-size:26px; font-weight:800; letter-spacing:.5px; margin:8px 0 0; }
    .sub{
      font-size:13px; color:var(--muted);
      margin:2px 0 18px;
    }
    .badge{
      padding:6px 10px; border-radius:999px; border:1px solid var(--border);
      background:var(--chip); color:#222; font-size:13px;
    }
    .ghost{
      background:#fff; border:1px solid var(--border); color:#222;
      padding:10px 14px; border-radius:10px; cursor:pointer;
    }
    .ghost:hover{ background:#f8f9fb; }
    .primary{
      background:var(--primary); color:#fff; border:1px solid var(--primary);
      padding:10px 14px; border-radius:10px; cursor:pointer;
    }
    .primary.weak{ background:var(--primary-weak); color:#174ea6; border-color:var(--primary-weak); }
    .danger{ background:var(--danger); color:#fff; border:1px solid var(--danger); }
    .pill{ padding:8px 12px; border:1px solid var(--border); border-radius:999px; background:#fff; }
    .tabs{ display:flex; gap:10px; padding:14px 20px; border-bottom:1px solid var(--border); background:#fff; position:sticky; top:74px; z-index:9;}
    .tab{ padding:10px 14px; border-radius:999px; border:1px solid var(--border); background:#fff; cursor:pointer; font-weight:600; }
    .tab.active{ background:var(--primary-weak); border-color:#dbe6ff; color:#174ea6; }
    main{ padding:18px 20px 40px; max-width:1200px; margin:0 auto; }
    .toolbar{ display:flex; gap:10px; align-items:center; margin:10px 0 14px; }
    .search{
      flex:1; display:flex; border:1px solid var(--border); border-radius:12px; overflow:hidden;
      background:#fff;
    }
    .search input{
      width:100%; border:0; padding:12px 14px; outline:none; font-size:16px;
    }
    .caption{ font-size:13px; color:var(--muted); margin-top:6px; }
    table{
      width:100%; border-collapse:separate; border-spacing:0; border:1px solid var(--border);
      border-radius:12px; overflow:hidden; background:#fff;
    }
    thead th{
      background:var(--table-header); text-align:left; padding:12px; font-weight:700; font-size:14px; border-bottom:1px solid var(--border);
    }
    tbody td{ padding:12px; border-bottom:1px solid var(--border); font-size:14px; vertical-align:middle; }
    tbody tr:last-child td{ border-bottom:0; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .chip{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:#fff; font-size:12px;}
    .dot{
      width:10px; height:10px; border-radius:999px; display:inline-block; background:#bbb; border:1px solid #999;
    }
    .dot.online{ background:#2ecc71; border-color:#27ae60; }
    .dot.away{ background:#f1c40f; border-color:#d4ac0d; }
    .dot.off{ background:#ccc; }
    .nowrap{ white-space:nowrap; }
    .actions{ display:flex; gap:6px; flex-wrap:wrap; }
    .switch{
      appearance:none; width:38px; height:22px; border-radius:999px; background:#ddd; position:relative; outline:none; cursor:pointer; border:1px solid #ccc;
    }
    .switch:checked{ background:#30c27a; border-color:#2ea767; }
    .switch::after{
      content:""; position:absolute; top:2px; left:2px; width:18px; height:18px; border-radius:50%; background:#fff; transition:all .18s ease;
      box-shadow:0 1px 2px rgba(0,0,0,.15);
    }
    .switch:checked::after{ left:18px; }

    .panel{ display:none; }
    .panel.active{ display:block; }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field label{ font-weight:700; font-size:14px; }
    .field input[type="text"], .field select, .field input[type="file"]{
      border:1px solid var(--border); border-radius:10px; padding:10px 12px; font-size:14px; background:#fff; color:#222;
    }
    .hr{ height:1px; background:var(--border); margin:18px 0; }

    .note{ background:#fff7e6; border:1px solid #ffe2a8; color:#7a4d00; padding:10px 12px; border-radius:10px; font-size:13px; }
    .ok{ background:#eefcf3; border:1px solid #cfeede; color:#0b5c2a; padding:10px 12px; border-radius:10px; font-size:13px; }
    .err{ background:#fff1f1; border:1px solid #ffd0d0; color:#8f2020; padding:10px 12px; border-radius:10px; font-size:13px; }
  </style>
</head>
<body>

  <!-- ======== 頂部 ======== -->
  <header>
    <div class="row">
      <a class="ghost" href="./index.html">← 回首頁</a>
      <span class="badge">單檔版・不動 index.html</span>
    </div>
    <div class="title">BookWide Admin 主控台</div>
    <div class="sub">顯示 <b>public.profiles</b>（時間以 <b>台灣</b> 顯示，10 分鐘內視為「在線」）</div>
  </header>

  <!-- ======== 分頁 ======== -->
  <nav class="tabs">
    <button class="tab active" data-tab="users">使用者清單</button>
    <button class="tab" data-tab="roles">授權／暫停管理</button>
    <button class="tab" data-tab="mp4">MP4 上傳自動化</button>
  </nav>

  <main>

    <!-- ========== 使用者清單 ========== -->
    <section id="panel-users" class="panel active">
      <div class="toolbar">
        <div class="search"><input id="kw" placeholder="搜尋 Email / 顯示名稱…" /></div>
        <button id="btnReload" class="ghost">重新整理</button>
      </div>
      <div class="caption">符合 RLS：僅管理員可查看所有人資料。</div>

      <table id="usersTable">
        <thead>
          <tr>
            <th>Email</th>
            <th>顯示名稱</th>
            <th>最後登入（台灣）</th>
            <th>最近在線（台灣）</th>
            <th>管理員</th>
            <th>狀態</th>
            <th class="nowrap">到期日</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="7">載入中…</td></tr>
        </tbody>
      </table>
    </section>

    <!-- ========== 授權／暫停管理 ========== -->
    <section id="panel-roles" class="panel">
      <div class="note">此分頁直接變更 <b>public.profiles</b> 的欄位：<code>is_admin</code>、<code>is_suspended</code>、<code>is_paused</code>。若某欄位不存在，控制切換會自動停用。</div>
      <div class="hr"></div>

      <table id="rolesTable">
        <thead>
          <tr>
            <th>Email</th>
            <th>顯示名稱</th>
            <th>管理員</th>
            <th>停用（is_suspended）</th>
            <th>暫停（is_paused）</th>
            <th>操作結果</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="6">載入中…</td></tr>
        </tbody>
      </table>
    </section>

    <!-- ========== MP4 上傳自動化 ========== -->
    <section id="panel-mp4" class="panel">
      <div class="grid">
        <div class="field">
          <label>分類</label>
          <select id="mp4Category">
            <option value="story">story</option>
            <option value="music">music</option>
            <option value="movie">movie</option>
            <option value="news">news</option>
            <option value="pro">pro</option>
          </select>
        </div>
        <div class="field">
          <label>Slug（不含空白與檔名）</label>
          <input id="mp4Slug" type="text" placeholder="例如：mid-autumn" />
        </div>

        <div class="field">
          <label>MP4 檔</label>
          <input id="mp4File" type="file" accept="video/mp4" />
        </div>
        <div class="field">
          <label>封面（可選）</label>
          <input id="coverFile" type="file" accept="image/*" />
        </div>
      </div>

      <div class="hr"></div>
      <div class="row">
        <button id="btnUpload" class="primary">上傳</button>
        <button id="btnReset" class="ghost">重設表單</button>
        <span class="badge">會上傳到 Storage：<code>videos/{category}/{slug}.mp4</code>、<code>assets/data/{category}/{slug}/cover.jpg</code></span>
      </div>

      <div id="mp4Msg" style="margin-top:12px;"></div>
    </section>

  </main>

  <script type="module">
    // ===== 共用：工具 =====
    const TZ = 'Asia/Taipei';
    const fmt = (d, fallback='—')=>{
      if(!d) return fallback;
      try{
        const dt = new Date(d);
        if (isNaN(dt.getTime())) return fallback;
        return new Intl.DateTimeFormat('zh-Hant-TW',{
          timeZone: TZ, year:'numeric', month:'2-digit', day:'2-digit',
          hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false
        }).format(dt);
      }catch{ return fallback; }
    };
    const el = sel => document.querySelector(sel);
    const els = sel => Array.from(document.querySelectorAll(sel));
    const sleep = ms=> new Promise(r=>setTimeout(r,ms));

    // ===== 分頁切換 =====
    els('.tab').forEach(t=>{
      t.addEventListener('click', ()=>{
        els('.tab').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        els('.panel').forEach(p=>p.classList.remove('active'));
        el('#panel-'+t.dataset.tab).classList.add('active');
      });
    });

    // ===== 欄位存在性偵測 =====
    let HAS_SUSPENDED = true;
    let HAS_PAUSED = true;

    // ===== 只允許管理員 =====
    async function requireAdmin(){
      const { data: { user }, error } = await supabase.auth.getUser();
      if (error || !user) {
        alert('請先登入。');
        location.href = './index.html';
        return false;
      }
      // 讀 profiles
      const { data: me, error: e2 } = await supabase
        .from('profiles')
        .select('id,is_admin')
        .eq('id', user.id)
        .maybeSingle();

      if (e2) {
        alert('無法讀取個人資料：' + e2.message);
        location.href = './index.html';
        return false;
      }
      if (!me?.is_admin) {
        alert('您沒有管理員權限');
        location.href = './index.html';
        return false;
      }
      return true;
    }

    // ===== 讀取所有 profiles 用於兩個表 =====
    let cached = [];
    async function loadProfiles(){
      // 嘗試偵測欄位（suspended / paused）
      HAS_SUSPENDED = true; HAS_PAUSED = true;

      // 先選完整欄位，若報欄位不存在，再降級
      let columns = 'id,email,display_name,is_admin,is_suspended,is_paused,last_sign_in_at,last_seen_at,expires_at';
      let r = await supabase.from('profiles').select(columns).order('email',{ascending:true});
      if (r.error && /column .* does not exist/i.test(r.error.message)) {
        // 逐步降級
        try{
          const colsTry = 'id,email,display_name,is_admin,last_sign_in_at,last_seen_at,expires_at';
          r = await supabase.from('profiles').select(colsTry).order('email',{ascending:true});
          HAS_SUSPENDED = false; HAS_PAUSED = false;
        }catch{}
      }
      if (r.error) {
        el('#usersTable tbody').innerHTML = `<tr><td colspan="7" class="err">讀取失敗：${r.error.message}</td></tr>`;
        el('#rolesTable tbody').innerHTML = `<tr><td colspan="6" class="err">讀取失敗：${r.error.message}</td></tr>`;
        return;
      }
      cached = (r.data||[]).map(x=>({
        ...x,
        is_suspended: (x.is_suspended ?? false),
        is_paused: (x.is_paused ?? false),
      }));
      renderUsers();
      renderRoles();
    }

    // ===== 使用者清單表格 =====
    function renderUsers(){
      const kw = el('#kw').value.trim().toLowerCase();
      const rows = cached.filter(u=>{
        if (!kw) return true;
        return (u.email||'').toLowerCase().includes(kw) ||
               (u.display_name||'').toLowerCase().includes(kw);
      });

      const now = Date.now();
      const tenMin = 10*60*1000;

      const tb = rows.map(u=>{
        const seen = u.last_seen_at ? new Date(u.last_seen_at).getTime() : 0;
        let state = 'off';
        if (seen && (now - seen) <= tenMin) state = 'online';
        else if (seen && (now - seen) <= (60*60*1000)) state = 'away';

        const dot = `<span class="dot ${state}" title="在線狀態"></span>`;

        const statusText = u.is_suspended ? '<span class="chip" style="border-color:#f5c2c7;background:#fff5f5;color:#781b1b">已停用</span>'
                        : (u.is_paused ? '<span class="chip" style="border-color:#ffeeba;background:#fff8e1;color:#8a6d00">暫停</span>'
                                       : '<span class="chip" style="border-color:#cfeede;background:#eefcf3;color:#0b5c2a">正常</span>');

        return `<tr>
          <td class="mono">${u.email||'—'}</td>
          <td>${u.display_name||'—'}</td>
          <td class="nowrap">${fmt(u.last_sign_in_at)}</td>
          <td class="nowrap">${dot} ${fmt(u.last_seen_at)}</td>
          <td>${u.is_admin ? '✔︎' : ''}</td>
          <td>${statusText}</td>
          <td class="nowrap">${u.expires_at || '—'}</td>
        </tr>`;
      }).join('');

      el('#usersTable tbody').innerHTML = rows.length? rows : `<tr><td colspan="7">沒有資料</td></tr>`;
    }

    // ===== 角色 / 暫停管理表格 =====
    function renderRoles(){
      const canSusp = HAS_SUSPENDED;
      const canPause = HAS_PAUSED;

      const tb = cached.map(u=>{
        const swAdmin = `<input type="checkbox" class="switch sw-admin" data-id="${u.id}" ${u.is_admin?'checked':''} />`;
        const swSusp = canSusp ? `<input type="checkbox" class="switch sw-susp" data-id="${u.id}" ${u.is_suspended?'checked':''} />`
                               : `<span class="chip">無欄位</span>`;
        const swPause = canPause ? `<input type="checkbox" class="switch sw-pause" data-id="${u.id}" ${u.is_paused?'checked':''} />`
                                 : `<span class="chip">無欄位</span>`;

        return `<tr>
          <td class="mono">${u.email||'—'}</td>
          <td>${u.display_name||'—'}</td>
          <td>${swAdmin}</td>
          <td>${swSusp}</td>
          <td>${swPause}</td>
          <td class="mono small" id="msg-${u.id}"></td>
        </tr>`;
      }).join('');

      el('#rolesTable tbody').innerHTML = tb || `<tr><td colspan="6">沒有資料</td></tr>`;

      // 綁事件
      els('.sw-admin').forEach(i=>i.addEventListener('change',()=> toggleField(i.dataset.id,'is_admin',i.checked)));
      els('.sw-susp').forEach(i=>i.addEventListener('change',()=> toggleField(i.dataset.id,'is_suspended',i.checked)));
      els('.sw-pause').forEach(i=>i.addEventListener('change',()=> toggleField(i.dataset.id,'is_paused',i.checked)));
    }

    async function toggleField(id, field, val){
      const msg = el(`#msg-${id}`);
      msg.textContent = '處理中…';
      const payload = {}; payload[field] = val;

      let res = await supabase
        .from('profiles')
        .update(payload)
        .eq('id', id);

      if (res.error) {
        msg.innerHTML = `<span class="err">失敗：${res.error.message}</span>`;
      }else{
        msg.innerHTML = `<span class="ok">已更新</span>`;
        // 同步本地快取
        const t = cached.find(x=>x.id===id);
        if (t) t[field] = val;
      }
    }

    // ===== MP4 上傳 =====
    async function uploadMP4(){
      const cat = el('#mp4Category').value.trim();
      const slug = el('#mp4Slug').value.trim();
      const fmp4 = el('#mp4File').files[0];
      const fcover = el('#coverFile').files[0];
      const msg = el('#mp4Msg');

      msg.innerHTML = '';

      if (!cat || !slug || !fmp4){
        msg.innerHTML = `<div class="err">請選擇分類、輸入 slug，並選擇 MP4 檔案。</div>`;
        return;
      }

      // 影片路徑
      const videoPath = `${cat}/${slug}.mp4`;
      // 封面路徑
      const coverPath = `data/${cat}/${slug}/cover.jpg`;

      try{
        msg.innerHTML = `<div class="note">上傳影片中…</div>`;
        const v = await supabase.storage.from('videos').upload(videoPath, fmp4, { upsert:true });
        if (v.error) throw v.error;

        if (fcover){
          msg.innerHTML = `<div class="note">上傳封面中…</div>`;
          const c = await supabase.storage.from('assets').upload(coverPath, fcover, { upsert:true });
          if (c.error) throw c.error;
        }

        msg.innerHTML = `<div class="ok">完成！影片存於 <code>videos/${videoPath}</code>${fcover?`，封面於 <code>assets/${coverPath}</code>`:''}</div>`;
      }catch(e){
        msg.innerHTML = `<div class="err">上傳失敗：${e.message || e}</div>`;
      }
    }

    // ===== 綁定事件 =====
    el('#kw').addEventListener('input', ()=> renderUsers());
    el('#btnReload').addEventListener('click', ()=> loadProfiles());
    el('#btnUpload').addEventListener('click', uploadMP4);
    el('#btnReset').addEventListener('click', ()=>{
      el('#mp4Slug').value=''; el('#mp4File').value=''; el('#coverFile').value='';
      el('#mp4Msg').textContent='';
    });

    // ===== 啟動：權限檢查 + 載資料 =====
    (async()=>{
      const ok = await requireAdmin();
      if (!ok) return;

      await loadProfiles();

      // 心跳偵測：避免你遇到的 "online" 判斷卡住（每 60 秒更新一下）
      setInterval(loadProfiles, 60*1000);
    })();
  </script>
</body>
</html>











