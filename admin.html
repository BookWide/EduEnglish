<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin · MP4 上傳自動化（含 EN/ZH/JA ZIP）· v20251106</title>
  <!-- 依原架構：內嵌 supa.js（不可變動其他頁） -->
  <script type="module" src="./supa.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <style>
    :root{ --bg:#fff; --fg:#111; --muted:#6b7280; --line:#e5e7eb; --brand:#2563eb; --chip:#eef2ff; --card:#fafafa; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","PingFang TC","Noto Sans CJK TC","微軟正黑體",sans-serif}
    header{padding:18px 20px;border-bottom:1px solid var(--line);display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .title{font-size:22px;font-weight:700;margin-right:auto}
    .chip{display:inline-block;padding:.35rem .6rem;border-radius:999px;background:var(--chip);color:var(--brand);font-size:12px}
    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab-btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:.5rem 1rem;cursor:pointer}
    .tab-btn.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    .wrap{max-width:1120px;margin:24px auto;padding:0 16px}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0 16px}
    .input, select, textarea{border:1px solid var(--line);border-radius:10px;padding:.55rem .8rem;background:#fff}
    textarea{width:100%;min-height:120px;font-family:ui-monospace,Menlo,Consolas,monospace;line-height:1.5}
    .btn{border:1px solid var(--brand);background:var(--brand);color:#fff;border-radius:10px;padding:.55rem .9rem;cursor:pointer}
    .btn.outline{background:#fff;color:var(--brand)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
    .table th,.table td{padding:.75rem .8rem;border-bottom:1px solid var(--line);text-align:left}
    .table th{background:var(--card);font-weight:600;color:#222}
    .muted{color:var(--muted)} .hint{color:#9aa3b2;font-size:13px}
    .hr{height:1px;background:var(--line);margin:18px 0}
    .row{display:grid;gap:12px} .grid-2{grid-template-columns:1fr 1fr} .grid-3{grid-template-columns:1fr 1fr 1fr}
    @media (max-width:820px){ .grid-2,.grid-3{grid-template-columns:1fr} }
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px}
    footer{padding:22px 20px;color:var(--muted);border-top:1px solid var(--line);text-align:center;margin-top:28px}
    .pill{display:inline-block;padding:.25rem .55rem;border-radius:999px;border:1px solid var(--line);font-size:12px}
    .pill.ok{color:#16a34a;border-color:#16a34a} .pill.warn{color:#f59e0b;border-color:#f59e0b}
    .drop{border:2px dashed var(--line);border-radius:12px;padding:18px;text-align:center;background:#fff}
    .drop.drag{border-color:#2563eb;background:#f8fbff}
    .progress{height:10px;background:#eef2ff;border-radius:99px;overflow:hidden}
    .bar{height:100%;width:0;background:#2563eb;transition:width .2s}
    code{background:#f6f8fa;border:1px solid #eaeef2;border-radius:6px;padding:2px 6px}
    .small{font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="title">BookWide Admin 主控台</div>
    <span class="chip">白底 · 單檔 · 內嵌 Supabase</span>
    <nav class="tabs">
      <button class="tab-btn active" data-tab="users">使用者清單</button>
      <button class="tab-btn" data-tab="roles">授權 / 暫停管理員</button>
      <button class="tab-btn" data-tab="mp4">MP4 上傳自動化</button>
    </nav>
  </header>

  <main class="wrap">
    <!-- 使用者清單 -->
    <section id="panel-users">
      <div class="toolbar">
        <input id="q" class="input" style="min-width:260px" placeholder="搜尋 Email / 顯示名稱…" />
        <button id="btnRefresh" class="btn outline">重新整理</button>
        <span class="hint small">顯示資料：public.profiles · 時區 Asia/Taipei · 10 分鐘內視為「在線」。</span>
      </div>
      <table class="table" id="usersTable">
        <thead><tr>
          <th>Email</th><th>顯示名稱</th><th>最後登入（台灣）</th><th>最近在線（台灣）</th><th>管理員</th><th>狀態</th><th>到期日</th>
        </tr></thead>
        <tbody><tr><td colspan="7" class="muted">載入中…</td></tr></tbody>
      </table>
    </section>

    <!-- 管理員/暫停 -->
    <section id="panel-roles" style="display:none">
      <div class="card">
        <div class="row grid-3">
          <div><label class="muted">Email</label><input id="roleEmail" class="input" placeholder="user@example.com"></div>
          <div>
            <label class="muted">動作</label>
            <select id="roleAction" class="input">
              <option value="grant-admin">授予管理員</option>
              <option value="revoke-admin">移除管理員</option>
              <option value="pause">暫停登入</option>
              <option value="unpause">解除暫停</option>
            </select>
          </div>
          <div style="display:flex;align-items:flex-end"><button id="btnApplyRole" class="btn">套用</button></div>
        </div>
        <div class="hr"></div>
        <div class="hint">直接更新 public.profiles 欄位：<code>is_admin</code> / <code>is_paused</code>。</div>
        <div id="roleMsg" class="muted" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- MP4 上傳自動化 -->
    <section id="panel-mp4" style="display:none">
      <div class="card">
        <h3 style="margin:6px 0 14px">MP4 上傳自動化（slug 檔名 · 完成即送 JSON ZIP · EN/ZH/JA）</h3>

        <div class="row grid-3">
          <div><label class="muted">分類</label>
            <select id="cat" class="input">
              <option value="story">story</option><option value="music" selected>music</option>
              <option value="movie">movie</option><option value="news">news</option>
              <option value="pro">pro</option>
            </select></div>
          <div><label class="muted">Slug（不含空白與副檔名）</label>
            <input id="slug" class="input" placeholder="alittlelove"></div>
          <div><label class="muted">顯示標題（可空）</label>
            <input id="title" class="input" placeholder="A Little Love"></div>
        </div>

        <div class="row grid-3" style="margin-top:12px">
          <div>
            <label class="muted">MP4 檔（可拖拉到框內）</label>
            <div id="drop" class="drop">
              <input id="mp4File" type="file" accept="video/mp4" style="display:none">
              <div>將檔案拖曳到此處，或 <button id="picker" class="btn outline" type="button">選擇檔案</button></div>
              <div id="chosen" class="hint" style="margin-top:6px">尚未選檔</div>
              <div class="progress" style="margin-top:8px"><div id="bar" class="bar"></div></div>
            </div>
          </div>
          <div><label class="muted">封面（可選）</label><input id="coverFile" type="file" accept="image/*" class="input"></div>
          <div><label class="muted">公開狀態</label>
            <select id="isPublic" class="input"><option value="true">公開</option><option value="false">非公開</option></select>
          </div>
        </div>

        <!-- EN / ZH / JA 行對齊輸入（可空；若空則自動產生佔位） -->
        <div class="row grid-3" style="margin-top:12px">
          <div>
            <label class="muted">EN 字幕（每行一句；可空）</label>
            <textarea id="enLines" placeholder="One day, the suns appeared.\nThe world turned hot."></textarea>
          </div>
          <div>
            <label class="muted">ZH 字幕（每行一句；可空）</label>
            <textarea id="zhLines" placeholder="有一天，太陽們出現了。\n世界變得很熱。"></textarea>
          </div>
          <div>
            <label class="muted">JA 字幕（每行一句；可空）</label>
            <textarea id="jaLines" placeholder="ある日、太陽たちが現れた。\n世界は暑くなった。"></textarea>
          </div>
        </div>

        <div class="row grid-3" style="margin-top:10px">
          <div class="hint">對齊參數：門檻 <code id="p-th">0.008</code> · 靜音≧ <code id="p-sil">0.25s</code> · 吸附窗口 ±<code id="p-win">1.5s</code></div>
          <div style="display:flex;gap:8px;align-items:center">
            <label class="muted">RMS 門檻</label><input id="th" class="input" type="number" step="0.0001" value="0.008" style="width:110px">
            <label class="muted">最短靜音</label><input id="sil" class="input" type="number" step="0.05" value="0.25" style="width:110px">
            <label class="muted">窗口(±s)</label><input id="win" class="input" type="number" step="0.1" value="1.5" style="width:110px">
          </div>
          <div style="display:flex;align-items:flex-end;gap:10px">
            <label class="muted" style="display:flex;align-items:center;gap:6px">
              <input id="autoAlign" type="checkbox" checked> 自動對齊字幕（吸附靜音）
            </label>
            <a id="zipLink" class="btn outline" href="#" download style="display:none">下載 JSON ZIP</a>
          </div>
        </div>

        <div class="row grid-3" style="margin-top:12px">
          <div style="display:flex;align-items:flex-end;gap:10px">
            <button id="btnUpload" class="btn">上傳並寫入資料表 → 產生 ZIP</button>
          </div>
          <div style="display:flex;align-items:flex-end">
            <span class="hint">影片路徑：<code>videos/{category}/{slug}.mp4</code>；封面（若選）：<code>assets/{category}/{slug}/cover.jpg</code></span>
          </div>
        </div>

        <div class="hr"></div><div id="upMsg" class="muted">就緒。</div>
      </div>
    </section>
  </main>

  <footer>BookWide Admin · 保持其他頁不動 · v20251106</footer>

  <script type="module">
    const ready = ()=>new Promise(r=>{ if(window.BW&&window.BW.supa) return r(); const t=setInterval(()=>{ if(window.BW&&window.BW.supa){clearInterval(t); r();}},50); });
    await ready(); await BW.requireAdmin(); BW.startHeartbeat(2);
    const supa = BW.supa;
    const $=(q,root)=> (root||document).querySelector(q);
    const $$=(q,root)=> Array.from((root||document).querySelectorAll(q));
    const fmtTW = ts => !ts ? '' : new Date(ts).toLocaleString('zh-TW',{timeZone:'Asia/Taipei',hour12:false});
    const pill = (ok,t,cls)=> `<span class="${cls|| (ok?'pill ok':'pill')}">${t??(ok?'在線':'離線')}</span>`;

    // 切頁
    $$('.tab-btn').forEach(b=>b.addEventListener('click',()=>{
      $$('.tab-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active');
      const t=b.dataset.tab;
      $('#panel-users').style.display=(t==='users')?'':'none';
      $('#panel-roles').style.display=(t==='roles')?'':'none';
      $('#panel-mp4').style.display=(t==='mp4')?'':'none';
    }));

    // Users
    async function loadProfiles(){
      const tbody=$('#usersTable tbody'); tbody.innerHTML='<tr><td class="muted" colspan="7">載入中…</td></tr>';
      const cols='email, display_name, is_admin, is_paused, last_sign_in_at, last_seen_at, expires_at';
      const r=await supa.from('profiles').select(cols).order('email',{ascending:true});
      if(r.error){ tbody.innerHTML='<tr><td class="muted" colspan="7">讀取失敗：'+r.error.message+'</td></tr>'; return; }
      const q=($('#q').value||'').trim().toLowerCase();
      const rows=(r.data||[]).filter(x=>!q || (x.email||'').toLowerCase().includes(q) || (x.display_name||'').toLowerCase().includes(q));
      if(!rows.length){ tbody.innerHTML='<tr><td class="muted" colspan="7">沒有符合的資料</td></tr>'; return; }
      tbody.innerHTML=rows.map(x=>{
        const online=BW.isOnlineWithin(x.last_seen_at,10);
        const status=x.is_paused?'<span class="pill warn">暫停</span>':'<span class="pill ok">正常</span>';
        return `<tr>
          <td>${x.email||''}</td>
          <td>${x.display_name||''}</td>
          <td>${fmtTW(x.last_sign_in_at)||''}</td>
          <td>${fmtTW(x.last_seen_at)||''} &nbsp; ${pill(online)}</td>
          <td>${x.is_admin?'<span class="pill ok">是</span>':'<span class="pill">否</span>'}</td>
          <td>${status}</td>
          <td>${x.expires_at||''}</td>
        </tr>`;
      }).join('');
    }
    $('#btnRefresh').addEventListener('click',loadProfiles); $('#q').addEventListener('input',loadProfiles); loadProfiles();

    // Roles
    $('#btnApplyRole').addEventListener('click',async()=>{
      const email=$('#roleEmail').value.trim(); const act=$('#roleAction').value; const msg=$('#roleMsg');
      if(!email){ msg.textContent='請輸入 Email'; return; }
      const q=await supa.from('profiles').select('id,is_admin').eq('email',email).maybeSingle();
      if(q.error){ msg.textContent='查詢失敗：'+q.error.message; return; } if(!q.data){ msg.textContent='找不到該使用者'; return; }
      let payload={},info='';
      if(act==='grant-admin'){payload={is_admin:true};info='已授予管理員';}
      if(act==='revoke-admin'){payload={is_admin:false};info='已移除管理員';}
      if(act==='pause'){payload={is_paused:true};info='已暫停登入';}
      if(act==='unpause'){payload={is_paused:false};info='已解除暫停';}
      const u=await supa.from('profiles').update(payload).eq('id',q.data.id);
      if(u.error){ msg.textContent='更新失敗：'+u.error.message; return; }
      msg.textContent=email+' '+info; loadProfiles();
    });

    // MP4 Upload panel
    const drop=$('#drop'), picker=$('#picker'), mp4Input=$('#mp4File'), chosen=$('#chosen');
    const bar=$('#bar'), btnUpload=$('#btnUpload'), upMsg=$('#upMsg'), zipLink=$('#zipLink');

    drop.addEventListener('dragover',e=>{e.preventDefault(); drop.classList.add('drag');});
    drop.addEventListener('dragleave',()=>drop.classList.remove('drag'));
    drop.addEventListener('drop',e=>{ e.preventDefault(); drop.classList.remove('drag'); const f=e.dataTransfer.files?.[0]; if(f){ mp4Input.files=e.dataTransfer.files; reflectChoose(); } });
    picker.addEventListener('click',()=>mp4Input.click());
    mp4Input.addEventListener('change',reflectChoose);

    function reflectChoose(){
      const f=mp4Input.files?.[0];
      if(!f){ chosen.textContent='尚未選檔'; return; }
      chosen.textContent = f.name+' · '+(f.size/1024/1024).toFixed(2)+' MB';
      const slug = ($('#slug').value||'').trim();
      if(!slug){ const base=f.name.replace(/\.mp4$/i,'').replace(/\s+/g,'-').toLowerCase(); $('#slug').value=base.slice(0,80); }
    }
    function setBar(p){ bar.style.width=Math.max(3,Math.min(100,p))+'%'; }
    async function getVideoDuration(file){
      return new Promise(res=>{ const v=document.createElement('video'); v.preload='metadata';
        v.onloadedmetadata=()=>{ res(Math.round(v.duration||0)); URL.revokeObjectURL(v.src); };
        v.onerror=()=>res(0); v.src=URL.createObjectURL(file);
      });
    }
    async function ensureFolder(bucket, pathLike){ try{ await supa.storage.from(bucket).list(pathLike); return true; }catch(e){ return true; } }

    // --- Audio helpers for Auto Align ---
    async function fetchAudioBuffer(url){
      const ctx=new (window.AudioContext||window.webkitAudioContext)({sampleRate:44100});
      const r=await fetch(url,{mode:'cors'}); const b=await r.arrayBuffer();
      return await ctx.decodeAudioData(b);
    }
    function energyEnvelope(buf, frameSize=1024, hop=256){
      const ch=buf.getChannelData(0); const frames=Math.max(0,Math.floor((ch.length-frameSize)/hop));
      const env=new Float32Array(frames);
      for(let i=0;i<frames;i++){ let sum=0; for(let j=0;j<frameSize;j++){ const v=ch[i*hop+j]; sum+=v*v; } env[i]=Math.sqrt(sum/frameSize); }
      return {env, tStep: hop/buf.sampleRate};
    }
    function detectSilences(env,tStep,thresh=0.008,minSil=0.25){
      const minFrames=Math.max(1,Math.floor(minSil/tStep)); const segs=[]; let run=-1;
      for(let i=0;i<env.length;i++){ if(env[i]<thresh){ if(run<0) run=i; } else if(run>=0){ const len=i-run; if(len>=minFrames) segs.push({s:run*tStep,e:i*tStep}); run=-1; } }
      if(run>=0){ const i=env.length; const len=i-run; if(len>=minFrames) segs.push({s:run*tStep,e:i*tStep}); }
      return segs;
    }
    function snapToSilence(cues,silences,win=1.5){
      function nearStart(t){ let best=null,d=Infinity; for(const s of silences){ const dd=Math.abs(t-s.s); if(dd<d&&dd<=win){ d=dd; best=s; } } return best; }
      function nearEnd(t){ let best=null,d=Infinity; for(const s of silences){ const dd=Math.abs(t-s.e); if(dd<d&&dd<=win){ d=dd; best=s; } } return best; }
      const out=cues.map(c=>({s:c.s,e:c.e,t:c.t}));
      for(const c of out){ const sSil=nearEnd(c.s), eSil=nearStart(c.e); if(sSil) c.s=Math.max(0,sSil.e); if(eSil) c.e=Math.max(c.s+0.05,eSil.s); }
      for(let i=1;i<out.length;i++){ if(out[i].s<out[i-1].e) out[i].s=out[i-1].e; if(out[i].e<=out[i].s) out[i].e=out[i].s+0.05; }
      return out;
    }

    // --- Builders (houyi format compatible) ---
    const pad2=n=>String(n).padStart(2,'0');
    const mmss=sec=>{sec=Math.max(0,Math.round(sec)); return pad2(Math.floor(sec/60))+':'+pad2(sec%60);};
    function avgSegments(durationSec){
      const total=20, span=Math.max(2,Math.floor((durationSec||120)/total)); const segs=[]; let t=0;
      for(let i=0;i<total;i++){ const s=t,e=s+span; segs.push({s,e,t:`第 ${pad2(i+1)} 句（請編輯）`}); t=e; } return segs;
    }
    function linesToArray(id){ const txt=($(id).value||'').trim(); return txt?txt.split(/\r?\n/):[]; }

    function buildCuesHouyi(segs){
      const enArr=linesToArray('#enLines'), zhArr=linesToArray('#zhLines'), jaArr=linesToArray('#jaLines');
      return segs.map((c,i)=>({ time:mmss(c.s), en: enArr[i]||"", zh: zhArr[i]||c.t, ja: jaArr[i]||"" }));
    }

    function pick(arr,n){ const a=arr.slice(), out=[]; while(out.length<n&&a.length){ out.push(a.splice(Math.floor(Math.random()*a.length),1)[0]); } return out; }
    const BANK={
      commonVocab:[{"word":"festival","pos":"n.","zh":"節日","en":"a special day of celebration","example":"This festival brings families together."},{"word":"moon","pos":"n.","zh":"月亮","en":"Earth's natural satellite","example":"We admire the full moon."},{"word":"gather","pos":"v.","zh":"聚集","en":"come together","example":"Families gather for dinner."},{"word":"mooncake","pos":"n.","zh":"月餅","en":"round pastry for Mid-Autumn","example":"They share mooncakes."},{"word":"lantern","pos":"n.","zh":"燈籠","en":"a light in a cover","example":"Kids carry lanterns."},{"word":"legend","pos":"n.","zh":"傳說","en":"traditional story","example":"There is a legend about the moon."},{"word":"archer","pos":"n.","zh":"弓箭手","en":"a person skilled with a bow","example":"He was a brave archer."},{"word":"immortal","pos":"adj.","zh":"不死的","en":"living forever","example":"She became immortal."},{"word":"reunion","pos":"n.","zh":"團圓","en":"coming together again","example":"The festival is for reunion."},{"word":"admire","pos":"v.","zh":"欣賞","en":"look at with pleasure","example":"They admire the bright moon."},{"word":"harvest","pos":"n.","zh":"收穫","en":"gathering crops","example":"People thank for the harvest."},{"word":"tradition","pos":"n.","zh":"傳統","en":"custom passed down","example":"Sharing mooncakes is a tradition."},{"word":"celebrate","pos":"v.","zh":"慶祝","en":"do something special","example":"People celebrate together."},{"word":"rabbit","pos":"n.","zh":"兔子","en":"small animal","example":"A rabbit appears in the legend."},{"word":"blessing","pos":"n.","zh":"祝福","en":"good wishes","example":"They ask for blessings."},{"word":"poem","pos":"n.","zh":"詩","en":"a piece of writing","example":"They read poems about the moon."},{"word":"clear","pos":"adj.","zh":"晴朗的","en":"without clouds","example":"We hope for a clear sky."},{"word":"family","pos":"n.","zh":"家庭","en":"parents and children","example":"Family time matters."}],
      mcDistractors:["sun","star","cloud","tree","river","noodles","cheese","pepper","books","games","rainy","windy"]
    };
    function buildVocab(){ return pick(BANK.commonVocab,20).map(x=>({time:0,word:x.word,pos:x.pos,zh:x.zh,en:x.en,sample:x.example||x.en})); }
    function makeMCQ(q,correct,wrongs){ const ch=pick(wrongs,3); ch.push(correct); for(let i=ch.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [ch[i],ch[j]]=[ch[j],ch[i]]; } return {type:'MCQ',question:q,choices:ch,answer:ch.indexOf(correct)}; }
    function buildQuizFromVocab(vocab,title){
      const wrongs=BANK.mcDistractors.slice(); const out=[];
      for(let i=0;i<20;i++){ const v=vocab[i%vocab.length]; out.push(makeMCQ(`What is the meaning of "${v.word}"?`,v.zh,wrongs)); }
      const grammar=[
        makeMCQ("Lanterns ____ by children at night.","are carried",["carry","are carrying","carried"]),
        makeMCQ("People ____ mooncakes every year.","eat",["ate","are eaten","is eating"]),
        makeMCQ("This is the night ____ families meet.","when",["who","which","where"]),
        makeMCQ("He suggested that we ____ tea.","drink",["drank","to drink","drinking"]),
        makeMCQ("People enjoy ____ poems.","reading",["read","to read","reads"]),
      ]; while(grammar.length<20){ grammar.push(makeMCQ("The moon is very ____ tonight.","bright",["broken","tiny","thin"])); }
      out.push(...grammar.slice(0,20));
      const reading=[
        makeMCQ(`Why do families meet in "${title||'the story'}"?`,"For reunion",["For business","For exercise","For study"]),
        makeMCQ("They choose a park with a clear view. What do they want to see?","The full moon",["Sunrise","Fireworks","TV show"]),
        makeMCQ("Kids carry lanterns and guess riddles. What does this show?","They enjoy traditions",["They are bored","They hate the dark","They are studying"]),
      ]; while(reading.length<20){ reading.push(makeMCQ("People share tea and fruit. The mood is ____.","warm",["cold","tense","lonely"])); }
      out.push(...reading.slice(0,20));
      const mixed=[
        makeMCQ("Which is NOT related to Mid-Autumn?","Christmas tree",["Mooncakes","Lanterns","Jade Rabbit"]),
        makeMCQ("Choose the collocation: admire the ____ moon.","full",["thin","broken","small"]),
        makeMCQ("The festival follows the ____ calendar.","lunar",["solar","school","work"]),
      ]; while(mixed.length<20){ mixed.push(makeMCQ("A polite gift is a box of ____.","mooncakes",["books","spoons","noodles"])); }
      out.push(...mixed.slice(0,20));
      const sections=["Vocabulary","Grammar","Reading","Mixed"];
      return out.map((q,i)=>({section:sections[Math.floor(i/20)], type:q.type, question:q.question, options:q.choices, answer:q.options[q.answer], explanation:""}));
    }
    function buildAI(title){
      const ps=[
        "Describe the festival.","What will you do this year?","Share a memory about the moon.",
        "What is your favorite song or activity?","Who do you celebrate with?","Describe the food you enjoy.",
        "How do you feel during the holiday?","Which tradition do you like most?","Describe the decorations.",
        "What do people do at night?","What stories do you know about this festival?","How is it different from others?",
        "Describe one interesting experience you had.","What does this festival mean to you?","What will you do next time to celebrate?"
      ];
      return {title:title||"Lesson", topics: ps.map((p,i)=>({title:`Topic ${i+1}`,prompt:p,hint:"",sample:""}))};
    }

    async function makeZipJson(opts){
      const {category, slug, title, publicVideoUrl, publicCoverUrl, durationSec} = opts;
      // 產生 20 段，必要時做自動對齊
      let segs = avgSegments(durationSec||0);
      try{
        if ($('#autoAlign').checked){
          const th=parseFloat($('#th').value||'0.008'), sil=parseFloat($('#sil').value||'0.25'), win=parseFloat($('#win').value||'1.5');
          const buf=await fetchAudioBuffer(publicVideoUrl); const o=energyEnvelope(buf); const sils=detectSilences(o.env,o.tStep,th,sil);
          segs=snapToSilence(segs,sils,win);
        }
      }catch(e){ console.warn('Auto align failed. Use uniform segments.', e); }
      const cues = buildCuesHouyi(segs);            // {time, en, zh, ja}
      const vocab= buildVocab();                     // 20
      const quiz = buildQuizFromVocab(vocab, title); // 80
      const ai   = buildAI(title);                   // 15 prompts

      const index = {
        title: title||slug, category, slug,
        video: publicVideoUrl, cover: publicCoverUrl || null,
        cues: { zh: `./cues-${slug}.json` },  // player 目前只讀 zh；en/ja 放在 cues 物件欄位中不影響既有版本
        vocab: `./vocab-${slug}.json`, quiz: `./quiz-${slug}.json`, ai: `./ai-${slug}.json`,
        is_public: true
      };

      const zip = new JSZip();
      const dir = zip.folder(`data/${category}/${slug}`);
      dir.file(`index-${slug}.json`, JSON.stringify(index,null,2));
      dir.file(`cues-${slug}.json`,  JSON.stringify(cues,null,2));
      dir.file(`vocab-${slug}.json`, JSON.stringify(vocab,null,2));
      dir.file(`quiz-${slug}.json`,  JSON.stringify(quiz,null,2));
      dir.file(`ai-${slug}.json`,    JSON.stringify(ai,null,2));
      const blob=await zip.generateAsync({type:'blob'}); return URL.createObjectURL(blob);
    }

    // 上傳 → 產生 ZIP
    btnUpload.addEventListener('click', async function(){
      const cat=$('#cat').value.trim(), slug=$('#slug').value.trim(), title=$('#title').value.trim();
      const mp4=mp4Input.files?.[0], cov=$('#coverFile').files?.[0]; const isPublic=$('#isPublic').value==='true';
      if(!cat||!slug||!mp4){ upMsg.textContent='請選擇分類、輸入 slug 並選擇 MP4 檔'; return; }
      zipLink.style.display='none'; zipLink.removeAttribute('href');
      btnUpload.disabled=true; setBar(8); upMsg.textContent='開始上傳…';
      try{
        const mp4Rel=cat+'/'+slug+'.mp4', mp4Full='videos/'+mp4Rel; await ensureFolder('videos',cat);
        setBar(15); const up1=await supa.storage.from('videos').upload(mp4Rel,mp4,{upsert:true,contentType:'video/mp4'});
        if(up1.error) throw up1.error; setBar(55);
        let coverFull=null; if(cov){ const rel=cat+'/'+slug+'/cover.jpg'; coverFull='assets/'+rel; await ensureFolder('assets',cat+'/'+slug);
          const up2=await supa.storage.from('assets').upload(rel,cov,{upsert:true}); if(up2.error) throw up2.error; }
        setBar(70);
        const duration=await getVideoDuration(mp4);
        const user=(await supa.auth.getUser()).data?.user||null;
        const rec={category:cat,slug,title:(title||null),storage_path:mp4Full,cover_path:coverFull,size_bytes:mp4.size||null,duration_sec:duration||null,is_public:isPublic,created_by:(user?user.id:null),updated_at:new Date().toISOString()};
        const ins=await supa.from('videos').upsert(rec,{onConflict:'category,slug'}).select('id').maybeSingle();
        if(ins.error) throw ins.error; setBar(85);
        const publicVideoUrl=supa.storage.url+'/object/public/'+mp4Full; const publicCoverUrl=coverFull?(supa.storage.url+'/object/public/'+coverFull):null;
        upMsg.textContent='產生多語 ZIP（含自動對齊）…';
        const url=await makeZipJson({category:cat,slug,title,publicVideoUrl,publicCoverUrl,durationSec:duration});
        zipLink.href=url; zipLink.download=cat+'-'+slug+'-templates-multilang.zip'; zipLink.style.display='inline-block';
        setBar(100);
        upMsg.innerHTML='✅ 完成！已上傳並寫入資料表<br>影片：<code>'+mp4Full+'</code>'+(coverFull?('；封面：<code>'+coverFull+'</code>'):'')+'<br>長度：'+(duration||0)+' 秒，大小：'+(mp4.size/1024/1024).toFixed(2)+' MB · <b>請點「下載 JSON ZIP」</b>';
      }catch(err){ console.error(err); upMsg.textContent='上傳/寫入失敗：'+(err?.message||err); setBar(0); }
      finally{ btnUpload.disabled=false; }
    });
  </script>
</body>
</html>




























