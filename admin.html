<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BookWide â€” Admin ä¸»æ§å°ï¼ˆå–®æª”ç‰ˆï¼‰</title>
  <style>
    :root{--bg:#0e1320;--panel:#121a2b;--ink:#e6edf6;--muted:#9fb0c3;--brand:#51a3ff;--ok:#1fc37d;--warn:#ffb020;--bad:#ff5d5d;--line:#1f2a42}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(14,19,32,.95),rgba(14,19,32,.8));backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid var(--line);}
    .bar{max-width:1200px;margin:auto;display:flex;align-items:center;gap:16px;padding:14px 20px}
    .logo{font-weight:700;letter-spacing:.5px}
    .chip{border:1px solid var(--line);border-radius:999px;padding:6px 12px;background:var(--panel);color:var(--ink);}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{border:1px solid var(--line);padding:8px 14px;border-radius:9px;background:#11182b;color:var(--muted);cursor:pointer}
    .tab.active{background:var(--brand);color:#001429;border-color:transparent}
    main{max-width:1200px;margin:24px auto;padding:0 20px}
    section.card{display:none;border:1px solid var(--line);border-radius:14px;background:var(--panel);padding:18px}
    section.card.active{display:block}
    h2{margin:0 0 6px 0;font-size:18px}
    .sub{color:var(--muted);font-size:13px;margin:0 0 14px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type="text"], input[type="email"], input[type="datetime-local"], select{background:#0e1526;border:1px solid var(--line);color:var(--ink);padding:8px 10px;border-radius:8px;outline:none}
    input[type="file"]{color:var(--muted)}
    button{background:#1a2340;border:1px solid var(--line);color:var(--ink);padding:8px 14px;border-radius:8px;cursor:pointer}
    button.primary{background:var(--brand);color:#001429;border-color:transparent}
    button.ghost{background:transparent;border-color:var(--line);color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
    th,td{border-bottom:1px solid var(--line);padding:10px 8px;text-align:left}
    th{color:#9fb0c3;font-weight:600}
    .badge{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);color:var(--muted)}
    .ok{color:var(--ok);border-color:var(--ok)}
    .bad{color:var(--bad);border-color:var(--bad)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    .mt12{margin-top:12px}
    .mt6{margin-top:6px}
    .grow{flex:1}
    .right{margin-left:auto}
    .muted{color:var(--muted)}
    .foot{margin-top:20px;color:var(--muted);font-size:12px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:920px){.grid2{grid-template-columns:1fr}}
  </style>
</head>
<body>

<!-- BW Supabase global initializer -->
<script type="module" id="bw-supa-init">
  import { supabase } from './supa.js';
  window.supa = window.supa ?? supabase;
  window.supabase = window.supa;
  window.dispatchEvent(new Event('bw:supa-ready'));
</script>
<header>
    <div class="bar">
      <div class="logo">BookWide Admin ä¸»æ§å°</div>
      <span class="chip">å–®æª”ç‰ˆ Â· ä¸å‹• index.html</span>
      <div class="tabs right">
        <div class="tab active" data-tab="users">ä½¿ç”¨è€…æ¸…å–®</div>
        <div class="tab" data-tab="grant">æˆæ¬Šï¼æš«åœç®¡ç†å“¡</div>
        <div class="tab" data-tab="mp4">MP4 ä¸Šå‚³è‡ªå‹•åŒ–</div>
      </div>
    </div>
  </header>

<script type="module" id="bw-guard-admin">
  import { supabase } from './supa.js';
  (async () => {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) { alert('è«‹å…ˆç™»å…¥'); location.href='./index.html'; return; }
    const { data: p } = await supabase.from('profiles').select('is_admin').eq('id', user.id).single();
    if (!p?.is_admin) { alert('æ‚¨æ²’æœ‰ç®¡ç†å“¡æ¬Šé™'); location.href='./index.html'; }
  })();
</script>


  <main>
    <!-- ä½¿ç”¨è€…æ¸…å–® -->
    <section class="card active" id="tab-users">
      <h2>ä½¿ç”¨è€…æ¸…å–®</h2>
      <p class="sub">æœ€å¾Œç™»å…¥èˆ‡ã€Œç›®å‰åœ¨ç·šã€ä»¥ <b>å°ç£æ™‚é–“</b> é¡¯ç¤ºï¼›10 åˆ†é˜å…§è¦–ç‚ºåœ¨ç·šã€‚</p>

      <div class="row">
        <input id="q" class="grow" type="text" placeholder="æœå°‹ Email / æš±ç¨± ..." />
        <button id="btnReload">é‡æ–°æ•´ç†</button>
      </div>

      <table id="tbl">
        <thead>
          <tr>
            <th>Email</th>
            <th>é¡¯ç¤ºåç¨±</th>
            <th>æœ€å¾Œç™»å…¥ï¼ˆå°ç£ï¼‰</th>
            <th>åˆ°æœŸæ—¥ / åœ¨ç·š</th>
            <th>ç®¡ç†å“¡</th>
            <th>æš«åœ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="foot">ç¬¦åˆ RLS è¦å‰‡ï¼šåƒ…ç®¡ç†å“¡å¯æŸ¥çœ‹æ‰€æœ‰äººè³‡æ–™ã€‚</div>
    </section>

    <!-- æˆæ¬Š/æš«åœ -->
    <section class="card" id="tab-grant">
      <h2>æˆæ¬Šï¼æš«åœç®¡ç†å“¡</h2>
      <p class="sub">ä»¥ Email æ“ä½œã€‚è¨­å®šåˆ°æœŸæ—¥å¯ç©ºç™½ï¼ˆä¸è®Šæ›´ï¼‰ã€‚</p>

      <div class="grid2">
        <div>
          <div class="muted">Email</div>
          <input id="gEmail" type="email" placeholder="someone@example.com" class="grow" />
        </div>
        <div>
          <div class="muted">åˆ°æœŸæ—¥ï¼ˆå¯ç©ºç™½ï¼‰</div>
          <input id="gExpire" type="date" />
        </div>
      </div>

      <div class="row mt12">
        <button id="btnGrant" class="primary">æˆæ¬Šç‚ºç®¡ç†å“¡</button>
        <button id="btnRevoke">å–æ¶ˆç®¡ç†å“¡</button>
        <button id="btnSuspend" class="warn">æš«åœ</button>
        <button id="btnUnsuspend" class="ghost">è§£é™¤æš«åœ</button>
      </div>

      <p id="grantMsg" class="mt6 muted mono"></p>
    </section>

    <!-- MP4 è‡ªå‹•åŒ– -->
    <section class="card" id="tab-mp4">
      <h2>MP4 ä¸Šå‚³è‡ªå‹•åŒ–</h2>
      <p class="sub">ä¸Šå‚³ MP4 èˆ‡å°é¢ï¼Œä¸¦å¯«å…¥ <code>assets</code> ï¼›è·¯å¾‘ï¼š
        <span class="mono">videos/{category}/{slug}.mp4</span>ã€
        <span class="mono">data/{category}/{slug}/cover.jpg</span>ã€
        <span class="mono">data/{category}/{slug}/cues-{slug}.json</span>â€¦</p>

      <div class="grid2">
        <div>
          <div class="muted">åˆ†é¡ï¼ˆcategoryï¼‰</div>
          <select id="mCat">
            <option value="story">story</option>
            <option value="music">music</option>
            <option value="movie">movie</option>
            <option value="news">news</option>
            <option value="pro">pro</option>
          </select>
        </div>
        <div>
          <div class="muted">Slugï¼ˆè‹±æ•¸é€£å­—è™Ÿï¼‰</div>
          <input id="mSlug" type="text" placeholder="mid-autumn" />
        </div>
      </div>

      <div class="grid2 mt12">
        <div>
          <div class="muted">æ¨™é¡Œï¼ˆtitleï¼‰</div>
          <input id="mTitle" type="text" placeholder="The Mid-Autumn Festival" />
        </div>
        <div>
          <div class="muted">MP4 æª”æ¡ˆ</div>
          <input id="mMp4" type="file" accept="video/mp4" />
        </div>
      </div>

      <div class="grid2 mt12">
        <div>
          <div class="muted">å°é¢ï¼ˆcoverï¼‰å¯é¸</div>
          <input id="mCover" type="file" accept="image/*" />
        </div>
        <div>
          <div class="muted">é†’ç›®è©ï¼ˆkeywords, é€—è™Ÿåˆ†éš”ï¼‰å¯é¸</div>
          <input id="mKw" type="text" placeholder="festival, moon, Hou Yi" />
        </div>
      </div>

      <div class="row mt12">
        <button id="btnUpload" class="primary">é–‹å§‹ä¸Šå‚³</button>
        <button id="btnReset" class="ghost">æ¸…é™¤</button>
        <div id="upState" class="muted right"></div>
      </div>

      <pre id="upLog" class="mt12 mono muted" style="white-space:pre-wrap"></pre>
    </section>
  </main>

  <!-- åªå¼•ç”¨ç¾æœ‰çš„ supa.jsï¼ˆå–®æª”ç¶­è­·ï¼Œä½†æ²¿ç”¨ä½ çš„æ†‘è­‰ï¼‰ -->
  <script type="module">
    // 1) å–ç”¨ä½ å°ˆæ¡ˆè£¡å·²å­˜åœ¨çš„ supa.jsï¼ˆESM åŒ¯å‡º supabaseï¼‰
    import { supabase } from './supa.js';
    window.supabase = supabase; // è®“å¾ŒçºŒæ™®é€š script ä¹Ÿèƒ½ç”¨

    // 2) Tab åˆ‡æ›
    const tabs = document.querySelectorAll('.tab');
    const cards = {
      users: document.getElementById('tab-users'),
      grant: document.getElementById('tab-grant'),
      mp4: document.getElementById('tab-mp4'),
    };
    tabs.forEach(t=>t.addEventListener('click',()=>{
      tabs.forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      Object.values(cards).forEach(c=>c.classList.remove('active'));
      cards[t.dataset.tab].classList.add('active');
    }));

    // ===== ä½¿ç”¨è€…æ¸…å–® =====
    const $tbody = document.querySelector('#tbl tbody');
    const $q = document.getElementById('q');
    const $btnReload = document.getElementById('btnReload');

    function toTzTaipei(ts){
      if(!ts) return '';
      const d = new Date(ts);
      return new Intl.DateTimeFormat('zh-TW', {
        timeZone:'Asia/Taipei', year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit', second:'2-digit'
      }).format(d);
    }
    function onlineBadge(lastSeenIso){
      if(!lastSeenIso) return '<span class="badge">â€”</span>';
      const last = new Date(lastSeenIso).getTime();
      const now = Date.now();
      const online = (now - last) <= 10*60*1000;
      return online ? '<span class="badge ok">åœ¨ç·š</span>' : '<span class="badge">é›¢ç·š</span>';
    }
    async function loadUsers(){
  $tbody.innerHTML = '<tr><td class="muted" colspan="6">è¼‰å…¥ä¸­â€¦</td></tr>';

  const { data, error } = await supabase
    .from('profiles')
    .select('email, full_name, nickname, is_admin, last_sign_in_at, expires_at')
    .order('email', { ascending: true });

  if (error) {
    $tbody.innerHTML = '<tr><td class="bad" colspan="6">è®€å–å¤±æ•— ' + (error.message||error) + '</td></tr>';
    return;
  }

  const kw = ($q.value || '').trim().toLowerCase();
  const rows = (data || []).filter(r => {
    const name = (r.full_name || r.nickname || '').toLowerCase();
    return !kw || (r.email?.toLowerCase().includes(kw) || name.includes(kw));
  });

  if (!rows.length) {
    $tbody.innerHTML = '<tr><td class="muted" colspan="6">æ²’æœ‰è³‡æ–™</td></tr>';
    return;
  }

  function toTzTaipei(iso){
    if(!iso) return '';
    try{
      const d = new Date(iso);
      const t = new Intl.DateTimeFormat('zh-TW', { timeZone: 'Asia/Taipei', dateStyle:'short', timeStyle:'medium' }).format(d);
      return t.replace(/\//g,'-');
    }catch(_){ return iso; }
  }
  function onlineByLastLogin(iso){
    if(!iso) return false;
    return (Date.now() - new Date(iso).getTime()) <= 10*60*1000; // 10 åˆ†é˜å…§
  }

  $tbody.innerHTML = rows.map(r => {
    const name = r.full_name || r.nickname || 'â€”';
    const lastLogin = toTzTaipei(r.last_sign_in_at);
    const exp = r.expires_at ? new Date(r.expires_at).toISOString().slice(0,10) : '';
    const online = onlineByLastLogin(r.last_sign_in_at)
      ? '<span class="badge ok">åœ¨ç·š</span>'
      : '<span class="badge">é›¢ç·š</span>';
    return `<tr>
      <td class="mono">${r.email || ''}</td>
      <td>${name}</td>
      <td class="mono">${lastLogin || ''}</td>
      <td class="mono">${exp} &nbsp; ${online}</td>
      <td>${r.is_admin ? '<span class="badge ok">Admin</span>' : '<span class="badge">â€”</span>'}</td>
      <td><span class="badge">â€”</span></td>
    </tr>`;
  }).join('');
}
  // æª”æ¡ˆé¸æ“‡å¾Œå…ˆé¡¯ç¤ºæª”åï¼›è‹¥è¦è‡ªå‹•ä¸Šå‚³ï¼Œå¯è§£é–‹åº•ä¸‹ç¤ºç¯„
  const fileInput = document.getElementById('mp4File');
  if (fileInput) {
    fileInput.addEventListener('change', async () => {
      const f = fileInput.files?.[0];
      if (!f) return;
      alert('å·²é¸æ“‡ MP4ï¼š' + f.name + '\n(ç›®å‰å·²æ¢å¾©æŒ‰éˆ•èˆ‡æª”æ¡ˆé¸æ“‡ï¼›è‹¥è¦ç›´å‚³ Storageï¼Œå‘Šè¨´æˆ‘è¦ç”¨çš„ bucket/path)');
      // ç¯„ä¾‹ï¼šç›´å‚³åˆ° Supabase Storage çš„ 'videos' bucket
      // import { supabase } from './supa.js';
      // const user = (await supabase.auth.getUser())?.data?.user;
      // if (!user) { alert('è«‹å…ˆç™»å…¥'); return; }
      // const path = `mp4/${Date.now()}-${f.name}`;
      // const { error } = await supabase.storage.from('videos').upload(path, f, { upsert:false, contentType: 'video/mp4' });
      // if (error) alert('ä¸Šå‚³å¤±æ•—: ' + error.message); else alert('ä¸Šå‚³å®Œæˆ: ' + path);
    });
  }
</script>


<script type="module">
  import { supabase } from './supa.js';
  const $ = (s)=>document.querySelector(s);
  const el = {
    mCat: $('#mCat'), mSlug: $('#mSlug'), mTitle: $('#mTitle'),
    mMp4: $('#mMp4'), mCover: $('#mCover'), mKw: $('#mKw'),
    btnUpload: $('#btnUpload'), btnReset: $('#btnReset'),
    upState: $('#upState'), upLog: $('#upLog')
  };
  function log(msg){ el.upLog.textContent += (msg + '\n'); el.upLog.scrollTop = el.upLog.scrollHeight; }
  function setState(s){ el.upState.textContent = s; }

  function assertSlug(s){
    return /^[a-z0-9-]+$/.test(s || '');
  }

  async function uploadTo(bucket, path, file, contentType){
    const { data, error } = await supabase.storage.from(bucket).upload(path, file, { upsert: true, contentType });
    if (error) throw new Error(`[${bucket}] ${error.message}`);
    return data;
  }

  // ç›´æ¥ç¶å®šã€Œé–‹å§‹ä¸Šå‚³ã€
  if (el.btnUpload) {
    el.btnUpload.addEventListener('click', async () => {
      try {
        el.upLog.textContent = '';
        setState('æº–å‚™ä¸­â€¦');

        // 1) é©—è­‰ç™»å…¥
        const userRes = await supabase.auth.getUser();
        const user = userRes?.data?.user;
        if (!user) { alert('è«‹å…ˆç™»å…¥'); return; }

        // 2) è®€å–è¡¨å–®
        const cat = el.mCat.value || 'story';
        const slug = (el.mSlug.value || '').trim();
        const title = (el.mTitle.value || '').trim();
        const mp4 = el.mMp4.files?.[0];
        const cover = el.mCover.files?.[0];
        const keywords = (el.mKw.value || '').trim();

        if (!assertSlug(slug)) { alert('Slug åªèƒ½ç”¨å°å¯«è‹±æ•¸èˆ‡é€£å­—è™Ÿ'); return; }
        if (!mp4) { alert('è«‹é¸æ“‡ MP4 æª”æ¡ˆ'); return; }

        log('âœ” è®€å–è¡¨å–®å®Œæˆ');
        setState('ä¸Šå‚³ä¸­â€¦ï¼ˆMP4ï¼‰');

        // 3) ä¸Šå‚³ MP4 åˆ° videos bucket
        const mp4Path = `videos/${cat}/${slug}.mp4`;
        await uploadTo('videos', mp4Path, mp4, 'video/mp4');
        log('âœ” MP4 å·²ä¸Šå‚³ï¼š' + mp4Path);

        // 4) ä¸Šå‚³å°é¢ï¼ˆå¯é¸ï¼‰
        if (cover) {
          setState('ä¸Šå‚³ä¸­â€¦ï¼ˆå°é¢ï¼‰');
          const coverPath = `data/${cat}/${slug}/cover.jpg`;
          await uploadTo('data', coverPath, cover, cover.type || 'image/jpeg');
          log('âœ” å°é¢å·²ä¸Šå‚³ï¼š' + coverPath);
        }

        // 5) å»ºç«‹ï¼ˆæˆ–è¦†è“‹ï¼‰ç©ºçš„ cues jsonï¼ˆæ–¹ä¾¿ä½ å¾ŒçºŒå¡«å…¥ï¼‰
        setState('å»ºç«‹åŸºç¤æª”â€¦ï¼ˆcuesï¼‰');
        const cuesPath = `data/${cat}/${slug}/cues-${slug}.json`;
        const emptyCues = new Blob([JSON.stringify({ cues: [] }, null, 2)], { type: 'application/json' });
        await uploadTo('data', cuesPath, emptyCues, 'application/json');
        log('âœ” cues json å·²å»ºç«‹ï¼š' + cuesPath);

        // 6) ï¼ˆå¯é¸ï¼‰å¯«å…¥ assets è¡¨ï¼ˆè‹¥æ¬„ä½ä¸åŒå¯å‘Šè¨´æˆ‘ï¼‰ï¼š
        try {
          const payload = {
            category: cat, slug, title,
            mp4_path: mp4Path,
            cover_path: cover ? `data/${cat}/${slug}/cover.jpg` : null,
            keywords
          };
            const { error: dbErr } = await supabase.from('assets').upsert(payload, { onConflict: 'category,slug' });
            if (dbErr) { log('ï¼ˆæé†’ï¼‰assets upsert å¤±æ•—ï¼š' + dbErr.message); }
            else { log('âœ” å·²å¯«å…¥ assets è¡¨'); }
        } catch (e) {
          log('ï¼ˆæé†’ï¼‰assets upsert è·³éæˆ–éŒ¯èª¤ï¼š' + e.message);
        }

        setState('å®Œæˆ âœ…');
        log('ğŸ‰ å®Œæˆï¼');
      } catch (err) {
        console.error(err);
        setState('å¤±æ•— âŒ');
        log('âŒ ' + (err.message || err));
        alert('ä¸Šå‚³å¤±æ•—ï¼š' + (err.message || err));
      }
    });
  }

  if (el.btnReset) {
    el.btnReset.addEventListener('click', () => {
      el.mSlug.value = '';
      el.mTitle.value = '';
      el.mMp4.value = '';
      el.mCover.value = '';
      el.mKw.value = '';
      el.upLog.textContent = '';
      setState('');
    });
  }
</script>

</body>
</html>




