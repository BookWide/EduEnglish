<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BookWide Admin 主控台（白底 · 內嵌 Supabase · 守門）</title>
  <style>
    :root{
      --bg:#ffffff; --fg:#111; --muted:#666; --primary:#0d6efd; --soft:#f5f7fb;
      --ok:#16a34a; --warn:#eab308; --bad:#ef4444; --chip:#e9f2ff;
      --br:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 -apple-system, BlinkMacSystemFont,"Segoe UI",PingFangTC,Microsoft JhengHei,Helvetica,Arial;}
    header, main, footer{max-width:1200px;margin:auto;padding:16px}
    header{display:flex;align-items:center;gap:12px;justify-content:space-between}
    .brand{font-weight:700;font-size:26px}
    .badge{background:var(--chip);color:#0753c4;border-radius:999px;padding:6px 12px;font-size:12px}
    nav.tabs{display:flex;gap:8px;margin-top:10px}
    .tab-btn{border:1px solid #dfe7ff;background:#fff;border-radius:999px;padding:8px 14px;cursor:pointer}
    .tab-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:var(--br);padding:16px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type="text"],select{padding:10px 12px;border:1px solid #d3d7df;border-radius:10px;min-width:280px}
    button{padding:10px 14px;border:none;border-radius:10px;background:var(--primary);color:#fff;cursor:pointer}
    button.outline{background:#fff;color:var(--primary);border:1px solid var(--primary)}
    button.ghost{background:#fff;border:1px solid #e5e7eb;color:#444}
    button[disabled]{opacity:.5;cursor:not-allowed}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:12px;border-bottom:1px solid #eee;text-align:left}
    th{color:#333;background:#fafbfd;position:sticky;top:0}
    .chip{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px}
    .chip.gray{background:#f2f4f7;color:#3a3a3a}
    .chip.green{background:#e9fbea;color:#0a7a2d}
    .chip.red{background:#ffe8e6;color:#b42318}
    .chip.yellow{background:#fff7e0;color:#854d0e}
    .right{display:flex;gap:8px;align-items:center}
    .hide{display:none}
    footer{color:var(--muted);text-align:center}
    .guard, .blocked{max-width:720px;margin:40px auto}
    .blocked h2{margin:0 0 8px}
    .blocked p{margin:0 0 16px;color:var(--muted)}
    .pill{display:inline-block;background:#f1f5ff;color:#0b5bd3;padding:6px 10px;border-radius:999px;font-size:12px}
    .row-actions{display:flex;gap:8px}
    .ok{color:var(--ok)} .bad{color:var(--bad)} .muted{color:var(--muted)}
  </style>
</head>
<body>
  <header id="app-header" class="hide">
    <div class="left">
      <div class="brand">BookWide Admin 主控台</div>
      <span class="badge">白底 · 單檔 · 內嵌 Supabase</span>
    </div>
    <div class="right">
      <span id="who" class="muted"></span>
      <button class="ghost" id="btnHome" onclick="location.href='index.html'">回首頁</button>
      <button class="outline" id="btnSignOut">登出</button>
    </div>
  </header>

  <main id="app-main" class="hide">
    <nav class="tabs">
      <button class="tab-btn active" data-tab="users">使用者清單</button>
      <button class="tab-btn" data-tab="roles">授權 / 暫停管理員</button>
      <button class="tab-btn" data-tab="mp4">MP4 上傳自動化</button>
    </nav>

    <!-- 使用者清單 -->
    <section id="tab-users" class="card">
      <div class="toolbar">
        <input id="q" type="text" placeholder="搜尋 Email / 顯示名稱…" />
        <button id="btnRefresh">重新整理</button>
        <span class="pill">顯示資料表：public.profiles · 時間以台灣時區顯示 · 每 10 分鐘內視為「在線」</span>
      </div>
      <table id="usersTable">
        <thead>
          <tr>
            <th style="min-width:260px">Email</th>
            <th>顯示名稱</th>
            <th>最後登入（台灣）</th>
            <th>最近在線（台灣）</th>
            <th>管理員</th>
            <th>狀態</th>
            <th>到期日</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="7" class="muted">載入中…</td></tr>
        </tbody>
      </table>
    </section>

    <!-- 授權 / 暫停管理員 -->
    <section id="tab-roles" class="card hide">
      <div class="toolbar">
        <input id="rq" type="text" placeholder="搜尋 Email / 顯示名稱…" />
        <button id="btnReloadRoles">重新整理</button>
        <span class="pill">變更 is_admin / is_suspended（需 RLS 允許管理員更新）</span>
      </div>
      <table id="rolesTable">
        <thead>
          <tr>
            <th style="min-width:260px">Email</th>
            <th>顯示名稱</th>
            <th>管理員</th>
            <th>暫停</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="5" class="muted">載入中…</td></tr>
        </tbody>
      </table>
    </section>

    <!-- MP4 上傳自動化（簡化單檔上傳） -->
    <section id="tab-mp4" class="card hide">
      <div class="toolbar" style="gap:14px">
        <label>分類
          <select id="vCategory">
            <option value="story">story</option>
            <option value="music">music</option>
            <option value="movie">movie</option>
            <option value="news">news</option>
            <option value="pro">pro</option>
          </select>
        </label>
        <label>Slug（檔名不含副檔名）
          <input id="vSlug" type="text" placeholder="例如：mid-autumn" />
        </label>
        <label>MP4 檔
          <input id="vFile" type="file" accept="video/mp4" />
        </label>
        <label>封面（可選）
          <input id="coverFile" type="file" accept="image/*" />
        </label>
        <button id="btnUpload">上傳</button>
        <span class="pill">會上傳到 Storage: videos/{category}/{slug}.mp4 及 data/{category}/{slug}/cover.jpg</span>
      </div>
      <div id="upLog" class="muted">待命中…</div>
    </section>
  </main>

  <section id="guard-block" class="blocked hide">
    <div class="card">
      <h2>拒絕訪問</h2>
      <p id="blockMsg">您沒有管理員權限。</p>
      <div class="right">
        <button class="ghost" onclick="location.href='index.html'">回首頁</button>
        <button id="btnBlockSignOut">登出</button>
      </div>
    </div>
  </section>

  <footer id="app-footer" class="hide">
    BookWide Admin · 內嵌 Supabase 版 · <span id="ver"></span>
  </footer>

  <!-- ========== 內嵌 Supabase 初始化（務必先填入 URL 與 ANON KEY） ========== -->
  <script type="module">
    // ==== 必填：替換成你自己的 Supabase 專案參數 ====
    const SUPABASE_URL = 'https://jeajrwpmrgczimmrflxo.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do';
    // ================================================

    // 單例：建立 Supabase client
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    const supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });

    // ====== 工具 ======
    const $ = (sel)=> document.querySelector(sel);
    const $$ = (sel)=> Array.from(document.querySelectorAll(sel));
    const fmtTW = (iso)=> {
      if(!iso) return '';
      try{
        const d = new Date(iso);
        return d.toLocaleString('zh-TW',{ timeZone:'Asia/Taipei' });
      }catch{ return iso; }
    };
    const within10Min = (iso)=> {
      if(!iso) return false;
      const t = new Date(iso).getTime();
      return (Date.now()-t) <= 10*60*1000;
    };

    // ====== 守門 ======
    async function guard(){
      try{
        const { data:{ user }, error } = await supa.auth.getUser();
        if(error) throw error;
        if(!user){
          // 未登入
          $('#blockMsg').textContent = '尚未登入，請回首頁登入後再進入此頁。';
          $('#guard-block').classList.remove('hide');
          return false;
        }
        // 讀取是否為管理員
        const { data: row, error: er2 } = await supa
          .from('public.profiles')
          .select('id,email,display_name,is_admin')
          .eq('id', user.id).maybeSingle();
        if(er2) throw er2;
        if(!row || !row.is_admin){
          $('#blockMsg').textContent = '您沒有管理員權限。';
          $('#guard-block').classList.remove('hide');
          return false;
        }
        // 通過
        $('#who').textContent = `${row.display_name ?? ''}（${row.email}）`;
        $('#app-header').classList.remove('hide');
        $('#app-main').classList.remove('hide');
        $('#app-footer').classList.remove('hide');
        return true;
      }catch(e){
        console.error('[Guard]', e);
        $('#blockMsg').textContent = '無法驗證身分（請檢查 Supabase 連線與 RLS 設定）。';
        $('#guard-block').classList.remove('hide');
        return false;
      }
    }

    // ====== 使用者清單 ======
    async function loadUsers(){
      const q = ($('#q').value||'').trim().toLowerCase();
      // 優先完整欄位，失敗再降級
      const colsA = 'id,email,display_name,is_admin,is_suspended,is_paused,last_sign_in_at,last_seen_at,expires_at';
      const colsB = 'id,email,display_name,is_admin,last_sign_in_at,last_seen_at,expires_at';
      let r = await supa.from('public.profiles').select(colsA).order('email',{ascending:true});
      if(r.error){ r = await supa.from('public.profiles').select(colsB).order('email',{ascending:true}); }
      const rows = r.data||[];
      const tbody = $('#usersTable tbody');
      const hit = rows.filter(x=>{
        const key = `${x.email||''} ${x.display_name||''}`.toLowerCase();
        return !q || key.includes(q);
      });
      if(hit.length===0){
        tbody.innerHTML = `<tr><td colspan="7" class="muted">沒有符合的資料</td></tr>`;
        return;
      }
      tbody.innerHTML = hit.map(x=>{
        const online = within10Min(x.last_seen_at);
        return `<tr>
          <td>${x.email??''}</td>
          <td>${x.display_name??''}</td>
          <td>${fmtTW(x.last_sign_in_at)}</td>
          <td>${x.last_seen_at? `<span class="chip ${online?'green':'gray'}">${fmtTW(x.last_seen_at)} ${online? '（在線）':''}</span>`:''}</td>
          <td>${x.is_admin?'<span class="chip green">是</span>':'<span class="chip gray">否</span>'}</td>
          <td>${x.is_suspended?'<span class="chip red">停用</span>':'<span class="chip green">正常</span>'}</td>
          <td>${x.expires_at??''}</td>
        </tr>`;
      }).join('');
    }

    // ====== 授權 / 暫停 ======
    async function loadRoles(){
      const q = ($('#rq').value||'').trim().toLowerCase();
      const cols = 'id,email,display_name,is_admin,is_suspended';
      const { data: rows = [] } = await supa.from('public.profiles').select(cols).order('email',{ascending:true});
      const hit = rows.filter(x=>{
        const key = `${x.email||''} ${x.display_name||''}`.toLowerCase();
        return !q || key.includes(q);
      });
      const tbody = $('#rolesTable tbody');
      if(hit.length===0){ tbody.innerHTML = `<tr><td colspan="5" class="muted">沒有符合的資料</td></tr>`; return; }
      tbody.innerHTML = hit.map(x=>`<tr>
        <td>${x.email}</td>
        <td>${x.display_name??''}</td>
        <td>${x.is_admin?'<span class="chip green">是</span>':'<span class="chip gray">否</span>'}</td>
        <td>${x.is_suspended?'<span class="chip red">停用</span>':'<span class="chip green">正常</span>'}</td>
        <td class="row-actions">
          <button class="ghost" data-action="toggle-admin" data-id="${x.id}" data-now="${x.is_admin?'1':'0'}">${x.is_admin?'取消管理員':'設為管理員'}</button>
          <button class="ghost" data-action="toggle-suspend" data-id="${x.id}" data-now="${x.is_suspended?'1':'0'}">${x.is_suspended?'解除暫停':'暫停'}</button>
        </td>
      </tr>`).join('');
      // 綁定事件
      $$('#rolesTable [data-action]').forEach(btn=>{
        btn.addEventListener('click', async e=>{
          const id = btn.dataset.id;
          const isNow = btn.dataset.now === '1';
          const act = btn.dataset.action;
          btn.disabled = true;
          try{
            if(act==='toggle-admin'){
              const { error } = await supa.from('public.profiles').update({ is_admin: !isNow }).eq('id', id);
              if(error) throw error;
            }else if(act==='toggle-suspend'){
              const { error } = await supa.from('public.profiles').update({ is_suspended: !isNow }).eq('id', id);
              if(error) throw error;
            }
            await loadRoles();
            await loadUsers();
          }catch(err){
            alert('更新失敗：'+(err?.message||err));
          }finally{
            btn.disabled = false;
          }
        });
      });
    }

    // ====== MP4 上傳簡化 ======
    async function uploadMP4(){
      const cat = $('#vCategory').value.trim();
      const slug = $('#vSlug').value.trim();
      const v = $('#vFile').files[0];
      const cover = $('#coverFile').files[0];
      const log = (msg)=> $('#upLog').textContent = msg;
      if(!v || !slug){ alert('請選擇 MP4 檔並填寫 slug'); return; }
      try{
        log('上傳影片中…');
        const videoPath = `videos/${cat}/${slug}.mp4`;
        const { error: e1 } = await supa.storage.from('videos').upload(videoPath, v, { upsert:true, contentType:'video/mp4' });
        if(e1) throw e1;
        if(cover){
          log('上傳封面中…');
          const coverPath = `data/${cat}/${slug}/cover.jpg`;
          const { error: e2 } = await supa.storage.from('assets').upload(coverPath, cover, { upsert:true });
          if(e2) throw e2;
        }
        log('完成 ✅');
      }catch(err){
        log('失敗：'+(err?.message||err));
      }
    }

    // ====== 分頁切換 ======
    function bindTabs(){
      $$('.tab-btn').forEach(btn=>btn.addEventListener('click', ()=>{
        $$('.tab-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.dataset.tab;
        $('#tab-users').classList.toggle('hide', tab!=='users');
        $('#tab-roles').classList.toggle('hide', tab!=='roles');
        $('#tab-mp4').classList.toggle('hide', tab!=='mp4');
      }));
    }

    // ====== 事件 ======
    $('#btnRefresh').addEventListener('click', loadUsers);
    $('#btnReloadRoles').addEventListener('click', loadRoles);
    $('#q').addEventListener('input', ()=> loadUsers());
    $('#rq').addEventListener('input', ()=> loadRoles());
    $('#btnUpload').addEventListener('click', uploadMP4);
    $('#btnSignOut').addEventListener('click', async ()=>{ await supa.auth.signOut(); location.href='index.html'; });
    $('#btnBlockSignOut').addEventListener('click', async ()=>{ await supa.auth.signOut(); location.href='index.html'; });

    // 版本
    $('#ver').textContent = 'v20251104';

    // ====== 啟動流程 ======
    (async ()=>{
      bindTabs();
      const ok = await guard();
      if(!ok) return;
      await loadUsers();
      await loadRoles();
    })();
  </script>
</body>
</html>













