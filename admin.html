<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BookWide Admin · 白底三分頁 + Videos Insert · v20251104-fix</title>

  <!-- ✅ 只保留一次：由 supa.js 建立 Supabase 連線與 BW 工具（不要在本頁再 createClient） -->
  <script type="module" src="./supa.js"></script>

  <style>
    :root{
      --bg:#ffffff; --fg:#111; --muted:#6b7280; --chip:#eef2ff; --ok:#16a34a; --warn:#f59e0b; --card:#fafafa;
      --brand:#2563eb;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue","PingFang TC","Noto Sans CJK TC",sans-serif}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
    h1{font-weight:800;font-size:22px;margin:0}
    .grow{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:.62rem 1rem;border:1px solid #e5e7eb;border-radius:10px;background:#fff;text-decoration:none;color:var(--fg)}
    .btn:hover{border-color:#d1d5db}
    .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .hint{color:var(--muted);font-size:13px}
    .toolbar{display:flex;gap:10px;align-items:center;margin:12px 0}
    input[type="search"]{width:340px;padding:.6rem .8rem;border:1px solid #e5e7eb;border-radius:10px;background:#fff;color:var(--fg)}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden}
    th,td{padding:12px 14px;text-align:left;border-bottom:1px solid #f3f4f6;vertical-align:top}
    th{background:#f8fafc;font-weight:700;color:#334155}
    tr:last-child td{border-bottom:none}
    .chip{display:inline-block;padding:.2rem .5rem;border-radius:9999px;background:var(--chip);color:#1e40af;font-weight:600;font-size:12px}
    .ok{background:#dcfce7;color:#166534}
    .warn{background:#fef3c7;color:#92400e}
    .muted{color:var(--muted)}
    .right{display:flex;gap:8px;align-items:center;justify-content:flex-end}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>BookWide Admin 主控台</h1>
      <div class="grow"></div>
      <a class="btn" href="./index.html">回首頁</a>
    </header>

    <div class="toolbar">
      <input id="q" type="search" placeholder="搜尋 Email / 顯示名稱…" />
      <button id="btnReload" class="btn">重新整理</button>
      <span class="grow"></span>
      <a class="btn" href="#" id="btnUsers">使用者清單</a>
      <a class="btn" href="#" id="btnRoles">授權 / 暫停管理員</a>
      <a class="btn" href="#" id="btnMp4">MP4 上傳自動化</a>
    </div>

    <div class="hint">顯示資料來自 <b>public.profiles</b> · 時間以台灣時區 (Asia/Taipei) 顯示 · 每 10 分鐘內視為「在線」。</div>

    <table>
      <thead>
        <tr>
          <th style="width:28%">Email</th>
          <th style="width:16%">顯示名稱</th>
          <th style="width:18%">最後登入（台灣）</th>
          <th style="width:16%">最近在線（台灣）</th>
          <th style="width:8%">管理員</th>
          <th style="width:8%">狀態</th>
          <th style="width:10%">到期日</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td class="muted" colspan="7">載入中…</td></tr>
      </tbody>
    </table>

    <footer class="hint" style="margin-top:18px">BookWide Admin · 內嵌 Supabase 版 · v20251104-fix</footer>
  </div>

  <script type="module">
    // ✅ 必須已由 supa.js 建立好 `window.supa` 與 `window.BW`。
    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>Array.from(document.querySelectorAll(sel));

    // Taiwan time formatter
    const fmt = new Intl.DateTimeFormat('zh-TW', {
      year:'numeric', month:'2-digit', day:'2-digit',
      hour:'2-digit', minute:'2-digit', second:'2-digit',
      hour12:false, timeZone:'Asia/Taipei'
    });

    function toTW(iso){
      if(!iso) return '—';
      try{ return fmt.format(new Date(iso)); }catch(e){ return '—'; }
    }

    function onlineTag(lastSeenIso){
      if(!lastSeenIso) return '<span class="chip muted">離線</span>';
      const diff = Date.now() - new Date(lastSeenIso).getTime();
      const min = diff / 60000;
      if(min <= 10) return '<span class="chip ok">在線</span>';
      return '<span class="chip muted">離線</span>';
    }

    function stateTag(row){
      if(row.is_suspended) return '<span class="chip warn">停權</span>';
      if(row.is_paused) return '<span class="chip warn">暫停</span>';
      return '<span class="chip ok">正常</span>';
    }

    async function loadProfiles(){
      const q = $('#q').value.trim().toLowerCase();
      const tbody = $('#rows');
      tbody.innerHTML = '<tr><td class="muted" colspan="7">載入中…</td></tr>';
      try{
        // 直接使用 supa.js 提供的全域 `supa`
        const columns = 'email, display_name, is_admin, is_suspended, is_paused, last_sign_in_at, last_seen_at, expires_at';
        let { data, error } = await window.supa
          .from('profiles')
          .select(columns)
          .order('email', { ascending:true });

        if(error) throw error;

        // 搜尋過濾
        if(q){
          const qq = q;
          data = data.filter(r => (r.email||'').toLowerCase().includes(qq) || (r.display_name||'').toLowerCase().includes(qq));
        }

        if(!data || !data.length){
          tbody.innerHTML = '<tr><td class="muted" colspan="7">目前沒有符合的資料。</td></tr>';
          return;
        }

        tbody.innerHTML = data.map(r=>{
          const admin = r.is_admin ? '<span class="chip ok">是</span>' : '<span class="chip muted">否</span>';
          return `<tr>
            <td>${r.email ?? ''}</td>
            <td>${r.display_name ?? ''}</td>
            <td>${toTW(r.last_sign_in_at)}</td>
            <td>${onlineTag(r.last_seen_at)}</td>
            <td>${admin}</td>
            <td>${stateTag(r)}</td>
            <td>${(r.expires_at? r.expires_at.split('T')[0]:'—')}</td>
          </tr>`;
        }).join('');

      }catch(err){
        console.error('[admin] loadProfiles error:', err);
        tbody.innerHTML = `<tr><td colspan="7" class="muted">讀取失敗：${err.message ?? err}</td></tr>`;
      }
    }

    // 守門 + 心跳（由 supa.js 的 BW 提供）
    try{
      await window.BW?.requireAdmin?.();
    }catch(e){
      // 若舊版 supa.js 尚未提供 requireAdmin，則簡單檢查是否登入
      const { data:{ user } } = await window.supa.auth.getUser();
      if(!user){ location.href='./index.html'; }
    }
    // 心跳：每 2 分鐘更新 last_seen
    if(window.BW?.startHeartbeat){
      window.BW.startHeartbeat(2);
    }else{
      setInterval(async ()=>{
        try{ await window.supa.from('profiles').update({ last_seen_at: new Date().toISOString() }).eq('email','__self__'); }catch(_){}
      }, 120000);
    }

    // 綁定事件
    $('#btnReload').addEventListener('click', loadProfiles);
    $('#q').addEventListener('input', ()=>{
      clearTimeout(window.__deb); window.__deb = setTimeout(loadProfiles, 300);
    });

    // 初次載入
    await loadProfiles();
  </script>
</body>
</html>














