<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BookWide Admin · 三步驟（上傳 → 產生 → 預覽/下載）</title>
<style>
  :root{--c:#2563eb;--g:#16a34a;--r:#dc2626;--bg:#f8fafc;--bd:#e5e7eb}
  body{font-family:ui-sans-serif,system-ui,'Segoe UI',sans-serif;background:#fff;margin:0}
  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--bd)}
  header .wrap{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 14px}
  h1{font-size:18px;margin:0}
  main{max-width:980px;margin:16px auto;padding:0 14px}
  section{border:1px solid var(--bd);border-radius:12px;margin:12px 0;padding:14px}
  section>h2{font-size:16px;margin:0 0 12px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .col{flex:1 1 280px}
  textarea{width:100%;min-height:120px;border:1px solid var(--bd);border-radius:10px;padding:10px;font-size:14px}
  input[type="text"],input[type="number"],select{width:100%;border:1px solid var(--bd);border-radius:10px;padding:10px;font-size:14px}
  .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--bd);border-radius:9999px;padding:10px 14px;background:#fff;cursor:pointer}
  .btn.p{background:var(--c);border-color:var(--c);color:#fff}
  .btn.s{background:var(--g);border-color:var(--g);color:#fff}
  .btn.d{background:#64748b;border-color:#64748b;color:#fff}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .muted{color:#64748b;font-size:12px}
  .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  pre{background:var(--bg);border:1px solid var(--bd);padding:10px;border-radius:10px;white-space:pre-wrap;word-break:break-word;max-height:280px;overflow:auto;font-size:12px}
  .chip{padding:2px 8px;border-radius:9999px;border:1px solid var(--bd);font-size:12px;background:#f1f5f9}
</style>
</head>
<body>
<header><div class="wrap">
  <h1>BookWide Admin · 三步驟</h1>
  <div class="bar">
    <label class="muted"><input id="minify" type="checkbox" checked/> 緊湊 JSON</label>
    <a id="downloadZip" class="btn d" download style="pointer-events:none">下載 JSON ZIP</a>
  </div>
</div></header>

<main>
  <!-- Step 1: 上傳影片 -->
  <section id="s1">
    <h2>① 上傳影片</h2>
    <div class="row">
      <div class="col"><label>分類
        <select id="category">
          <option value="story">story</option>
          <option value="music" selected>music</option>
          <option value="movie">movie</option>
          <option value="news">news</option>
          <option value="pro">pro</option>
        </select></label></div>
      <div class="col"><label>Slug（不含空白與副檔名）<input id="slug" type="text" placeholder="alittlelove"/></label></div>
      <div class="col"><label>顯示標題（可空）<input id="title" type="text" placeholder="A Little Love"/></label></div>
    </div>
    <div class="row">
      <div class="col"><label>MP4 檔<input id="mp4" type="file" accept="video/mp4" /></label></div>
      <div class="col"><label>封面（可空）<input id="cover" type="file" accept="image/*" /></label></div>
      <div class="col"><label>封面檔名（預設 cover.jpg）<input id="coverName" type="text" value="cover.jpg"/></label></div>
    </div>
    <div class="bar" style="margin-top:10px">
      <button id="btnUpload" class="btn p">上傳到 Supabase</button>
      <span id="uploadMsg" class="muted">尚未上傳</span>
    </div>
    <div class="muted" style="margin-top:6px">影片路徑：videos/{category}/{slug}.mp4；封面：assets/{category}/{slug}/{coverName}</div>
  </section>

  <!-- Step 2: 多語與產生 -->
  <section id="s2">
    <h2>② 填寫多語 → 產生 JSON</h2>
    <div class="bar" style="margin-bottom:8px">
      <button id="btnGenerate" class="btn s">產生 JSON（不上傳）</button>
      <label class="chip">總題數 <input id="quizTotal" type="number" value="60" min="10" max="120" style="width:70px;margin-left:6px"></label>
      <label class="chip">每題選項 <input id="quizChoices" type="number" value="4" min="3" max="6" style="width:60px;margin-left:6px"></label>
    </div>
    <div class="grid3">
      <div><div class="muted">EN 字幕（每行一句）</div><textarea id="en"></textarea></div>
      <div><div class="muted">ZH 字幕（對齊 EN，可空）</div><textarea id="zh"></textarea></div>
      <div><div class="muted">JA 字幕（可空，不參與輸出）</div><textarea id="ja"></textarea></div>
    </div>
    <div style="margin-top:10px">
      <div class="muted">Vocab（每行：<code>word | pos | zh | en</code>）</div>
      <textarea id="vocab" placeholder="festival | n. | 節慶 | "></textarea>
    </div>
  </section>

  <!-- Step 3: 預覽與下載 -->
  <section id="s3">
    <h2>③ 預覽 → 下載 / 之後接 GitHub</h2>
    <div class="row">
      <div class="col"><div class="muted">index-*.json</div><pre id="pv-index">{}</pre></div>
      <div class="col"><div class="muted">cues-*.json</div><pre id="pv-cues">[]</pre></div>
      <div class="col"><div class="muted">vocab-*.json</div><pre id="pv-vocab">[]</pre></div>
    </div>
    <div class="row" style="margin-top:10px">
      <div class="col"><div class="muted">quiz-*.json</div><pre id="pv-quiz">[]</pre></div>
      <div class="col"><div class="muted">ai-*.json</div><pre id="pv-ai">{"topics":[]}</pre></div>
    </div>
    <div class="bar" style="margin-top:10px">
      <button id="btnCopyAll" class="btn">複製全部 JSON</button>
      <span id="genMsg" class="muted">尚未產生</span>
    </div>
  </section>
</main>

<script>
// === Supabase client（使用你現有變數 window.supa；若無就跳過上傳） ===

// 工具
function two(n){n=Math.floor(n);return (n<10?'0':'')+n}
function secToMMSS(s){if(!isFinite(s))s=0;const m=Math.floor(s/60),ss=Math.floor(s%60);return two(m)+':'+two(ss)}
function lines(id){return String(document.getElementById(id).value||'').replace(/\\r/g,'').split('\\n').map(s=>s.trim())}
function padTo(a,n){a=a.slice();while(a.length<n)a.push('');return a}

// 估時長（讀取 <video> metadata）
async function getDuration(file){
  return await new Promise((resolve)=>{
    if(!file) return resolve(0);
    const url = URL.createObjectURL(file);
    const v = document.createElement('video');
    v.preload='metadata'; v.src=url;
    v.onloadedmetadata=()=>{const d=isFinite(v.duration)?v.duration:0;URL.revokeObjectURL(url);resolve(d)};
    v.onerror=()=>resolve(0);
  });
}

// 產生 cues 陣列（Houyi）
function buildCues(en, zh, durationSec){
  const N = en.filter(Boolean).length || 12;
  const span = Math.max(2, Math.floor((durationSec||N*5)/Math.max(1,N)));
  zh = padTo(zh, N);
  const out=[];
  for(let i=0;i<N;i++){
    out.push({time:secToMMSS(i*span+1), en:en[i]||'', zh:zh[i]||''});
  }
  return out;
}

// 解析 vocab（Houyi）
function parseVocab(){
  const raw = lines('vocab').filter(Boolean);
  const out=[]; let t=2;
  for(const s of raw){
    const p = s.split('|').map(x=>x.trim());
    out.push({time:secToMMSS(t), word:p[0]||'', pos:p[1]||'', zh:p[2]||'', en:p[3]||''});
    t+=3;
  }
  return out;
}

// 簡單出題（MCQ/SA），符合你 player 的題型鍵名
function randPick(a){return a[Math.floor(Math.random()*a.length)]}
function makeQuiz(vocab, total, choiceN){
  const qs=[]; const words=vocab.map(v=>v.word).filter(Boolean);
  while(qs.length<total){
    if(qs.length%3===0 && words.length){ // Vocab MCQ
      const w = randPick(words);
      const wrong = words.filter(x=>x!==w).slice(0,choiceN-1);
      const opts = [w, ...wrong].slice(0,choiceN);
      qs.push({section:"Vocabulary",type:"MCQ",question:`Choose the correct word:`,options:opts,answer:w,explanation:""});
    }else if(qs.length%4===0){ // Reading MCQ
      qs.push({section:"Reading",type:"MCQ",question:"Why did people suffer in the legend?",options:["It was very hot and dry.","There was no air.","It was very cold.","There was too much rain."].slice(0,choiceN),answer:"It was very hot and dry.",explanation:""});
    }else{ // SA
      qs.push({section:"Mixed",type:"SA",question:"Who saved the people from the heat?",answer:"Houyi",explanation:""});
    }
  }
  return qs.slice(0,total);
}

// AI topics（10 題）
function buildAI(){
  const prompts=["Describe the video.","Summarize the story.","List 3 new words.","Share your opinion.","What happens next?"];
  const topics=[]; for(let i=0;i<10;i++){const p=prompts[i%prompts.length];topics.push({title:`Topic ${i+1}`,prompt:p,hint:"",sample:""})}
  return {schema:"bw-ai@1.0",topics};
}

const $ = (id)=>document.getElementById(id);

// Step 1 上傳
$('btnUpload').addEventListener('click', async ()=>{
  const f = $('mp4').files[0];
  const cov = $('cover').files[0];
  const cat=$('category').value, slug=$('slug').value.trim(), title=$('title').value.trim()||slug, coverName=$('coverName').value||'cover.jpg';
  if(!f || !slug){ alert('請選 MP4 與填 slug'); return; }
  let videoUrl='', coverUrl='';
  try{
    if(window.supa){
      const vpath=`${cat}/${slug}.mp4`;
      const {error:e1}=await supa.storage.from('videos').upload(vpath,f,{upsert:true,contentType:'video/mp4'}); if(e1) throw e1;
      videoUrl = supa.storage.from('videos').getPublicUrl(vpath).data.publicUrl;
      if(cov){
        const cpath=`${cat}/${slug}/${coverName}`;
        const {error:e2}=await supa.storage.from('assets').upload(cpath,cov,{upsert:true,contentType:cov.type||'image/jpeg'}); if(e2) throw e2;
        coverUrl = supa.storage.from('assets').getPublicUrl(cpath).data.publicUrl;
      }
      $('uploadMsg').textContent='已上傳：'+videoUrl.split('/').pop();
    }else{
      $('uploadMsg').textContent='未連 Supabase，僅本地產生';
    }
  }catch(e){
    console.error(e); alert('上傳失敗：'+(e.message||e)); $('uploadMsg').textContent='上傳失敗';
    return;
  }
  // 暫存
  window._ctx = {category:cat, slug, title, videoUrl, coverUrl, coverName, durationSec: await getDuration(f)};
});

// Step 2 產生
$('btnGenerate').addEventListener('click', async ()=>{
  const ctx = window._ctx || {category:$('category').value, slug:$('slug').value.trim(), title:$('title').value.trim()||$('slug').value.trim(), videoUrl:'', coverUrl:'', durationSec: await getDuration($('mp4').files[0])};
  if(!ctx.slug){ alert('請先填 slug'); return; }
  const en = lines('en').filter(Boolean);
  const zh = lines('zh');
  const vocab = parseVocab();
  const cues = buildCues(en, zh, ctx.durationSec);
  const quizTotal = parseInt($('quizTotal').value||'60',10);
  const choiceN = parseInt($('quizChoices').value||'4',10);
  const quiz = makeQuiz(vocab, quizTotal, choiceN);
  const ai = buildAI();
  const index = {
    title: ctx.title, category: ctx.category||"", slug: ctx.slug,
    video: ctx.videoUrl||"", cover: ctx.coverUrl||"",
    is_public: true,
    cues: { zh: `./cues-${ctx.slug}.json` },
    vocab: `./vocab-${ctx.slug}.json`,
    quiz: `./quiz-${ctx.slug}.json`,
    ai: `./ai-${ctx.slug}.json`
  };
  // 預覽
  const pretty = (o)=> JSON.stringify(o, null, 2);
  $('pv-index').textContent = pretty(index);
  $('pv-cues').textContent  = pretty(cues);
  $('pv-vocab').textContent = pretty(vocab);
  $('pv-quiz').textContent  = pretty(quiz);
  $('pv-ai').textContent    = pretty(ai);

  // 存成 zip 連結
  const minify = $('minify').checked;
  const toStr = (o)=> minify ? JSON.stringify(o) : JSON.stringify(o, null, 2);
  const zip = new JSZip();
  zip.file(`index-${ctx.slug}.json`, toStr(index));
  zip.file(`cues-${ctx.slug}.json`,  toStr(cues));
  zip.file(`vocab-${ctx.slug}.json`, toStr(vocab));
  zip.file(`quiz-${ctx.slug}.json`,  toStr(quiz));
  zip.file(`ai-${ctx.slug}.json`,    toStr(ai));
  const blob = await zip.generateAsync({type:'blob'});
  const url = URL.createObjectURL(blob);
  const a = $('downloadZip'); a.href=url; a.style.pointerEvents='auto'; a.download=`${ctx.slug}.zip`;
  $('genMsg').textContent=`完成 ✓ 題數 ${quiz.length}，字幕 ${cues.length} 行`;
  window._lastZipUrl = url;
});

$('btnCopyAll').addEventListener('click', ()=>{
  const all = {
    index: JSON.parse($('pv-index').textContent||'{}'),
    cues:  JSON.parse($('pv-cues').textContent||'[]'),
    vocab: JSON.parse($('pv-vocab').textContent||'[]'),
    quiz:  JSON.parse($('pv-quiz').textContent||'[]'),
    ai:    JSON.parse($('pv-ai').textContent||'{"topics":[]}')
  };
  navigator.clipboard.writeText(JSON.stringify(all, null, 2));
});

</script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</body></html>





















































































































































































































































































































































































