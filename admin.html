<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin · 上傳自動化＋對齊字幕（slug 檔名版）· v20251104-2</title>
  <script type="module" src="./supa.js">document.addEventListener('click',function(ev){
  var btn=document.getElementById('accountMenuBtn'); var menu=document.getElementById('accountMenu');
  if(!btn||!menu) return;
  if(btn.contains(ev.target)){ var open=menu.style.display!=='none'; menu.style.display=open?'none':'block'; btn.setAttribute('aria-expanded', open?'false':'true'); }
  else if(!menu.contains(ev.target)){ menu.style.display='none'; btn.setAttribute('aria-expanded','false'); }
});
var so=document.getElementById('signoutBtn');
if(so && window.BW && BW.supa){ so.addEventListener('click', async function(){ try{ await BW.supa.auth.signOut(); location.reload(); }catch(e){ alert('登出失敗'); } }); }
</script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <style>
    :root{ --bg:#ffffff; --fg:#111; --muted:#6b7280; --muted-2:#9ca3af; --line:#e5e7eb;
           --brand:#2563eb; --chip:#eef2ff; --ok:#16a34a; --warn:#f59e0b; --card:#fafafa; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","PingFang TC","Noto Sans CJK TC","微軟正黑體",sans-serif}
    header{padding:18px 20px;border-bottom:1px solid var(--line);display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .title{font-size:22px;font-weight:700;margin-right:auto}
    .chip{display:inline-block;padding:.35rem .6rem;border-radius:999px;background:var(--chip);color:var(--brand);font-size:12px}
    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab-btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:.5rem 1rem;cursor:pointer}
    .tab-btn.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    .wrap{max-width:1120px;margin:24px auto;padding:0 16px}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0 16px}
    .input, select{border:1px solid var(--line);border-radius:10px;padding:.55rem .8rem;background:#fff}
    .btn{border:1px solid var(--brand);background:var(--brand);color:#fff;border-radius:10px;padding:.55rem .9rem;cursor:pointer}
    .btn.outline{background:#fff;color:var(--brand)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
    .table th,.table td{padding:.75rem .8rem;border-bottom:1px solid var(--line);text-align:left}
    .table th{background:var(--card);font-weight:600;color:#222}
    .muted{color:var(--muted)} .hint{color:var(--muted-2);font-size:13px}
    .hr{height:1px;background:var(--line);margin:18px 0}
    .row{display:grid;gap:12px} .grid-2{grid-template-columns:1fr 1fr} .grid-3{grid-template-columns:1fr 1fr 1fr}
    @media (max-width:820px){ .grid-2,.grid-3{grid-template-columns:1fr} }
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px}
    footer{padding:22px 20px;color:var(--muted);border-top:1px solid var(--line);text-align:center;margin-top:28px}
    .pill{display:inline-block;padding:.25rem .55rem;border-radius:999px;border:1px solid var(--line);font-size:12px}
    .pill.ok{color:#16a34a;border-color:#16a34a} .pill.warn{color:#f59e0b;border-color:#f59e0b}
    .drop{border:2px dashed var(--line);border-radius:12px;padding:18px;text-align:center;background:#fff}
    .drop.drag{border-color:#2563eb;background:#f8fbff}
    .progress{height:10px;background:#eef2ff;border-radius:99px;overflow:hidden}
    .bar{height:100%;width:0;background:#2563eb;transition:width .2s}
    code{background:#f6f8fa;border:1px solid #eaeef2;border-radius:6px;padding:2px 6px}
    .input.compact{min-height:72px}
  .input.compact:focus{min-height:140px}
  details{margin-top:8px}
  .row.grid-3{grid-template-columns:1fr 1fr 1fr; align-items:start}
  .inline-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.inline-3 .input{width:100%}
</style>
</head>
<body>
  <header>
    <div class="title">BookWide Admin 主控台</div>
    <span class="chip">白底 · 單檔 · 內嵌 Supabase</span>
    <nav class="tabs">
      <button class="tab-btn active" data-tab="users">使用者清單</button>
      <button class="tab-btn" data-tab="roles">授權 / 暫停管理員</button>
      <button class="tab-btn" data-tab="mp4">MP4 上傳自動化</button>
    </nav>
</header>

  <main class="wrap">
    <section id="panel-users">
      <div class="toolbar">
        <input id="q" class="input" style="min-width:260px" placeholder="搜尋 Email / 顯示名稱…" />
        <button id="btnRefresh" class="btn outline">重新整理</button>
        <span class="hint">顯示資料來自 <b>public.profiles</b> · 時間以台灣時區 (Asia/Taipei) 顯示 · 每 10 分鐘內視為「在線」。</span>
      </div>
      <table class="table" id="usersTable">
        <thead><tr>
          <th>Email</th><th>顯示名稱</th><th>最後登入（台灣）</th><th>最近在線（台灣）</th><th>管理員</th><th>狀態</th><th>到期日</th>
        </tr></thead>
        <tbody><tr><td colspan="7" class="muted">載入中…</td></tr></tbody>
      </table>
    </section>

    <section id="panel-roles" style="display:none">
      <div class="card">
        <div class="row grid-3">
          <div><label class="muted">Email</label><input id="roleEmail" class="input" placeholder="user@example.com"></div>
          <div>
            <label class="muted">動作</label>
            <select id="roleAction" class="input">
              <option value="grant-admin">授予管理員</option>
              <option value="revoke-admin">移除管理員</option>
              <option value="pause">暫停登入</option>
              <option value="unpause">解除暫停</option>
            </select>
          </div>
          <div style="display:flex;align-items:flex-end"><button id="btnApplyRole" class="btn">套用</button></div>
        </div>
        <div class="hr"></div>
        <div class="hint">此區直接更新 <b>public.profiles</b> 欄位：<code>is_admin</code> / <code>is_paused</code>。</div>
        <div id="roleMsg" class="muted" style="margin-top:10px"></div>
      </div>
    </section>

    <section id="panel-mp4" style="display:none">
      <div class="card">
        <h3 style="margin:6px 0 14px">MP4 上傳自動化（slug 檔名 · 完成即送 JSON ZIP）</h3>

        <div class="row grid-3">
          <div><label class="muted">分類</label>
            <select id="cat" class="input">
              <option value="story">story</option><option value="music" selected>music</option>
              <option value="movie">movie</option><option value="news">news</option>
              <option value="pro">pro</option>
            </select></div>
          <div><label class="muted">Slug（不含空白與副檔名）</label>
            <input id="slug" class="input" placeholder="alittlelove"></div>
          <div><label class="muted">顯示標題（可空）</label>
            <input id="title" class="input" placeholder="A Little Love"></div>
        
        <div class="hr"></div>
        <details open>
  <div style="display:flex;gap:8px;margin:6px 0 8px 0">
    <button id="btnMakeMultilang" class="btn secondary">從多語欄位產生 JSON（不上傳）</button>
  </div>
          <summary>多語字幕與單字（EN / ZH / JA）</summary>
          <div class="inline-3"><div><label class="muted">EN 字幕（每行一筆）</label>
          <textarea id="ml-en" class="input compact" style="min-height:120px" placeholder="每行一筆英文台詞"></textarea>
          </div><div><label class="muted">ZH 字幕（對齊 EN 行數；可空）</label>
          <textarea id="ml-zh" class="input compact" style="min-height:120px" placeholder="每行一筆中文台詞（可空）"></textarea>
          </div><div><label class="muted">JA 字幕（對齊 EN 行數；可空）</label>
          <textarea id="ml-ja" class="input compact" style="min-height:120px" placeholder="每行一筆日文台詞（可空）"></textarea></div></div>
          <label class="muted">Vocab（每行：word | pos | zh | ja）</label>
          <textarea id="ml-vocab" class="input compact" style="min-height:120px" placeholder="festival | n. | 節慶 | 祭り"></textarea>
          <div class="hint">若填入 EN 內容：將以多語行數自動產出 <code>cues-*.json</code>（每行預設等長；會套用自動吸附）。若留空：改用平均分段並產生示例詞彙/測驗。</div>
        </details>
</div>

        <div class="row grid-3" style="margin-top:12px">
          <div>
            <label class="muted">MP4 檔（可拖拉到框內）</label>
            <div id="drop" class="drop">
              <input id="mp4File" type="file" accept="video/mp4" style="display:none">
              <div>將檔案拖曳到此處，或 <button id="picker" class="btn outline" type="button">選擇檔案</button></div>
              <div id="chosen" class="hint" style="margin-top:6px">尚未選檔</div>
              <div class="progress" style="margin-top:8px"><div id="bar" class="bar"></div></div>
            </div>
          </div>
          <div><label class="muted">封面（可選）</label><input id="coverFile" type="file" accept="image/*" class="input"></div>
          <div><label class="muted">公開狀態</label>
            <select id="isPublic" class="input"><option value="true">公開</option><option value="false">非公開</option></select>
          </div>
        </div>

        <div class="row grid-3" style="margin-top:12px">
          <div style="display:flex;align-items:flex-end;gap:10px">
            <button id="btnUpload" class="btn">上傳並寫入資料表</button>
            <label class="hint" style="display:flex;align-items:center;gap:6px">
              <input id="autoAlign" type="checkbox" checked> 自動對齊字幕（吸附靜音）
            </label>
            <a id="zipLink" class="btn outline" href="#" download style="display:none">下載 JSON ZIP</a>
          </div>
          <div style="display:flex;align-items:flex-end">
            <span class="hint">影片路徑：<code>videos/{category}/{slug}.mp4</code>；封面（若選）：<code>assets/{category}/{slug}/cover.jpg</code></span>
          </div>
        </div>

        <div class="row grid-3" style="margin-top:12px">
          <div class="hint">對齊參數：門檻 <code id="p-th">0.008</code> · 靜音≧ <code id="p-sil">0.25s</code> · 吸附窗口 ±<code id="p-win">1.5s</code></div>
          <div style="display:flex;gap:8px;align-items:center">
            <label class="muted">RMS 門檻</label><input id="th" class="input" type="number" step="0.0001" value="0.008" style="width:110px">
            <label class="muted">最短靜音</label><input id="sil" class="input" type="number" step="0.05" value="0.25" style="width:110px">
            <label class="muted">窗口(±s)</label><input id="win" class="input" type="number" step="0.1" value="1.5" style="width:110px">
          </div>
        </div>

        <div class="hr"></div><div id="upMsg" class="muted">就緒。</div>
      </div>
    </section>
  </main>

  <footer>BookWide Admin · 內嵌 Supabase 版 · v20251104-slug2</footer>

  <script type="module">
// --- Fallback: segments -> bw-cues@1.1
function segmentsToHouyiCues(segs){
  var cues = (segs||[]).map(function(x){ return { time:{s:x.s||0, e:x.e||0}, en:'', zh:'', ja:'' }; });
  return { schema:'bw-cues@1.1', cues:cues };
}


// --- Fallback: vocab
function buildVocabHouyi(){ return { schema:'bw-vocab@1.1', words: [] }; }


// --- Fallback: quiz (empty list)
function buildQuizHouyiFromVocab(vocab, title){ return []; }


// --- Fallback: AI topics
function buildAIHouyi(title){
  var seeds = ['Describe the video.','Summarize the story.','List 3 new words.','Share your opinion.','What happens next?'];
  return { schema:'bw-ai@1.0', topics: seeds.map(function(p,i){ return {title:(title||'Topic')+' '+(i+1), prompt:p, hint:'', sample:''}; }) };
}

// --- Multilang helpers (in-block) ---
function __linesById(id){
  var el=document.getElementById(id); if(!el) return [];
  return String(el.value||'').replace(/\r/g,'').split('\n').map(function(s){return s.trim();}).filter(Boolean);
}
function __padTo(arr,n){ var a=arr.slice(); while(a.length<n){ a.push(''); } return a; }
function __buildCuesFromLines(durationSec){
  var EN=__linesById('ml-en'); if(!EN.length) return null;
  var ZH=__padTo(__linesById('ml-zh'), EN.length);
  var JA=__padTo(__linesById('ml-ja'), EN.length);
  var span = Math.max(2, Math.floor((durationSec||120)/Math.max(1, EN.length)));
  return EN.map(function(en,i){ return { s:i*span, e:(i+1)*span, en:en, zh:ZH[i]||'', ja:JA[i]||'' }; });
}
function __parseVocab(){
  var raw=__linesById('ml-vocab'); if(!raw.length) return null;
  return raw.map(function(s){ var p=s.split('|').map(function(x){return x.trim();}); return {word:p[0]||'', pos:p[1]||'', zh:p[2]||'', ja:p[3]||''}; })
            .filter(function(x){ return x.word && x.pos; });
}

    const ready = () => new Promise(function(r){ if (window.BW && window.BW.supa) return r(); const t = setInterval(function(){ if(window.BW && window.BW.supa){clearInterval(t); r();}},50); });
    await ready();

    await BW.requireAdmin();
    BW.startHeartbeat(2);

    const supa = BW.supa;
    const $ = function(q,root){ return (root||document).querySelector(q); };
    const $$ = function(q,root){ return Array.prototype.slice.call((root||document).querySelectorAll(q)); };
    const fmtTW = function(ts){ return !ts?'':new Date(ts).toLocaleString('zh-TW',{timeZone:'Asia/Taipei',hour12:false}); };
    const pill = function(ok, t, cls){ t = (typeof t!=='undefined')?t:(ok?'在線':'離線'); cls = cls || (ok?'pill ok':'pill'); return '<span class="'+cls+'">'+t+'</span>'; };

    $$('.tab-btn').forEach(function(b){
      b.addEventListener('click',function(){
        $$('.tab-btn').forEach(function(x){ x.classList.remove('active'); });
        b.classList.add('active');
        const t=b.getAttribute('data-tab');
        $('#panel-users').style.display = (t==='users')?'':'none';
        $('#panel-roles').style.display = (t==='roles')?'':'none';
        $('#panel-mp4').style.display   = (t==='mp4')  ?'':'none';
      });
    });

    async function loadProfiles(){
      const tbody = $('#usersTable tbody'); tbody.innerHTML='<tr><td class="muted" colspan="7">載入中…</td></tr>';
      const cols='email, display_name, is_admin, is_paused, last_sign_in_at, last_seen_at, expires_at';
      const r=await supa.from('profiles').select(cols).order('email',{ascending:true});
      if(r.error){ tbody.innerHTML='<tr><td class="muted" colspan="7">讀取失敗：'+r.error.message+'</td></tr>'; return; }
      const q = ($('#q').value||'').trim().toLowerCase();
      const rows=(r.data||[]).filter(function(x){
        return !q || ( (x.email||'').toLowerCase().includes(q) || (x.display_name||'').toLowerCase().includes(q) );
      });
      if(!rows.length){ tbody.innerHTML='<tr><td class="muted" colspan="7">沒有符合的資料</td></tr>'; return; }
      tbody.innerHTML=rows.map(function(x){
        const online = BW.isOnlineWithin(x.last_seen_at, 10);
        const status = x.is_paused ? '<span class="pill warn">暫停</span>' : '<span class="pill ok">正常</span>';
        return '<tr>'
          + '<td>'+(x.email||'')+'</td>'
          + '<td>'+(x.display_name||'')+'</td>'
          + '<td>'+(fmtTW(x.last_sign_in_at)||'')+'</td>'
          + '<td>'+(fmtTW(x.last_seen_at)||'')+' &nbsp; '+pill(online)+'</td>'
          + '<td>'+(x.is_admin?'<span class="pill ok">是</span>':'<span class="pill">否</span>')+'</td>'
          + '<td>'+status+'</td>'
          + '<td>'+(x.expires_at||'')+'</td>'
          + '</tr>';
      }).join('');
    }
    $('#btnRefresh').addEventListener('click',loadProfiles); $('#q').addEventListener('input',loadProfiles);
    loadProfiles();

    $('#btnApplyRole').addEventListener('click',async function(){
      const email=$('#roleEmail').value.trim(); const act=$('#roleAction').value; const msg=$('#roleMsg');
      if(!email){ msg.textContent='請輸入 Email'; return; }
      const q=await supa.from('profiles').select('id,is_admin').eq('email',email).maybeSingle();
      if(q.error){ msg.textContent='查詢失敗：'+q.error.message; return; } if(!q.data){ msg.textContent='找不到該使用者'; return; }
      var payload={},info='';
      if(act==='grant-admin'){payload={is_admin:true};info='已授予管理員';}
      if(act==='revoke-admin'){payload={is_admin:false};info='已移除管理員';}
      if(act==='pause'){payload={is_paused:true};info='已暫停登入';}
      if(act==='unpause'){payload={is_paused:false};info='已解除暫停';}
      const u=await supa.from('profiles').update(payload).eq('id',q.data.id);
      if(u.error){ msg.textContent='更新失敗：'+u.error.message; return; }
      msg.textContent=email+' '+info; loadProfiles();
    });

    const drop = $('#drop'); const picker = $('#picker'); const mp4Input=$('#mp4File'); const chosen=$('#chosen');
    const bar = $('#bar'); const btnUpload = $('#btnUpload'); const upMsg = $('#upMsg'); const zipLink = $('#zipLink');

    drop.addEventListener('dragover',function(e){ e.preventDefault(); drop.classList.add('drag'); });
    drop.addEventListener('dragleave',function(){ drop.classList.remove('drag'); });
    drop.addEventListener('drop',function(e){
      e.preventDefault(); drop.classList.remove('drag');
      const f = e.dataTransfer.files && e.dataTransfer.files[0]; if(f){ mp4Input.files = e.dataTransfer.files; reflectChoose(); }
    });
    picker.addEventListener('click',function(){ mp4Input.click(); });
    mp4Input.addEventListener('change',reflectChoose);
    function reflectChoose(){
      const f=mp4Input.files && mp4Input.files[0];
      if(!f){ chosen.textContent='尚未選檔'; return; }
      chosen.textContent = f.name+' · '+(f.size/1024/1024).toFixed(2)+' MB';
      const slug = ($('#slug').value||'').trim();
      if(!slug){
        const base = f.name.replace(/\.mp4$/i,'').replace(/\s+/g,'-').toLowerCase();
        $('#slug').value = base.slice(0,80);
      }
    }
    function setBar(p){ bar.style.width = Math.max(3, Math.min(100, p)) + '%'; }
    async function getVideoDuration(file){
      return new Promise(function(resolve){
        const v=document.createElement('video'); v.preload='metadata';
        v.onloadedmetadata=function(){ resolve(Math.round(v.duration||0)); URL.revokeObjectURL(v.src); };
        v.onerror=function(){ resolve(0); }; v.src=URL.createObjectURL(file);
      });
    }
    async function ensureFolder(bucket, pathLike){
      try{ await supa.storage.from(bucket).list(pathLike); return true; }catch(e){ return true; }
    }

    function pad2(n){ return n.toString().padStart(2,'0'); }
    function pick(arr, n){
      const a=arr.slice(); const out=[];
      while(out.length<n && a.length){ out.push(a.splice(Math.floor(Math.random()*a.length),1)[0]); }
      return out;
    }
    const BANK = {
      commonVocab: [{"word":"festival","pos":"n.","zh":"節日","en":"a special day of celebration","example":"This festival brings families together."},{"word":"moon","pos":"n.","zh":"月亮","en":"Earth's natural satellite","example":"We admire the full moon."},{"word":"gather","pos":"v.","zh":"聚集","en":"come together","example":"Families gather for dinner."},{"word":"mooncake","pos":"n.","zh":"月餅","en":"round pastry for Mid-Autumn","example":"They share mooncakes."},{"word":"lantern","pos":"n.","zh":"燈籠","en":"a light in a cover","example":"Kids carry lanterns."},{"word":"legend","pos":"n.","zh":"傳說","en":"traditional story","example":"There is a legend about the moon."},{"word":"archer","pos":"n.","zh":"弓箭手","en":"a person skilled with a bow","example":"He was a brave archer."},{"word":"elixir","pos":"n.","zh":"仙丹","en":"magical drink","example":"The elixir grants immortality."},{"word":"immortal","pos":"adj.","zh":"不死的","en":"living forever","example":"She became immortal."},{"word":"reunion","pos":"n.","zh":"團圓","en":"coming together again","example":"The festival is for reunion."},{"word":"admire","pos":"v.","zh":"欣賞","en":"look at with pleasure","example":"They admire the bright moon."},{"word":"harvest","pos":"n.","zh":"收穫","en":"gathering crops","example":"People thank for the harvest."},{"word":"tradition","pos":"n.","zh":"傳統","en":"custom passed down","example":"Sharing mooncakes is a tradition."},{"word":"celebrate","pos":"v.","zh":"慶祝","en":"do something special","example":"People celebrate together."},{"word":"rabbit","pos":"n.","zh":"兔子","en":"small animal","example":"A rabbit appears in the legend."},{"word":"blessing","pos":"n.","zh":"祝福","en":"good wishes","example":"They ask for blessings."},{"word":"tea","pos":"n.","zh":"茶","en":"a popular drink","example":"People drink tea at night."},{"word":"poem","pos":"n.","zh":"詩","en":"a piece of writing","example":"They read poems about the moon."},{"word":"clear","pos":"adj.","zh":"晴朗的","en":"without clouds","example":"We hope for a clear sky."},{"word":"family","pos":"n.","zh":"家庭","en":"parents and children","example":"Family time matters."}],
      mcDistractors:["sun","star","cloud","tree","river","noodles","cheese","pepper","books","games","rainy","windy"]
    };
    function buildCues(durationSec){
      const total = 20; const span = Math.max(2, Math.floor((durationSec||120)/total));
      const cues=[]; var t=0;
      for(var i=0;i<total;i++){ var s=t, e=s+span; cues.push({ "s": s, "e": e, "t": "第 "+pad2(i+1)+" 句（請編輯）" }); t=e; }
      return cues;
    }
    function buildVocab(){
      const words=BANK.commonVocab.slice(); return pick(words,20).map(function(x){
        return { "word": x.word, "pos": x.pos, "zh": x.zh, "en": x.en, "sample": x.example || x.en };
      });
    }
    function makeMCQ(q, correct, wrongs){
      const ch=pick(wrongs,3); ch.push(correct);
      for(let i=ch.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); const tmp=ch[i]; ch[i]=ch[j]; ch[j]=tmp; }
      return {"type":"mc", "q":q, "choices":ch, "answer": ch.indexOf(correct)};
    }
    function buildQuizFromVocab(vocab, title){
      const wrongs=BANK.mcDistractors.slice(), quiz=[];
      for(let i=0;i<20;i++){ const v=vocab[i%vocab.length]; quiz.push(makeMCQ('What is the meaning of "'+v.word+'"?', v.zh, wrongs)); }
      const grammar=[
        makeMCQ("Lanterns ____ by children at night.","are carried",["carry","are carrying","carried"]),
        makeMCQ("People ____ mooncakes every year.","eat",["ate","are eaten","is eating"]),
        makeMCQ("This is the night ____ families meet.","when",["who","which","where"]),
        makeMCQ("He suggested that we ____ tea.","drink",["drank","to drink","drinking"]),
        makeMCQ("People enjoy ____ poems.","reading",["read","to read","reads"]),
      ]; while(grammar.length<20){ grammar.push(makeMCQ("The moon is very ____ tonight.","bright",["broken","tiny","thin"])); }
      Array.prototype.push.apply(quiz, grammar.slice(0,20));
      const reading=[
        makeMCQ('Why do families meet in "'+(title||'the story')+'"?',"For reunion",["For business","For exercise","For study"]),
        makeMCQ("They choose a park with a clear view. What do they want to see?","The full moon",["Sunrise","Fireworks","TV show"]),
        makeMCQ("Kids carry lanterns and guess riddles. What does this show?","They enjoy traditions",["They are bored","They hate the dark","They are studying"]),
      ]; while(reading.length<20){ reading.push(makeMCQ("People share tea and fruit. The mood is ____.","warm",["cold","tense","lonely"])); }
      Array.prototype.push.apply(quiz, reading.slice(0,20));
      const mixed=[
        makeMCQ("Which is NOT related to Mid-Autumn?","Christmas tree",["Mooncakes","Lanterns","Jade Rabbit"]),
        makeMCQ("Choose the collocation: admire the ____ moon.","full",["thin","broken","small"]),
        makeMCQ("The festival follows the ____ calendar.","lunar",["solar","school","work"]),
      ]; while(mixed.length<20){ mixed.push(makeMCQ("A polite gift is a box of ____.","mooncakes",["books","spoons","noodles"])); }
      Array.prototype.push.apply(quiz, mixed.slice(0,20)); return quiz;
    }
    async function fetchAudioBuffer(url){
      const ctx = new (window.AudioContext||window.webkitAudioContext)({sampleRate:44100});
      const r = await fetch(url, {mode:'cors'}); const b = await r.arrayBuffer();
      return await ctx.decodeAudioData(b);
    }
    function energyEnvelope(buf, frameSize, hop){
      frameSize = frameSize||1024; hop = hop||256;
      const ch = buf.getChannelData(0);
      const frames = Math.max(0, Math.floor((ch.length - frameSize) / hop));
      const env = new Float32Array(frames);
      for(let i=0;i<frames;i++){
        let sum=0; for(let j=0;j<frameSize;j++){ const v = ch[i*hop+j]; sum += v*v; }
        env[i]=Math.sqrt(sum/frameSize);
      } return {"env": env, "tStep": hop / buf.sampleRate};
    }
    function detectSilences(env, tStep, thresh, minSil){
      thresh = (typeof thresh==='number')?thresh:0.008;
      minSil = (typeof minSil==='number')?minSil:0.25;
      const minFrames = Math.max(1, Math.floor(minSil / tStep)); const segs=[]; let run=-1;
      for(let i=0;i<env.length;i++){
        if(env[i]<thresh){ if(run<0) run=i; }
        else if(run>=0){ const len=i-run; if(len>=minFrames) segs.push({"s":run*tStep,"e":i*tStep}); run=-1; }
      }
      if(run>=0){ const i=env.length; const len=i-run; if(len>=minFrames) segs.push({"s":run*tStep,"e":i*tStep}); }
      return segs;
    }
    function snapToSilence(cues, silences, win){
      win = (typeof win==='number')?win:1.5;
      function nearStart(t){ let best=null,d=Infinity; for(const s of silences){ const dd=Math.abs(t-s.s); if(dd<d && dd<=win){ d=dd; best=s; } } return best; }
      function nearEnd(t){ let best=null,d=Infinity; for(const s of silences){ const dd=Math.abs(t-s.e); if(dd<d && dd<=win){ d=dd; best=s; } } return best; }
      const out=cues.map(function(c){ return {"s":c.s,"e":c.e,"t":c.t}; });
      for(const c of out){ const sSil=nearEnd(c.s); const eSil=nearStart(c.e); if(sSil) c.s=Math.max(0,sSil.e); if(eSil) c.e=Math.max(c.s+0.05,eSil.s); }
      for(let i=1;i<out.length;i++){ if(out[i].s<out[i-1].e) out[i].s=out[i-1].e; if(out[i].e<=out[i].s) out[i].e=out[i].s+0.05; }
      return out;
    }

    
async function makeZipJson(opts){
  const {category, slug, title, publicVideoUrl, publicCoverUrl, durationSec} = opts;

  // 1) Decide cues source
  let segs = buildSegments(durationSec||0);
  let cuesML = __buildCuesFromLines(durationSec||0); // may be null if EN not provided
  if(cuesML){
    // apply auto align to s/e if enabled
    try{
      const auto = document.getElementById('autoAlign');
      if (auto && auto.checked && typeof fetchAudioBuffer === 'function'){
        const th  = parseFloat(document.getElementById('th')?.value||'0.008');
        const sil = parseFloat(document.getElementById('sil')?.value||'0.25');
        const win = parseFloat(document.getElementById('win')?.value||'1.5');
        const buf = await fetchAudioBuffer(publicVideoUrl);
        const o   = energyEnvelope(buf);
        const sils= detectSilences(o.env, o.tStep, th, sil);
        const snapped = snapToSilence(cuesML.map(c=>({s:c.s,e:c.e,t:''})), sils, win);
        // merge snapped times back
        cuesML = cuesML.map((c,i)=>({ s:snapped[i].s, e:snapped[i].e, en:c.en, zh:c.zh, ja:c.ja }));
      }
    }catch(e){ console.warn('Auto align (ML) failed', e); }
  }else{
    // fallback to uniform segments
    try{
      const auto = document.getElementById('autoAlign');
      if (auto && auto.checked && typeof fetchAudioBuffer === 'function'){
        const th  = parseFloat(document.getElementById('th')?.value||'0.008');
        const sil = parseFloat(document.getElementById('sil')?.value||'0.25');
        const win = parseFloat(document.getElementById('win')?.value||'1.5');
        const buf = await fetchAudioBuffer(publicVideoUrl);
        const o   = energyEnvelope(buf);
        const sils= detectSilences(o.env, o.tStep, th, sil);
        segs      = snapToSilence(segs, sils, win);
      }
    }catch(e){ console.warn('Auto align (uniform) failed', e); }
  }

  // 2) Build JSON docs depending on mode
  const zip = new JSZip();
  const minify = (document.getElementById('minifyJson')?.checked)!==false; /*__MINIFY_PATCH__*/
  const dir = zip.folder(`data/${category}/${slug}`);

  const indexJson = {
    title: title || slug,
    category, slug,
    video: publicVideoUrl,
    cover: publicCoverUrl || null,
    is_public: true
  };

  if(cuesML){
    // Multi-language cues path (admin(1) style)
    const cuesDoc = { schema: 'bw-cues@1.1', cues: cuesML.map(c=>({ time: {s: c.s, e: c.e}, en: c.en, zh: c.zh, ja: c.ja })) };
    indexJson.cues = { zh: `./cues-${slug}.json`, ja: `./cues-${slug}.json` };
    const vocabML = __parseVocab();
    const vocabDoc = { schema: 'bw-vocab@1.1', words: (vocabML||[])};
    indexJson.vocab = `./vocab-${slug}.json`;
    // Simple quiz (admin(1) style) from vocab
    function buildQuizSimple(vocab,need){ if(!vocab||!vocab.length) return []; const pool=vocab.slice(); while(pool.length<need) pool.push(...vocab); const out=[]; for(let i=0;i<need;i++){ const v=pool[i%pool.length]; const distract=[]; for(let j=i+1;j<i+4;j++){ const w=pool[j%pool.length]; distract.push(w.zh||w.word); } const choices=[v.zh||v.word,...distract].slice(0,4).sort(()=>Math.random()-0.5); out.push({type:'mc',q:`What is the meaning of "${v.word}"?`,choices,answer:choices.indexOf(v.zh||v.word)});} return out; }
    const quiz = buildQuizSimple(vocabML||[],80);
    indexJson.quiz = `./quiz-${slug}.json`;
    const ai = { schema:'bw-ai@1.0', topics: Array.from({length:15},(_,i)=>({title:`Topic ${i+1}`,prompt:['Describe the festival.','What will you do this year?','Share a memory about the moon.','Tell us your favorite food for this festival.','How do people celebrate in your hometown?'][i%5],hint:'',sample:''})) };
    indexJson.ai = `./ai-${slug}.json`;

    dir.file(`index-${slug}.json`, JSON.stringify(indexJson));
    dir.file(`cues-${slug}.json`,  JSON.stringify(cuesDoc));
    dir.file(`vocab-${slug}.json`, JSON.stringify(vocabDoc));
    dir.file(`quiz-${slug}.json`,  JSON.stringify(quiz));
    dir.file(`ai-${slug}.json`,    JSON.stringify(ai));
  }else{
    // Houyi fallback (existing admin.html behavior)
    const cuesHouyi = segmentsToHouyiCues(segs);
    const vocabHouyi = buildVocabHouyi();
    const quizHouyi  = buildQuizHouyiFromVocab(vocabHouyi, title);
    const aiHouyi    = buildAIHouyi(title);

    indexJson.cues = { zh: `./cues-${slug}.json` };
    indexJson.vocab = `./vocab-${slug}.json`;
    indexJson.quiz  = `./quiz-${slug}.json`;
    indexJson.ai    = `./ai-${slug}.json`;

    dir.file(`index-${slug}.json`, JSON.stringify(indexJson));
    dir.file(`cues-${slug}.json`,  JSON.stringify(cuesHouyi));
    dir.file(`vocab-${slug}.json`, JSON.stringify(vocabHouyi));
    dir.file(`quiz-${slug}.json`,  JSON.stringify(quizHouyi));
    dir.file(`ai-${slug}.json`,    JSON.stringify(aiHouyi));
  }

  const blob = await zip.generateAsync({type:"blob"});
  const url  = URL.createObjectURL(blob);
  window.__lastZipUrl = url;
  return url;
}
window.makeZipJson = makeZipJson;

// ---- Safe DOM helpers ----
function getEl(id){ return document.getElementById(id); }
function getVal(id, dft=''){ var el=getEl(id); return (el && typeof el.value!=='undefined')? String(el.value).trim() : dft; }
function getFile(id){ var el=getEl(id); return (el && el.files && el.files[0])? el.files[0] : null; }
function safeShow(el){ if(el){ el.style.display='inline-flex'; } }

// Fallback: uniform segmentation into ~20 parts if original buildSegments is missing
function buildSegments(durationSec){
  try{
    // If already defined elsewhere, reuse it
    if (typeof window.buildSegments === 'function') return window.buildSegments(durationSec);
  }catch(e){}
  var total = 20;
  var span  = Math.max(2, Math.floor((durationSec||120)/total));
  var segs  = []; var t=0;
  for(var i=0;i<total;i++){ var s=t, e=s+span; segs.push({s:s, e:e, t:''}); t=e; }
  return segs;
}


// --- Wire upload & then enable ZIP link ---
btnUpload.addEventListener('click', async function(){
  try{
    zipLink.style.display='none'; zipLink.removeAttribute('href');
    const f = getFile('mp4File');
    const cov = getFile('coverFile');
    const category = getVal('category');
    const slug = getVal('slug');
    const title = getVal('title', slug||'');
    const coverName = getVal('cover','cover.jpg');
    if(!slug){ alert('請先填 slug'); return; }
    if(!f){ if(!confirm('未選 MP4，仍要繼續？（將只產生 JSON ZIP）')) return; }

    btnUpload.disabled = true; upMsg.textContent='準備中…'; setBar(8);

    // optional upload to supabase
    let publicVideoUrl = '', publicCoverUrl = '';
    try{
      if(supa){
        if(f){
          await ensureFolder('videos', category);
          const { error: e1 } = await supa.storage.from('videos').upload(`${category}/${slug}.mp4`, f, { upsert:true, contentType:'video/mp4' });
          if(e1) throw e1;
          const { data: pv } = supa.storage.from('videos').getPublicUrl(`${category}/${slug}.mp4`);
          publicVideoUrl = pv.publicUrl || '';
        }
        if(cov){
          await ensureFolder('assets', `${category}/${slug}`);
          const { error: e2 } = await supa.storage.from('assets').upload(`${category}/${slug}/${coverName}`, cov, { upsert:true, contentType: cov.type||'image/jpeg' });
          if(e2) throw e2;
          const { data: pc } = supa.storage.from('assets').getPublicUrl(`${category}/${slug}/${coverName}`);
          publicCoverUrl = pc.publicUrl || '';
        }
      }
    }catch(e){
      console.warn('Supabase 上傳失敗或未設定，改為僅產生 ZIP', e);
      upMsg.textContent='未設定或上傳失敗：僅產生 ZIP'; 
    }

    // duration (if file present)
    let durationSec = 0;
    try{ if(f){ durationSec = await getVideoDuration(f); } }catch(e){}

    setBar(55); upMsg.textContent='準備 ZIP 下載連結…';
    const url = await makeZipJson({ category, slug, title, publicVideoUrl, publicCoverUrl, durationSec });
    setBar(100); upMsg.textContent='完成，可下載 JSON ZIP';
    if(zipLink){ zipLink.href = url; safeShow(zipLink); }
  }catch(e){
    console.error(e); alert('流程失敗：'+(e.message||e));
    upMsg.textContent='失敗'; setBar(3);
  }finally{
    btnUpload.disabled = false;
  }
});


// 獨立按鈕：只用多語欄位產生 ZIP（不上傳）
(function(){
  const btn = document.getElementById('btnMakeMultilang');
  const zipLink = document.getElementById('zipLink');
  const upMsg = document.getElementById('upMsg');
  if(!btn) return;
  btn.addEventListener('click', async function(){
    try{
      if(upMsg) upMsg.textContent='產生中…';
      const category = (document.getElementById('category')||{}).value || '';
      const slug = (document.getElementById('slug')||{}).value || '';
      const title = (document.getElementById('title')||{}).value || slug;
      // 估計時長：每行 EN 8 秒，最低 60 秒
      const enLines = (document.getElementById('ml-en')?.value||'').split('\n').filter(s=>s.trim()).length;
      const durationSec = Math.max(60, (enLines||8)*8);
      const url = await makeZipJson({category, slug, title, durationSec});
      zipLink.href = url; zipLink.style.pointerEvents='auto'; zipLink.style.opacity='1';
      if(upMsg) upMsg.textContent='完成，可下載 ZIP';
    }catch(e){
      alert('多語產生失敗：'+(e.message||e)); if(upMsg) upMsg.textContent='失敗';
    }
  });
})();
</script>

<!-- END: BookWide ZIP generator -->
</body>
</html>
























































































































































































































































































































































