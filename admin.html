<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>BookWide Admin · 簡版（上傳 Supabase + 產生 JSON + 預覽/下載）</title>
<style>
  :root{--b:#111;--m:#6b7280;--a:#2563eb;--bd:#e5e7eb;--bg:#fff}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,'Noto Sans TC',sans-serif;background:var(--bg);color:var(--b);margin:0}
  .wrap{max-width:980px;margin:24px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 10px}
  section{border:1px solid var(--bd);border-radius:14px;padding:14px;margin:12px 0}
  label{display:block;margin:6px 0 4px;font-size:12px}
  input,select,textarea{width:100%;padding:10px;border:1px solid var(--bd);border-radius:10px;font-size:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .col{flex:1 1 240px}
  .btn{appearance:none;border:0;border-radius:999px;background:var(--a);color:#fff;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid var(--bd);color:var(--b)}
  .btn[disabled]{opacity:.45;cursor:not-allowed}
  .help{font-size:12px;color:var(--m)}
  pre{background:#0a0a0a;color:#f3f3f3;border-radius:12px;padding:10px;overflow:auto;max-height:360px}
  .tabs{display:flex;gap:8px;margin:8px 0}
  .tab{border:1px solid var(--bd);border-radius:10px;padding:6px 10px;cursor:pointer;background:#fafafa}
  .tab.active{background:#111;color:#fff;border-color:#111}
</style>

<div class="wrap">
  <h1>BookWide Admin · 簡版</h1>

  <!-- ① 上傳到 Supabase -->
  <section>
    <div class="row">
      <div class="col">
        <label>分類 category</label>
        <select id="category">
          <option value="story">story</option>
          <option value="music" selected>music</option>
          <option value="movie">movie</option>
          <option value="news">news</option>
          <option value="pro">pro</option>
        </select>
      </div>
      <div class="col">
        <label>Slug（小寫英數-/_）</label>
        <input id="slug" placeholder="alittlelove">
      </div>
      <div class="col">
        <label>顯示標題（可空）</label>
        <input id="title" placeholder="A Little Love">
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col">
        <label>MP4</label>
        <input id="mp4" type="file" accept="video/mp4">
      </div>
      <div class="col">
        <label>封面 cover.jpg（可空）</label>
        <input id="cover" type="file" accept="image/*">
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnUpload" class="btn">① 上傳到 Supabase</button>
      <span class="help">需全域 <code>window.supabase</code> 已初始化。路徑：videos/{category}/{slug}.mp4、assets/{category}/{slug}/cover.jpg</span>
    </div>
    <div id="upLog" class="help"></div>
  </section>

  <!-- ② 產生 JSON（不上傳） -->
  <section>
    <div class="row">
      <button id="btnGenerate" class="btn">② 產生 JSON（不上傳）</button>
      <button id="btnUploadGitHub" class="btn ghost" disabled>（預留）送到 GitHub</button>
      <span class="help">產出：index / cues / vocab / quiz / ai（符合你現在 player 的 Houyi 格式）。</span>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col">
        <label>EN 字幕（每行一句）</label>
        <textarea id="enLines" placeholder="Each line an English sentence."></textarea>
      </div>
      <div class="col">
        <label>ZH 字幕（對齊 EN；可空）</label>
        <textarea id="zhLines" placeholder="對齊 EN 的中文（可空）"></textarea>
      </div>
      <div class="col">
        <label>JA 字幕（對齊 EN；可空）</label>
        <textarea id="jaLines" placeholder="対訳の日本語（空でも可）"></textarea>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label>Vocab（每行：word | pos | zh | ja）</label>
        <textarea id="vocabLines" placeholder="festival | n. | 節慶 | 祭り"></textarea>
      </div>
    </div>
  </section>

  <!-- ③ 預覽 & 下載 -->
  <section>
    <div class="row">
      <button id="btnZip" class="btn">③ 下載 JSON ZIP</button>
      <span class="help">檢查預覽 → 下載 → 你手動上傳到 GitHub。</span>
    </div>
    <div class="tabs">
      <div class="tab active" data-k="index">index</div>
      <div class="tab" data-k="cues">cues</div>
      <div class="tab" data-k="vocab">vocab</div>
      <div class="tab" data-k="quiz">quiz</div>
      <div class="tab" data-k="ai">ai</div>
    </div>
    <pre id="preview"></pre>
  </section>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<script>
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));

// —— 小工具 ——
const lines=(t)=>t.split(/\\r?\\n/).map(s=>s.trim()).filter(Boolean);

// 產出資料（依你現有 Houyi 格式）
function buildIndex({title, category, slug, videoUrl, coverUrl}){
  return {
    title: title||slug,
    category: category||'',
    slug,
    video: videoUrl||'',
    cover: coverUrl||'',
    cues: { zh: `./cues-${slug}.json` },   // 檔內含 en/zh/ja 三語，player 仍指 zh 路徑
    vocab: `./vocab-${slug}.json`,
    quiz: `./quiz-${slug}.json`,
    ai: `./ai-${slug}.json`,
    is_public: true
  };
}
function buildCues(en, zh, ja){
  const cues=[]; const n=en.length;
  for(let i=0;i<n;i++){ cues.push({ time:{s:i*4, e:(i+1)*4}, en:en[i]||"", zh:zh[i]||"", ja:ja[i]||"" }); }
  return { schema:"bw-cues@1.1", cues };
}
function buildVocab(vlines){
  const words=[];
  for(const raw of vlines){
    const p=raw.split('|').map(s=>s.trim());
    if(p.length>=1){
      words.push({ time:"", word:p[0]||"", pos:p[1]||"", zh:p[2]||"", ja:p[3]||"" });
    }
  }
  return { schema:"bw-vocab@1.1", words };
}
function buildQuiz(){ return []; } // 預留
function buildAI(){ 
  return { schema:"bw-ai@1.0", topics:[
    {title:"Topic 1",prompt:"Describe the video.",hint:"",sample:""},
    {title:"Topic 2",prompt:"Summarize the story.",hint:"",sample:""},
    {title:"Topic 3",prompt:"List 3 new words.",hint:"",sample:""},
    {title:"Topic 4",prompt:"Share your opinion.",hint:"",sample:""},
    {title:"Topic 5",prompt:"What happens next?",hint:"",sample:""}
  ]};
}

// 狀態
const S={ json:{index:null,cues:null,vocab:null,quiz:null,ai:null} };

function show(which="index"){
  const obj=S.json[which]||{};
  $("#preview").textContent=JSON.stringify(obj, null, 2);
  $$(".tab").forEach(t=>t.classList.toggle("active", t.dataset.k===which));
}
$$(".tab").forEach(t=>t.addEventListener("click", ()=>show(t.dataset.k)));

// ① 上傳到 Supabase
$("#btnUpload").addEventListener("click", async ()=>{
  const slug=$("#slug").value.trim(); const cat=$("#category").value.trim();
  if(!slug){ alert("請填 slug"); return; }
  const mp4=$("#mp4").files[0]; const cover=$("#cover").files[0];
  if(!window.supabase){ $("#upLog").textContent="未偵測到 Supabase；略過實際上傳。"; }
  else{
    const cli=window.supabase;
    const up=async(path,file)=>{
      const {error}=await cli.storage.from("public").upload(path,file,{upsert:true,cacheControl:"3600"});
      if(error) throw error;
      const {data}=cli.storage.from("public").getPublicUrl(path); return data.publicUrl;
    };
    try{
      let vurl="", curl="";
      if(mp4) vurl=await up(`videos/${cat}/${slug}.mp4`, mp4);
      if(cover) curl=await up(`assets/${cat}/${slug}/cover.jpg`, cover);
      $("#upLog").textContent=`已上傳：video=${vurl?"OK":"略過"}，cover=${curl?"OK":"略過"}`;
    }catch(e){ console.error(e); alert("上傳失敗："+e.message); }
  }
  // 先放一份 index（沒有網址也可先產生）
  S.json.index=buildIndex({title:$("#title").value.trim(),category:cat,slug,videoUrl:"",coverUrl:""});
  show("index");
});

// ② 產生 JSON（不上傳）
$("#btnGenerate").addEventListener("click", ()=>{
  const slug=$("#slug").value.trim();
  if(!slug){ alert("請填 slug"); return; }
  const en=lines($("#enLines").value);
  if(en.length===0){ alert("請輸入 EN 至少一行"); return; }
  const zh=lines($("#zhLines").value);
  const ja=lines($("#jaLines").value);
  const voc=lines($("#vocabLines").value);

  S.json.cues=buildCues(en, zh, ja);      // 時間先均分（每句 4 秒）
  S.json.vocab=buildVocab(voc);
  S.json.quiz=buildQuiz();
  S.json.ai=buildAI();
  if(!S.json.index){
    S.json.index=buildIndex({title:$("#title").value.trim(),category:$("#category").value.trim(),slug,videoUrl:"",coverUrl:""});
  }
  show("cues");
});

// ③ 下載 ZIP
$("#btnZip").addEventListener("click", async ()=>{
  const slug=$("#slug").value.trim();
  if(!slug){ alert("請填 slug"); return; }
  const need=["index","cues","vocab","quiz","ai"];
  for(const k of need){ if(!S.json[k]){ alert(`缺少 ${k} JSON，請先按 ②`); return; } }
  const zip=new JSZip();
  zip.file(`index-${slug}.json`, JSON.stringify(S.json.index, null, 2));
  zip.file(`cues-${slug}.json`, JSON.stringify(S.json.cues, null, 2));
  zip.file(`vocab-${slug}.json`, JSON.stringify(S.json.vocab, null, 2));
  zip.file(`quiz-${slug}.json`, JSON.stringify(S.json.quiz, null, 2));
  zip.file(`ai-${slug}.json`, JSON.stringify(S.json.ai, null, 2));
  const blob=await zip.generateAsync({type:"blob"});
  saveAs(blob, `${slug}-json.zip`);
});

// 初始預覽
show("index");
</script>

























