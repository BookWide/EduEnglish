
<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>BookWide Admin 上傳修正版 v20251104</title>
</head>
<body style="font-family:Arial, sans-serif; padding:20px;">
<h2>BookWide Admin 上傳修正版 v20251104</h2>
<p>此版本修正 Supabase Storage <strong>new row violates row-level security policy</strong> 問題。</p>
<p>✅ 自動帶入 Authorization + apikey，通過 RLS 驗證。</p>
<hr>
<pre style="background:#f8f8f8; padding:10px; border:1px solid #ccc;">
&lt;script&gt;
async function uploadToBucket({ bucket, path, file, contentType }) {
  const { data: sess } = await supabase.auth.getSession();
  const token = sess?.session?.access_token;
  if (!token) throw new Error('尚未登入');

  const uploadUrl = `${SUPABASE_URL}/storage/v1/object/${bucket}/${path}`;
  const res = await fetch(uploadUrl, {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${token}`,
      apikey: SUPABASE_ANON_KEY,
      'x-upsert': 'false',
      'Content-Type': contentType || file.type
    },
    body: file
  });
  if (!res.ok) throw new Error('上傳失敗: ' + res.statusText);
  return await res.json();
}

async function handleUploadAndInsert() {
  const category = document.querySelector('#category').value.trim();
  const slug = document.querySelector('#slug').value.trim();
  const mp4File = document.querySelector('#mp4File').files[0];
  const coverFile = document.querySelector('#coverFile')?.files?.[0];
  if (!category || !slug || !mp4File) return alert('請輸入完整資料');

  try {
    await uploadToBucket({
      bucket: 'videos',
      path: `${category}/${slug}.mp4`,
      file: mp4File,
      contentType: 'video/mp4'
    });

    if (coverFile) {
      await uploadToBucket({
        bucket: 'assets',
        path: `${category}/${slug}/cover.jpg`,
        file: coverFile,
        contentType: 'image/jpeg'
      });
    }

    const { error } = await supabase.from('videos').insert({
      category, slug,
      storage_path: `videos/${category}/${slug}.mp4`,
      cover_path: coverFile ? `assets/${category}/${slug}/cover.jpg` : null,
      is_public: true
    });
    if (error) throw error;
    alert('✅ 上傳成功並已寫入資料表');
  } catch (err) {
    alert('錯誤: ' + err.message);
  }
}
&lt;/script&gt;
</pre>
</body>
</html>

