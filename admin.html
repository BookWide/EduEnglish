<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin · 三分頁 · v20251106-three-tabs-v3</title>
  <script type="module" src="./supa.js"></script>
  <!-- 修正 UMD 連結空白 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <style>
    :root{ --bg:#fff; --fg:#111; --muted:#6b7280; --line:#e5e7eb; --brand:#2563eb; --ok:#16a34a; --warn:#f59e0b; --card:#fafafa;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"PingFang TC","Noto Sans TC","微軟正黑體",sans-serif}
    header{padding:18px 20px;border-bottom:1px solid var(--line);display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .title{font-size:22px;font-weight:700;margin-right:auto}
    .chip{padding:.35rem .6rem;border-radius:999px;background:#eef2ff;color:#1d4ed8;font-size:12px}
    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab-btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:.5rem 1rem;cursor:pointer}
    .tab-btn.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    .wrap{max-width:1100px;margin:22px auto;padding:0 16px}
    .row{display:grid;gap:14px}
    .grid-2{grid-template-columns: 1fr 1fr}
    @media (max-width:1100px){ .grid-2{grid-template-columns:1fr} }
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px}
    .input, select, textarea{border:1px solid var(--line);border-radius:10px;padding:.6rem .8rem;background:#fff}
    textarea{height:240px;resize:vertical;white-space:pre-wrap;overflow:auto}
    .btn{border:1px solid var(--brand);background:var(--brand);color:#fff;border-radius:10px;padding:.55rem .9rem;cursor:pointer}
    .btn.outline{background:#fff;color:var(--brand)}
    .hint{color:#6b7280;font-size:13px}
    .progress{height:10px;background:#eef2ff;border-radius:99px;overflow:hidden}
    .bar{height:100%;width:0;background:#2563eb;transition:width .2s}
    .pill{display:inline-block;padding:.2rem .5rem;border-radius:999px;border:1px solid var(--line);font-size:12px}
    .pill.ok{color:#16a34a;border-color:#16a34a} .pill.warn{color:#f59e0b;border-color:#f59e0b}
    /* Accordion */
    .acc{border:1px solid var(--line);border-radius:12px;background:#f8fafc}
    .acc .hd{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;cursor:pointer;user-select:none}
    .acc .hd h4{margin:0;font-size:14px}
    .acc .bd{padding:12px;display:block}
    .acc.collapsed .bd{display:none}
    .chev{width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:7px solid #6b7280;transition:transform .2s}
    .acc.collapsed .chev{transform:rotate(-90deg)}
    .stack{display:grid;gap:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0 12px}
    .table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
    .table th,.table td{padding:.7rem .8rem;border-bottom:1px solid var(--line);text-align:left}
    .table th{background:var(--card);font-weight:600}
    .right{display:flex;gap:10px;align-items:center;justify-content:flex-end}
  </style>
</head>
<body>
  <header>
    <div class="title">BookWide Admin 主控台</div>
    <span class="chip">三分頁 · 內嵌 Supabase · v20251106</span>
    <nav class="tabs">
      <button class="tab-btn active" data-tab="users">使用者清單</button>
      <button class="tab-btn" data-tab="roles">授權 / 暫停管理員</button>
      <button class="tab-btn" data-tab="mp4">MP4 上傳</button>
    </nav>
  </header>

  <main class="wrap">
    <!-- 使用者清單 -->
    <section id="panel-users">
      <div class="toolbar">
        <input id="q" class="input" style="min-width:260px" placeholder="搜尋 Email / 顯示名稱…" />
        <button id="btnRefresh" class="btn outline">重新整理</button>
        <span class="hint">資料表：public.profiles · 台灣時區顯示 · 10 分鐘內視為「在線」。</span>
      </div>
      <table class="table" id="usersTable">
        <thead><tr><th>Email</th><th>顯示名稱</th><th>最後登入</th><th>最近在線</th><th>管理員</th><th>狀態</th><th>到期日</th></tr></thead>
        <tbody><tr><td colspan="7" class="hint">載入中…</td></tr></tbody>
      </table>
    </section>

    <!-- 權限管理 -->
    <section id="panel-roles" style="display:none">
      <div class="card">
        <div class="row grid-2">
          <div><label class="hint">Email</label><input id="roleEmail" class="input" placeholder="user@example.com"></div>
          <div>
            <label class="hint">動作</label>
            <select id="roleAction" class="input">
              <option value="grant-admin">授予管理員</option>
              <option value="revoke-admin">移除管理員</option>
              <option value="pause">暫停登入</option>
              <option value="unpause">解除暫停</option>
            </select>
          </div>
        </div>
        <div class="right" style="margin-top:10px"><button id="btnApplyRole" class="btn">套用</button></div>
        <div class="hint" style="margin-top:6px">更新欄位：<code>is_admin</code> / <code>is_paused</code></div>
        <div id="roleMsg" class="hint" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- MP4 上傳 -->
    <section id="panel-mp4" style="display:none">
      <div class="row grid-2">
        <!-- 左：表單 + 預覽 -->
        <div class="card">
          <h3 style="margin:6px 0 14px">MP4 上傳自動化（含字幕匯入、JSON 預覽）</h3>

          <div class="row grid-2">
            <div>
              <label class="hint">分類</label>
              <select id="cat" class="input"><option>story</option><option selected>music</option><option>movie</option><option>news</option><option>pro</option></select>
            </div>
            <div><label class="hint">Slug</label><input id="slug" class="input" placeholder="applesong"></div>
          </div>

          <div class="row grid-2" style="margin-top:8px">
            <div><label class="hint">顯示標題（可空）</label><input id="title" class="input" placeholder="A Little Love"></div>
            <div><label class="hint">吸附窗（s）</label><input id="snapWin" class="input" type="number" step="0.05" value="0.25"></div>
          </div>

          <div class="row grid-2" style="margin-top:8px">
            <div><label class="hint">MP4 檔</label><input id="mp4File" type="file" accept="video/mp4" class="input"></div>
            <div><label class="hint">封面（建議 JPG）</label><input id="coverFile" type="file" accept="image/*" class="input"></div>
          </div>
          <div style="margin-top:8px"><label class="hint">字幕（.txt / .srt / .vtt / .json）</label><input id="subFile" type="file" accept=".txt,.srt,.vtt,.json" class="input" style="width:100%"></div>

          <div class="row grid-2" style="margin-top:10px">
            <div>
              <label class="hint">中/日 產生模式</label>
              <div style="display:flex;gap:12px;align-items:center;margin-top:6px">
                <label style="display:flex;gap:6px;align-items:center"><input id="modeSimple" type="radio" name="mtmode" checked> 簡易（只產生 en）</label>
                <label style="display:flex;gap:6px;align-items:center"><input id="modeMT" type="radio" name="mtmode"> 機翻（透過 Edge Function）</label>
              </div>
            </div>
            <div>
              <label class="hint">Edge Function 名稱（預設 mt-translate）</label>
              <input id="edgeFn" class="input" placeholder="mt-translate" value="mt-translate">
              <div class="hint" style="margin-top:6px">Functions 連線：<code id="fnBase">未偵測</code>　<button class="btn outline" id="btnTestFn" style="padding:.25rem .6rem">測試</button> <span id="fnMsg" class="hint"></span></div>
            </div>
          </div>

          <div class="right" style="margin-top:10px;gap:8px">
            <button class="btn outline" id="btnCollapseAll">全部收合</button>
            <button class="btn outline" id="btnExpandAll">全部展開</button>
            <button class="btn" id="btnPreview">預覽 JSON（5 件）</button>
          </div>

          <div class="stack" style="margin-top:10px">
            <div class="acc" id="accIndex">
              <div class="hd"><h4>index-<span id="fnSlug1">slug</span>.json（影片資訊）</h4><div class="chev"></div></div>
              <div class="bd"><textarea id="boxIndex" placeholder="index-<slug>.json 預覽"></textarea></div>
            </div>
            <div class="acc" id="accCues">
              <div class="hd"><h4>cues-<span id="fnSlug2">slug</span>.json（三語字幕）</h4><div class="chev"></div></div>
              <div class="bd"><textarea id="boxCues" placeholder="cues-*.json"></textarea></div>
            </div>
            <div class="acc" id="accQuiz">
              <div class="hd"><h4>quiz-<span id="fnSlug3">slug</span>.json（80 題）</h4><div class="chev"></div></div>
              <div class="bd"><textarea id="boxQuiz" placeholder="quiz-*.json"></textarea></div>
            </div>
            <div class="acc" id="accVocab">
              <div class="hd"><h4>vocab-<span id="fnSlug4">slug</span>.json（20 詞：英/中/日/定義/例句）</h4><div class="chev"></div></div>
              <div class="bd"><textarea id="boxVocab" placeholder="vocab-*.json"></textarea></div>
            </div>
            <div class="acc" id="accAI">
              <div class="hd"><h4>ai-<span id="fnSlug5">slug</span>.json（AI 問答模板 15 題）</h4><div class="chev"></div></div>
              <div class="bd"><textarea id="boxAI" placeholder="ai-*.json"></textarea></div>
            </div>
          </div>

          <div class="hint" style="margin-top:10px">字幕：.txt 視為「每行一句」；.srt/.vtt 會解析時間。三語同檔格式：<code>[{ time, en, ja, zh }]</code>。</div>
        </div>

        <!-- 右：Supabase / GitHub -->
        <div class="card">
          <h3 style="margin:6px 0 14px">Supabase 上傳（影片＋封面）</h3>
          <div class="row grid-2">
            <div><label class="hint">Supabase URL（可空）</label><input id="sbUrl" class="input" placeholder="https://xxxx.supabase.co"></div>
            <div><label class="hint">Supabase anon key（可空）</label><input id="sbKey" class="input" placeholder="ey..."></div>
          </div>
          <div class="row grid-2">
            <div><label class="hint">影片桶名</label><input id="bucketVideo" class="input" value="videos"></div>
            <div><label class="hint">封面桶名</label><input id="bucketAsset" class="input" value="assets"></div>
          </div>
          <div class="right" style="margin-top:6px"><button class="btn" id="btnSupaUpload">上傳到 Supabase（影片＋封面）</button></div>
          <pre id="supaStatus" class="hint" style="background:#0b10221a;padding:10px;border-radius:8px;margin-top:8px;white-space:pre-wrap"></pre>
          <div class="progress" style="margin-top:6px"><div id="supaBar2" class="bar"></div></div>
          <div id="supaPct2" class="hint" style="margin-top:4px">0%</div>

          <div style="margin:16px 0;height:1px;background:var(--line)"></div>

          <h3 style="margin:6px 0 10px">GitHub 上傳（5 件 JSON）</h3>
          <div class="row grid-2">
            <div><label class="hint">Owner</label><input id="ghOwner" class="input" value="bookwide"></div>
            <div><label class="hint">Repo</label><input id="ghRepo" class="input" value="EduEnglish"></div>
          </div>
          <div class="row grid-2">
            <div><label class="hint">Branch</label><input id="ghBranch" class="input" value="main"></div>
            <div><label class="hint">Base Path（例：data/）</label><input id="ghBase" class="input" value="data/"></div>
          </div>
          <div class="row grid-2">
            <div><label class="hint">Commit 訊息</label><input id="ghMsg" class="input" value="Add JSON templates"></div>
            <div><label class="hint">GitHub Token（Classic PAT）</label><input id="ghTok" class="input" placeholder="ghp_xxx"></div>
          </div>
          <div class="right" style="margin-top:6px"><button class="btn" id="btnUploadGithub">上傳到 GitHub（5 件）</button></div>
          <pre id="ghStatus" class="hint" style="background:#0b10221a;padding:10px;border-radius:8px;margin-top:8px;white-space:pre-wrap"></pre>
          <div class="progress" style="margin-top:6px"><div id="ghBar2" class="bar"></div></div>
          <div id="ghPct2" class="hint" style="margin-top:4px">0%</div>
        </div>
      </div>
    </section>
  </main>

  <footer style="padding:22px 20px;border-top:1px solid var(--line);text-align:center;color:#6b7280">BookWide Admin · v20251106-three-tabs-v3</footer>

  <!-- 主邏輯（已改：測試 payload、預覽用批次機翻、移除 translateBatch） -->
  <script type="module">
    const ready = () => new Promise(r=>{ if (window.BW && window.BW.supa) return r(); const t=setInterval(()=>{ if(window.BW && window.BW.supa){clearInterval(t); r();}},50)});
    await ready();
    await BW.requireAdmin();
    BW.startHeartbeat(2);

    const supa = BW.supa;
    const $ = (q,root=document)=>root.querySelector(q);
    const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));
    const fmtTW = ts => !ts?'':new Date(ts).toLocaleString('zh-TW',{timeZone:'Asia/Taipei',hour12:false});
    const pill = (ok,t,cls)=>{ t=(t!==undefined)?t:(ok?'在線':'離線'); cls=cls||(ok?'pill ok':'pill'); return '<span class="'+cls+'">'+t+'</span>'; };

    // Tabs
    $$('.tab-btn').forEach(b=>b.addEventListener('click',()=>{
      $$('.tab-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active');
      const t=b.getAttribute('data-tab');
      $('#panel-users').style.display = (t==='users')?'':'none';
      $('#panel-roles').style.display = (t==='roles')?'':'none';
      $('#panel-mp4').style.display   = (t==='mp4')  ?'':'none';
    }));

    // Users
    async function loadProfiles(){
      const tbody = $('#usersTable tbody'); tbody.innerHTML='<tr><td class="hint" colspan="7">載入中…</td></tr>';
      const cols='email, display_name, is_admin, is_paused, last_sign_in_at, last_seen_at, expires_at';
      const r=await supa.from('profiles').select(cols).order('email',{ascending:true});
      if(r.error){ tbody.innerHTML='<tr><td class="hint" colspan="7">讀取失敗：'+r.error.message+'</td></tr>'; return; }
      const q = ($('#q').value||'').trim().toLowerCase();
      const rows=(r.data||[]).filter(x=> !q || ( (x.email||'').toLowerCase().includes(q) || (x.display_name||'').toLowerCase().includes(q) ));
      if(!rows.length){ tbody.innerHTML='<tr><td class="hint" colspan="7">沒有符合的資料</td></tr>'; return; }
      tbody.innerHTML=rows.map(x=>{
        const online = BW.isOnlineWithin(x.last_seen_at, 10);
        const status = x.is_paused ? '<span class="pill warn">暫停</span>' : '<span class="pill ok">正常</span>';
        return '<tr>'
          + '<td>'+(x.email||'')+'</td>'
          + '<td>'+(x.display_name||'')+'</td>'
          + '<td>'+(fmtTW(x.last_sign_in_at)||'')+'</td>'
          + '<td>'+(fmtTW(x.last_seen_at)||'')+' &nbsp; '+pill(online)+'</td>'
          + '<td>'+(x.is_admin?'<span class="pill ok">是</span>':'<span class="pill">否</span>')+'</td>'
          + '<td>'+status+'</td>'
          + '<td>'+(x.expires_at||'')+'</td>'
          + '</tr>';
      }).join('');
    }
    $('#btnRefresh').addEventListener('click',loadProfiles);
    $('#q').addEventListener('input',loadProfiles);
    loadProfiles();

    // ========== MP4 分頁輔助 ==========

    const qs=(s,r)=> (r||document).querySelector(s);
    const qsa=(s,r)=> Array.from((r||document).querySelectorAll(s));
    const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
    const b64=(s)=>btoa(unescape(encodeURIComponent(s)));

    // Accordion
    qsa('.acc .hd').forEach(hd=>{
      hd.addEventListener('click',()=> hd.parentElement.classList.toggle('collapsed'));
    });
    qs('#btnCollapseAll')?.addEventListener('click',()=> qsa('.acc').forEach(a=>a.classList.add('collapsed')));
    qs('#btnExpandAll')?.addEventListener('click',()=> qsa('.acc').forEach(a=>a.classList.remove('collapsed')));

    // Functions base
    function computeFnBase(){
      let url = (window.BW?.url) || qs('#sbUrl')?.value || '';
      if(!url && window.BW?.supa?.url) url = window.BW.supa.url;
      let base='';
      try{ const u=new URL(url); base=`${u.protocol}//${u.host.replace('.supabase.co','.functions.supabase.co')}`; }catch(e){}
      qs('#fnBase').textContent = base || '未偵測';
      return base;
    }
    computeFnBase();
    qs('#sbUrl')?.addEventListener('input', computeFnBase);

    async function callEdge(fn, payload){
      const base = computeFnBase();
      if(!base){ throw new Error('未偵測到 Supabase Functions 端點'); }
      const url = `${base}/${fn}`;
      const headers={'Content-Type':'application/json'};
      try{
        const s = await window.BW?.auth?.getSession?.();
        const jwt = s?.session?.access_token;
        if(jwt) headers['Authorization'] = `Bearer ${jwt}`;
      }catch(e){}
      const r=await fetch(url,{method:'POST',headers,body:JSON.stringify(payload)});
      if(!r.ok){ const t=await r.text(); throw new Error(`Functions HTTP ${r.status} – ${t}`); }
      return await r.json();
    }

    function setSlugLabels(slug){
      ['fnSlug1','fnSlug2','fnSlug3','fnSlug4','fnSlug5'].forEach(id=>{ const el=qs('#'+id); if(el) el.textContent=slug||'slug'; });
    }

    function mmss(i, step=4){ const s=i*step; const m=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${m}:${ss}`; }

    async function parseSubtitleFile(file){
      if(!file) return [];
      const name=file.name.toLowerCase();
      const text=await file.text();
      if(name.endsWith('.json')){
        try{ const arr=JSON.parse(text); if(Array.isArray(arr)&&arr.length&&('time' in arr[0])) return arr.map(x=>({time:x.time,en:x.en||'',ja:x.ja||'',zh:x.zh||''})); }catch(e){}
      }
      if(name.endsWith('.srt')||name.endsWith('.vtt')){
        const lines=text.replace(/\r/g,'').split('\n');
        const out=[]; let cur=null;
        const timeRe=/(\d\d:\d\d:\d\d)[,\.](\d\d\d)\s*-->\s*(\d\d:\d\d:\d\d)[,\.](\d\d\d)/;
        for(const ln of lines){
          const m=timeRe.exec(ln);
          if(m){ cur={time:m[1].slice(0,5), en:''}; continue; }
          if(!ln.trim()){ if(cur){ out.push({...cur,ja:'',zh:''}); cur=null; } }
          else if(cur){ cur.en = (cur.en?cur.en+' ':'') + ln.trim(); }
        }
        if(cur) out.push({...cur,ja:'',zh:''});
        return out;
      }
      const arr=text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      return arr.map((line,i)=>({ time:mmss(i), en:line, ja:'', zh:'' }));
    }

    function tokenizeEn(s){ return (s||'').toLowerCase().replace(/[^a-z0-9' ]/g,' ').split(/\s+/).filter(Boolean); }
    const STOP=new Set(['the','a','an','to','is','are','am','be','and','or','of','in','on','for','with','that','this','it','as','at','by','from','i','you','he','she','we','they','was','were','been','do','did','does','so','but','if','not','no','yes','me','my','your','our','their']);
    function topWords(cues,n=40){
      const freq=new Map();
      for(const c of cues){ for(const w of tokenizeEn(c.en)){ if(w.length<3||STOP.has(w)) continue; freq.set(w,(freq.get(w)||0)+1); } }
      return Array.from(freq.entries()).sort((a,b)=>b[1]-a[1]).slice(0,n).map(x=>x[0]);
    }
    function buildVocabFromCues(cues){
      const keys=topWords(cues,40);
      const set=new Set(); const out=[];
      for(const k of keys){
        if(set.has(k)) continue; set.add(k);
        const sample=(cues.find(c=>c.en.toLowerCase().includes(k))?.en)||(`I use "${k}" in a sentence.`);
        out.push({ en:k, zh:"", ja:"", def_en:"", example_en: sample });
        if(out.length>=20) break;
      }
      return out;
    }

    // 「測試」按鈕：改用 {lines:[...]}
    qs('#btnTestFn')?.addEventListener('click', async ()=>{
      const msg=qs('#fnMsg'); msg.textContent='測試中…';
      try{
        const fn=(qs('#edgeFn').value||'mt-translate').trim();
        const j=await callEdge(fn,{ lines: ['Hello world'] });
        msg.textContent = j?.ok ? ('OK：'+(j.result || 'Edge 連線成功')) : '失敗';
      }catch(e){ msg.textContent='失敗：'+(e.message||e); }
    });

    // 預覽 JSON：改一次送陣列到 Edge 取得 zh/ja
    qs('#btnPreview')?.addEventListener('click', async ()=>{
      const cat=qs('#cat').value.trim(), slug=qs('#slug').value.trim(), title=qs('#title').value.trim();
      setSlugLabels(slug);
      const sub=qs('#subFile').files[0];
      const cuesEN=await parseSubtitleFile(sub);
      let zhArr=[], jaArr=[];

      if(qs('#modeMT').checked && cuesEN.length){
        const enArr=cuesEN.map(x=>x.en);
        try{
          // 利用末段 helper：translateViaEdge（一次回 zh/ja）
          const { zh, ja } = await translateViaEdge(enArr);
          zhArr = zh; jaArr = ja;
        }catch(e){ qs('#fnMsg').textContent='機翻失敗：'+(e.message||e); }
      }

      // 20 詞彙
      const vocab20 = buildVocabFromCues(cuesEN).map(v=>({ ...v, zh:'', ja:'' }));

      const index = { slug, title, video:`videos/${cat}/${slug}.mp4`, cover:`assets/${cat}/${slug}/cover.jpg`, category:cat, updatedAt:new Date().toISOString() };
      const topics = Array.from({length:20},(_,i)=>({title:`Topic ${i+1}`,prompt:"",hint:"",sample:""}));
      const quiz = { title:"Lesson", topics };
      const cues = cuesEN.map((x,i)=>({...x, zh: zhArr[i]||x.zh||'', ja: jaArr[i]||x.ja||'' }));
      const ai = { tasks: Array.from({length:15},(_,i)=>({q:`Question ${i+1}`,a:""})) };

      qs('#boxIndex').value = JSON.stringify(index, null, 2);
      qs('#boxCues').value  = JSON.stringify(cues,  null, 2);
      qs('#boxQuiz').value  = JSON.stringify(quiz,  null, 2);
      qs('#boxVocab').value = JSON.stringify({words:vocab20}, null, 2);
      qs('#boxAI').value    = JSON.stringify(ai,    null, 2);
    });

    // Supabase upload
    function getClient(){
      if(window.BW?.supa?.createClient) return window.BW.supa.createClient();
      const url=qs('#sbUrl').value.trim(); const key=qs('#sbKey').value.trim();
      if(!url || !key) return null;
      return supabase.createClient(url,key);
    }
    async function supaUpload(bucket, path, file, client){
      const { error } = await client.storage.from(bucket).upload(path, file, { upsert:true, contentType:file.type||undefined });
      if(error) throw error;
      const { data:pub } = client.storage.from(bucket).getPublicUrl(path);
      return pub.publicUrl;
    }
    function setProgress(bar,pct,p){ p=Math.max(0,Math.min(100,Math.round(p))); if(bar) bar.style.width=p+'%'; if(pct) pct.textContent=p+'%'; }
    const supaBar=qs('#supaBar2'), supaPct=qs('#supaPct2');
    qs('#btnSupaUpload')?.addEventListener('click', async ()=>{
      const st=qs('#supaStatus'); st.textContent='';
      const cat=qs('#cat').value.trim(), slug=qs('#slug').value.trim();
      const mp4=qs('#mp4File').files[0], cover=qs('#coverFile').files[0];
      if(!mp4){ st.textContent='[錯誤] 請先選擇 MP4 檔。'; return; }
      const c=getClient(); if(!c){ st.textContent='[錯誤] 找不到 Supabase 連線（BW.supa 或手動 URL/KEY）。'; return; }
      const vBucket=qs('#bucketVideo').value.trim()||'videos', aBucket=qs('#bucketAsset').value.trim()||'assets';
      try{
        setProgress(supaBar,supaPct,10); st.textContent+='[1/2] 上傳影片中...\n';
        const vUrl=await supaUpload(vBucket, `${cat}/${slug}.mp4`, mp4, c);
        st.textContent+=`    影片 URL → ${vUrl}\n`; setProgress(supaBar,supaPct,70);
        let cUrl=''; if(cover){ st.textContent+='[2/2] 上傳封面中...\n'; cUrl=await supaUpload(aBucket, `${cat}/${slug}/cover.jpg`, cover, c); st.textContent+=`    封面 URL → ${cUrl}\n`; } else { st.textContent+='[2/2] 未選封面，略過。\n'; }
        setProgress(supaBar,supaPct,100);
        if(qs('#boxIndex').value){ try{ const idx=JSON.parse(qs('#boxIndex').value); if(vUrl) idx.video=vUrl; if(cUrl) idx.cover=cUrl; qs('#boxIndex').value=JSON.stringify(idx,null,2);}catch(e){} }
        st.textContent+='完成。';
      }catch(e){ st.textContent+=`[失敗] ${e.message||e}`; setProgress(supaBar,supaPct,0); }
    });

    // GitHub upload
    async function ghPut({owner,repo,branch,token,path,content,message}){
      const url=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
      const body={ message, branch, content: b64(content) };
      const r=await fetch(url,{method:'PUT',headers:{'Authorization':`token ${token}`,'Content-Type':'application/json'},body:JSON.stringify(body)});
      if(!r.ok){ const t=await r.text(); throw new Error(`HTTP ${r.status} – ${t}`); }
      return await r.json();
    }
    function parseBox(id){ try{ return JSON.parse(qs(id).value||''); }catch(e){ return null; } }
    function validateAll(st){
      const index=parseBox('#boxIndex'), cues=parseBox('#boxCues'), quiz=parseBox('#boxQuiz'), vocab=parseBox('#boxVocab'), ai=parseBox('#boxAI');
      if(!index||!cues||!quiz||!vocab||!ai){ st.textContent='[錯誤] 五份 JSON 需全部產生（請先按「預覽 JSON」）'; return false; }
      return true;
    }
    const ghBar=qs('#ghBar2'), ghPct=qs('#ghPct2');
    qs('#btnUploadGithub')?.addEventListener('click', async ()=>{
      const st=qs('#ghStatus'); st.textContent='';
      if(!validateAll(st)){ setProgress(ghBar,ghPct,0); return; }
      const owner=qs('#ghOwner').value.trim(), repo=qs('#ghRepo').value.trim(), branch=qs('#ghBranch').value.trim(), base=(qs('#ghBase').value||'').trim(), token=qs('#ghTok').value.trim();
      const msg=qs('#ghMsg').value.trim()||'Add JSON';
      if(!owner||!repo||!branch||!token){ st.textContent='[錯誤] 請填 owner / repo / branch / token'; return; }
      const slugVal=qs('#slug').value.trim(); if(!slugVal){ st.textContent='[錯誤] Slug 不可空（請在左側填寫 slug 並重新產生 JSON）'; return; }
      const cat=qs('#cat').value.trim(), slug=qs('#slug').value.trim();
      const root = (base ? base.replace(/\/$/,'') : 'data') + `/${cat}/${slug}`;
      const files=[
        {name:`${root}/index-${slug}.json`, data:qs('#boxIndex').value},
        {name:`${root}/cues-${slug}.json`,  data:qs('#boxCues').value},
        {name:`${root}/quiz-${slug}.json`,  data:qs('#boxQuiz').value},
        {name:`${root}/vocab-${slug}.json`, data:qs('#boxVocab').value},
        {name:`${root}/ai-${slug}.json`,    data:qs('#boxAI').value},
      ];
      let i=0;
      try{
        for(const f of files){ i++; st.textContent+=`[${i}/5] 上傳 ${f.name}...\n`; await ghPut({owner,repo,branch,token,path:f.name,content:f.data,message:msg}); ghBar.style.width=`${Math.round(i/5*100)}%`; ghPct.textContent=`${Math.round(i/5*100)}%`; await sleep(150); }
        st.textContent+='完成。';
      }catch(e){ st.textContent+=`[失敗] ${e.message||e}`; ghBar.style.width='0%'; ghPct.textContent='0%'; }
    });
  </script>

  <!-- 批次機翻 Helper（保留；被預覽流程呼叫） -->
  <script>
    /** 你的 function 端點（維持你專案的實際 URL） */
    const EDGE_URL = "https://jeajrwpmrgczimmrflxo.functions.supabase.co/functions/v1/mt-translate";

    /** 呼叫 Edge Function：輸入英文陣列 → 回傳 { zh:[], ja:[] } */
    async function translateViaEdge(enLines) {
      const res = await fetch(EDGE_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ lines: enLines })
      });
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || "Edge translation failed");
      return { zh: json.zh || [], ja: json.ja || [] };
    }
  </script>

  <script>
/**
 * BookWide Admin – Edge Translate Patch (mt-translate only)
 * 不動你的版型與其餘流程，只補上「用 Edge Function 翻譯中/日」的前端呼叫。
 * 使用方式：
 * 1) 頁面上原本就有的「Supabase URL」與「Supabase anon key」輸入框，下面這段會自動抓取（也會寫入 localStorage 以後自動帶入）。
 * 2) 讀使用者選的字幕 .txt 形成陣列 lines（你的原流程已有），呼叫 doEdgeTranslate(lines, ["zh","ja"])。
 * 3) 取得 results 後，丟回你現有的預覽/組 JSON 的函式即可。
 */

/* === 1) 取得 / 保存 Supabase 連線設定（沿用你頁面上的欄位） === */
function bwGetElByLabelStartsWith(text) {
  // 幫忙找你頁面已存在的輸入框（以 placeholder 或 label 文字片段匹配）
  const inputs = Array.from(document.querySelectorAll('input,textarea'));
  // 常見 placeholder / label：Supabase URL、Supabase anon key
  let el = inputs.find(i => (i.placeholder || '').includes(text));
  if (el) return el;
  // 再掃一輪看 label 旁邊的 input
  const labels = Array.from(document.querySelectorAll('label'));
  for (const lb of labels) {
    if ((lb.textContent || '').includes(text)) {
      const forId = lb.getAttribute('for');
      if (forId) {
        const byFor = document.getElementById(forId);
        if (byFor) return byFor;
      }
      const nextInput = lb.parentElement?.querySelector('input,textarea');
      if (nextInput) return nextInput;
    }
  }
  return null;
}

function bwLoadConn() {
  const saved = JSON.parse(localStorage.getItem('BW_SUPA_CONN') || '{}');
  // 嘗試從頁面抓一次
  const urlInput = bwGetElByLabelStartsWith('https://') || bwGetElByLabelStartsWith('Supabase URL');
  const anonInput = bwGetElByLabelStartsWith('ey') || bwGetElByLabelStartsWith('anon key') || bwGetElByLabelStartsWith('Supabase anon');

  const url = (urlInput?.value || saved.url || '').trim();
  const anon = (anonInput?.value || saved.anon || '').trim();

  if (urlInput) urlInput.value = url;
  if (anonInput) anonInput.value = anon;

  if (url && anon) {
    localStorage.setItem('BW_SUPA_CONN', JSON.stringify({ url, anon }));
  }
  return { url, anon };
}

/* === 2) 將 https://<proj>.supabase.co 轉成 functions 網域 === */
function toFunctionsBaseUrl(supabaseUrl) {
  // 例： https://jeajrwpmrgczimmrflxo.supabase.co -> https://jeajrwpmrgczimmrflxo.functions.supabase.co
  try {
    const u = new URL(supabaseUrl);
    const host = u.host.replace('.supabase.co', '.functions.supabase.co');
    return `${u.protocol}//${host}`;
  } catch {
    return '';
  }
}

/* === 3) 呼叫 Edge Function: mt-translate === */
async function doEdgeTranslate(lines, toLangs = ['zh','ja']) {
  const conn = bwLoadConn();
  if (!conn.url) throw new Error('尚未填 Supabase URL');
  // anon key 不需要送到 Edge（由 Edge 端用環境變數打 OpenAI），這裡只保存起來給你其他流程用
  const fnBase = toFunctionsBaseUrl(conn.url);
  const endpoint = `${fnBase}/functions/v1/mt-translate`;

  const body = { lines, to: toLangs };
  const res = await fetch(endpoint, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    // 不要夾 anon key；Edge Functions 會讀 Settings → Secrets 的 OPENAI_API_KEY
    body: JSON.stringify(body),
  });

  let data;
  try { data = await res.json(); } catch { data = null; }

  if (!res.ok) {
    // 讓錯誤明確顯示
    const msg = data && typeof data === 'object' ? JSON.stringify(data) : await res.text();
    throw new Error(`Edge 失敗 (${res.status}): ${msg}`);
  }
  // 期待格式：
  // { ok:true, input:[...], results:[ {lang:"zh", text:"...", lines:[...], tokens:..., costUSD:..., ...}, {...ja...} ], totalUSD, totalTWD, price:{...}}
  if (!data || !data.ok || !Array.isArray(data.results)) {
    throw new Error('Edge 回傳格式不符，請檢查 Edge 程式。');
  }
  return data;
}

/* === 4) 從 .txt 讀取字幕為陣列（保留你原有流程也可直接餵陣列進來） === */
async function readTxtFileToLines(file) {
  const txt = await file.text();
  // 依你字幕 .txt 的格式，通常一行一句。如果有空白行，過濾掉。
  return txt.replace(/\r\n/g, '\n').split('\n').map(s => s.trim()).filter(Boolean);
}

/* === 5) 綁定「Edge 測試」按鈕（不動你原按鈕；給你一個可見測試鈕） === */
(function injectEdgeTestButton() {
  // 只插一次
  if (document.getElementById('bw-edge-test-btn')) return;
  // 找你「字幕 .txt」檔案輸入旁邊插一顆測試鈕
  const fileInputs = Array.from(document.querySelectorAll('input[type="file"]'));
  const txtInput = fileInputs.find(i => (i.accept || '').includes('.txt') || (i.parentElement?.textContent || '').includes('.txt')) || fileInputs[1];
  if (!txtInput) return;

  const btn = document.createElement('button');
  btn.id = 'bw-edge-test-btn';
  btn.type = 'button';
  btn.textContent = 'Edge 翻譯測試（中/日）';
  btn.style.marginLeft = '8px';
  txtInput.parentElement.appendChild(btn);

  const logArea = document.createElement('div');
  logArea.id = 'bw-edge-log';
  logArea.style.cssText = 'margin-top:8px; padding:8px; border:1px dashed #ccc; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; white-space:pre-wrap;';
  txtInput.closest('section,div,fieldset,form')?.appendChild(logArea);

  btn.addEventListener('click', async () => {
    logArea.textContent = '讀取字幕中…';
    try {
      const f = txtInput.files?.[0];
      if (!f) throw new Error('請先選擇字幕 .txt 檔');

      const lines = await readTxtFileToLines(f);
      if (!lines.length) throw new Error('字幕內容為空');

      logArea.textContent = '呼叫 Edge Function 中…';
      const data = await doEdgeTranslate(lines, ['zh','ja']);

      // 顯示簡要結果與估算費用
      const zh = data.results.find(r => r.lang === 'zh');
      const ja = data.results.find(r => r.lang === 'ja');
      const cost = `成本(估)：USD ${data.totalUSD ?? 0} ≈ TWD ${data.totalTWD ?? 0}`;

      logArea.textContent =
`✔ Edge 成功
—— 原始行數：${lines.length}
—— zh 前 2 行：${(zh?.lines || []).slice(0,2).join(' / ')}
—— ja 前 2 行：${(ja?.lines || []).slice(0,2).join(' / ')}
${cost}`;

      // 你原本的預覽/組 JSON 流程若有全域函式，可在這裡餵回去：
      // window.bwOnTranslateDone?.(data); // 例如交回去你的預覽面板
      window.BW_EDGE_LAST = data; // 先暫存，方便你在 Console 看：BW_EDGE_LAST
    } catch (err) {
      logArea.textContent = `✖ 失敗：${err.message || err}`;
    }
  });
})();

/* === 6) 提供一個全域函式，讓你原本流程可直接呼叫 === */
// 例如你的流程：const data = await bwEdgeTranslate(lines, ['zh','ja']); 然後把 data 丟入你現有的 JSON 組裝。
window.bwEdgeTranslate = doEdgeTranslate;
</script>

</body>
</html>
















































































































































































