<!doctype html>
<html lang="zh-Hant">
<head>
<!-- ✅ Supabase 初始化補丁 -->
<script type="module">
  import { supabase } from './supa.js';
  if (!window.supabase) {
    window.supabase = supabase;
    console.log('[BookWide] Supabase client initialized');
  }
</script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BookWide — Admin 主控台（單檔版）</title>
  <style>
    :root{--bg:#0e1320;--panel:#121a2b;--ink:#e6edf6;--muted:#9fb0c3;--brand:#51a3ff;--ok:#1fc37d;--warn:#ffb020;--bad:#ff5d5d;--line:#1f2a42}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(14,19,32,.95),rgba(14,19,32,.8));backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid var(--line);}
    .bar{max-width:1200px;margin:auto;display:flex;align-items:center;gap:16px;padding:14px 20px}
    .logo{font-weight:700;letter-spacing:.5px}
    .chip{border:1px solid var(--line);border-radius:999px;padding:6px 12px;background:var(--panel);color:var(--ink);}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{border:1px solid var(--line);padding:8px 14px;border-radius:9px;background:#11182b;color:var(--muted);cursor:pointer}
    .tab.active{background:var(--brand);color:#001429;border-color:transparent}
    main{max-width:1200px;margin:24px auto;padding:0 20px}
    section.card{display:none;border:1px solid var(--line);border-radius:14px;background:var(--panel);padding:18px}
    section.card.active{display:block}
    h2{margin:0 0 6px 0;font-size:18px}
    .sub{color:var(--muted);font-size:13px;margin:0 0 14px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type="text"], input[type="email"], input[type="datetime-local"], select{background:#0e1526;border:1px solid var(--line);color:var(--ink);padding:8px 10px;border-radius:8px;outline:none}
    input[type="file"]{color:var(--muted)}
    button{background:#1a2340;border:1px solid var(--line);color:var(--ink);padding:8px 14px;border-radius:8px;cursor:pointer}
    button.primary{background:var(--brand);color:#001429;border-color:transparent}
    button.ghost{background:transparent;border-color:var(--line);color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
    th,td{border-bottom:1px solid var(--line);padding:10px 8px;text-align:left}
    th{color:#9fb0c3;font-weight:600}
    .badge{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);color:var(--muted)}
    .ok{color:var(--ok);border-color:var(--ok)}
    .bad{color:var(--bad);border-color:var(--bad)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    .mt12{margin-top:12px}
    .mt6{margin-top:6px}
    .grow{flex:1}
    .right{margin-left:auto}
    .muted{color:var(--muted)}
    .foot{margin-top:20px;color:var(--muted);font-size:12px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:920px){.grid2{grid-template-columns:1fr}}
  </style>
</head>
<body>

<!-- BW Supabase global initializer -->
<script type="module" id="bw-supa-init">
  import { supabase } from './supa.js';
  window.supa = window.supa ?? supabase;
  window.supabase = window.supa;
  window.dispatchEvent(new Event('bw:supa-ready'));
</script>
<header class="topbar flex items-center justify-between px-4 py-2 bg-[#0d1321] text-white">
  <div class="flex items-center gap-3">
    <h1 class="text-lg font-semibold">BookWide Admin 主控台</h1>
    <a href="index.html" class="text-sm text-blue-300 hover:underline">← 回首頁</a>
  </div>
  <nav class="flex items-center gap-2">
    <button class="btn-tab active">使用者清單</button>
    <button class="btn-tab">授權／暫停管理員</button>
    <button class="btn-tab">MP4 上傳自動化</button>
  </nav>
</header>

<script type="module" id="bw-guard-admin">
  import { supabase } from './supa.js';
  (async () => {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) { alert('請先登入'); location.href='./index.html'; return; }
    const { data: p } = await supabase.from('profiles').select('is_admin').eq('id', user.id).single();
    if (!p?.is_admin) { alert('您沒有管理員權限'); location.href='./index.html'; }
  })();
</script>


  <main>
    <!-- 使用者清單 -->
    <section class="card active" id="tab-users">
      <h2>使用者清單</h2>
      <p class="sub">最後登入與「目前在線」以 <b>台灣時間</b> 顯示；10 分鐘內視為在線。</p>

      <div class="row">
        <input id="q" class="grow" type="text" placeholder="搜尋 Email / 暱稱 ..." />
        <button id="btnReload">重新整理</button>
      </div>

      <table id="tbl">
        <thead>
          <tr>
            <th>Email</th>
            <th>顯示名稱</th>
            <th>最後登入（台灣）</th>
            <th>到期日 / 在線</th>
            <th>管理員</th>
            <th>暫停</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="foot">符合 RLS 規則：僅管理員可查看所有人資料。</div>
    </section>

    <!-- 授權/暫停 -->
    <section class="card" id="tab-grant">
      <h2>授權／暫停管理員</h2>
      <p class="sub">以 Email 操作。設定到期日可空白（不變更）。</p>

      <div class="grid2">
        <div>
          <div class="muted">Email</div>
          <input id="gEmail" type="email" placeholder="someone@example.com" class="grow" />
        </div>
        <div>
          <div class="muted">到期日（可空白）</div>
          <input id="gExpire" type="date" />
        </div>
      </div>

      <div class="row mt12">
        <button id="btnGrant" class="primary">授權為管理員</button>
        <button id="btnRevoke">取消管理員</button>
        <button id="btnSuspend" class="warn">暫停</button>
        <button id="btnUnsuspend" class="ghost">解除暫停</button>
      </div>

      <p id="grantMsg" class="mt6 muted mono"></p>
    </section>

    <!-- MP4 自動化 -->
    <section class="card" id="tab-mp4">
      <h2>MP4 上傳自動化</h2>
      <p class="sub">上傳 MP4 與封面，並寫入 <code>assets</code> ；路徑：
        <span class="mono">videos/{category}/{slug}.mp4</span>、
        <span class="mono">data/{category}/{slug}/cover.jpg</span>、
        <span class="mono">data/{category}/{slug}/cues-{slug}.json</span>…</p>

      <div class="grid2">
        <div>
          <div class="muted">分類（category）</div>
          <select id="mCat">
            <option value="story">story</option>
            <option value="music">music</option>
            <option value="movie">movie</option>
            <option value="news">news</option>
            <option value="pro">pro</option>
          </select>
        </div>
        <div>
          <div class="muted">Slug（英數連字號）</div>
          <input id="mSlug" type="text" placeholder="mid-autumn" />
        </div>
      </div>

      <div class="grid2 mt12">
        <div>
          <div class="muted">標題（title）</div>
          <input id="mTitle" type="text" placeholder="The Mid-Autumn Festival" />
        </div>
        <div>
          <div class="muted">MP4 檔案</div>
          <input id="mMp4" type="file" accept="video/mp4" />
        </div>
      </div>

      <div class="grid2 mt12">
        <div>
          <div class="muted">封面（cover）可選</div>
          <input id="mCover" type="file" accept="image/*" />
        </div>
        <div>
          <div class="muted">醒目詞（keywords, 逗號分隔）可選</div>
          <input id="mKw" type="text" placeholder="festival, moon, Hou Yi" />
        </div>
      </div>

      <div class="row mt12">
        <button id="btnUpload" class="primary">開始上傳</button>
        <button id="btnReset" class="ghost">清除</button>
        <div id="upState" class="muted right"></div>
      </div>

      <pre id="upLog" class="mt12 mono muted" style="white-space:pre-wrap"></pre>
    </section>
  </main>

  <!-- 只引用現有的 supa.js（單檔維護，但沿用你的憑證） -->
  <script type="module">
    // 1) 取用你專案裡已存在的 supa.js（ESM 匯出 supabase）
    import { supabase } from './supa.js';
    window.supabase = supabase; // 讓後續普通 script 也能用

    // 2) Tab 切換
    const tabs = document.querySelectorAll('.tab');
    const cards = {
      users: document.getElementById('tab-users'),
      grant: document.getElementById('tab-grant'),
      mp4: document.getElementById('tab-mp4'),
    };
    tabs.forEach(t=>t.addEventListener('click',()=>{
      tabs.forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      Object.values(cards).forEach(c=>c.classList.remove('active'));
      cards[t.dataset.tab].classList.add('active');
    }));

    // ===== 使用者清單 =====
    const $tbody = document.querySelector('#tbl tbody');
    const $q = document.getElementById('q');
    const $btnReload = document.getElementById('btnReload');

    function toTzTaipei(ts){
      if(!ts) return '';
      const d = new Date(ts);
      return new Intl.DateTimeFormat('zh-TW', {
        timeZone:'Asia/Taipei', year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit', second:'2-digit'
      }).format(d);
    }
    function onlineBadge(lastSeenIso){
      if(!lastSeenIso) return '<span class="badge">—</span>';
      const last = new Date(lastSeenIso).getTime();
      const now = Date.now();
      const online = (now - last) <= 10*60*1000;
      return online ? '<span class="badge ok">在線</span>' : '<span class="badge">離線</span>';
    }
    async function loadUsers(){
  $tbody.innerHTML = '<tr><td class="muted" colspan="6">載入中…</td></tr>';

  const { data, error } = await supabase
    .from('profiles')
    .select('email, full_name, nickname, is_admin, last_sign_in_at, expires_at')
    .order('email', { ascending: true });

  if (error) {
    $tbody.innerHTML = '<tr><td class="bad" colspan="6">讀取失敗 ' + (error.message||error) + '</td></tr>';
    return;
  }

  const kw = ($q.value || '').trim().toLowerCase();
  const rows = (data || []).filter(r => {
    const name = (r.full_name || r.nickname || '').toLowerCase();
    return !kw || (r.email?.toLowerCase().includes(kw) || name.includes(kw));
  });

  if (!rows.length) {
    $tbody.innerHTML = '<tr><td class="muted" colspan="6">沒有資料</td></tr>';
    return;
  }

  function toTzTaipei(iso){
    if(!iso) return '';
    try{
      const d = new Date(iso);
      const t = new Intl.DateTimeFormat('zh-TW', { timeZone: 'Asia/Taipei', dateStyle:'short', timeStyle:'medium' }).format(d);
      return t.replace(/\//g,'-');
    }catch(_){ return iso; }
  }
  function onlineByLastLogin(iso){
    if(!iso) return false;
    return (Date.now() - new Date(iso).getTime()) <= 10*60*1000; // 10 分鐘內
  }

  $tbody.innerHTML = rows.map(r => {
    const name = r.full_name || r.nickname || '—';
    const lastLogin = toTzTaipei(r.last_sign_in_at);
    const exp = r.expires_at ? new Date(r.expires_at).toISOString().slice(0,10) : '';
    const online = onlineByLastLogin(r.last_sign_in_at)
      ? '<span class="badge ok">在線</span>'
      : '<span class="badge">離線</span>';
    return `<tr>
      <td class="mono">${r.email || ''}</td>
      <td>${name}</td>
      <td class="mono">${lastLogin || ''}</td>
      <td class="mono">${exp} &nbsp; ${online}</td>
      <td>${r.is_admin ? '<span class="badge ok">Admin</span>' : '<span class="badge">—</span>'}</td>
      <td><span class="badge">—</span></td>
    </tr>`;
  }).join('');
}
const kw = ($q.value || '').trim().toLowerCase();
      const rows = (data||[]).filter(r=> !kw || (r.email?.toLowerCase().includes(kw) || r.full_name?.toLowerCase().includes(kw)));
      if(!rows.length){ $tbody.innerHTML = '<tr><td class="muted" colspan="6">沒有資料</td></tr>'; return; }

      $tbody.innerHTML = rows.map(r=>{
        return `<tr>
          <td class="mono">${r.email||''}</td>
          <td>${r.full_name||''}</td>
          <td class="mono">${toTzTaipei(r.last_sign_in_at)}</td>
          <td class="mono">${r.expires_at ? new Date(r.expires_at).toISOString().slice(0,10) : ''} &nbsp; ${onlineBadge(r.last_sign_in_at)}</td>
          <td>${r.is_admin ? '<span class="badge ok">Admin</span>' : '<span class="badge">—</span>'}</td>
          <td>${r.suspended ? '<span class="badge bad">暫停</span>' : '<span class="badge">—</span>'}</td>
        </tr>`
      }).join('');
    }
    $btnReload.addEventListener('click', loadUsers);
    $q.addEventListener('input', () => { loadUsers() });

    // ===== 授權／暫停 =====
    const $gEmail = document.getElementById('gEmail');
    const $gExpire = document.getElementById('gExpire');
    const $grantMsg = document.getElementById('grantMsg');

    async function setAdmin(flag){
      const email = $gEmail.value.trim();
      if(!email){ $grantMsg.textContent = 'Email 必填'; return; }
      const payload = { is_admin: !!flag };
      if($gExpire.value) payload.expires_at = $gExpire.value;
      const { error } = await supabase.from('profiles').update(payload).eq('email', email);
      $grantMsg.textContent = error ? ('失敗：'+error.message) : '成功';
      loadUsers();
    }
    async function setSuspend(flag){
      const email = $gEmail.value.trim();
      if(!email){ $grantMsg.textContent = 'Email 必填'; return; }
      const { error } = await supabase.from('profiles').update({ suspended: !!flag }).eq('email', email);
      $grantMsg.textContent = error ? ('失敗：'+error.message) : '成功';
      loadUsers();
    }
    document.getElementById('btnGrant').addEventListener('click', ()=>setAdmin(true));
    document.getElementById('btnRevoke').addEventListener('click', ()=>setAdmin(false));
    document.getElementById('btnSuspend').addEventListener('click', ()=>setSuspend(true));
    document.getElementById('btnUnsuspend').addEventListener('click', ()=>setSuspend(false));

    // ===== MP4 上傳 =====
    const $mCat = document.getElementById('mCat');
    const $mSlug = document.getElementById('mSlug');
    const $mTitle = document.getElementById('mTitle');
    const $mMp4 = document.getElementById('mMp4');
    const $mCover = document.getElementById('mCover');
    const $mKw = document.getElementById('mKw');
    const $upState = document.getElementById('upState');
    const $upLog = document.getElementById('upLog');

    function logln(s){ $upLog.textContent += (s + "\n"); }
    function resetForm(){
      $mSlug.value=''; $mTitle.value=''; $mMp4.value=''; $mCover.value=''; $mKw.value=''; $upState.textContent=''; $upLog.textContent='';
    }
    document.getElementById('btnReset').addEventListener('click', resetForm);

    async function uploadTo(bucket, path, file, opts={ upsert: true, cacheControl: '3600' }){
      const { data, error } = await supabase.storage.from(bucket).upload(path, file, opts);
      if(error) throw error;
      const { data:pub } = await supabase.storage.from(bucket).getPublicUrl(path);
      return pub.publicUrl;
    }

    async function upsertAsset(rec){
      const { error } = await supabase.from('assets').upsert(rec, { onConflict: 'category,slug' });
      if(error) throw error;
      return true;
    }

    document.getElementById('btnUpload').addEventListener('click', async () => {
      try{
        $upState.textContent='上傳中…'; $upLog.textContent='';
        const cat = $mCat.value.trim();
        const slug = $mSlug.value.trim();
        const title = $mTitle.value.trim();
        if(!cat || !slug || !title){ $upState.textContent='請填分類/slug/標題'; return; }
        if(!$mMp4.files[0]){ $upState.textContent='請選擇 MP4 檔案'; return; }

        const mp4Path = `videos/${cat}/${slug}.mp4`;
        logln('上傳 MP4 → ' + mp4Path);
        const mp4Url = await uploadTo('videos', mp4Path, $mMp4.files[0]);
        logln('OK ' + mp4Url);

        let coverUrl='';
        if($mCover.files[0]){
          const coverPath = `data/${cat}/${slug}/cover.jpg`;
          logln('上傳封面 → ' + coverPath);
          coverUrl = await uploadTo('data', coverPath, $mCover.files[0]);
          logln('OK ' + coverUrl);
        }

        // 預留 cues/vocab/quiz/ai json（可先放空檔案或之後補）
        const base = `data/${cat}/${slug}`;
        const cuesUrl  = `${location.origin}${location.pathname.replace(/\/[^/]*$/,'/')}${base}/cues-${slug}.json`;
        const vocabUrl = `${location.origin}${location.pathname.replace(/\/[^/]*$/,'/')}${base}/vocab-${slug}.json`;
        const quizUrl  = `${location.origin}${location.pathname.replace(/\/[^/]*$/,'/')}${base}/quiz-${slug}.json`;
        const aiUrl    = `${location.origin}${location.pathname.replace(/\/[^/]*$/,'/')}${base}/ai-${slug}.json`;

        // upsert assets
        const rec = {
          category: cat, slug, title,
          mp4_url: mp4Url, cover_url: coverUrl || null,
          cues_url: cuesUrl, vocab_url: vocabUrl, quiz_url: quizUrl, ai_url: aiUrl,
          keywords: $mKw.value || null, updated_at: new Date().toISOString()
        };
        logln('寫入 assets …');
        await upsertAsset(rec);
        logln('完成');
        $upState.textContent='✅ 完成';
      }catch(err){
        console.error(err);
        $upState.textContent='❌ 失敗';
        logln('ERROR: ' + err.message);
      }
    });

    // 首次載入
    loadUsers();
  </script>

<!-- Hidden MP4 input -->
<input id="mp4File" type="file" accept="video/mp4" style="display:none">

<script type="module">
  // MP4 上傳自動化：恢復按鈕
  const MP4_BTN_IDS = ['btnUploadAuto','btnMp4','btnMP4Auto'];
  const $btn = MP4_BTN_IDS.map(id=>document.getElementById(id)).find(Boolean);
  if ($btn) {
    $btn.addEventListener('click', async (e)=>{
      e.preventDefault();
      // 優先切換到 MP4 分頁
      const tab = document.querySelector('[data-tab="mp4"], #pane-mp4, a[href="#mp4"], a[href="#pane-mp4"]');
      if (tab) {
        try { tab.click(); } catch(_) {}
        const pane = document.querySelector('#mp4, #pane-mp4');
        if (pane) { pane.scrollIntoView({behavior:'smooth', block:'start'}); return; }
      }
      // 若沒有分頁則開啟檔案選擇器
      const fileInput = document.getElementById('mp4File');
      if (!fileInput) return alert('找不到 MP4 上傳元件，請稍後重試。');
      fileInput.value = '';
      fileInput.click();
    });
  }

  // 檔案選擇後先顯示檔名；若要自動上傳，可解開底下示範
  const fileInput = document.getElementById('mp4File');
  if (fileInput) {
    fileInput.addEventListener('change', async () => {
      const f = fileInput.files?.[0];
      if (!f) return;
      alert('已選擇 MP4：' + f.name + '\n(目前已恢復按鈕與檔案選擇；若要直傳 Storage，告訴我要用的 bucket/path)');
      // 範例：直傳到 Supabase Storage 的 'videos' bucket
      // import { supabase } from './supa.js';
      // const user = (await supabase.auth.getUser())?.data?.user;
      // if (!user) { alert('請先登入'); return; }
      // const path = `mp4/${Date.now()}-${f.name}`;
      // const { error } = await supabase.storage.from('videos').upload(path, f, { upsert:false, contentType: 'video/mp4' });
      // if (error) alert('上傳失敗: ' + error.message); else alert('上傳完成: ' + path);
    });
  }
</script>

</body>
</html>






