<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin Â· ä¸Šå‚³è‡ªå‹•åŒ–ï¼ˆå®Œæ•´ç‰ˆ v20251104ï¼‰</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <style>
    :root{--bg:#f7f7fb;--card:#fff;--text:#222;--muted:#666;--pri:#2563eb;--ok:#16a34a;--err:#dc2626;--bd:#e5e7eb}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.6 system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial}
    header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#fff;border-bottom:1px solid var(--bd);position:sticky;top:0;z-index:5}
    header .brand{font-weight:700}
    header .who{font-size:14px;color:var(--muted)}
    main{max-width:980px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:12px;padding:16px 16px 8px;margin-bottom:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .field{margin:8px 0}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=text], select{width:100%;padding:10px;border:1px solid var(--bd);border-radius:10px;background:#fff}
    input[type=file]{width:100%}
    .drop{border:2px dashed var(--bd);border-radius:12px;padding:16px;text-align:center;background:#fafafa}
    .hint{font-size:12px;color:var(--muted)}
    .btn{display:inline-flex;gap:8px;align-items:center;border:none;border-radius:10px;padding:10px 14px;background:var(--pri);color:#fff;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .mutebtn{background:#e5e7eb;color:#111}
    .log{white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;border:1px dashed var(--bd);border-radius:10px;padding:10px;background:#fff;margin:8px 0;max-height:260px;overflow:auto}
    .good{color:var(--ok)} .bad{color:var(--err)}
    .row .full{grid-column:1 / -1}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--bd);background:#fff}
  </style>
  <!-- UMD ç‰ˆ supabase-jsï¼ˆåªä½œç‚ºå‚™æ´ï¼›è‹¥ç«™ä¸Šå·²æœ‰ BW.supa æœƒå„ªå…ˆä½¿ç”¨ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.1/dist/umd/supabase.js" defer></script>
</head>
<body>
  <header>
    <div class="brand">ğŸ“¦ BookWide Admin Â· ä¸Šå‚³è‡ªå‹•åŒ–</div>
    <div class="who" id="who">åˆå§‹åŒ–ä¸­â€¦</div>
  </header>

  <main>
    <section class="card">
      <h3 style="margin:0 0 12px">MP4 ä¸Šå‚³è‡ªå‹•åŒ–ï¼ˆå®Œæˆå³å¯«å…¥è³‡æ–™è¡¨ï¼‰</h3>

      <div class="row">
        <div class="field">
          <label>åˆ†é¡</label>
          <select id="category">
            <option value="story">story</option>
            <option value="music" selected>music</option>
            <option value="movie">movie</option>
            <option value="news">news</option>
            <option value="pro">pro</option>
          </select>
        </div>
        <div class="field">
          <label>Slugï¼ˆä¸å«ç©ºç™½èˆ‡å‰¯æª”åï¼›ä¾‹ï¼šmid-autumnï¼‰</label>
          <input id="slug" type="text" placeholder="mid-autumn" />
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>é¡¯ç¤ºæ¨™é¡Œï¼ˆå¯ç©ºï¼‰</label>
          <input id="title" type="text" placeholder="ä¾‹å¦‚ï¼šä¸­ç§‹ç¯€å‚³èªª / A Little Love" />
        </div>
        <div class="field">
          <label>å…¬é–‹ç‹€æ…‹</label>
          <select id="vis">
            <option value="true" selected>å…¬é–‹</option>
            <option value="false">ä¸å…¬é–‹</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="field full">
          <label>MP4 æª”ï¼ˆå¯æ‹–æ‹‰åˆ°æ¡†å…§ï¼‰</label>
          <div id="drop" class="drop">
            <input id="fileMP4" type="file" accept="video/mp4" />
            <div class="hint">æª”æ¡ˆå°‡å­˜æ”¾ï¼š<code>videos/{category}/{slug}.mp4</code></div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>å°é¢ï¼ˆå¯é¸ï¼‰</label>
          <input id="fileCover" type="file" accept="image/*" />
          <div class="hint">å°é¢å°‡å­˜æ”¾ï¼š<code>assets/{category}/{slug}/cover.jpg</code></div>
        </div>
        <div class="field" style="align-self:end">
          <button id="btnUpload" class="btn">â¬†ï¸ ä¸Šå‚³ä¸¦å¯«å…¥è³‡æ–™è¡¨</button>
          <button id="btnCheck" class="btn mutebtn">ğŸ” æª¢æŸ¥æ¬Šé™</button>
        </div>
      </div>

      <div class="log" id="log">å¾…å‘½ä¸­â€¦</div>
      <div class="hint">æˆåŠŸå¾Œæœƒé¡¯ç¤º public URL èˆ‡è³‡æ–™è¡¨æ–°å¢çµæœã€‚</div>
    </section>

    <section class="card">
      <details>
        <summary>ğŸ“˜ èªªæ˜ / ç–‘é›£æ’è§£</summary>
        <ul>
          <li>æ­¤é æœƒå„ªå…ˆä½¿ç”¨ä½ ç«™ä¸Šçš„ <code>BW.supa</code> é€£ç·šï¼›è‹¥ä¸å­˜åœ¨ï¼Œæœƒé€€å›å…§å»º UMD é€£ç·šã€‚</li>
          <li>è‹¥çœ‹åˆ° <span class="bad">new row violates row-level security policy</span>ï¼Œè«‹ç¢ºèªï¼š<br>
            1) ä½ æ˜¯ <span class="pill">profiles.is_admin = true</span>ï¼›<br>
            2) <code>storage.objects</code> çš„ <b>INSERT</b> policy å° <code>bucket_id='videos'</code> / <code>'assets'</code> æ”¾è¡Œä¸”ä»¥ <code>WITH CHECK</code> ç¶å®š adminï¼›<br>
            3) ã€Œvideosã€è³‡æ–™è¡¨æœ‰ admin çš„ <b>INSERT</b> policyã€‚</li>
        </ul>
      </details>
    </section>
  </main>

<script>
(function(){
  const logEl = document.getElementById('log');
  const whoEl = document.getElementById('who');
  const btnUpload = document.getElementById('btnUpload');
  const btnCheck  = document.getElementById('btnCheck');

  // å–ç”¨æ—¢æœ‰é€£ç·šï¼ˆå„ªå…ˆ BW.supaï¼‰ï¼Œå¦å‰‡ç”¨ UMD å‚™æ´ï¼ˆéœ€åœ¨æ­¤å¡«å…¥ä½ çš„ URL/Anon Key æˆ–ç«™ä¸Šå·²æœ‰ç’°å¢ƒè®Šæ•¸ï¼‰
  const SUPA_URL = window.BW?.SUPABASE_URL || window.SUPABASE_URL || '';
  const SUPA_KEY = window.BW?.SUPABASE_ANON_KEY || window.SUPABASE_ANON_KEY || '';
  const supa = (window.BW && window.BW.supa) 
               ? window.BW.supa
               : (SUPA_URL && SUPA_KEY && window.supabase?.createClient)
                    ? window.supabase.createClient(SUPA_URL, SUPA_KEY, {auth:{persistSession:true, autoRefreshToken:true}})
                    : null;

  if(!supa){
    whoEl.textContent = 'âš ï¸ æ‰¾ä¸åˆ° Supabase é€£ç·šï¼ˆBW.supa ä¸å­˜åœ¨ï¼Œä¸”æœªæä¾› SUPABASE_URL / SUPABASE_ANON_KEYï¼‰';
    log('è«‹æ–¼å…¨ç«™å…±ç”¨çš„ supa.js æš´éœ² BW.supaï¼Œæˆ–æ–¼æœ¬æª”é ‚ç«¯æ³¨å…¥ SUPABASE_URL / SUPABASE_ANON_KEYã€‚', true);
  }

  // é¡¯ç¤ºç›®å‰ç™»å…¥è€…
  (async ()=>{
    try{
      const { data:{ session } } = await supa.auth.getSession();
      if(!session){
        whoEl.innerHTML = 'æœªç™»å…¥ Â· <span class="pill">è«‹å…ˆç™»å…¥</span>';
        return;
      }
      const uid = session.user.id;
      const em  = session.user.email;
      // æŸ¥ admin
      const { data: prof, error } = await supa.from('profiles').select('is_admin').eq('id', uid).maybeSingle();
      const isAdmin = (prof?.is_admin === true);
      whoEl.innerHTML = `${em} Â· <span class="pill">${isAdmin?'admin':'user'}</span>`;
    }catch(e){
      whoEl.textContent = 'è®€å–ç™»å…¥è³‡è¨Šå¤±æ•—';
    }
  })();

  // æ‹–æ‹‰ UXï¼ˆç°¡åŒ–ï¼‰
  const drop = document.getElementById('drop');
  drop.addEventListener('dragover', e=>{e.preventDefault(); drop.style.background='#fff';});
  drop.addEventListener('dragleave', e=>{drop.style.background='#fafafa';});
  drop.addEventListener('drop', e=>{
    e.preventDefault();
    drop.style.background='#fafafa';
    const f = e.dataTransfer.files?.[0];
    if(f) document.getElementById('fileMP4').files = e.dataTransfer.files;
  });

  btnCheck.addEventListener('click', async ()=>{
    await quickCheck();
  });

  btnUpload.addEventListener('click', async ()=>{
    btnUpload.disabled = true;
    try{
      await doUploadFlow();
    }finally{
      btnUpload.disabled = false;
    }
  });

  function log(msg, isErr=false){
    const t = `[${new Date().toLocaleTimeString()}] ${msg}`;
    logEl.innerHTML = (isErr? `<span class="bad">${t}</span>` : t) + '\n' + logEl.innerHTML;
    console[(isErr?'error':'log')](msg);
  }

  async function quickCheck(){
    const { data:{ session } } = await supa.auth.getSession();
    if(!session){ log('å°šæœªç™»å…¥ï¼ˆsession=nullï¼‰', true); return; }
    const uid = session.user.id;
    const em  = session.user.email;
    const { data: prof } = await supa.from('profiles').select('is_admin').eq('id', uid).maybeSingle();
    log(`ç›®å‰ä½¿ç”¨è€…ï¼š${em} / ${uid} Â· is_admin=${prof?.is_admin===true}`);
  }

  function cleanSlug(s){
    return String(s||'').trim().toLowerCase().replace(/[^\w\-]+/g,'-').replace(/-{2,}/g,'-').replace(/^-+|-+$/g,'');
  }

  async function doUploadFlow(){
    const cat   = document.getElementById('category').value;
    const slugI = document.getElementById('slug').value;
    const title = document.getElementById('title').value.trim();
    const isPub = document.getElementById('vis').value === 'true';
    const fMp4  = document.getElementById('fileMP4').files[0];
    const fCov  = document.getElementById('fileCover').files[0];

    let slug = cleanSlug(slugI);
    if(!slug){ log('è«‹è¼¸å…¥åˆæ³•çš„ slugï¼ˆè‹±æ•¸èˆ‡ - _ï¼‰', true); return; }
    if(!fMp4){ log('è«‹é¸æ“‡ MP4 æª”', true); return; }

    // å–å¾— session / token / anon key
    const { data:{ session } } = await supa.auth.getSession();
    if(!session){ log('å°šæœªç™»å…¥ï¼Œç„¡æ³•ä¸Šå‚³ã€‚', true); return; }
    const accessToken = session.access_token;
    const anonKey     = SUPA_KEY || window.BW?.SUPABASE_ANON_KEY || '';

    const videoPath = `videos/${cat}/${slug}.mp4`;
    const coverPath = `assets/${cat}/${slug}/cover.jpg`;

    log(`é–‹å§‹ä¸Šå‚³ï¼š${videoPath}`);
    const up1 = await uploadWithFallback('videos', videoPath, fMp4, accessToken, anonKey);
    if(!up1.ok){ log(`å½±ç‰‡ä¸Šå‚³å¤±æ•—ï¼š${up1.message}`, true); return; }
    const publicVideoUrl = supa.storage.from('videos').getPublicUrl(videoPath).data.publicUrl;
    log(`âœ… å½±ç‰‡ OK â†’ ${publicVideoUrl}`);

    let publicCoverUrl = null;
    if(fCov){
      log(`ä¸Šå‚³å°é¢ï¼š${coverPath}`);
      const up2 = await uploadWithFallback('assets', coverPath, fCov, accessToken, anonKey);
      if(!up2.ok){ log(`å°é¢ä¸Šå‚³å¤±æ•—ï¼š${up2.message}`, true); return; }
      publicCoverUrl = supa.storage.from('assets').getPublicUrl(coverPath).data.publicUrl;
      log(`âœ… å°é¢ OK â†’ ${publicCoverUrl}`);
    }else{
      log('ç•¥éå°é¢ï¼ˆæœªé¸æ“‡æª”æ¡ˆï¼‰');
    }

    // å¯«å…¥è³‡æ–™è¡¨ public.videos
    const row = {
      category: cat,
      slug,
      title: title || null,
      storage_path: videoPath,
      cover_path: fCov ? coverPath : null,
      size_bytes: fMp4.size || null,
      duration_sec: null, // è‹¥éœ€ï¼Œå¯åœ¨å¾Œç«¯æˆ–æ—¥å¾Œè£œç®—
      is_public: isPub
    };
    log('å¯«å…¥è³‡æ–™è¡¨ public.videosâ€¦');
    const { data: ins, error: insErr } = await supa.from('videos').insert(row).select().maybeSingle();
    if(insErr){ log(`è³‡æ–™è¡¨ insert å¤±æ•—ï¼š${insErr.message}`, true); return; }
    log(`ğŸŸ¢ å¯«å…¥å®Œæˆï¼ˆvideos.id=${ins?.id || '(ç„¡å›å‚³ id)'}ï¼‰\nå½±ç‰‡ï¼š${publicVideoUrl}\nå°é¢ï¼š${publicCoverUrl || '(ç„¡)'}\n`);

    alert('ä¸Šå‚³èˆ‡å¯«å…¥å®Œæˆï¼');
  }

  // å…ˆèµ° SDKï¼›è‹¥é‡ RLS å ±éŒ¯ï¼Œå† fallback èµ° REST ç›´å‚³ï¼ˆå¸¶ Bearer èˆ‡ apikeyï¼‰
  async function uploadWithFallback(bucket, path, file, accessToken, anonKey){
    // 1) SDK
    try{
      const { error } = await supa.storage.from(bucket).upload(path, file, {
        upsert: true,
        contentType: file.type || 'application/octet-stream'
      });
      if(!error){
        return { ok:true };
      }
      const msg = error.message || String(error);
      // åªæœ‰é‡åˆ° RLS æ‰é€² fallback
      if(/row-level security/i.test(msg) || /RLS/i.test(msg) || /permission/i.test(msg)){
        log(`SDK ä¸Šå‚³è¢« RLS æ“‹ä½ï¼Œæ”¹ç”¨ REST ç›´å‚³â€¦`);
      }else{
        return { ok:false, message: msg };
      }
    }catch(e){
      // SDK ä¾‹å¤– â†’ è©¦è©¦ REST
      log(`SDK ä¸Šå‚³ä¾‹å¤–ï¼š${e?.message || e}`);
    }

    // 2) REST
    try{
      const url = `${SUPA_URL || window.BW?.SUPABASE_URL}/storage/v1/object/${encodeURIComponent(bucket)}/${encodeURIComponent(path)}`;
      const res = await fetch(url, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${accessToken}`,
          'apikey': anonKey,
          'Content-Type': file.type || 'application/octet-stream',
        },
        body: file
      });
      if(!res.ok){
        const txt = await res.text().catch(()=>res.statusText);
        return { ok:false, message: `HTTP ${res.status} ${txt}` };
      }
      return { ok:true };
    }catch(e){
      return { ok:false, message: e?.message || String(e) };
    }
  }
})();
</script>
</body>
</html>


