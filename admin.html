<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin · 三分頁 · v20251108-clean-singleEdge</title>
  <style>
    :root{ --bg:#fff; --fg:#111; --muted:#6b7280; --line:#e5e7eb; --brand:#2563eb; --ok:#16a34a; --warn:#f59e0b; --card:#fafafa;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"PingFang TC","Noto Sans TC","微軟正黑體",sans-serif}
    header{padding:18px 20px;border-bottom:1px solid var(--line);display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .title{font-size:22px;font-weight:700;margin-right:auto}
    .chip{padding:.35rem .6rem;border-radius:999px;background:#eef2ff;color:#1d4ed8;font-size:12px}
    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab-btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:.5rem 1rem;cursor:pointer}
    .tab-btn.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    .wrap{max-width:1100px;margin:22px auto;padding:0 16px}
    .row{display:grid;gap:14px}
    .grid-2{grid-template-columns: 1fr 1fr}
    @media (max-width:1100px){ .grid-2{grid-template-columns:1fr} }
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px}
    .input, select, textarea{border:1px solid var(--line);border-radius:10px;padding:.6rem .8rem;background:#fff}
    textarea{height:240px;resize:vertical;white-space:pre-wrap;overflow:auto}
    .btn{border:1px solid var(--brand);background:var(--brand);color:#fff;border-radius:10px;padding:.55rem .9rem;cursor:pointer}
    .btn.outline{background:#fff;color:var(--brand)}
    .hint{color:#6b7280;font-size:13px}
    .progress{height:10px;background:#eef2ff;border-radius:99px;overflow:hidden}
    .bar{height:100%;width:0;background:#2563eb;transition:width .2s}
    .pill{display:inline-block;padding:.2rem .5rem;border-radius:999px;border:1px solid var(--line);font-size:12px}
    .pill.ok{color:#16a34a;border-color:#16a34a} .pill.warn{color:#f59e0b;border-color:#f59e0b}
    /* Accordion */
    .acc{border:1px solid var(--line);border-radius:12px;background:#f8fafc}
    .acc .hd{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;cursor:pointer;user-select:none}
    .acc .hd h4{margin:0;font-size:14px}
    .acc .bd{padding:12px;display:block}
    .acc.collapsed .bd{display:none}
    .chev{width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:7px solid #6b7280;transition:transform .2s}
    .acc.collapsed .chev{transform:rotate(-90deg)}
    .stack{display:grid;gap:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0 12px}
    .table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
    .table th,.table td{padding:.7rem .8rem;border-bottom:1px solid var(--line);text-align:left}
    .table th{background:var(--card);font-weight:600}
    .right{display:flex;gap:10px;align-items:center;justify-content:flex-end}
    .muted{color:#6b7280}
    code.k{background:#f3f4f6;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <header>
    <div class="title">BookWide Admin 主控台</div>
    <span class="chip">三分頁 · 單一 Edge 機翻 · v20251108</span>
    <nav class="tabs">
      <button class="tab-btn active" data-tab="users">使用者清單</button>
      <button class="tab-btn" data-tab="roles">授權 / 暫停管理員</button>
      <button class="tab-btn" data-tab="mp4">MP4 上傳</button>
    </nav>
  </header>

  <main class="wrap">
    <section id="panel-users">
      <div class="toolbar">
        <input id="q" class="input" style="min-width:260px" placeholder="搜尋 Email / 顯示名稱…" />
        <button id="btnRefresh" class="btn outline">重新整理</button>
        <span class="hint">資料表：public.profiles · 台灣時區顯示 · 10 分鐘內視為「在線」。</span>
      </div>
      <table class="table" id="usersTable">
        <thead><tr><th>Email</th><th>顯示名稱</th><th>最後登入</th><th>最近在線</th><th>管理員</th><th>狀態</th><th>到期日</th></tr></thead>
        <tbody><tr><td colspan="7" class="hint">（此區保留；若你需要連 Supabase，請在下方接入 supa.js）</td></tr></tbody>
      </table>
    </section>

    <section id="panel-roles" style="display:none">
      <div class="card">
        <div class="row grid-2">
          <div><label class="hint">Email</label><input id="roleEmail" class="input" placeholder="user@example.com"></div>
          <div>
            <label class="hint">動作</label>
            <select id="roleAction" class="input">
              <option value="grant-admin">授予管理員</option>
              <option value="revoke-admin">移除管理員</option>
              <option value="pause">暫停登入</option>
              <option value="unpause">解除暫停</option>
            </select>
          </div>
        </div>
        <div class="right" style="margin-top:10px"><button id="btnApplyRole" class="btn">套用</button></div>
        <div class="hint" style="margin-top:6px">（此區保留；實作依你現場 supa.js 與資料表欄位）</div>
      </div>
    </section>

    <section id="panel-mp4" style="display:none">
      <div class="row grid-2">
        <div class="card">
          <h3 style="margin:6px 0 14px">MP4 上傳自動化（含字幕匯入、JSON 預覽）</h3>

          <div class="row grid-2">
            <div>
              <label class="hint">分類</label>
              <select id="cat" class="input"><option>story</option><option selected>music</option><option>movie</option><option>news</option><option>pro</option></select>
            </div>
            <div><label class="hint">Slug</label><input id="slug" class="input" placeholder="applesong"></div>
          </div>

          <div class="row grid-2" style="margin-top:8px">
            <div><label class="hint">顯示標題（可空）</label><input id="title" class="input" placeholder="A Little Love"></div>
            <div><label class="hint">吸附窗（s）</label><input id="snapWin" class="input" type="number" step="0.05" value="0.25"></div>
          </div>

          <div class="row grid-2" style="margin-top:8px">
            <div><label class="hint">MP4 檔</label><input id="mp4File" type="file" accept="video/mp4" class="input"></div>
            <div><label class="hint">封面（建議 JPG）</label><input id="coverFile" type="file" accept="image/*" class="input"></div>
          </div>
          <div style="margin-top:8px"><label class="hint">字幕（.txt / .srt / .vtt / .json）</label><input id="subFile" type="file" accept=".txt,.srt,.vtt,.json" class="input" style="width:100%"></div>

          <div class="row grid-2" style="margin-top:10px">
            <div>
              <label class="hint">中/日 產生模式</label>
              <div style="display:flex;gap:12px;align-items:center;margin-top:6px">
                <label style="display:flex;gap:6px;align-items:center"><input id="modeMT" type="radio" name="mtmode" checked> Edge Function（機翻）</label>
                <label style="display:flex;gap:6px;align-items:center"><input id="modeSimple" type="radio" name="mtmode"> 簡易（只產 en）</label>
              </div>
            </div>
            <div>
              <label class="hint">Edge Function 名稱（已固定）</label>
              <input id="edgeFn" class="input" value="mt-translate" readonly>
              <div class="hint" style="margin-top:6px">Functions 連線：<code id="fnBase" class="k">未偵測</code>　<button class="btn outline" id="btnTestFn" style="padding:.25rem .6rem">測試</button> <span id="fnMsg" class="hint"></span></div>
            </div>
          </div>

          <div class="right" style="margin-top:10px;gap:8px">
            <button class="btn outline" id="btnCollapseAll">全部收合</button>
            <button class="btn outline" id="btnExpandAll">全部展開</button>
            <button class="btn" id="btnPreview">預覽 JSON（5 件）</button>
          </div>

          <div class="stack" style="margin-top:10px">
            <div class="acc" id="accIndex">
              <div class="hd"><h4>index-<span id="fnSlug1">slug</span>.json（影片資訊）</h4><div class="chev"></div></div>
              <div class="bd"><textarea id="boxIndex" placeholder="index-<slug>.json 預覽"></textarea></div>
            </div>
            <div class="acc" id="accCues">
              <div class="hd"><h4>cues-<span id="fnSlug2">slug</span>.json（三語字幕）</h4><div class="chev"></div></div>
              <div class="bd"><textarea id="boxCues" placeholder="cues-*.json"></textarea></div>
            </div>
            <div class="acc" id="accQuiz">
              <div class="hd"><h4>quiz-<span id="fnSlug3">slug</span>.json（80 題）</h4><div class="chev"></div></div>
              <div class="bd"><textarea id="boxQuiz" placeholder="quiz-*.json"></textarea></div>
            </div>
            <div class="acc" id="accVocab">
              <div class="hd"><h4>vocab-<span id="fnSlug4">slug</span>.json（20 詞：英/中/日/定義/例句）</h4><div class="chev"></div></div>
              <div class="bd"><textarea id="boxVocab" placeholder="vocab-*.json"></textarea></div>
            </div>
            <div class="acc" id="accAI">
              <div class="hd"><h4>ai-<span id="fnSlug5">slug</span>.json（AI 問答模板 15 題）</h4><div class="chev"></div></div>
              <div class="bd"><textarea id="boxAI" placeholder="ai-*.json"></textarea></div>
            </div>
          </div>

          <div class="hint" style="margin-top:10px">字幕：.txt 視為「每行一句」；.srt/.vtt 會解析時間。三語同檔格式：<code>[{ time, en, ja, zh }]</code>。</div>
          <div id="edgeLog" class="hint" style="margin-top:10px;white-space:pre-wrap;background:#f9fafb;border:1px dashed #d1d5db;padding:10px;border-radius:8px"></div>
        </div>

        <div class="card">
          <h3 style="margin:6px 0 14px">Supabase 上傳（影片＋封面）</h3>
          <div class="hint muted">（此區保留；你可依現場 supa.js 接回上傳邏輯）</div>

          <div style="margin:16px 0;height:1px;background:var(--line)"></div>

          <h3 style="margin:6px 0 10px">GitHub 上傳（5 件 JSON）</h3>
          <div class="hint muted">（此區保留；你目前先手動上傳 GitHub）</div>
        </div>
      </div>
    </section>
  </main>

  <footer style="padding:22px 20px;border-top:1px solid var(--line);text-align:center;color:#6b7280">BookWide Admin · v20251108-clean-singleEdge</footer>

  <script>
    document.querySelectorAll('.tab-btn').forEach(b=>{
      b.addEventListener('click',()=>{
        document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        const t=b.getAttribute('data-tab');
        document.getElementById('panel-users').style.display = (t==='users')?'':'none';
        document.getElementById('panel-roles').style.display = (t==='roles')?'':'none';
        document.getElementById('panel-mp4').style.display   = (t==='mp4')  ?'':'none';
      });
    });
    document.getElementById('btnCollapseAll').addEventListener('click',()=>{
      document.querySelectorAll('.acc').forEach(a=>a.classList.add('collapsed'));
    });
    document.getElementById('btnExpandAll').addEventListener('click',()=>{
      document.querySelectorAll('.acc').forEach(a=>a.classList.remove('collapsed'));
    });
    const $=(q,r=document)=>r.querySelector(q);
    const $$=(q,r=document)=>Array.from(r.querySelectorAll(q));
    function setSlugLabels(slug){ ['fnSlug1','fnSlug2','fnSlug3','fnSlug4','fnSlug5'].forEach(id=>{ const el=$('#'+id); if(el) el.textContent=slug||'slug'; }); }
    function mmss(i, step=4){ const s=i*step; const m=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${m}:${ss}`; }
    async function parseSubtitleFile(file){
      if(!file) return [];
      const name=file.name.toLowerCase();
      const text=await file.text();
      if(name.endsWith('.json')){
        try{ const arr=JSON.parse(text); if(Array.isArray(arr)&&arr.length&&('time' in arr[0])) return arr.map(x=>({time:x.time,en:x.en||'',ja:x.ja||'',zh:x.zh||''})); }catch(e){}
      }
      if(name.endsWith('.srt')||name.endsWith('.vtt')){
        const lines=text.replace(/\\r/g,'').split('\\n');
        const out=[]; let cur=null;
        const timeRe=/(\\d\\d:\\d\\d:\\d\\d)[,\\.](\\d\\d\\d)\\s*-->\\s*(\\d\\d:\\d\\d:\\d\\d)[,\\.](\\d\\d\\d)/;
        for(const ln of lines){
          const m=timeRe.exec(ln);
          if(m){ cur={time:m[1].slice(0,5), en:''}; continue; }
          if(!ln.trim()){ if(cur){ out.push({...cur,ja:'',zh:''}); cur=null; } }
          else if(cur){ cur.en = (cur.en?cur.en+' ':'') + ln.trim(); }
        }
        if(cur) out.push({...cur,ja:'',zh:''});
        return out;
      }
      const arr=text.split(/\\r?\\n/).map(s=>s.trim()).filter(Boolean);
      return arr.map((line,i)=>({ time:mmss(i), en:line, ja:'', zh:'' }));
    }
    function detectFunctionsBase(){
      const nodes=$$('a, code, pre, input, textarea, div, span');
      for(const n of nodes){
        const raw=(n.value ?? n.textContent ?? '').trim();
        const m=raw.match(/https:\\/\\/[a-z0-9\\-\\.]+functions\\.supabase\\.co/);
        if(m) return m[0].replace(/\\/+$/,'')+'/functions/v1';
      }
      return '';
    }
    async function callEdgeTranslate(lines, to=['zh','ja']){
      const base=detectFunctionsBase();
      const fnName='mt-translate';
      if(!base) throw new Error('未偵測到 Functions 連線（*.functions.supabase.co）。');
      const url=`${base}/${fnName}`;
      const res=await fetch(url,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({lines,to})
      });
      let data=null; try{ data=await res.json(); }catch(e){ throw new Error(`Edge 回應非 JSON（HTTP ${res.status}）`); }
      if(!res.ok){ const msg=data?.error?.message || data?.message || JSON.stringify(data); throw new Error(`Edge 失敗（HTTP ${res.status}）：${msg}`); }
      const results = data?.results || data?.data?.results || [];
      if(!Array.isArray(results)) throw new Error('Edge 回傳無 results 陣列');
      return {results, raw:data};
    }
    document.getElementById('btnTestFn').addEventListener('click', async ()=>{
      const sub=$('#subFile').files[0];
      const log=$('#fnMsg'); const log2=$('#edgeLog');
      log.textContent='測試中…'; log2.textContent='';
      try{
        const cuesEN=await parseSubtitleFile(sub);
        const enLines=cuesEN.map(x=>x.en);
        const {results, raw}=await callEdgeTranslate(enLines,['zh','ja']);
        const zh=results.find(r=>r.lang==='zh')?.lines||[];
        const ja=results.find(r=>r.lang==='ja')?.lines||[];
        log.textContent='OK';
        log2.textContent=`✔ Edge 成功
—— 原始行數：${enLines.length}
—— zh 前 2 行：${(zh.slice(0,2)).join(' / ')}
—— ja 前 2 行：${(ja.slice(0,2)).join(' / ')}
${raw?.totalUSD ? '成本(估) USD '+raw.totalUSD : ''}`;
        window.__BW_EDGE_RES__={ zh, ja };
      }catch(e){
        log.textContent='失敗'; $('#edgeLog').textContent='✖ '+(e.message||e);
      }
    });
    document.getElementById('btnPreview').addEventListener('click', async ()=>{
      const cat=$('#cat').value.trim(), slug=$('#slug').value.trim(), title=$('#title').value.trim();
      setSlugLabels(slug);
      const sub=$('#subFile').files[0];
      const cuesEN=await parseSubtitleFile(sub);
      const zh=(window.__BW_EDGE_RES__?.zh)||[];
      const ja=(window.__BW_EDGE_RES__?.ja)||[];
      const cues=cuesEN.map((x,i)=>({...x, zh: zh[i]||x.zh||'', ja: ja[i]||x.ja||''}));
      const index = { slug, title, video:`videos/${cat}/${slug}.mp4`, cover:`assets/${cat}/${slug}/cover.jpg`, category:cat, updatedAt:new Date().toISOString() };
      const topics = Array.from({length:20},(_,i)=>({title:`Topic ${i+1}`,prompt:"",hint:"",sample:""}));
      const quiz = { title:"Lesson", topics };
      const vocab20 = Array.from({length:20},(_,i)=>({ en:`word${i+1}`, zh: zh[i]||"", ja: ja[i]||"", def_en:"", example_en:"" }));
      const ai = { tasks: Array.from({length:15},(_,i)=>({q:`Question ${i+1}`,a:""})) };
      $('#boxIndex').value = JSON.stringify(index, null, 2);
      $('#boxCues').value  = JSON.stringify(cues,  null, 2);
      $('#boxQuiz').value  = JSON.stringify(quiz,  null, 2);
      $('#boxVocab').value = JSON.stringify({words:vocab20}, null, 2);
      $('#boxAI').value    = JSON.stringify(ai,    null, 2);
    });
    $('#slug').addEventListener('input', e=> setSlugLabels(e.target.value.trim()));
  </script>
</body>
</html>

















































































































































































