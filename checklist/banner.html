<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>首頁廣告管理（輪播 / A-B）｜BookWide Admin</title>
  <style>
    :root{
      --bg:#f4f6fb;
      --card:#fff;
      --muted:#6b7280;
      --border:#e5e7eb;
      --brand:#2563eb;
      --brand-soft:#e0edff;
      --danger:#b91c1c;
      --ok:#15803d;
      --radius:18px;
      --shadow:0 10px 30px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC","Microsoft JhengHei",sans-serif;
      background:var(--bg);
      color:#111827;
    }
    a{color:inherit;text-decoration:none;}
    .wrap{max-width:1180px;margin:24px auto 80px;padding:0 16px 40px;}
    header{
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-end;
      margin-bottom:14px;
    }
    .title{font-size:1.35rem;font-weight:800;}
    .subtitle{font-size:.9rem;color:var(--muted);margin-top:4px;line-height:1.5}
    .tag{
      display:inline-flex;padding:3px 9px;border-radius:999px;
      background:var(--brand-soft);color:#1e40af;font-size:.78rem;margin-left:6px;
    }
    .right{display:flex;flex-direction:column;gap:6px;align-items:flex-end}
    .admin-mail{font-size:.8rem;color:#6b7280;}
    .back-link{font-size:.85rem;color:var(--brand);cursor:pointer}

    .grid{display:grid;grid-template-columns:minmax(0,1.25fr) minmax(0,1fr);gap:16px;align-items:start;}
    @media(max-width:980px){ .grid{grid-template-columns:1fr;} }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px 16px 14px;
    }
    .card h3{margin:0 0 8px;font-size:1rem}
    .card .hint{color:var(--muted);font-size:.82rem;line-height:1.5;margin-bottom:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    label{font-size:.82rem;color:#374151}
    input[type="text"], input[type="number"], input[type="url"], input[type="datetime-local"], select, textarea{
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px 10px;
      font-size:.9rem;
      font-family:inherit;
      background:#fff;
      width:100%;
    }
    textarea{min-height:72px;resize:vertical;}
    .col{flex:1;min-width:220px}
    .col.sm{min-width:140px;max-width:200px}
    .col.xs{min-width:110px;max-width:140px}
    .col.full{flex:1 1 100%}

    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:6px;
      padding:8px 14px;border-radius:999px;border:1px solid var(--brand);
      background:var(--brand);color:#fff;font-size:.85rem;cursor:pointer;
    }
    .btn.secondary{background:#fff;color:var(--brand);}
    .btn.danger{background:#fff;color:var(--danger);border-color:var(--danger);}
    .btn.small{padding:6px 10px;font-size:.78rem}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .status{font-size:.8rem;color:var(--muted);min-height:1em;margin-top:6px}
    .status.ok{color:var(--ok)}
    .status.err{color:var(--danger)}

    .list{
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
    }
    .list-head, .list-row{
      display:grid;
      grid-template-columns: 38px 54px 90px 86px 1.4fr 1fr 90px 92px 92px;
      gap:8px;
      align-items:center;
      padding:10px 10px;
    }
    .list-head{
      background:#0f172a;color:#e5e7eb;font-size:.78rem;font-weight:700;
    }
    .list-row{
      background:#fff;border-top:1px solid var(--border);font-size:.85rem;
    }
    .list-row.active{background:#f8fafc}
    .list-row .muted{color:var(--muted);font-size:.78rem}
    .pill{
      display:inline-flex;align-items:center;justify-content:center;
      padding:2px 8px;border-radius:999px;border:1px solid var(--border);
      font-size:.78rem;background:#fff;color:#374151;
      width:max-content;
    }
    .pill.on{background:#dcfce7;border-color:#86efac;color:#166534}
    .pill.off{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}
    .mini-actions{display:flex;gap:6px;justify-content:flex-end}
    .mini-actions button{
      width:30px;height:30px;border-radius:10px;border:1px solid var(--border);
      background:#fff;cursor:pointer;
    }
    .mini-actions button:hover{background:#f3f4f6}
    .selrow{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .selrow .chip{
      background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;
      font-size:.78rem;border-radius:999px;padding:3px 10px;
    }

    .preview{
      border-radius:14px;border:1px solid var(--border);overflow:hidden;background:#000;
      margin-bottom:10px;
    }
    .preview video,.preview img{display:block;width:100%;height:auto}
    .caption{
      padding:9px 10px;background:#0f172a;color:#e5e7eb;font-size:.82rem;line-height:1.45
    }
    pre{
      background:#0b1120;color:#e5e7eb;font-size:.78rem;padding:10px;border-radius:12px;
      overflow:auto;max-height:360px;line-height:1.5;white-space:pre;
      border:1px solid rgba(255,255,255,.06);
    }
    footer{margin-top:14px;text-align:right;color:var(--muted);font-size:.78rem}
    code{background:#f1f5f9;padding:1px 6px;border-radius:8px}
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div>
      <div class="title">首頁廣告管理 <span class="tag">Hero 輪播 / Dots / Swipe / A-B</span></div>
      <div class="subtitle">
        這頁會產出 <code>data/hero-banner.json</code>（v2 結構），讓首頁自動輪播（含 dots + swipe）；
        支援排序 / 啟用停用 / 排程（start/end）/ 權重 / A/B Test。
      </div>
      <div class="back-link" onclick="location.href='/admin.html'">← 回 Admin 首頁</div>
    </div>
    <div class="right">
      <div class="admin-mail">管理員：<span id="adminEmail">檢查中…</span></div>
      <div class="status" id="authStatus"></div>
    </div>
  </header>

  <div class="grid">
    <!-- LEFT: list + editor -->
    <section class="card">
      <h3>1) Banner 清單（排序 / 啟用 / A-B）</h3>
      <div class="hint">點選一列進入編輯。排序：↑↓；啟用：Enabled；A/B：Variant。權重 Weight 越高出現機率越高。</div>

      <div class="row" style="justify-content:space-between">
        <div class="selrow">
          <span class="chip">輪播間隔（ms）</span>
          <input id="intervalMs" type="number" value="6000" min="2500" step="500" style="width:140px">
          <span class="chip">A/B</span>
          <select id="abEnabled" style="width:130px">
            <option value="1" selected>啟用</option>
            <option value="0">停用</option>
          </select>
          <span class="chip">強制預覽</span>
          <select id="forceVariant" style="width:130px">
            <option value="">（不強制）</option>
            <option value="A">只看 A</option>
            <option value="B">只看 B</option>
          </select>
          <button class="btn secondary small" id="btnLoadDraft" type="button">載入草稿</button>
          <button class="btn secondary small" id="btnSaveDraft" type="button">存草稿</button>
        </div>
        <div class="selrow">
          <button class="btn small" id="btnAdd" type="button">＋新增 Banner</button>
        </div>
      </div>

      <div class="list" id="list">
        <div class="list-head">
          <div>#</div><div>啟用</div><div>Variant</div><div>Type</div><div>Title</div><div>Media</div><div>Weight</div><div>排程</div><div style="text-align:right">操作</div>
        </div>
        <div id="listBody"></div>
      </div>

      <hr style="border:none;border-top:1px solid var(--border);margin:14px 0;">

      <h3>2) 編輯選取 Banner</h3>
      <div class="hint">支援：圖片 / 影片（可上傳到 Supabase ads/home/）。影片 autoplay 預設關閉（避免首頁吵）。</div>

      <div class="row">
        <div class="col xs">
          <label>Enabled</label>
          <select id="fEnabled">
            <option value="1" selected>啟用</option>
            <option value="0">停用</option>
          </select>
        </div>
        <div class="col xs">
          <label>Variant</label>
          <select id="fVariant">
            <option value="ALL" selected>ALL</option>
            <option value="A">A</option>
            <option value="B">B</option>
          </select>
        </div>
        <div class="col xs">
          <label>Type</label>
          <select id="fType">
            <option value="image" selected>image</option>
            <option value="video">video</option>
          </select>
        </div>
        <div class="col xs">
          <label>Weight</label>
          <input id="fWeight" type="number" min="1" step="1" value="100">
        </div>
        <div class="col xs" id="autoWrap" style="display:none">
          <label>Video autoplay</label>
          <select id="fVideoAutoplay">
            <option value="0" selected>否</option>
            <option value="1">是（muted/loop）</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Title</label>
          <input id="fTitle" type="text" placeholder="例如：今日精選">
        </div>
        <div class="col">
          <label>Subtitle</label>
          <input id="fSubtitle" type="text" placeholder="例如：熱門故事全新上線">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>CTA Text</label>
          <input id="fCtaText" type="text" placeholder="例如：立即開始">
        </div>
        <div class="col">
          <label>CTA Link</label>
          <input id="fCtaLink" type="text" placeholder="例如：player.html?cat=story&slug=mid-autumn">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Media URL（image 或 video）</label>
          <input id="fMediaUrl" type="url" placeholder="https://.../ads/home/xxx.png 或 .mp4">
        </div>
        <div class="col">
          <label>Poster URL（選填：影片封面 / 圖片可同 media）</label>
          <input id="fPosterUrl" type="url" placeholder="https://.../ads/home/xxx.png">
        </div>
      </div>

      <div class="row">
        <div class="col sm">
          <label>Slug（上傳用，無副檔名）</label>
          <input id="fSlug" type="text" placeholder="home-hero-a">
        </div>
        <div class="col sm">
          <label>Start（選填）</label>
          <input id="fStartAt" type="datetime-local">
        </div>
        <div class="col sm">
          <label>End（選填）</label>
          <input id="fEndAt" type="datetime-local">
        </div>
        <div class="col" style="min-width:260px">
          <label>快速上傳（Supabase ads/home/）</label>
          <div class="row" style="margin:6px 0 0">
            <input id="fileMedia" type="file" style="flex:1;min-width:220px" />
            <button class="btn small" id="btnUploadMedia" type="button">上傳 Media</button>
          </div>
          <div class="row" style="margin:6px 0 0">
            <input id="filePoster" type="file" accept="image/*" style="flex:1;min-width:220px" />
            <button class="btn small" id="btnUploadPoster" type="button">上傳 Poster</button>
          </div>
          <div class="status" id="uploadStatus"></div>
        </div>
      </div>

      <div class="row" style="justify-content:space-between">
        <div class="selrow">
          <button class="btn secondary" id="btnApply" type="button">套用到清單</button>
          <button class="btn danger" id="btnDelete" type="button">刪除這筆</button>
        </div>
        <div class="selrow">
          <button class="btn secondary" id="btnRefreshPreview" type="button">更新預覽</button>
          <button class="btn" id="btnDownloadJson" type="button">下載 hero-banner.json</button>
        </div>
      </div>

      <div class="status" id="formStatus"></div>
    </section>

    <!-- RIGHT: preview + json -->
    <section class="card">
      <h3>3) 預覽（右側）</h3>
      <div class="hint">
        預覽只顯示「目前選取」那一筆。若要看 A/B，請用上方「強制預覽」切換。
      </div>

      <div class="preview">
        <video id="pvVideo" controls style="display:none"></video>
        <img id="pvImg" alt="preview" style="display:none">
        <div class="caption" id="pvCap">（尚未選取 Banner）</div>
      </div>

      <h3>4) JSON（v2）</h3>
      <div class="hint">把下載的檔案放到 <code>EduEnglish/data/hero-banner.json</code> 覆蓋即可生效。</div>
      <pre id="jsonPreview">{}</pre>

      <footer>BookWide Admin · checklist/banner.html · v20260112-carousel</footer>
    </section>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
<script>
  // ===== Supabase =====
  const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
  const SUPABASE_ANON =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
  const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  const STORAGE_PUBLIC = "https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public";
  const BUCKET = "ads";
  const HOME_DIR = "home"; // ads/home/...

  // ===== Auth guard =====
  const DENY_SIGNIN = "/index.html?denied=signin";
  const DENY_ADMIN  = "/index.html?denied=admin";
  const DENY_PAUSED = "/index.html?denied=paused";
  const DENY_PROFILE= "/index.html?denied=profile";
  function kick(url){ try{ location.replace(url); }catch(e){ location.href=url; } }

  async function requireAdmin(){
    const { data: sess } = await supa.auth.getSession();
    const session = sess?.session;
    if (!session?.user) return kick(DENY_SIGNIN);

    const { data: profile, error } = await supa
      .from("profiles")
      .select("email,is_admin,is_paused")
      .eq("id", session.user.id)
      .maybeSingle();

    if (error || !profile) return kick(DENY_PROFILE);
    if (profile.is_paused) return kick(DENY_PAUSED);
    if (!profile.is_admin) return kick(DENY_ADMIN);

    document.getElementById("adminEmail").textContent = profile.email || session.user.email || "admin";
    document.getElementById("authStatus").textContent = "✅ Admin OK";
    document.getElementById("authStatus").className = "status ok";

    supa.auth.onAuthStateChange((_e, s) => { if (!s?.user) kick(DENY_SIGNIN); });
  }

  // ===== State =====
  let banners = [];
  let selected = -1;

  const defaultBanner = () => ({
    id: "hero-" + Date.now(),
    enabled: true,
    variant: "ALL",
    type: "image",
    title: "",
    subtitle: "",
    media_url: "",
    poster_url: "",
    cta_text: "",
    cta_link: "",
    weight: 100,
    video_autoplay: false,
    start_at: "",
    end_at: "",
    slug: ""
  });

  function ui(id){ return document.getElementById(id); }
  function setStatus(id, msg, cls){
    const el = ui(id); if(!el) return;
    el.textContent = msg || "";
    el.className = "status " + (cls||"");
  }

  function cfgV2(){
    const interval_ms = Math.max(2500, Number(ui("intervalMs").value||6000));
    const ab_on = ui("abEnabled").value === "1";
    return {
      version: 2,
      interval_ms,
      ab_test: { enabled: ab_on, variants: ["A","B"] },
      banners: banners.map(b => ({
        id: b.id,
        enabled: !!b.enabled,
        variant: (b.variant||"ALL"),
        type: (b.type||"image"),
        title: b.title || "",
        subtitle: b.subtitle || "",
        media_url: b.media_url || "",
        poster_url: b.poster_url || "",
        cta_text: b.cta_text || "",
        cta_link: b.cta_link || "",
        weight: Number(b.weight||100),
        video_autoplay: !!b.video_autoplay,
        start_at: b.start_at || "",
        end_at: b.end_at || ""
      }))
    };
  }

  function renderList(){
    const body = ui("listBody");
    body.innerHTML = "";

    banners.forEach((b, i) => {
      const row = document.createElement("div");
      row.className = "list-row" + (i===selected ? " active" : "");
      row.innerHTML = `
        <div>${i+1}</div>
        <div><span class="pill ${b.enabled?'on':'off'}">${b.enabled?'ON':'OFF'}</span></div>
        <div><span class="pill">${(b.variant||'ALL')}</span></div>
        <div><span class="pill">${(b.type||'image')}</span></div>
        <div>
          <div style="font-weight:700">${escapeHtml(b.title||'（無標題）')}</div>
          <div class="muted">${escapeHtml(b.subtitle||'')}</div>
        </div>
        <div class="muted" title="${escapeHtml(b.media_url||'')}">${escapeHtml(shortUrl(b.media_url))}</div>
        <div>${Number(b.weight||100)}</div>
        <div class="muted">${scheduleText(b)}</div>
        <div class="mini-actions">
          <button title="上移" data-act="up">↑</button>
          <button title="下移" data-act="down">↓</button>
          <button title="編輯" data-act="edit">✎</button>
        </div>
      `;
      row.addEventListener("click", (e) => {
        const act = e.target?.dataset?.act;
        if (act === "up") { move(i, -1); return; }
        if (act === "down") { move(i, +1); return; }
        select(i);
      });
      body.appendChild(row);
    });

    refreshJsonPreview();
  }

  function scheduleText(b){
    const s = b.start_at ? "S" : "—";
    const e = b.end_at ? "E" : "—";
    return `${s}/${e}`;
  }

  function shortUrl(u){
    if (!u) return "";
    try{
      const x = new URL(u);
      return x.pathname.split("/").slice(-2).join("/");
    }catch(e){
      return u.length>28 ? (u.slice(0,28)+"…") : u;
    }
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function move(i, delta){
    const j = i + delta;
    if (j < 0 || j >= banners.length) return;
    const tmp = banners[i];
    banners[i] = banners[j];
    banners[j] = tmp;
    selected = j;
    renderList();
    fillFormFromSelected();
    setStatus("formStatus","已重新排序。","ok");
  }

  function select(i){
    selected = i;
    renderList();
    fillFormFromSelected();
    refreshPreview();
  }

  function fillFormFromSelected(){
    const b = banners[selected];
    if (!b) return;

    ui("fEnabled").value = b.enabled ? "1" : "0";
    ui("fVariant").value = (b.variant||"ALL");
    ui("fType").value = (b.type||"image");
    ui("fWeight").value = Number(b.weight||100);
    ui("fVideoAutoplay").value = b.video_autoplay ? "1" : "0";
    ui("fTitle").value = b.title||"";
    ui("fSubtitle").value = b.subtitle||"";
    ui("fCtaText").value = b.cta_text||"";
    ui("fCtaLink").value = b.cta_link||"";
    ui("fMediaUrl").value = b.media_url||"";
    ui("fPosterUrl").value = b.poster_url||"";
    ui("fStartAt").value = b.start_at||"";
    ui("fEndAt").value = b.end_at||"";
    ui("fSlug").value = b.slug||"";

    ui("autoWrap").style.display = (b.type === "video") ? "block" : "none";
  }

  function applyFormToSelected(){
    const b = banners[selected];
    if (!b) return;

    b.enabled = ui("fEnabled").value === "1";
    b.variant = ui("fVariant").value;
    b.type = ui("fType").value;
    b.weight = Number(ui("fWeight").value||100);
    b.video_autoplay = ui("fVideoAutoplay").value === "1";

    b.title = ui("fTitle").value.trim();
    b.subtitle = ui("fSubtitle").value.trim();
    b.cta_text = ui("fCtaText").value.trim();
    b.cta_link = ui("fCtaLink").value.trim();
    b.media_url = ui("fMediaUrl").value.trim();
    b.poster_url = ui("fPosterUrl").value.trim();
    b.start_at = ui("fStartAt").value;
    b.end_at = ui("fEndAt").value;
    b.slug = ui("fSlug").value.trim();

    ui("autoWrap").style.display = (b.type === "video") ? "block" : "none";
  }

  function refreshJsonPreview(){
    const v = cfgV2();
    ui("jsonPreview").textContent = JSON.stringify(v, null, 2);
  }

  function refreshPreview(){
    const b = banners[selected];
    const force = ui("forceVariant").value;
    if (!b) {
      ui("pvCap").textContent = "（尚未選取 Banner）";
      ui("pvVideo").style.display = "none";
      ui("pvImg").style.display = "none";
      return;
    }
    if (force && (b.variant !== "ALL") && (b.variant !== force)) {
      ui("pvCap").textContent = `（此筆屬於 Variant ${b.variant}，你目前強制預覽 ${force}，所以略過）`;
      ui("pvVideo").style.display = "none";
      ui("pvImg").style.display = "none";
      return;
    }

    const v = ui("pvVideo"), img = ui("pvImg"), cap = ui("pvCap");
    v.pause?.(); v.removeAttribute("src");
    img.removeAttribute("src");
    v.style.display = "none"; img.style.display = "none";

    cap.innerHTML = `<b>${escapeHtml(b.title||"（無標題）")}</b><br>${escapeHtml(b.subtitle||"")}`;

    if (b.type === "video" && b.media_url) {
      v.src = b.media_url;
      if (b.poster_url) v.poster = b.poster_url;
      v.style.display = "block";
    } else if (b.media_url) {
      img.src = b.media_url;
      img.style.display = "block";
    }
  }

  // ===== Draft =====
  function saveDraft(){
    const draft = {
      interval_ms: ui("intervalMs").value,
      ab_enabled: ui("abEnabled").value,
      banners
    };
    try{
      localStorage.setItem("bwHeroDraft", JSON.stringify(draft));
      setStatus("formStatus","✅ 已存草稿（localStorage）。","ok");
    }catch(e){
      setStatus("formStatus","❌ 草稿儲存失敗（localStorage）。","err");
    }
  }
  function loadDraft(){
    try{
      const raw = localStorage.getItem("bwHeroDraft");
      if (!raw) { setStatus("formStatus","（沒有草稿）",""); return; }
      const d = JSON.parse(raw);
      ui("intervalMs").value = d.interval_ms || 6000;
      ui("abEnabled").value = d.ab_enabled ?? "1";
      banners = Array.isArray(d.banners) ? d.banners : [];
      if (!banners.length) banners = [defaultBanner()];
      selected = 0;
      renderList();
      fillFormFromSelected();
      refreshPreview();
      setStatus("formStatus","✅ 已載入草稿。","ok");
    }catch(e){
      setStatus("formStatus","❌ 草稿讀取失敗。","err");
    }
  }

  // ===== Download JSON =====
  function downloadJson(){
    const blob = new Blob([JSON.stringify(cfgV2(), null, 2)], {type:"application/json;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "hero-banner.json";
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
    setStatus("formStatus","✅ 已下載 hero-banner.json（請放到 /data/hero-banner.json）。","ok");
  }

  // ===== Upload =====
  async function uploadToSupabase(file, slug){
    const ext = (file.name.split(".").pop() || "").toLowerCase();
    const path = `${HOME_DIR}/${slug}.${ext}`;
    const { error } = await supa.storage.from(BUCKET).upload(path, file, { upsert:true, cacheControl:"3600" });
    if (error) throw error;
    return `${STORAGE_PUBLIC}/${BUCKET}/${path}`;
  }

  async function upload(kind){
    const b = banners[selected];
    if (!b) return;

    const slug = ui("fSlug").value.trim();
    if (!slug) return setStatus("uploadStatus","❌ 先填 Slug。","err");

    const input = (kind==="media") ? ui("fileMedia") : ui("filePoster");
    const file = input.files && input.files[0];
    if (!file) return setStatus("uploadStatus","❌ 請選檔案。","err");

    setStatus("uploadStatus","上傳中…","");

    try{
      const url = await uploadToSupabase(file, slug + (kind==="poster" ? "-poster" : ""));
      if (kind==="media") ui("fMediaUrl").value = url;
      else ui("fPosterUrl").value = url;

      setStatus("uploadStatus","✅ 上傳完成，已填入 URL。","ok");
    }catch(e){
      setStatus("uploadStatus","❌ 上傳失敗：" + (e?.message || e),"err");
    }
  }

  // ===== init =====
  ui("btnAdd").addEventListener("click", () => {
    const b = defaultBanner();
    banners.push(b);
    selected = banners.length - 1;
    renderList();
    fillFormFromSelected();
    refreshPreview();
    setStatus("formStatus","已新增一筆。","ok");
  });

  ui("btnApply").addEventListener("click", () => {
    if (selected < 0) return;
    applyFormToSelected();
    renderList();
    refreshPreview();
    setStatus("formStatus","✅ 已套用。","ok");
  });

  ui("btnDelete").addEventListener("click", () => {
    if (selected < 0) return;
    if (!confirm("確定刪除這筆？")) return;
    banners.splice(selected, 1);
    if (!banners.length) banners = [defaultBanner()];
    selected = Math.min(selected, banners.length - 1);
    renderList();
    fillFormFromSelected();
    refreshPreview();
    setStatus("formStatus","已刪除。","ok");
  });

  ui("btnRefreshPreview").addEventListener("click", () => {
    applyFormToSelected();
    refreshPreview();
    refreshJsonPreview();
    setStatus("formStatus","已更新預覽/JSON。","ok");
  });

  ui("btnDownloadJson").addEventListener("click", downloadJson);

  ui("btnSaveDraft").addEventListener("click", saveDraft);
  ui("btnLoadDraft").addEventListener("click", loadDraft);

  ui("btnUploadMedia").addEventListener("click", () => upload("media"));
  ui("btnUploadPoster").addEventListener("click", () => upload("poster"));

  ui("fType").addEventListener("change", () => {
    ui("autoWrap").style.display = (ui("fType").value === "video") ? "block" : "none";
  });

  ui("intervalMs").addEventListener("change", refreshJsonPreview);
  ui("abEnabled").addEventListener("change", refreshJsonPreview);

  ui("forceVariant").addEventListener("change", refreshPreview);

  function boot(){
    banners = [
      {
        id:"hero-1",
        enabled:true,
        variant:"ALL",
        type:"image",
        title:"今日精選",
        subtitle:"熱門故事全新上線",
        media_url:"https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/ads/home/home-hero.png",
        poster_url:"https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/ads/home/home-hero.png",
        cta_text:"立即開始",
        cta_link:"pricing.html",
        weight:100,
        video_autoplay:false,
        start_at:"",
        end_at:"",
        slug:"home-hero"
      }
    ];
    selected = 0;
    renderList();
    fillFormFromSelected();
    refreshPreview();
    setStatus("formStatus","（已載入預設 1 筆，可新增更多做輪播/A-B）","");
  }

  requireAdmin().then(boot);
</script>
</body>
</html>

