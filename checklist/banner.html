<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>首頁廣告管理｜BookWide Admin</title>
  <style>
    :root{
      --bg:#f4f6fb;
      --card-bg:#fff;
      --muted:#6b7280;
      --border:#e5e7eb;
      --brand:#2563eb;
      --brand-soft:#e0edff;
      --danger:#b91c1c;
      --radius-lg:18px;
      --shadow-card:0 10px 30px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC","Microsoft JhengHei",sans-serif;
      background:var(--bg);
      color:#111827;
    }
    a{color:inherit;text-decoration:none;}
    .wrap{
      max-width:1080px;
      margin:24px auto 80px;
      padding:0 16px 40px;
    }
    header{
      margin-bottom:16px;
      display:flex;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
      align-items:flex-end;
    }
    .title{
      font-size:1.4rem;
      font-weight:700;
    }
    .subtitle{
      font-size:.9rem;
      color:var(--muted);
      margin-top:4px;
    }
    .tag{
      display:inline-flex;
      padding:3px 9px;
      border-radius:999px;
      background:var(--brand-soft);
      color:#1e40af;
      font-size:.8rem;
      margin-left:6px;
    }
    .back-link{
      font-size:.85rem;
      color:var(--brand);
      display:inline-flex;
      align-items:center;
      gap:4px;
      cursor:pointer;
    }
    .admin-mail{
      font-size:.8rem;
      color:#6b7280;
      text-align:right;
    }

    .grid{
      display:grid;
      grid-template-columns: minmax(0,1.6fr) minmax(0,1.2fr);
      gap:16px;
    }
    @media(max-width:900px){
      .grid{grid-template-columns:1fr;}
    }

    .card{
      background:var(--card-bg);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-card);
      padding:18px 18px 14px;
    }
    .card-title{
      font-size:1rem;
      font-weight:600;
      margin-bottom:8px;
    }
    .card-sub{
      font-size:.82rem;
      color:var(--muted);
      margin-bottom:12px;
    }
    .field{
      margin-bottom:10px;
    }
    .label-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:4px;
      gap:4px;
    }
    .label{
      font-size:.83rem;
      color:#374151;
    }
    .hint{
      font-size:.75rem;
      color:var(--muted);
    }
    .ipt,.sel,textarea{
      width:100%;
      font-size:.9rem;
      padding:7px 9px;
      border-radius:8px;
      border:1px solid var(--border);
      font-family:inherit;
    }
    textarea{min-height:60px;resize:vertical;}

    .radio-row{
      display:flex;
      gap:12px;
      font-size:.85rem;
      margin-bottom:4px;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:7px 14px;
      border-radius:999px;
      border:1px solid var(--brand);
      background:var(--brand);
      color:#fff;
      font-size:.85rem;
      cursor:pointer;
      gap:4px;
    }
    .btn.secondary{
      background:#fff;
      color:var(--brand);
    }
    .btn.small{
      padding:5px 10px;
      font-size:.78rem;
    }
    .btn.danger{
      border-color:var(--danger);
      background:#fff;
      color:var(--danger);
    }

    .row-inline{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    .status{
      margin-top:6px;
      font-size:.78rem;
      color:var(--muted);
    }
    .status.ok{color:#15803d;}
    .status.err{color:var(--danger);}

    .preview-hero{
      border-radius:14px;
      border:1px solid var(--border);
      overflow:hidden;
      background:#000;
      margin-bottom:10px;
    }
    .preview-hero video,
    .preview-hero img{
      display:block;
      width:100%;
      height:auto;
    }
    .preview-caption{
      padding:8px 10px 10px;
      background:#0f172a;
      color:#e5e7eb;
      font-size:.8rem;
    }

    pre.json-preview{
      background:#0b1120;
      color:#e5e7eb;
      font-size:.78rem;
      padding:10px;
      border-radius:10px;
      overflow:auto;
      max-height:260px;
      line-height:1.5;
      white-space:pre;
    }

    footer{
      margin-top:16px;
      font-size:.78rem;
      color:var(--muted);
      text-align:right;
    }

    .badge{
      display:inline-flex;
      padding:1px 6px;
      border-radius:999px;
      background:#fee2e2;
      color:#b91c1c;
      font-size:.7rem;
      margin-left:4px;
    }
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div>
      <div class="title">
        首頁廣告管理
        <span class="tag">Hero Banner / 影片 / 圖片</span>
      </div>
      <div class="subtitle">
        上傳廣告 MP4 或圖片，設定標題與按鈕，產出 <code>hero-banner.json</code> 給首頁使用。
      </div>
      <div class="back-link" onclick="location.href='/admin.html'">← 回 Admin 首頁</div>
    </div>
    <div class="admin-mail">
      管理員：<span id="adminEmail">檢查中…</span>
    </div>
  </header>

  <div class="grid">
    <!-- 左：設定表單 & 上傳 -->
    <section class="card">
      <div class="card-title">1. 媒體與文案設定</div>
      <div class="card-sub">
        先選擇要使用「影片」或「圖片」作為首頁主視覺，再上傳檔案與輸入文案。
        <span class="badge">目前僅 1 組 Hero，之後可擴充多組輪播</span>
      </div>

      <div class="field">
        <div class="label-row">
          <div class="label">Hero 類型</div>
        </div>
        <div class="radio-row">
          <label><input type="radio" name="heroType" value="video" checked> 影片 Video</label>
          <label><input type="radio" name="heroType" value="image"> 圖片 Image</label>
        </div>
      </div>

      <div class="field">
        <div class="label-row">
          <div class="label">檔名 slug（不含副檔名）</div>
          <div class="hint">用來存到 Supabase /ads/home/&lt;slug&gt;.*，預設：home-hero</div>
        </div>
        <input id="slugInput" class="ipt" value="home-hero" />
      </div>

      <div class="field">
        <div class="label-row">
          <div class="label">上傳影片 MP4（選填）</div>
          <div class="hint">建議 16:9，< 20MB。上傳後自動填入 media_url（影片型）</div>
        </div>
        <div class="row-inline">
          <input id="videoFile" type="file" accept="video/*" />
          <button class="btn small" id="btnUploadVideo">上傳至 Supabase</button>
        </div>
        <div id="videoStatus" class="status"></div>
      </div>

      <div class="field">
        <div class="label-row">
          <div class="label">上傳封面圖片 JPG/PNG（建議 1280×720）</div>
          <div class="hint">影片型：作為 poster；圖片型：作為主視覺 image</div>
        </div>
        <div class="row-inline">
          <input id="imageFile" type="file" accept="image/*" />
          <button class="btn small" id="btnUploadImage">上傳至 Supabase</button>
        </div>
        <div id="imageStatus" class="status"></div>
      </div>

      <hr style="border:none;border-top:1px solid var(--border);margin:12px 0;">

      <div class="field">
        <div class="label-row">
          <div class="label">標題 title</div>
        </div>
        <input id="titleInput" class="ipt" placeholder="例如：BookWide 新片上線｜機場英文對話" />
      </div>

      <div class="field">
        <div class="label-row">
          <div class="label">副標 subtitle</div>
        </div>
        <textarea id="subtitleInput" placeholder="例如：跟著實境對話學機場英語，邊聽邊跟讀，還有單字卡與 AI 練習。"></textarea>
      </div>

      <div class="field">
        <div class="label-row">
          <div class="label">按鈕文字 cta_text</div>
        </div>
        <input id="ctaTextInput" class="ipt" placeholder="例如：立即試看" />
      </div>

      <div class="field">
        <div class="label-row">
          <div class="label">按鈕連結 cta_link</div>
          <div class="hint">例如：player.html?cat=news&amp;slug=at-the-airport-conversation</div>
        </div>
        <input id="ctaLinkInput" class="ipt" placeholder="目標網址（可為站內相對路徑）" />
      </div>

      <div class="field">
        <div class="label-row">
          <div class="label">media_url</div>
          <div class="hint">影片或圖片主檔 URL，會隨上傳自動填入，也可手動修改</div>
        </div>
        <input id="mediaUrlInput" class="ipt" />
      </div>

      <div class="field">
        <div class="label-row">
          <div class="label">poster_url（可選）</div>
          <div class="hint">影片封面：建議填入圖片 URL；圖片型可留空</div>
        </div>
        <input id="posterUrlInput" class="ipt" />
      </div>

      <div class="field" style="margin-top:14px;">
        <div class="row-inline">
          <button class="btn" id="btnRefresh">更新預覽 / JSON</button>
          <button class="btn secondary" id="btnDownload">下載 hero-banner.json</button>
          <button class="btn danger" id="btnClear">清空表單</button>
        </div>
        <div id="formStatus" class="status"></div>
      </div>
    </section>

    <!-- 右：預覽 & JSON -->
    <section class="card">
      <div class="card-title">2. 預覽首頁 Hero 效果</div>
      <div class="card-sub">
        這裡只模擬首頁 hero 區塊，真實效果仍以 <code>index.html</code> 為準。
      </div>

      <div class="preview-hero" id="heroPreviewBox">
        <video id="previewVideo" controls playsinline muted style="display:none"></video>
        <img id="previewImage" alt="Hero 圖片預覽" style="display:none">
      </div>
      <div class="preview-caption" id="previewCaption">
        尚未設定。請先輸入標題 / 副標，並按「更新預覽」。
      </div>

      <div style="margin-top:12px;margin-bottom:6px;font-size:.82rem;font-weight:600;">
        3. hero-banner.json 內容預覽
      </div>
      <pre class="json-preview" id="jsonPreview">{}</pre>
    </section>
  </div>

  <footer>
    BookWide Admin · checklist/banner.html · v20251202
  </footer>
</div>

<!-- Supabase & Admin 守門 -->
<script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
<script>
  const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
  const SUPABASE_ANON =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";

  const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
  const STORAGE_BUCKET = "ads";         // 請在 Supabase 建立 ads bucket
  const STORAGE_PREFIX = "home";        // 最終路徑：ads/home/<slug>.*

  async function requireAdmin() {
    const { data: { session } } = await supa.auth.getSession();
    if (!session) {
      alert("請先登入（需管理員身分）");
      location.href = "/index.html";
      throw new Error("no-session");
    }
    const { data: profile, error } = await supa
      .from("profiles")
      .select("email,is_admin,is_paused")
      .eq("id", session.user.id)
      .single();
    if (error || !profile) {
      alert("找不到使用者資料");
      location.href = "/index.html";
      throw new Error("no-profile");
    }
    if (!profile.is_admin || profile.is_paused) {
      alert("您沒有後台管理權限");
      location.href = "/index.html";
      throw new Error("not-admin");
    }
    document.getElementById("adminEmail").textContent = profile.email;
  }

  function currentConfig() {
    const type = document.querySelector("input[name='heroType']:checked")?.value || "video";
    return {
      type,
      title:      document.getElementById("titleInput").value.trim(),
      subtitle:   document.getElementById("subtitleInput").value.trim(),
      media_url:  document.getElementById("mediaUrlInput").value.trim(),
      poster_url: document.getElementById("posterUrlInput").value.trim(),
      cta_text:   document.getElementById("ctaTextInput").value.trim(),
      cta_link:   document.getElementById("ctaLinkInput").value.trim()
    };
  }

  function updateJsonPreview() {
    const cfg = currentConfig();
    const preview = document.getElementById("jsonPreview");
    preview.textContent = JSON.stringify(cfg, null, 2);

    // 更新預覽區塊
    const v = document.getElementById("previewVideo");
    const img = document.getElementById("previewImage");
    const caption = document.getElementById("previewCaption");

    v.style.display = "none";
    img.style.display = "none";
    v.removeAttribute("src");
    img.removeAttribute("src");

    if (cfg.type === "video" && cfg.media_url) {
      v.src = cfg.media_url;
      if (cfg.poster_url) v.poster = cfg.poster_url;
      v.style.display = "block";
    } else if (cfg.type === "image" && cfg.media_url) {
      img.src = cfg.media_url;
      img.style.display = "block";
    }

    if (cfg.title || cfg.subtitle) {
      caption.innerHTML =
        (cfg.title ? `<strong>${cfg.title}</strong><br>` : "") +
        (cfg.subtitle || "");
    } else {
      caption.textContent = "尚未設定。請先輸入標題 / 副標，並按「更新預覽」。";
    }
  }

  function showStatus(id, msg, cls) {
    const el = document.getElementById(id);
    el.textContent = msg || "";
    el.classList.remove("ok","err");
    if (cls) el.classList.add(cls);
  }

  async function uploadFile(kind) {
    const slug = document.getElementById("slugInput").value.trim() || "home-hero";
    const fileInput = kind === "video" ? document.getElementById("videoFile") : document.getElementById("imageFile");
    const statusId  = kind === "video" ? "videoStatus" : "imageStatus";
    const file = fileInput.files[0];
    if (!file) {
      showStatus(statusId,"請先選擇檔案。","err");
      return;
    }

    const ext = file.name.split(".").pop().toLowerCase();
    const path = `${STORAGE_PREFIX}/${slug}.${ext}`;
    showStatus(statusId,`上傳中… (${path})`);

    const { error } = await supa.storage.from(STORAGE_BUCKET).upload(path, file, { upsert:true });
    if (error) {
      console.error(error);
      showStatus(statusId,"上傳失敗："+error.message,"err");
      return;
    }

    const { data } = supa.storage.from(STORAGE_BUCKET).getPublicUrl(path);
    const publicUrl = data.publicUrl;

    if (kind === "video") {
      document.getElementById("mediaUrlInput").value = publicUrl;
      showStatus(statusId,"影片上傳成功，已填入 media_url。","ok");
    } else {
      const heroType = document.querySelector("input[name='heroType']:checked")?.value || "video";
      if (heroType === "video") {
        document.getElementById("posterUrlInput").value = publicUrl;
      } else {
        document.getElementById("mediaUrlInput").value = publicUrl;
      }
      showStatus(statusId,"圖片上傳成功，已填入對應欄位。","ok");
    }
    updateJsonPreview();
  }

  function downloadJson() {
    const cfg = currentConfig();
    const blob = new Blob([JSON.stringify(cfg,null,2)], {type:"application/json"});
    const url  = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "hero-banner.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    showStatus("formStatus","已下載 hero-banner.json，請再用既有流程上傳到 GitHub /data/home/。","ok");
  }

  function clearForm() {
    document.getElementById("titleInput").value = "";
    document.getElementById("subtitleInput").value = "";
    document.getElementById("ctaTextInput").value = "";
    document.getElementById("ctaLinkInput").value = "";
    document.getElementById("mediaUrlInput").value = "";
    document.getElementById("posterUrlInput").value = "";
    showStatus("videoStatus","");
    showStatus("imageStatus","");
    showStatus("formStatus","");
    updateJsonPreview();
  }

  // 綁定事件
  document.addEventListener("DOMContentLoaded", () => {
    requireAdmin().catch(()=>{});

    document.getElementById("btnUploadVideo").addEventListener("click", e => {
      e.preventDefault();
      uploadFile("video");
    });
    document.getElementById("btnUploadImage").addEventListener("click", e => {
      e.preventDefault();
      uploadFile("image");
    });

    document.getElementById("btnRefresh").addEventListener("click", e => {
      e.preventDefault();
      updateJsonPreview();
      showStatus("formStatus","已更新預覽與 JSON。","ok");
    });
    document.getElementById("btnDownload").addEventListener("click", e => {
      e.preventDefault();
      downloadJson();
    });
    document.getElementById("btnClear").addEventListener("click", e => {
      e.preventDefault();
      clearForm();
    });

    // 初始 JSON 預覽
    updateJsonPreview();
  });
</script>
</body>
</html>

