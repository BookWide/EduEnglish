<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Talk A Adminï½œBookWide</title>
<style>
:root{
  --bg:#f4f6fb; --card:#fff; --ink:#0b1220; --muted:#5b667a; --line:#e6eaf0; --soft:#f6f8fb;
  --brand:#0b66ff; --brand2:#084fc6; --radius:24px; --shadow:0 12px 34px rgba(10,20,40,.10);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;background:var(--bg);color:var(--ink)}
a{color:inherit}
.wrap{max-width:980px;margin:0 auto;padding:12px 12px calc(14px + env(safe-area-inset-bottom));display:flex;flex-direction:column;gap:10px;min-height:100%}
.top{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.92);backdrop-filter:blur(10px);box-shadow:var(--shadow)}
.back{width:42px;height:42px;border-radius:999px;border:1px solid var(--line);background:#fff;display:grid;place-items:center;cursor:pointer}
.ttl{display:flex;flex-direction:column;gap:2px;min-width:0}
.ttl b{font-size:16px;line-height:1.1}
.ttl span{font-size:12px;color:var(--muted);line-height:1.1}
.topRight{margin-left:auto;display:flex;align-items:center;gap:8px;min-width:0}
.pill{display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#fff;min-width:0}
.pill b{font-size:12px;color:var(--muted);white-space:nowrap}
.sel{border:0;outline:none;background:transparent;font-weight:800;color:var(--ink);font-size:13px;max-width:62vw}
.btn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:10px 14px;font-weight:800;cursor:pointer}
.btn.primary{background:linear-gradient(180deg,var(--brand),var(--brand2));color:#fff;border-color:transparent;box-shadow:0 10px 22px rgba(11,102,255,.22)}
.card{border:1px solid var(--line);border-radius:var(--radius);background:var(--card);box-shadow:var(--shadow)}
.teacher{display:flex;gap:14px;align-items:center;padding:12px}
.avatar{width:76px;height:76px;border-radius:20px;overflow:hidden;border:1px solid var(--line);background:radial-gradient(circle at 30% 30%, #fff, #e9eef7)}
.avatar video,.avatar img{width:100%;height:100%;object-fit:cover;display:block}
.tInfo{min-width:0;flex:1}
.tInfo .sceneTitle{font-weight:900;font-size:18px;line-height:1.15;margin:0 0 4px}
.tInfo .meta{color:var(--muted);font-size:12px;line-height:1.2}
.aiLine{padding:14px 16px}
.aiEn{font-size:28px;font-weight:950;line-height:1.05;margin:0}
.aiZh{margin:6px 0 0;color:var(--muted);font-size:15px;line-height:1.15}
.controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;padding:10px 12px}
.mic{width:68px;height:68px;border-radius:999px;border:0;cursor:pointer;background:linear-gradient(180deg,var(--brand),var(--brand2));box-shadow:0 12px 26px rgba(11,102,255,.25);display:grid;place-items:center;color:#fff;font-size:26px}
.smallBtn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:10px 14px;font-weight:900;cursor:pointer;display:flex;gap:8px;align-items:center}
.smallBtn:active{transform:translateY(1px)}
.reply{padding:14px 16px}
.rTop{display:flex;align-items:center;gap:8px}
.rTop h3{margin:0;font-size:18px}
.rTop .sp{margin-left:auto;display:flex;gap:8px}
.chip{border:1px solid var(--line);border-radius:999px;padding:8px 12px;background:#fff;font-weight:900;color:var(--muted)}
.q{margin:10px 0 6px;font-size:30px;font-weight:950;line-height:1.05}
.help{margin:0 0 10px;color:var(--muted);font-size:13px;line-height:1.25}
.inputRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.inp{flex:1;min-width:220px;border:1px solid var(--line);border-radius:16px;padding:14px 14px;font-size:18px;outline:none;background:#fff}
.actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
.fullBtn{flex:1;min-width:220px;border:0;border-radius:18px;padding:14px 16px;font-size:18px;font-weight:950;cursor:pointer}
.fullBtn.primary{background:linear-gradient(180deg,var(--brand),var(--brand2));color:#fff;box-shadow:0 12px 24px rgba(11,102,255,.22)}
.notice{padding:10px 12px;border:1px dashed var(--line);border-radius:16px;background:rgba(255,255,255,.7);color:var(--muted);font-size:12px;line-height:1.3}
.admin{padding:10px 12px;display:none}
.admin.show{display:block}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.file{border:1px solid var(--line);border-radius:14px;padding:10px;background:#fff}
.kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;color:var(--muted)}
@media (max-width:520px){
  .aiEn{font-size:26px}
  .q{font-size:28px}
  .mic{width:64px;height:64px}
}
</style>
</head>
<body>
<div class="wrap" id="app">
  <div class="top">
    <button class="back" id="btnBack" aria-label="back">â†</button>
    <div class="ttl">
      <b>Talk Aï¼ˆç®¡ç†ï¼‰</b>
      <span>TTSï¼šBrowser SpeechSynthesis</span>
    </div>
    <div class="topRight">
      <div class="pill">
        <b id="wkTag">W?</b>
        <select class="sel" id="sceneSel"></select>
      </div>
      <button class="btn" id="btnReplay">é‡æ’­</button>
      <button class="btn" id="btnAdmin">Admin</button>
    </div>
  </div>

  <div class="card teacher">
    <div class="avatar" aria-label="teacher">
      <video id="teacherVideo" muted playsinline loop preload="metadata"></video>
    </div>
    <div class="tInfo">
      <div class="sceneTitle" id="sceneTitle">è¼‰å…¥ä¸­â€¦</div>
      <div class="meta" id="sceneMeta">è®€å– index.jsonâ€¦</div>
    </div>
  </div>

  <div class="card aiLine" id="aiCard" style="display:none">
    <p class="aiEn" id="aiEn"></p>
    <p class="aiZh" id="aiZh"></p>
  </div>

  <div class="card controls">
    <button class="mic" id="btnMic" title="èªéŸ³è¾¨è­˜">ğŸ¤</button>
    <button class="smallBtn" id="btnFocus">âŒ¨ï¸ è¼¸å…¥</button>
    <button class="smallBtn" id="btnSkip">è·³é</button>
    <button class="smallBtn" id="btnHint">æç¤º</button>
    <button class="smallBtn" id="btnSave">æ”¶è—</button>
    <button class="smallBtn" id="btnCloze">å¡«ç©ºå¼•å°</button>
  </div>

  <div class="card reply">
    <div class="rTop">
      <h3>ä½ çš„å›è¦†</h3>
      <div class="sp">
        <span class="chip" id="lvlChip">A1</span>
        <button class="btn" id="btnHide">éš±è—</button>
      </div>
    </div>
    <div class="q" id="qText">â€”</div>
    <p class="help" id="helpText">å°è©±æ¨¡å¼ï¼šAI å…ˆèªªä¸€å¥ï¼Œç­‰ä½ å›è¦†ï¼ˆèªéŸ³æˆ–è¼¸å…¥ï¼‰æ‰æœƒé€²ä¸‹ä¸€å¥ã€‚</p>
    <div class="inputRow">
      <input class="inp" id="userInput" placeholder="è¼¸å…¥å›è¦†â€¦"/>
    </div>
    <div class="actions">
      <button class="fullBtn primary" id="btnSubmit">âœ… é€å‡ºå¡«å¥½å¥</button>
      <button class="fullBtn" id="btnRetry">é‡ä¾†</button>
    </div>
    <div class="notice" id="errBox" style="display:none"></div>
  </div>

  <div class="card admin" id="adminBox">
    <div class="row" style="margin-bottom:8px">
      <div class="file">
        <div style="font-weight:900;margin-bottom:6px">é›¢ç·šæ¨¡å¼ï¼ˆfile://ï¼‰è«‹ä¸Šå‚³</div>
        <div class="row">
          <label class="file">index.json <input type="file" id="fileIndex" accept="application/json"></label>
          <label class="file">scene.json <input type="file" id="fileScene" accept="application/json"></label>
        </div>
      </div>
      <div class="file">
        <div style="font-weight:900;margin-bottom:6px">ç›®å‰æª”å</div>
        <div class="kbd" id="curJsonName">â€”</div>
      </div>
    </div>
    <div class="notice">æç¤ºï¼šä¸Šç·šæ™‚æœƒè‡ªå‹•è®€ <span class="kbd">/talk/index.json</span>ï¼ˆæˆ– <span class="kbd">../talk/index.json</span>ï¼‰èˆ‡ <span class="kbd">wxx.*.json</span>ï¼›æœ¬å€åªæ˜¯ç‚ºäº†è§£æ±º iPhone ç›´æ¥é–‹ä¸‹è¼‰æª”ï¼ˆfile://ï¼‰æ™‚ fetch å¤±æ•ˆã€‚</div>
  </div>
</div>

<script>
(() => {
  'use strict';
  const $ = (id) => document.getElementById(id);
  const el = {
    sceneSel: $('sceneSel'),
    btnReplay: $('btnReplay'),
    btnMic: $('btnMic'),
    btnInput: $('btnInput'),
    btnSkip: $('btnSkip'),
    btnHint: $('btnHint'),
    btnFav: $('btnFav'),
    btnCloze: $('btnCloze'),
    btnSendCloze: $('btnSendCloze'),
    btnReset: $('btnReset'),
    aiAvatar: $('aiAvatar'),
    sceneTitle: $('sceneTitle'),
    sceneId: $('sceneId'),
    aiEn: $('aiEn'),
    aiZh: $('aiZh'),
    aiCard: $('aiCard'),
    qText: $('qText'),
    userInput: $('userInput'),
    chips: $('chips'),
    levelPill: $('levelPill'),
    btnHide: $('btnHide'),
  };

  const state = {
    index: null,
    currentSceneId: null,
    scene: null,
    currentUserHint: null,
    cloze: null,
    recognizing: false,
    recog: null,
  };

  const indexURL = new URL('../talk/index.json', location.href);
  const sceneURL = (id) => new URL(`../talk/${id}.json`, location.href);

  function safeText(x){ return (x ?? '').toString(); }

  function setLoading(msg){
    const m = msg || 'Loading...';
    if (el.sceneTitle) el.sceneTitle.textContent = m;
    if (el.aiCard) el.aiCard.style.display = 'none';
    if (el.aiCard) el.aiCard.style.display = 'none';
    if (el.aiEn) el.aiEn.textContent = '';
    if (el.aiZh) el.aiZh.textContent = '';
  }

  function pickLevelFromId(id){
    const m = /^w(\d+)\.(core|variation|challenge)\./i.exec(id || '');
    if (!m) return 'A1';
    const t = m[2].toLowerCase();
    return t === 'core' ? 'A1' : (t === 'variation' ? 'A2' : 'B1');
  }

  async function loadIndex(){
    setLoading('Loading...');
    try{
      const res = await fetch(indexURL.toString(), {cache:'no-store'});
      if(!res.ok) throw new Error(`index.json HTTP ${res.status}`);
      const data = await res.json();
      if(!data || !Array.isArray(data.scenes)) throw new Error('index.json format error');
      state.index = data;
      if (el.sceneSel){
        el.sceneSel.innerHTML = '';
        for(const s of data.scenes){
          const opt = document.createElement('option');
          opt.value = s.id;
          opt.textContent = s.title || s.id;
          el.sceneSel.appendChild(opt);
        }
      }
      const qp = new URLSearchParams(location.search);
      const qScene = qp.get('scene');
      const initial = (qScene && data.scenes.some(s=>s.id===qScene)) ? qScene : data.scenes[0]?.id;
      if(initial){
        if(el.sceneSel) el.sceneSel.value = initial;
        await loadScene(initial);
      }else{
        setLoading('No scenes in index.json');
      }
    }catch(err){
      console.error(err);
      // fallback: embedded index json (for local preview / fetch blocked)
      try{
        const embed = document.getElementById('EMBED_INDEX');
        if(embed && embed.textContent && embed.textContent.trim()){
          const data = JSON.parse(embed.textContent);
          if(data && Array.isArray(data.scenes)){
            state.index = data;
            if (el.sceneSel){
              el.sceneSel.innerHTML = '';
              for(const s of data.scenes){
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = s.title || s.id;
                el.sceneSel.appendChild(opt);
              }
            }
            const initial = getInitialSceneId() || (data.scenes[0] && data.scenes[0].id);
            if(initial){
              if(el.sceneSel) el.sceneSel.value = initial;
              await loadScene(initial);
              return;
            }
          }
        }
      }catch(e2){
        console.error('EMBED_INDEX parse failed', e2);
      }
      setLoading('Loading... (ç„¡æ³•è®€å– index.json)');
      if (el.aiZh) el.aiZh.textContent = '';
    }
  }

  async function loadScene(id){
    state.currentSceneId = id;
    state.scene = null;
    state.currentUserHint = null;
    state.cloze = null;

    if(el.levelPill) el.levelPill.textContent = pickLevelFromId(id);
    if(el.sceneId) el.sceneId.textContent = id;

    const title = state.index?.scenes?.find(s=>s.id===id)?.title || id;
    if(el.sceneTitle) el.sceneTitle.textContent = title;

    setLoading('Loading...');
    try{
      const res = await fetch(sceneURL(id).toString(), {cache:'no-store'});
      if(!res.ok) throw new Error(`${id}.json HTTP ${res.status}`);
      const data = await res.json();
      if(!data || !Array.isArray(data.dialogue)) throw new Error('scene json format error');
      state.scene = data;

      const firstAI = data.dialogue.find(d => (d.role||'').toUpperCase()==='AI');
      if(firstAI){
        el.aiEn.textContent = safeText(firstAI.en);
        el.aiZh.textContent = safeText(firstAI.zh);
      }else{
        el.aiEn.textContent = '...';
        el.aiZh.textContent = '';
      }

      state.currentUserHint = data.dialogue.find(d => (d.role||'').toUpperCase()==='USER') || null;
      renderUserHint();
    }catch(err){
      console.error(err);
      setLoading(`Loading... (æ‰¾ä¸åˆ° ${id}.json)`);
      if(el.aiZh) el.aiZh.textContent = '';
      clearClozeUI();
    }
  }

  function clearChips(){
    if(!el.chips) return;
    el.chips.innerHTML = '';
  }
  function clearClozeUI(){
    state.cloze = null;
    clearChips();
  }

  function renderUserHint(){
    const d = state.currentUserHint;
    if(!d){
      if(el.qText) el.qText.textContent = 'â€”';
      clearClozeUI();
      return;
    }
    if(el.qText) el.qText.textContent = safeText(d.hint_en || d.en || '');
    clearClozeUI();
  }

  const STOP = new Set(['the','a','an','to','of','and','or','is','are','am','i','you','me','my','your','please','could','can','would','will','it','in','on','at','for','with','this','that']);
  function makeClozeFromSentence(s){
    const raw = safeText(s).trim();
    if(!raw) return null;
    const tokens = raw.replace(/[^\w'\s]/g,' ').split(/\s+/).filter(Boolean);
    let answer = '';
    for(const w of [...tokens].sort((a,b)=>b.length-a.length)){
      const lw = w.toLowerCase();
      if(lw.length>=4 && !STOP.has(lw)){ answer = w; break; }
    }
    if(!answer){
      for(const w of tokens){
        const lw = w.toLowerCase();
        if(lw.length>=3 && !STOP.has(lw)){ answer = w; break; }
      }
    }
    if(!answer) return null;
    const blank = '____';
    const reAns = new RegExp(`\\b${answer.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\\\$&')}\\b`);
    const text = raw.replace(reAns, blank);

    const pool = ['help','gate','terminal','order','ticket','passport','menu','bill','coffee','water','reservation','table','check-in','boarding','taxi','luggage'];
    const opts = new Set([answer]);
    while(opts.size<3) opts.add(pool[Math.floor(Math.random()*pool.length)]);
    const options = [...opts];
    for(let i=options.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [options[i],options[j]]=[options[j],options[i]];
    }
    return {text, answer, options};
  }

  function renderCloze(){
    const d = state.currentUserHint;
    const base = safeText(d?.hint_en || d?.en || '');
    const c = makeClozeFromSentence(base);
    if(!c) return;
    state.cloze = c;
    if(el.qText) el.qText.textContent = c.text;
    if(el.userInput) el.userInput.value = '';
    if(el.chips){
      el.chips.innerHTML = '';
      for(const opt of c.options){
        const b=document.createElement('button');
        b.type='button';
        b.className='chip';
        b.textContent=opt;
        b.addEventListener('click',()=>{ el.userInput.value = opt; el.userInput.focus(); });
        el.chips.appendChild(b);
      }
    }
  }

  function speak(text){
    const t=safeText(text).trim();
    if(!t) return;
    try{
      window.speechSynthesis.cancel();
      const u=new SpeechSynthesisUtterance(t);
      u.lang='en-US';
      u.rate=1.0;
      window.speechSynthesis.speak(u);
    }catch(e){ console.warn(e); }
  }

  function setupSpeechRecognition(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR) return;
    const r = new SR();
    r.lang='en-US';
    r.interimResults=true;
    r.continuous=false;
    r.onstart=()=>{ state.recognizing=true; el.btnMic?.classList.add('on'); };
    r.onend=()=>{ state.recognizing=false; el.btnMic?.classList.remove('on'); };
    r.onerror=(e)=>console.warn(e);
    r.onresult=(ev)=>{
      let txt='';
      for(let i=ev.resultIndex;i<ev.results.length;i++){
        txt += ev.results[i][0].transcript;
      }
      if(el.userInput) el.userInput.value = txt.trim();
    };
    state.recog=r;
  }
  function toggleRecog(){
    if(!state.recog) return;
    if(state.recognizing) state.recog.stop(); else state.recog.start();
  }

  function submitAnswer(){
    const user = safeText(el.userInput?.value || '').trim();
    if(!user) return;
    let finalSentence = user;
    if(state.cloze && state.cloze.text.includes('____') && /^\w[\w'-]*$/.test(user)){
      finalSentence = state.cloze.text.replace('____', user);
    }
    if(el.qText) el.qText.textContent = finalSentence;
    speak(finalSentence);
  }

  function wireUI(){
    el.sceneSel?.addEventListener('change', async()=>{ await loadScene(el.sceneSel.value); });
    el.btnReplay?.addEventListener('click', ()=> speak(el.aiEn?.textContent || ''));
    el.btnMic?.addEventListener('click', toggleRecog);
    el.btnCloze?.addEventListener('click', renderCloze);
    el.btnSendCloze?.addEventListener('click', submitAnswer);
    el.btnReset?.addEventListener('click', ()=>{ if(el.userInput) el.userInput.value=''; renderUserHint(); });
    el.userInput?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); submitAnswer(); } });
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    setupSpeechRecognition();
    wireUI();
    loadIndex();
  });
})();
</script>
</body>
</html>
