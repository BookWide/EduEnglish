<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Talk Aï¼ˆç®¡ç†ãƒ»Index Onlyï¼‰ï½œBookWide</title>
<style>
  :root{
    --bg:#f4f6fb; --card:#fff; --ink:#0b1220; --muted:#5b667a; --line:#e6eaf0;
    --brand:#0b66ff; --brand2:#084fc6; --soft:#f6f8fb; --shadow:0 10px 28px rgba(10,20,40,.10);
    --radius:18px; --radius2:24px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
    background:var(--bg); color:var(--ink);
  }
  .app{
    height:100%;
    max-width:1020px;
    margin:0 auto;
    padding:12px 12px calc(12px + env(safe-area-inset-bottom));
    display:flex; flex-direction:column; gap:10px;
  }
  .topbar{
    display:flex; align-items:center; gap:10px;
    padding:10px 12px;
    background:rgba(255,255,255,.86);
    border:1px solid var(--line);
    border-radius:999px;
    box-shadow:var(--shadow);
    backdrop-filter: blur(10px);
  }
  .backBtn{
    width:42px; height:42px; border-radius:999px;
    border:1px solid var(--line);
    background:#fff; cursor:pointer;
    display:grid; place-items:center;
  }
  .brand{
    display:flex; flex-direction:column; line-height:1.05;
    min-width:0;
  }
  .brand .t{font-weight:800}
  .brand .s{font-size:12px;color:var(--muted)}
  .spacer{flex:1}
  select{
    appearance:none;
    border:1px solid var(--line);
    background:#fff;
    border-radius:999px;
    padding:10px 40px 10px 12px;
    font-weight:700;
    min-width:240px;
    box-shadow:0 8px 20px rgba(10,20,40,.06);
    cursor:pointer;
  }
  .selectWrap{position:relative}
  .selectWrap:after{
    content:"â–¾";
    position:absolute;
    right:14px; top:50%;
    transform:translateY(-50%);
    color:var(--muted);
    pointer-events:none;
    font-size:14px;
  }
  .pill{
    border:1px solid var(--line);
    background:#fff;
    border-radius:999px;
    padding:10px 14px;
    font-weight:800;
    cursor:pointer;
    box-shadow:0 8px 20px rgba(10,20,40,.06);
  }
  .pill.primary{background:linear-gradient(180deg,var(--brand),var(--brand2)); color:#fff; border-color:transparent}
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:var(--radius2);
    box-shadow:var(--shadow);
    overflow:hidden;
  }

  /* Teacher + loading inline */
  .hero{
    display:flex; gap:12px; align-items:center;
    padding:14px 14px;
  }
  .avatar{
    width:64px; height:64px; border-radius:18px;
    background:linear-gradient(180deg,#f0f4ff,#ffffff);
    border:1px solid var(--line);
    flex:0 0 auto;
    overflow:hidden;
    display:grid; place-items:center;
  }
  .avatar img{width:100%;height:100%;object-fit:cover;display:block}
  .heroMain{min-width:0; flex:1}
  .heroTitle{
    display:flex; align-items:baseline; gap:10px; flex-wrap:wrap;
    font-weight:900; font-size:22px; line-height:1.05;
  }
  .heroSub{color:var(--muted); font-size:13px; margin-top:6px}
  .statusLine{color:var(--muted); font-size:13px; margin-top:6px}
  .statusLine b{color:var(--ink)}
  .loadingChip{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px;
    border-radius:999px;
    border:1px solid var(--line);
    background:#fff;
    font-size:12px; color:var(--muted);
  }
  .dot{
    width:8px;height:8px;border-radius:999px;background:#22c55e;
    box-shadow:0 0 0 6px rgba(34,197,94,.14);
  }
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

  .controls{
    padding:12px 14px;
    display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    border-top:1px dashed rgba(230,234,240,.9);
  }
  .micBtn{
    width:62px; height:62px; border-radius:999px;
    background:linear-gradient(180deg,var(--brand),var(--brand2));
    border:none; color:#fff; cursor:pointer;
    box-shadow:0 18px 40px rgba(11,102,255,.26);
    display:grid; place-items:center;
    flex:0 0 auto;
    font-size:22px;
  }
  .btn{
    border:1px solid var(--line);
    background:#fff;
    padding:10px 14px;
    border-radius:999px;
    cursor:pointer;
    font-weight:800;
    box-shadow:0 8px 20px rgba(10,20,40,.06);
    display:inline-flex; align-items:center; gap:8px;
  }
  .btn:disabled{opacity:.55; cursor:not-allowed}
  .btn.small{padding:8px 12px; font-weight:800; font-size:13px}
  .btn.primary{border-color:transparent;background:linear-gradient(180deg,var(--brand),var(--brand2)); color:#fff}
  .btn.ghost{background:transparent}
  .btn.row{white-space:nowrap}

  .replyCard{padding:14px}
  .replyTop{
    display:flex; align-items:center; gap:10px;
    margin-bottom:10px;
  }
  .replyTop h3{
    margin:0;
    font-size:18px;
    letter-spacing:.5px;
  }
  .replyTop .level{
    margin-left:auto;
    display:flex; align-items:center; gap:8px;
  }
  .badge{
    border:1px solid var(--line);
    border-radius:999px;
    padding:8px 12px;
    font-weight:900;
    background:#fff;
  }
  .helpText{color:var(--muted); font-size:13px; line-height:1.25; margin-top:6px}
  .prompt{
    font-weight:900;
    font-size:34px;
    line-height:1.02; /* ultra compact */
    margin:6px 0 10px 0;
    word-break:break-word;
  }
  .prompt.small{font-size:28px}
  .inputRow{
    display:flex; gap:10px; flex-wrap:wrap;
    margin-top:10px;
  }
  input[type="text"]{
    flex:1;
    min-width:220px;
    border:1px solid var(--line);
    border-radius:16px;
    padding:14px 14px;
    font-size:18px;
    outline:none;
    background:#fff;
  }
  .chips{
    display:flex; gap:10px; flex-wrap:wrap;
    margin-top:10px;
  }
  .chip{
    border:1px solid var(--line);
    border-radius:999px;
    padding:10px 14px;
    background:#fff;
    cursor:pointer;
    font-weight:800;
  }
  .chip:active{transform:translateY(1px)}
  .finalLine{
    margin-top:10px;
    padding:12px 14px;
    border-radius:16px;
    border:1px solid var(--line);
    background:var(--soft);
    font-weight:900;
    font-size:18px;
  }
  .muted{color:var(--muted)}
  .danger{
    background:#fff5f5;
    border:1px solid #ffd2d2;
    color:#8a1f1f;
    padding:10px 12px;
    border-radius:14px;
    font-size:13px;
    line-height:1.25;
    margin-top:10px;
  }

  @media (max-width:620px){
    .app{padding:10px 10px calc(10px + env(safe-area-inset-bottom))}
    select{min-width:190px}
    .prompt{font-size:30px}
    .heroTitle{font-size:20px}
    .avatar{width:60px;height:60px;border-radius:16px}
  }
</style>
</head>
<body>
<div class="app">

  <div class="topbar">
    <button class="backBtn" id="backBtn" aria-label="Back">â†</button>
    <div class="brand">
      <div class="t">Talk Aï¼ˆç®¡ç†ï¼‰</div>
      <div class="s">TTSï¼šBrowser SpeechSynthesis â€¢ Index.json å”¯ä¸€è³‡æ–™æº</div>
    </div>
    <div class="spacer"></div>
    <div class="selectWrap">
      <select id="sceneSelect" title="é¸æ“‡æƒ…å¢ƒ"></select>
    </div>
    <button class="pill" id="replayBtn">é‡æ’­</button>
    <button class="pill primary" id="adminPill">Admin</button>
  </div>

  <div class="card" id="heroCard">
    <div class="hero">
      <div class="avatar" id="avatarBox" aria-label="teacher avatar">
        <span class="muted">â€”</span>
      </div>
      <div class="heroMain">
        <div class="heroTitle">
          <span id="heroTitle">Loadingâ€¦</span>
          <span class="loadingChip" id="statusChip">
            <span class="dot"></span>
            <span id="statusText">è®€å– index.jsonâ€¦</span>
          </span>
        </div>
        <div class="heroSub mono" id="heroId">â€”</div>
        <div class="statusLine" id="heroMeta"></div>
        <div class="danger" id="fatalBox" style="display:none"></div>
      </div>
    </div>

    <div class="controls">
      <button class="micBtn" id="micBtn" title="é–‹å§‹èªéŸ³è¾¨è­˜">ğŸ¤</button>
      <button class="btn row" id="inputModeBtn">âŒ¨ï¸ è¼¸å…¥</button>
      <button class="btn row" id="skipBtn">è·³é</button>
      <button class="btn row" id="hintBtn">æç¤º</button>
      <button class="btn row" id="saveBtn">æ”¶è—</button>
      <button class="btn row" id="clozeBtn">ğŸ§© å¡«ç©ºå¼•å°</button>
      <span class="muted" id="hintInline" style="margin-left:auto"></span>
    </div>
  </div>

  <div class="card replyCard" id="replyCard" style="display:none">
    <div class="replyTop">
      <h3>ä½ çš„å›è¦†</h3>
      <div class="level">
        <span class="badge" id="levelBadge">A1</span>
        <button class="btn small" id="hideBtn">éš±è—</button>
      </div>
    </div>

    <div class="prompt" id="qText">â€”</div>
    <div class="helpText" id="modeText">å°è©±æ¨¡å¼ï¼šAI å…ˆèªªä¸€å¥ï¼Œç­‰ä½ å›è¦†ï¼ˆèªéŸ³æˆ–è¼¸å…¥ï¼‰æ‰æœƒé€²ä¸‹ä¸€å¥ã€‚</div>

    <div class="chips" id="chips"></div>

    <div class="inputRow">
      <input type="text" id="replyInput" placeholder="è¼¸å…¥å›è¦†..." autocomplete="off" />
      <button class="btn primary" id="submitBtn">âœ… é€å‡ºå¡«å¥½å¥</button>
      <button class="btn" id="resetBtn">é‡ä¾†</button>
    </div>

    <div class="finalLine" id="finalLine" style="display:none"></div>
    <div class="danger" id="warnBox" style="display:none"></div>
  </div>

</div>

<script>
/* =========================
   Talk A Admin (B)
   - index.json å”¯ä¸€è³‡æ–™æº
   - é›¶å‡è³‡æ–™ï¼šscene æœªè®€åˆ°å°±ä¸é¡¯ç¤ºå›è¦†å€
   - å…¨ Promise éƒ½æœ‰ try/catchï¼Œæœçµ• Uncaught(in promise)
   - ç›¸å°è·¯å¾‘ï¼šæœ¬é åœ¨ /checklist/ æ™‚ï¼Œ../talk/index.json => /talk/index.json
========================= */

const $ = (id)=>document.getElementById(id);

const state = {
  index: null,
  scenes: [],
  sceneId: null,
  scene: null,
  dialogues: [],
  i: 0,
  current: null,
  clozeMode: false,
  recog: null,
  supportsRecog: false,
  lastSpoken: ""
};

function log(...a){ /* console.log(...a); */ }
function setStatus(text){
  $("statusText").textContent = text;
}
function showFatal(msg){
  $("fatalBox").style.display = "block";
  $("fatalBox").textContent = msg;
  setStatus("ç™¼ç”ŸéŒ¯èª¤");
}
function hideFatal(){
  $("fatalBox").style.display = "none";
  $("fatalBox").textContent = "";
}

function asUrl(rel){
  return new URL(rel, location.href).toString();
}
function isFileProtocol(){
  return location.protocol === "file:";
}

async function fetchJson(url){
  const res = await fetch(url, { cache:"no-store" });
  if(!res.ok) throw new Error(`Fetch failed: ${res.status} ${url}`);
  return await res.json();
}

/* ----- index.json ONLY ----- */
async function loadIndex(){
  if(isFileProtocol()){
    throw new Error("ä½ ç¾åœ¨ç”¨ file:// ç›´æ¥æ‰“é–‹ï¼Œç€è¦½å™¨æœƒæ“‹ fetchã€‚è«‹ä¸Šå‚³åˆ° bookwide.net åŒç¶²åŸŸå¾Œæ¸¬è©¦ã€‚");
  }
  const indexUrl = asUrl("../talk/index.json");
  setStatus("è®€å– index.jsonâ€¦");
  const data = await fetchJson(indexUrl);

  if(!data || !Array.isArray(data.scenes)){
    throw new Error("index.json æ ¼å¼ä¸å°ï¼šç¼º scenes[]");
  }
  state.index = data;
  state.scenes = data.scenes
    .filter(x => x && x.id)
    .map(x => ({ id:String(x.id), title:String(x.title || x.id) }));

  if(state.scenes.length === 0) throw new Error("index.json scenes ç‚ºç©º");

  // Fill select
  const sel = $("sceneSelect");
  sel.innerHTML = "";
  for(const s of state.scenes){
    const opt = document.createElement("option");
    opt.value = s.id;
    opt.textContent = s.title;
    sel.appendChild(opt);
  }
}

/* ----- read scene.json (by id from index) ----- */
function getSceneFromQuery(){
  const u = new URL(location.href);
  return u.searchParams.get("scene") || u.searchParams.get("id") || "";
}

async function loadSceneById(sceneId){
  state.sceneId = sceneId;
  $("heroId").textContent = sceneId;
  setStatus(`è®€å– ${sceneId}.jsonâ€¦`);

  const sceneUrl = asUrl(`../talk/${encodeURIComponent(sceneId)}.json`);
  const scene = await fetchJson(sceneUrl);
  state.scene = scene;

  // Avatar (optional)
  const avatarUrl = scene?.teacher?.avatar || scene?.avatar || scene?.teacher_avatar || "";
  const avatarBox = $("avatarBox");
  avatarBox.innerHTML = "";
  if(avatarUrl){
    const img = new Image();
    img.src = avatarUrl;
    img.alt = "teacher";
    img.onload = ()=>{};
    img.onerror = ()=>{ avatarBox.innerHTML = '<span class="muted">â€”</span>'; };
    avatarBox.appendChild(img);
  }else{
    avatarBox.innerHTML = '<span class="muted">â€”</span>';
  }

  // Title (prefer index title)
  const fromIndex = state.scenes.find(x=>x.id===sceneId)?.title || sceneId;
  $("heroTitle").textContent = fromIndex;
  $("heroMeta").textContent = ""; // ä½ è¦ä¹¾æ·¨ï¼Œé€™è£¡ä¸é¡¯ç¤ºã€Œæœ¬é€±/é€²åº¦ã€é‚£äº›å­—

  // Dialogue normalization
  const d =
    (Array.isArray(scene.dialogues) && scene.dialogues) ||
    (Array.isArray(scene.lines) && scene.lines) ||
    (Array.isArray(scene.steps) && scene.steps) ||
    (Array.isArray(scene.items) && scene.items) ||
    [];

  if(d.length === 0){
    throw new Error(`${sceneId}.json ç¼º dialogues/lines/steps/items é™£åˆ—`);
  }

  state.dialogues = d.map((x)=>normalizeDialogue(x)).filter(Boolean);
  if(state.dialogues.length === 0){
    throw new Error(`${sceneId}.json è§£æä¸åˆ°å¯ç”¨å°è©±`);
  }

  state.i = 0;
  state.current = state.dialogues[state.i];

  setStatus("å°±ç·’");
}

/* ----- dialogue normalize: keep it tolerant ----- */
function normalizeDialogue(x){
  if(!x || typeof x !== "object") return null;

  const en = String(x.en || x.ai || x.teacher || x.prompt || x.q || x.question || "").trim();
  const zh = String(x.zh || x.tw || x.cn || x.translation || "").trim();

  // Cloze candidates: array of words
  let cloze = x.cloze || x.options || x.choices || x.words || x.gaps;
  if(typeof cloze === "string") cloze = cloze.split(/[,\s]+/).filter(Boolean);
  if(!Array.isArray(cloze)) cloze = [];
  cloze = cloze.map(w=>String(w).trim()).filter(Boolean);

  // Template with blanks
  const tpl =
    String(x.cloze_sentence || x.clozeTemplate || x.template || x.sentence || "").trim();

  // Level (optional)
  const level = String(x.level || x.cefr || "A1").trim();

  // If nothing at all, skip
  if(!en && !tpl) return null;

  return { en, zh, tpl, cloze, level };
}

/* ----- UI render ----- */
function showReplyUI(){
  $("replyCard").style.display = "block";
}
function hideReplyUI(){
  $("replyCard").style.display = "none";
}

function setQuestionText(text){
  $("qText").textContent = text || "â€”";
  $("qText").classList.toggle("small", (text||"").length > 42);
}

function renderCurrent(){
  const cur = state.current;
  if(!cur) return;

  $("levelBadge").textContent = cur.level || "A1";
  $("finalLine").style.display = "none";
  $("finalLine").textContent = "";
  $("warnBox").style.display = "none";
  $("warnBox").textContent = "";

  // default: show teacher line (en + zh) compact
  state.clozeMode = false;
  const text = (cur.en || "â€”");
  const sub = (cur.zh ? `\n${cur.zh}` : "");
  setQuestionText(text); // keep clean: only main line; translation goes to hint line
  $("hintInline").textContent = cur.zh ? cur.zh : "";

  renderChips([]);
  $("replyInput").value = "";
  showReplyUI();
}

/* chips are used only in cloze mode */
function renderChips(words){
  const box = $("chips");
  box.innerHTML = "";
  if(!words || words.length===0) return;

  for(const w of words){
    const b = document.createElement("button");
    b.className = "chip";
    b.type = "button";
    b.textContent = w;
    b.onclick = ()=>insertWord(w);
    box.appendChild(b);
  }
}

function insertWord(w){
  const inp = $("replyInput");
  const val = inp.value || "";
  // If template has "____" and input empty, place w
  if(val.includes("____")){
    inp.value = val.replace("____", w);
    return;
  }
  // If caret exists, insert at end
  inp.value = (val ? (val.trimEnd()+" ") : "") + w;
  inp.focus();
}

/* ----- Cloze mode ----- */
function enterCloze(){
  const cur = state.current;
  if(!cur) return;

  // Must have template OR can derive a template from en if possible
  let template = cur.tpl;

  if(!template){
    // Derive: replace first cloze word occurrence with ____ if possible
    if(cur.en && cur.cloze && cur.cloze.length){
      const w = cur.cloze[0];
      const re = new RegExp(`\\b${escapeRegExp(w)}\\b`);
      if(re.test(cur.en)) template = cur.en.replace(re, "____");
    }
  }

  if(!template){
    $("warnBox").style.display = "block";
    $("warnBox").textContent = "æ­¤é¡Œæ²’æœ‰å¯ç”¨çš„å¡«ç©ºæ¨¡æ¿ï¼ˆscene.json éœ€æä¾› cloze_sentence æˆ– cloze+enï¼‰ã€‚";
    return;
  }

  state.clozeMode = true;
  setQuestionText(template);
  $("hintInline").textContent = ""; // cloze æ¨¡å¼å°±ä¹¾æ·¨
  renderChips(cur.cloze || []);
  $("replyInput").value = template; // è®“ä½ ç›´æ¥å¡«
  $("replyInput").focus();
}

/* ----- Submit (fill) ----- */
function submitFilled(){
  const cur = state.current;
  if(!cur) return;

  const inp = $("replyInput").value.trim();
  if(!inp){
    $("warnBox").style.display="block";
    $("warnBox").textContent="è«‹å…ˆè¼¸å…¥æˆ–é»é¸è©å½™å¡«å…¥ç©ºæ ¼ã€‚";
    return;
  }

  // If still has blank, warn
  if(inp.includes("____")){
    $("warnBox").style.display="block";
    $("warnBox").textContent="ä½ é‚„æ²’å¡«å®Œï¼šé‚„æœ‰ ____ã€‚";
    return;
  }

  $("warnBox").style.display="none";
  $("finalLine").style.display="block";
  $("finalLine").textContent = inp;

  speak(inp);

  // move next
  nextDialogue();
}

function nextDialogue(){
  if(!state.dialogues.length) return;
  state.i = Math.min(state.i + 1, state.dialogues.length - 1);
  state.current = state.dialogues[state.i];
  renderCurrent();
}

function resetThis(){
  renderCurrent();
}

/* ----- TTS ----- */
function speak(text){
  try{
    state.lastSpoken = text || "";
    if(!("speechSynthesis" in window)) return;

    window.speechSynthesis.cancel();
    const ut = new SpeechSynthesisUtterance(text);
    // pick en voice if possible
    const voices = window.speechSynthesis.getVoices?.() || [];
    const v = voices.find(v=>/en/i.test(v.lang)) || voices[0];
    if(v) ut.voice = v;
    ut.rate = 1.0;
    ut.pitch = 1.0;
    window.speechSynthesis.speak(ut);
  }catch(e){
    // swallow
  }
}
function replay(){
  if(state.lastSpoken) speak(state.lastSpoken);
  else if(state.current?.en) speak(state.current.en);
}

/* ----- Speech Recognition (optional) ----- */
function setupRecog(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  state.supportsRecog = !!SR;
  if(!SR){
    $("micBtn").disabled = true;
    $("micBtn").title = "æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜";
    return;
  }
  const r = new SR();
  r.lang = "en-US";
  r.interimResults = false;
  r.maxAlternatives = 1;

  r.onresult = (ev)=>{
    try{
      const t = ev.results?.[0]?.[0]?.transcript || "";
      if(t){
        $("replyInput").value = t;
      }
    }catch(e){}
  };
  r.onerror = (ev)=>{
    $("warnBox").style.display="block";
    $("warnBox").textContent = "èªéŸ³è¾¨è­˜å¤±æ•—ï¼ˆå¯èƒ½è¢«ç€è¦½å™¨é˜»æ“‹éº¥å…‹é¢¨æ¬Šé™ï¼‰ã€‚";
  };
  state.recog = r;
}

function startRecog(){
  if(!state.recog) return;
  $("warnBox").style.display="none";
  try{ state.recog.start(); }catch(e){}
}

/* ----- Helpers ----- */
function escapeRegExp(s){
  return String(s).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
}

/* ----- Events ----- */
$("backBtn").onclick = ()=>history.back();
$("replayBtn").onclick = ()=>replay();
$("micBtn").onclick = ()=>startRecog();
$("clozeBtn").onclick = ()=>enterCloze();
$("submitBtn").onclick = ()=>submitFilled();
$("resetBtn").onclick = ()=>resetThis();
$("skipBtn").onclick = ()=>nextDialogue();
$("hintBtn").onclick = ()=>{
  // show translation only, no extra text blocks
  if(state.current?.zh){
    $("hintInline").textContent = state.current.zh;
  }else{
    $("hintInline").textContent = "ï¼ˆæ­¤é¡Œæ²’æœ‰ç¿»è­¯ï¼‰";
  }
};
$("hideBtn").onclick = ()=>{
  const on = $("replyCard").style.display !== "none";
  if(on) hideReplyUI(); else showReplyUI();
};

$("sceneSelect").onchange = async (e)=>{
  const id = e.target.value;
  await safeLoadScene(id, true);
};

function setQueryScene(id){
  const u = new URL(location.href);
  u.searchParams.set("scene", id);
  history.replaceState(null, "", u.toString());
}

async function safeLoadScene(id, updateQuery){
  try{
    hideFatal();
    hideReplyUI();
    setStatus(`è®€å– ${id}.jsonâ€¦`);
    await loadSceneById(id);
    if(updateQuery) setQueryScene(id);
    renderCurrent();
  }catch(err){
    showFatal(String(err?.message || err));
    // keep UI but no fake data
    setQuestionText("â€”");
    $("hintInline").textContent = "";
    renderChips([]);
    $("replyInput").value = "";
    showReplyUI();
  }
}

/* ----- Boot ----- */
(async function boot(){
  try{
    hideFatal();
    hideReplyUI();
    await loadIndex();

    const qid = getSceneFromQuery();
    const initial = (qid && state.scenes.some(s=>s.id===qid)) ? qid : state.scenes[0].id;

    $("sceneSelect").value = initial;
    await safeLoadScene(initial, true);

    setupRecog();

    // iOS voices populate after async
    if("speechSynthesis" in window){
      window.speechSynthesis.onvoiceschanged = ()=>{};
    }
  }catch(err){
    showFatal(String(err?.message || err));
  }
})();
</script>
</body>
</html>
