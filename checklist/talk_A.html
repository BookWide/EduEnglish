<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Talk｜BookWide</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;background:#f6f7fb;margin:0}
.wrap{max-width:980px;margin:24px auto;padding:0 12px}
.card{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:16px;margin-bottom:16px}
.btn{border-radius:999px;padding:10px 14px;border:1px solid #e5e7eb;background:#fff}
.primary{background:#2563eb;color:#fff;border:none}
.row{display:flex;gap:8px;flex-wrap:wrap}
h1{font-size:18px;margin:0}
.small{color:#6b7280;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h1>Talk</h1>
      <div class="row">
        <select id="sceneSelect" class="btn"></select>
        <button id="reload" class="btn">重播</button>
      </div>
    </div>
  </div>

  <div class="card" id="aiCard">
    <div><strong id="aiText">Loading...</strong></div>
    <div class="small" id="aiSub"></div>
  </div>

  <div class="card">
    <div class="row">
      <button class="btn">輸入</button>
      <button class="btn">跳過</button>
      <button class="btn">提示</button>
      <button class="btn">收藏</button>
      <button class="btn">填空引導</button>
    </div>
  </div>

  <div class="card">
    <div><strong>你的回覆</strong></div>
    <div id="userText" style="font-size:18px;margin:8px 0">—</div>
    <div class="row">
      <input id="answer" class="btn" style="flex:1" placeholder="填入空格..."/>
      <button id="submit" class="btn primary">送出填好句</button>
      <button id="reset" class="btn">重來</button>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL='https://jeajrwpmrgczimmrflxo.supabase.co';
const SUPABASE_ANON_KEY=window.SUPABASE_ANON_KEY||'';

const qs = new URLSearchParams(location.search);
let currentWeek = Number(qs.get('week')||1);

async function loadIndex(){
  const res = await fetch('/EduEnglish/talk/index.json',{cache:'no-store'});
  const j = await res.json();
  return j.scenes||[];
}

function renderSelect(scenes){
  const sel=document.getElementById('sceneSelect');
  sel.innerHTML='';
  scenes.filter(s=>s.week===currentWeek).forEach(s=>{
    const o=document.createElement('option');
    o.value=s.id;
    o.textContent=`W${s.week} · Task ${s.order}`;
    sel.appendChild(o);
  });
}

function showSceneById(scenes,id){
  const s=scenes.find(x=>x.id===id);
  document.getElementById('aiText').textContent=s?.title||'—';
  document.getElementById('aiSub').textContent='';
  document.getElementById('userText').textContent='';
}

(async function(){
  try{
    const scenes=await loadIndex();
    renderSelect(scenes);
    const sel=document.getElementById('sceneSelect');
    if(sel.options.length){
      showSceneById(scenes, sel.value);
    }
    sel.onchange=()=>showSceneById(scenes, sel.value);
    document.getElementById('reload').onclick=()=>showSceneById(scenes, sel.value);
    document.getElementById('submit').onclick=()=>{
      document.getElementById('userText').textContent=document.getElementById('answer').value||'—';
    };
    document.getElementById('reset').onclick=()=>{
      document.getElementById('answer').value='';
      document.getElementById('userText').textContent='—';
    };
  }catch(e){
    document.getElementById('aiText').textContent='Index JSON not found.';
  }
})();
</script>
</body>
</html>
