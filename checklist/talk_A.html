<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Talk A Adminï½œBookWide</title>
<style>
:root{
  --bg:#f4f6fb; --card:#fff; --ink:#0b1220; --muted:#5b667a; --line:#e6eaf0; --soft:#f6f8fb;
  --brand:#0b66ff; --brand2:#084fc6; --radius:24px; --shadow:0 12px 34px rgba(10,20,40,.10);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;background:var(--bg);color:var(--ink)}
a{color:inherit}
.wrap{max-width:980px;margin:0 auto;padding:12px 12px calc(14px + env(safe-area-inset-bottom));display:flex;flex-direction:column;gap:10px;min-height:100%}
.top{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.92);backdrop-filter:blur(10px);box-shadow:var(--shadow)}
.back{width:42px;height:42px;border-radius:999px;border:1px solid var(--line);background:#fff;display:grid;place-items:center;cursor:pointer}
.ttl{display:flex;flex-direction:column;gap:2px;min-width:0}
.ttl b{font-size:16px;line-height:1.1}
.ttl span{font-size:12px;color:var(--muted);line-height:1.1}
.topRight{margin-left:auto;display:flex;align-items:center;gap:8px;min-width:0}
.pill{display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#fff;min-width:0}
.pill b{font-size:12px;color:var(--muted);white-space:nowrap}
.sel{border:0;outline:none;background:transparent;font-weight:800;color:var(--ink);font-size:13px;max-width:62vw}
.btn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:10px 14px;font-weight:800;cursor:pointer}
.btn.primary{background:linear-gradient(180deg,var(--brand),var(--brand2));color:#fff;border-color:transparent;box-shadow:0 10px 22px rgba(11,102,255,.22)}
.card{border:1px solid var(--line);border-radius:var(--radius);background:var(--card);box-shadow:var(--shadow)}
.teacher{display:flex;gap:14px;align-items:center;padding:12px}
.avatar{width:76px;height:76px;border-radius:20px;overflow:hidden;border:1px solid var(--line);background:radial-gradient(circle at 30% 30%, #fff, #e9eef7)}
.avatar video,.avatar img{width:100%;height:100%;object-fit:cover;display:block}
.tInfo{min-width:0;flex:1}
.tInfo .sceneTitle{font-weight:900;font-size:18px;line-height:1.15;margin:0 0 4px}
.tInfo .meta{color:var(--muted);font-size:12px;line-height:1.2}
.aiLine{padding:14px 16px}
.aiEn{font-size:28px;font-weight:950;line-height:1.05;margin:0}
.aiZh{margin:6px 0 0;color:var(--muted);font-size:15px;line-height:1.15}
.controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;padding:10px 12px}
.mic{width:68px;height:68px;border-radius:999px;border:0;cursor:pointer;background:linear-gradient(180deg,var(--brand),var(--brand2));box-shadow:0 12px 26px rgba(11,102,255,.25);display:grid;place-items:center;color:#fff;font-size:26px}
.smallBtn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:10px 14px;font-weight:900;cursor:pointer;display:flex;gap:8px;align-items:center}
.smallBtn:active{transform:translateY(1px)}
.reply{padding:14px 16px}
.rTop{display:flex;align-items:center;gap:8px}
.rTop h3{margin:0;font-size:18px}
.rTop .sp{margin-left:auto;display:flex;gap:8px}
.chip{border:1px solid var(--line);border-radius:999px;padding:8px 12px;background:#fff;font-weight:900;color:var(--muted)}
.q{margin:10px 0 6px;font-size:30px;font-weight:950;line-height:1.05}
.help{margin:0 0 10px;color:var(--muted);font-size:13px;line-height:1.25}
.inputRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.inp{flex:1;min-width:220px;border:1px solid var(--line);border-radius:16px;padding:14px 14px;font-size:18px;outline:none;background:#fff}
.actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
.fullBtn{flex:1;min-width:220px;border:0;border-radius:18px;padding:14px 16px;font-size:18px;font-weight:950;cursor:pointer}
.fullBtn.primary{background:linear-gradient(180deg,var(--brand),var(--brand2));color:#fff;box-shadow:0 12px 24px rgba(11,102,255,.22)}
.notice{padding:10px 12px;border:1px dashed var(--line);border-radius:16px;background:rgba(255,255,255,.7);color:var(--muted);font-size:12px;line-height:1.3}
.admin{padding:10px 12px;display:none}
.admin.show{display:block}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.file{border:1px solid var(--line);border-radius:14px;padding:10px;background:#fff}
.kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;color:var(--muted)}
@media (max-width:520px){
  .aiEn{font-size:26px}
  .q{font-size:28px}
  .mic{width:64px;height:64px}
}
</style>

<script>
// ===== Global error guards (avoid Uncaught (in promise) Object) =====
window.addEventListener('unhandledrejection', (e) => {
  const reason = e.reason instanceof Error ? (e.reason.stack || e.reason.message) : safeStr(e.reason);
  console.error("UnhandledPromiseRejection:", e.reason);
  if (window.showErr) window.showErr("Promise Error: " + reason);
});
window.addEventListener('error', (e) => {
  console.error("RuntimeError:", e.message);
  if (window.showErr) window.showErr("Runtime Error: " + e.message);
});
function safeStr(v){ try{ return (typeof v==='string')?v:JSON.stringify(v); } catch(_){ return String(v); } }
</script>
</head>

<body>
<div class="wrap" id="app">
  <div class="top">
    <button class="back" id="btnBack" aria-label="back">â†</button>
    <div class="ttl">
      <b>Talk Aï¼ˆç®¡ç†ï¼‰</b>
      <span>TTSï¼šBrowser SpeechSynthesis</span>
    </div>
    <div class="topRight">
      <div class="pill">
        <b id="wkTag">W?</b>
        <select class="sel" id="sceneSel"></select>
      </div>
      <button class="btn" id="btnReplay">é‡æ’­</button>
      <button class="btn" id="btnAdmin">Admin</button>
    </div>
  </div>

  <div class="card teacher">
    <div class="avatar" aria-label="teacher">
      <video id="teacherVideo" muted playsinline loop preload="metadata"></video>
    </div>
    <div class="tInfo">
      <div class="sceneTitle" id="sceneTitle">è¼‰å…¥ä¸­â€¦</div>
      <div class="meta" id="sceneMeta">è®€å– index.jsonâ€¦</div>
    </div>
  </div>

  <div class="card aiLine">
    <p class="aiEn" id="aiEn">Loadingâ€¦</p>
    <p class="aiZh" id="aiZh">ï¼ˆè¼‰å…¥ä¸­â€¦ï¼‰</p>
  </div>

  <div class="card controls">
    <button class="mic" id="btnMic" title="èªéŸ³è¾¨è­˜">ğŸ¤</button>
    <button class="smallBtn" id="btnFocus">âŒ¨ï¸ è¼¸å…¥</button>
    <button class="smallBtn" id="btnSkip">è·³é</button>
    <button class="smallBtn" id="btnHint">æç¤º</button>
    <button class="smallBtn" id="btnSave">æ”¶è—</button>
    <button class="smallBtn" id="btnCloze">å¡«ç©ºå¼•å°</button>
  </div>

  <div class="card reply">
    <div class="rTop">
      <h3>ä½ çš„å›è¦†</h3>
      <div class="sp">
        <span class="chip" id="lvlChip">A1</span>
        <button class="btn" id="btnHide">éš±è—</button>
      </div>
    </div>
    <div class="q" id="qText">â€”</div>
    <p class="help" id="helpText">å°è©±æ¨¡å¼ï¼šAI å…ˆèªªä¸€å¥ï¼Œç­‰ä½ å›è¦†ï¼ˆèªéŸ³æˆ–è¼¸å…¥ï¼‰æ‰æœƒé€²ä¸‹ä¸€å¥ã€‚</p>
    <div class="inputRow">
      <input class="inp" id="userInput" placeholder="è¼¸å…¥å›è¦†â€¦"/>
    </div>
    <div class="actions">
      <button class="fullBtn primary" id="btnSubmit">âœ… é€å‡ºå¡«å¥½å¥</button>
      <button class="fullBtn" id="btnRetry">é‡ä¾†</button>
    </div>
    <div class="notice" id="errBox" style="display:none"></div>
  </div>

  <div class="card admin" id="adminBox">
    <div class="row" style="margin-bottom:8px">
      <div class="file">
        <div style="font-weight:900;margin-bottom:6px">é›¢ç·šæ¨¡å¼ï¼ˆfile://ï¼‰è«‹ä¸Šå‚³</div>
        <div class="row">
          <label class="file">index.json <input type="file" id="fileIndex" accept="application/json"></label>
          <label class="file">scene.json <input type="file" id="fileScene" accept="application/json"></label>
        </div>
      </div>
      <div class="file">
        <div style="font-weight:900;margin-bottom:6px">ç›®å‰æª”å</div>
        <div class="kbd" id="curJsonName">â€”</div>
      </div>
    </div>
    <div class="notice">æç¤ºï¼šä¸Šç·šæ™‚æœƒè‡ªå‹•è®€ <span class="kbd">/talk/index.json</span>ï¼ˆæˆ– <span class="kbd">../talk/index.json</span>ï¼‰èˆ‡ <span class="kbd">wxx.*.json</span>ï¼›æœ¬å€åªæ˜¯ç‚ºäº†è§£æ±º iPhone ç›´æ¥é–‹ä¸‹è¼‰æª”ï¼ˆfile://ï¼‰æ™‚ fetch å¤±æ•ˆã€‚</div>
  </div>
</div>

<script id="EMBED_INDEX" type="application/json">{
  "updated_at": "2026-01-09T14:18:08.561208Z",
  "scenes": [
    {
      "id": "w01.core.coffee_shop",
      "title": "W1 Core Â· Coffee Shop"
    },
    {
      "id": "w01.variation.restaurant_order",
      "title": "W1 Variation Â· Restaurant"
    },
    {
      "id": "w01.challenge.coffee_shop",
      "title": "W1 Challenge Â· Coffee Shop"
    },
    {
      "id": "w02.core.hotel_checkin",
      "title": "W2 Core Â· Hotel Check-in"
    },
    {
      "id": "w02.variation.airport",
      "title": "W2 Variation Â· Airport"
    },
    {
      "id": "w02.challenge.hotel_checkin",
      "title": "W2 Challenge Â· Hotel Check-in"
    },
    {
      "id": "w03.core.restaurant_order",
      "title": "W3 Core Â· Restaurant"
    },
    {
      "id": "w03.variation.airport",
      "title": "W3 Variation Â· Airport"
    },
    {
      "id": "w03.challenge.restaurant_order",
      "title": "W3 Challenge Â· Restaurant"
    },
    {
      "id": "w04.core.coffee_shop",
      "title": "W4 Core Â· Coffee Shop"
    },
    {
      "id": "w04.variation.hotel_checkin",
      "title": "W4 Variation Â· Hotel Check-in"
    },
    {
      "id": "w04.challenge.coffee_shop",
      "title": "W4 Challenge Â· Coffee Shop"
    },
    {
      "id": "w05.core.hotel_checkin",
      "title": "W5 Core Â· Hotel Check-in"
    },
    {
      "id": "w05.variation.restaurant_order",
      "title": "W5 Variation Â· Restaurant"
    },
    {
      "id": "w05.challenge.airport",
      "title": "W5 Challenge Â· Airport"
    },
    {
      "id": "w06.core.coffee_shop",
      "title": "W6 Core Â· Coffee Shop"
    },
    {
      "id": "w06.variation.restaurant_order",
      "title": "W6 Variation Â· Restaurant"
    },
    {
      "id": "w06.challenge.coffee_shop",
      "title": "W6 Challenge Â· Coffee Shop"
    },
    {
      "id": "w07.core.hotel_checkin",
      "title": "W7 Core Â· Hotel Check-in"
    },
    {
      "id": "w07.variation.business_meeting",
      "title": "W7 Variation Â· Business Meeting"
    },
    {
      "id": "w07.challenge.business_meeting",
      "title": "W7 Challenge Â· Business Meeting"
    },
    {
      "id": "w08.core.coffee_shop",
      "title": "W8 Core Â· Coffee Shop"
    },
    {
      "id": "w08.variation.restaurant_order",
      "title": "W8 Variation Â· Restaurant"
    },
    {
      "id": "w08.challenge.restaurant_order",
      "title": "W8 Challenge Â· Restaurant"
    }
  ]
}</script>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  const state = {
    index: null,
    curScene: null,
    curSceneJson: null,
    lineIdx: 0,
    hideZh: false,
    recog: null,
      clozeActive: false,
    clozeText: '',
};

  function showErr(msg) {
    const box = $("errBox");
    box.style.display = "block";
    box.textContent = msg;
  }
  function clearErr() {
    const box = $("errBox");
    box.style.display = "none";
    box.textContent = "";
  }

  

// ===== Cloze (å¡«ç©ºå¼•å°) =====
const BW_STOP_WORDS = new Set([
  "the","a","an","and","or","but","so","to","of","in","on","at","for","with","from",
  "is","are","am","was","were","be","been","being",
  "do","does","did","done",
  "i","you","he","she","it","we","they","me","him","her","us","them",
  "my","your","his","her","its","our","their",
  "this","that","these","those",
  "what","which","who","whom","where","when","why","how",
  "would","could","should","can","will","may","might","must",
  "please","thanks","thank"
]);

function bw_sceneFallbackSentence(){
  const sid = (document.getElementById("sceneSel")?.value || "").toLowerCase();
  if (sid.includes("coffee")) return "What would you like to drink?";
  if (sid.includes("restaurant")) return "May I take your order?";
  if (sid.includes("hotel")) return "I have a reservation under my name.";
  if (sid.includes("airport")) return "Where is the check-in counter?";
  if (sid.includes("business")) return "Could we schedule a meeting for tomorrow?";
  return "Can you help me, please?";
}

function bw_getBaseEnForCloze(){
  const en = (document.getElementById("aiEn")?.textContent || "").trim();
  if (en && !/^loading/i.test(en) && !en.includes("æ‰¾ä¸åˆ°")) return en;
  return bw_sceneFallbackSentence();
}

function bw_makeCloze(sentence, maxHoles=2){
  const s = (sentence || "").trim();
  if(!s) return { ok:false, cloze:"â€”", answer:"", msg:"æ²’æœ‰å¯ç”¨å¥å­" };

  const tokens = s.split(/(\s+)/); // keep spaces
  const cands = [];
  for (let i=0;i<tokens.length;i++){
    const w = tokens[i];
    if(!w || /^\s+$/.test(w)) continue;
    const m = /^[A-Za-z][A-Za-z'\-]{3,}$/.exec(w);
    if(!m) continue;
    const low = w.toLowerCase();
    if (BW_STOP_WORDS.has(low)) continue;
    const score = w.replace(/[^A-Za-z]/g,"").length;
    cands.push({i, w, score});
  }

  if(!cands.length){
    return { ok:true, cloze: s.replace(/[A-Za-z][A-Za-z'\-]*/,"_____"), answer:"", msg:"" };
  }

  cands.sort((a,b)=> (b.score-a.score) || (a.i-b.i));
  const pick = cands.slice(0, Math.max(1, Math.min(maxHoles, cands.length)));

  const answers = [];
  for (const p of pick){
    answers.push(tokens[p.i]);
    tokens[p.i] = "_____";
  }
  return { ok:true, cloze: tokens.join(""), answer: answers.join(" / "), msg:"" };
}

function bw_applyCloze(){
  clearErr();
  const base = bw_getBaseEnForCloze();
  const r = bw_makeCloze(base, 2);
  if(!r.ok){
    showErr("å¡«ç©ºå¼•å°ï¼š" + r.msg);
    return;
  }
  state.clozeActive = true;
  state.clozeText = r.cloze;

  $("qText").textContent = r.cloze; // âœ… é¡¯ç¤ºåœ¨ã€Œä½ çš„å›è¦†ã€å€ï¼ˆqTextï¼‰
  $("helpText").textContent = "å¡«ç©ºå¼•å°ï¼šè«‹å®Œæˆç©ºæ ¼å¾Œé€å‡ºã€‚" + (r.answer ? "ï¼ˆç­”æ¡ˆæç¤ºï¼š" + r.answer + "ï¼‰" : "");
  $("userInput").focus();
  $("qText").scrollIntoView({behavior:"smooth", block:"center"});
}

function bw_clearCloze(){
  state.clozeActive = false;
  state.clozeText = "";
}

function parseWeekFromId(id) {
    const m = /^w(\d\d)/i.exec(id || "");
    return m ? ("W" + String(parseInt(m[1],10))) : "W?";
  }

  function setTeacherMedia() {
    const url = "https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/assets/avatars/talk.mp4";
    const v = $("teacherVideo");
    v.src = url;
    v.autoplay = true;
    v.muted = true;
    v.loop = true;
    v.playsInline = true;
    v.play().catch(()=>{});
  }

  async function fetchFirst(urls) {
    let lastErr = null;
    for (const u of urls) {
      try {
        const r = await fetch(u, {cache:"no-store"});
        if (!r.ok) throw new Error(u + " HTTP " + r.status);
        return await r.json();
      } catch(e) {
        lastErr = e;
      }
    }
    throw lastErr || new Error("fetch failed");
  }

  function buildIndexCandidates() {
    const base = location.pathname || "";
    const inChecklist = base.includes("/checklist/");
    return [
      "./talk/index.json",
      "../talk/index.json",
      "/talk/index.json",
      "talk/index.json",
      inChecklist ? "../talk/index.json" : "./talk/index.json",
    ];
  }
  function buildSceneCandidates(sceneId) {
    const fname = sceneId + ".json";
    const base = location.pathname || "";
    const inChecklist = base.includes("/checklist/");
    return [
      "./talk/" + fname,
      "../talk/" + fname,
      "/talk/" + fname,
      "talk/" + fname,
      inChecklist ? "../talk/" + fname : "./talk/" + fname,
    ];
  }

  function fillSceneSelect() {
    const sel = $("sceneSel");
    sel.innerHTML = "";
    for (const s of (state.index?.scenes || [])) {
      const opt = document.createElement("option");
      opt.value = s.id;
      opt.textContent = s.title || s.id;
      sel.appendChild(opt);
    }
  }

  function normalizeSceneJson(js) {
    if (Array.isArray(js)) return { lines: js };
    if (js && Array.isArray(js.lines)) return js;
    if (js && Array.isArray(js.dialogue)) return { lines: js.dialogue };
    if (js && Array.isArray(js.items)) return { lines: js.items };
    return { lines: [] };
  }

  function render() {
    const scene = state.curScene;
    $("sceneTitle").textContent = scene?.title || scene?.id || "â€”";
    $("wkTag").textContent = parseWeekFromId(scene?.id);
    const meta = [];
    if (scene?.id) meta.push(scene.id);
    if (scene?.subtitle) meta.push(scene.subtitle);
    $("sceneMeta").textContent = meta.join(" Â· ") || "â€”";

    const lines = state.curSceneJson?.lines || [];
    const line = lines[state.lineIdx] || lines[0] || null;

    const aiEn = (line?.ai_en || line?.en || line?.teacher || line?.text || "Loadingâ€¦");
    const aiZh = (line?.ai_zh || line?.zh || line?.zh_tw || line?.translation || "");
    $("aiEn").textContent = aiEn;
    $("aiZh").textContent = state.hideZh ? "" : (aiZh || " ");

    const q = (line?.q || line?.question || line?.prompt || line?.user_en || line?.cloze || "â€”");
    if(state.clozeActive && state.clozeText){
      $("qText").textContent = state.clozeText;
    } else {
      $("qText").textContent = q;
    }
$("curJsonName").textContent = scene?.id ? (scene.id + ".json") : "â€”";
    clearErr();
  }

  async function loadIndex() {
    try {
      state.index = await fetchFirst(buildIndexCandidates());
    } catch(e) {
      try {
        const embed = $("EMBED_INDEX").textContent || "";
        state.index = JSON.parse(embed);
      } catch(_) {
        state.index = { scenes: [] };
      }
    }
    fillSceneSelect();
  }

  async function loadSceneById(id) {
    const scene = (state.index?.scenes || []).find(s=>s.id===id) || {id, title:id};
    state.curScene = scene;
    state.lineIdx = 0;

    try {
      const js = await fetchFirst(buildSceneCandidates(id));
      state.curSceneJson = normalizeSceneJson(js);
    } catch(e) {
      state.curSceneJson = { lines: [{en:"Loadingâ€¦", zh:"ï¼ˆæ‰¾ä¸åˆ° " + id + ".jsonï¼‰", q:"â€”"}] };
      showErr("è®€å– " + id + ".json å¤±æ•—ï¼ˆè‹¥ä½ æ˜¯ç”¨ iPhone ç›´æ¥é–‹ä¸‹è¼‰æª”ï¼Œè«‹æŒ‰ Admin ä¸Šå‚³ scene.jsonï¼‰ã€‚");
    }
    render();
  }

  function speak(text) {
    try {
      if (!("speechSynthesis" in window)) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "en-US";
      u.rate = 1.0;
      window.speechSynthesis.speak(u);
    } catch(_) {}
  }

  function setupRecog() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) return null;
    const r = new SR();
    r.lang = "en-US";
    r.interimResults = true;
    r.continuous = false;
    r.onresult = (ev)=> {
      let t = "";
      for (let i=ev.resultIndex;i<ev.results.length;i++) t += ev.results[i][0].transcript;
      $("userInput").value = (t || "").trim();
    };
    r.onerror = (e)=>showErr("èªéŸ³è¾¨è­˜å¤±æ•—ï¼š" + (e.error||""));
    return r;
  }

  function nextLine() {
    const lines = state.curSceneJson?.lines || [];
    if (!lines.length) return;
    state.lineIdx = Math.min(state.lineIdx + 1, lines.length - 1);
    render();
    speak($("aiEn").textContent);
  }

  $("btnBack").onclick = ()=> history.back();
  $("btnReplay").onclick = ()=> speak($("aiEn").textContent);
  $("btnFocus").onclick = ()=> $("userInput").focus();
  $("btnSkip").onclick = ()=> { bw_clearCloze(); nextLine(); };
  $("btnHint").onclick = ()=> alert("æç¤ºï¼ˆdemoï¼‰ï¼šè«‹çœ‹ä¸­æ–‡æç¤ºï¼Œæˆ–å…ˆç”¨ç°¡çŸ­å¥å›è¦†ã€‚");
  $("btnSave").onclick = ()=> alert("æ”¶è—ï¼ˆdemoï¼‰ï¼šç®¡ç†ç‰ˆå¯ä¹‹å¾Œæ¥è³‡æ–™åº«ã€‚");
  $("btnCloze").onclick = ()=> bw_applyCloze();
  $("btnHide").onclick = ()=> { state.hideZh = !state.hideZh; $("btnHide").textContent = state.hideZh ? "é¡¯ç¤º" : "éš±è—"; render(); };
  $("btnSubmit").onclick = ()=> { bw_clearCloze(); nextLine(); };
  $("btnRetry").onclick = ()=> { bw_clearCloze(); state.lineIdx = 0; $("userInput").value=""; render(); };
  $("sceneSel").onchange = (e)=> { bw_clearCloze(); loadSceneById(e.target.value); };
  $("btnAdmin").onclick = ()=> $("adminBox").classList.toggle("show");

  $("fileIndex").addEventListener("change", async (e)=> {
    const f = e.target.files?.[0]; if (!f) return;
    try {
      state.index = JSON.parse(await f.text());
      fillSceneSelect();
      if (state.index.scenes?.length) {
        $("sceneSel").value = state.index.scenes[0].id;
        await loadSceneById(state.index.scenes[0].id);
      }
    } catch(err) {
      showErr("index.json è§£æå¤±æ•—");
    }
  });
  $("fileScene").addEventListener("change", async (e)=> {
    const f = e.target.files?.[0]; if (!f) return;
    try {
      const js = JSON.parse(await f.text());
      state.curSceneJson = normalizeSceneJson(js);
      state.lineIdx = 0;
      render();
    } catch(err) {
      showErr("scene.json è§£æå¤±æ•—");
    }
  });

  setTeacherMedia();
  state.recog = setupRecog();
  $("btnMic").onclick = ()=> {
    clearErr();
    if (!state.recog) return showErr("æ­¤ç€è¦½å™¨ä¸æ”¯æ´ SpeechRecognitionã€‚è«‹ç”¨ Chrome/Edgeã€‚");
    try { state.recog.start(); } catch(_) {}
  };

  (async ()=>{
    await loadIndex();
    const first = state.index?.scenes?.[0]?.id;
    const urlScene = new URLSearchParams(location.search).get("scene");
    const target = urlScene || first;
    if (target) {
      $("sceneSel").value = target;
      await loadSceneById(target);
    } else {
      render();
    }
  })();
})();
</script>
</body>
</html>
