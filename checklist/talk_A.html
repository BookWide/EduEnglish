<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Talk Aï½œBookWide</title>
<style>
:root{
  --bg:#eef2fb;
  --card:#ffffff;
  --ink:#0b1220;
  --muted:#5b667a;
  --line:#e6eaf0;
  --brand:#0b66ff;
  --brand2:#084fc6;
  --radius:26px;
  --shadow:0 12px 34px rgba(10,20,40,.10);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
  background:var(--bg);
  color:var(--ink);
}
.wrap{max-width:980px;margin:0 auto;padding:14px 14px calc(16px + env(safe-area-inset-bottom));display:flex;flex-direction:column;gap:14px;min-height:100%}

/* teacher header */
.card{border:1px solid var(--line);border-radius:var(--radius);background:var(--card);box-shadow:var(--shadow)}
.teacher{padding:16px;display:flex;gap:16px;align-items:flex-start}
.avatar{width:82px;height:82px;border-radius:22px;overflow:hidden;border:1px solid var(--line);background:radial-gradient(circle at 30% 30%, #fff, #e9eef7);flex:0 0 auto}
.avatar video,.avatar img{width:100%;height:100%;object-fit:cover;display:block}
.bubble{flex:1;min-width:0}
.bubbleBox{
  border:1px solid var(--line);
  border-radius:22px;
  padding:14px 16px;
  background:#fff;
}
.aiEn{font-size:22px;font-weight:950;line-height:1.15;margin:0}
.aiZh{margin:6px 0 0;color:var(--muted);font-size:14px;line-height:1.25}
.progress{margin-top:10px;color:var(--muted);font-size:12px;line-height:1.2}

/* controls row like screenshot */
.controlsRow{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.micWrap{width:74px;height:74px;border-radius:999px;background:linear-gradient(180deg,var(--brand),var(--brand2));box-shadow:0 12px 26px rgba(11,102,255,.25);display:grid;place-items:center;flex:0 0 auto}
.micBtn{width:64px;height:64px;border-radius:999px;border:0;background:transparent;color:#fff;font-size:28px;cursor:pointer}
.pills{display:flex;gap:10px;flex-wrap:wrap}
.pillBtn{
  border:1px solid var(--line);
  background:#fff;
  border-radius:999px;
  padding:10px 14px;
  font-weight:900;
  cursor:pointer;
}
.pillBtn:active{transform:translateY(1px)}

/* reply card */
.reply{padding:16px}
.rTop{display:flex;align-items:center;gap:10px}
.rTop h3{margin:0;font-size:18px}
.rTop .right{margin-left:auto;display:flex;gap:10px;align-items:center}
.badge{border:1px solid var(--line);border-radius:999px;padding:8px 12px;background:#fff;font-weight:900}
.badge.muted{color:var(--muted)}
.bigQ{margin:12px 0 8px;font-size:30px;font-weight:950;line-height:1.06}
.help{margin:0 0 12px;color:var(--muted);font-size:13px;line-height:1.25}

/* hint chips */
.chips{display:flex;gap:10px;flex-wrap:wrap;margin:0 0 12px}
.chip{
  border:1px solid var(--line);
  border-radius:999px;
  padding:8px 14px;
  background:#fff;
  font-weight:900;
  cursor:pointer;
}
.chip:active{transform:translateY(1px)}

/* input + actions */
.inp{
  width:100%;
  border:1px solid var(--line);
  border-radius:18px;
  padding:16px 16px;
  font-size:18px;
  outline:none;
  background:#fff;
}
.actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:14px}
.primaryBtn{
  flex:1;min-width:220px;
  border:0;border-radius:20px;
  padding:14px 16px;
  font-size:18px;font-weight:950;
  cursor:pointer;
  background:linear-gradient(180deg,var(--brand),var(--brand2));
  color:#fff;
  box-shadow:0 12px 24px rgba(11,102,255,.22);
}
.secondaryBtn{
  flex:0 0 auto;min-width:120px;
  border:1px solid var(--line);
  border-radius:20px;
  padding:14px 16px;
  font-size:18px;font-weight:950;
  cursor:pointer;
  background:#fff;
}
.notice{margin-top:12px;padding:10px 12px;border:1px dashed var(--line);border-radius:16px;background:rgba(255,255,255,.7);color:var(--muted);font-size:12px;line-height:1.3;display:none}

/* hidden (kept for compatibility) */
.hidden{display:none !important}

@media (max-width:520px){
  .aiEn{font-size:20px}
  .bigQ{font-size:28px}
  .micWrap{width:70px;height:70px}
  .micBtn{width:60px;height:60px}
}
</style>

<script>
/* ===== Global error guards (avoid Uncaught (in promise) Object) ===== */
window.addEventListener('unhandledrejection', (e) => {
  const reason = e.reason instanceof Error ? (e.reason.stack || e.reason.message) : safeStr(e.reason);
  console.error("UnhandledPromiseRejection:", e.reason);
  if (window.showErr) window.showErr("Promise Error: " + reason);
});
window.addEventListener('error', (e) => {
  console.error("RuntimeError:", e.message);
  if (window.showErr) window.showErr("Runtime Error: " + e.message);
});
function safeStr(v){ try{ return (typeof v==='string')?v:JSON.stringify(v); } catch(_){ return String(v); } }
</script>
</head>

<body>
<div class="wrap" id="app">

  <div class="card teacher">
    <div class="avatar" aria-label="teacher">
      <video id="teacherVideo" muted playsinline loop preload="metadata"></video>
    </div>
    <div class="bubble">
      <div class="bubbleBox">
        <p class="aiEn" id="aiEn">Loadingâ€¦</p>
        <p class="aiZh" id="aiZh">ï¼ˆè¼‰å…¥ä¸­â€¦ï¼‰</p>
      </div>
      <div class="progress" id="progressText">æœ¬é€±ï¼š3 å€‹ç·´ç¿’ï¼ˆCore / Variation / Challengeï¼‰ Â· é€²åº¦ 1/4</div>
    </div>
  </div>

  <div class="controlsRow">
    <div class="micWrap">
      <button class="micBtn" id="btnMic" title="èªéŸ³è¾¨è­˜">ğŸ¤</button>
    </div>
    <div class="pills">
      <button class="pillBtn" id="btnFocus">è¼¸å…¥</button>
      <button class="pillBtn" id="btnSkip">è·³é</button>
      <button class="pillBtn" id="btnHint">æç¤º</button>
      <button class="pillBtn" id="btnSave">æ”¶è—</button>
      <button class="pillBtn" id="btnCloze">å¡«ç©ºå¼•å°</button>
    </div>
  </div>

  <div class="card reply">
    <div class="rTop">
      <h3>ä½ çš„å›è¦†</h3>
      <div class="right">
        <span class="badge" id="lvlChip">A1</span>
        <button class="badge muted" id="btnHide" type="button">éš±è—</button>
      </div>
    </div>

    <div class="bigQ" id="qText">â€”</div>
    <p class="help" id="helpText">å°è©±æ¨¡å¼ï¼šAI å…ˆèªªä¸€å¥ï¼Œç­‰ä½ å›è¦†ï¼ˆèªéŸ³æˆ–è¼¸å…¥ï¼‰æ‰æœƒé€²ä¸‹ä¸€å¥ã€‚æŒ‰ã€Œæç¤ºã€å¯é¡¯ç¤ºå®Œæ•´å»ºè­°å¥ã€‚</p>

    <div class="chips" id="hintChips" style="display:none"></div>

    <input class="inp" id="userInput" placeholder="å¡«å…¥ç©ºæ ¼â€¦"/>

    <div class="actions">
      <button class="primaryBtn" id="btnSubmit">âœ… é€å‡ºå¡«å¥½å¥</button>
      <button class="secondaryBtn" id="btnRetry">é‡ä¾†</button>
    </div>

    <div class="notice" id="errBox"></div>
  </div>

  <!-- keep for compatibility: scene select (hidden) -->
  <select id="sceneSel" class="hidden"></select>

</div>

<script id="EMBED_INDEX" type="application/json">{
  "updated_at": "2026-01-09T14:18:08.561208Z",
  "scenes": [
    {"id":"w01.core.coffee_shop","title":"W1 Core Â· Coffee Shop"},
    {"id":"w01.variation.restaurant_order","title":"W1 Variation Â· Restaurant"},
    {"id":"w01.challenge.coffee_shop","title":"W1 Challenge Â· Coffee Shop"},
    {"id":"w02.core.hotel_checkin","title":"W2 Core Â· Hotel Check-in"},
    {"id":"w02.variation.airport","title":"W2 Variation Â· Airport"},
    {"id":"w02.challenge.hotel_checkin","title":"W2 Challenge Â· Hotel Check-in"},
    {"id":"w03.core.restaurant_order","title":"W3 Core Â· Restaurant"},
    {"id":"w03.variation.airport","title":"W3 Variation Â· Airport"},
    {"id":"w03.challenge.restaurant_order","title":"W3 Challenge Â· Restaurant"},
    {"id":"w04.core.coffee_shop","title":"W4 Core Â· Coffee Shop"},
    {"id":"w04.variation.hotel_checkin","title":"W4 Variation Â· Hotel Check-in"},
    {"id":"w04.challenge.coffee_shop","title":"W4 Challenge Â· Coffee Shop"},
    {"id":"w05.core.hotel_checkin","title":"W5 Core Â· Hotel Check-in"},
    {"id":"w05.variation.restaurant_order","title":"W5 Variation Â· Restaurant"},
    {"id":"w05.challenge.airport","title":"W5 Challenge Â· Airport"},
    {"id":"w06.core.coffee_shop","title":"W6 Core Â· Coffee Shop"},
    {"id":"w06.variation.restaurant_order","title":"W6 Variation Â· Restaurant"},
    {"id":"w06.challenge.coffee_shop","title":"W6 Challenge Â· Coffee Shop"},
    {"id":"w07.core.hotel_checkin","title":"W7 Core Â· Hotel Check-in"},
    {"id":"w07.variation.business_meeting","title":"W7 Variation Â· Business Meeting"},
    {"id":"w07.challenge.business_meeting","title":"W7 Challenge Â· Business Meeting"},
    {"id":"w08.core.coffee_shop","title":"W8 Core Â· Coffee Shop"},
    {"id":"w08.variation.restaurant_order","title":"W8 Variation Â· Restaurant"},
    {"id":"w08.challenge.restaurant_order","title":"W8 Challenge Â· Restaurant"}
  ]
}</script>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);

  /* ========= UI error ========= */
  function showErr(msg) {
    const box = $("errBox");
    box.style.display = "block";
    box.textContent = msg;
  }
  window.showErr = showErr;
  function clearErr() {
    const box = $("errBox");
    box.style.display = "none";
    box.textContent = "";
  }

  /* ========= TTS (robust) ========= */
  let bwVoices = [];
  function bwRefreshVoices(){
    try { bwVoices = window.speechSynthesis.getVoices() || []; }
    catch(_) { bwVoices = []; }
  }
  function bwPickVoice(langPrefix){
    const lp = (langPrefix || "en").toLowerCase();
    return bwVoices.find(v => (v.lang||"").toLowerCase().startsWith(lp)) || bwVoices[0] || null;
  }
  bwRefreshVoices();
  if ("speechSynthesis" in window) window.speechSynthesis.onvoiceschanged = bwRefreshVoices;

  let bwTtsUnlocked = false;
  function bwUnlockTTS(){
    if (bwTtsUnlocked) return;
    bwTtsUnlocked = true;
    try{
      const u = new SpeechSynthesisUtterance(" ");
      u.volume = 0;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }catch(_){}
  }
  window.addEventListener("pointerdown", bwUnlockTTS, { once:true, capture:true });

  function bwSpeak(text, lang="en-US"){
    return new Promise((resolve, reject)=>{
      try{
        bwUnlockTTS();
        if (!("speechSynthesis" in window)) throw new Error("SpeechSynthesis not supported");
        const t = (text || "").trim();
        if (!t || /^loading/i.test(t)) throw new Error("No text to speak");
        bwRefreshVoices();

        const u = new SpeechSynthesisUtterance(t);
        u.lang = lang;
        u.rate = 1.0;
        u.pitch = 1.0;
        u.volume = 1.0;

        const v = bwPickVoice(lang.split("-")[0]);
        if (v) u.voice = v;

        u.onend = ()=> resolve(true);
        u.onerror = (ev)=> reject(ev?.error || new Error("TTS error"));

        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);

        setTimeout(()=>{
          try{
            if (window.speechSynthesis.speaking) return;
            bwRefreshVoices();
            const v2 = bwPickVoice(lang.split("-")[0]);
            if (v2) u.voice = v2;
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(u);
          }catch(_){}
        }, 220);
      }catch(e){ reject(e); }
    });
  }

  async function speak(text){
    try{
      clearErr();
      await bwSpeak(text, "en-US");
    }catch(e){
      const msg = (e && e.message) ? e.message : String(e);
      showErr("TTS å¤±æ•—ï¼š" + msg);
    }
  }

  /* ========= state ========= */
  const state = {
    index: null,
    curScene: null,
    curSceneJson: null,
    lineIdx: 0,
    hideZh: false,
    recog: null,
    clozeActive: false,
    clozeText: "",
    clozeAnswers: [],   // tokens selected to blank
  };

  /* ========= Cloze ========= */
  const BW_STOP_WORDS = new Set([
    "the","a","an","and","or","but","so","to","of","in","on","at","for","with","from",
    "is","are","am","was","were","be","been","being",
    "do","does","did","done",
    "i","you","he","she","it","we","they","me","him","her","us","them",
    "my","your","his","her","its","our","their",
    "this","that","these","those",
    "what","which","who","whom","where","when","why","how",
    "would","could","should","can","will","may","might","must",
    "please","thanks","thank"
  ]);

  function bw_sceneFallbackSentence(){
    const sid = (state.curScene?.id || "").toLowerCase();
    if (sid.includes("coffee")) return "What would you like to drink?";
    if (sid.includes("restaurant")) return "May I take your order?";
    if (sid.includes("hotel")) return "I have a reservation under my name.";
    if (sid.includes("airport")) return "Where is the check-in counter?";
    if (sid.includes("business")) return "Could we schedule a meeting for tomorrow?";
    return "Can you help me, please?";
  }

  function bw_getBaseEnForCloze(){
    const en = ($("aiEn")?.textContent || "").trim();
    if (en && !/^loading/i.test(en) && !en.includes("æ‰¾ä¸åˆ°")) return en;
    return bw_sceneFallbackSentence();
  }

  function bw_makeCloze(sentence, maxHoles=2){
    const s = (sentence || "").trim();
    if(!s) return { ok:false, cloze:"â€”", answers:[], msg:"æ²’æœ‰å¯ç”¨å¥å­" };

    const tokens = s.split(/(\s+)/); // keep spaces
    const cands = [];
    for (let i=0;i<tokens.length;i++){
      const w = tokens[i];
      if(!w || /^\s+$/.test(w)) continue;
      const m = /^[A-Za-z][A-Za-z'\-]{3,}$/.exec(w);
      if(!m) continue;
      const low = w.toLowerCase();
      if (BW_STOP_WORDS.has(low)) continue;
      const score = w.replace(/[^A-Za-z]/g,"").length;
      cands.push({i, w, score});
    }

    if(!cands.length){
      // fallback: blank the first word
      const cloze = s.replace(/[A-Za-z][A-Za-z'\-]*/,"_____");
      return { ok:true, cloze, answers:[], msg:"" };
    }

    cands.sort((a,b)=> (b.score-a.score) || (a.i-b.i));
    const pick = cands.slice(0, Math.max(1, Math.min(maxHoles, cands.length)));

    const answers = [];
    for (const p of pick){
      answers.push(tokens[p.i]);
      tokens[p.i] = "_____";
    }
    return { ok:true, cloze: tokens.join(""), answers, msg:"" };
  }

  function bw_renderChips(words){
    const box = $("hintChips");
    box.innerHTML = "";
    const arr = (words || []).filter(Boolean).slice(0, 5);
    if(!arr.length){
      box.style.display = "none";
      return;
    }
    box.style.display = "flex";
    for(const w of arr){
      const b = document.createElement("button");
      b.type = "button";
      b.className = "chip";
      b.textContent = w.replace(/[^A-Za-z'\-]/g,"");
      b.onclick = ()=> {
        const inp = $("userInput");
        const t = (inp.value || "").trim();
        inp.value = (t ? (t + " ") : "") + b.textContent;
        inp.focus();
      };
      box.appendChild(b);
    }
  }

  function bw_applyCloze(){
    clearErr();
    const base = bw_getBaseEnForCloze();
    const r = bw_makeCloze(base, 2);
    if(!r.ok){
      showErr("å¡«ç©ºå¼•å°ï¼š" + r.msg);
      return;
    }
    state.clozeActive = true;
    state.clozeText = r.cloze;
    state.clozeAnswers = r.answers || [];

    $("qText").textContent = r.cloze;               // é¡¯ç¤ºåœ¨ã€Œä½ çš„å›è¦†ã€
    $("helpText").textContent = "å¡«å…¥ç©ºæ ¼å¾Œé€å‡ºï¼ˆå¯é»ä¸‹æ–¹æç¤ºå­—å¡å¿«é€Ÿå¡«å…¥ï¼‰ã€‚";
    $("userInput").value = "";
    $("userInput").placeholder = "å¡«å…¥ç©ºæ ¼â€¦";
    bw_renderChips(state.clozeAnswers);

    $("userInput").focus();
    $("qText").scrollIntoView({behavior:"smooth", block:"center"});
  }

  function bw_clearCloze(){
    state.clozeActive = false;
    state.clozeText = "";
    state.clozeAnswers = [];
    bw_renderChips([]);
    $("userInput").placeholder = "å¡«å…¥ç©ºæ ¼â€¦";
  }

  function countBlanks(s){
    const m = (s || "").match(/_____+/g);
    return m ? m.length : 0;
  }
  function fillBlanks(template, fills){
    let out = template;
    for(const f of fills){
      out = out.replace(/_____+/, f);
    }
    return out;
  }

  /* ========= media ========= */
  function setTeacherMedia() {
    const url = "https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/assets/avatars/talk.mp4";
    const v = $("teacherVideo");
    v.src = url;
    v.autoplay = true;
    v.muted = true;
    v.loop = true;
    v.playsInline = true;
    v.play().catch(()=>{});
  }

  /* ========= data loading ========= */
  async function fetchFirst(urls) {
    let lastErr = null;
    for (const u of urls) {
      try {
        const r = await fetch(u, {cache:"no-store"});
        if (!r.ok) throw new Error(u + " HTTP " + r.status);
        return await r.json();
      } catch(e) { lastErr = e; }
    }
    throw lastErr || new Error("fetch failed");
  }

  function buildIndexCandidates() {
    return ["./talk/index.json","../talk/index.json","/talk/index.json","talk/index.json"];
  }
  function buildSceneCandidates(sceneId) {
    const fname = sceneId + ".json";
    return ["./talk/" + fname,"../talk/" + fname,"/talk/" + fname,"talk/" + fname];
  }

  function fillSceneSelect() {
    const sel = $("sceneSel");
    sel.innerHTML = "";
    for (const s of (state.index?.scenes || [])) {
      const opt = document.createElement("option");
      opt.value = s.id;
      opt.textContent = s.title || s.id;
      sel.appendChild(opt);
    }
  }

  function normalizeSceneJson(js) {
    if (Array.isArray(js)) return { lines: js };
    if (js && Array.isArray(js.lines)) return js;
    if (js && Array.isArray(js.dialogue)) return { lines: js.dialogue };
    if (js && Array.isArray(js.items)) return { lines: js.items };
    return { lines: [] };
  }

  function render() {
    const lines = state.curSceneJson?.lines || [];
    const line = lines[state.lineIdx] || lines[0] || null;

    const aiEn = (line?.ai_en || line?.en || line?.teacher || line?.text || "Loadingâ€¦");
    const aiZh = (line?.ai_zh || line?.zh || line?.zh_tw || line?.translation || "");
    $("aiEn").textContent = aiEn;
    $("aiZh").textContent = state.hideZh ? "" : (aiZh || " ");

    const q = (line?.q || line?.question || line?.prompt || line?.user_en || line?.cloze || "â€”");

    if(state.clozeActive && state.clozeText){
      $("qText").textContent = state.clozeText;
    } else {
      $("qText").textContent = q;
    }

    clearErr();
  }

  async function loadIndex() {
    try {
      state.index = await fetchFirst(buildIndexCandidates());
    } catch(e) {
      try {
        state.index = JSON.parse($("EMBED_INDEX").textContent || "{}");
      } catch(_) {
        state.index = { scenes: [] };
      }
    }
    fillSceneSelect();
  }

  async function loadSceneById(id) {
    const scene = (state.index?.scenes || []).find(s=>s.id===id) || {id, title:id};
    state.curScene = scene;
    state.lineIdx = 0;

    try {
      const js = await fetchFirst(buildSceneCandidates(id));
      state.curSceneJson = normalizeSceneJson(js);
    } catch(e) {
      state.curSceneJson = { lines: [{en:"Loadingâ€¦", zh:"ï¼ˆæ‰¾ä¸åˆ° " + id + ".jsonï¼‰", q:"â€”"}] };
      showErr("è®€å– " + id + ".json å¤±æ•—ï¼šè«‹ç¢ºèª /talk/ ç›®éŒ„æœ‰æª”æ¡ˆã€‚");
    }
    render();
    // speak after render to avoid mobile timing issues
    setTimeout(()=> speak($("aiEn").textContent), 60);
  }

  /* ========= SpeechRecognition ========= */
  function setupRecog() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) return null;
    const r = new SR();
    r.lang = "en-US";
    r.interimResults = true;
    r.continuous = false;
    r.onresult = (ev)=> {
      let t = "";
      for (let i=ev.resultIndex;i<ev.results.length;i++) t += ev.results[i][0].transcript;
      $("userInput").value = (t || "").trim();
    };
    r.onerror = (e)=>showErr("èªéŸ³è¾¨è­˜å¤±æ•—ï¼š" + (e.error||""));
    return r;
  }

  function nextLine() {
    const lines = state.curSceneJson?.lines || [];
    if (!lines.length) return;
    state.lineIdx = Math.min(state.lineIdx + 1, lines.length - 1);
    bw_clearCloze();
    $("userInput").value = "";
    render();
    setTimeout(()=> speak($("aiEn").textContent), 60);
  }

  /* ========= actions ========= */
  $("aiEn").onclick = ()=> speak($("aiEn").textContent);
  $("btnFocus").onclick = ()=> $("userInput").focus();

  $("btnSkip").onclick = ()=> { bw_clearCloze(); nextLine(); };

  $("btnHint").onclick = ()=> {
    // å­¸å“¡ç‰ˆï¼šæç¤º = é¡¯ç¤ºå®Œæ•´å»ºè­°å¥ï¼ˆæŠŠç©ºæ ¼ç­”æ¡ˆç•¶ä½œæç¤ºå­—å¡ï¼‰
    if(state.clozeActive){
      const tips = state.clozeAnswers && state.clozeAnswers.length ? state.clozeAnswers : [];
      if(tips.length){
        showErr("æç¤ºï¼šå¯é»å­—å¡å¡«å…¥ç©ºæ ¼ã€‚");
        setTimeout(()=> clearErr(), 1200);
      }else{
        showErr("æç¤ºï¼šè«‹ç”¨ç°¡çŸ­å¥å›è¦†ã€‚");
      }
      return;
    }
    // éå¡«ç©ºï¼šæŠŠ qText è®Šæˆå»ºè­°å›è¦†ï¼ˆç”¨ aiEn ç•¶ç¤ºç¯„ï¼‰
    $("qText").textContent = bw_getBaseEnForCloze();
    $("helpText").textContent = "æç¤ºï¼šä½ å¯ä»¥ç…§è‘—ä¸Šé¢å¥å­å›è¦†ï¼ˆæˆ–æŒ‰ã€Œå¡«ç©ºå¼•å°ã€è®Šæˆç©ºæ ¼ï¼‰ã€‚";
  };

  $("btnSave").onclick = ()=> showErr("æ”¶è—ï¼šå­¸å“¡ç‰ˆå¯ä¹‹å¾Œæ¥è³‡æ–™åº«ã€‚");

  $("btnCloze").onclick = ()=> bw_applyCloze();

  $("btnHide").onclick = ()=> {
    state.hideZh = !state.hideZh;
    $("btnHide").textContent = state.hideZh ? "é¡¯ç¤º" : "éš±è—";
    render();
  };

  $("btnSubmit").onclick = ()=> {
    clearErr();

    if(state.clozeActive){
      const tpl = state.clozeText || "";
      const n = countBlanks(tpl);
      const raw = ($("userInput").value || "").trim();
      const fills = raw ? raw.split(/\s+/).filter(Boolean) : [];
      if(!n){
        // no blanks -> treat as normal submit
        bw_clearCloze();
        nextLine();
        return;
      }
      if(fills.length < n){
        showErr("é‚„å·® " + (n - fills.length) + " å€‹ç©ºæ ¼æ²’å¡«ã€‚");
        return;
      }
      const done = fillBlanks(tpl, fills.slice(0, n));
      $("qText").textContent = done;
      bw_clearCloze();
      $("userInput").value = "";
      // push to next line like your screenshot flow
      setTimeout(()=> nextLine(), 220);
      return;
    }

    // éå¡«ç©ºï¼šç›´æ¥ä¸‹ä¸€å¥
    nextLine();
  };

  $("btnRetry").onclick = ()=> {
    bw_clearCloze();
    state.lineIdx = 0;
    $("userInput").value = "";
    render();
    setTimeout(()=> speak($("aiEn").textContent), 60);
  };

  /* ========= init ========= */
  setTeacherMedia();
  state.recog = setupRecog();
  $("btnMic").onclick = ()=> {
    clearErr();
    if (!state.recog) return showErr("æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ã€‚è«‹ç”¨ Chrome/Edgeã€‚");
    try { state.recog.start(); } catch(_) {}
  };

  (async ()=>{
    await loadIndex();
    const first = state.index?.scenes?.[0]?.id;
    const urlScene = new URLSearchParams(location.search).get("scene");
    const target = urlScene || first;
    if (target) {
      $("sceneSel").value = target;
      await loadSceneById(target);
    } else {
      render();
    }
  })();
})();
</script>
</body>
</html>
