<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Talk Aï¼ˆæ‰‹æ©Ÿå£èªªï¼‰ï½œBookWide</title>
  <style>
    :root{
      --bg:#ffffff; --ink:#0b1220; --muted:#5b667a; --line:#e6eaf0; --soft:#f6f8fb;
      --pill:#111827; --pillText:#ffffff; --shadow:0 10px 28px rgba(10,20,40,.10);
      --radius:18px; --radius2:24px; --btn:#0b66ff; --btn2:#084fc6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      background:var(--bg); color:var(--ink); overflow:hidden;
    }
    .app{height:100%;display:flex;flex-direction:column;padding:12px 12px calc(12px + env(safe-area-inset-bottom));gap:10px;max-width:980px;margin:0 auto;}
    .top{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;box-shadow:var(--shadow);}
    .back{width:36px;height:36px;border-radius:999px;border:1px solid var(--line);background:#fff;display:grid;place-items:center;cursor:pointer;flex:0 0 auto;}
    .title{display:flex;flex-direction:column;gap:2px;min-width:0;}
    .title b{font-size:15px;line-height:1.1}
    .title small{font-size:12px;color:var(--muted)}
    .spacer{flex:1}
    .scenario{display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:999px;padding:8px 10px;background:var(--soft);min-width:220px;max-width:420px;}
    .scenario select{width:100%;border:0;background:transparent;font-size:14px;outline:none;color:var(--ink);appearance:none;}
    .btn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 10px;cursor:pointer;font-size:13px;white-space:nowrap;}
    .stage{flex:1;min-height:0;border:1px solid var(--line);border-radius:var(--radius2);background:#fff;box-shadow:var(--shadow);padding:14px;display:flex;flex-direction:column;gap:10px;}
    .who{display:flex;align-items:center;gap:10px;}
    .pill{display:inline-flex;align-items:center;gap:8px;background:var(--pill);color:var(--pillText);border-radius:999px;padding:6px 10px;font-size:12px;}
    .statusDot{width:8px;height:8px;border-radius:99px;background:#94a3b8;}
    .statusDot.on{background:#10b981}
    .who small{color:var(--muted)}

    .center{display:flex;align-items:center;justify-content:flex-start;gap:18px;padding:8px 0 2px;}
    .avatarWrap{
      width:min(180px,42vw); aspect-ratio:1/1; border-radius:999px;
      background:radial-gradient(circle at 30% 30%, #e9eef7, #ffffff 55%, #e9eef7);
      border:1px solid var(--line);
      box-shadow:0 20px 60px rgba(10,20,40,.12) inset;
      display:grid; place-items:center; position:relative; overflow:hidden;
    }
    .avatarImg{
      width:78%; height:78%; border-radius:999px; object-fit:cover;
      border:6px solid rgba(255,255,255,.9);
      box-shadow:0 18px 48px rgba(10,20,40,.18);
      background:#fff;
      transition:transform .18s ease, box-shadow .18s ease;
    }
    .avatarWrap.speaking .avatarImg{transform:scale(1.03); box-shadow:0 26px 80px rgba(0,0,0,.22);}
    .avatarVid{
      display:none;
      width:78%; height:78%; border-radius:999px; object-fit:cover;
      border:6px solid rgba(255,255,255,.9);
      box-shadow:0 18px 48px rgba(10,20,40,.18);
      background:#fff;
    }
    .avatarWrap.speaking .avatarImg{display:none;}
    .avatarWrap.speaking .avatarVid{display:block;transform:scale(1.03); box-shadow:0 26px 80px rgba(0,0,0,.22);}


    .dialog{border:1px solid var(--line);border-radius:var(--radius);padding:14px;background:var(--soft);}
    .dialog .en{font-size:22px;line-height:1.35;font-weight:800;letter-spacing:.2px;}
    .dialog .zh{margin-top:6px;font-size:13px;color:var(--muted);line-height:1.4;}
    .note{border:1px dashed var(--line);border-radius:var(--radius);padding:10px 12px;color:var(--muted);font-size:12px;line-height:1.4;background:#fff;}
    .controls{display:flex;flex-direction:column;gap:10px;}
    .micRow{display:flex;align-items:center;gap:10px;}
    .micBtn{
      flex:1;border:0;background:linear-gradient(180deg,var(--btn),var(--btn2));color:#fff;border-radius:999px;
      padding:14px 16px;font-weight:800;font-size:15px;cursor:pointer;box-shadow:0 14px 30px rgba(11,102,255,.25);
      display:flex;align-items:center;justify-content:center;gap:10px;
    }
    .skipBtn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:14px 16px;font-weight:700;cursor:pointer;min-width:96px;}
    .helperRow{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;}
    .helperBtn{border:1px solid var(--line);background:#fff;border-radius:var(--radius);padding:12px 10px;text-align:left;cursor:pointer;min-height:62px;box-shadow:0 8px 18px rgba(10,20,40,.06);}
    .helperBtn b{display:block;font-size:14px}
    .helperBtn small{display:block;margin-top:4px;color:var(--muted);font-size:12px}
    .softHint{margin-top:12px;padding:12px 14px;border:1px solid var(--line);border-radius:14px;background:#fff7ed;color:#7c2d12;font-size:15px;line-height:1.35;box-shadow:0 10px 28px rgba(15,23,42,.08)}
    .softHint b{font-weight:800}
    .softHint .sub{display:block;margin-top:6px;color:#92400e;font-size:13px}

    .sheetMask{position:fixed;inset:0;background:rgba(0,0,0,.28);display:none;z-index:50;}
    .sheetMask.show{display:block}
    .sheet{position:fixed;left:0;right:0;bottom:0;background:#fff;border-radius:18px 18px 0 0;border:1px solid var(--line);
      box-shadow:0 -24px 60px rgba(10,20,40,.18);max-width:980px;margin:0 auto;max-height:78vh;transform:translateY(110%);
      transition:transform .22s ease;z-index:51;overflow:hidden;}
    .sheet.show{transform:translateY(0)}
    .sheetHead{display:flex;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid var(--line);background:var(--soft);}
    .grab{width:42px;height:5px;border-radius:99px;background:#cfd6e3;margin:0 auto;}
    .sheetClose{margin-left:auto;border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 10px;cursor:pointer;font-weight:800;font-size:13px;}
    .sheetBody{padding:14px;overflow:auto;max-height:calc(78vh - 52px);}
    .card{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff;margin-bottom:10px;}
    .card h3{margin:0 0 8px 0;font-size:14px}
    .card p{margin:0;color:var(--muted);line-height:1.5}
    .row{display:flex;flex-wrap:wrap;gap:8px;}
    .tag{display:inline-flex;align-items:center;padding:4px 8px;border-radius:999px;background:var(--soft);border:1px solid var(--line);font-size:12px;color:var(--muted);}

    .gate{position:fixed;inset:0;background:rgba(255,255,255,.92);display:none;z-index:80;padding:22px;}
    .gate.show{display:flex;align-items:center;justify-content:center}
    .gateBox{width:min(520px,92vw);border:1px solid var(--line);border-radius:18px;background:#fff;box-shadow:var(--shadow);padding:16px;text-align:center;}
    .gateBox h2{margin:6px 0 8px 0;font-size:18px}
    .gateBox p{margin:0 0 12px 0;color:var(--muted);line-height:1.5}
    .gateBox button{border:0;background:linear-gradient(180deg,var(--btn),var(--btn2));color:#fff;border-radius:999px;padding:12px 16px;font-weight:900;cursor:pointer;width:100%;}

    @media (max-width:520px){
      .scenario{min-width:0;max-width:none}
      .dialog .en{font-size:20px}
      .helperRow{gap:8px}
      .helperBtn{padding:10px 8px;min-height:58px}
      .helperBtn b{font-size:13px}
      .helperBtn small{font-size:11px}
      .micBtn{font-size:14px;padding:13px 14px}
      .skipBtn{padding:13px 14px}
    }
  
/* =========================================
   Mobile Only Patch (Talk A11)
   - å…è¨±æ•´é ä¸Šä¸‹æ»‘å‹•ï¼ˆiOS ä¸å†å¡æ­»ï¼‰
   - AI é ­åƒç¸®å°ï¼ˆä¸æ˜¯ä¸»è§’ï¼‰
   - ä¸Šæ–¹å€åŸŸè®Šç˜¦ï¼Œç•™ç©ºé–“çµ¦ä¸‹æ–¹ä»»å‹™åˆ—
========================================= */
@media (max-width: 768px){
  html,body{height:auto !important; overflow:auto !important;}
  body{overflow:auto !important; -webkit-overflow-scrolling:touch !important;}
  .app{height:auto !important; min-height:100vh !important; padding-top:10px !important;}
  .stage{min-height:auto !important; overflow:auto !important; -webkit-overflow-scrolling:touch !important;}

  /* Top bar è®Šç˜¦ */
  .top{padding:8px 10px !important; gap:8px !important;}
  .title small{display:none !important;} /* æ‰‹æ©Ÿå…ˆä¸é¡¯ç¤º TTS å­æ¨™ */
  .scenario{padding:6px 10px !important;}
  .btn{padding:6px 10px !important;}

  /* è®“å ´æ™¯ä¸‹æ‹‰æ›´å¥½é» */
  .scenario select{font-size:13px !important;}

  /* é ­åƒç¸®å°ï¼ˆç•™ç©ºé–“çµ¦åº•éƒ¨ï¼‰ */
  .center{padding:4px 0 0 !important;}
  .avatarWrap{width:min(128px,38vw) !important;}
  .avatarImg,.avatarVid{width:80% !important; height:80% !important;}

  /* å°è©±å¡ç¨å¾®æ”¶é«˜ï¼ˆä¸æ”¹é¢¨æ ¼ï¼‰ */
  .dialog{padding:12px !important;}
  .dialog .en{font-size:20px !important; line-height:1.2 !important;}
  .dialog .zh{font-size:12px !important;}

  /* æŒ‰éˆ•åˆ—ç·Šæ¹Šé»ï¼Œé¿å…æ“ åˆ°åº• */
  .micBtn{padding:12px 14px !important;}
  .skipBtn{padding:12px 14px !important;}
  .helperRow{gap:8px !important;}
  .helperBtn{min-height:56px !important; padding:10px 8px !important;}
}


/* ===== ä»»å‹™/ç¯„ä¾‹æµ®çª— (v20260107-stable) ===== */
#missionBox, #examplesBox{
  position:fixed;
  left:12px; right:12px;
  bottom:12px;
  max-height:62vh;
  overflow:auto;
  background:#ffffff;
  border:1px solid rgba(0,0,0,.08);
  border-radius:18px;
  box-shadow:0 18px 50px rgba(15,23,42,.18);
  padding:14px 14px 18px;
  z-index:9999;
  display:none;
}
#missionBox .btn, #examplesBox .btn{
  display:inline-flex; align-items:center; gap:8px;
  padding:10px 12px; border-radius:14px;
  border:1px solid rgba(0,0,0,.10);
  background:#fff; color:#111827;
  text-decoration:none; font-weight:800;
}
#missionBox .btn:hover, #examplesBox .btn:hover{background:rgba(0,0,0,.03);}

/* ===== å¡«ç©ºæŒ‰éˆ•æ¨£å¼ï¼ˆv20260107-fillï¼‰===== */
.fillChoice{
  border:1px solid rgba(0,0,0,.10);
  background:var(--soft);
  border-radius:999px;
  padding:8px 10px;
  cursor:pointer;
  font-weight:800;
  font-size:13px;
}
.fillChoice:hover{background:rgba(0,0,0,.03);}
.fillSlot{
  border:1px dashed rgba(0,0,0,.18);
  background:#fff;
  border-radius:999px;
  padding:6px 10px;
  font-weight:900;
  font-size:13px;
}


/* ===== æƒ…å¢ƒå½±ç‰‡å€ï¼ˆv20260107-sceneVideoï¼‰===== */
.sceneBox{
  flex:1 1 auto;
  min-width:240px;
  border:1px solid var(--line);
  border-radius:var(--radius);
  background:#fff;
  padding:10px;
}
.sceneHead{display:flex;gap:10px;align-items:baseline;flex-wrap:wrap}
.sceneTitle{font-weight:900}
.sceneHint{color:var(--muted);font-size:12px}
.sceneVid{width:100%;max-height:260px;border-radius:14px;background:#0b1220;display:none}
.sceneEmpty{margin-top:10px;color:var(--muted);font-size:12px}
@media (max-width: 780px){
  .center{flex-direction:column;align-items:center}
  .sceneBox{width:100%}
  .sceneVid{max-height:220px}
}


/* ===== åº•éƒ¨ä»»å‹™åˆ—å›ºå®šï¼ˆv20260107-bottomDockï¼‰===== */
body{padding-bottom:120px;} /* é¿å…è¢«å›ºå®šåˆ—è“‹ä½ */
.helperRow{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:14px;
  width:min(980px, calc(100vw - 24px));
  z-index:50;
  background:rgba(255,255,255,.92);
  border:1px solid var(--line);
  border-radius:16px;
  padding:10px;
  box-shadow:0 18px 46px rgba(15,23,42,.18);
  backdrop-filter: blur(8px);
}
@media (max-width: 780px){
  body{padding-bottom:140px;}
  .helperRow{bottom:10px;border-radius:18px;padding:10px;}
}


/* ===== å¡«ç©ºæç¤ºä½ç½®å¾®èª¿ï¼ˆv20260107-fillbar-up10mmï¼‰===== */
#fillBar{
  margin-top:-38px;
}
@media (max-width: 780px){
  #fillBar{ margin-top:-28px; }
}


/* ===== FINAL Mobile One-Page Lock (vFINAL-20260107) ===== */
@media (max-width: 780px){
  html, body{
    width:100%;
    max-width:100%;
    overflow-x:hidden !important;
    overscroll-behavior-x:none;
  }
  .app, .stage, .center, .main{
    max-width:100%;
    overflow-x:hidden !important;
  }
  /* æƒ…å¢ƒå½±ç‰‡å€ç¸®å°ï¼Œä¸æ¶ç•«é¢ */
  .sceneBox{ padding:8px !important; }
  .sceneVid{ max-height:160px !important; }
}

</style>
  <style id="bwGateHide">body{opacity:0;}</style>
<script>setTimeout(()=>{try{document.getElementById('bwGateHide')?.remove();}catch(e){}},3000);</script>

<script>
/* ====== Global error guard (avoid blank screen) ====== */
(function(){
  function toText(x){
    try{
      if (x instanceof Error) return x.stack || x.message || String(x);
      if (typeof x === 'string') return x;
      return JSON.stringify(x);
    }catch(e){ return String(x); }
  }
  function showFatal(msg){
    var el = document.getElementById('bwFatal');
    if(!el){
      el = document.createElement('div');
      el.id = 'bwFatal';
      el.style.cssText = 'position:fixed;left:12px;right:12px;top:12px;z-index:999999;background:#fff;border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,.18);padding:14px 14px 12px;display:none;max-width:720px;margin:0 auto;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC","Microsoft JhengHei",sans-serif;';
      el.innerHTML =
        '<div style="font-weight:800;margin-bottom:8px">ç³»çµ±è¼‰å…¥å¤±æ•—</div>'+
        '<div id="bwFatalMsg" style="white-space:pre-wrap;color:#334155;font-size:13px;line-height:1.4"></div>'+
        '<div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">'+
          '<button id="bwFatalReload" style="padding:10px 12px;border-radius:12px;border:1px solid #e2e8f0;background:#0f172a;color:#fff;font-weight:700">é‡æ–°æ•´ç†</button>'+
          '<a id="bwFatalPricing" href="pricing.html" style="padding:10px 12px;border-radius:12px;border:1px solid #e2e8f0;background:#fff;color:#0f172a;font-weight:700;text-decoration:none">å‰å¾€è¨‚é–±</a>'+
        '</div>';
      document.addEventListener('DOMContentLoaded', function(){ document.body.appendChild(el); });
      // if DOM already ready
      if (document.body) document.body.appendChild(el);
      el.querySelector('#bwFatalReload').onclick = function(){ location.reload(); };
    }
    var msgEl = el.querySelector('#bwFatalMsg');
    if(msgEl) msgEl.textContent = msg;
    el.style.display = 'block';
  }
  window.addEventListener('error', function(e){
    if(document.body) showFatal(toText(e.error || e.message || e));
  });
  window.addEventListener('unhandledrejection', function(e){
    if(document.body) showFatal('Uncaught (in promise)\n' + toText(e.reason));
  });
  window.BW_showFatal = showFatal;
})();
</script>

</head>
<body>
  <div class="app">
    <div class="top">
      <button class="back" id="btnBack" aria-label="back">â†</button>
      <div class="title">
        <b>Talk Aï¼ˆæ‰‹æ©Ÿå£èªªï¼‰</b>
        <small id="subTitle">TTSï¼šBrowser SpeechSynthesis</small>
      </div>
      <div class="spacer"></div>
      <div class="scenario">
        <select id="sceneSelect"></select>
      </div>
      <button class="btn" id="btnReplay">é‡æ’­æœ¬å¥</button>
    </div>

    <div class="stage">
      <div class="who">
        <span class="pill"><span class="statusDot" id="dot"></span><span id="roleLabel">AI Â· teacher</span></span>
        <small id="sceneLabel">â€”</small>
      </div>

      <div class="center">
        <div class="avatarWrap" id="avatarWrap">
          <video class="avatarVid" id="avatarVid" preload="auto" playsinline muted></video>
          <img class="avatarImg" id="avatarImg" alt="AI Avatar" style="display:none" />
        </div>

        <!-- ===== æƒ…å¢ƒå½±ç‰‡å€ï¼ˆv20260107-sceneVideoï¼‰===== -->
        <div class="sceneBox" id="sceneBox">
          <div class="sceneHead">
            <div class="sceneTitle">æƒ…å¢ƒå½±ç‰‡</div>
            <div class="sceneHint">ï¼ˆå¯æ”¾ CapCut å½±ç‰‡è³£é»ï¼‰</div>
          </div>
          <video class="sceneVid" id="sceneVid" controls playsinline preload="metadata"></video>
          <div class="sceneEmpty" id="sceneEmpty">å°šæœªè¨­å®šæƒ…å¢ƒå½±ç‰‡ï¼ˆå¯åœ¨å ´æ™¯ JSON çš„ meta.scene_video æŒ‡å®š mp4 URLï¼‰</div>
        </div>
      </div>

      <div class="dialog" id="dialogBox">
        <div class="en" id="lineEN">Loadingâ€¦</div>
        <div class="zh" id="lineZH">ï¼ˆè¼‰å…¥ä¸­â€¦ï¼‰</div>
      </div>

      <div class="note" id="heardText" style="display:none">ä½ èªªï¼šâ€”</div>
      <div class="softHint" id="softHint" style="display:none"></div>

      <div class="controls">
        <div class="micRow">
          <button class="micBtn" id="btnMic">ğŸ¤ é»æˆ‘èªªï¼ˆé–‹å§‹è¾¨è­˜ï¼‰</button>
          <button class="skipBtn" id="btnType">âŒ¨ï¸ è¼¸å…¥</button>
          <button class="skipBtn" id="btnSkip">è·³é</button>
        <!-- ===== å¡«ç©ºå¼•å°åˆ—ï¼ˆv20260107-fillï¼‰===== -->
        <div id="fillBar" style="display:none;margin-top:6px;border:1px solid var(--line);border-radius:var(--radius);padding:10px;background:#fff;">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
            <div style="font-weight:900;font-size:13px;">å¡«ç©ºæç¤º</div>
            <div class="tag" id="fillLevelTag" style="margin-left:auto;">A2</div>
            <button class="btn" id="btnFillHide" type="button">éš±è—</button>
          </div>
          <div id="fillMasked" style="margin-top:8px;font-size:16px;line-height:1.35;font-weight:900;letter-spacing:.2px;"></div>
          <div id="fillSlots" style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;"></div>
          <div id="fillChoices" style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;"></div>
          <div style="margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <button class="micBtn" id="btnFillSubmit" type="button" style="padding:10px 14px;font-size:14px;flex:0 0 auto;box-shadow:none;">âœ… é€å‡ºå¡«å¥½å¥</button>
            <button class="skipBtn" id="btnFillReset" type="button" style="padding:10px 14px;">é‡ä¾†</button>
            <div style="color:var(--muted);font-size:12px;">æç¤ºï¼šå…ˆç”¨ã€Œå¡«ç©ºã€å®Œæˆä¸€å¥ï¼Œå†æ”¹æˆä½ è‡ªå·±çš„èªªæ³•ã€‚</div>
          </div>
        </div>

        </div>

        <div class="helperRow">
          <button class="helperBtn" id="btnTask"><b>ä»»å‹™</b><small>è¦åšä»€éº¼</small></button>
          <button class="helperBtn" id="btnExamples"><b>ç¯„ä¾‹</b><small>ä¸æœƒå¥</small></button>
          <button class="helperBtn" id="btnTranslate"><b>ç¿»è­¯</b><small>ä¸­ / æ—¥</small></button>
          <button class="helperBtn" id="btnSaved"><b>å·²å„²å­˜</b><small>å–®å­—å¥</small></button>
        </div>

        <div id="hintTools" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px;">
          <button class="btn" id="btnHintToggle" type="button">æç¤ºï¼ˆå±•é–‹ï¼‰</button>
          <button class="btn" id="btnHintSave" type="button">â˜… æ”¶è—æœ¬å¥</button>
          <button class="btn" id="btnHintClose" type="button">Ã— é—œé–‰æç¤º</button>
          <button class="btn" id="btnHintFill" type="button">ğŸ§© å¡«ç©ºå¼•å°</button>
        </div>
        <div class="note" id="noteText">ä¸»é ä¿æŒåœ¨å°è©±ä¸­ï¼›é»ã€Œä»»å‹™ / ç¯„ä¾‹ / ç¿»è­¯ / å·²å„²å­˜ã€åªæœƒæ‰“é–‹è¼”åŠ©å°çª—ï¼Œä¸æœƒä¸­æ–·å°è©±ã€‚</div>
      </div>
    </div>
  </div>

  <div class="sheetMask" id="sheetMask"></div>
  <div class="sheet" id="sheet">
    <div class="sheetHead">
      <div style="width:100%"><div class="grab"></div></div>
      <button class="sheetClose" id="sheetClose">é—œé–‰</button>
    </div>
    <div class="sheetBody" id="sheetBody"></div>
  </div>

  <div class="gate" id="gate">
    <div class="gateBox">
      <h2>é»ä¸€ä¸‹å•Ÿå‹•èªéŸ³</h2>
      <p>iPhone/éƒ¨åˆ†ç€è¦½å™¨æœƒé˜»æ“‹ã€Œè‡ªå‹•å‡ºè²ã€ã€‚é»ä¸€æ¬¡å¾Œå°±å¯æ­£å¸¸æœ—è®€ã€‚</p>
      <button id="gateBtn">é–‹å§‹</button>
    </div>
  </div>


  <!-- ä»»å‹™/ç¯„ä¾‹ æµ®çª—ï¼ˆé¿å… missionBox/examplesBox undefinedï¼‰ -->
  <div id="missionBox" aria-label="ä»»å‹™" role="dialog"></div>
  <div id="examplesBox" aria-label="ç¯„ä¾‹" role="dialog"></div>

<script type="module">
  /* ===== BookWide Talk Gate (same rule as player.html) =====
     - å¿…é ˆå…ˆç™»å…¥
     - è¨‚é–±ä»¥ profiles.expires_at ç‚ºå”¯ä¸€æ¬Šå¨ï¼ˆé¿å… orders/items å·®ç•°é€ æˆèª¤è¸¢ï¼‰
     - å¯ç”¨ ?preview=1 é€²è¡Œå…§éƒ¨æ¸¬è©¦ï¼ˆé è¨­ä¸é–‹æ”¾å¤–éƒ¨ï¼‰
  */
  import { supabase as talkSupa, SUPABASE_URL } from "./supa.js";

  // expose for debugging / future learning-console scoring submit
  window.talkSupa = talkSupa;

  const ROOT_BASE = ""; // keep consistent with player.html
  const paramsGate = new URLSearchParams(location.search);
  const isPreview = paramsGate.get("preview") === "1";

  async function waitUser(maxMs = 1500, stepMs = 250){
    const t0 = Date.now();
    while(Date.now() - t0 < maxMs){
      try{
        const { data } = await talkSupa.auth.getUser();
        if(data && data.user) return data.user;
      }catch(e){}
      await new Promise(r=>setTimeout(r, stepMs));
    }
    return null;
  }

  async function runGate(){
    // 1) å¿…é ˆç™»å…¥ï¼ˆpreview ä¹Ÿå¿…é ˆç™»å…¥ï¼Œèˆ‡ player.html ä¸€è‡´ï¼‰
    const user = await waitUser(1500, 250);
    if(!user){
      const next = location.pathname + location.search;
      const url = new URL((ROOT_BASE||"") + "/index.html", location.origin);
      url.searchParams.set("denied","signin");
      url.searchParams.set("next", next);
      location.href = url.toString();
      return false;
    }

    // âœ… è©¦ç”¨é–‹æ”¾ï¼šç™»å…¥ä½†æœªè¨‚é–±ä¹Ÿå¯ç”¨ coffee_shopï¼ˆå¯è‡ªè¡Œå¢æ¸›ï¼‰
    const trialScene = (new URLSearchParams(location.search).get("scene") || "").trim();
    if (trialScene === "coffee_shop") return true;

    // 2) è¨‚é–±æª¢æŸ¥ï¼šé preview æ‰æª¢æŸ¥
    if(!isPreview){
      try{
        const { data: p, error: perr } = await talkSupa
          .from("profiles")
          .select("expires_at")
          .eq("id", user.id)
          .maybeSingle();

        if(perr){
          console.warn("[BW-talk] profiles expires_at read error =", perr);
        }

        const today = new Date();
        today.setHours(0,0,0,0);

        const exp = (p && p.expires_at) ? new Date(p.expires_at) : null;

        if(!exp || isNaN(exp.getTime())){
          const next = location.pathname + location.search;
          const url = new URL((ROOT_BASE||"") + "/pricing.html", location.origin);
          url.searchParams.set("denied","noactive");
          url.searchParams.set("next", next);
          location.href = url.toString();
          return false;
        }

        if(exp.getTime() < today.getTime()){
          const next = location.pathname + location.search;
          const url = new URL((ROOT_BASE||"") + "/pricing.html", location.origin);
          url.searchParams.set("denied","expired");
          url.searchParams.set("next", next);
          location.href = url.toString();
          return false;
        }

        console.log("[BW-talk] allow by profiles.expires_at =", exp.toISOString());
      }catch(e){
        console.error("[BW-talk] subscription check exception", e);
        const next = location.pathname + location.search;
        const url = new URL((ROOT_BASE||"") + "/pricing.html", location.origin);
        url.searchParams.set("denied","noactive");
        url.searchParams.set("next", next);
        location.href = url.toString();
        return false;
      }
    }

    // 3) gate pass â†’ é¡¯ç¤ºç•«é¢
    try{ document.getElementById("bwGateHide")?.remove(); }catch(_){}
    return true;
  }

  let __gateOk = false;
  try{
    __gateOk = await runGate();
  }catch(e){
    console.error('[gate] failed', e);
    try{ window.BW_showFatal && window.BW_showFatal('gate failed\n' + (e && (e.stack||e.message) || String(e))); }catch(_){ }
    __gateOk = false;
  } finally {
    // always unhide even if gate fails, to avoid white screen
    try{ document.getElementById("bwGateHide")?.remove(); }catch(_){}
  }
  if(!__gateOk){
    // go pricing, but don't throw (avoid Uncaught promise + hidden body)
    const next = encodeURIComponent(location.href);
    location.href = `pricing.html?next=${next}`;
  }


(function(){
  const $ = (id)=>document.getElementById(id);

  // ===== é˜²å‘†ï¼šé¿å… Chrome é¡¯ç¤ºã€ŒUncaught (in promise) Objectã€=====
  // é€™é€šå¸¸ä¾†è‡ªç€è¦½å™¨è‡ªå‹•æ’­æ”¾ç­–ç•¥/å¤–æ›/éŸ³è¨Šæ¬Šé™é€ æˆçš„ Promise rejectionã€‚
  // æˆ‘å€‘åœ¨é€™è£¡çµ±ä¸€åƒæ‰æœªè™•ç†çš„ rejectionï¼Œä¸¦åœ¨ console ç•™ä¸‹å¯è¿½æŸ¥è¨Šæ¯ã€‚
  window.addEventListener("unhandledrejection", (e)=>{
    try{
      console.warn("[TalkA] unhandledrejection:", e.reason);
      e.preventDefault();
    }catch(_){}
  });
  window.addEventListener("error", (e)=>{
    try{ console.warn("[TalkA] error:", e.message || e.error || e); }catch(_){}
  });


  // âœ… ç¾å¥³è€å¸«å”¯ä¸€ä¾†æºï¼ˆé–æ­»ï¼‰
// - ä¸åš fallbackã€ä¸åšéš¨æ©Ÿ bust
// - ä½ è¦æ›ç¾å¥³è€å¸«ï¼šåªè¦æŠŠ Supabase é€™æ”¯ talk.mp4 æ›æ‰å³å¯
  
  // ===== æƒ…å¢ƒå½±ç‰‡ï¼šå¾å ´æ™¯ JSON çš„ meta.scene_video æ›è¼‰ï¼ˆv20260107-sceneVideoï¼‰=====
  function updateSceneVideo(){
    const v = $("sceneVid");
    const empty = $("sceneEmpty");
    // æ”¯æ´ï¼šcurSceneData.meta.scene_video / sceneVideo / video
    const meta = (typeof curSceneData === "object" && curSceneData && curSceneData.meta) ? curSceneData.meta : {};
    const url = String(meta.scene_video || meta.sceneVideo || meta.video || "");
    if(!v) return;
    if(url){
      v.src = url;
      v.style.display = "block";
      if(empty) empty.style.display = "none";
    }else{
      try{ v.removeAttribute("src"); v.load && v.load(); }catch(_){}
      v.style.display = "none";
      if(empty) empty.style.display = "block";
    }
  }

const AVATAR_VIDEO_URL = "https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/assets/avatars/talk.mp4";

  const avatarWrap = $("avatarWrap");
  const safePlay = ()=>{
    try{
      const p = avatarVid && avatarVid.play ? avatarVid.play() : null;
      if(p && typeof p.catch === "function") p.catch(()=>{});
    }catch(_){ }
  };
  const avatarImg  = $("avatarImg");
  const avatarVid  = $("avatarVid");
  const dot = $("dot");

  // âœ… æ°¸é ä½¿ç”¨ talk.mp4ï¼ˆç¾å¥³è€å¸«ï¼‰ï¼Œä¸åš fallback
  function ensureAvatarVideo(){
    try{
      if(avatarVid && avatarVid.src !== AVATAR_VIDEO_URL){
        avatarVid.src = AVATAR_VIDEO_URL;
        avatarVid.preload = "auto";
        avatarVid.playsInline = true;
        avatarVid.muted = true;
        avatarVid.load();
      }
      if(avatarImg) avatarImg.style.display = "none";
      if(avatarVid) avatarVid.style.display = "block";
    }catch(e){}
  }

  function setAvatarState(state){
    ensureAvatarVideo();

    // state: "idle" | "listen" | "speak"
    try{
      if(state === "speak"){
        avatarVid.loop = true;
        safePlay();
        const p = null; // legacy
        if(p && typeof p.catch === "function") p.catch(()=>{});
        return;
      }
      // idle / listenï¼šåœåœ¨ç¬¬ä¸€å¹€ï¼ˆä¸æ’­æ”¾ï¼‰
      avatarVid.loop = false;
      avatarVid.pause();
      try{ avatarVid.currentTime = 0; }catch(_){}
    }catch(e){}
  }

  function setSpeaking(on){
    avatarWrap.classList.toggle("speaking", !!on);
    setAvatarState(on ? "speak" : "idle");
  }

  // è‹¥å½±ç‰‡è¼‰å…¥å¤±æ•—ï¼šåªæç¤ºï¼Œä¸åˆ‡æ›ä»»ä½• fallback åœ–
  if(avatarVid){
    avatarVid.addEventListener("error", ()=>{
      try{ avatarVid.pause(); }catch(_){}
      console.warn("[TalkA] avatar video load failed:", AVATAR_VIDEO_URL);
    });
  }

  // å…ˆæŠŠå½±ç‰‡æ›ä¸Šï¼ˆé¿å…ç¬¬ä¸€æ¬¡æ‰ set srcï¼‰
  ensureAvatarVideo();

  // ===== TTS =====
  let lastSpoken = "";
  let audioEnabled = false;
  const gate = $("gate");
  const gateBtn = $("gateBtn");

  function canSpeak(){ return ("speechSynthesis" in window) && ("SpeechSynthesisUtterance" in window); }
  function speak(text){
    const t = String(text||"").trim();
    if(!t || !canSpeak()) return Promise.resolve(false);
    lastSpoken = t;
    try{ speechSynthesis.cancel(); }catch(_){}
    return new Promise((resolve)=>{
      const u = new SpeechSynthesisUtterance(t);
      u.lang = "en-US";
      u.onstart = ()=>{ dot.classList.add("on"); setSpeaking(true); };
      u.onend   = ()=>{ dot.classList.remove("on"); setSpeaking(false); resolve(true); };
      u.onerror = ()=>{ dot.classList.remove("on"); setSpeaking(false); resolve(false); };
      try{ speechSynthesis.speak(u); }catch(e){ resolve(false); }
    });
  }
  async function speakOrGate(text){
    const t = String(text||"").trim();
    if(!t) return false;
    lastSpoken = t;
    if(!audioEnabled){
      gate.classList.add("show");
      return false;
    }
    return await speak(t);
  }
  gateBtn.addEventListener("click", async ()=>{
    gate.classList.remove("show");
    audioEnabled = true;
    await speak(lastSpoken);
  });
  ["click","touchstart","keydown"].forEach(evt=>{
    window.addEventListener(evt, ()=>{ if(!gate.classList.contains("show")) audioEnabled = true; }, { once:true, passive:true });
  });

  // ===== Bottom sheet =====
  const sheetMask = $("sheetMask");
  const sheet = $("sheet");
  const sheetBody = $("sheetBody");
  const sheetClose = $("sheetClose");
  function openSheet(title, html){
    const body = (html==null && title!=null) ? String(title) : String(html||"");
    const t = (html==null) ? "" : String(title||"");
    sheetBody.innerHTML = t ? (`<div class="pill" style="font-weight:900;margin-bottom:10px">`+t+`</div>` + body) : body;
    sheetMask.classList.add("show"); sheet.classList.add("show");
  }
  function closeSheet(){ sheetMask.classList.remove("show"); sheet.classList.remove("show"); }
  sheetMask.addEventListener("click", closeSheet);
  sheetClose.addEventListener("click", closeSheet);

  // ===== Scenes (æœ€å°å¯ç”¨ï¼šå…ˆå…§å»ºï¼Œä¸ä¾è³´å¤–éƒ¨ json) =====

  // ===== Scenes (é›¢ç·šå¯ç”¨ï¼šæƒ…å¢ƒè³‡æ–™å…§åµŒï¼›ä¸æ”¹å¤–è§€/äº’å‹•) =====
  const sceneSelect = $("sceneSelect");
  const roleLabel = $("roleLabel");
  const sceneLabel = $("sceneLabel");
  const lineEN = $("lineEN");
  const lineZH = $("lineZH");
  const btnReplay = $("btnReplay");
  const btnMic = $("btnMic");
  const btnSkip = $("btnSkip");
  const btnType = $("btnType");
  const missionBox = $("missionBox");
  const examplesBox = $("examplesBox");
  const heard = $("heardText");
  const softHint = $("softHint");
  let hintTimer = null;

  function showSoftHint(html, ms=2600){
    if(!softHint) return;
    softHint.innerHTML = toText(html);
    softHint.style.display = "block";
    clearTimeout(hintTimer);
    hintTimer = setTimeout(()=>{ softHint.style.display="none"; }, ms);
  }
  function hideSoftHint(){ if(softHint) softHint.style.display="none"; }


  // ===== é˜²å‘†ï¼šä»»ä½• UI é¡¯ç¤ºåªåƒå­—ä¸²ï¼Œé¿å… [object Object] =====
  function toText(v){
    if(v == null) return "";
    if(typeof v === "string") return v;
    if(typeof v === "number" || typeof v === "boolean") return String(v);
    if(typeof v === "object"){
      return String(v.transcript || v.text || v.message || v.reason || "");
    }
    try{ return String(v); }catch(_){ return ""; }
  }

  // ===== æç¤º/æ”¶è—/é—œé–‰ï¼ˆv20260107-hintsï¼‰=====
  const LS_HINT_COLLAPSED = "BW_TALKA_HINT_COLLAPSED";
  const LS_HINT_CLOSED_ONCE = "BW_TALKA_HINT_CLOSED_ONCE";
  const LS_SAVED = "BW_TALKA_SAVED";

  const btnHintToggle = $("btnHintToggle");
  const btnHintSave   = $("btnHintSave");
  const btnHintClose  = $("btnHintClose");
  const btnHintFill   = $("btnHintFill");

  let hintClosed = false;

  function saveText(t){
    const s = String(t||"").trim();
    if(!s) return;
    let arr = [];
    try{ arr = JSON.parse(localStorage.getItem(LS_SAVED) || "[]"); }catch(_){ arr=[]; }
    if(!Array.isArray(arr)) arr = [];
    if(!arr.includes(s)) arr.unshift(s);
    localStorage.setItem(LS_SAVED, JSON.stringify(arr.slice(0,200)));
    showSoftHint(`<b>å·²æ”¶è—</b>ï¼š${s}`, 1600);
  }

  function getCurHint(){
    const s = steps[idx] || {};
    return String(s.hint||"").trim();
  }

  function applyHintUI(){
    const collapsed = localStorage.getItem(LS_HINT_COLLAPSED) === "1";
    if(btnHintToggle) btnHintToggle.textContent = collapsed ? "æç¤ºï¼ˆå±•é–‹ï¼‰" : "æç¤ºï¼ˆæ”¶èµ·ï¼‰";
    if(hintClosed){
      if(softHint) softHint.style.display = "none";
      const fb = $("fillBar"); if(fb) fb.style.display="none";
      return;
    }
    const fb = $("fillBar");
    if(fb && collapsed) fb.style.display="none";
  }

  hintClosed = localStorage.getItem(LS_HINT_CLOSED_ONCE) === "1";
  applyHintUI();

  btnHintToggle && btnHintToggle.addEventListener("click", ()=>{
    const collapsed = localStorage.getItem(LS_HINT_COLLAPSED) === "1";
    localStorage.setItem(LS_HINT_COLLAPSED, collapsed ? "0" : "1");
    const nowCollapsed = localStorage.getItem(LS_HINT_COLLAPSED) === "1";
    if(!nowCollapsed){
      const h = getCurHint();
      if(h) showSoftHint(`åƒè€ƒå›ç­”ï¼ˆç…§è®€ä¹Ÿå¯ä»¥ï¼‰ï¼š<b>${h}</b>`, 2200);
    }
    applyHintUI();
  });

  btnHintSave && btnHintSave.addEventListener("click", ()=>{
    const h = getCurHint();
    saveText(h || lineEN.textContent || "");
  });

  btnHintClose && btnHintClose.addEventListener("click", ()=>{
    hintClosed = true;
    localStorage.setItem(LS_HINT_CLOSED_ONCE, "1");
    applyHintUI();
    showSoftHint("å·²é—œé–‰æç¤ºï¼ˆéœ€è¦æ¢å¾©å¯æ¸…é™¤ localStorage é–‹é—œï¼‰", 1400);
  });

  // ===== å¡«ç©ºå¼•å°ï¼ˆv20260107-fillï¼‰=====
  const fillBar = $("fillBar");
  const btnFillHide = $("btnFillHide");
  const btnFillSubmit = $("btnFillSubmit");
  const btnFillReset = $("btnFillReset");
  const fillMasked = $("fillMasked");
  const fillSlots = $("fillSlots");
  const fillChoices = $("fillChoices");
  const fillLevelTag = $("fillLevelTag");

  let fillTarget = "";
  let fillWords = [];
  let fillPicked = [];

  function shuffle(a){
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  function buildFill(sentence){
    const s = String(sentence||"").trim();
    if(!s) return null;

    const words = s.split(/[^A-Za-z0-9']+/).filter(w=>w.length>=3);
    const ban = new Set(["please","hello","thanks","thank","sure","okay","ok","hi"]);
    const candidates = words.filter(w=>!ban.has(w.toLowerCase()) && w.length>=4);

    const pickN = Math.min(3, Math.max(2, Math.floor(s.length/28)));
    const picked = [];
    const pool = candidates.length ? candidates : words;
    for(const w of pool){
      if(picked.length>=pickN) break;
      const lw = w.toLowerCase();
      if(!picked.map(x=>x.toLowerCase()).includes(lw)) picked.push(w);
    }
    if(!picked.length) return null;

    fillTarget = s;
    fillWords = picked;
    fillPicked = new Array(picked.length).fill("");

    let masked = s;
    picked.forEach((w)=>{
      const re = new RegExp("\\b" + w.replace(/[.*+?^${}()|[\]\\]/g,"\\$&") + "\\b", "i");
      masked = masked.replace(re, "____");
    });

    return { masked, picked };
  }

  function renderFill(){
    if(!fillBar) return;
    const collapsed = localStorage.getItem(LS_HINT_COLLAPSED) === "1";
    if(hintClosed || collapsed){
      fillBar.style.display = "none";
      return;
    }
    fillBar.style.display = "block";

    try{ fillLevelTag.textContent = (curScene && curScene.level) ? curScene.level : "A2"; }catch(_){}

    const def = getCurHint() || "";
    const built = buildFill(def);
    if(!built){
      fillMasked.textContent = "ï¼ˆæœ¬è¼ªæ²’æœ‰å¯ç”¨çš„æç¤ºå¥ï¼‰";
      fillSlots.innerHTML = "";
      fillChoices.innerHTML = "";
      return;
    }

    fillMasked.textContent = built.masked;

    fillSlots.innerHTML = "";
    built.picked.forEach((_, i)=>{
      const sp = document.createElement("span");
      sp.className = "fillSlot";
      sp.textContent = fillPicked[i] ? fillPicked[i] : `ç©ºæ ¼${i+1}`;
      sp.style.cursor = "pointer";
      sp.title = "é»ä¸€ä¸‹æ¸…é™¤é€™æ ¼";
      sp.addEventListener("click", ()=>{
        fillPicked[i] = "";
        renderFill();
      });
      fillSlots.appendChild(sp);
    });

    const extraPool = ["today","tomorrow","ticket","train","New","York","City","one-way","round-trip","afternoon","morning","cash","card","please","by","at","to"];
    const choices = [...built.picked];
    while(choices.length < built.picked.length + 2){
      const x = extraPool[Math.floor(Math.random()*extraPool.length)];
      if(!choices.includes(x)) choices.push(x);
      if(choices.length > 10) break;
    }
    shuffle(choices);

    fillChoices.innerHTML = "";
    choices.forEach((w)=>{
      const b = document.createElement("button");
      b.type="button";
      b.className="fillChoice";
      b.textContent = w;
      b.addEventListener("click", ()=>{
        const k = fillPicked.findIndex(x=>!x);
        if(k === -1) return;
        fillPicked[k] = w;
        renderFill();
      });
      fillChoices.appendChild(b);
    });
  }

  btnHintFill && btnHintFill.addEventListener("click", ()=>{
    localStorage.setItem(LS_HINT_COLLAPSED, "0");
    applyHintUI();
    renderFill();
  });

  btnFillHide && btnFillHide.addEventListener("click", ()=>{
    if(fillBar) fillBar.style.display="none";
  });

  btnFillReset && btnFillReset.addEventListener("click", ()=>{
    renderFill();
  });

  btnFillSubmit && btnFillSubmit.addEventListener("click", async ()=>{
    if(!fillTarget) return;
    let out = fillTarget;
    for(const w of fillPicked){
      if(!w){ showSoftHint("é‚„æ²’å¡«å®Œå–”ï½", 1400); return; }
      out = out.replace("____", w);
    }
    await handleUser(out);
  });

  // --- speech recognition ---
  const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
  let rec = null;
  if(SpeechRec){
    rec = new SpeechRec();
    rec.lang = "en-US";
    rec.interimResults = false;
    rec.maxAlternatives = 1;
  }

  function qs(name){ return new URL(location.href).searchParams.get(name); }
  function setQs(name, value){
    const u = new URL(location.href);
    u.searchParams.set(name, value);
    history.replaceState(null, "", u.toString());
  }

  // è¶…å¯¬é¬†éé—œï¼ˆé¿å…å¡é—œï¼‰
  function norm(s){ return String(s||"").trim().toLowerCase(); }
  function simpleOk(userText, hint){
    const t = norm(userText);
    const h = norm(hint);
    if(!h) return true;
    if(t === h) return true;
    const tokens = h.split(/[^a-z]+/).filter(w=>w.length>=4);
    if(tokens.some(w=>t.includes(w))) return true;
    if(["ok","okay","yes","yeah","yep","thanks","thank you"].some(p=>t===p || t.startsWith(p+" "))) return true;
    return false;
  }

  
  // âœ… æƒ…å¢ƒç´¢å¼•ï¼šå®Œå…¨ç”± /talk/index.json é©…å‹•ï¼ˆç„¡ fallbackï¼‰
  // - é€™ä»½æª”æ¡ˆæ˜¯ã€Œå”¯ä¸€çœŸç›¸ã€ï¼Œä½ æ–°å¢/åˆªé™¤/æ”¹åæƒ…å¢ƒï¼Œåªè¦æ”¹ /talk/index.json
  // - ç‚ºé¿å… GitHub Pages å¿«å–ï¼Œæœƒå¸¶ cache-bust åƒæ•¸
  let scenes = [];

  function normalizeIndex(json){
    // æ”¯æ´ï¼šArray / {scenes:[...]} / {items:[...]}
    const arr = Array.isArray(json) ? json
      : (Array.isArray(json?.scenes) ? json.scenes
      : (Array.isArray(json?.items) ? json.items
      : null));
    if (!arr) return [];
    return arr.map(x => ({
      id: String(x.id ?? x.slug ?? "").trim(),
      title_zh: x.title_zh ?? x.titleZh ?? x.title_zh_tw ?? x.title ?? "",
      title_en: x.title_en ?? x.titleEn ?? "",
      level: x.level ?? x.cefr ?? "",
      teacher_label: x.teacher_label ?? x.teacherLabel ?? x.role ?? "",
      teacher_avatar: x.teacher_avatar ?? x.teacherAvatar ?? x.avatar ?? ""
    })).filter(x => x.id);
  }

  async function loadScenesIndex(){
    if (Array.isArray(scenes) && scenes.length) return scenes;

    // å…è¨±æ¸¬è©¦ï¼š?index=/talk/index.preview.json
    const override = qs("index");
    const candidates = [];
    if (override){
      candidates.push(override.startsWith("/") ? override : ("/" + override));
    }
    for (const u of INDEX_URLS) candidates.push(u);

    let j = null;
    let lastErr = null;

    for (const path of candidates){
      try{
        const url = new URL(path, location.origin);
        url.searchParams.set("v", String(Date.now()));
        const r = await fetch(url.toString(), { cache: "no-store" });
        if (!r.ok) throw new Error("Index fetch failed: " + r.status + " @ " + url.pathname);
        j = await r.json();
        lastErr = null;
        break;
      }catch(e){
        lastErr = e;
      }
    }
    if (!j) throw lastErr || new Error("Index fetch failed");

    const arr = normalizeIndex(j);
    if (!arr.length) throw new Error("Index empty or invalid schema");

    scenes = arr;
    return scenes;
  }




  function fillSelect(){
    sceneSelect.innerHTML = "";
    scenes.forEach(it=>{
      const opt = document.createElement("option");
      opt.value = it.id;
      opt.textContent = `${it.title_zh}ï½œ${it.title_en} (${it.level})`;
      sceneSelect.appendChild(opt);
    });
  }

  // Convert JSON dialogue -> TalkA steps (AI line + zh + next USER hint_en)
  function jsonToSteps(sceneJson){
    const dlg = Array.isArray(sceneJson?.dialogue) ? sceneJson.dialogue : [];
    const out = [];
    for(let i=0;i<dlg.length;i++){ 
      const row = dlg[i];
      if(!row || row.speaker !== "AI") continue;
      let hint = "";
      for(let j=i+1;j<dlg.length;j++){ 
        if(dlg[j] && dlg[j].speaker === "USER"){ hint = (dlg[j].hint_en || "").trim(); break; }
        if(dlg[j] && dlg[j].speaker === "AI") break;
      }
      out.push({ ai:String(row.en||"").trim(), zh:String(row.zh||"").trim(), hint });
    }
    return out;
  }

  

  const sceneDataCache = {};

  // âœ… è‹¥ sceneDataCache æ²’æœ‰ï¼Œæ”¹ç”¨ fetch è®€å– /talk/*.jsonï¼ˆå¯æ”¯æ´æ–°å¢å ´æ™¯ï¼Œä¸å¿…æ¯æ¬¡æ”¹ talk_A.htmlï¼‰
  async function getSceneData(sceneId){
    // å…è¨±å‚³å…¥ {id,...}
    if (sceneId && typeof sceneId === "object") sceneId = sceneId.id || sceneId.slug || sceneId.file;

    if (!sceneId) throw new Error("Missing sceneId");
    // 1) cache
    if (sceneDataCache && sceneDataCache[sceneId]) return sceneDataCache[sceneId];

    // 2) try multiple bases (GitHub Pages / root / talk/)
    const bases = [
      (window.BW_SCENE_JSON_BASE || "").trim(),
      "./talk/",
      "./",
      "/talk/",
      "/",
    ].filter((v,i,a)=>v && a.indexOf(v)===i);

    let lastErr = null;
    for (const base of bases){
      const url = (base.endsWith("/") ? base : base + "/") + `${sceneId}.json`;
      try{
        const r = await fetch(url, { cache: "no-store" });
        if (!r.ok) { lastErr = new Error(`${r.status} ${r.statusText}`); continue; }
        const j = await r.json();
        if (sceneDataCache) sceneDataCache[sceneId] = j;
        return j;
      }catch(e){ lastErr = e; }
    }
    throw (lastErr || new Error("Scene JSON not found"));
  }

  async function applyScene(id){
    curScene = scenes.find(x=>x.id===id) || scenes[0];
    if(!curScene) return;

    roleLabel.textContent = `AI Â· ${curScene.role || "teacher"}`;
    const lvl = (curScene.level || "").trim();
    const ttlZh = (curScene.title_zh || "").trim();
    const ttlEn = (curScene.title_en || "").trim();
    sceneLabel.textContent = ttlEn ? `${ttlZh}ï½œ${ttlEn}${lvl?` (${lvl})`:``}` : `${ttlZh}${lvl?` (${lvl})`:``}`;

    try{
      curSceneData = await getSceneData(curScene);
      steps = curSceneData ? jsonToSteps(curSceneData) : [];
      if(!steps.length) throw new Error("no steps");
    }catch(e){
      curSceneData = null;
      steps = [{ai:"Loading failed. Please check scene json files.", zh:"è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªæƒ…å¢ƒè³‡æ–™æ˜¯å¦å­˜åœ¨ã€‚", hint:""}];
    }

    idx = 0;
    setAvatarState("idle");
    render();
    try{ await speakOrGate(lineEN.textContent); }catch(_){ }
    try{ renderFill(); }catch(_){ }
    setQs("scene", curScene.id);
  }

  async function handleUser(text){
    const userText = String(text||"").trim();
    if(!userText) return;
    heard.style.display="block";
    heard.textContent = "ä½ èªªï¼š" + userText;

    const s = steps[idx] || {};
    if(simpleOk(userText, s.hint||"")){
      if(idx < steps.length-1){
        idx++;
        render();
        await speakOrGate(lineEN.textContent);
        try{ renderFill(); }catch(_){ }
      }else{
        showSoftHint("<b>å®Œæˆï¼</b> å·²çµæŸã€‚ä½ å¯ä»¥åˆ‡æ›æƒ…å¢ƒç¹¼çºŒç·´ã€‚", 2200);
      }
      return;
    }
    const expected = (s.hint || "").trim() || "ï¼ˆå¯ç”¨ä»»æ„åˆç†å›ç­”ï¼‰";
    showSoftHint(`å†è©¦ä¸€æ¬¡ï¼šä½ å¯ä»¥ç›´æ¥èªªæˆ–æŒ‰ã€ŒâŒ¨ï¸ è¼¸å…¥ã€è²¼ä¸Šï¼š <b>${expected}</b><span class="sub">å°æŠ€å·§ï¼šæ…¢ä¸€é»ã€å°¾éŸ³æ‹‰æ¸…æ¥šï¼ˆä¾‹å¦‚ pleaseï¼‰ã€‚</span>`);
  }

  // hooks
  btnReplay.addEventListener("click", ()=>{ try{ const p = speakOrGate(lastSpoken || lineEN.textContent || ""); if(p && p.catch) p.catch(()=>{}); }catch(_){ } });
  btnSkip.addEventListener("click", async ()=>{
    if(idx < steps.length-1){ idx++; render(); await speakOrGate(lineEN.textContent); }
    else openSheet('<div class="card"><h3>å®Œæˆï¼</h3><p>å·²çµæŸã€‚</p></div>');
  });

  btnType.addEventListener("click", async ()=>{
    audioEnabled = true;
    setAvatarState("listen");
    const s = steps[idx] || {};
    const def = String(s.hint||"").trim();
    const t = prompt("è«‹è¼¸å…¥ä½ è¦å›ç­”çš„è‹±æ–‡ï¼š", def) || "";
    setAvatarState("idle");
    await handleUser(t);
  });

  btnMic.addEventListener("click", async ()=>{
    audioEnabled = true;
    if(!rec){
      const t = prompt("æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ã€‚è«‹è¼¸å…¥ä½ è¦å›ç­”çš„è‹±æ–‡ï¼š") || "";
      await handleUser(t);
      return;
    }
    try{
      btnMic.textContent = "ğŸ™ï¸ è½ä½ èªªâ€¦ï¼ˆèªªå®Œåœä¸€ä¸‹ï¼‰";
      btnMic.disabled = true;
      setAvatarState("listen");

      rec.onresult = async (e)=>{
        const t = e.results && e.results[0] && e.results[0][0] ? e.results[0][0].transcript : "";
        btnMic.textContent = "ğŸ¤ é»æˆ‘èªªï¼ˆé–‹å§‹è¾¨è­˜ï¼‰";
        btnMic.disabled = false;
        setAvatarState("idle");
        await handleUser(t);
      };
      rec.onerror = async ()=>{
        btnMic.textContent = "âŒ¨ï¸ é€™å°ä¸æ”¯æ´èªéŸ³ï¼Œæ”¹ç”¨è¼¸å…¥";
        btnMic.disabled = false;
        setAvatarState("idle");
        const t = prompt("è«‹è¼¸å…¥ä½ è¦å›ç­”çš„è‹±æ–‡ï¼š") || "";
        await handleUser(t);
      };
      rec.onend = ()=>{
        btnMic.textContent = "ğŸ¤ é»æˆ‘èªªï¼ˆé–‹å§‹è¾¨è­˜ï¼‰";
        btnMic.disabled = false;
        setAvatarState("idle");
      };
      rec.start();
    }catch(e){
      btnMic.textContent = "âŒ¨ï¸ é€™å°ä¸æ”¯æ´èªéŸ³ï¼Œæ”¹ç”¨è¼¸å…¥";
      btnMic.disabled = false;
      setAvatarState("idle");
      const t = prompt("è«‹è¼¸å…¥ä½ è¦å›ç­”çš„è‹±æ–‡ï¼š") || "";
      await handleUser(t);
    }
  });

  // Bottom sheet: ä»»å‹™ / ç¯„ä¾‹ï¼ˆåƒ json.metaï¼›å¤–è§€ä¸è®Šï¼‰
  $("btnTask").addEventListener("click", ()=>{
    const esc = (s)=>String(s??"").replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
    const meta = (curSceneData && curSceneData.meta) ? curSceneData.meta : {};
    const missions = Array.isArray(meta.missions) ? meta.missions : [];
    const playerUrl = String(meta.player || curScene?.player || ((curScene?.id||"")==="speaking-one-way-ticket" ? "https://bookwide.net/player.html?cat=news&slug=one-way-ticket" : "") );
    const curHint = (steps[idx] && (steps[idx].hint || steps[idx].hint_en)) ? String(steps[idx].hint || steps[idx].hint_en).trim() : "";

    let h = "";
    if(missions.length){
      // missions may be array of objects {text} or strings
      h += missions.map(m=>`<div class="card"><h3>ä»»å‹™</h3><p>${esc(m.text||m)}</p></div>`).join("");
    }else{
      h += `<div class="card"><h3>ä»»å‹™</h3><p>å…ˆçœ‹æƒ…å¢ƒå½±ç‰‡/æ’­æ”¾å™¨ç†Ÿæ‚‰å…§å®¹ï¼Œå†ç”¨ä¸€å¥è‹±æ–‡å›ç­”ï¼ˆç…§è®€æç¤ºä¹Ÿç®—éï¼‰ã€‚</p></div>`;
    }
    if(playerUrl){
      h += `<a class="btn" style="margin-top:10px;display:inline-flex;gap:8px;align-items:center" target="_blank" rel="noopener" href="${esc(playerUrl)}">ğŸ”— é–‹å•Ÿæ’­æ”¾å™¨ï¼ˆå…ˆç†Ÿæ‚‰å­—å¹•/å…§å®¹ï¼‰</a>`;
    }
    if(curHint){
      h += `<div class="card" style="margin-top:10px"><h3>æœ¬è¼ªæç¤º</h3><p>${esc(curHint)}</p></div>`;
    }
    openSheet("ä»»å‹™", h);
  });
$("btnExamples").addEventListener("click", ()=>{
    const esc = (s)=>String(s??"").replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
    const meta = (curSceneData && curSceneData.meta) ? curSceneData.meta : {};
    const ex = Array.isArray(meta.examples) ? meta.examples : [];
    let h = "";
    if(ex.length){
      h += ex.map(it=>`<div class="card"><h3>${esc(it.en||it)}</h3><p>${esc(it.zh||"")}</p></div>`).join("");
    }else{
      h += `<div class="card"><h3>ç¯„ä¾‹</h3><p>æœ¬æƒ…å¢ƒå°šæœªæä¾›ç¯„ä¾‹ã€‚</p></div>`;
    }
    openSheet("ç¯„ä¾‹", h);
  });
$("btnTranslate").addEventListener("click", ()=> {
    const zh = (lineZH.textContent||"").trim();
    openSheet(`<div class="card"><h3>ç¿»è­¯ï¼ˆæœ¬å¥ï¼‰</h3><p>${esc(zh)}</p></div>`);
  });
  $("btnSaved").addEventListener("click", ()=> openSheet('<div class="card"><h3>å·²å„²å­˜</h3><p>æœ€å°ç‰ˆå…ˆä¸åšã€‚</p></div>'));

  $("btnBack").addEventListener("click", ()=>{ location.href = "./index.html"; });
  sceneSelect.addEventListener("change", ()=> applyScene(sceneSelect.value));

  function bootScenes(){
    fillSelect();
    const initial = qs("scene") || (scenes[0] && scenes[0].id) || "coffee_shop";
    sceneSelect.value = initial;
    applyScene(sceneSelect.value);
    setAvatarState("idle");
  }
  // ESC closes ä»»å‹™/ç¯„ä¾‹
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ try{ missionBox.style.display='none'; examplesBox.style.display='none'; }catch(_){} }});

  loadScenesIndex()
    .then(() => bootScenes())
    .catch((err) => {
      console.error('[TalkA] index.json error:', err);
      try{
        const box = document.createElement('div');
        box.style.cssText = [
          'position:fixed','left:12px','right:12px','bottom:12px','z-index:99999',
          'background:#fff','border:1px solid #e5e7eb','border-radius:16px',
          'padding:12px 14px','box-shadow:0 14px 40px rgba(0,0,0,.12)',
          'font-size:14px','line-height:1.4','color:#0f172a'
        ].join(';');
        const hint = (location.origin + '/talk/index.json');
        box.innerHTML = 'âŒ ç„¡æ³•è®€å– /talk/index.json<br>'
          + '<div style="color:#64748b;margin-top:4px">è«‹ç¢ºèªæª”æ¡ˆå­˜åœ¨ï¼š' + hint + '</div>'
          + '<div style="color:#64748b;margin-top:4px">éŒ¯èª¤ï¼š' + (err?.message || String(err)) + '</div>';
        document.body.appendChild(box);
      }catch(_){}
    });
})();
</script>
</body>
</html>