<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MP4 批次合成（產生 BAT）｜BookWide</title>
  <style>
    :root{--bg:#0b1220;--card:#0f1b2e;--muted:#9aa4b2;--text:#e8eef7;--brand:#22c55e;--btn:#2563eb;--btn2:#0ea5e9;--border:#1f2a44;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Microsoft JhengHei","Noto Sans TC",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:24px auto 64px;padding:0 16px}
    h1{font-size:22px;margin:0 0 8px}
    .sub{color:var(--muted);font-size:13px;line-height:1.6;margin-bottom:18px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px;min-height:260px}
    .tag{display:inline-block;padding:4px 10px;border-radius:999px;background:#12324a;color:#8bd3ff;font-size:12px;margin-left:8px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0}
    button{border:0;border-radius:12px;padding:10px 14px;color:#fff;cursor:pointer;font-weight:700}
    .btn{background:var(--btn)}
    .btn2{background:var(--btn2)}
    .btn3{background:#334155}
    select,input{background:#0b1628;color:var(--text);border:1px solid var(--border);border-radius:12px;padding:10px 12px;min-width:260px}
    .kv{font-size:13px;color:var(--muted);line-height:1.6}
    .ok{color:#86efac}
    .bad{color:#fca5a5}
    pre{margin:0;background:#071022;border:1px solid var(--border);border-radius:14px;padding:12px;overflow:auto;max-height:520px;font-size:12px;line-height:1.55}
    .hint{font-size:12px;color:var(--muted)}
    a{color:#93c5fd}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>MP4 批次合成（產生 BAT）<span class="tag">不在瀏覽器跑 ffmpeg</span></h1>
    <div class="sub">
      用途：你在後台選 <b>story 資料夾</b>（例如 <code>D:\bookwide\story\</code>）→ 這頁會掃描所有 <code>in_*</code> → 讓你選 input / 故事 → 自動產生 <code>make_mp4.bat</code>（含輸出分類規則）。
      <br/>重點：瀏覽器安全限制，<b>不能直接讀你輸入的路徑字串</b>；必須用「選資料夾」授權。
    </div>

    <div class="grid">
      <div class="card">
        <h3 style="margin:0 0 8px">Step 1　選擇 story 資料夾</h3>

        <div class="row">
          <button class="btn" id="pickDirBtn">選擇資料夾（建議）</button>
          <button class="btn3" id="scanBtn" disabled>掃描</button>
        </div>

        <div class="kv">
          <div>目前選擇：<span id="pickedPath" class="bad">尚未選擇</span></div>
          <div>找到的 input（<code>in_*</code>）：<span id="inCount">0</span></div>
          <div class="hint">你要選的是：<b>story 這一層</b>（裡面要有 <code>in_mp3</code>、<code>out_mp4</code> 或未來更多 <code>in_*</code>）。</div>
        </div>

        <hr style="border:0;border-top:1px solid var(--border);margin:14px 0">

        <div class="row">
          <label class="kv" style="min-width:120px">找到的 input：</label>
          <select id="inSelect" disabled></select>
        </div>

        <div class="row">
          <label class="kv" style="min-width:120px">模式：</label>
          <select id="modeSelect" disabled>
            <option value="all">全部故事</option>
            <option value="one">指定一個故事</option>
          </select>
        </div>

        <div class="row">
          <label class="kv" style="min-width:120px">指定故事：</label>
          <select id="storySelect" disabled></select>
        </div>

        <div class="row">
          <button class="btn2" id="genBtn" disabled>產生 make_mp4.bat</button>
        </div>

        <div class="hint">
          ⚠️ 若你的 Chrome/Edge 不支援「選擇資料夾」，請更新版本。這功能需要 File System Access API。
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px">Step 2　預覽 BAT（下載後在本機執行）</h3>
        <div class="kv" style="margin-bottom:10px">
          輸出規則：<code>out_mp4\&lt;inputName&gt;\&lt;storyName&gt;\ID.mp4</code><br/>
          BAT 會掃該故事資料夾內的 <code>*.mp3</code>，若同名 <code>.png</code> 存在就合成 MP4。
        </div>
        <pre id="batPreview">@echo off
REM 請先在 Step 1 選資料夾並掃描
</pre>

        <div class="row" style="margin-top:12px">
          <button class="btn" id="downloadBtn" disabled>下載 make_mp4.bat</button>
        </div>

        <div class="hint">
          你本機要能跑：<code>ffmpeg</code>（已安裝或加到 PATH）。在 CMD 先試：<code>ffmpeg -version</code>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);

  let storyDirHandle = null;
  let inDirs = []; // {name, handle, stories:[{name, handle}]}

  const pickedPathEl = $("pickedPath");
  const inCountEl = $("inCount");

  const pickDirBtn = $("pickDirBtn");
  const scanBtn = $("scanBtn");
  const inSelect = $("inSelect");
  const modeSelect = $("modeSelect");
  const storySelect = $("storySelect");
  const genBtn = $("genBtn");

  const batPreview = $("batPreview");
  const downloadBtn = $("downloadBtn");

  function setStatus(el, ok, text){
    el.className = ok ? "ok" : "bad";
    el.textContent = text;
  }

  async function pickDirectory(){
    if(!window.showDirectoryPicker){
      alert("此瀏覽器不支援「選擇資料夾」。請用 Chrome/Edge 最新版。");
      return;
    }
    storyDirHandle = await window.showDirectoryPicker();
    setStatus(pickedPathEl, true, storyDirHandle.name);
    scanBtn.disabled = false;
  }

  async function listSubDirs(dirHandle){
    const dirs = [];
    for await (const [name, handle] of dirHandle.entries()){
      if(handle.kind === "directory"){
        dirs.push({name, handle});
      }
    }
    dirs.sort((a,b)=>a.name.localeCompare(b.name));
    return dirs;
  }

  async function scan(){
    inDirs = [];
    if(!storyDirHandle) return;

    const subs = await listSubDirs(storyDirHandle);
    const inputs = subs.filter(x => /^in_/i.test(x.name));

    for(const inp of inputs){
      const stories = await listSubDirs(inp.handle);
      inDirs.push({name: inp.name, handle: inp.handle, stories});
    }

    inCountEl.textContent = String(inDirs.length);

    // fill input select
    inSelect.innerHTML = "";
    for(const d of inDirs){
      const opt = document.createElement("option");
      opt.value = d.name;
      opt.textContent = d.name;
      inSelect.appendChild(opt);
    }

    const has = inDirs.length > 0;
    inSelect.disabled = !has;
    modeSelect.disabled = !has;
    storySelect.disabled = !has;
    genBtn.disabled = !has;

    if(!has){
      batPreview.textContent =
`[ERROR] 找不到任何 in_* 資料夾
請確認你選的是 story 那一層，例如：
D:\\bookwide\\story\\
並且裡面真的有 in_mp3、in_mp3_alt ...`;
      downloadBtn.disabled = true;
      return;
    }

    await refreshStorySelect();
  }

  async function refreshStorySelect(){
    const inName = inSelect.value;
    const item = inDirs.find(x=>x.name===inName);
    const stories = item ? item.stories : [];

    storySelect.innerHTML = "";
    for(const s of stories){
      const opt = document.createElement("option");
      opt.value = s.name;
      opt.textContent = s.name;
      storySelect.appendChild(opt);
    }

    const mode = modeSelect.value;
    storySelect.disabled = (mode !== "one");
  }

  function buildBat({basePathHint, inName, mode, onlyStory}){
    // basePathHint: 用來寫在 REM，不能真的從瀏覽器拿到 D:\...
    // BAT 本身用相對路徑 %~dp0（放在 story 目錄下）
    const esc = (s)=>String(s||"").replace(/"/g,'""');

    const onlyLine = (mode==="one" && onlyStory) ? `set "ONLYSTORY=${esc(onlyStory)}"\r\n` : `set "ONLYSTORY="\r\n`;

    return `@echo off
chcp 65001 >nul
setlocal enabledelayedexpansion

REM =========================================================
REM  BookWide - make_mp4.bat (generated by srt_mp4.html)
REM  建議放置位置：${basePathHint}\\make_mp4.bat
REM  input 資料夾命名：in_*（例如 in_mp3 / in_mp3_alt）
REM  output：out_mp4\\<inputName>\\<storyName>\\ID.mp4
REM =========================================================

set "BASE=%~dp0"
set "OUTROOT=%BASE%out_mp4"
if not exist "%OUTROOT%" mkdir "%OUTROOT%"

set "INNAME=${esc(inName)}"
set "INDIR=%BASE%%INNAME%"
set "OUTDIR=%OUTROOT%\\%INNAME%"

${onlyLine}
echo.
echo ===============================
echo   BookWide MP4 批次合成工具
echo   BASE: %BASE%
echo   IN  : %INDIR%
echo   OUT : %OUTDIR%
echo ===============================
echo.

if not exist "%INDIR%" (
  echo [ERROR] 找不到 input 資料夾：%INDIR%
  pause
  exit /b 1
)

echo === 開始處理 ===
echo.

for /d %%S in ("%INDIR%\\*") do (
  set "STORY=%%~nxS"

  if not "%ONLYSTORY%"=="" (
    if /i not "!STORY!"=="%ONLYSTORY%" (
      REM skip
      goto :CONTINUE_STORY
    )
  )

  echo ▶ Story: !STORY!
  if not exist "%OUTDIR%\\!STORY!" mkdir "%OUTDIR%\\!STORY!"
  pushd "%%S"

  for %%F in (*.mp3) do (
    set "ID=%%~nF"
    if exist "!ID!.png" (
      echo   [OK] !ID!.mp4
      ffmpeg -y -hide_banner -loglevel error ^
        -loop 1 -i "!ID!.png" -i "!ID!.mp3" ^
        -c:v libx264 -tune stillimage -preset veryfast ^
        -vf "scale=1080:1920:force_original_aspect_ratio=decrease,pad=1080:1920:(ow-iw)/2:(oh-ih)/2,format=yuv420p" ^
        -c:a aac -b:a 192k -shortest ^
        "%OUTDIR%\\!STORY!\\!ID!.mp4"
    ) else (
      echo   [SKIP] %%F (missing PNG)
    )
  )

  popd
  echo.

  :CONTINUE_STORY
)

echo === DONE ===
echo 輸出在：%OUTDIR%
pause
`;
  }

  function downloadText(filename, text){
    const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 500);
  }

  function gen(){
    const inName = inSelect.value;
    const mode = modeSelect.value;
    const onlyStory = (mode==="one") ? storySelect.value : "";
    const bat = buildBat({
      basePathHint: "D:\\bookwide\\story", // 只是提示文字，BAT 以 %~dp0 為準
      inName,
      mode,
      onlyStory
    });

    batPreview.textContent = bat;
    downloadBtn.disabled = false;

    downloadBtn.onclick = ()=>downloadText("make_mp4.bat", bat);
  }

  // wire
  pickDirBtn.addEventListener("click", pickDirectory);
  scanBtn.addEventListener("click", scan);
  inSelect.addEventListener("change", refreshStorySelect);
  modeSelect.addEventListener("change", refreshStorySelect);
  genBtn.addEventListener("click", gen);

})();
</script>
</body>
</html>
