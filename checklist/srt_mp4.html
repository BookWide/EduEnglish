<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>SRT MP4 一鍵批次（產生 BAT）｜BookWide</title>
<style>
  :root{
    --bg:#071018; --panel:#0b1a27; --card:#0f2334; --text:#e7f1ff; --muted:#9fb3c8;
    --line:rgba(255,255,255,.08); --btn:#1a65ff; --btn2:#233a53; --ok:#20d59b; --warn:#ffcc66;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#06101a,#060b12);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  h1{margin:0 0 6px;font-size:18px}
  .sub{color:var(--muted);font-size:13px;margin-bottom:14px;line-height:1.5}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .card{background:rgba(15,35,52,.78);border:1px solid var(--line);border-radius:14px;padding:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  label{font-size:12px;color:var(--muted)}
  input[type="text"], select, textarea{
    background:#071a28;border:1px solid var(--line);color:var(--text);
    padding:10px 10px;border-radius:10px;outline:none;min-width:220px;
  }
  textarea{width:100%;min-height:120px;resize:vertical;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px}
  button{
    border:1px solid var(--line);background:var(--btn);color:white;border-radius:12px;
    padding:10px 12px;cursor:pointer;font-weight:700;
  }
  button.secondary{background:var(--btn2)}
  button:disabled{opacity:.5;cursor:not-allowed}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.15);color:var(--muted);font-size:12px}
  .ok{color:var(--ok);font-weight:700}
  .warn{color:var(--warn);font-weight:700}
  .list{max-height:220px;overflow:auto;border:1px solid var(--line);border-radius:12px;padding:10px;background:rgba(0,0,0,.12)}
  .item{display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,.06);font-size:13px}
  .item:last-child{border-bottom:0}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <h1>MP4 批次合成（一鍵產生 BAT，雙擊就跑）</h1>
  <div class="sub">
    你要的「在後台按一下就做 MP4」：<span class="warn">瀏覽器/HTML 不能直接跑 ffmpeg</span>（安全限制）。<br/>
    這頁會幫你：選 input → 選故事 → <span class="ok">自動產生 make_mp4.bat</span>（含輸出分類規則），你下載後放到對應分類資料夾，雙擊就會產生 mp4。
  </div>

  <div class="grid">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="pill"><span class="ok">Step 1</span>選你的分類資料夾（例如 D:\bookwide\story\）</div>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="row">
        <div style="flex:1">
          <label>用資料夾選擇器（建議）</label><br/>
          <input id="dirPick" type="file" webkitdirectory directory multiple />
          <div class="small">選擇 <span class="mono">story</span> 這一層（裡面要有 <span class="mono">in_mp3</span> / <span class="mono">out_mp4</span> / 各故事資料夾）。</div>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="row">
        <div>
          <label>或手動填路徑（Windows）</label><br/>
          <input id="basePath" type="text" value="D:\bookwide\story\" />
          <div class="small">例：<span class="mono">D:\bookwide\story\</span>（最後建議帶反斜線）</div>
        </div>
      </div>

      <div style="height:14px"></div>
      <div class="row">
        <button id="scanBtn" class="secondary">掃描（用資料夾選擇器）</button>
        <span id="scanState" class="pill">尚未掃描</span>
      </div>

      <div style="height:14px"></div>
      <div class="row">
        <div style="flex:1">
          <label>找到的 input（in_*）</label><br/>
          <select id="inputSelect" disabled></select>
        </div>
        <div style="flex:1">
          <label>模式</label><br/>
          <select id="modeSelect" disabled>
            <option value="all">全部故事</option>
            <option value="one">只跑指定故事</option>
          </select>
        </div>
      </div>

      <div style="height:12px"></div>
      <div class="row">
        <div style="flex:1">
          <label>指定故事（mode=只跑指定時才用）</label><br/>
          <select id="storySelect" disabled></select>
        </div>
      </div>

      <div style="height:14px"></div>
      <div class="row">
        <button id="genBtn" disabled>下載 make_mp4.bat</button>
        <span class="pill">輸出會自動到：<span class="mono">out_mp4\&lt;input&gt;\&lt;story&gt;\*.mp4</span></span>
      </div>
    </div>

    <div class="card">
      <div class="pill"><span class="ok">Step 2</span>預覽將下載的 BAT（你也可自行微調）</div>
      <div style="height:10px"></div>
      <textarea id="batPreview" readonly></textarea>
      <div class="small">
        重要：此 BAT 需要你電腦已裝 <span class="mono">ffmpeg</span>（或已加入 PATH）。測試：在 CMD 打 <span class="mono">ffmpeg -version</span>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  const dirPick = $("dirPick");
  const basePath = $("basePath");
  const scanBtn = $("scanBtn");
  const scanState = $("scanState");
  const inputSelect = $("inputSelect");
  const modeSelect = $("modeSelect");
  const storySelect = $("storySelect");
  const genBtn = $("genBtn");
  const batPreview = $("batPreview");

  // Parsed from webkitdirectory listing
  let inputs = [];  // ["in_mp3", ...]
  let storiesByInput = new Map(); // input -> Set(storyName)

  function setState(txt, ok=false){
    scanState.textContent = txt;
    scanState.style.borderColor = ok ? "rgba(32,213,155,.4)" : "rgba(255,255,255,.12)";
    scanState.style.color = ok ? "var(--ok)" : "var(--muted)";
  }

  function clearSelect(sel){
    sel.innerHTML = "";
  }

  function fillSelect(sel, arr){
    clearSelect(sel);
    arr.forEach(v=>{
      const opt=document.createElement("option");
      opt.value=v; opt.textContent=v;
      sel.appendChild(opt);
    });
  }

  function escapeBat(s){
    // Minimal escaping for batch variables in echo; we use set "VAR=..."
    return s.replaceAll('"','""');
  }

  function buildBat(){
    const base = basePath.value.trim() || "%~dp0";
    const inName = inputSelect.value || "in_mp3";
    const mode = modeSelect.value || "all";
    const onlyStory = storySelect.value || "";

    // Use robust dir scan (no wildcard error spam)
    const bat = `@echo off
chcp 65001 >nul
setlocal EnableDelayedExpansion

REM =========================================================
REM  BookWide - make_mp4.bat (generated by srt_mp4.html)
REM  BASE: ${escapeBat(base)}
REM  input: ${escapeBat(inName)}
REM  output: out_mp4\\${escapeBat(inName)}\\<story>\\ID.mp4
REM =========================================================

set "BASE=${escapeBat(base)}"
if not "%BASE:~-1%"=="\\" set "BASE=%BASE%\\"

set "INNAME=${escapeBat(inName)}"
set "INDIR=%BASE%%INNAME%"
set "OUTROOT=%BASE%out_mp4"
set "OUTDIR=%OUTROOT%\\%INNAME%"

if not exist "%OUTROOT%" mkdir "%OUTROOT%"
if not exist "%OUTDIR%"  mkdir "%OUTDIR%"

where ffmpeg >nul 2>nul
if errorlevel 1 (
  echo [ERROR] 找不到 ffmpeg。請先安裝或把 ffmpeg 加到 PATH。
  echo 測試：ffmpeg -version
  pause
  exit /b 1
)

if not exist "%INDIR%" (
  echo [ERROR] 找不到 input 資料夾：%INDIR%
  pause
  exit /b 1
)

set "MODE=${escapeBat(mode)}"
set "ONLYSTORY=${escapeBat(mode==="one"?onlyStory:"")}"

echo.
echo ===============================
echo   BookWide MP4 批次合成工具
echo   BASE: %BASE%
echo   INPUT: %INNAME%
echo ===============================
echo.

if "%MODE%"=="one" (
  echo [MODE] 只跑指定故事：%ONLYSTORY%
) else (
  echo [MODE] 全部故事
)

echo.
echo === 開始處理 ===
echo.

for /d %%S in ("%INDIR%\\*") do (
  set "STORY=%%~nxS"

  if "%MODE%"=="one" (
    if /i not "!STORY!"=="%ONLYSTORY%" (
      REM skip
    ) else (
      call :RENDER_ONE "%%S" "!STORY!"
    )
  ) else (
    call :RENDER_ONE "%%S" "!STORY!"
  )
)

echo === DONE ===
echo 輸出在：%OUTDIR%
pause
exit /b 0

:RENDER_ONE
set "STORY_PATH=%~1"
set "STORY_NAME=%~2"

echo ▶ Story: %STORY_NAME%
if not exist "%OUTDIR%\\%STORY_NAME%" mkdir "%OUTDIR%\\%STORY_NAME%"

pushd "%STORY_PATH%" || (
  echo   [SKIP] 無法進入資料夾：%STORY_PATH%
  exit /b 0
)

for %%F in (*.mp3) do (
  set "ID=%%~nF"
  if exist "!ID!.png" (
    echo   [OK] !ID!.mp4
    ffmpeg -y -hide_banner -loglevel error ^
      -loop 1 -i "!ID!.png" -i "!ID!.mp3" ^
      -c:v libx264 -tune stillimage -preset veryfast ^
      -vf "scale=1080:1920:force_original_aspect_ratio=decrease,pad=1080:1920:(ow-iw)/2:(oh-ih)/2,format=yuv420p" ^
      -c:a aac -b:a 192k -shortest ^
      "%OUTDIR%\\%STORY_NAME%\\!ID!.mp4"
  ) else (
    echo   [SKIP] %%F (missing PNG)
  )
)

popd
echo.
exit /b 0
`;
    return bat;
  }

  function refreshPreview(){
    batPreview.value = buildBat();
  }

  function enableUI(enable){
    inputSelect.disabled = !enable;
    modeSelect.disabled = !enable;
    storySelect.disabled = !enable;
    genBtn.disabled = !enable;
  }

  function scanFromDirectoryPicker(){
    const files = Array.from(dirPick.files || []);
    if(!files.length){
      alert("請先用『資料夾選擇器』選擇 story 資料夾。");
      return;
    }

    // Determine base folder name from first file relative path: "in_mp3\\001-...\\x.mp3"
    // We'll only rely on directory listing to populate input/story; basePath is still manual (default D:\bookwide\story\)
    inputs = [];
    storiesByInput = new Map();

    for(const f of files){
      const rel = f.webkitRelativePath || "";
      if(!rel) continue;
      const parts = rel.split(/[\\/]/).filter(Boolean);
      // parts[0] should be something like "in_mp3" or "out_mp4" etc.
      const top = parts[0] || "";
      if(!top.startsWith("in_")) continue;
      const story = parts[1] || "";
      if(!story) continue;

      if(!storiesByInput.has(top)) storiesByInput.set(top, new Set());
      storiesByInput.get(top).add(story);
    }

    inputs = Array.from(storiesByInput.keys()).sort((a,b)=>a.localeCompare(b,"en"));

    if(!inputs.length){
      setState("沒抓到任何 in_*（確認你選的是 story 這一層）", false);
      enableUI(false);
      refreshPreview();
      return;
    }

    fillSelect(inputSelect, inputs);
    modeSelect.value = "all";
    fillSelect(storySelect, Array.from(storiesByInput.get(inputs[0])||[]).sort());
    storySelect.disabled = true;

    enableUI(true);
    setState(`已掃描：${inputs.length} 個 input`, true);
    refreshPreview();
  }

  inputSelect.addEventListener("change", ()=>{
    const inName = inputSelect.value;
    const stories = Array.from(storiesByInput.get(inName) || []).sort((a,b)=>a.localeCompare(b,"en"));
    fillSelect(storySelect, stories);
    refreshPreview();
  });

  modeSelect.addEventListener("change", ()=>{
    const mode = modeSelect.value;
    storySelect.disabled = (mode !== "one");
    refreshPreview();
  });

  storySelect.addEventListener("change", refreshPreview);
  basePath.addEventListener("input", refreshPreview);

  scanBtn.addEventListener("click", scanFromDirectoryPicker);

  genBtn.addEventListener("click", ()=>{
    const bat = buildBat();
    const blob = new Blob([bat], {type:"text/plain;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "make_mp4.bat";
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();}, 400);
  });

  // initial
  enableUI(false);
  refreshPreview();
})();
</script>
</body>
</html>
