<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>MP4 æ‰¹æ¬¡åˆæˆï¼ˆç”¢ç”Ÿ BATï¼‰ï½œBookWide</title>
<style>
:root{--bg:#061225;--card:#0b1d36;--muted:#9fb3c8;--text:#e8f0ff;--line:#173052;--btn:#2b69ff;--btn2:#1247c7;}
*{box-sizing:border-box}
body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC";background:radial-gradient(1200px 600px at 20% 0%, #0b2a55 0%, var(--bg) 55%);color:var(--text)}
header{padding:18px 18px 10px;border-bottom:1px solid rgba(255,255,255,.06)}
h1{margin:0;font-size:18px;font-weight:800;letter-spacing:.5px}
sub{color:var(--muted)}
.container{max-width:1100px;margin:0 auto;padding:14px 14px 28px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:980px){.grid{grid-template-columns:1fr}}
.card{background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
.badge{display:inline-flex;align-items:center;gap:8px;font-size:12px;color:#cfe0ff;background:rgba(43,105,255,.14);border:1px solid rgba(43,105,255,.25);padding:6px 10px;border-radius:999px;margin-bottom:10px}
label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
input,select,textarea{width:100%;background:#071a33;border:1px solid rgba(255,255,255,.12);color:var(--text);border-radius:10px;padding:10px 10px;font-size:14px;outline:none}
textarea{height:420px;resize:vertical;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;line-height:1.4}
.row{display:flex;gap:10px;flex-wrap:wrap}
.row > *{flex:1 1 220px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:0;border-radius:12px;padding:11px 12px;background:var(--btn);color:white;font-weight:800;cursor:pointer;box-shadow:0 12px 24px rgba(43,105,255,.18)}
.btn:active{transform:translateY(1px)}
.btn.secondary{background:#0b2a55;border:1px solid rgba(255,255,255,.12);box-shadow:none}
.note{font-size:12px;color:var(--muted);line-height:1.55;margin-top:10px}
.hr{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
.small{font-size:12px;color:var(--muted)}
.ok{color:#8dffb0}
.err{color:#ff8d8d}
.kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);padding:1px 6px;border-radius:6px}
</style>
</head>
<body>
<header>
  <h1>MP4 æ‰¹æ¬¡åˆæˆï¼ˆç”¢ç”Ÿ BATï¼‰ <sub>ä¸æœƒä¸Šå‚³ä½ çš„æª”æ¡ˆï½œåªæƒæä½ é¸çš„æœ¬æ©Ÿè³‡æ–™å¤¾</sub></h1>
</header>

<div class="container">
  <div class="grid">
    <div class="card">
      <div class="badge">Step 1ã€€é¸æ“‡ä½ çš„åˆ†é¡è³‡æ–™å¤¾ï¼ˆä¾‹å¦‚ <span class="kbd">D:\bookwide\story\</span>ï¼‰</div>

      <div class="row">
        <div>
          <label>ç”¨ Directory Pickerï¼ˆå»ºè­°ï¼šä¸æœƒè·³ã€Œä¸Šå‚³æª”æ¡ˆã€è¦–çª—ï¼‰</label>
          <button class="btn secondary" id="pickDirBtn">é¸æ“‡è³‡æ–™å¤¾</button>
          <div class="small" id="pickedPath" style="margin-top:8px">å°šæœªé¸æ“‡</div>
        </div>
        <div>
          <label>æˆ–æ‰‹å‹•è¼¸å…¥è·¯å¾‘ï¼ˆåªå½±éŸ¿ BAT è¨»è§£é¡¯ç¤ºï¼Œä¸å½±éŸ¿æƒæï¼‰</label>
          <input id="basePath" placeholder="ä¾‹ï¼šD:\bookwide\story\" value="D:\bookwide\story\"/>
          <div class="small" style="margin-top:6px">ä½ çœŸæ­£è¦æŠŠ <b>make_mp4.bat</b> æ”¾åœ¨é€™ä¸€å±¤è³‡æ–™å¤¾ï¼ˆèˆ‡ <span class="kbd">in_*</span> åŒå±¤ï¼‰ã€‚</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div>
          <label>æ‰¾åˆ°çš„ inputï¼ˆin_*ï¼‰</label>
          <select id="inputSel"></select>
        </div>
        <div>
          <label>æ¨¡å¼</label>
          <select id="modeSel">
            <option value="all">å…¨éƒ¨æ•…äº‹</option>
            <option value="one">æŒ‡å®šä¸€å€‹æ•…äº‹</option>
          </select>
        </div>
        <div>
          <label>æŒ‡å®šæ•…äº‹ï¼ˆmode=æŒ‡å®šæ™‚æ‰ç”¨ï¼‰</label>
          <select id="storySel"></select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="genBtn">ç”¢ç”Ÿ make_mp4.batï¼ˆä¸‹è¼‰ï¼‰</button>
        <button class="btn secondary" id="refreshBtn">é‡æ–°æƒæ</button>
      </div>

      <div class="note">
        âœ… æª”æ¡ˆè¦å‰‡ï¼šåœ¨ <span class="kbd">in_xxx\æ•…äº‹è³‡æ–™å¤¾\</span> è£¡ï¼Œå¿…é ˆè¦åŒå <span class="kbd">ID.mp3</span> + <span class="kbd">ID.png</span> æ‰æœƒåˆæˆã€‚<br/>
        âœ… è¼¸å‡ºè¦å‰‡ï¼šè‡ªå‹•è¼¸å‡ºåˆ° <span class="kbd">out_mp4\&lt;inputName&gt;\&lt;storyName&gt;\ID.mp4</span><br/>
        âœ… ä½ çš„ç€è¦½å™¨ä¸èƒ½ç›´æ¥è·‘ ffmpegï¼Œæ‰€ä»¥é€™é åªè² è²¬ã€Œç”¢ç”Ÿ BATã€ã€‚ä½ ä¸‹è¼‰å¾Œæ”¾åˆ°åˆ†é¡è³‡æ–™å¤¾æ ¹ç›®éŒ„ï¼Œé›™æ“Šå°±è·‘ã€‚<br/>
        ğŸ”§ å…ˆåœ¨ CMD æ¸¬ï¼š<span class="kbd">ffmpeg -version</span>ï¼ˆç¢ºå®šå·²è£å¥½ / æœ‰åŠ  PATHï¼‰ã€‚
      </div>

      <div class="hr"></div>
      <div class="small" id="scanMsg"></div>
    </div>

    <div class="card">
      <div class="badge">Step 2ã€€é è¦½ï¼šå³å°‡ä¸‹è¼‰çš„ BAT å…§å®¹</div>
      <textarea id="batPreview" spellcheck="false"></textarea>
      <div class="row" style="margin-top:10px">
        <button class="btn secondary" id="copyBtn">è¤‡è£½ BAT å…§å®¹</button>
      </div>
      <div class="note">
        âš ï¸ å»ºè­°ä¸è¦ç”¨è¤‡è£½è²¼ä¸Šï¼ˆå®¹æ˜“è¢«ç€è¦½å™¨æ”¹è¡Œ/å¼•è™Ÿï¼‰ã€‚è«‹ç”¨ã€Œä¸‹è¼‰ make_mp4.batã€ã€‚<br/>
        å¦‚æœä½ çœŸçš„è¦è¤‡è£½ï¼šè«‹è²¼åˆ°è¨˜äº‹æœ¬å¾Œã€Œå¦å­˜æ–°æª”ã€é¸ ANSI æˆ– UTF-8ï¼ˆä¸è¦åŠ å¥‡æ€ªå¼•è™Ÿï¼‰ã€‚
      </div>
    </div>
  </div>
</div>

<script>
const $ = (id)=>document.getElementById(id);
let baseHandle = null;

function escapeBatPath(p){
  // keep backslashes; BAT uses quotes for spaces
  return p;
}

function makeBat({inName, mode, onlyStory}) {
return `@echo off
chcp 65001 >nul
setlocal EnableDelayedExpansion

REM =========================================================
REM  BookWide - make_mp4.bat (generated by srt_mp4.html)
REM  æ”¾ç½®ä½ç½®ï¼šæŠŠæœ¬æª”æ”¾åˆ°ã€Œåˆ†é¡è³‡æ–™å¤¾æ ¹ç›®éŒ„ã€ï¼ˆèˆ‡ in_* åŒå±¤ï¼‰
REM  ä½ ç¾åœ¨é¸æ“‡ï¼š
REM    input : ${inName}
REM    mode  : ${mode === 'all' ? 'å…¨éƒ¨æ•…äº‹' : 'æŒ‡å®šæ•…äº‹'}${mode==='one' ? ' / ' + onlyStory : ''}
REM =========================================================

set "BASE=%~dp0"
set "INNAME=${inName}"
set "INDIR=%BASE%!INNAME!"
set "OUTROOT=%BASE%out_mp4"
set "OUTDIR=%OUTROOT%\!INNAME!"

if not exist "!INDIR!" (
  echo [ERROR] æ‰¾ä¸åˆ° input è³‡æ–™å¤¾ï¼š!INDIR!
  echo è«‹ç¢ºèª make_mp4.bat æ”¾åœ¨åˆ†é¡è³‡æ–™å¤¾æ ¹ç›®éŒ„ï¼ˆèˆ‡ in_* åŒå±¤ï¼‰
  pause
  exit /b 1
)

if not exist "!OUTROOT!" mkdir "!OUTROOT!"

echo.
echo ===============================
echo   BookWide MP4 æ‰¹æ¬¡åˆæˆå·¥å…·
echo   BASE: !BASE!
echo   IN  : !INDIR!
echo   OUT : !OUTDIR!
echo ===============================
echo.

set "ONLYSTORY="
${mode === 'one' ? `set "ONLYSTORY=${onlyStory}"` : `REM set "ONLYSTORY="`}

for /d %%S in ("!INDIR!\*") do (
  set "STORY=%%~nxS"

  if not "!ONLYSTORY!"=="" (
    if /i not "!STORY!"=="!ONLYSTORY!" (
      REM skip
      goto :CONTINUE_STORY
    )
  )

  echo â–¶ Story: !STORY!

  if not exist "!OUTDIR!\!STORY!" mkdir "!OUTDIR!\!STORY!"

  pushd "%%S"

  for %%F in (*.mp3) do (
    set "ID=%%~nF"
    if exist "!ID!.png" (
      echo   [OK] !ID!.mp4
      ffmpeg -y -hide_banner -loglevel error ^
        -loop 1 -i "!ID!.png" -i "!ID!.mp3" ^
        -c:v libx264 -tune stillimage -preset veryfast ^
        -vf "scale=1080:1920:force_original_aspect_ratio=decrease,pad=1080:1920:(ow-iw)/2:(oh-ih)/2,format=yuv420p" ^
        -c:a aac -b:a 192k -shortest ^
        "!OUTDIR!\!STORY!\!ID!.mp4"
    ) else (
      echo   [SKIP] %%F (missing PNG)
    )
  )

  popd
  echo.

  :CONTINUE_STORY
)

echo === DONE ===
echo è¼¸å‡ºåœ¨ï¼š!OUTDIR!
pause
`;
}

async function scan() {
  const msg = $("scanMsg");
  msg.textContent = "";
  $("inputSel").innerHTML = "";
  $("storySel").innerHTML = "";

  if (!baseHandle) {
    msg.innerHTML = '<span class="err">å°šæœªé¸æ“‡è³‡æ–™å¤¾ã€‚è«‹æŒ‰ã€Œé¸æ“‡è³‡æ–™å¤¾ã€ã€‚</span>';
    $("batPreview").value = "";
    return;
  }

  // list in_* folders
  const inNames = [];
  for await (const [name, handle] of baseHandle.entries()) {
    if (handle.kind === 'directory' && /^in_.+/i.test(name)) inNames.push(name);
  }
  inNames.sort((a,b)=>a.localeCompare(b,'en'));

  if (!inNames.length) {
    msg.innerHTML = '<span class="err">é€™å±¤æ‰¾ä¸åˆ°ä»»ä½• in_* è³‡æ–™å¤¾ï¼ˆä¾‹å¦‚ in_mp3ï¼‰ã€‚</span>';
    $("batPreview").value = "";
    return;
  }

  for (const n of inNames) {
    const opt = document.createElement('option');
    opt.value = n; opt.textContent = n;
    $("inputSel").appendChild(opt);
  }

  await refreshStories();
  msg.innerHTML = '<span class="ok">å·²æƒæå®Œæˆã€‚</span>';
}

async function refreshStories(){
  $("storySel").innerHTML = "";
  const inName = $("inputSel").value;
  if (!baseHandle || !inName) return;

  const inHandle = await baseHandle.getDirectoryHandle(inName);
  const stories = [];
  for await (const [name, handle] of inHandle.entries()) {
    if (handle.kind === 'directory') stories.push(name);
  }
  stories.sort((a,b)=>a.localeCompare(b,'en'));

  if (!stories.length) {
    const opt = document.createElement('option');
    opt.value = ""; opt.textContent = "(æ­¤ input åº•ä¸‹æ²’æœ‰æ•…äº‹è³‡æ–™å¤¾)";
    $("storySel").appendChild(opt);
    return;
  }

  for (const s of stories) {
    const opt = document.createElement('option');
    opt.value = s; opt.textContent = s;
    $("storySel").appendChild(opt);
  }
}

function updatePreview(){
  const inName = $("inputSel").value || "in_mp3";
  const mode = $("modeSel").value;
  const onlyStory = $("storySel").value || "";
  const bat = makeBat({inName, mode, onlyStory});
  $("batPreview").value = bat;
}

function downloadBat(){
  const inName = $("inputSel").value || "in_mp3";
  const mode = $("modeSel").value;
  const onlyStory = $("storySel").value || "";
  const bat = makeBat({inName, mode, onlyStory});
  const blob = new Blob([bat], {type:"text/plain;charset=utf-8"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = "make_mp4.bat";
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
}

$("pickDirBtn").addEventListener('click', async ()=>{
  try{
    baseHandle = await window.showDirectoryPicker();
    $("pickedPath").textContent = "å·²é¸æ“‡ï¼š" + (baseHandle.name || "(è³‡æ–™å¤¾)");
    await scan();
    updatePreview();
  }catch(e){
    // user canceled
  }
});

$("refreshBtn").addEventListener('click', async ()=>{
  await scan();
  updatePreview();
});
$("inputSel").addEventListener('change', async ()=>{
  await refreshStories();
  updatePreview();
});
$("modeSel").addEventListener('change', ()=>{
  updatePreview();
});
$("storySel").addEventListener('change', ()=>{
  updatePreview();
});
$("genBtn").addEventListener('click', ()=>{
  updatePreview();
  downloadBat();
});
$("copyBtn").addEventListener('click', async ()=>{
  try{ await navigator.clipboard.writeText($("batPreview").value); }catch(e){}
});

</script>
</body>
</html>
