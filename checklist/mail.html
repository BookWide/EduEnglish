/* ===== 補寄所有 MAIL_FAIL ===== */
document.getElementById('btnResendFail').onclick = async ()=>{
  if(!confirm('確定要補寄所有 MAIL_FAIL？')) return;

  const { data, error } = await supa
    .from('ecpay_callbacks')
    .select('merchant_trade_no')
    .eq('method','MAIL_RESULT')
    .eq('rtn_code','MAIL_FAIL');

  if(error){
    alert(error.message);
    return;
  }

  if(!data.length){
    alert('目前沒有 MAIL_FAIL');
    return;
  }

  for(const r of data){
    await fetch(
      `${SUPABASE_URL}/functions/v1/admin-resend-email`,
      {
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'Authorization':`Bearer ${BW.session()?.access_token}`
        },
        body: JSON.stringify({
          merchant_trade_no: r.merchant_trade_no,
          force: true
        })
      }
    );
  }

  alert('補寄完成');
  load();
};

/* ===== 匯出 CSV ===== */
document.getElementById('btnExportCSV').onclick = async ()=>{
  const { data } = await supa
    .from('ecpay_callbacks')
    .select('*')
    .eq('method','MAIL_RESULT')
    .order('created_at',{ascending:false});

  if(!data?.length){
    alert('沒有資料');
    return;
  }

  const header = Object.keys(data[0]).join(',');
  const rows = data.map(r =>
    Object.values(r).map(v => `"${String(v||'').replace(/"/g,'""')}"`).join(',')
  );

  const csv = [header, ...rows].join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'mail_result.csv';
  a.click();
};


