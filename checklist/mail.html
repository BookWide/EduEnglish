<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Email 通知中心｜BookWide</title>

<style>
:root{
  --bg:#f4f6fb;
  --card:#fff;
  --muted:#6b7280;
  --border:#e5e7eb;
  --brand:#2563eb;
  --ok:#15803d;
  --fail:#b91c1c;
}
body{
  margin:0;
  font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;
  background:var(--bg);
}
.wrap{
  max-width:1100px;
  margin:24px auto;
  padding:0 16px 40px;
}
h1{margin:0 0 6px}
.sub{color:var(--muted);font-size:14px;margin-bottom:16px}
.card{
  background:var(--card);
  border-radius:16px;
  padding:16px;
  box-shadow:0 10px 30px rgba(15,23,42,.08);
  margin-bottom:16px;
}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
input{
  flex:1;
  padding:10px 14px;
  border-radius:999px;
  border:1px solid var(--border);
  font-size:14px;
  min-width:260px;
}
button{
  padding:10px 18px;
  border-radius:999px;
  border:0;
  background:var(--brand);
  color:#fff;
  cursor:pointer;
  font-size:14px;
  white-space:nowrap;
}
button.secondary{background:#111827}
button.ghost{background:#e5e7eb;color:#111827}
button.danger{background:#b91c1c}
table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}
th,td{
  padding:8px 6px;
  border-bottom:1px solid var(--border);
}
th{text-align:left;color:#4b5563;white-space:nowrap}
.pill{
  padding:3px 10px;
  border-radius:999px;
  font-size:12px;
  display:inline-block;
  white-space:nowrap;
}
.ok{background:#ecfdf3;color:var(--ok)}
.fail{background:#fff1f2;color:var(--fail)}
.small{font-size:12px;color:var(--muted)}
pre{margin:8px 0 0;white-space:pre-wrap;word-break:break-word}
hr{border:0;border-top:1px solid var(--border);margin:12px 0}
</style>

<!-- ✅ 建議：直接吃你現成的登入狀態 & admin 檢查（不改其它檔） -->
<script type="module" src="../supa.js?v=20251229-mail1"></script>
</head>

<body>
<div class="wrap">
  <a href="../admin.html">← 回上頁</a>
  <h1>Email 通知中心</h1>
  <p class="sub">查詢付款成功信 / 補寄（補寄只透過 Edge Function）</p>

  <!-- 查詢 / 補寄 -->
  <div class="card">
    <div class="row">
      <input id="mtn" placeholder="輸入 MerchantTradeNo（例：BW2512290828596）" />
      <button id="btnQuery">查詢</button>
      <button class="secondary" id="btnResendOne">強制補寄</button>
      <button class="ghost" id="btnReload">重新整理</button>
    </div>

    <div class="row" style="margin-top:10px;">
      <!-- ✅ 你要的：一鍵補寄所有 FAIL -->
      <button class="danger" id="btnResendAllFail">補寄所有 MAIL_FAIL</button>
      <button class="ghost" id="btnExportCSV">匯出 CSV（最近 50 筆）</button>

      <!-- ✅ 可選：固定 BCC 給自己（你要就打勾） -->
      <label class="small" style="display:flex;align-items:center;gap:6px;">
        <input type="checkbox" id="chkBcc" />
        BCC 一份到 pmktools@gmail.com
      </label>
    </div>

    <p class="small">⚠️ 補寄會呼叫 Edge Function：<b>admin-resend-email</b>。查詢與列表則讀取 <b>ecpay_callbacks</b> 的 <b>MAIL_RESULT</b> 記錄。</p>
  </div>

  <!-- 查詢結果 -->
  <div class="card">
    <h3 style="margin:0 0 8px;">查詢結果</h3>
    <div id="result" class="small">尚未查詢</div>
  </div>

  <!-- 最近寄信紀錄 -->
  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <h3 style="margin:0;">最近寄信紀錄（MAIL_RESULT）</h3>
      <div class="small">只顯示最近 50 筆</div>
    </div>
    <table>
      <thead>
        <tr>
          <th>時間</th>
          <th>MerchantTradeNo</th>
          <th>結果</th>
          <th>To</th>
          <th>Detail</th>
        </tr>
      </thead>
      <tbody id="logs">
        <tr><td colspan="5" class="small">載入中…</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script type="module">
/**
 * ✅ 核心修正點
 * - 你之前 doQuery() 是用 Edge Function 回傳 logs，但你的 function 未必支援 action=query
 * - 所以改成：查詢/列表 一律直接查 ecpay_callbacks(method='MAIL_RESULT')
 * - 補寄才呼叫 admin-resend-email
 */

// ---- wait BW + supabase ready ----
const ready = () => new Promise(r=>{
  if (window.BW && window.BW.supa) return r();
  const t=setInterval(()=>{
    if (window.BW && window.BW.supa){ clearInterval(t); r(); }
  },50);
});
await ready();

const supa = window.BW.supa;
const $ = q => document.querySelector(q);

const fmt = (ts)=>{
  if(!ts) return '';
  const d = new Date(ts);
  if(isNaN(d)) return String(ts);
  return d.toLocaleString('zh-TW',{timeZone:'Asia/Taipei',hour12:false});
};

function pill(ok){
  return `<span class="pill ${ok?'ok':'fail'}">${ok?'MAIL_OK':'MAIL_FAIL'}</span>`;
}

function safeStr(v){
  if(v === null || v === undefined) return '';
  if(typeof v === 'object') return JSON.stringify(v);
  return String(v);
}

/* ====== 讀最近 50 筆 MAIL_RESULT ====== */
async function loadRecent(){
  const tbody = $('#logs');
  tbody.innerHTML = `<tr><td colspan="5" class="small">載入中…</td></tr>`;
  try{
    // ✅ 這張表就是你畫面上那個「MAIL_OK / MAIL_FAIL」來源
    const r = await supa
      .from('ecpay_callbacks')
      .select('created_at, merchant_trade_no, rtn_code, raw_body')
      .eq('method','MAIL_RESULT')
      .order('created_at',{ascending:false})
      .limit(50);

    if(r.error) throw r.error;

    const rows = (r.data || []).map(x=>{
      const ok = x.rtn_code === 'MAIL_OK';
      let to = '';
      let detail = '';
      try{
        const parsed = typeof x.raw_body === 'string' ? JSON.parse(x.raw_body) : x.raw_body;
        // 你 function 寫入 raw_body 可能是 { ok, to, detail, ... }
        to = parsed?.to || parsed?.toMain || '';
        detail = parsed?.detail || parsed?.message || safeStr(parsed);
      }catch(_){
        detail = safeStr(x.raw_body);
      }

      return {
        created_at: fmt(x.created_at),
        merchant_trade_no: x.merchant_trade_no || '',
        ok,
        to,
        detail
      };
    });

    renderLogs(rows);
  }catch(e){
    tbody.innerHTML = `<tr><td colspan="5" class="small">讀取失敗：${e.message||e}</td></tr>`;
  }
}

function renderLogs(rows){
  const tbody = $('#logs');
  if(!rows.length){
    tbody.innerHTML = `<tr><td colspan="5" class="small">沒有紀錄</td></tr>`;
    return;
  }
  tbody.innerHTML = rows.map(r=>`
    <tr>
      <td>${r.created_at||''}</td>
      <td>${r.merchant_trade_no||''}</td>
      <td>${pill(!!r.ok)}</td>
      <td>${r.to||''}</td>
      <td>${safeStr(r.detail||'')}</td>
    </tr>
  `).join('');
}

/* ====== 查詢單筆（直接查表） ====== */
async function doQuery(){
  const mtn = $('#mtn').value.trim();
  if(!mtn) return alert('請輸入 MerchantTradeNo');

  $('#result').textContent = '查詢中…';
  try{
    // 取最近一筆該 MTN 的 MAIL_RESULT
    const r = await supa
      .from('ecpay_callbacks')
      .select('created_at, merchant_trade_no, rtn_code, raw_body')
      .eq('method','MAIL_RESULT')
      .eq('merchant_trade_no', mtn)
      .order('created_at',{ascending:false})
      .limit(20);

    if(r.error) throw r.error;

    const list = r.data || [];
    if(!list.length){
      $('#result').innerHTML = `<span class="pill fail">找不到紀錄</span> 這筆 MTN 目前沒有 MAIL_RESULT（可能尚未寄 / 尚未寫入）`;
      return;
    }

    // 顯示 JSON（最新一筆）
    const latest = list[0];
    $('#result').innerHTML = `
      <div>${pill(latest.rtn_code === 'MAIL_OK')} <b>${latest.merchant_trade_no}</b>　<span class="small">${fmt(latest.created_at)}</span></div>
      <pre>${safeStr(latest.raw_body)}</pre>
    `;

    // 同 MTN 的多筆也放到表格
    const rows = list.map(x=>{
      let to='', detail='';
      try{
        const parsed = typeof x.raw_body === 'string' ? JSON.parse(x.raw_body) : x.raw_body;
        to = parsed?.to || parsed?.toMain || '';
        detail = parsed?.detail || parsed?.message || safeStr(parsed);
      }catch(_){
        detail = safeStr(x.raw_body);
      }
      return {
        created_at: fmt(x.created_at),
        merchant_trade_no: x.merchant_trade_no || '',
        ok: x.rtn_code === 'MAIL_OK',
        to,
        detail
      };
    });
    renderLogs(rows);
  }catch(e){
    $('#result').innerHTML = `<span class="pill fail">查詢失敗</span> ${e.message||e}`;
  }
}

/* ====== 補寄單筆（呼叫 Edge Function） ====== */
async function doResendOne(){
  const mtn = $('#mtn').value.trim();
  if(!mtn) return alert('請輸入 MerchantTradeNo');
  if(!confirm('確定要強制補寄？')) return;

  const copyTo = $('#chkBcc').checked ? 'pmktools@gmail.com' : null;

  try{
    // ✅ 你 function 目前已經能跑（你截圖有 MAIL_OK）
    const { data, error } = await supa.functions.invoke('admin-resend-email', {
      body: { merchant_trade_no: mtn, force: true, copy_to: copyTo }
    });
    if(error) throw error;

    alert('補寄已送出');
    console.log(data);
    await loadRecent();
  }catch(e){
    alert('補寄失敗：' + (e.message||e));
  }
}

/* ====== 補寄所有 FAIL（讀表 -> 逐筆呼叫 function） ====== */
async function doResendAllFail(){
  if(!confirm('確定要補寄所有 MAIL_FAIL？（會逐筆呼叫 admin-resend-email）')) return;

  const copyTo = $('#chkBcc').checked ? 'pmktools@gmail.com' : null;

  // 找出最近 200 筆內的 FAIL（你也可以把 limit 改大）
  const r = await supa
    .from('ecpay_callbacks')
    .select('merchant_trade_no, created_at')
    .eq('method','MAIL_RESULT')
    .eq('rtn_code','MAIL_FAIL')
    .order('created_at',{ascending:false})
    .limit(200);

  if(r.error){
    alert('讀取 MAIL_FAIL 失敗：' + r.error.message);
    return;
  }

  const uniq = [];
  const seen = new Set();
  for(const x of (r.data||[])){
    const mtn = x.merchant_trade_no;
    if(!mtn) continue;
    if(seen.has(mtn)) continue;
    seen.add(mtn);
    uniq.push(mtn);
  }

  if(!uniq.length){
    alert('目前沒有 MAIL_FAIL');
    return;
  }

  $('#result').innerHTML = `<span class="small">補寄中… 共 ${uniq.length} 筆</span>`;

  let ok = 0, fail = 0;
  for(const mtn of uniq){
    try{
      const rr = await supa.functions.invoke('admin-resend-email', {
        body: { merchant_trade_no: mtn, force: true, copy_to: copyTo }
      });
      if(rr.error) throw rr.error;
      ok++;
    }catch(_){
      fail++;
    }
  }

  $('#result').innerHTML = `<span class="small">補寄完成：OK ${ok} / FAIL ${fail}</span>`;
  await loadRecent();
}

/* ====== 匯出 CSV（最近 50 筆） ====== */
async function exportCSV(){
  const r = await supa
    .from('ecpay_callbacks')
    .select('created_at, merchant_trade_no, rtn_code, raw_body')
    .eq('method','MAIL_RESULT')
    .order('created_at',{ascending:false})
    .limit(50);

  if(r.error){
    alert('匯出失敗：' + r.error.message);
    return;
  }

  const rows = (r.data||[]).map(x=>{
    let to='', detail='';
    try{
      const parsed = typeof x.raw_body === 'string' ? JSON.parse(x.raw_body) : x.raw_body;
      to = parsed?.to || parsed?.toMain || '';
      detail = parsed?.detail || parsed?.message || safeStr(parsed);
    }catch(_){
      detail = safeStr(x.raw_body);
    }
    return {
      created_at: fmt(x.created_at),
      merchant_trade_no: x.merchant_trade_no || '',
      result: x.rtn_code || '',
      to,
      detail
    };
  });

  if(!rows.length){
    alert('沒有資料可匯出');
    return;
  }

  const header = Object.keys(rows[0]).join(',');
  const body = rows.map(r =>
    Object.values(r).map(v => `"${String(v??'').replace(/"/g,'""')}"`).join(',')
  ).join('\n');

  const csv = header + '\n' + body;
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `mail_result_${Date.now()}.csv`;
  a.click();
}

/* ====== 綁事件 ====== */
$('#btnQuery').addEventListener('click', doQuery);
$('#btnResendOne').addEventListener('click', doResendOne);
$('#btnReload').addEventListener('click', loadRecent);
$('#btnResendAllFail').addEventListener('click', doResendAllFail);
$('#btnExportCSV').addEventListener('click', exportCSV);

// Enter 直接查詢
$('#mtn').addEventListener('keydown', (e)=>{
  if(e.key === 'Enter') doQuery();
});

// ✅ 進頁面先確認 admin（你 BW.requireAdmin 已經在 supa.js 裡）
try{ await window.BW.requireAdmin(); }catch(_){ /* BW 裡若已處理 redirect，就不用做事 */ }

// ✅ 進頁面自動載入最近寄信紀錄
loadRecent();
</script>
</body>
</html>





