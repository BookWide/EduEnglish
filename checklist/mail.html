<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin｜Email 通知中心</title>
  <style>
    :root{
      --bg:#f4f6fb; --card:#fff; --ink:#111827; --muted:#6b7280; --line:#e5e7eb;
      --brand:#2563eb; --soft:#eef2ff; --ok:#15803d; --warn:#ea580c; --danger:#b91c1c;
      --radius:18px; --shadow:0 14px 40px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif;background:var(--bg);color:var(--ink)}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1100px;margin:24px auto 48px;padding:0 16px}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap}
    .back{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:#fff}
    .admin{color:var(--muted);font-size:13px}
    h1{margin:6px 0 6px;font-size:24px}
    .sub{margin:0 0 16px;color:var(--muted);font-size:14px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){ .grid{grid-template-columns:1fr 1fr} }
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .card h2{margin:0 0 10px;font-size:16px}
    .kpis{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    .kpi{background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px}
    .kpi .t{font-size:12px;color:var(--muted)}
    .kpi .v{font-size:20px;font-weight:800;margin-top:4px}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);padding:2px 10px;border-radius:999px;font-size:12px;background:#fff}
    .pill.ok{border-color:rgba(21,128,61,.35);color:var(--ok);background:#ecfdf3}
    .pill.warn{border-color:rgba(234,88,12,.35);color:var(--warn);background:#fff7ed}
    .pill.bad{border-color:rgba(185,28,28,.35);color:var(--danger);background:#fff1f2}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row input{flex:1;min-width:220px;padding:10px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:14px}
    .btn{appearance:none;border:0;background:var(--brand);color:#fff;border-radius:999px;padding:10px 14px;font-size:14px;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--ink);border:1px solid var(--line)}
    .btn.danger{background:var(--danger)}
    .btn.small{padding:7px 10px;font-size:13px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    thead th{font-size:12px;color:#4b5563;background:#f9fafb;text-align:left;border-bottom:1px solid var(--line);padding:8px 6px;white-space:nowrap}
    tbody td{border-bottom:1px solid #f1f5f9;padding:8px 6px;vertical-align:top}
    tbody tr:nth-child(even){background:#fbfcff}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .muted{color:var(--muted);font-size:12px}
    .hint{padding:14px 8px;text-align:center;color:var(--muted)}
    .right{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .err{color:var(--danger);font-size:13px}
    .ok{color:var(--ok);font-size:13px}
  </style>
  <script type="module" src="../supa.js?v=20251229a"></script>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="back" href="../admin.html">← 回上頁</a>
      <div class="admin">管理員：<b id="adminEmail">讀取中…</b></div>
    </div>

    <h1>Email 通知中心</h1>
    <p class="sub">集中管理付款成功通知信（補寄 / 查詢 / 失敗原因）。</p>

    <div class="card" style="margin-bottom:12px;">
      <div class="row">
        <input id="mtn" class="mono" placeholder="輸入 MerchantTradeNo（例如 BW2512281708024）" />
        <button id="btnLookup" class="btn">查詢</button>
        <button id="btnRefresh" class="btn secondary">重新整理</button>
      </div>
      <div id="lookupMsg" class="muted" style="margin-top:8px;"></div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>總覽（近 48 小時）</h2>
        <div class="kpis">
          <div class="kpi"><div class="t">MAIL_OK</div><div class="v" id="k_ok">—</div></div>
          <div class="kpi"><div class="t">MAIL_FAIL</div><div class="v" id="k_fail">—</div></div>
          <div class="kpi"><div class="t">待補寄（paid & 未寄）</div><div class="v" id="k_pending">—</div></div>
        </div>
        <div class="muted" style="margin-top:10px;">
          規則：寄信成功以 <span class="mono">orders.email_sent_at</span> 為準；失敗原因看 <span class="mono">ecpay_callbacks(method=MAIL_RESULT)</span>。
        </div>
      </div>

      <div class="card">
        <h2>操作</h2>
        <div class="muted" style="margin-bottom:10px;">
          「補寄」會呼叫 Edge Function：<span class="mono">admin-resend-email</span>。<br/>
          若你要強制重寄：在查詢後按「強制重寄」。
        </div>
        <div id="opBox" class="hint">請先用上方輸入 MerchantTradeNo 查詢</div>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <h2>待補寄清單</h2>
      <div class="muted" style="margin-bottom:10px;">條件：status=paid、email_to 有值、email_sent_at 為空（最多 200 筆）。</div>
      <div style="overflow-x:auto;">
        <table id="tblPending">
          <thead>
            <tr>
              <th>建立時間</th>
              <th>MerchantTradeNo</th>
              <th>Email</th>
              <th>金額</th>
              <th>到期</th>
              <th class="right">操作</th>
            </tr>
          </thead>
          <tbody><tr><td class="hint" colspan="6">載入中…</td></tr></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <h2>最近寄信紀錄（MAIL_RESULT）</h2>
      <div class="muted" style="margin-bottom:10px;">顯示最近 50 筆（成功/失敗與原因）。</div>
      <div style="overflow-x:auto;">
        <table id="tblLogs">
          <thead>
            <tr>
              <th>時間</th>
              <th>MerchantTradeNo</th>
              <th>結果</th>
              <th>To</th>
              <th>Detail</th>
            </tr>
          </thead>
          <tbody><tr><td class="hint" colspan="5">載入中…</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

<script type="module">
const $ = (q,root=document)=>root.querySelector(q);
const readyBW = () => new Promise(r=>{
  if (window.BW && window.BW.supa) return r();
  const t=setInterval(()=>{ if (window.BW && window.BW.supa){ clearInterval(t); r(); } }, 50);
});
const fmtTW = (ts) => {
  if(!ts) return '';
  const d = new Date(ts);
  if(isNaN(d)) return '';
  return d.toLocaleString('zh-TW',{timeZone:'Asia/Taipei',hour12:false});
};
const money = (cents) => 'NT$ ' + Math.round((Number(cents||0))/100);
function pill(result){
  if(result==='MAIL_OK') return '<span class="pill ok">MAIL_OK</span>';
  if(result==='MAIL_FAIL') return '<span class="pill bad">MAIL_FAIL</span>';
  return '<span class="pill warn">'+String(result||'—')+'</span>';
}
async function invokeResend(mtn, force=false){
  const supa = BW.supa;
  const { data, error } = await supa.functions.invoke('admin-resend-email', {
    body: { merchant_trade_no: mtn, force: !!force }
  });
  if(error) throw error;
  if(!data?.ok) throw new Error(data?.message || 'RESEND_FAILED');
  return data;
}
async function loadAll(){
  const supa = BW.supa;
  // pending
  $('#tblPending tbody').innerHTML = '<tr><td class="hint" colspan="6">載入中…</td></tr>';
  const pr = await supa
    .from('orders')
    .select('created_at, merchant_trade_no, email_to, total_cents, expire_at, email_sent_at, status')
    .eq('status','paid')
    .is('email_sent_at', null)
    .not('email_to','is', null)
    .order('created_at',{ascending:false})
    .limit(200);
  if(pr.error){
    $('#tblPending tbody').innerHTML = '<tr><td class="hint" colspan="6">讀取失敗：'+pr.error.message+'</td></tr>';
  }else{
    const rows = pr.data||[];
    $('#k_pending').textContent = String(rows.length);
    $('#tblPending tbody').innerHTML = rows.length ? rows.map(r=>{
      const mtn = r.merchant_trade_no||'';
      return `
        <tr>
          <td>${fmtTW(r.created_at)}</td>
          <td class="mono">${mtn}</td>
          <td class="mono">${r.email_to||''}</td>
          <td>${money(r.total_cents)}</td>
          <td>${fmtTW(r.expire_at)||'—'}</td>
          <td><div class="right"><button class="btn small" data-act="resend" data-mtn="${mtn}">補寄</button></div></td>
        </tr>`;
    }).join('') : '<tr><td class="hint" colspan="6">目前沒有待補寄</td></tr>';
  }
  // KPI logs (48h)
  const since = new Date(Date.now() - 48*3600*1000).toISOString();
  const lr = await supa
    .from('ecpay_callbacks')
    .select('created_at, method, merchant_trade_no, rtn_code')
    .eq('method','MAIL_RESULT')
    .gte('created_at', since)
    .order('created_at',{ascending:false})
    .limit(500);
  let ok=0, fail=0;
  if(!lr.error){
    for(const x of (lr.data||[])){
      if(String(x.rtn_code||'')==='MAIL_OK') ok++;
      if(String(x.rtn_code||'')==='MAIL_FAIL') fail++;
    }
  }
  $('#k_ok').textContent = String(ok);
  $('#k_fail').textContent = String(fail);
  // recent logs 50
  $('#tblLogs tbody').innerHTML = '<tr><td class="hint" colspan="5">載入中…</td></tr>';
  const lr2 = await supa
    .from('ecpay_callbacks')
    .select('created_at, method, merchant_trade_no, rtn_code, raw_body, parsed')
    .eq('method','MAIL_RESULT')
    .order('created_at',{ascending:false})
    .limit(50);
  if(lr2.error){
    $('#tblLogs tbody').innerHTML = '<tr><td class="hint" colspan="5">讀取失敗：'+lr2.error.message+'</td></tr>';
  }else{
    const rows = lr2.data||[];
    $('#tblLogs tbody').innerHTML = rows.length ? rows.map(x=>{
      const parsed = x.parsed || {};
      const to = parsed?.to ? String(parsed.to) : '';
      const detail = parsed?.detail ? String(parsed.detail) : (x.raw_body||'');
      return `
        <tr>
          <td>${fmtTW(x.created_at)}</td>
          <td class="mono">${x.merchant_trade_no||''}</td>
          <td>${pill(x.rtn_code)}</td>
          <td class="mono">${to}</td>
          <td class="mono muted">${detail ? detail.slice(0,140) : ''}</td>
        </tr>`;
    }).join('') : '<tr><td class="hint" colspan="5">目前沒有紀錄</td></tr>';
  }
}
async function lookupOne(mtn){
  const supa = BW.supa;
  $('#lookupMsg').textContent = '查詢中…';
  $('#opBox').innerHTML = '<div class="hint">查詢中…</div>';
  const r = await supa
    .from('orders')
    .select('created_at, merchant_trade_no, status, email_to, email_sent_at, total_cents, expire_at, period')
    .eq('merchant_trade_no', mtn)
    .maybeSingle();
  if(r.error){
    $('#lookupMsg').innerHTML = '<span class="err">查詢失敗：'+r.error.message+'</span>';
    $('#opBox').innerHTML = '<div class="hint">—</div>';
    return;
  }
  const o = r.data;
  if(!o){
    $('#lookupMsg').innerHTML = '<span class="err">找不到訂單：'+mtn+'</span>';
    $('#opBox').innerHTML = '<div class="hint">—</div>';
    return;
  }
  const canResend = (String(o.status||'')==='paid') && (o.email_to) && (!o.email_sent_at);
  $('#lookupMsg').innerHTML = `
    <span class="mono">${mtn}</span>　
    狀態：<b>${o.status||'—'}</b>　
    Email：<span class="mono">${o.email_to||'—'}</span>　
    金額：<b>${money(o.total_cents)}</b>　
    寄出：<b>${o.email_sent_at ? fmtTW(o.email_sent_at) : '尚未'}</b>`;
  $('#opBox').innerHTML = `
    <div class="row">
      <button id="btnResend" class="btn" ${canResend ? '' : 'disabled'}>補寄</button>
      <button id="btnForce" class="btn danger">強制重寄</button>
      <span class="muted">（強制重寄不看 email_sent_at，會再寄一次）</span>
    </div>
    <div id="opMsg" class="muted" style="margin-top:10px;"></div>`;
  $('#btnResend').addEventListener('click', async ()=>{
    try{
      $('#opMsg').textContent = '補寄中…';
      const out = await invokeResend(mtn,false);
      $('#opMsg').innerHTML = '<span class="ok">補寄成功：'+(out.to||'')+'</span>';
      await loadAll(); await lookupOne(mtn);
    }catch(e){
      $('#opMsg').innerHTML = '<span class="err">補寄失敗：'+(e.message||e)+'</span>';
    }
  });
  $('#btnForce').addEventListener('click', async ()=>{
    try{
      $('#opMsg').textContent = '強制重寄中…';
      const out = await invokeResend(mtn,true);
      $('#opMsg').innerHTML = '<span class="ok">強制重寄成功：'+(out.to||'')+'</span>';
      await loadAll(); await lookupOne(mtn);
    }catch(e){
      $('#opMsg').innerHTML = '<span class="err">強制重寄失敗：'+(e.message||e)+'</span>';
    }
  });
}
(async ()=>{
  await readyBW();
  await BW.requireAdmin();
  try{
    const { data:{user} } = await BW.supa.auth.getUser();
    $('#adminEmail').textContent = user?.email || '—';
  }catch(_){ $('#adminEmail').textContent = '—'; }
  $('#btnRefresh').addEventListener('click', loadAll);
  $('#btnLookup').addEventListener('click', ()=>{
    const mtn = ($('#mtn').value||'').trim();
    if(mtn) lookupOne(mtn);
  });
  $('#mtn').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('#btnLookup').click(); } });
  document.addEventListener('click', async (e)=>{
    const btn = e.target?.closest?.('button[data-act="resend"]');
    if(!btn) return;
    const mtn = btn.getAttribute('data-mtn');
    if(!mtn) return;
    btn.disabled = true; btn.textContent = '補寄中…';
    try{ await invokeResend(mtn,false); await loadAll(); }
    catch(err){ alert('補寄失敗：' + (err?.message||err)); }
    finally{ btn.disabled=false; btn.textContent='補寄'; }
  });
  await loadAll();
})();
</script>
</body>
</html>
