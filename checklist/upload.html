<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin｜上傳 MP4 / COVER / JSON</title>

  <style>
    :root{
      --bg:#f4f6fb;
      --card-bg:#fff;
      --muted:#6b7280;
      --border:#e5e7eb;
      --brand:#2563eb;
      --brand-soft:#e0edff;
      --radius-lg:18px;
      --shadow-card:0 10px 30px rgba(15,23,42,.08);
    }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC","Microsoft JhengHei";
      background:var(--bg);
      color:#111827;
    }
    .wrap{
      max-width:760px;
      margin:24px auto 80px;
      padding:0 16px 40px;
    }
    header{margin-bottom:10px;}
    .title{font-size:1.5rem;font-weight:700;}
    .subtitle{font-size:.9rem;color:var(--muted);margin-top:4px;}

    .top-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:6px;margin-bottom:14px;
    }
    .back-btn{
      font-size:.85rem;
      color:#2563eb;
      cursor:pointer;
      text-decoration:none;
      padding:6px 14px;
      border:1px solid #2563eb;
      border-radius:999px;
      background:#fff;
    }
    .admin-mail{
      font-size:.85rem;
      color:#6b7280;
    }

    /* Tabs */
    .tabs{
      display:flex;gap:10px;margin-bottom:18px;
    }
    .tab{
      padding:8px 18px;border-radius:30px;
      border:1px solid #d1d5db;font-size:.9rem;
      background:#fff;color:#374151;text-decoration:none;
    }
    .tab.active{
      background:#2563eb;color:#fff;border-color:#2563eb;
    }

    .card{
      background:var(--card-bg);
      border-radius:var(--radius-lg);
      padding:18px 18px 22px;
      box-shadow:var(--shadow-card);
      margin-bottom:24px;
    }
    .label{font-size:.9rem;font-weight:600;margin-bottom:6px;}
    .ipt{
      width:100%;padding:8px 12px;border-radius:10px;border:1px solid var(--border);font-size:1rem;
    }
    .file-row{margin:14px 0;}
    .btn{
      padding:8px 18px;border-radius:999px;border:1px solid #2563eb;
      background:#2563eb;color:#fff;cursor:pointer;font-size:.9rem;margin-top:6px;
    }
    .prog{
      margin-top:6px;height:8px;background:#e5e7eb;border-radius:8px;overflow:hidden;
    }
    .prog > div{
      height:100%;width:0%;background:#2563eb;transition:.2s;
    }
    .hint{font-size:.82rem;color:var(--muted);margin-top:6px;}
  </style>
</head>

<body>
<div class="wrap">

  <header>
    <div class="title">BookWide Admin｜上傳 MP4 / COVER / JSON</div>
    <div class="subtitle">上傳至 Supabase（mp4/cover）與 GitHub Pages（JSON）。</div>
  </header>

  <div class="top-row">
    <a href="/admin.html" class="back-btn">← 回上頁</a>
    <div class="admin-mail">管理員：<span id="adminEmail">檢查中…</span></div>
  </div>

  <nav class="tabs">
    <a href="user.html" class="tab">使用者清單</a>
    <a href="authorize.html" class="tab">授權／暫停管理員</a>
    <span class="tab active">上傳頁</span>
  </nav>

  <!-- === 影片資訊 === -->
  <section class="card">
    <div class="label">分類（category）</div>
    <input id="cat" class="ipt" placeholder="story / music / movie / news / pro">

    <div class="label" style="margin-top:14px;">片名（slug）</div>
    <input id="slug" class="ipt" placeholder="mid-autumn / houyi / alittlelove">
    <div class="hint">上傳路徑會自動成為：<br>mp4 → videos/{cat}/{slug}.mp4<br>jpg → assets/{cat}/{slug}.jpg</div>
  </section>

  <!-- === SUPABASE：Cover / MP4 === -->
  <section class="card">
    <h3 style="font-size:1.05rem;margin-bottom:10px;">上傳到 Supabase</h3>

    <div class="file-row">
      <div class="label">封面 cover.jpg</div>
      <input type="file" id="coverFile">
      <button class="btn" onclick="uploadCover()">上傳 Cover</button>
      <div class="prog"><div id="coverProg"></div></div>
    </div>

    <div class="file-row">
      <div class="label">影片 mp4</div>
      <input type="file" id="mp4File">
      <button class="btn" onclick="uploadMp4()">上傳 MP4</button>
      <div class="prog"><div id="mp4Prog"></div></div>
    </div>
  </section>

  <!-- === GitHub：JSON === -->
  <section class="card">
    <h3 style="font-size:1.05rem;margin-bottom:10px;">上傳到 GitHub Pages（JSON）</h3>

    <div class="file-row">
      <div class="label">cues-*.json</div>
      <input type="file" id="cuesFile">
      <button class="btn" onclick="uploadJson('cues')">上傳 cues</button>
      <div class="prog"><div id="cuesProg"></div></div>
    </div>

    <div class="file-row">
      <div class="label">quiz-*.json</div>
      <input type="file" id="quizFile">
      <button class="btn" onclick="uploadJson('quiz')">上傳 quiz</button>
      <div class="prog"><div id="quizProg"></div></div>
    </div>

    <div class="file-row">
      <div class="label">vocab-*.json</div>
      <input type="file" id="vocabFile">
      <button class="btn" onclick="uploadJson('vocab')">上傳 vocab</button>
      <div class="prog"><div id="vocabProg"></div></div>
    </div>

    <div class="file-row">
      <div class="label">ai-*.json</div>
      <input type="file" id="aiFile">
      <button class="btn" onclick="uploadJson('ai')">上傳 ai</button>
      <div class="prog"><div id="aiProg"></div></div>
    </div>
  </section>

</div>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
<script>
  const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
  const SUPABASE_ANON =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";

  const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  async function requireAdmin(){
    const { data:{session} } = await supa.auth.getSession();
    if(!session){
      alert("請先登入");
      location.href="/index.html"; throw 0;
    }
    const { data:p } = await supa.from("profiles")
      .select("email,is_admin,is_paused").eq("id",session.user.id).single();
    if(!p || !p.is_admin || p.is_paused){
      alert("沒有管理員權限");
      location.href="/index.html"; throw 0;
    }
    document.getElementById("adminEmail").textContent = p.email;
  }

  requireAdmin();
</script>

<!-- upload logic -->
<script>
function getPath(type){
  const cat = document.getElementById("cat").value.trim();
  const slug = document.getElementById("slug").value.trim();
  if(!cat || !slug){ alert("請先輸入分類與片名"); return null; }

  if(type==="cover") return `assets/${cat}/${slug}.jpg`;
  if(type==="mp4")   return `videos/${cat}/${slug}.mp4`;
  return null;
}

async function uploadCover(){
  const file = document.getElementById("coverFile").files[0];
  if(!file){ alert("請選擇檔案"); return; }

  const path = getPath("cover");
  if(!path) return;

  const prog = document.getElementById("coverProg");

  const { error } = await supa.storage
    .from("assets")
    .upload(path, file, {
      cacheControl:"3600",
      upsert:true,
      onUploadProgress: e => {
        prog.style.width = (e.loaded/e.total*100)+"%";
      }
    });

  if(error) alert("上傳錯誤："+error.message);
  else alert("封面已上傳成功！");
}

async function uploadMp4(){
  const file = document.getElementById("mp4File").files[0];
  if(!file){ alert("請選擇 mp4"); return; }

  const path = getPath("mp4");
  if(!path) return;

  const prog = document.getElementById("mp4Prog");

  const { error } = await supa.storage
    .from("videos")
    .upload(path, file, {
      cacheControl:"3600",
      upsert:true,
      onUploadProgress:e=>{
        prog.style.width = (e.loaded/e.total*100)+"%";
      }
    });

  if(error) alert("上傳錯誤："+error.message);
  else alert("MP4 已上傳成功！");
}

async function uploadJson(type){
  const fileEl = document.getElementById(type+"File");
  const file = fileEl.files[0];
  if(!file){ alert("請選擇 JSON 檔案"); return; }

  const cat = document.getElementById("cat").value.trim();
  const slug = document.getElementById("slug").value.trim();
  if(!cat || !slug){ alert("請先輸入分類與片名"); return; }

  const prog = document.getElementById(type+"Prog");

  const path = `data/${cat}/${type}-${slug}.json`;
  
  const rawUrl = "<YOUR_GITHUB_REPO_RAW>" + path;

  prog.style.width="20%";

  // 直接 PUT 上傳到 GitHub raw（需設定 CORS=open)
  const res = await fetch(rawUrl, {
    method:"PUT",
    headers:{ "Content-Type":"application/json" },
    body: file
  });

  if(!res.ok){
    alert("GitHub 上傳失敗（需啟用 Pages Write 权限）");
  }else{
    prog.style.width="100%";
    alert(`JSON（${type}）上傳成功`);
  }
}
</script>
</body>
</html>
