<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BookWide Admin｜Level 管理</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--bg:#f5f7fb;--card:#fff;--text:#111827;--muted:#6b7280;--line:#e5e7eb;--blue:#2563eb;--blue2:#1d4ed8;--red:#ef4444;--green:#16a34a;}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
    .title{font-size:28px;font-weight:900;letter-spacing:.2px}
    .subtitle{color:var(--muted);margin-top:4px}
    .tabs{display:flex;gap:8px;margin:12px 0 18px}
    .tab{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:#fff;color:#111827;text-decoration:none;font-weight:700}
    .tab:hover{border-color:#cbd5e1}
    .tab.active{background:#111827;color:#fff;border-color:#111827}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:0 10px 25px rgba(17,24,39,.06);padding:16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;color:#111827;font-weight:700}
    input{font:inherit;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;min-width:240px}
    input.small{min-width:120px;width:120px}
    button{font:inherit;border:0;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
    .btn{background:var(--blue);color:#fff}
    .btn:hover{background:var(--blue2)}
    .btn2{background:#111827;color:#fff}
    .btn2:hover{background:#0b1220}
    .btnDanger{background:var(--red);color:#fff}
    .btnDanger:hover{filter:brightness(.95)}
    .hint{color:var(--muted);font-size:13px;line-height:1.45;margin-top:8px}
    table{width:100%;border-collapse:separate;border-spacing:0 10px;margin-top:12px}
    th{font-size:12px;color:var(--muted);text-align:left;padding:0 10px}
    td{background:#fff;border:1px solid var(--line);padding:12px 10px;vertical-align:middle}
    tr td:first-child{border-top-left-radius:14px;border-bottom-left-radius:14px}
    tr td:last-child{border-top-right-radius:14px;border-bottom-right-radius:14px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .tag{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-weight:800;border:1px solid var(--line)}
    .tag.ok{border-color:#bbf7d0;background:#f0fdf4;color:#166534}
    .tag.no{border-color:#fecaca;background:#fff1f2;color:#9f1239}
    .right{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
    .warn{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;border-radius:14px;padding:12px;margin-top:12px}
    code{background:#f3f4f6;border:1px solid #e5e7eb;padding:2px 6px;border-radius:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="title">BookWide Admin｜Level 管理</div>
        <div class="subtitle">後台手動指定「使用者起點 Week」，以及（可選）解除 30 天冷卻。</div>
      </div>
      <div class="row">
        <span id="who" class="pill">未登入</span>
        <button id="reload" class="btn2">重新整理</button>
      </div>
    </div>

    <div class="tabs">
      <a class="tab" href="user.html">使用者清單</a>
      <a class="tab active" href="level-admin.html">Level 管理</a>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <input id="q" placeholder="搜尋 Email / 顯示名稱…" />
          <button id="search" class="btn">搜尋</button>
        </div>
        <div class="row">
          <span class="pill">預設：只顯示前 200 筆</span>
        </div>
      </div>

      <div class="warn">
        <b>重要：</b>要做到「後台改起點 → 前台 Talk 立即生效」，需要把 Level 寫到資料庫（profiles）。
        下面這頁會更新三個欄位（若欄位不存在會更新失敗）：
        <code>profiles.level_result</code>、<code>profiles.level_start_week</code>、<code>profiles.level_last_test_at</code>。
        <div class="hint">如果你尚未加欄位，先跑本頁下方提供的 SQL（只要一次）。</div>
      </div>

      <table id="tbl">
        <thead>
          <tr>
            <th>#</th>
            <th>Email</th>
            <th>顯示名稱</th>
            <th>訂閱到期</th>
            <th>目前 Level / 起點</th>
            <th class="right">操作</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="hint">
        ✅ 建議規則：訂閱決定「上限週數」，Level 只決定「起點」；一般用戶 30 天只能重測一次；Admin 永遠不受限。
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div style="font-weight:900;margin-bottom:8px">一次性 SQL（新增欄位 + RLS 設定）</div>
      <div class="hint">把下面貼到 Supabase SQL Editor 跑一次即可：</div>
      <pre style="white-space:pre-wrap;background:#0b1220;color:#e5e7eb;border-radius:14px;padding:12px;overflow:auto"><code id="sql"></code></pre>
    </div>
  </div>

  <script>
    // ===== Supabase public config (global) =====
    const SUPABASE_URL = 'https://jeajrwpmrgczimmrflxo.supabase.co';
    // NOTE: 這裡沿用你站上既有的 anon key（user.html/talk.html 也同樣用）。
    // 若你已在其他檔案用 window.SUPABASE_ANON_KEY，可改成讀 window.
    const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || window.SUPABASE_ANON_KEY || '';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });

    const $ = (id) => document.getElementById(id);
    const tbody = $('tbl').querySelector('tbody');

    const SQL = `-- 1) profiles 加欄位（只要一次）
alter table public.profiles
  add column if not exists level_result text,
  add column if not exists level_start_week int,
  add column if not exists level_last_test_at timestamptz;

-- 2) 一般用戶只能更新自己的 level 欄位（你可依現況調整）
--    這段假設 profiles 已有 RLS 且有 update policy。
--    若你已經有「使用者可更新自己 profiles」的 policy，這段可省略。
do $$
begin
  -- 只是示意：避免重複建立 policy 名稱
  if not exists (
    select 1 from pg_policies
    where schemaname='public' and tablename='profiles' and policyname='profiles_update_own_level'
  ) then
    create policy profiles_update_own_level
    on public.profiles
    for update
    using (auth.uid() = id)
    with check (auth.uid() = id);
  end if;
end $$;

-- 3) Admin 可更新所有人的 level 欄位
--    這段假設 profiles 有 is_admin boolean
do $$
begin
  if not exists (
    select 1 from pg_policies
    where schemaname='public' and tablename='profiles' and policyname='profiles_admin_update_level'
  ) then
    create policy profiles_admin_update_level
    on public.profiles
    for update
    using (exists (select 1 from public.profiles p where p.id = auth.uid() and p.is_admin = true))
    with check (true);
  end if;
end $$;`;

    $('sql').textContent = SQL;

    function fmt(dt){
      if(!dt) return '—';
      try{ return new Date(dt).toLocaleString('zh-TW',{hour12:false}); }catch(e){ return String(dt); }
    }

    function badge(ok, text){
      return `<span class="tag ${ok?'ok':'no'}">${text}</span>`;
    }

    async function ensureAdmin(){
      const { data: { session } } = await supabase.auth.getSession();
      if(!session){ $('who').textContent = '未登入'; throw new Error('not signed in'); }
      const email = session.user.email || '—';
      $('who').textContent = `管理員：${email}`;

      // 檢查 is_admin
      const { data, error } = await supabase.from('profiles').select('is_admin').eq('id', session.user.id).maybeSingle();
      if(error) throw error;
      if(!data || data.is_admin !== true){
        throw new Error('not admin');
      }
    }

    function rowHtml(u, idx){
      const level = u.level_result || '—';
      const start = (u.level_start_week ?? '—');
      const last = u.level_last_test_at ? fmt(u.level_last_test_at) : '—';
      const expires = u.expires_at ? fmt(u.expires_at) : '—';
      const ok = u.expires_at ? (new Date(u.expires_at).getTime() > Date.now()) : false;

      return `
        <tr>
          <td class="mono">${idx}</td>
          <td class="mono">${u.email || '—'}</td>
          <td>${u.display_name || '—'}</td>
          <td>${ok ? badge(true, expires) : badge(false, expires)}</td>
          <td>
            <div class="row" style="gap:8px">
              <span class="tag">${level}</span>
              <span class="pill">起點 W${start}</span>
            </div>
            <div class="hint">上次測驗：${last}</div>
          </td>
          <td>
            <div class="right">
              <input class="small" data-k="start" data-id="${u.id}" placeholder="起點W" value="${u.level_start_week ?? ''}" />
              <input class="small" data-k="level" data-id="${u.id}" placeholder="A1/A2/B1..." value="${u.level_result ?? ''}" />
              <button class="btn" data-act="save" data-id="${u.id}">保存</button>
              <button class="btnDanger" data-act="reset" data-id="${u.id}">解除冷卻</button>
            </div>
          </td>
        </tr>`;
    }

    async function loadUsers(keyword=''){
      await ensureAdmin();
      tbody.innerHTML = '';

      // 取必要欄位；若你還沒加 level 欄位，這個 select 仍可跑（不存在會報錯），所以用 select('*') 最穩。
      let q = supabase.from('profiles').select('*').order('expires_at', { ascending: false }).limit(200);
      if(keyword){
        // Supabase 不支援跨欄位 OR ilike 的簡寫，這裡用 or()
        const k = keyword.replace(/[,]/g,' ');
        q = q.or(`email.ilike.%${k}%,display_name.ilike.%${k}%`);
      }

      const { data, error } = await q;
      if(error) throw error;

      const rows = data || [];
      tbody.innerHTML = rows.map((u,i)=>rowHtml(u,i+1)).join('');
    }

    async function saveUser(id){
      const startEl = document.querySelector(`input[data-k="start"][data-id="${id}"]`);
      const levelEl = document.querySelector(`input[data-k="level"][data-id="${id}"]`);
      const startWeek = startEl && String(startEl.value||'').trim();
      const level = levelEl && String(levelEl.value||'').trim();

      const patch = {
        level_result: level || null,
        level_start_week: startWeek ? Number(startWeek) : null,
        // 保存時，等同「剛測過一次」：避免前台被判定可一直重測
        level_last_test_at: new Date().toISOString(),
      };

      const { error } = await supabase.from('profiles').update(patch).eq('id', id);
      if(error) throw error;
    }

    async function resetCooldown(id){
      const { error } = await supabase.from('profiles').update({ level_last_test_at: null }).eq('id', id);
      if(error) throw error;
    }

    document.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      if(btn.id === 'reload'){
        try{ await loadUsers($('q').value.trim()); }
        catch(err){ alert(`讀取失敗：${err.message||err}`); }
        return;
      }
      if(btn.id === 'search'){
        try{ await loadUsers($('q').value.trim()); }
        catch(err){ alert(`搜尋失敗：${err.message||err}`); }
        return;
      }

      const act = btn.dataset.act;
      const id = btn.dataset.id;
      if(!act || !id) return;

      try{
        if(act === 'save'){
          await saveUser(id);
          await loadUsers($('q').value.trim());
          return;
        }
        if(act === 'reset'){
          await resetCooldown(id);
          await loadUsers($('q').value.trim());
          return;
        }
      }catch(err){
        alert(`操作失敗：${err.message||err}`);
      }
    });

    // enter to search
    $('q').addEventListener('keydown', (ev)=>{
      if(ev.key === 'Enter') $('search').click();
    });

    // init
    (async ()=>{
      try{ await loadUsers(''); }
      catch(err){
        const msg = String(err.message||err);
        if(msg.includes('not signed in')){
          alert('請先登入管理員帳號');
        }else if(msg.includes('not admin')){
          alert('你不是管理員，無法使用此頁');
        }else{
          alert(`載入失敗：${msg}`);
        }
      }
    })();
  </script>
</body>
</html>
