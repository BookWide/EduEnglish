<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>SRT → 生圖提示辭/運鏡提示辭｜BookWide 工具</title>
<style>
  :root {
    --bg:#0b1220; --panel:#101b33; --panel2:#0f1930;
    --text:#eaf0ff; --muted:#9bb0d3; --line:#22345e;
    --accent:#4da3ff; --good:#2ee59d; --bad:#ff5d73;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",Arial;
       background:linear-gradient(180deg,#070b14,#0b1220 20%,#070b14); color:var(--text)}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .head{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .title{font-weight:800;font-size:18px;letter-spacing:.5px}
  .card{background:rgba(16,27,51,.92); border:1px solid var(--line); border-radius:14px; padding:14px; box-shadow:0 8px 24px rgba(0,0,0,.35)}
  .grid{display:grid;gap:12px;grid-template-columns: 1.2fr .8fr}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  label{font-size:12px;color:var(--muted)}
  input[type="text"], input[type="number"], select{background:var(--panel2); color:var(--text); border:1px solid var(--line);
      border-radius:10px; padding:10px 12px; outline:none; min-width:220px}
  input[type="file"]{color:var(--muted)}
  button{background:linear-gradient(180deg,#2a78ff,#1663ea); color:white;
      border:none;border-radius:12px; padding:10px 12px; font-weight:700; cursor:pointer}
  button.secondary{background:transparent;border:1px solid var(--line); color:var(--text)}
  button:disabled{opacity:.5; cursor:not-allowed}
  .hint{color:var(--muted); font-size:12px; line-height:1.5}
  .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid var(--line);
        border-radius:999px;background:rgba(15,25,48,.7);color:var(--muted);font-size:12px}
  table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border:1px solid var(--line); border-radius:12px}
  thead th{background:rgba(15,25,48,.9); color:var(--muted); font-size:12px; text-align:left; padding:10px; border-bottom:1px solid var(--line)}
  tbody td{padding:10px; border-bottom:1px solid rgba(34,52,94,.55); vertical-align:top; font-size:13px}
  tbody tr:hover td{background:rgba(77,163,255,.06)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .right{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
  .ok{color:var(--good);font-weight:800}
  .bad{color:var(--bad);font-weight:800}
  .small{font-size:12px;color:var(--muted)}
  textarea{width:100%; min-height:220px; resize:vertical; border-radius:12px; border:1px solid var(--line);
           background:var(--panel2); color:var(--text); padding:10px; line-height:1.45}
</style>
</head>
<body>
<div class="wrap">
  <div class="head">
    <div class="title">SRT → 依句生成：生圖提示辭 / 運鏡提示辭（可下載 JSON / CSV）</div>
    <div class="pill">規格：<span class="mono">短檔名 + 序號</span>（例：<span class="mono">lion_mouse_001</span>）</div>
  </div>

  <div class="grid" style="margin-top:12px">
    <div class="card">
      <div class="row">
        <div>
          <label>1) 上傳 SRT（會自動識別檔名）</label><br/>
          <input id="file" type="file" accept=".srt"/>
        </div>
        <div>
          <label>短檔名（可改）</label><br/>
          <input id="shortName" type="text" placeholder="例如: lion_mouse"/>
        </div>
        <div>
          <label>每張圖使用幾句英文（1–3）</label><br/>
          <select id="perScene">
            <option value="1">1 句</option>
            <option value="2">2 句</option>
            <option value="3">3 句</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="build" disabled>2) 解析 + 生成提示辭</button>
        <button id="downloadJson" class="secondary" disabled>下載 JSON</button>
        <button id="downloadCsv" class="secondary" disabled>下載 CSV</button>
        <span id="status" class="small"></span>
      </div>

      <div class="row" style="margin-top:10px; gap:10px; flex-wrap:wrap">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <span class="small" style="min-width:84px">MP3（TTS）</span>
          <input id="apiKey" type="password" placeholder="（不需 API Key，走 Supabase tts-mp3）" style="min-width:260px"/>
          <select id="voice">
            <option value="en-US-JennyNeural">en-US-JennyNeural（女）</option>
            <option value="en-US-AriaNeural">en-US-AriaNeural（女）</option>
            <option value="en-US-GuyNeural">en-US-GuyNeural（男）</option>
            <option value="en-GB-SoniaNeural">en-GB-SoniaNeural（英女）</option>
            <option value="en-AU-NatashaNeural">en-AU-NatashaNeural（澳女）</option>
          </select>
          <input id="ttsRate" placeholder="rate（例：0% / -10% / +10%）" style="width:220px"/>
          <input id="ttsPitch" placeholder="pitch（例：0% / -5% / +5%）" style="width:220px"/>
        </div>
      </div>

      <div class="row" style="margin-top:8px; gap:10px; flex-wrap:wrap">
        <button id="mp3Selected" class="secondary" disabled>生 MP3（選取列）</button>
        <button id="mp3All" class="secondary" disabled>批次生 MP3（前 <span id="mp3LimitLabel">10</span> 列）</button>
        <input id="mp3Limit" type="number" min="1" max="500" value="10" style="width:90px"/>
        <span id="mp3Prog" class="small"></span>
      </div>

      <div class="hint" style="margin-top:10px">
        • 你可先用「每張 1 句」跑一版，再改成「2 / 3 句」重跑。<br/>
        • 生成的提示辭是「可直接貼到 GPT 生單張圖」的起手式；你要更精準風格，再在提示辭末尾加風格關鍵字即可。<br/>
      </div>

      <div style="margin-top:12px;overflow:auto;max-height:480px">
        <table id="tbl">
          <thead>
            <tr>
              <th style="width:110px">ID</th>
              <th style="width:170px">時間</th>
              <th>英文句（對齊）</th>
              <th style="width:320px">生圖提示辭（photo_prompt）</th>
              <th style="width:280px">運鏡提示辭（camera_prompt）</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <div style="font-weight:800;margin-bottom:6px">快速複製：單張生圖提示辭</div>
          <div class="hint">點表格列會把該列的 <span class="mono">photo_prompt</span> 複製到下面，直接 Ctrl+C 貼到 GPT 生單張。</div>
        </div>
        <div class="right">
          <button id="copyPrompt" class="secondary" disabled>複製</button>
        </div>
      </div>
      <textarea id="promptBox" placeholder="點左邊任何一列，這裡就會出現 photo_prompt"></textarea>
      <div class="hint" style="margin-top:10px">
        建議你貼到 GPT 生圖時，末尾加一行：<br/>
        <span class="mono">-- style: cinematic still, soft light, high detail, no text</span><br/>
        或你自己的固定風格關鍵字。
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const fileInput = $("file");
  const shortNameInput = $("shortName");
  const perSceneSel = $("perScene");
  const buildBtn = $("build");
  const jsonBtn = $("downloadJson");
  const csvBtn = $("downloadCsv");
  const status = $("status");
  const tbody = document.querySelector("#tbl tbody");
  const promptBox = $("promptBox");
  const copyPromptBtn = $("copyPrompt");
  const apiKeyInput = $("apiKey");
  const voiceSel = $("voice");
  const mp3SelectedBtn = $("mp3Selected");
  const mp3AllBtn = $("mp3All");
  const mp3LimitInput = $("mp3Limit");
  const mp3LimitLabel = $("mp3LimitLabel");
  const mp3Prog = $("mp3Prog");

  let current = { source_filename:"", short_name:"", per_scene:1, scenes:[] };

  let selectedScene = null;

  // 記住 API Key（只存本機 localStorage）
  const KEY_LS = "BW_OPENAI_API_KEY";
  if (apiKeyInput) {
    apiKeyInput.value = localStorage.getItem(KEY_LS) || "";
    apiKeyInput.addEventListener("change", ()=>{
      const v = (apiKeyInput.value||"").trim();
      if (v) localStorage.setItem(KEY_LS, v);
      else localStorage.removeItem(KEY_LS);
      refreshMp3Buttons();
    });
  }
  if (mp3LimitInput) {
    mp3LimitInput.addEventListener("input", ()=>{
      const n = parseInt(mp3LimitInput.value, 10) || 10;
      mp3LimitLabel.textContent = String(Math.max(1, n));
      refreshMp3Buttons();
    });
  }



  // Enable/disable MP3 controls based on current selection/data
  function refreshMp3Buttons() {
    try {
      const hasRows = current && Array.isArray(current.scenes) && current.scenes.length > 0;
      const hasSel = !!selectedScene;
      if (mp3SelectedBtn) mp3SelectedBtn.disabled = !hasSel;
      if (mp3AllBtn) mp3AllBtn.disabled = !hasRows;
      if (mp3LimitInput) mp3LimitInput.disabled = !hasRows;
      if (mp3LimitLabel && mp3LimitInput) {
        const n = parseInt(mp3LimitInput.value, 10) || 10;
        mp3LimitLabel.textContent = String(Math.max(1, n));
      }
    } catch (_) {}
  }

  function baseName(name) {
    return name.replace(/\.[^/.]+$/, "");
  }
  function inferShortName(filename) {
    // 1) 去掉括號內容  2) 去前導數字-  3) 轉 slug
    let b = baseName(filename).replace(/\s*\(.*?\)\s*/g,"").trim();
    b = b.replace(/^\d+\s*[-_]+\s*/,"");
    let slug = b.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"");
    if (!slug) slug = "srt";
    return slug.slice(0, 18);
  }

  function parseSrt(text) {
    const blocks = text.replace(/\r/g,"").trim().split(/\n\s*\n/);
    const out = [];
    for (const blk of blocks) {
      const lines = blk.split("\n").map(s=>s.trim()).filter(Boolean);
      if (lines.length < 2) continue;
      let timeLine = lines.find(l => l.includes("-->"));
      if (!timeLine) continue;
      const m = timeLine.match(/(\d{2}:\d{2}:\d{2}[,.]\d{3})\s*-->\s*(\d{2}:\d{2}:\d{2}[,.]\d{3})/);
      if (!m) continue;
      const start = m[1].replace(".",",");
      const end = m[2].replace(".",",");
      // 文字：取 timeLine 後面的行（也可能 index 在前）
      const timeIdx = lines.indexOf(timeLine);
      const textLines = lines.slice(timeIdx+1).map(l=>l.replace(/<[^>]+>/g,"")).filter(Boolean);
      const t = textLines.join(" ").replace(/\s+/g," ").trim();
      if (t) out.push({start, end, text:t});
    }
    return out;
  }

  const KW = [
    ["lion","a powerful lion with a noble mane"],
    ["mouse","a tiny mouse with bright eyes"],
    ["forest","lush green forest"],
    ["tree","a large tree with wide branches"],
    ["hunter","a hunter in the distance"],
    ["net","a rope net tangled"],
    ["trap","a rope trap"],
    ["roar","lion roaring"]
  ];

  function unique(arr) {
    const seen = new Set();
    const out = [];
    for (const x of arr) {
      if (seen.has(x)) continue;
      seen.add(x); out.push(x);
    }
    return out;
  }

  function genPhotoPrompt(english) {
    const t = english.toLowerCase();
    const subjects = unique(KW.filter(([k])=>t.includes(k)).map(([,v])=>v));
    const subj = subjects.length ? subjects.join(", ") : "storybook characters in a natural setting";
    const mood = "warm storybook realism, cinematic still photo, soft natural light, high detail";
    return `${subj}. ${mood}. Match the line: "${english}". No text, no captions.`;
  }

  function genCameraPrompt(english) {
    const t = english.toLowerCase();
    if (t.includes("fell asleep") || t.includes("asleep")) {
      return "slow push-in, low angle, gentle breathing motion, 35mm lens, shallow depth of field";
    }
    if (t.includes("ran") || t.includes("quick")) {
      return "quick dolly follow, handheld but stable, 28mm lens, slight motion blur";
    }
    if (t.includes("roar")) {
      return "dramatic push-in to close-up, 50mm lens, strong contrast, brief shake on roar";
    }
    if (t.includes("net") || t.includes("trap")) {
      return "medium shot to close-up on rope, rack focus from knot to face, 35mm lens";
    }
    return "slow pan left to right, medium-wide shot, 35mm lens, smooth stabilization";
  }

  function buildScenes(entries, shortName, perScene, sourceFilename) {
    const scenes = [];
    let seq = 1;
    for (let i=0; i<entries.length; i+=perScene) {
      const chunk = entries.slice(i, i+perScene);
      const english = chunk.map(x=>x.text).join(" ");
      const start = chunk[0].start;
      const end = chunk[chunk.length-1].end;
      const id = `${shortName}_${String(seq).padStart(3,"0")}`;
      scenes.push({
        id,
        short_name: shortName,
        seq,
        start,
        end,
        english,
        photo_prompt: genPhotoPrompt(english),
        camera_prompt: genCameraPrompt(english),
        source_filename: sourceFilename
      });
      seq++;
    }
    return scenes;
  }

  function renderTable(scenes) {
    tbody.innerHTML = "";
    for (const s of scenes) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${s.id}</td>
        <td class="mono">${s.start} → ${s.end}</td>
        <td>${escapeHtml(s.english)}</td>
        <td>${escapeHtml(s.photo_prompt)}</td>
        <td>${escapeHtml(s.camera_prompt)}</td>
      `;
      tr.addEventListener("click", ()=>{
        selectedScene = s;
        promptBox.value = s.photo_prompt;
        copyPromptBtn.disabled = false;
        status.innerHTML = `<span class="ok">已選取：</span><span class="mono">${s.id}</span>`;
        refreshMp3Buttons();
      });
      tbody.appendChild(tr);
    }
  }

  function escapeHtml(str) {
    return (str||"").replace(/[&<>"']/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]));

  function refreshMp3Buttons() {
    const keyOk = (apiKeyInput && (apiKeyInput.value||"").trim().length > 0);
    const hasScenes = current && current.scenes && current.scenes.length > 0;
    if (mp3SelectedBtn) mp3SelectedBtn.disabled = !(keyOk && selectedScene);
    if (mp3AllBtn) mp3AllBtn.disabled = !(keyOk && hasScenes);
  }

  async function ttsToMp3(text, filename) {
    const key = (apiKeyInput.value||"").trim();
    if (!key) throw new Error("缺 OPENAI_API_KEY");
    const payload = {
      text,
      voice: (voiceSel && voiceSel.value) ? voiceSel.value : "en-US-JennyNeural",
      rate: (document.getElementById("ttsRate")?.value || "0%").trim() || "0%",
      pitch: (document.getElementById("ttsPitch")?.value || "0%").trim() || "0%"
    };

    const resp = await fetch("https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/tts-mp3", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload)
    });
    if (!resp.ok) {
      const msg = await resp.text().catch(()=> "");
      throw new Error("TTS 失敗：" + resp.status + " " + (msg.slice(0, 200) || ""));
    }
    const buf = await resp.arrayBuffer();
    const blob = new Blob([buf], {type:"audio/mpeg"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename.endsWith(".mp3") ? filename : (filename + ".mp3");
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 2000);
  }

  }

  function download(filename, content, mime) {
    const blob = new Blob([content], {type: mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 500);
  }

  function toCsv(rows) {
    const cols = ["id","short_name","seq","start","end","english","photo_prompt","camera_prompt","source_filename"];
    const esc = (v)=>`"${String(v??"").replace(/"/g,'""')}"`;
    const lines = [cols.join(",")];
    for (const r of rows) {
      lines.push(cols.map(c=>esc(r[c])).join(","));
    }
    return lines.join("\n");
  }

  fileInput.addEventListener("change", async (e)=>{
    const f = fileInput.files && fileInput.files[0];
    if (!f) return;
    current.source_filename = f.name;
    shortNameInput.value = inferShortName(f.name);
    status.textContent = `已選擇：${f.name}`;
    buildBtn.disabled = false;
    jsonBtn.disabled = true;
    csvBtn.disabled = true;
    copyPromptBtn.disabled = true;
    promptBox.value = "";
    selectedScene = null;
    refreshMp3Buttons();
    tbody.innerHTML = "";
  });

  buildBtn.addEventListener("click", async ()=>{
    const f = fileInput.files && fileInput.files[0];
    if (!f) return;
    const text = await f.text();
    const entries = parseSrt(text);
    const shortName = (shortNameInput.value || inferShortName(f.name)).trim();
    const perScene = Math.max(1, Math.min(3, parseInt(perSceneSel.value, 10) || 1));

    if (!entries.length) {
      status.innerHTML = '<span class="bad">解析失敗：</span>找不到 SRT 時間軸';
      return;
    }

    current.short_name = shortName;
    current.per_scene = perScene;
    current.scenes = buildScenes(entries, shortName, perScene, f.name);

    selectedScene = null;
    renderTable(current.scenes);
    jsonBtn.disabled = false;
    csvBtn.disabled = false;
    refreshMp3Buttons();
    status.innerHTML = `<span class="ok">完成：</span>${entries.length} 句 → ${current.scenes.length} 張（每張 ${perScene} 句）`;
  });

  jsonBtn.addEventListener("click", ()=>{
    const name = `${current.short_name}_prompts.json`;
    download(name, JSON.stringify(current.scenes, null, 2), "application/json;charset=utf-8");
  });

  csvBtn.addEventListener("click", ()=>{
    const name = `${current.short_name}_prompts.csv`;
    download(name, toCsv(current.scenes), "text/csv;charset=utf-8");
  });

  copyPromptBtn.addEventListener("click", async ()=>{
    const v = promptBox.value.trim();
    if (!v) return;
    try {
      await navigator.clipboard.writeText(v);
      status.innerHTML = `<span class="ok">已複製：</span>photo_prompt`;
    } catch {
      // fallback
      promptBox.focus();
      promptBox.select();
      document.execCommand("copy");
      status.innerHTML = `<span class="ok">已複製：</span>photo_prompt（fallback）`;
    }
  });

  // ===== MP3 產生 =====
  if (mp3LimitInput && mp3LimitLabel) {
    mp3LimitLabel.textContent = mp3LimitInput.value || "10";
    mp3LimitInput.addEventListener("input", ()=>{
      mp3LimitLabel.textContent = mp3LimitInput.value || "10";
    });
  }

  if (mp3SelectedBtn) {
    mp3SelectedBtn.addEventListener("click", async ()=>{
      try{
        if (!selectedScene) return;
        mp3Prog.textContent = "產生中… " + selectedScene.id;
        await ttsToMp3(selectedScene.english, selectedScene.id + ".mp3");
        mp3Prog.textContent = "完成：" + selectedScene.id + ".mp3";
      }catch(e){
        mp3Prog.textContent = "";
        alert((e && e.message) ? e.message : String(e));
      }
    });
  }

  if (mp3AllBtn) {
    mp3AllBtn.addEventListener("click", async ()=>{
      try{
        const limit = Math.max(1, Math.min(9999, parseInt(mp3LimitInput.value,10) || 10));
        const arr = (current.scenes || []).slice(0, limit);
        if (!arr.length) return;
        let i = 0;
        for (const s of arr) {
          i++;
          mp3Prog.textContent = `(${i}/${arr.length}) 產生中… ${s.id}`;
          await ttsToMp3(s.english, s.id + ".mp3");
        }
        mp3Prog.textContent = `完成：已輸出 ${arr.length} 個 MP3`;
      }catch(e){
        mp3Prog.textContent = "";
        alert((e && e.message) ? e.message : String(e));
      }
    });
  }

  // 初始化一次
  refreshMp3Buttons();

})();
</script>
</body>
</html>
