<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SRT 工具（Production 穩定版）</title>
<style>
:root{
  --bg:#0b1220; --panel:#0f1b2e; --text:#e6eefc; --muted:#9db0d1;
  --line:rgba(255,255,255,.08); --accent:#4aa3ff; --good:#2ee59d; --bad:#ff6b6b; --warn:#ffd166;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,#06101f,#070d1a);color:var(--text);
  font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",Arial;}
.topbar{position:sticky;top:0;z-index:5;background:rgba(9,18,32,.82);backdrop-filter: blur(10px);border-bottom:1px solid var(--line);}
.topbar .inner{max-width:1200px;margin:0 auto;padding:14px 16px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.title{font-weight:800}
.hint{color:var(--muted);font-size:13px}
.wrap{max-width:1200px;margin:0 auto;padding:16px;}
.grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px}
@media (max-width: 1024px){.grid{grid-template-columns:1fr}}
.card{background:rgba(15,27,46,.72);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.35);}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
input[type="text"], select, input[type="number"]{
  background:rgba(7,14,26,.7);border:1px solid var(--line);color:var(--text);
  border-radius:12px;padding:10px 12px;outline:none;min-width:220px;
}
input[type="number"]{min-width:120px}
.btn{border:1px solid var(--line);background:rgba(10,18,32,.55);color:var(--text);
  border-radius:14px;padding:10px 14px;cursor:pointer;transition:.15s;font-weight:700}
.btn:hover{transform:translateY(-1px);border-color:rgba(74,163,255,.5)}
.btn.primary{background:rgba(74,163,255,.18);border-color:rgba(74,163,255,.45)}
.btn.good{background:rgba(46,229,157,.14);border-color:rgba(46,229,157,.5)}
.btn.bad{background:rgba(255,107,107,.12);border-color:rgba(255,107,107,.45)}
.btn:disabled{opacity:.45;cursor:not-allowed;transform:none}
.badge{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border-radius:999px;border:1px solid var(--line);
  background:rgba(7,14,26,.55);color:var(--muted);font-size:12px}
.badge b{color:var(--text)}
.statusline{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.status{padding:8px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:var(--muted);background:rgba(7,14,26,.45)}
.status.ok{border-color:rgba(46,229,157,.35);color:#bff6df}
.status.warn{border-color:rgba(255,209,102,.35);color:#ffe6aa}
.status.bad{border-color:rgba(255,107,107,.35);color:#ffc1c1}
.split{height:1px;background:var(--line);margin:12px 0}
table{width:100%;border-collapse:separate;border-spacing:0 8px}
th{text-align:left;color:var(--muted);font-size:12px;font-weight:700;padding:0 10px}
td{background:rgba(7,14,26,.45);border:1px solid var(--line);padding:10px;border-left:none;border-right:none;vertical-align:top}
tr td:first-child{border-left:1px solid var(--line);border-top-left-radius:12px;border-bottom-left-radius:12px}
tr td:last-child{border-right:1px solid var(--line);border-top-right-radius:12px;border-bottom-right-radius:12px}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
textarea{width:100%;min-height:140px;background:rgba(7,14,26,.55);border:1px solid var(--line);color:var(--text);
  border-radius:14px;padding:10px 12px;outline:none}
.small{font-size:12px;color:var(--muted)}
.rightcol .card{position:sticky;top:74px}
@media (max-width:1024px){.rightcol .card{position:static}}
</style>
</head>
<body>
<div class="topbar">
  <div class="inner">
    <div class="title">SRT → 依句生成（Production 穩定版）</div>
    <div class="hint">串行生圖/生MP3｜換 SRT 自動清空參考｜失敗可續跑｜下載 JSON/CSV</div>
  </div>
</div>

<div class="wrap">
  <div class="grid">
    <div class="leftcol">
      <div class="card">
        <div class="row">
          <div>
            <label>1) 上傳 SRT（會自動抓檔名）</label>
            <input id="srtFile" type="file" accept=".srt"/>
          </div>
          <div>
            <label>短檔名（可改）</label>
            <input id="shortName" type="text" placeholder="例如：lion_mouse"/>
            <div class="small"><input id="lockShort" type="checkbox"/> 鎖短檔名（換 SRT 不自動改）</div>
          </div>
          <div>
            <label>每張圖使用幾句英文（1–3）</label>
            <select id="sentPerImg">
              <option value="1">1 句</option>
              <option value="2" selected>2 句</option>
              <option value="3">3 句</option>
            </select>
          </div>
          <button class="btn primary" id="btnParse">2) 解析 + 生成提示詞</button>
          <button class="btn" id="btnJson" disabled>下載 JSON</button>
          <button class="btn" id="btnCsv" disabled>下載 CSV</button>
        </div>

        <div class="split"></div>

        <div class="row">
          <div style="min-width:260px">
            <label>世界觀（可手動切換）</label>
            <select id="world">
              <option value="auto" selected>自動（依內容推測）</option>
              <option value="storybook">童話繪本（溫暖、柔光、故事感）</option>
              <option value="ancient_china">古代中國／歷史故事（禁止現代、禁止西方臉）</option>
              <option value="modern_city">現代城市（寫實、電影感）</option>
              <option value="animals">動物自然（紀實/自然光）</option>
            </select>
          </div>

          <div style="min-width:340px">
            <label>參考圖（1–3 張）：只影響「本片風格」，不鎖角色</label>
            <input id="refFiles" type="file" accept="image/*" multiple/>
            <div class="row" style="margin-top:6px;gap:8px">
              <label class="small" style="margin:0"><input id="lockRefThisSrt" type="checkbox" checked/> 一鍵鎖本片參考（不殘留到下一支）</label>
              <button class="btn bad" id="btnClearRef" type="button">一鍵清空參考</button>
            </div>
            <div id="refInfo" class="small">未選擇參考圖</div>
          </div>
        </div>

        <div class="split"></div>

        <div class="row">
          <div>
            <label>圖片比例</label>
            <select id="imgRatio">
              <option value="16:9">16:9 橫式</option>
              <option value="9:16" selected>9:16 直式</option>
              <option value="1:1">1:1 方形</option>
            </select>
          </div>
          <div>
            <label>批次 N（每次前 N 列）</label>
            <input id="batchN" type="number" min="1" value="10"/>
          </div>
          <button class="btn good" id="btnBatchImg" disabled>批次生圖（前 N 列）</button>
          <button class="btn good" id="btnBatchMp3" disabled>批次生 MP3（前 N 列）</button>
          <button class="btn" id="btnStop" disabled>停止</button>
        </div>

        <div class="statusline" id="statusLine"></div>

        <div class="split"></div>

        <div class="small">
          重要：<br/>
          1) 遇到 400 / moderation_blocked（safety）→ 代表 photo_prompt 觸發安全系統，請把該列 prompt 改更中性再重試。<br/>
          2) 遇到 429 → 代表太快，本版會自動退避重試（串行）。<br/>
          3) 換 SRT 時：自動清空表格 / 生成紀錄 / 參考圖（除非你勾鎖定）。
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <div class="row" style="justify-content:space-between">
          <div class="badge"><b>已選：</b><span id="pickedSrt">—</span></div>
          <div class="badge"><b>已解析：</b><span id="parsedCount">0</span> 列</div>
          <div class="badge"><b>完成：</b><span id="doneCount">0</span></div>
        </div>

        <div style="overflow:auto;margin-top:10px;max-height:520px">
          <table>
            <thead>
              <tr>
                <th style="min-width:240px">ID</th>
                <th style="min-width:160px">時間</th>
                <th>英文句</th>
                <th>photo_prompt（可改）</th>
                <th style="min-width:220px">camera_prompt（可改）</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="rightcol">
      <div class="card">
        <label>快速複製：photo_prompt</label>
        <textarea id="quickPhoto" placeholder="點表格任一列，這裡會顯示 photo_prompt"></textarea>
        <div class="split"></div>
        <label>快速複製：camera_prompt</label>
        <textarea id="quickCam" placeholder="點表格任一列，這裡會顯示 camera_prompt"></textarea>
        <div class="split"></div>
        <div class="small">提示：你可以直接 Ctrl+V 貼到 GPT 生單張圖。</div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  'use strict';

  const IMG_ONE = "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/img-one";
  const TTS_MP3 = "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/tts-mp3";

  const el = (id)=>document.getElementById(id);
  const srtFile = el('srtFile');
  const shortName = el('shortName');
  const lockShort = el('lockShort');
  const sentPerImg = el('sentPerImg');
  const btnParse = el('btnParse');
  const btnJson = el('btnJson');
  const btnCsv = el('btnCsv');
  const world = el('world');
  const refFiles = el('refFiles');
  const lockRefThisSrt = el('lockRefThisSrt');
  const btnClearRef = el('btnClearRef');
  const refInfo = el('refInfo');
  const imgRatio = el('imgRatio');
  const batchN = el('batchN');
  const btnBatchImg = el('btnBatchImg');
  const btnBatchMp3 = el('btnBatchMp3');
  const btnStop = el('btnStop');
  const statusLine = el('statusLine');
  const tbody = el('tbody');
  const pickedSrt = el('pickedSrt');
  const parsedCount = el('parsedCount');
  const doneCount = el('doneCount');
  const quickPhoto = el('quickPhoto');
  const quickCam = el('quickCam');

  let rows = [];
  let currentSrtName = '';
  let currentSrtHash = '';
  let stopFlag = false;
  let refCache = []; // {name,dataUrl}

  const sleep = (ms)=>new Promise(r=>setTimeout(r, ms));
  const clamp = (v,min,max)=>Math.max(min, Math.min(max, v));
  const pad3 = (n)=>String(n).padStart(3,'0');

  function setStatus(items){
    statusLine.innerHTML = '';
    items.forEach(it=>{
      const d=document.createElement('div');
      d.className='status ' + (it.kind||'');
      d.textContent = it.text;
      statusLine.appendChild(d);
    });
  }

  function resetAll(reason){
    rows = [];
    tbody.innerHTML = '';
    parsedCount.textContent = '0';
    doneCount.textContent = '0';
    btnJson.disabled = true;
    btnCsv.disabled = true;
    btnBatchImg.disabled = true;
    btnBatchMp3.disabled = true;
    quickPhoto.value = '';
    quickCam.value = '';
    setStatus([{kind:'warn', text: reason || '已重置'}]);
  }

  function clearRefUI(){
    refFiles.value = '';
    refCache = [];
    refInfo.textContent = '未選擇參考圖';
  }

  function hashLite(str){
    let h=0;
    for (let i=0;i<str.length;i++) h = (h*31 + str.charCodeAt(i)) >>> 0;
    return String(h);
  }

  function inferShortName(filename){
    return filename.replace(/\.srt$/i,'')
      .replace(/\s+/g,'_')
      .replace(/[^a-zA-Z0-9_\-]+/g,'_')
      .slice(0,40) || 'clip';
  }

  function timeToMs(t){
    const m = t.match(/(\d\d):(\d\d):(\d\d)[,.](\d\d\d)/);
    if(!m) return 0;
    const hh=+m[1], mm=+m[2], ss=+m[3], ms=+m[4];
    return (((hh*60+mm)*60)+ss)*1000 + ms;
  }
  function msToSrt(ms){
    const hh = Math.floor(ms/3600000); ms%=3600000;
    const mm = Math.floor(ms/60000); ms%=60000;
    const ss = Math.floor(ms/1000); const mss = ms%1000;
    const z = (n,w)=>String(n).padStart(w,'0');
    return z(hh,2)+':'+z(mm,2)+':'+z(ss,2)+','+z(mss,3);
  }

  function parseSrt(text){
    const blocks = text.replace(/\r/g,'').trim().split(/\n\s*\n/);
    const items = [];
    for(const b of blocks){
      const lines = b.split('\n').filter(x=>x.trim().length>0);
      if(lines.length < 2) continue;
      let timeLine = lines.find(l=>/-->/.test(l));
      if(!timeLine) continue;
      const tm = timeLine.match(/(\d\d:\d\d:\d\d[,.]\d\d\d)\s*-->\s*(\d\d:\d\d:\d\d[,.]\d\d\d)/);
      if(!tm) continue;
      const start = tm[1].replace('.',',');
      const end = tm[2].replace('.',',');
      const idx = lines.indexOf(timeLine);
      const content = lines.slice(idx+1).join(' ').replace(/\s+/g,' ').trim();
      if(!content) continue;
      items.push({start,end,text:content});
    }
    return items;
  }

  function splitSentences(text){
    const parts = text
      .replace(/([.!?])\s+/g, '$1\n')
      .replace(/\s+/g,' ')
      .split('\n')
      .map(s=>s.trim())
      .filter(Boolean);
    return parts.length ? parts : [text.trim()];
  }

  function groupSentences(srtItems, perImg){
    const seq = [];
    for(const it of srtItems){
      const ss = splitSentences(it.text);
      const startMs = timeToMs(it.start);
      const endMs = timeToMs(it.end);
      const dur = Math.max(1, endMs-startMs);
      for(let i=0;i<ss.length;i++){
        const a = startMs + Math.floor(dur*(i/ss.length));
        const b = startMs + Math.floor(dur*((i+1)/ss.length));
        seq.push({startMs:a, endMs:Math.max(a+1,b), text:ss[i]});
      }
    }
    const groups=[];
    for(let i=0;i<seq.length;i+=perImg){
      const chunk = seq.slice(i,i+perImg);
      if(!chunk.length) break;
      groups.push({
        start: msToSrt(chunk[0].startMs),
        end: msToSrt(chunk[chunk.length-1].endMs),
        text: chunk.map(x=>x.text).join(' ')
      });
    }
    return groups;
  }

  function buildStyle(key){
    if(key === 'ancient_china'){
      return "Ancient China historical setting, Chinese faces only, traditional clothing, no modern objects, no western facial features, realistic illustration, consistent era.";
    }
    if(key === 'modern_city'){
      return "Modern city, cinematic realistic look, natural lighting, contemporary environment.";
    }
    if(key === 'animals'){
      return "Wildlife nature documentary feel, natural lighting, realistic animals.";
    }
    return "Storybook realism with a timeless feel, warm soft light, painterly illustration, consistent style.";
  }

  function buildCamera(text){
    const t = (text||'').toLowerCase();
    if(t.includes('said')||t.includes('asked')||t.includes('told')){
      return "slow push-in, 35mm lens, medium shot, soft focus pull, natural lighting.";
    }
    return "slow push-in, 35mm lens, medium-wide to medium shot, soft focus pull, natural lighting.";
  }

  function escapeCsv(v){
    const s = String(v ?? '');
    if(/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  }

  function downloadBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download=filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{URL.revokeObjectURL(url); a.remove();}, 600);
  }

  function sizeFromRatio(r){
    if(r==='9:16') return '1024x1792';
    if(r==='16:9') return '1792x1024';
    return '1024x1024';
  }

  function postJson(url, payload){
    return fetch(url,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
  }

  function renderTable(){
    tbody.innerHTML='';
    for(const r of rows){
      const tr=document.createElement('tr');

      const tdId=document.createElement('td'); tdId.className='mono'; tdId.textContent=r.id;
      const tdTime=document.createElement('td'); tdTime.className='mono'; tdTime.textContent=r.start+' → '+r.end;
      const tdText=document.createElement('td'); tdText.textContent=r.text;

      const tdPhoto=document.createElement('td');
      const ta1=document.createElement('textarea'); ta1.style.minHeight='88px'; ta1.value=r.photo_prompt||'';
      ta1.addEventListener('input', ()=>{r.photo_prompt=ta1.value;});
      tdPhoto.appendChild(ta1);

      const tdCam=document.createElement('td');
      const ta2=document.createElement('textarea'); ta2.style.minHeight='88px'; ta2.value=r.camera_prompt||'';
      ta2.addEventListener('input', ()=>{r.camera_prompt=ta2.value;});
      tdCam.appendChild(ta2);

      tr.appendChild(tdId); tr.appendChild(tdTime); tr.appendChild(tdText); tr.appendChild(tdPhoto); tr.appendChild(tdCam);

      tr.addEventListener('click', (e)=>{
        if(e.target && (e.target.tagName==='TEXTAREA' || e.target.tagName==='INPUT')) return;
        quickPhoto.value = r.photo_prompt||'';
        quickCam.value = r.camera_prompt||'';
      });

      tbody.appendChild(tr);
    }
    parsedCount.textContent = String(rows.length);
  }

  function updateDoneCount(){
    const done = rows.filter(r=>r._imgDone || r._mp3Done).length;
    doneCount.textContent = String(done);
  }

  async function filesToDataUrls(fileList, max){
    const files = Array.from(fileList || []).slice(0, max);
    const out=[];
    for(const f of files){
      const dataUrl = await new Promise((resolve,reject)=>{
        const fr=new FileReader();
        fr.onload=()=>resolve(String(fr.result||''));
        fr.onerror=()=>reject(new Error('read file error'));
        fr.readAsDataURL(f);
      });
      out.push({name:f.name, dataUrl});
    }
    return out;
  }

  async function generateOneImage(row, refs){
    const payload = {prompt: row.photo_prompt, size: sizeFromRatio(imgRatio.value), ref_images: (refs||[]).map(x=>x.dataUrl)};
    let attempt=0;
    while(true){
      if(stopFlag) throw new Error('stopped');
      attempt++;
      const resp = await postJson(IMG_ONE, payload);
      if(resp.status===429 || resp.status===503){
        const wait = clamp(800*Math.pow(2,attempt-1), 800, 8000);
        setStatus([{kind:'warn', text:'生圖 429/503，'+Math.round(wait/1000)+'s 後重試… ('+attempt+')'}]);
        await sleep(wait);
        continue;
      }
      if(!resp.ok){
        const t = await resp.text().catch(()=> '');
        throw new Error('生圖失敗：'+resp.status+'\n'+t);
      }
      return await resp.blob();
    }
  }

  async function generateOneMp3(row){
    const payload = {text: row.text, voice: "en-US-AriaNeural", rate: 0, pitch: 0, id: row.id};
    let attempt=0;
    while(true){
      if(stopFlag) throw new Error('stopped');
      attempt++;
      const resp = await postJson(TTS_MP3, payload);
      if(resp.status===429 || resp.status===503){
        const wait = clamp(800*Math.pow(2,attempt-1), 800, 8000);
        setStatus([{kind:'warn', text:'TTS 429/503，'+Math.round(wait/1000)+'s 後重試… ('+attempt+')'}]);
        await sleep(wait);
        continue;
      }
      if(!resp.ok){
        const t = await resp.text().catch(()=> '');
        throw new Error('生 MP3 失敗：'+resp.status+'\n'+t);
      }
      return await resp.blob();
    }
  }

  // events
  srtFile.addEventListener('change', async ()=>{
    const f = srtFile.files && srtFile.files[0];
    if(!f) return;
    pickedSrt.textContent = f.name;
    const text = await f.text();
    const h = hashLite(text);
    if(h !== currentSrtHash){
      currentSrtHash = h;
      currentSrtName = f.name;
      resetAll('換 SRT：已自動清空（避免殘留）');
      if(!lockShort.checked) shortName.value = inferShortName(f.name);
      if(!lockRefThisSrt.checked) clearRefUI();
    }
  });

  refFiles.addEventListener('change', async ()=>{
    try{
      refCache = await filesToDataUrls(refFiles.files, 3);
      refInfo.textContent = refCache.length ? ('已選擇 '+refCache.length+' 張：'+refCache.map(x=>x.name).join('、')) : '未選擇參考圖';
    }catch(e){
      console.error(e);
      clearRefUI();
      alert('參考圖讀取失敗');
    }
  });

  btnClearRef.addEventListener('click', ()=>{
    clearRefUI();
    setStatus([{kind:'ok', text:'已清空參考圖'}]);
  });

  btnParse.addEventListener('click', async ()=>{
    const f = srtFile.files && srtFile.files[0];
    if(!f){ alert('請先選擇 SRT 檔'); return; }
    try{
      btnParse.disabled=true;
      setStatus([{kind:'warn', text:'解析中…'}]);

      const srtText = await f.text();
      const items = parseSrt(srtText);
      if(!items.length) throw new Error('解析不到字幕內容（SRT 格式不符？）');

      const per = clamp(parseInt(sentPerImg.value,10)||2, 1, 3);
      const grouped = groupSentences(items, per);

      const sn = (shortName.value || inferShortName(f.name)).trim() || 'clip';
      const style = buildStyle(world.value==='auto' ? 'storybook' : world.value);

      rows = grouped.map((g, idx)=>{
        const id = sn + '_' + pad3(idx+1);
        const photo = style + "\nScene: " + g.text + "\nKeep consistent era and mood.";
        return {id, start:g.start, end:g.end, text:g.text, photo_prompt:photo, camera_prompt:buildCamera(g.text), _imgDone:false, _mp3Done:false};
      });

      renderTable();
      btnJson.disabled=false; btnCsv.disabled=false; btnBatchImg.disabled=false; btnBatchMp3.disabled=false;
      setStatus([{kind:'ok', text:'解析完成：'+rows.length+' 列'},{kind:'warn', text:'建議先試前 5～10 張確認風格'}]);
    }catch(e){
      console.error(e);
      alert('解析失敗：' + (e && e.message ? e.message : e));
      setStatus([{kind:'bad', text:'解析失敗（看 Console）'}]);
    }finally{
      btnParse.disabled=false;
    }
  });

  btnJson.addEventListener('click', ()=>{
    const data = {
      meta:{
        source_srt: currentSrtName,
        short_name: shortName.value || '',
        sentences_per_image: parseInt(sentPerImg.value,10)||2,
        world: world.value,
        ratio: imgRatio.value,
        reference_images: refCache.map(x=>x.name)
      },
      rows: rows.map(r=>({id:r.id,start:r.start,end:r.end,text:r.text,photo_prompt:r.photo_prompt,camera_prompt:r.camera_prompt}))
    };
    downloadBlob(new Blob([JSON.stringify(data,null,2)],{type:'application/json'}), (shortName.value||'clip')+'.json');
  });

  btnCsv.addEventListener('click', ()=>{
    const head = ['id','start','end','text','photo_prompt','camera_prompt'];
    const lines=[head.join(',')];
    for(const r of rows){
      lines.push([escapeCsv(r.id),escapeCsv(r.start),escapeCsv(r.end),escapeCsv(r.text),escapeCsv(r.photo_prompt),escapeCsv(r.camera_prompt)].join(','));
    }
    downloadBlob(new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8'}), (shortName.value||'clip')+'.csv');
  });

  btnStop.addEventListener('click', ()=>{
    stopFlag = true;
    btnStop.disabled = true;
    setStatus([{kind:'warn', text:'已停止（可再次點批次繼續）'}]);
  });

  async function runBatch(kind){
    if(!rows.length){ alert('請先解析 SRT'); return; }
    stopFlag=false;
    btnStop.disabled=false;

    const N = clamp(parseInt(batchN.value,10)||10, 1, rows.length);
    const subset = rows.slice(0, N);
    const refs = refCache.slice(0);

    for(let i=0;i<subset.length;i++){
      if(stopFlag) break;
      const r = subset[i];
      try{
        setStatus([{kind:'warn', text:(kind==='img'?'批次生圖':'批次生MP3')+'：'+(i+1)+'/'+N+'  '+r.id}]);

        if(kind==='img'){
          if(r._imgDone) continue;
          const blob = await generateOneImage(r, refs);
          downloadBlob(blob, r.id+'.png');
          r._imgDone=true;
        }else{
          if(r._mp3Done) continue;
          const blob = await generateOneMp3(r);
          downloadBlob(blob, r.id+'.mp3');
          r._mp3Done=true;
        }

        updateDoneCount();
        await sleep(350);
      }catch(e){
        console.error(e);
        alert((e && e.message) ? e.message : String(e));
        setStatus([{kind:'bad', text:'批次中斷（看 Console / alert）'}]);
        break;
      }
    }
    btnStop.disabled=true;
    if(!stopFlag) setStatus([{kind:'ok', text:'批次完成'}]);
  }

  btnBatchImg.addEventListener('click', ()=>runBatch('img'));
  btnBatchMp3.addEventListener('click', ()=>runBatch('mp3'));

  setStatus([{kind:'', text:'就緒：先上傳 SRT → 解析 → 批次生圖/生MP3'}]);
})();
</script>
</body>
</html>
