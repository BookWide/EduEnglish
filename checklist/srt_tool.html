<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>SRT 工具｜生圖提示辭 / 運鏡提示辭 / MP3（TTS）</title>
<style>
  :root{
    --bg:#0b1220;--panel:#0f1b33;--panel2:#0c172d;--text:#e8eefc;--muted:#9fb1d1;
    --line:#1b2b4b;--btn:#1f6feb;--btn2:#12264d;--danger:#ff5d5d;--ok:#22c55e;
    --radius:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC,Arial; background:var(--bg); color:var(--text);}
  header{padding:14px 16px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#0e1a31,#0b1220)}
  header .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  h1{margin:0;font-size:16px;font-weight:700;letter-spacing:.2px}
  .hint{color:var(--muted);font-size:12px}
  .wrap{padding:16px;max-width:1200px;margin:0 auto}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:14px}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:980px){ .grid{grid-template-columns:1.1fr .9fr} }
  label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
  input[type="text"], input[type="number"], select, textarea{
    width:100%;background:var(--panel2);border:1px solid var(--line);color:var(--text);
    border-radius:12px;padding:10px 12px;outline:none;
  }
  textarea{min-height:160px;resize:vertical}
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
  .controls .field{min-width:180px;flex:1}
  .controls .field.small{min-width:140px;flex:0 0 140px}
  .controls .field.mid{min-width:220px;flex:1.2}
  .btn{
    border:1px solid transparent;border-radius:12px;padding:10px 14px;font-weight:700;
    background:var(--btn);color:white;cursor:pointer;user-select:none;
  }
  .btn.secondary{background:var(--btn2);border-color:var(--line);color:var(--text)}
  .btn:disabled{opacity:.45;cursor:not-allowed}
  .status{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{font-size:12px;color:var(--muted);border:1px solid var(--line);background:rgba(0,0,0,.15);padding:6px 10px;border-radius:999px}
  .pill.ok{border-color:rgba(34,197,94,.35);color:#bbf7d0}
  .pill.bad{border-color:rgba(255,93,93,.35);color:#fecaca}
  table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  th,td{border-bottom:1px solid var(--line);padding:10px 10px;vertical-align:top}
  th{background:rgba(255,255,255,.03);color:var(--muted);font-size:12px;text-align:left}
  td{font-size:13px;line-height:1.25}
  tr:hover{background:rgba(31,111,235,.08)}
  tr.selected{background:rgba(34,197,94,.10)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .twoCol{display:grid;grid-template-columns:1fr;gap:16px}
  
  .footerNote{color:var(--muted);font-size:12px;line-height:1.5}
  .copyRow{display:flex;gap:10px;align-items:stretch;flex-direction:column}
  .copyRow button{white-space:nowrap;align-self:flex-end}
  .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
    background:rgba(15,27,51,.96);border:1px solid var(--line);padding:10px 12px;border-radius:999px;
    color:var(--text);font-size:13px;opacity:0;pointer-events:none;transition:opacity .18s ease;
  }
  .toast.show{opacity:1}
</style>
</head>
<body>
<header>
  <div class="row">
    <h1>SRT → 依句生成：生圖提示辭 / 運鏡提示辭（可下載 JSON / CSV）＋ MP3（TTS）</h1>
    <span class="pill mono">規格：短檔名 + 序號（例：lion_mouse_001）</span>
  </div>
  <div class="hint">提示：先解析生成，再點表格任一列 → 按哪列就處理哪列（不自動選取/不自動填入）。</div>
</header>

<div class="wrap">
  <div class="grid">
    <div class="card">
      <div class="controls">
        <div class="field mid">
          <label>1) 上傳 SRT（會自動識別檔名）</label>
          <input id="srtFile" type="file" accept=".srt,.txt"/>
        </div>
        <div class="field">
          <label>短檔名（可改）</label>
          <input id="shortName" type="text" placeholder="例如：lion_mouse"/>
        </div>
        <div class="field small">
          <label>每張圖使用幾句英文（1–3）</label>
          <select id="sentPerSlide">
            <option value="1">1 句</option>
            <option value="2" selected>2 句</option>
            <option value="3">3 句</option>
          </select>
        </div>
        <button id="btnParse" class="btn">2) 解析 + 生成提示辭</button>
        <button id="btnJson" class="btn secondary" disabled>下載 JSON</button>
        <button id="btnCsv" class="btn secondary" disabled>下載 CSV</button>
      </div>
<!-- BW v1: Era + Reference images (local only) -->
<div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
  <div style="min-width:220px; flex:1;">
    <div style="font-size:12px; opacity:.9; margin-bottom:6px;">世界觀（可手動切換）</div>
    <select id="eraSelect" class="bw-input" style="width:100%;">
      <option value="auto" selected>自動（依內容推測）</option>
      <option value="historical_ancient_china">古代中國／歷史敘事（禁止現代）</option>
      <option value="modern_realistic">現代寫實（禁止古代）</option>
      <option value="storybook_fantasy">童話寫實（中性、不現代科技）</option>
    </select>
    <div style="font-size:11px; opacity:.65; margin-top:6px;">提示：若你有混合素材，請改手動選。</div>
  </div>

  <div style="min-width:260px; flex:1.2;">
    <div style="font-size:12px; opacity:.9; margin-bottom:6px;">參考圖（1–3 張，用來鎖風格／年代）</div>
<div style="margin-top:8px;">
  <div style="font-size:12px; opacity:.9; margin-bottom:4px;">Reference 使用模式</div>
  <select id="refModeSelect" class="bw-input" style="width:100%;">
    <option value="global">Global（全片共用）</option>
    <option value="beats" selected>By Beats（起承轉合自動分配）</option>
  </select>
</div>

    <input id="refImages" type="file" accept="image/*" multiple class="bw-input" style="width:100%; padding:8px;" />
    <div id="refImagesHint" style="font-size:11px; opacity:.75; margin-top:6px;">未選擇參考圖</div>
  </div>
</div>


      <div style="height:10px"></div>

      <div class="controls">
        <div class="field mid">
          <label>MP3（TTS）— 走 Supabase Edge Function（tts-mp3 / Azure）</label>
          <div class="hint">不需要輸入 OpenAI Key。會用你已存在的 tts-mp3：/functions/v1/tts-mp3</div>
        </div>
        <div class="field">
          <label>Voice（Azure）</label>
          <select id="ttsVoice">
            <option value="en-US-AnaNeural">en-US-AnaNeural</option>
            <option value="en-US-AriaNeural" selected>en-US-AriaNeural（女）</option>
            <option value="en-US-JennyNeural">en-US-JennyNeural（女）</option>
            <option value="en-US-GuyNeural">en-US-GuyNeural（男）</option>
            <option value="en-AU-NatashaNeural">en-AU-NatashaNeural</option>
          </select>
        </div>
        <div class="field small">
          <label>rate（例：0% / -10% / +10%）</label>
          <input id="ttsRate" type="text" placeholder="0%"/>
        </div>
        <div class="field small">
          <label>pitch（例：0% / -5% / +5%）</label>
          <input id="ttsPitch" type="text" placeholder="0%"/>
        </div>

        <div class="field small">
          <label>圖片比例（對齊 CapCut）</label>
          <select id="imgRatio">
            <option value="9:16" selected>9:16 直式（Shorts / Reels）</option>
            <option value="16:9">16:9 橫式（YouTube）</option>
            <option value="1:1">1:1 方形</option>
          </select>
        </div>
        <button id="btnMp3One" class="btn secondary" disabled>生 MP3（選取列）</button>
        
        <button id="btnImgOne" class="btn secondary" disabled>生圖（選取列）</button>
<div class="field small">
          <label>批次 N</label>
          <input id="batchN" type="number" min="1" step="1" value="10"/>
        </div>
        <button id="btnMp3Batch" class="btn secondary" disabled>批次生 MP3（前 N 列）</button>
      
        <button id="btnImgBatch" class="btn secondary" disabled>批次生圖（前 N 列）</button>
</div>

      <div style="height:12px"></div>

      <div class="status">
        <span id="pillFile" class="pill">未選擇檔案</span>
        <span id="pillRows" class="pill">未解析</span>
        <span id="pillSel" class="pill">未選取列</span>
        <span class="pill mono">完成：<span id="statSents">0</span> 句 → <span id="statSlides">0</span> 張</span>
      </div>

      <div style="height:12px"></div>

      <div style="overflow:auto;max-height:460px;border-radius:12px">
        <table id="tbl">
          <thead>
            <tr>
              <th style="width:160px">ID</th>
              <th style="width:160px">時間</th>
              <th>英文句（對齊）</th>
              <th>生圖提示辭（photo_prompt）</th>
              <th>運鏡提示辭（camera_prompt）</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="5" class="footerNote">尚未解析。請先上傳 SRT → 按「解析 + 生成提示辭」。</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="twoCol">
        <div>
          <label>快速複製：單張生圖提示辭（photo_prompt）</label>
          <div class="copyRow">
            <textarea id="quickPhoto" placeholder="點表格任一列，這裡就會出現 photo_prompt"></textarea>
            <button id="btnCopyPhoto" class="btn secondary" disabled>複製</button>
          </div>
          <div class="footerNote">目的：你可以直接 Ctrl+V 貼到 GPT 生單張圖。ID 在表格第一欄。</div>
        </div>
        <div>
          <label>快速複製：單張運鏡提示辭（camera_prompt）</label>
          <div class="copyRow">
            <textarea id="quickCam" placeholder="點表格任一列，這裡就會出現 camera_prompt"></textarea>
            <button id="btnCopyCam" class="btn secondary" disabled>複製</button>
          </div>
          <div class="footerNote">運鏡可貼到你後續的動畫/剪輯工具或當作提示詞。</div>
        </div>
      </div>

      <div style="height:12px"></div>
      <div class="footerNote">
        <b>注意：</b><br/>
        1) MP3 由你現有的 <span class="mono">tts-mp3</span> (Azure) 產生，檔名固定 <span class="mono">ID.mp3</span>。<br/>
        2) 批次下載會逐檔下載（瀏覽器可能會擋多檔下載，請允許）。<br/>
        3) 若你看到舊錯誤，請用 <span class="mono">Ctrl+F5</span> 強制重整（或清快取）。
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast">已複製</div>

<script>
(() => {
  "use strict";

  const SUPA_TTS_MP3_URL = "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/tts-mp3";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";


  const IMG_ONE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/img-one";
  const el = (id) => document.getElementById(id);

  const srtFile = el("srtFile");
  const shortName = el("shortName");
  const sentPerSlide = el("sentPerSlide");
  const btnParse = el("btnParse");
  const btnJson = el("btnJson");
  const btnCsv = el("btnCsv");

  const ttsVoice = el("ttsVoice");
  const ttsRate  = el("ttsRate");
  const ttsPitch = el("ttsPitch");
  const btnMp3One = el("btnMp3One");
  const btnImgOne = el("btnImgOne");
  const btnMp3Batch = el("btnMp3Batch");
  const btnImgBatch = el("btnImgBatch");
  const batchN = el("batchN");



  const imgRatio = el("imgRatio");
  const IMG_SIZE_BY_RATIO = {
    "9:16": "1024x1536",
    "16:9": "1536x1024",
    "1:1": "1024x1024"
  };
  let imgSize = IMG_SIZE_BY_RATIO[imgRatio?.value] || "1024x1024";
  if (imgRatio){
    imgRatio.addEventListener("change", () => {
      imgSize = IMG_SIZE_BY_RATIO[imgRatio.value] || "1024x1024";
    });
  }

  const pillFile = el("pillFile");
  const pillRows = el("pillRows");
  const pillSel = el("pillSel");
  const statSents = el("statSents");
  const statSlides = el("statSlides");

  const tbody = el("tbody");

  const quickPhoto = el("quickPhoto");
  const quickCam = el("quickCam");
  const btnCopyPhoto = el("btnCopyPhoto");
  const btnCopyCam = el("btnCopyCam");
  const toast = el("toast");

  /** @type {Array<{id:string,start:string,end:string,english:string,photo_prompt:string,camera_prompt:string,source_filename:string}>} */
  let rows = [];
  /** @type {any|null} */
  let selectedRow = null;
  let selectedRowIndex = 0;

  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(()=>toast.classList.remove("show"), 900);
  }

  function sanitizeShortName(name){
    return (name || "")
      .trim()
      .toLowerCase()
      .replace(/\.[a-z0-9]+$/i, "")
      .replace(/[^a-z0-9]+/g, "_")
      .replace(/^_+|_+$/g, "")
      .slice(0, 40) || "srt";
  }

  function pad3(n){
    const s = String(n);
    if (s.length >= 3) return s;
    return ("000" + s).slice(-3);
  }

  function downloadBlob(blob, filename){
    const a = document.createElement("a");
    const url = URL.createObjectURL(blob);
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
  }

  function downloadText(text, filename, mime="application/json"){
    downloadBlob(new Blob([text], {type:mime}), filename);
  }

  function csvEscape(v){
    const s = String(v ?? "");
    if (/[",\n\r]/.test(s)) return '"' + s.replaceAll('"','""') + '"';
    return s;
  }

  // --- SRT parsing ---
  function parseSrt(srtText){
    const text = (srtText || "").replace(/\r/g, "");
    const blocks = text.split(/\n\n+/).map(b=>b.trim()).filter(Boolean);
    const items = [];
    for (const b of blocks){
      const lines = b.split("\n").map(x=>x.trim());
      if (lines.length < 2) continue;

      // Usually: index line, time line, text lines...
      let timeLine = "";
      let startIdx = 0;
      if (/^\d+$/.test(lines[0])) { // has index
        timeLine = lines[1] || "";
        startIdx = 2;
      } else {
        timeLine = lines[0] || "";
        startIdx = 1;
      }

      const m = timeLine.match(/(\d\d:\d\d:\d\d[,\.]\d\d\d)\s*-->\s*(\d\d:\d\d:\d\d[,\.]\d\d\d)/);
      if (!m) continue;

      const start = m[1].replace(".", ",");
      const end = m[2].replace(".", ",");
      const caption = lines.slice(startIdx).join(" ").replace(/\s+/g," ").trim();
      if (!caption) continue;

      // split into sentences (naive, but stable)
      const sents = splitIntoSentences(caption);
      for (const sent of sents){
        const clean = sent.trim();
        if (clean) items.push({start, end, text: clean});
      }
    }
    return items;
  }

  function splitIntoSentences(s){
    // Keep punctuation as sentence end; also handle "..." and abbreviations loosely
    const t = s
      .replace(/\s+/g, " ")
      .trim();
    if (!t) return [];
    const parts = [];
    let buf = "";
    for (let i=0;i<t.length;i++){
      const ch = t[i];
      buf += ch;
      if (/[.!?。！？]/.test(ch)){
        // end sentence
        const next = t[i+1] || "";
        if (next === '"' || next === "'" || next === "”" || next === "’") { /* let it attach */ }
        parts.push(buf.trim());
        buf = "";
      }
    }
    if (buf.trim()) parts.push(buf.trim());
    // If no punctuation, return whole string
    if (parts.length===0) return [t];
    // merge very tiny fragments
    const merged = [];
    for (const p of parts){
      if (merged.length && p.length < 4){
        merged[merged.length-1] += " " + p;
      } else merged.push(p);
    }
    return merged;
  }

  
// === BW v1: Era lock + reference images (local only) ===
function bwInferEraFromText(text) {
  const t = (text || "").toLowerCase();
  // Storybook / fable hints
  const storyHints = ["lion","mouse","forest","fable","once upon a time","storybook","fairy"];
  for (const k of storyHints){
    if (t.includes(k)) return "storybook_fantasy";
  }
  const ancientHints = [
    "三国","三國","茅庐","茅廬","刘备","劉備","诸葛","諸葛","关羽","關羽","张飞","張飛",
    "dynasty","ancient","kingdom","warlord","strategist","thatched","cottage","imperial","court"
  ];
  for (const k of ancientHints) {
    if (t.includes(String(k).toLowerCase())) return "historical_ancient_china";
  }
  // default: storybook is safer for most educational stories (avoids modern/ancient conflicts)
  return "storybook_fantasy";
}

function bwGetEraPrompt(eraKey) {
  const key = eraKey || "auto";
  if (key === "historical_ancient_china") {
    return [
      "Pre-modern historical setting, ancient China inspired world",
      "No modern technology, no modern buildings, no contemporary clothing",
      "No modern vehicles, no modern signage, no smartphones"
    ];
  }
  if (key === "modern_realistic") {
    return [
      "Modern contemporary setting, present-day environment",
      "No historical or ancient elements, no period costumes",
      "No ancient architecture, no traditional robes"
    ];
  }
  if (key === "storybook_fantasy") {
    return [
      "Storybook realism with a timeless feel",
      "No modern technology, no contemporary branding",
      "Keep era consistent across all images"
    ];
  }
  return [];
}

function bwGetRefLine() {
  const inp = document.getElementById("refImages");
  const hint = document.getElementById("refImagesHint");
  if (!inp || !inp.files) return "";
  const files = Array.from(inp.files || []);
  if (hint) {
    hint.textContent = files.length ? (`已選擇 ${files.length} 張參考圖：` + files.map(f => f.name).join("、")) : "未選擇參考圖";
  }
  if (!files.length) return "";
  return "Match the provided reference images: same era, clothing, faces, color grade, and cinematography (attach the reference images when generating).";
}
// === /BW v1 ===


// === BW v2: By Beats reference assignment ===
function bwGetBeatRefLine(rowIndex, totalRows) {
  const inp = document.getElementById("refImages");
  const mode = document.getElementById("refModeSelect")?.value || "global";
  if (!inp || !inp.files || !inp.files.length) return "";
  const files = Array.from(inp.files);
  if (mode === "global") {
    return "Match all reference images consistently across all scenes.";
  }
  const n = files.length;
  if (n === 1) return "Match the single reference image across the full story.";
  const segment = Math.floor((rowIndex / totalRows) * n);
  const refIndex = Math.min(segment, n - 1);
  return `Match reference image ${refIndex+1} for this story beat (keep era, faces, clothing, color grade consistent).`;
}
// === /BW v2 ===
function makePhotoPrompt(english, titleHint, idx, index = 0, totalRows = 1){

  // --- Stable commercial prompt: lock style, lighting, framing across the whole story ---
  const GLOBAL_STYLE = [
  "cinematic still photo",
  "storybook realism",
  "soft natural lighting",
  "warm golden tone",
  "consistent character design",
  "same lion: large golden mane, calm noble face, amber eyes",
  "same mouse: tiny brown mouse, round ears, small bright eyes",
  "same forest environment continuity",
  "medium shot",
  "stable framing",
  "natural color grading",
  "no dramatic lighting change",
  "no color shift",
  "NO text, NO subtitles, NO captions, NO words, NO letters, NO watermark"
].join(", ");

  const eraSel = document.getElementById("eraSelect");
  const eraMode = (eraSel && eraSel.value) ? eraSel.value : "auto";
  const inferText = `${(document.getElementById("shortName")?.value||"")} ${(window.__srtFileName||"")} ${(titleHint||"")}`;
  const eraKey = (eraMode === "auto") ? bwInferEraFromText(inferText) : eraMode;
  const eraLines = bwGetEraPrompt(eraKey);

  // Reference images are optional. Keep them gentle (do not conflict with style).
  const refLine = bwGetRefLine();
  const beatRefLine = bwGetBeatRefLine(index, totalRows);

  return [
    ...eraLines,
    ...(refLine ? [refLine] : []),
    ...(beatRefLine ? [beatRefLine] : []),
    (titleHint ? (titleHint + " — ") : "") + GLOBAL_STYLE,
    `Visualize this exact moment: "${english}"`,
    "Keep characters consistent with previous scenes. Do not change style."
  ].join(", ");
}

  function makeCameraPrompt(english, idx){
    const moves = [
      "slow push-in",
      "gentle lateral slide",
      "static tripod with subtle breathing",
      "slow pull-back reveal",
      "soft handheld micro-movement"
    ];
    const lenses = ["35mm", "50mm", "24mm wide", "85mm portrait", "70mm medium tele"];
    const pick = (arr) => arr[Math.abs(Number(idx||0)) % arr.length];

    return [
      `${pick(moves)}, ${pick(lenses)} lens`,
      `medium-wide to medium shot, natural lighting, soft focus pull`,
      `match pacing to the line: "${english}"`
    ].join(", ");
  }

  function refreshButtons(english){
    // A stable camera direction template
    return [
      `slow push-in, medium-wide to medium shot, gentle handheld stabilization`,
      `match pacing to the line: "${english}"`,
      `soft focus pull, natural lighting`
    ].join(", ");
  }

  function refreshButtons(){
    const hasRows = rows.length > 0;
    btnJson.disabled = !hasRows;
    btnCsv.disabled = !hasRows;

    const hasSel = !!selectedRow;
    btnMp3One.disabled = !hasSel;

    btnImgOne.disabled = !hasSel;

    btnMp3Batch.disabled = !hasRows;
    btnImgBatch.disabled = !hasRows;

    btnCopyPhoto.disabled = !hasSel;
    btnCopyCam.disabled = !hasSel;

    pillRows.textContent = hasRows ? `已解析：${rows.length} 列` : "未解析";
    pillRows.className = "pill" + (hasRows ? " ok" : "");
    pillSel.textContent = hasSel ? `已選取：${selectedRow.id}` : "未選取列";
    pillSel.className = "pill" + (hasSel ? " ok" : "");
  }

  function renderTable(){
    tbody.innerHTML = "";
    if (!rows.length){
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 5;
      td.className = "footerNote";
      td.textContent = "尚未解析。請先上傳 SRT → 按「解析 + 生成提示辭」。";
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    for (const r of rows){
      const tr = document.createElement("tr");
      tr.dataset.id = r.id;

      const tdId = document.createElement("td");
      tdId.className = "mono";
      tdId.textContent = r.id;

      const tdTime = document.createElement("td");
      tdTime.className = "mono";
      tdTime.textContent = `${r.start} → ${r.end}`;

      const tdEn = document.createElement("td");
      tdEn.textContent = r.english;

      const tdP = document.createElement("td");
      tdP.textContent = r.photo_prompt;

      const tdC = document.createElement("td");
      tdC.textContent = r.camera_prompt;

      tr.append(tdId, tdTime, tdEn, tdP, tdC);

      tr.addEventListener("click", () => {
        selectedRow = r;
        // highlight
        for (const rowEl of tbody.querySelectorAll("tr")){
          rowEl.classList.toggle("selected", rowEl.dataset.id === r.id);
        }
        quickPhoto.value = r.photo_prompt;
        quickCam.value = r.camera_prompt;
        refreshButtons();
      });

      tbody.appendChild(tr);
    }
    // 不自動選取：使用者點哪一列才選哪一列
    selectedRow = null;
    quickPhoto.value = "";
    quickCam.value = "";
    refreshButtons();
  }

  async function readFileAsText(file){
    return new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onload = () => resolve(String(fr.result || ""));
      fr.onerror = reject;
      fr.readAsText(file);
    });
  }

  // Events
  srtFile.addEventListener("change", () => {
    const f = srtFile.files && srtFile.files[0];
    if (!f){
      pillFile.textContent = "未選擇檔案";
      pillFile.className = "pill";
      return;
    }
    const base = sanitizeShortName(f.name);
    if (!shortName.value.trim()) shortName.value = base;
    pillFile.textContent = `已選：${f.name}`;
    pillFile.className = "pill ok";
  });

  btnParse.addEventListener("click", async () => {
    const f = srtFile.files && srtFile.files[0];
    if (!f){
      alert("請先選擇 .srt 檔");
      return;
    }
    btnParse.disabled = true;
    btnParse.textContent = "解析中…";
    try{
      const txt = await readFileAsText(f);
      const sents = parseSrt(txt);
      const per = Math.max(1, Math.min(3, Number(sentPerSlide.value || 1)));
      const sname = sanitizeShortName(shortName.value || f.name);
      const titleHint = sname.replaceAll("_"," ").trim();

      rows = [];
      selectedRow = null;

      statSents.textContent = String(sents.length);

      const totalSlides = Math.ceil(sents.length / per);
      statSlides.textContent = String(totalSlides);

      for (let i=0;i<totalSlides;i++){
        const chunk = sents.slice(i*per, i*per + per);
        if (!chunk.length) continue;

        const english = chunk.map(x=>x.text).join(" ").replace(/\s+/g," ").trim();
        const start = chunk[0].start;
        const end = chunk[chunk.length-1].end;

        const id = `${sname}_${pad3(i+1)}`;
        const photo_prompt = makePhotoPrompt(english, titleHint, i, i, totalSlides);
        const camera_prompt = makeCameraPrompt(english, i);

        rows.push({
          id, start, end, english,
          photo_prompt, camera_prompt,
          source_filename: f.name
        });
      }

      renderTable();
      refreshButtons();
    }catch(e){
      console.error(e);
      alert("解析失敗：請看 Console");
    }finally{
      btnParse.disabled = false;
      btnParse.textContent = "2) 解析 + 生成提示辭";
    }
  });

  btnJson.addEventListener("click", () => {
    if (!rows.length) return;
    const payload = rows;
    const name = sanitizeShortName(shortName.value || "srt");
    downloadText(JSON.stringify(payload, null, 2), `${name}_prompts.json`, "application/json");
  });

  btnCsv.addEventListener("click", () => {
    if (!rows.length) return;
    const name = sanitizeShortName(shortName.value || "srt");
    const headers = ["id","start","end","english","photo_prompt","camera_prompt","source_filename"];
    const lines = [headers.join(",")];
    for (const r of rows){
      lines.push(headers.map(h=>csvEscape(r[h])).join(","));
    }
    downloadText(lines.join("\n"), `${name}_prompts.csv`, "text/csv;charset=utf-8");
  });

  btnCopyPhoto.addEventListener("click", async () => {
    if (!selectedRow) return;
    await navigator.clipboard.writeText(quickPhoto.value || "");
    showToast("已複製 photo_prompt");
  });

  btnCopyCam.addEventListener("click", async () => {
    if (!selectedRow) return;
    await navigator.clipboard.writeText(quickCam.value || "");
    showToast("已複製 camera_prompt");
  });

  async function ttsToMp3(row){
    if (!row){
      alert("請先點選一列");
      return;
    }
    const voice = ttsVoice.value || "en-US-AriaNeural";
    const rate = (ttsRate.value || "0%").trim() || "0%";
    const pitch = (ttsPitch.value || "0%").trim() || "0%";

    const resp = await fetch(SUPA_TTS_MP3_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "apikey": SUPABASE_ANON_KEY,
        "Authorization": "Bearer " + SUPABASE_ANON_KEY
      },
      body: JSON.stringify({ text: row.english, voice, rate, pitch })
    });

    if (!resp.ok){
      const t = await resp.text().catch(()=> "");
      alert(`TTS 失敗：${resp.status}\n${t}`);
      return;
    }
    const blob = await resp.blob();
    downloadBlob(blob, `${row.id}.mp3`);
  }

  
// --- Reference image support (attach 1-3 images to influence generation) ---
async function fileToDataURL(file){
  return await new Promise((resolve, reject) => {
    const fr = new FileReader();
    fr.onerror = () => reject(fr.error || new Error("FileReader error"));
    fr.onload = () => resolve(String(fr.result || ""));
    fr.readAsDataURL(file);
  });
}

function pickRefFileForIndex(rowIndex, totalRows){
  const inp = document.getElementById("refImages");
  const mode = document.getElementById("refModeSelect")?.value || "global";
  if (!inp || !inp.files || !inp.files.length) return [];
  const files = Array.from(inp.files);
  if (mode === "global") return files.slice(0, 3);
  const n = files.length;
  if (n <= 1) return files.slice(0, 1);
  const segment = Math.floor((rowIndex / Math.max(totalRows,1)) * n);
  const refIndex = Math.min(segment, n - 1);
  return [files[refIndex]];
}

async function getRefImagesData(rowIndex, totalRows){
  const files = pickRefFileForIndex(rowIndex, totalRows);
  if (!files.length) return [];
  const out = [];
  for (const f of files){
    try{
      out.push(await fileToDataURL(f));
    }catch(e){
      console.warn("ref image read failed", f?.name, e);
    }
  }
  return out;
}

async function imgOne(row, rowIndex = 0, totalRows = 1){
    if (!row){
      alert("請先點選一列");
      return;
    }
    const resp = await fetch(IMG_ONE_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "apikey": SUPABASE_ANON_KEY,
        "Authorization": "Bearer " + SUPABASE_ANON_KEY
      },
      body: JSON.stringify({
        prompt: row.photo_prompt,
        size: imgSize,
        // NEW: reference images (data URLs). Backend must support this field.
        ref_images: await getRefImagesData(rowIndex, totalRows),
        ref_mode: (document.getElementById("refModeSelect")?.value || "global")
      })
    });

    if (!resp.ok){
      const t = await resp.text().catch(()=> "");
      alert(`生圖失敗：${resp.status}
${t}`);
      return;
    }
    const blob = await resp.blob();
    downloadBlob(blob, `${row.id}.png`);
  }

  btnImgOne.addEventListener("click", async () => {
    if (!selectedRow) { alert("請先點選一列"); return; }
    btnImgOne.disabled = true;
    const old = btnImgOne.textContent;
    btnImgOne.textContent = "生成中…";
    try{
      await imgOne(selectedRow, selectedRowIndex || 0, rows.length || 1);
    }finally{
      btnImgOne.disabled = false;
      btnImgOne.textContent = old;
    }
  });

  btnImgBatch.addEventListener("click", async () => {
    if (!rows.length) return;
    let n = Number(batchN.value || 10);
    if (!Number.isFinite(n) || n < 1) n = 10;
    n = Math.min(n, rows.length);

    const ok = confirm(`將依序下載 ${n} 張圖片（ID.png，瀏覽器可能會詢問允許多檔下載）。要開始嗎？`);
    if (!ok) return;

    btnImgBatch.disabled = true;
    const old = btnImgBatch.textContent;
    btnImgBatch.textContent = `批次生成中（0/${n}）…`;

    try{
      for (let i=0;i<n;i++){
        btnImgBatch.textContent = `批次生成中（${i+1}/${n}）…`;
        await imgOne(rows[i], i, n);
        await new Promise(r=>setTimeout(r, 350));
      }
      showToast(`批次完成：${n} 張圖片`);
    }catch(e){
      console.error(e);
      alert("批次中斷：請看 Console");
    }finally{
      btnImgBatch.disabled = false;
      btnImgBatch.textContent = old;
    }
  });

  btnMp3One.addEventListener("click", async () => {
    if (!selectedRow) { alert("請先點選一列"); return; }
    btnMp3One.disabled = true;
    const old = btnMp3One.textContent;
    btnMp3One.textContent = "生成中…";
    try{
      await ttsToMp3(selectedRow);
    }finally{
      btnMp3One.disabled = false;
      btnMp3One.textContent = old;
    }
  });

  btnMp3Batch.addEventListener("click", async () => {
    if (!rows.length) return;
    let n = Number(batchN.value || 10);
    if (!Number.isFinite(n) || n < 1) n = 10;
    n = Math.min(n, rows.length);

    const ok = confirm(`將依序下載 ${n} 個 MP3（瀏覽器可能會詢問允許多檔下載）。要開始嗎？`);
    if (!ok) return;

    btnMp3Batch.disabled = true;
    const old = btnMp3Batch.textContent;
    btnMp3Batch.textContent = `批次生成中（0/${n}）…`;

    try{
      for (let i=0;i<n;i++){
        btnMp3Batch.textContent = `批次生成中（${i+1}/${n}）…`;
        await ttsToMp3(rows[i]);
        // small delay to avoid browser blocking too aggressively
        await new Promise(r=>setTimeout(r, 250));
      }
      showToast(`批次完成：${n} 個 MP3`);
    }catch(e){
      console.error(e);
      alert("批次中斷：請看 Console");
    }finally{
      btnMp3Batch.disabled = false;
      btnMp3Batch.textContent = old;
    }
  });

  // initial
  refreshButtons();
})();
</script>
</body>
</html>
