<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Media Jobs Control Panel</title>
  <style>
    :root{
      --bg:#0b1220; --card:#111b2f; --muted:#9fb0d0; --text:#e7eeff;
      --line:#1e2a45; --good:#39d98a; --warn:#ffcc66; --bad:#ff5c7a; --btn:#1a2a52;
      --accent:#7aa2ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:linear-gradient(180deg,#071022,#0b1220);
      color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", Arial;
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1200px; margin:0 auto; padding:18px}
    .top{
      display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap;
    }
    .card{
      background:rgba(17,27,47,.9);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .card h2{margin:0 0 10px 0; font-size:15px; letter-spacing:.2px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .col{flex:1 1 260px}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input, select, textarea{
      width:100%;
      background:#0b1530;
      color:var(--text);
      border:1px solid var(--line);
      border-radius:10px;
      padding:10px 10px;
      outline:none;
    }
    textarea{min-height:120px; resize:vertical; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px}
    .btn{
      border:1px solid var(--line);
      background:linear-gradient(180deg,#152650,#0f1f46);
      color:var(--text);
      padding:9px 11px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      font-size:12px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }
    .btn:hover{filter:brightness(1.05)}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .btn.ghost{background:#0b1530}
    .btn.good{border-color:rgba(57,217,138,.35); background:linear-gradient(180deg,rgba(57,217,138,.18),rgba(15,31,70,.9))}
    .btn.warn{border-color:rgba(255,204,102,.35); background:linear-gradient(180deg,rgba(255,204,102,.14),rgba(15,31,70,.9))}
    .btn.bad{border-color:rgba(255,92,122,.35); background:linear-gradient(180deg,rgba(255,92,122,.14),rgba(15,31,70,.9))}
    .btn.small{padding:7px 9px; font-size:11px}
    .muted{color:var(--muted)}
    .pill{
      display:inline-flex; padding:4px 9px; border-radius:999px; font-size:11px;
      border:1px solid var(--line); background:#0b1530; color:var(--muted);
    }
    .pill.good{color:var(--good); border-color:rgba(57,217,138,.35)}
    .pill.warn{color:var(--warn); border-color:rgba(255,204,102,.35)}
    .pill.bad{color:var(--bad); border-color:rgba(255,92,122,.35)}
    .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .jobs{
      margin-top:14px;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--line);
      background:#0b1530;
    }
    th,td{
      padding:10px 10px;
      border-bottom:1px solid rgba(30,42,69,.7);
      font-size:12px;
      vertical-align:top;
    }
    th{
      position:sticky; top:0;
      background:#0d1936;
      color:#cfe0ff;
      text-align:left;
      z-index:1;
      font-size:12px;
    }
    tr:last-child td{border-bottom:none}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .progress{
      width:160px;
    }
    .bar{
      height:10px; border-radius:999px; background:#0a132a; border:1px solid var(--line); overflow:hidden;
    }
    .bar > i{
      display:block; height:100%; width:0%;
      background:linear-gradient(90deg,#7aa2ff,#39d98a);
    }
    .stage{font-size:11px; color:var(--muted); margin-top:6px}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:900px){
      .grid2{grid-template-columns:1fr}
      .progress{width:140px}
      th{position:static}
    }
    .notice{
      border:1px dashed rgba(122,162,255,.5);
      background:rgba(122,162,255,.08);
      color:#cfe0ff;
      border-radius:12px;
      padding:10px;
      font-size:12px;
      line-height:1.4;
    }
    .right{margin-left:auto}
    .statusline{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .toast{
      position:fixed; right:14px; bottom:14px;
      background:#0d1936; border:1px solid var(--line);
      padding:10px 12px; border-radius:12px; max-width:420px;
      box-shadow:0 12px 35px rgba(0,0,0,.35);
      display:none;
      font-size:12px;
      line-height:1.4;
    }
    .toast.show{display:block}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="card col" style="flex:1 1 360px">
        <h2>連線設定（只需一次）</h2>
        <div class="grid2">
          <div>
            <label>SUPABASE_URL</label>
            <input id="sbUrl" placeholder="https://xxxx.supabase.co" />
          </div>
          <div>
            <label>SUPABASE_ANON_KEY</label>
            <input id="sbAnon" placeholder="eyJhbGciOi..." />
          </div>
          <div>
            <label>Storage Bucket</label>
            <input id="bucket" placeholder="talk" />
          </div>
          <div>
            <label>Worker ID（顯示用）</label>
            <input id="workerId" placeholder="LIN-SUKHUAN" />
          </div>
        </div>

        <div style="margin-top:10px" class="toolbar">
          <button class="btn good" id="btnConnect">Connect</button>
          <button class="btn ghost" id="btnSave">Save</button>
          <button class="btn ghost" id="btnLoad">Load</button>
          <span class="pill" id="connState">Not connected</span>
          <span class="muted right mono" id="now"></span>
        </div>

        <div style="margin-top:10px" class="notice">
          暫停功能：因為你 DB 的 <span class="mono">media_jobs_status_check</span> 不允許 <span class="mono">paused</span>，
          本頁採用：<b>Pause = pending</b> / <b>Resume = queued</b>，完全不用 SQL。
        </div>
      </div>

      <div class="card col" style="flex:1 1 360px">
        <h2>建立 Job</h2>
        <div class="grid2">
          <div>
            <label>slug</label>
            <input id="newSlug" placeholder="stress-10beats-001" />
          </div>
          <div>
            <label>category</label>
            <input id="newCategory" placeholder="story / movie / music..." />
          </div>
          <div style="grid-column:1 / -1">
            <label>title</label>
            <input id="newTitle" placeholder="Stress Test 10 Beats" />
          </div>
        </div>
        <div class="toolbar" style="margin-top:10px">
          <button class="btn good" id="btnCreateJob">Create Job (pending)</button>
          <button class="btn ghost" id="btnCreateAndQueue">Create + Queue</button>
        </div>
        <div class="muted" style="margin-top:10px; font-size:12px">
          建立後會回傳 job_id，你接著在右邊貼 SRT 匯入 beats。
        </div>
      </div>

      <div class="card col" style="flex:1 1 420px">
        <h2>SRT / Beats 匯入</h2>

        <label>Job ID（要匯入到哪一筆）</label>
        <input id="importJobId" placeholder="fa5a8282-..." />

        <label>貼 SRT（支援標準 00:00:01,000 --> 00:00:03,000）</label>
        <textarea id="srtText" placeholder="1
00:00:00,000 --> 00:00:03,000
A lion stands in the forest.

2
00:00:03,000 --> 00:00:06,000
A rabbit watches from the bushes.
"></textarea>

        <div class="toolbar" style="margin-top:10px">
          <button class="btn good" id="btnParseSrt">Preview Parse</button>
          <button class="btn warn" id="btnInsertBeats">Insert Beats</button>
          <button class="btn ghost" id="btnQueueThisJob">Queue This Job</button>
        </div>

        <div class="muted" style="margin-top:10px; font-size:12px" id="parseInfo">
          尚未解析。
        </div>
      </div>
    </div>

    <div class="card jobs">
      <div class="toolbar">
        <h2 style="margin:0">Media Jobs（最近 50 筆）</h2>
        <span class="pill" id="autoState">Auto refresh: OFF</span>
        <button class="btn ghost" id="btnRefresh">Refresh</button>
        <button class="btn ghost" id="btnAuto">Toggle Auto</button>

        <span class="right"></span>
        <select id="filterStatus" style="width:190px">
          <option value="">All status</option>
          <option value="pending">pending</option>
          <option value="queued">queued</option>
          <option value="processing">processing</option>
          <option value="done">done</option>
          <option value="failed">failed</option>
          <option value="canceled">canceled</option>
          <option value="claimed">claimed</option>
        </select>
        <input id="search" style="width:240px" placeholder="search slug/title/job_id..." />
      </div>

      <div style="margin-top:10px; overflow:auto; border-radius:14px">
        <table>
          <thead>
            <tr>
              <th style="min-width:220px">Job</th>
              <th style="min-width:110px">Status</th>
              <th class="progress">Progress</th>
              <th style="min-width:220px">Outputs</th>
              <th style="min-width:320px">Actions</th>
            </tr>
          </thead>
          <tbody id="jobsBody">
            <tr><td colspan="5" class="muted">尚未載入。</td></tr>
          </tbody>
        </table>
      </div>

      <div class="muted" style="margin-top:10px; font-size:12px" id="jobsInfo"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // -------------------------
    // UI helpers
    // -------------------------
    const $ = (id) => document.getElementById(id);
    const toast = (msg) => {
      const el = $("toast");
      el.textContent = msg;
      el.classList.add("show");
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => el.classList.remove("show"), 3200);
    };
    const fmtDate = (iso) => {
      if (!iso) return "";
      const d = new Date(iso);
      return d.toLocaleString();
    };
    const clip = async (text) => {
      try { await navigator.clipboard.writeText(text); toast("已複製"); }
      catch { toast("複製失敗（瀏覽器限制）"); }
    };

    // -------------------------
    // State
    // -------------------------
    let supabase = null;
    let parsedBeats = [];
    let autoTimer = null;

    function loadSettings(){
      const s = JSON.parse(localStorage.getItem("media_jobs_settings") || "{}");
      $("sbUrl").value = s.url || "";
      $("sbAnon").value = s.anon || "";
      $("bucket").value = s.bucket || "talk";
      $("workerId").value = s.workerId || "";
      toast("已載入設定");
    }
    function saveSettings(){
      const s = {
        url: $("sbUrl").value.trim(),
        anon: $("sbAnon").value.trim(),
        bucket: $("bucket").value.trim() || "talk",
        workerId: $("workerId").value.trim(),
      };
      localStorage.setItem("media_jobs_settings", JSON.stringify(s));
      toast("已保存設定");
    }

    function setConnState(ok){
      const el = $("connState");
      if(ok){
        el.textContent = "Connected";
        el.className = "pill good";
      }else{
        el.textContent = "Not connected";
        el.className = "pill";
      }
    }

    function pillForStatus(status){
      const s = (status || "").toLowerCase();
      if(["done"].includes(s)) return `<span class="pill good">${s}</span>`;
      if(["failed","canceled"].includes(s)) return `<span class="pill bad">${s}</span>`;
      if(["processing","queued","claimed"].includes(s)) return `<span class="pill warn">${s}</span>`;
      return `<span class="pill">${s || "-"}</span>`;
    }

    // -------------------------
    // Connect & test
    // -------------------------
    async function connect(){
      const url = $("sbUrl").value.trim();
      const anon = $("sbAnon").value.trim();
      if(!url || !anon){ toast("請先填 SUPABASE_URL / SUPABASE_ANON_KEY"); return; }
      supabase = createClient(url, anon);
      // quick test
      const { error } = await supabase.from("media_jobs").select("id").limit(1);
      if(error){
        console.error(error);
        setConnState(false);
        toast("連線失敗：請檢查 Key / RLS / Table 權限");
        return;
      }
      setConnState(true);
      toast("連線成功");
      await refreshJobs();
    }

    // -------------------------
    // Parse SRT
    // -------------------------
    function timeToMs(t){
      // "00:00:03,210" or "00:00:03.210"
      const m = t.trim().match(/^(\d{2}):(\d{2}):(\d{2})[,.](\d{1,3})$/);
      if(!m) return null;
      const hh = parseInt(m[1],10), mm = parseInt(m[2],10), ss = parseInt(m[3],10);
      let ms = parseInt(m[4],10);
      if(m[4].length === 1) ms *= 100;
      if(m[4].length === 2) ms *= 10;
      return ((hh*3600 + mm*60 + ss)*1000 + ms);
    }

    function parseSrt(text){
      const lines = text.replace(/\r/g,"").split("\n");
      const beats = [];
      let i=0;

      while(i < lines.length){
        // skip empty
        while(i < lines.length && lines[i].trim()==="") i++;
        if(i >= lines.length) break;

        // optional index
        if(/^\d+$/.test(lines[i].trim())) i++;

        // time range
        if(i >= lines.length) break;
        const tr = lines[i].trim();
        const m = tr.match(/^(.+?)\s*-->\s*(.+?)$/);
        if(!m){ i++; continue; }
        const startMs = timeToMs(m[1].trim());
        const endMs = timeToMs(m[2].trim());
        i++;

        // text block until empty
        const texts = [];
        while(i < lines.length && lines[i].trim()!==""){
          texts.push(lines[i].trim());
          i++;
        }
        const lineText = texts.join(" ").trim();

        if(startMs!=null && endMs!=null && lineText){
          beats.push({ start_ms:startMs, end_ms:endMs, line_text:lineText });
        }
      }

      // assign beat_index 1..n
      return beats.map((b, idx) => ({ beat_index: idx+1, ...b }));
    }

    function previewParsed(){
      const srt = $("srtText").value;
      parsedBeats = parseSrt(srt);
      if(parsedBeats.length === 0){
        $("parseInfo").textContent = "解析不到任何段落：請確認時間格式像 00:00:01,000 --> 00:00:03,000";
        toast("解析失敗：0 beats");
        return;
      }
      const totalSec = (parsedBeats[parsedBeats.length-1].end_ms/1000).toFixed(2);
      $("parseInfo").innerHTML = `
        解析成功：<b>${parsedBeats.length}</b> beats（總長約 <b>${totalSec}s</b>）<br/>
        預覽：<span class="mono">${escapeHtml(parsedBeats[0].line_text).slice(0,90)}</span>
      `;
      toast(`解析成功：${parsedBeats.length} beats`);
    }

    function escapeHtml(s){
      return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    }

    // -------------------------
    // Insert beats
    // -------------------------
    async function insertBeats(){
      if(!supabase){ toast("請先 Connect"); return; }
      const jobId = $("importJobId").value.trim();
      if(!jobId){ toast("請先填 Job ID"); return; }

      if(parsedBeats.length === 0){
        previewParsed();
        if(parsedBeats.length === 0) return;
      }

      // insert in chunks to avoid payload limits
      const chunkSize = 200;
      let inserted = 0;

      for(let i=0; i<parsedBeats.length; i+=chunkSize){
        const chunk = parsedBeats.slice(i, i+chunkSize).map(b => ({
          job_id: jobId,
          beat_index: b.beat_index,
          start_ms: b.start_ms,
          end_ms: b.end_ms,
          line_text: b.line_text,
        }));

        const { error } = await supabase.from("media_job_beats").insert(chunk);
        if(error){
          console.error(error);
          toast("Insert beats 失敗（請檢查 RLS/欄位/唯一鍵）");
          return;
        }
        inserted += chunk.length;
      }

      toast(`已插入 beats：${inserted}`);
    }

    // -------------------------
    // Jobs CRUD / Control
    // -------------------------
    async function createJob(queueAfter=false){
      if(!supabase){ toast("請先 Connect"); return; }
      const slug = $("newSlug").value.trim();
      const category = $("newCategory").value.trim() || "story";
      const title = $("newTitle").value.trim() || slug;
      if(!slug){ toast("請填 slug"); return; }

      const status = queueAfter ? "queued" : "pending";

      const { data, error } = await supabase
        .from("media_jobs")
        .insert([{ slug, category, title, status, progress: 0 }])
        .select("id,slug,status")
        .single();

      if(error){
        console.error(error);
        toast("Create Job 失敗（請檢查 RLS/欄位）");
        return;
      }

      $("importJobId").value = data.id;
      toast(`Job created: ${data.id}`);
      await refreshJobs();
    }

    async function setStatus(jobId, status){
      if(!supabase){ toast("請先 Connect"); return; }
      const { error } = await supabase
        .from("media_jobs")
        .update({ status })
        .eq("id", jobId);

      if(error){
        console.error(error);
        toast(`更新狀態失敗：${error.message || "unknown"}`);
        return;
      }
      toast(`status → ${status}`);
      await refreshJobs();
    }

    async function retryJob(jobId){
      if(!supabase){ toast("請先 Connect"); return; }

      // 你表內欄位可能叫 error / error_message / error_code / stage / progress / output_mp4_url / output_zip_url / output_manifest_url
      // 我們用「只更新存在的欄位」做法：先讀一筆，存在才更新
      const { data: job, error: e1 } = await supabase.from("media_jobs").select("*").eq("id", jobId).single();
      if(e1){ console.error(e1); toast("讀取 job 失敗"); return; }

      const patch = { status: "queued" };
      if("progress" in job) patch.progress = 0;
      if("stage" in job) patch.stage = null;
      if("error" in job) patch.error = null;
      if("error_code" in job) patch.error_code = null;
      if("error_message" in job) patch.error_message = null;
      if("worker_id" in job) patch.worker_id = null;
      if("lease_until" in job) patch.lease_until = null;
      if("output_mp4_url" in job) patch.output_mp4_url = null;
      if("output_zip_url" in job) patch.output_zip_url = null;
      if("output_manifest_url" in job) patch.output_manifest_url = null;

      const { error: e2 } = await supabase.from("media_jobs").update(patch).eq("id", jobId);
      if(e2){ console.error(e2); toast("Retry 更新失敗"); return; }

      toast("Retry queued");
      await refreshJobs();
    }

    async function refreshJobs(){
      if(!supabase){
        $("jobsBody").innerHTML = `<tr><td colspan="5" class="muted">尚未連線。</td></tr>`;
        return;
      }

      const status = $("filterStatus").value.trim();
      const q = $("search").value.trim().toLowerCase();

      let query = supabase
        .from("media_jobs")
        .select("*")
        .order("created_at", { ascending:false })
        .limit(50);

      if(status) query = query.eq("status", status);

      const { data, error } = await query;
      if(error){
        console.error(error);
        $("jobsBody").innerHTML = `<tr><td colspan="5" class="muted">讀取失敗：${escapeHtml(error.message || "unknown")}</td></tr>`;
        return;
      }

      let rows = data || [];
      if(q){
        rows = rows.filter(r => {
          const s = `${r.id||""} ${r.slug||""} ${r.title||""} ${r.category||""}`.toLowerCase();
          return s.includes(q);
        });
      }

      $("jobsInfo").textContent = `顯示 ${rows.length} 筆（最近 50 筆中篩選）`;

      if(rows.length === 0){
        $("jobsBody").innerHTML = `<tr><td colspan="5" class="muted">沒有資料。</td></tr>`;
        return;
      }

      const bucket = $("bucket").value.trim() || "talk";
      const base = $("sbUrl").value.trim().replace(/\/$/,"");
      const mkPublic = (path) => `${base}/storage/v1/object/public/${bucket}/${path}`;

      $("jobsBody").innerHTML = rows.map(job => {
        const id = job.id;
        const slug = escapeHtml(job.slug || "");
        const title = escapeHtml(job.title || "");
        const category = escapeHtml(job.category || "");
        const createdAt = fmtDate(job.created_at);
        const progress = typeof job.progress === "number" ? job.progress : 0;
        const stage = escapeHtml(job.stage || "");
        const statusPill = pillForStatus(job.status);

        const mp4 = job.output_mp4_url || job.output_video_url || "";
        const zip = job.output_zip_url || "";
        const manifest = job.output_manifest_url || (job.output_manifest_url===null ? "" : "") || job.output_manifest || "";

        const folderUrl = mkPublic(`jobs/${id}/`);

        const mp4Link = mp4 ? `<a href="${mp4}" target="_blank">MP4</a>` : `<span class="muted">MP4 -</span>`;
        const zipLink = zip ? `<a href="${zip}" target="_blank">ZIP</a>` : `<span class="muted">ZIP -</span>`;
        const manLink = manifest ? `<a href="${manifest}" target="_blank">manifest</a>` : `<span class="muted">manifest -</span>`;

        const isQueued = (job.status === "queued");
        const isPending = (job.status === "pending");

        return `
          <tr>
            <td>
              <div style="font-weight:700; font-size:13px">${title || slug || id}</div>
              <div class="muted" style="margin-top:4px">
                <span class="mono">${id}</span>
              </div>
              <div class="muted" style="margin-top:4px">
                ${category ? `<span class="pill">${category}</span>` : ""}
                ${slug ? `<span class="pill">${slug}</span>` : ""}
                <span class="muted" style="margin-left:6px">${createdAt}</span>
              </div>
              <div class="toolbar" style="margin-top:8px">
                <button class="btn small ghost" data-copy="${id}">Copy ID</button>
                <button class="btn small ghost" data-setimport="${id}">Use for Import</button>
              </div>
            </td>
            <td>${statusPill}</td>
            <td>
              <div class="bar"><i style="width:${Math.max(0, Math.min(100, progress))}%"></i></div>
              <div class="stage">${progress}% ${stage ? `• ${stage}` : ""}</div>
            </td>
            <td>
              <div class="toolbar" style="gap:10px">
                ${mp4Link} ${zipLink} ${manLink}
              </div>
              <div class="muted" style="margin-top:6px; font-size:11px">
                <a href="${folderUrl}" target="_blank">Open folder</a>
              </div>
            </td>
            <td>
              <div class="toolbar" style="flex-wrap:wrap">
                <button class="btn small good" data-queue="${id}" ${isQueued ? "disabled":""}>Queue</button>
                <button class="btn small warn" data-pause="${id}" ${isPending ? "disabled":""}>Pause(pending)</button>
                <button class="btn small ghost" data-retry="${id}">Retry</button>
                <button class="btn small bad" data-cancel="${id}">Cancel</button>
                <button class="btn small ghost" data-refreshone="${id}">Refresh</button>
              </div>
            </td>
          </tr>
        `;
      }).join("");

      // bind actions
      $("jobsBody").querySelectorAll("[data-copy]").forEach(b=>{
        b.addEventListener("click", () => clip(b.getAttribute("data-copy")));
      });
      $("jobsBody").querySelectorAll("[data-setimport]").forEach(b=>{
        b.addEventListener("click", () => {
          $("importJobId").value = b.getAttribute("data-setimport");
          toast("已填入 Import Job ID");
        });
      });
      $("jobsBody").querySelectorAll("[data-queue]").forEach(b=>{
        b.addEventListener("click", () => setStatus(b.getAttribute("data-queue"), "queued"));
      });
      $("jobsBody").querySelectorAll("[data-pause]").forEach(b=>{
        b.addEventListener("click", () => setStatus(b.getAttribute("data-pause"), "pending"));
      });
      $("jobsBody").querySelectorAll("[data-retry]").forEach(b=>{
        b.addEventListener("click", () => retryJob(b.getAttribute("data-retry")));
      });
      $("jobsBody").querySelectorAll("[data-cancel]").forEach(b=>{
        b.addEventListener("click", () => setStatus(b.getAttribute("data-cancel"), "canceled"));
      });
      $("jobsBody").querySelectorAll("[data-refreshone]").forEach(b=>{
        b.addEventListener("click", refreshJobs));
      });
    }

    // -------------------------
    // Queue this job shortcut
    // -------------------------
    async function queueImportJob(){
      const jobId = $("importJobId").value.trim();
      if(!jobId){ toast("請先填 Job ID"); return; }
      await setStatus(jobId, "queued");
    }

    // -------------------------
    // Auto refresh
    // -------------------------
    function toggleAuto(){
      if(autoTimer){
        clearInterval(autoTimer);
        autoTimer = null;
        $("autoState").textContent = "Auto refresh: OFF";
        $("autoState").className = "pill";
        toast("Auto refresh OFF");
      }else{
        autoTimer = setInterval(refreshJobs, 3000);
        $("autoState").textContent = "Auto refresh: ON (3s)";
        $("autoState").className = "pill good";
        toast("Auto refresh ON");
      }
    }

    // clock
    setInterval(() => $("now").textContent = new Date().toLocaleString(), 500);

    // -------------------------
    // Wire buttons
    // -------------------------
    $("btnConnect").addEventListener("click", connect);
    $("btnSave").addEventListener("click", saveSettings);
    $("btnLoad").addEventListener("click", loadSettings);
    $("btnRefresh").addEventListener("click", refreshJobs);
    $("btnAuto").addEventListener("click", toggleAuto);

    $("btnCreateJob").addEventListener("click", () => createJob(false));
    $("btnCreateAndQueue").addEventListener("click", () => createJob(true));

    $("btnParseSrt").addEventListener("click", previewParsed);
    $("btnInsertBeats").addEventListener("click", insertBeats);
    $("btnQueueThisJob").addEventListener("click", queueImportJob);

    $("filterStatus").addEventListener("change", refreshJobs);
    $("search").addEventListener("input", () => {
      // debounce a bit
      clearTimeout(window.__qTimer);
      window.__qTimer = setTimeout(refreshJobs, 250);
    });

    // initial
    loadSettings();
    setConnState(false);
  </script>
</body>
</html>
