<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Media Jobs 控制台（Supabase + Worker）</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#07121b; --card:#0b1c28; --card2:#0a1822;
      --text:#e8f1ff; --muted:#9ab0c7; --line:rgba(255,255,255,.08);
      --btn:#132a3a; --btn2:#103145; --good:#27d69b; --warn:#ffb020; --bad:#ff5d5d;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --r:18px;
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",Arial;
    }
    body{ margin:0; background: radial-gradient(1200px 800px at 30% 10%, #122b3b 0%, var(--bg) 55%), var(--bg); color:var(--text);}
    .wrap{max-width:1200px; margin:22px auto; padding:0 14px;}
    h1{font-size:20px; margin:0 0 14px 0; color:#dff0ff; letter-spacing:.2px;}
    .grid{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:14px;}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .card h2{font-size:14px; margin:0 0 10px 0; color:#cfe6ff;}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px;}
    input, select, textarea{
      width:100%; box-sizing:border-box;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      border-radius: 12px;
      padding:10px 10px;
      outline:none;
    }
    textarea{min-height:160px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; font-size:12px; line-height:1.4;}
    .row{display:flex; gap:10px; align-items:center;}
    .row > *{flex:1;}
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    button{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition:.15s;
    }
    button:hover{transform: translateY(-1px);}
    button.primary{background: linear-gradient(180deg, rgba(39,214,155,.22), rgba(39,214,155,.10)); border-color: rgba(39,214,155,.35);}
    button.warn{background: linear-gradient(180deg, rgba(255,176,32,.22), rgba(255,176,32,.10)); border-color: rgba(255,176,32,.35);}
    button.bad{background: linear-gradient(180deg, rgba(255,93,93,.22), rgba(255,93,93,.10)); border-color: rgba(255,93,93,.35);}
    .hint{font-size:12px; color:var(--muted); margin-top:8px; line-height:1.45;}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.18); font-size:12px;}
    .dot{width:9px;height:9px;border-radius:50%;}
    .dot.good{background:var(--good);} .dot.warn{background:var(--warn);} .dot.bad{background:var(--bad);}
    .jobs{margin-top:14px;}
    .toolbar{display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:10px;}
    .toolbar .left, .toolbar .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .table{
      border:1px solid var(--line);
      border-radius: var(--r);
      overflow:hidden;
      background: rgba(0,0,0,.16);
    }
    .thead, .trow{
      display:grid;
      grid-template-columns: 1.5fr .8fr 1fr 1.1fr 1.1fr;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      align-items:center;
    }
    .thead{font-size:12px; color:var(--muted); background: rgba(255,255,255,.03);}
    .trow{font-size:12px;}
    .trow:last-child{border-bottom:none;}
    .jobtitle{display:flex; flex-direction:column; gap:3px;}
    .small{color:var(--muted); font-size:11px;}
    .status{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      width:fit-content;
    }
    .progressbar{
      height:10px; border-radius:999px; background: rgba(255,255,255,.08);
      overflow:hidden; border:1px solid rgba(255,255,255,.10);
    }
    .progressbar > div{height:100%; width:0%; background: linear-gradient(90deg, rgba(39,214,155,.85), rgba(74,153,255,.85));}
    a{color:#8bd3ff; text-decoration:none;}
    a:hover{text-decoration:underline;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Media Jobs 控制台（Supabase + Worker）</h1>

    <div class="grid">
      <div class="card">
        <h2>連線設定（只需一次）</h2>

        <label>SUPABASE_URL</label>
        <input id="sbUrl" placeholder="https://xxxx.supabase.co" />

        <label>SUPABASE_ANON_KEY</label>
        <input id="sbAnon" placeholder="eyJhbGciOi..." />

        <div class="row">
          <div>
            <label>Storage Bucket（顯示用）</label>
            <input id="bucket" value="talk" />
          </div>
          <div>
            <label>Worker ID（顯示用）</label>
            <input id="workerId" value="LIN-SUKHUAN" />
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="btnConnect" type="button">Connect</button>
          <button id="btnSave" type="button">Save</button>
          <button id="btnLoad" type="button">Load</button>
          <span class="pill" id="connPill"><span class="dot bad"></span><span id="connText">Not connected</span></span>
        </div>

        <div class="hint">
          ✅ 這頁用 <b>ANON key</b> 只做「控制台」：<br/>
          Create Job / Insert Beats / Queue / Pause / Resume 都走 RPC（繞過 RLS）。<br/>
          真正生圖/合成 MP4/ZIP 是你本機 <b>worker.py（service role）</b> 在跑。
        </div>
      </div>

      <div class="card">
        <h2>建立 Job</h2>
        <div class="row">
          <div>
            <label>slug</label>
            <input id="jobSlug" value="test" />
          </div>
          <div>
            <label>category</label>
            <select id="jobCategory">
              <option value="story">story</option>
              <option value="stress">stress</option>
              <option value="movie">movie</option>
              <option value="music">music</option>
              <option value="other">other</option>
            </select>
          </div>
        </div>

        <label>title</label>
        <input id="jobTitle" value="test" />

        <div class="btns">
          <button class="primary" id="btnCreatePending" type="button">Create Job (pending)</button>
          <button class="primary" id="btnCreateQueue" type="button">Create + Queue</button>
        </div>

        <div class="hint">
          建立後會回傳 <b>job_id</b>，把它貼到右邊 SRT/Beats 區。
        </div>

        <hr style="border:none;border-top:1px solid var(--line); margin:14px 0;">

        <h2>快速控制（不用 SQL）</h2>
        <label>Job ID（uuid）</label>
        <input id="ctlJobId" placeholder="貼 job id" class="mono" />

        <div class="btns">
          <button class="warn" id="btnPause" type="button">Pause（pending）</button>
          <button class="primary" id="btnResume" type="button">Resume（queued）</button>
          <button class="bad" id="btnFail" type="button">Mark failed</button>
        </div>

        <div class="hint">
          你的 DB constraint 不允許 status='paused'。<br/>
          所以：<b>Pause = pending</b>（worker 不會 claim） / <b>Resume = queued</b>（worker 會 claim）。
        </div>
      </div>

      <div class="card">
        <h2>SRT / Beats 匯入</h2>

        <label>Job ID（要匯入到哪一筆）</label>
        <input id="beatsJobId" placeholder="貼 job id（uuid）" class="mono" />

        <label>選擇 .srt 檔（會自動讀進下面文字框）</label>
        <input id="srtFile" type="file" accept=".srt" />

        <div class="btns">
          <button id="btnReadSrt" type="button">讀取 .srt 檔</button>
          <button id="btnClearSrt" type="button">清空</button>
          <span class="pill" id="srtPill"><span class="dot warn"></span><span id="srtText">尚未讀檔</span></span>
        </div>

        <label>貼 SRT（支援標準：00:00:01,000 --> 00:00:03,000）</label>
        <textarea id="srtTextArea" placeholder="把整段 SRT 貼在這裡"></textarea>

        <div class="btns">
          <button class="primary" id="btnPreview" type="button">Preview Parse</button>
          <button class="primary" id="btnInsertBeats" type="button">Insert Beats</button>
          <button class="primary" id="btnQueue" type="button">Queue This Job</button>
        </div>

        <div class="hint" id="parseHint">尚未解析。</div>
        <pre id="parseOut" style="white-space:pre-wrap; font-size:12px; color:#cfe6ff; margin:10px 0 0;"></pre>

        <div class="hint">
          ✅ 你要一支完整 mp4：就要確保這個 job 的 beats 是「完整的」（例如 26 行就插入 26 beats）。<br/>
          若只插入 10 beats，worker 只會合成 10 段 → mp4 看起來像「一小段」。
        </div>
      </div>
    </div>

    <div class="jobs">
      <div class="toolbar">
        <div class="left">
          <span class="pill"><span class="dot good"></span>Media Jobs（最近 50 筆）</span>
          <button id="btnRefresh" type="button">Refresh</button>
          <button id="btnToggleAuto" type="button">Auto refresh: OFF</button>
        </div>
        <div class="right">
          <select id="statusFilter">
            <option value="">All status</option>
            <option value="pending">pending</option>
            <option value="queued">queued</option>
            <option value="processing">processing</option>
            <option value="done">done</option>
            <option value="failed">failed</option>
          </select>
          <input id="searchBox" placeholder="search slug/title/job_id..." />
        </div>
      </div>

      <div class="table">
        <div class="thead">
          <div>Job</div>
          <div>Status</div>
          <div>Progress</div>
          <div>Outputs</div>
          <div>Actions</div>
        </div>
        <div id="jobRows"></div>
      </div>

      <div class="hint" style="margin-top:10px;">
        ✅ Outputs 欄位會顯示：<b>output_zip_url / output_manifest_url / output_video_url</b>（以你 DB 實際存在欄位為準）。<br/>
        你之前的錯誤：<b>output_mp4_url does not exist</b> 是因為前端查了不存在的欄位。
      </div>
    </div>
  </div>

<script>
  let supa = null;
  let autoTimer = null;
  let lastParsed = [];

  const $ = (id)=>document.getElementById(id);

  function log(msg){
    const el = $("logBox");
    const t = new Date().toLocaleTimeString();
    const line = `[${t}] ${msg}`;
    console.log(line);
    if(el){
      el.textContent = (el.textContent ? el.textContent + "\n" : "") + line;
      el.scrollTop = el.scrollHeight;
    }
  }

  window.addEventListener("error", (ev)=>{
    log("JS error: " + (ev.message || ev.error || "unknown"));
  });

  window.addEventListener("unhandledrejection", (ev)=>{
    log("Promise rejection: " + (ev.reason?.message || String(ev.reason)));
  });


  function setConn(ok){
    const pill = $("connPill");
    pill.querySelector(".dot").className = "dot " + (ok ? "good":"bad");
    $("connText").textContent = ok ? "Connected":"Not connected";
  }

  function setSrtState(state, text){
    const dot = $("srtPill").querySelector(".dot");
    dot.className = "dot " + (state==="ok" ? "good" : state==="warn" ? "warn":"bad");
    $("srtText").textContent = text;
  }

  function saveCfg(){
    const cfg = {
      url: $("sbUrl").value.trim(),
      anon: $("sbAnon").value.trim(),
      bucket: $("bucket").value.trim(),
      workerId: $("workerId").value.trim()
    };
    localStorage.setItem("media_jobs_cfg", JSON.stringify(cfg));
  }

  function loadCfg(){
    const raw = localStorage.getItem("media_jobs_cfg");
    if(!raw) return;
    try{
      const cfg = JSON.parse(raw);
      $("sbUrl").value = cfg.url || "";
      $("sbAnon").value = cfg.anon || "";
      $("bucket").value = cfg.bucket || "talk";
      $("workerId").value = cfg.workerId || "LIN-SUKHUAN";
    }catch(e){}
  }

  function connect(){
    const url = $("sbUrl").value.trim();
    const anon = $("sbAnon").value.trim();
    if(!url || !anon){
      alert("請填 SUPABASE_URL 與 SUPABASE_ANON_KEY");
      return;
    }
    supa = window.supabase.createClient(url, anon);
    setConn(true);
  }

  function parseSrt(srt){
    // Very tolerant parser for blocks:
    // index \n time --> time \n text...
    const lines = srt.replace(/\r/g,"").split("\n");
    const out = [];
    let i=0;
    while(i < lines.length){
      // skip empty
      while(i<lines.length && lines[i].trim()==="") i++;
      if(i>=lines.length) break;

      // index optional
      let idxLine = lines[i].trim();
      if(/^\d+$/.test(idxLine)) i++;
      if(i>=lines.length) break;

      const timeLine = (lines[i]||"").trim();
      const m = timeLine.match(/(\d{2}:\d{2}:\d{2}[,.]\d{3})\s*-->\s*(\d{2}:\d{2}:\d{2}[,.]\d{3})/);
      if(!m){ i++; continue; }
      const t1 = m[1].replace(",",".");
      const t2 = m[2].replace(",",".");
      i++;

      // collect text until blank
      const texts = [];
      while(i<lines.length && lines[i].trim()!==""){
        texts.push(lines[i]);
        i++;
      }
      const text = texts.join(" ").trim();

      const ms1 = toMs(t1);
      const ms2 = toMs(t2);
      if(ms2>ms1){
        out.push({ start_ms: ms1, end_ms: ms2, line_text: text });
      }
    }

    // assign beat_index 1..n
    out.forEach((b, k)=> b.beat_index = k+1);
    return out;
  }

  function toMs(t){
    // "HH:MM:SS.mmm"
    const [hh,mm,rest] = t.split(":");
    const [ss,ms] = rest.split(".");
    return (parseInt(hh)*3600 + parseInt(mm)*60 + parseInt(ss))*1000 + parseInt(ms);
  }

  async function rpc(name, args){
    if(!supa) throw new Error("Not connected");
    log(`RPC -> ${name} ${args?JSON.stringify(args):""}`);
    const { data, error } = await supa.rpc(name, args);
    if(error){
      log(`RPC ERROR ${name}: ` + (error.message || JSON.stringify(error)));
      throw error;
    }
    log(`RPC OK ${name}: ` + (typeof data==="string" ? data : JSON.stringify(data)));
    return data;
  }

  async function createJob(status){
    const slug = $("jobSlug").value.trim();
    const category = $("jobCategory").value.trim();
    const title = $("jobTitle").value.trim();
    if(!slug || !category || !title){
      alert("請填 slug/category/title");
      return;
    }
    const jobId = await rpc("rpc_create_media_job", { p_slug: slug, p_category: category, p_title: title });
    if(!jobId || typeof jobId !== "string"){ throw new Error("rpc_create_media_job 沒回傳 job_id（請檢查 SQL function 回傳型別）"); }
    $("ctlJobId").value = jobId;
    $("beatsJobId").value = jobId;

    if(status === "queued"){
      await rpc("rpc_set_media_job_status", { p_job_id: jobId, p_status: "queued" });
    }

    alert("建立成功：\n" + jobId);
    await refreshJobs();
  }

  async function setStatus(jobId, status){
    if(!jobId) { alert("請填 job_id"); return; }
    await rpc("rpc_set_media_job_status", { p_job_id: jobId, p_status: status });
    await refreshJobs();
  }

  async function insertBeats(){
    const jobId = $("beatsJobId").value.trim();
    if(!jobId) { alert("請貼 job_id"); return; }
    if(!lastParsed.length) { alert("先按 Preview Parse"); return; }

    const payload = lastParsed.map(b=>({
      beat_index: b.beat_index,
      start_ms: b.start_ms,
      end_ms: b.end_ms,
      line_text: b.line_text || ""
    }));

    const count = await rpc("rpc_insert_media_job_beats", { p_job_id: jobId, p_beats: payload });
    alert("已寫入 beats 筆數: " + count);
  }

  async function refreshJobs(){
    if(!supa) return;
    const status = $("statusFilter").value.trim();
    const q = $("searchBox").value.trim().toLowerCase();

    const rows = await rpc("rpc_list_media_jobs", { p_limit: 50 });

    const filtered = (rows || []).filter(r=>{
      if(status && r.status !== status) return false;
      if(q){
        const s = `${r.id} ${r.slug||""} ${r.title||""}`.toLowerCase();
        if(!s.includes(q)) return false;
      }
      return true;
    });

    $("jobRows").innerHTML = filtered.map(renderRow).join("");
  }

  function statusDot(s){
    if(s==="done") return "good";
    if(s==="failed") return "bad";
    if(s==="processing") return "warn";
    if(s==="queued") return "warn";
    return "warn";
  }

  function safeLink(url, label){
    if(!url) return "";
    return `<div><a href="${url}" target="_blank" rel="noopener">${label}</a></div>`;
  }

  function renderRow(r){
    const prog = Math.max(0, Math.min(100, parseInt(r.progress||0)));
    const stage = r.stage ? `stage: ${r.stage}` : "";
    const err = r.error_message ? `<div class="small" style="color:#ff9b9b">⚠ ${escapeHtml(r.error_message)}</div>` : "";
    const outputs = `
      ${safeLink(r.output_zip_url, "output_zip_url")}
      ${safeLink(r.output_manifest_url, "output_manifest_url")}
      ${safeLink(r.output_video_url, "output_video_url")}
    `.trim() || `<span class="small">（尚無輸出）</span>`;

    return `
      <div class="trow">
        <div class="jobtitle">
          <div class="mono">${r.id}</div>
          <div class="small">${escapeHtml(r.slug||"")} • ${escapeHtml(r.title||"")}</div>
          <div class="small">${escapeHtml(stage)}</div>
          ${err}
        </div>
        <div>
          <span class="status"><span class="dot ${statusDot(r.status)}"></span>${escapeHtml(r.status||"")}</span>
        </div>
        <div>
          <div class="progressbar"><div style="width:${prog}%"></div></div>
          <div class="small">${prog}%</div>
        </div>
        <div>${outputs}</div>
        <div class="btns" style="margin:0;">
          <button onclick="copyId('${r.id}')" type="button">Copy ID</button>
          <button class="warn" onclick="setStatusUI('${r.id}','pending')" type="button">Pause</button>
          <button class="primary" onclick="setStatusUI('${r.id}','queued')" type="button">Resume</button>
          <button class="bad" onclick="setStatusUI('${r.id}','failed')" type="button">Fail</button>
        </div>
      </div>
    `;
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }

  window.copyId = (id)=>{
    navigator.clipboard.writeText(id);
  };

  window.setStatusUI = async (id, status)=>{
    try{
      await setStatus(id, status);
    }catch(e){
      alert(e.message || String(e));
    }
  };

  // Wire
  $("btnLoad").onclick = ()=>{ loadCfg(); };
  $("btnSave").onclick = ()=>{ saveCfg(); alert("Saved"); };
  $("btnConnect").onclick = async ()=>{
    try{
      connect();
      saveCfg();
      await refreshJobs();
    }catch(e){
      setConn(false);
      alert(e.message || String(e));
    }
  };

  $("btnCreatePending").onclick = async ()=>{
    try{ await createJob("pending"); }catch(e){ alert(e.message||String(e)); }
  };
  $("btnCreateQueue").onclick = async ()=>{
    try{ await createJob("queued"); }catch(e){ alert(e.message||String(e)); }
  };

  $("btnPause").onclick = async ()=>{
    try{ await setStatus($("ctlJobId").value.trim(), "pending"); }catch(e){ alert(e.message||String(e)); }
  };
  $("btnResume").onclick = async ()=>{
    try{ await setStatus($("ctlJobId").value.trim(), "queued"); }catch(e){ alert(e.message||String(e)); }
  };
  $("btnFail").onclick = async ()=>{
    try{ await setStatus($("ctlJobId").value.trim(), "failed"); }catch(e){ alert(e.message||String(e)); }
  };

  $("btnReadSrt").onclick = async ()=>{
    const f = $("srtFile").files && $("srtFile").files[0];
    if(!f){ alert("請選擇 .srt 檔"); return; }
    const txt = await f.text();
    $("srtTextArea").value = txt;
    setSrtState("ok", `已讀取檔案：${f.name}（${Math.round(f.size/1024)} KB）`);
  };
  $("btnClearSrt").onclick = ()=>{
    $("srtTextArea").value = "";
    $("parseOut").textContent = "";
    $("parseHint").textContent = "尚未解析。";
    lastParsed = [];
    setSrtState("warn","尚未讀檔");
  };

  $("btnPreview").onclick = ()=>{
    const srt = $("srtTextArea").value || "";
    const beats = parseSrt(srt);
    lastParsed = beats;
    $("parseHint").textContent = `解析結果：beats = ${beats.length}`;
    $("parseOut").textContent = beats.slice(0, 8).map(b=>{
      return `${b.beat_index}. ${b.start_ms}~${b.end_ms}ms | ${b.line_text}`;
    }).join("\n") + (beats.length>8 ? "\n..." : "");
  };

  $("btnInsertBeats").onclick = async ()=>{
    try{ await insertBeats(); }catch(e){ alert(e.message||String(e)); }
  };

  $("btnQueue").onclick = async ()=>{
    try{
      const jobId = $("beatsJobId").value.trim();
      if(!jobId){ alert("請貼 job_id"); return; }
      await setStatus(jobId, "queued");
      alert("已設為 queued（worker 會開始 claim）");
    }catch(e){
      alert(e.message||String(e));
    }
  };

  $("btnRefresh").onclick = refreshJobs;
  $("statusFilter").onchange = refreshJobs;
  $("searchBox").oninput = ()=>{ clearTimeout(window.__q); window.__q=setTimeout(refreshJobs, 250); };

  $("btnToggleAuto").onclick = ()=>{
    if(autoTimer){
      clearInterval(autoTimer);
      autoTimer = null;
      $("btnToggleAuto").textContent = "Auto refresh: OFF";
    }else{
      autoTimer = setInterval(refreshJobs, 2000);
      $("btnToggleAuto").textContent = "Auto refresh: ON";
    }
  };

  $("btnClearLog").onclick = ()=>{ $("logBox").textContent=""; };

  // init
  loadCfg();
  setConn(false);
  setSrtState("warn","尚未讀檔");
</script>
</body>
</html>





    <!-- card: logs -->
    <div class="card">
      <div class="h">即時訊息（Debug）</div>
      <div class="hint">如果按鈕「沒反應」，請看這裡會不會出現 RPC / 權限 / 連線錯誤。</div>
      <pre id="logBox" style="margin:10px 0 0; padding:10px; background:rgba(0,0,0,.25); border:1px solid var(--line); border-radius:12px; height:180px; overflow:auto; font-size:12px; line-height:1.45; white-space:pre-wrap;"></pre>
      <div class="btns" style="margin-top:10px">
        <button id="btnClearLog">Clear log</button>
      </div>
    </div>


