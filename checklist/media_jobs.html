<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Media Jobs æ§åˆ¶å° (Supabase + Worker)</title>
  <style>
    :root{
      --bg:#071024;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.08);
      --border:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.65);
      --ok:#3ddc97;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --btn:rgba(255,255,255,.08);
      --btn2:rgba(255,255,255,.12);
      --shadow:0 12px 40px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 900px at 20% 10%, rgba(56,189,248,.18), transparent 55%),
                  radial-gradient(900px 700px at 70% 20%, rgba(34,197,94,.16), transparent 50%),
                  radial-gradient(900px 700px at 60% 80%, rgba(168,85,247,.16), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family:var(--sans);
      min-height:100vh;
    }
    header{
      padding:18px 18px 8px;
      max-width:1400px;
      margin:0 auto;
    }
    h1{
      margin:0;
      font-size:20px;
      letter-spacing:.2px;
      font-weight:700;
    }
    .sub{
      margin-top:6px;
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
    }
    .wrap{
      max-width:1400px;
      margin:0 auto;
      padding:14px 18px 24px;
      display:grid;
      grid-template-columns: 1.05fr 1.05fr 1.3fr;
      gap:14px;
    }
    @media (max-width:1100px){
      .wrap{grid-template-columns:1fr}
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.05));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .card h2{
      margin:0 0 10px;
      font-size:15px;
      font-weight:700;
    }
    .grid2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px;
    }
    input, select, textarea{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(2,8,23,.50);
      color:var(--text);
      padding:10px 12px;
      outline:none;
      font-size:14px;
    }
    textarea{
      min-height:180px;
      font-family:var(--mono);
      font-size:12.5px;
      line-height:1.45;
      resize:vertical;
    }
    input::placeholder, textarea::placeholder{color:rgba(255,255,255,.35)}
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, var(--btn2), var(--btn));
      color:var(--text);
      padding:10px 14px;
      border-radius:14px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      transition:.12s ease;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.ok{border-color:rgba(61,220,151,.35)}
    .btn.bad{border-color:rgba(255,107,107,.45)}
    .btn.warn{border-color:rgba(255,204,102,.45)}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      font-size:12px;
      color:var(--muted);
    }
    .dot{
      width:9px;height:9px;border-radius:50%;
      background:rgba(255,255,255,.35);
    }
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--bad)}
    .dot.warn{background:var(--warn)}
    .hint{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.18);
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
      background:rgba(255,255,255,.04);
    }
    .mono{font-family:var(--mono)}
    .small{font-size:12px;color:var(--muted)}
    .progress{
      height:10px;
      width:100%;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      border-radius:999px;
      overflow:hidden;
    }
    .bar{
      height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(56,189,248,.9), rgba(34,197,94,.9));
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0 10px;
      font-size:13px;
    }
    th{
      text-align:left;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      padding:0 10px;
    }
    td{
      padding:10px 10px;
      background:rgba(255,255,255,.06);
      border-top:1px solid rgba(255,255,255,.10);
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    td:first-child{border-left:1px solid rgba(255,255,255,.10); border-top-left-radius:14px; border-bottom-left-radius:14px}
    td:last-child{border-right:1px solid rgba(255,255,255,.10); border-top-right-radius:14px; border-bottom-right-radius:14px}
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      font-size:12px;
      color:var(--text);
      white-space:nowrap;
    }
    a{color:rgba(56,189,248,.95); text-decoration:none}
    a:hover{text-decoration:underline}
    .rightActions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .dangerNote{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,107,107,.35);
      background:rgba(255,107,107,.08);
      color:rgba(255,255,255,.85);
      font-size:12px;
      line-height:1.45;
    }
    .kbd{
      font-family:var(--mono);
      padding:2px 6px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.06);
      font-size:12px;
      color:rgba(255,255,255,.85);
    }
  
    .toast{
      position:fixed;
      right:16px;
      top:16px;
      z-index:9999;
      max-width:min(520px, calc(100vw - 32px));
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.72);
      color:rgba(255,255,255,.95);
      font-size:13px;
      line-height:1.4;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      user-select:none;
    }
    .toast.bad{ border-color: rgba(255,80,80,.45); }
    .toast.ok{ border-color: rgba(0,255,180,.35); }

  </style>
</head>
<body>

<div id="toast" class="toast" style="display:none"></div>
<header>
  <h1>Media Jobs æ§åˆ¶å° (Supabase + Worker)</h1>
  <div class="sub">
    âœ… ä¸ç”¨ SQLï¼šå»ºç«‹ job â†’ åŒ¯å…¥ SRT ç”¢ç”Ÿ beats â†’ Queue â†’ worker è‡ªå‹•ç”¢åœ–ã€åˆ MP4ã€æ‰“åŒ… ZIPã€ä¸Šå‚³ manifestã€‚<br/>
    â›” DB çš„ status check æ²’æœ‰ <span class="kbd">paused</span>ï¼šæ‰€ä»¥æœ¬é æ¡ç”¨ <b>Pause = pending / Resume = queued</b>ã€‚
  </div>
</header>

<div class="wrap">
  <!-- Connect -->
  <section class="card">
    <h2>é€£ç·šè¨­å®šï¼ˆåªéœ€ä¸€æ¬¡ï¼‰</h2>
    <div class="grid2">
      <div>
        <label>SUPABASE_URL</label>
        <input id="sbUrl" placeholder="https://xxxx.supabase.co" />
      </div>
      <div>
        <label>SUPABASE_ANON_KEY</label>
        <input id="sbAnon" placeholder="eyJhbGciOi..." />
      </div>
      <div>
        <label>Storage Bucketï¼ˆåœ–ç‰‡/mp4/zip/manifestï¼‰</label>
        <input id="sbBucket" value="talk" />
      </div>
      <div>
        <label>Worker IDï¼ˆé¡¯ç¤ºç”¨ï¼‰</label>
        <input id="workerId" value="LIN-SUKHUAN" />
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn ok" id="btnConnect">Connect</button>
      <button class="btn" id="btnSave">Save</button>
      <button class="btn" id="btnLoad">Load</button>
      <span class="pill" id="connPill"><span class="dot" id="connDot"></span><span id="connText">Not connected</span></span>
    </div>

    <div class="hint">
      âœ… å»ºè­°ï¼šç”¨ ANoN key åªåšå‰å°æ§åˆ¶å°ï¼›çœŸæ­£ç”¢æª”ç”¨ä½ çš„æœ¬æ©Ÿ <b>worker.py</b>ï¼ˆservice roleï¼‰è·‘ã€‚<br/>
      è‹¥ä½ çœ‹åˆ° <span class="kbd">400</span> æˆ– <span class="kbd">column ... does not exist</span>ï¼Œé€šå¸¸æ˜¯å‰ç«¯ select æ¬„ä½å¯«éŒ¯ï¼›æœ¬é å·²é¿å…ç¡¬å¯«ä¸å­˜åœ¨æ¬„ä½ã€‚
    </div>
  </section>

  <!-- Create Job + Quick control -->
  <section class="card">
    <h2>å»ºç«‹ Job</h2>

    <div class="grid2">
      <div>
        <label>slug</label>
        <input id="jobSlug" placeholder="stress-10beats-001" />
      </div>
      <div>
        <label>category</label>
        <select id="jobCategory">
          <option value="story">story</option>
          <option value="movie">movie</option>
          <option value="music">music</option>
          <option value="ads">ads</option>
          <option value="other">other</option>
        </select>
      </div>
      <div style="grid-column:1/3">
        <label>title</label>
        <input id="jobTitle" placeholder="Stress Test 10 Beats" />
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn" id="btnCreatePending">Create Job (pending)</button>
      <button class="btn ok" id="btnCreateQueue">Create + Queue</button>
      <span class="pill"><span class="dot warn"></span><span class="small">å»ºç«‹å¾Œæœƒå›å‚³ job_idï¼ŒæŠŠå®ƒè²¼åˆ°å³é‚ŠåŒ¯å…¥ beats</span></span>
    </div>

    <div class="dangerNote">
      ğŸ”’ Pause/Resume èªªæ˜ï¼šä½ çš„ DB constraint ä¸å…è¨± status='paused'ã€‚<br/>
      æ‰€ä»¥æœ¬é ï¼š<b>Pause = pending</b>ï¼ˆworker ä¸æœƒ claimï¼‰ï¼Œ<b>Resume = queued</b>ï¼ˆworker æœƒ claimï¼‰ã€‚
    </div>

    <h2 style="margin-top:16px">å¿«é€Ÿæ§åˆ¶ï¼ˆä¸ç”¨ SQLï¼‰</h2>
    <div class="grid2">
      <div style="grid-column:1/3">
        <label>Job IDï¼ˆuuidï¼‰</label>
        <input id="ctlJobId" placeholder="fa5a8282-921d-4fc5-9d5f-fdce411e7645" />
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn warn" id="btnPause">Pause (pending)</button>
      <button class="btn ok" id="btnResume">Resume (queued)</button>
      <button class="btn bad" id="btnMarkFailed">Mark failed</button>
    </div>
    <div class="hint">
      âš ï¸ å¦‚æœ job æ­£åœ¨æœ¬æ©Ÿ worker åˆæˆ ffmpegï¼Œä¸­é€”æ”¹ status ä¸¦ä¸æœƒã€Œç«‹åˆ»ä¸­æ­¢ ffmpegã€ï¼Œä½† worker ä¸‹ä¸€è¼ª poll æœƒå°Šé‡ç‹€æ…‹ï¼ˆä¸å†è™•ç†ä¸‹ä¸€æ­¥ï¼‰ã€‚
    </div>
  </section>

  <!-- SRT / Beats -->
  <section class="card">
    <h2>SRT / Beats åŒ¯å…¥</h2>

    <div class="grid2">
      <div style="grid-column:1/3">
        <label>Job IDï¼ˆè¦åŒ¯å…¥åˆ°å“ªä¸€ç­†ï¼‰</label>
        <input id="beatsJobId" placeholder="fa5a8282-..." />
      </div>
      <div style="grid-column:1/3">
        <label>é¸æ“‡ .srt æª”ï¼ˆæœƒè‡ªå‹•è®€é€²ä¸‹é¢æ–‡å­—æ¡†ï¼‰</label>
        <input id="srtFile" type="file" accept=".srt,text/plain" />
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn" id="btnReadSrt">è®€å– .srt æª”</button>
      <button class="btn" id="btnClearSrt">æ¸…ç©º</button>
      <span class="pill"><span class="dot" id="srtDot"></span><span id="srtInfo">å°šæœªè¼‰å…¥</span></span>
    </div>

    <div style="margin-top:10px">
      <label>è²¼ SRTï¼ˆæ”¯æ´ï¼š00:00:01,000 --> 00:00:03,000ï¼‰</label>
      <textarea id="srtText" placeholder="è²¼ä¸Š SRT å…§å®¹..."></textarea>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn" id="btnPreviewParse">Preview Parse</button>
      <button class="btn ok" id="btnInsertBeats">Insert Beats</button>
      <button class="btn ok" id="btnQueueThisJob">Queue This Job</button>
    </div>

    <div class="hint">
      âœ… ä½ è¦ã€Œä¸€æ”¯å®Œæ•´ mp4ã€ï¼šå°±è¦è®“é€™å€‹ job çš„ beats æ˜¯å®Œæ•´çš„ï¼ˆä¾‹å¦‚ 26 è¡Œå°±æ’å…¥ 26 beatsï¼‰ã€‚<br/>
      è‹¥åªæ’å…¥ 10 beatsï¼Œworker åªæœƒåˆæˆ 10 æ®µ â†’ output.mp4 çœ‹èµ·ä¾†åƒã€Œä¸€å°æ®µã€ã€‚
    </div>

    <div style="margin-top:10px">
      <label>è§£æçµæœï¼ˆåªè®€ï¼‰</label>
      <textarea id="parseOut" readonly placeholder="æŒ‰ Preview Parse æœƒé¡¯ç¤º beats..."></textarea>
    </div>
  </section>

  <!-- Jobs list -->
  <section class="card" style="grid-column:1/-1">
    <div class="row" style="justify-content:space-between; align-items:flex-end">
      <div>
        <h2 style="margin:0">Media Jobsï¼ˆæœ€è¿‘ 50 ç­†ï¼‰</h2>
        <div class="small">Auto refreshï¼š<span id="autoState" class="kbd">OFF</span></div>
      </div>
      <div class="row">
        <button class="btn" id="btnRefresh">Refresh</button>
        <button class="btn" id="btnToggleAuto">Toggle Auto</button>
        <select id="filterStatus" style="width:180px">
          <option value="">All status</option>
          <option value="pending">pending</option>
          <option value="queued">queued</option>
          <option value="processing">processing</option>
          <option value="done">done</option>
          <option value="failed">failed</option>
        </select>
        <input id="searchText" style="width:260px" placeholder="search slug/title/job_id..." />
      </div>
    </div>

    <div style="margin-top:10px">
      <table>
        <thead>
        <tr>
          <th style="width:260px">Job</th>
          <th style="width:120px">Status</th>
          <th style="width:240px">Progress</th>
          <th>Outputs</th>
          <th style="width:320px">Actions</th>
        </tr>
        </thead>
        <tbody id="jobsBody">
          <tr><td colspan="5" class="small" style="background:transparent;border:0;padding:14px 10px">å°šæœªè¼‰å…¥ã€‚</td></tr>
        </tbody>
      </table>
    </div>

    <div class="hint">
      âœ… æœ¬é ä¸ä¾è³´ä»»ä½•ã€Œç‰¹å®š output æ¬„ä½ã€ã€‚  
      æœƒå„ªå…ˆé¡¯ç¤ºï¼šoutput_zip_url / output_manifest_url / output_video_url / output_mp4_urlï¼ˆåªè¦ä½  DB æœ‰å“ªå€‹å°±é¡¯ç¤ºå“ªå€‹ï¼‰ã€‚
    </div>
  </section>
</div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // ---------- helpers ----------
  const $ = (id) => document.getElementById(id);
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  function isAbortError(e){
    return e?.name === "AbortError" || /aborterror/i.test(String(e?.message || e));
  }

  let _toastTimer = null;
  function toast(msg, kind="info"){
    const el = $("toast");
    if(!el) return;
    el.className = "toast " + kind;
    el.textContent = msg;
    el.style.display = "block";
    clearTimeout(_toastTimer);
    _toastTimer = setTimeout(()=>{ el.style.display="none"; }, 2600);
  }

  function uiError(e, prefix=""){
    if(isAbortError(e)) return; // âœ… AbortError éœé»˜
    const msg = (prefix? (prefix + "ï¼š") : "") + (e?.message || e);
    console.error(prefix || "Error", e);
    toast("âŒ " + msg, "bad");
  }

  async function retryOnce(fn){
    try { return await fn(); }
    catch(e){
      if(isAbortError(e)){
        await sleep(350);
        try { return await fn(); }
        catch(e2){ return { __abort:true, err:e2 }; }
      }
      throw e;
    }
  }

  // refresh lock (avoid overlapping refresh when auto ON)
  let _refreshing = false;

  const uuidRe = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;

  function setConn(connected, msg){
    $("connDot").className = "dot " + (connected ? "ok" : "");
    $("connText").textContent = msg || (connected ? "Connected" : "Not connected");
  }
  function setSrtState(ok, text){
    $("srtDot").className = "dot " + (ok ? "ok" : "");
    $("srtInfo").textContent = text || (ok ? "å·²è®€å–" : "å°šæœªè¼‰å…¥");
  }
  function esc(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // parse SRT: returns beats [{beat_index,start_ms,end_ms,line_text}]
  function parseSrtToBeats(srtText){
    const lines = (srtText || "").replaceAll("\r\n","\n").replaceAll("\r","\n").split("\n");
    const beats = [];
    let i = 0;
    const timeRe = /^(\d\d):(\d\d):(\d\d),(\d\d\d)\s*-->\s*(\d\d):(\d\d):(\d\d),(\d\d\d)/;

    function toMs(h,m,s,ms){
      return (((+h)*60 + (+m))*60 + (+s))*1000 + (+ms);
    }

    while(i < lines.length){
      const line = lines[i].trim();
      if(!line){ i++; continue; }

      // index line (optional)
      let idxLine = line;
      let timeLine = lines[i+1] ? lines[i+1].trim() : "";
      let hasIndex = /^\d+$/.test(idxLine) && timeRe.test(timeLine);
      if(hasIndex){
        i++;
      }
      const t = (lines[i] || "").trim();
      const m = t.match(timeRe);
      if(!m){ i++; continue; }

      const start_ms = toMs(m[1],m[2],m[3],m[4]);
      const end_ms   = toMs(m[5],m[6],m[7],m[8]);
      i++;

      // collect text until blank
      const texts = [];
      while(i < lines.length && lines[i].trim() !== ""){
        texts.push(lines[i].trim());
        i++;
      }
      const line_text = texts.join(" ").trim();
      if(line_text){
        beats.push({
          beat_index: beats.length + 1,
          start_ms,
          end_ms,
          line_text
        });
      }
      i++;
    }
    return beats;
  }

  // ---------- state ----------
  let supabase = null;
  let autoTimer = null;

  // ---------- storage ----------
  function saveSettings(){
    const o = {
      url: $("sbUrl").value.trim(),
      anon: $("sbAnon").value.trim(),
      bucket: $("sbBucket").value.trim() || "talk",
      workerId: $("workerId").value.trim() || ""
    };
    localStorage.setItem("media_jobs_settings", JSON.stringify(o));
  }
  function loadSettings(){
    try{
      const o = JSON.parse(localStorage.getItem("media_jobs_settings") || "{}");
      if(o.url) $("sbUrl").value = o.url;
      if(o.anon) $("sbAnon").value = o.anon;
      if(o.bucket) $("sbBucket").value = o.bucket;
      if(o.workerId) $("workerId").value = o.workerId;
    }catch{}
  }

  // ---------- supabase ops ----------
  function requireConn(){
    if(!supabase) throw new Error("Not connected. è«‹å…ˆæŒ‰ Connectã€‚");
  }

  async function connect(){
    const url = $("sbUrl").value.trim();
    const anon = $("sbAnon").value.trim();
    if(!url || !anon) throw new Error("è«‹å¡« SUPABASE_URL èˆ‡ SUPABASE_ANON_KEY");
    supabase = createClient(url, anon, { auth: { persistSession: false }});
    setConn(true, "Connected");
  }

  async function createJob({queue}){
    requireConn();
    const slug = $("jobSlug").value.trim();
    const category = $("jobCategory").value.trim();
    const title = $("jobTitle").value.trim();
    if(!slug) throw new Error("slug å¿…å¡«");
    if(!title) throw new Error("title å¿…å¡«");
    const status = queue ? "queued" : "pending";

    const payload = { slug, category, title, status, progress: 0, stage: "created" };
    const { data, error } = await supabase.from("media_jobs").insert(payload).select("*").single();
    if(error) throw error;

    // fill convenience
    $("beatsJobId").value = data.id;
    $("ctlJobId").value = data.id;

    alert(`âœ… Job å»ºç«‹æˆåŠŸ\njob_id = ${data.id}\n\nä¸‹ä¸€æ­¥ï¼šå³å´åŒ¯å…¥ SRT â†’ Insert Beats â†’ Queue`);
    await refreshJobs();
  }

  async function updateJobStatus(jobId, status, extra={}){
    requireConn();
    if(!uuidRe.test(jobId)) throw new Error("Job ID å¿…é ˆæ˜¯ uuidï¼ˆä¾‹å¦‚ fa5a...ï¼‰");
    const patch = { status, updated_at: new Date().toISOString(), ...extra };
    const { error } = await supabase.from("media_jobs").update(patch).eq("id", jobId);
    if(error) throw error;
    await refreshJobs();
  }

  async function queueThisJob(jobId){
    await updateJobStatus(jobId, "queued", { stage: "queued", error_code: null, error_message: null });
  }

  async function insertBeats(jobId, beats){
    requireConn();
    if(!uuidRe.test(jobId)) throw new Error("Job ID å¿…é ˆæ˜¯ uuidï¼ˆä¾‹å¦‚ fa5a...ï¼‰");
    if(!beats.length) throw new Error("æ²’æœ‰å¯æ’å…¥çš„ beatsï¼ˆå…ˆ Preview Parse çœ‹çœ‹ï¼‰");

    // build rows
    const rows = beats.map(b => ({
      job_id: jobId,
      beat_index: b.beat_index,
      start_ms: b.start_ms,
      end_ms: b.end_ms,
      line_text: b.line_text
    }));

    // chunk insert to avoid payload limit
    const CHUNK = 200;
    for(let i=0;i<rows.length;i+=CHUNK){
      const chunk = rows.slice(i, i+CHUNK);
      const { error } = await supabase.from("media_job_beats").insert(chunk);
      if(error) throw error;
      await sleep(120);
    }
  }

  function pickOutputs(row){
    const outs = [];
    const keys = ["output_zip_url","output_manifest_url","output_video_url","output_mp4_url"];
    for(const k of keys){
      if(row && row[k]) outs.push({k, url: row[k]});
    }
    return outs;
  }

  function statusDot(status){
    if(status === "done") return "ok";
    if(status === "failed") return "bad";
    if(status === "processing" || status === "queued") return "warn";
    return "";
  }

  async function refreshJobs(){
    requireConn();
    if(_refreshing) return;
    _refreshing = true;
    try{
      const status = $("filterStatus").value.trim();
      const q = $("searchText").value.trim().toLowerCase();

      let query = supabase.from("media_jobs")
        .select("*")
        .order("created_at", { ascending:false })
        .limit(50);

      if(status) query = query.eq("status", status);

      const r = await retryOnce(async()=> await query);
      if(r && r.__abort) return;
      const { data, error } = r;
      if(error) throw error;

      const rows = (data || []).filter(row=>{
        if(!q) return true;
        const hay = [
          row.id, row.slug, row.category, row.title,
          row.status, row.stage,
          row.error_code, row.error_message
        ].map(v => (v ?? "").toString().toLowerCase()).join(" | ");
        return hay.includes(q);
      });

      const body = $("jobsBody");
      if(!rows.length){
        body.innerHTML = `<tr><td colspan="5" class="small" style="background:transparent;border:0;padding:14px 10px">æŸ¥ç„¡è³‡æ–™ã€‚</td></tr>`;
        return;
      }

      body.innerHTML = rows.map(r=>{
        const dot = statusDot(r.status);
        const prog = Math.max(0, Math.min(100, Number(r.progress ?? 0)));
        const outs = pickOutputs(r).map(o=>`<a class="link" href="${esc(o.url)}" target="_blank">${esc(o.k)}</a>`).join(" Â· ");

        return `
          <tr>
            <td>
              <div class="row">
                <span class="dot ${dot}"></span>
                <div class="mono">${esc(r.id)}</div>
              </div>
              <div class="small muted">${esc(r.slug||"")} Â· ${esc(r.category||"")}</div>
              <div class="small">${esc(r.title||"")}</div>
            </td>
            <td>
              <div><b>${esc(r.status||"")}</b></div>
              <div class="small muted">${esc(r.stage||"")}</div>
              <div class="small">${outs ? ("è¼¸å‡ºï¼š"+outs) : ""}</div>
            </td>
            <td class="small">
              <div>${prog}%</div>
              <div class="bar"><span style="width:${prog}%"></span></div>
              <div class="small muted">${esc(r.worker_id||"")}</div>
            </td>
            <td class="small">
              <div class="muted">${esc(r.created_at||"")}</div>
              <div class="muted">${esc(r.updated_at||"")}</div>
            </td>
            <td class="small">
              ${r.error_code ? `<div class="bad"><b>${esc(r.error_code)}</b></div>` : ""}
              ${r.error_message ? `<div class="bad">${esc(r.error_message)}</div>` : ""}
              <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">
                <button class="mini" data-act="copy" data-id="${esc(r.id)}">Copy ID</button>
                <button class="mini" data-act="pause" data-id="${esc(r.id)}">Pause</button>
                <button class="mini" data-act="resume" data-id="${esc(r.id)}">Resume</button>
                <button class="mini danger" data-act="fail" data-id="${esc(r.id)}">Fail</button>
              </div>
            </td>
          </tr>
        `;
      }).join("");
    }catch(e){
      uiError(e, "Refresh å¤±æ•—");
    }finally{
      _refreshing = false;
    }
  }

  // ---------- UI wire ----------
  loadSettings();

  $("btnSave").onclick = () => { saveSettings(); alert("âœ… å·²ä¿å­˜"); };
  $("btnLoad").onclick = () => { loadSettings(); alert("âœ… å·²è¼‰å…¥"); };

  $("btnConnect").onclick = async () => {
    try{
      await connect();
      saveSettings();
      alert("âœ… Connected");
      await refreshJobs();
    }catch(e){
      console.error(e);
      uiError(e,"Connect å¤±æ•—");
      setConn(false, "Not connected");
      supabase = null;
    }
  };

  $("btnCreatePending").onclick = async ()=> {
    try{ await createJob({queue:false}); }catch(e){ console.error(e); uiError(e); }
  };
  $("btnCreateQueue").onclick = async ()=> {
    try{ await createJob({queue:true}); }catch(e){ console.error(e); uiError(e); }
  };

  $("btnPause").onclick = async ()=> {
    try{
      const id = $("ctlJobId").value.trim();
      await updateJobStatus(id, "pending", { stage: "paused(pending)" });
      alert("âœ… å·² Pauseï¼ˆstatus=pendingï¼‰");
    }catch(e){ console.error(e); uiError(e); }
  };
  $("btnResume").onclick = async ()=> {
    try{
      const id = $("ctlJobId").value.trim();
      await updateJobStatus(id, "queued", { stage: "resumed(queued)" });
      alert("âœ… å·² Resumeï¼ˆstatus=queuedï¼‰");
    }catch(e){ console.error(e); uiError(e); }
  };
  $("btnMarkFailed").onclick = async ()=> {
    try{
      const id = $("ctlJobId").value.trim();
      await updateJobStatus(id, "failed", { stage: "manual_failed", error_message: "manually marked failed" });
      alert("âœ… å·²æ¨™è¨˜ failed");
    }catch(e){ console.error(e); uiError(e); }
  };

  $("btnReadSrt").onclick = async ()=> {
    try{
      const f = $("srtFile").files?.[0];
      if(!f) throw new Error("è«‹å…ˆé¸æ“‡ .srt æª”");
      const text = await f.text();
      $("srtText").value = text;
      setSrtState(true, `å·²è®€å–æª”æ¡ˆï¼š${f.name}ï¼ˆ${Math.round(f.size/1024)} KBï¼‰`);
    }catch(e){ console.error(e); setSrtState(false, "å°šæœªè¼‰å…¥"); uiError(e); }
  };
  $("btnClearSrt").onclick = ()=> { $("srtText").value=""; $("parseOut").value=""; setSrtState(false, "å°šæœªè¼‰å…¥"); };

  $("btnPreviewParse").onclick = ()=> {
    try{
      const beats = parseSrtToBeats($("srtText").value);
      const preview = beats.slice(0, 30).map(b =>
        `${b.beat_index}. ${b.start_ms}~${b.end_ms}ms | ${b.line_text}`
      ).join("\n");
      $("parseOut").value = `beats = ${beats.length}\n\n` + preview + (beats.length>30 ? `\n\n...ï¼ˆåªé¡¯ç¤ºå‰ 30 ç­†ï¼‰` : "");
      setSrtState(true, `å·²è§£æ beatsï¼š${beats.length} ç­†`);
    }catch(e){ console.error(e); uiError(e); }
  };

  $("btnInsertBeats").onclick = async ()=> {
    try{
      requireConn();
      const jobId = $("beatsJobId").value.trim();
      const beats = parseSrtToBeats($("srtText").value);
      if(!beats.length) throw new Error("è§£æä¸åˆ° beatsï¼šè«‹ç¢ºèª SRT æ™‚é–“æ ¼å¼ (00:00:01,000 --> 00:00:03,000)");
      await insertBeats(jobId, beats);
      alert(`âœ… Insert Beats æˆåŠŸï¼š${beats.length} ç­†\n\nä¸‹ä¸€æ­¥ï¼šQueue This Job`);
      await refreshJobs();
    }catch(e){ console.error(e); uiError(e); }
  };

  $("btnQueueThisJob").onclick = async ()=> {
    try{
      const jobId = $("beatsJobId").value.trim();
      await queueThisJob(jobId);
      alert("âœ… å·² Queue");
    }catch(e){ console.error(e); uiError(e); }
  };

  $("btnRefresh").onclick = async ()=> {
    try{ await refreshJobs(); }catch(e){ console.error(e); uiError(e); }
  };
  $("btnToggleAuto").onclick = async ()=> {
    if(autoTimer){
      clearInterval(autoTimer);
      autoTimer = null;
      $("autoState").textContent = "OFF";
      return;
    }
    autoTimer = setInterval(()=> refreshJobs().catch(()=>{}), 3000);
    $("autoState").textContent = "ON";
  };

  $("filterStatus").onchange = ()=> refreshJobs().catch(()=>{});
  $("searchText").oninput = ()=> refreshJobs().catch(()=>{});

  $("jobsBody").addEventListener("click", async (ev)=>{
    const btn = ev.target.closest("button");
    if(!btn) return;
    const act = btn.getAttribute("data-act");
    const id = btn.getAttribute("data-id");
    try{
      if(act === "copy"){
        await navigator.clipboard.writeText(id);
        $("beatsJobId").value = id;
        $("ctlJobId").value = id;
        alert("âœ… å·²è¤‡è£½ job_idï¼Œä¸¦å¡«å…¥ä¸Šæ–¹æ¬„ä½");
        return;
      }
      if(act === "pause"){
        await updateJobStatus(id, "pending", { stage:"paused(pending)" });
        return;
      }
      if(act === "resume"){
        await updateJobStatus(id, "queued", { stage:"resumed(queued)" });
        return;
      }
      if(act === "fail"){
        await updateJobStatus(id, "failed", { stage:"manual_failed", error_message:"manually marked failed" });
        return;
      }
    }catch(e){
      console.error(e);
      uiError(e);
    }
  });

  // boot
  setConn(false, "Not connected");
  setSrtState(false, "å°šæœªè¼‰å…¥");
</script>
</body>
</html>



