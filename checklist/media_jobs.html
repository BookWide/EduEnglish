<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Media Jobs 控制台（Supabase + Worker）</title>
  <style>
    :root{
      --bg:#071326;
      --card:#0c1f3a;
      --card2:#0a1a33;
      --text:#eaf1ff;
      --muted:#a9c0e8;
      --line:rgba(255,255,255,.08);
      --btn:#1b3a66;
      --btn2:#214a86;
      --ok:#15c37b;
      --warn:#ffb020;
      --bad:#ff4d6d;
      --chip:rgba(255,255,255,.08);
      --shadow:0 12px 30px rgba(0,0,0,.35);
      --radius:18px;
      font-synthesis-weight:none;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans TC", "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background: radial-gradient(1000px 500px at 20% 0%, rgba(40,90,190,.25), transparent 60%),
                  radial-gradient(900px 600px at 70% 10%, rgba(0,220,180,.10), transparent 55%),
                  linear-gradient(180deg, #050c18, var(--bg));
      min-height:100vh;
    }
    header{
      padding:18px 18px 6px;
      max-width:1400px;
      margin:0 auto;
      display:flex;
      gap:12px;
      align-items:flex-end;
      justify-content:space-between;
    }
    .title{
      font-size:22px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .sub{
      color:var(--muted);
      font-size:12px;
      margin-top:4px;
    }
    .wrap{
      max-width:1400px;
      margin:0 auto;
      padding:14px 18px 28px;
      display:grid;
      grid-template-columns: 1.05fr .95fr 1.2fr;
      gap:14px;
    }
    @media (max-width: 1100px){
      .wrap{grid-template-columns:1fr; }
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), transparent);
      border-bottom:1px solid var(--line);
    }
    .card .hd .h{
      font-weight:800;
      letter-spacing:.2px;
    }
    .card .bd{ padding:14px; }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:10px 0 6px;
    }
    input, select, textarea{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.2);
      color:var(--text);
      outline:none;
    }
    textarea{ min-height:150px; resize:vertical; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .row{ display:flex; gap:10px; }
    .row > *{ flex:1; }
    .btnrow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:700;
      letter-spacing:.2px;
    }
    button.primary{ background: linear-gradient(180deg, rgba(33,74,134,.9), rgba(27,58,102,.7)); border-color: rgba(130,170,255,.25); }
    button.ok{ background: linear-gradient(180deg, rgba(21,195,123,.35), rgba(21,195,123,.18)); border-color: rgba(21,195,123,.4); }
    button.warn{ background: linear-gradient(180deg, rgba(255,176,32,.25), rgba(255,176,32,.12)); border-color: rgba(255,176,32,.35); }
    button.bad{ background: linear-gradient(180deg, rgba(255,77,109,.25), rgba(255,77,109,.12)); border-color: rgba(255,77,109,.35); }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px;
      border-radius:999px;
      background:var(--chip);
      border:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
    }
    .note{
      margin-top:10px;
      padding:10px 12px;
      border:1px dashed rgba(255,255,255,.16);
      border-radius:14px;
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
      background: rgba(0,0,0,.14);
    }
    .tableWrap{
      grid-column: 1 / -1;
    }
    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.12);
    }
    .toolbar .left, .toolbar .right{ display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .toolbar input, .toolbar select{
      width:auto;
      min-width:220px;
      padding:9px 10px;
      border-radius:12px;
    }
    .toolbar select{ min-width:170px; }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    thead th{
      text-align:left;
      padding:10px 12px;
      color:var(--muted);
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.10);
      position:sticky;
      top:0;
    }
    tbody td{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      vertical-align:top;
    }
    .status{
      font-weight:800;
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      display:inline-block;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
    }
    .s_pending{ color:#d7e8ff; }
    .s_queued{ color:#9fd5ff; }
    .s_processing{ color:#ffd48b; }
    .s_done{ color:#6ff0b1; }
    .s_failed{ color:#ff7d93; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .small{ font-size:12px; color:var(--muted); }
    .links a{ color:#b8d6ff; text-decoration:none; }
    .links a:hover{ text-decoration:underline; }
    .progress{
      height:10px;
      background:rgba(255,255,255,.08);
      border:1px solid var(--line);
      border-radius:999px;
      overflow:hidden;
      min-width:140px;
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(21,195,123,.75), rgba(100,190,255,.75));
    }
    .err{
      color:#ff9bb0;
      white-space:pre-wrap;
      max-width:520px;
    }
    .okmsg{ color:#9ef3c7; }
  </style>
</head>
<body>
<header>
  <div>
    <div class="title">Media Jobs 控制台（Supabase + Worker）</div>
    <div class="sub">不用 SQL：建立 job → 匯入 SRT/Beats → Queue → worker 自動生圖/打包/合成</div>
  </div>
  <div class="pill" id="pillConn">Not connected</div>
</header>

<section class="wrap">
  <!-- Connect -->
  <div class="card">
    <div class="hd">
      <div class="h">連線設定（只需一次）</div>
      <div class="pill">LocalStorage</div>
    </div>
    <div class="bd">
      <label>SUPABASE_URL</label>
      <input id="sbUrl" placeholder="https://xxxx.supabase.co" />
      <label>SUPABASE_ANON_KEY</label>
      <input id="sbAnon" placeholder="eyJhbGci..." />
      <div class="row">
        <div>
          <label>Storage Bucket（顯示用）</label>
          <input id="sbBucket" placeholder="talk" />
        </div>
        <div>
          <label>Worker ID（顯示用）</label>
          <input id="workerId" placeholder="LIN-SUKHUAN" />
        </div>
      </div>
      <div class="btnrow">
        <button class="primary" id="btnConnect">Connect</button>
        <button id="btnSave">Save</button>
        <button id="btnLoad">Load</button>
      </div>

      <div class="note">
        暫停功能：因為你 DB 的 <span class="mono">media_jobs_status_check</span> 不允許 <span class="mono">paused</span>。<br/>
        所以本頁採用：<b>Pause = pending</b> / <b>Resume = queued</b>（完全不用 SQL）。
      </div>
    </div>
  </div>

  <!-- Create Job -->
  <div class="card">
    <div class="hd">
      <div class="h">建立 Job</div>
      <div class="pill">media_jobs</div>
    </div>
    <div class="bd">
      <div class="row">
        <div>
          <label>slug</label>
          <input id="jobSlug" placeholder="stress-10beats-001" />
        </div>
        <div>
          <label>category</label>
          <select id="jobCategory">
            <option value="story">story</option>
            <option value="movie">movie</option>
            <option value="music">music</option>
            <option value="edu">edu</option>
            <option value="other">other</option>
          </select>
        </div>
      </div>
      <label>title</label>
      <input id="jobTitle" placeholder="Stress Test 10 Beats" />
      <div class="btnrow">
        <button class="primary" id="btnCreatePending">Create Job (pending)</button>
        <button class="ok" id="btnCreateQueue">Create + Queue</button>
      </div>
      <div class="note" id="createNote">建立後會回傳 job_id，把它貼到右邊「Job ID」再匯入 SRT。</div>
    </div>
  </div>

  <!-- SRT / Beats -->
  <div class="card">
    <div class="hd">
      <div class="h">SRT / Beats 匯入</div>
      <div class="pill">media_job_beats</div>
    </div>
    <div class="bd">
      <label>Job ID（要匯入到哪一筆）</label>
      <input id="beatsJobId" placeholder="貼 job_id（uuid）" />

      <label>選擇 .srt 檔（可選）</label>
      <input id="srtFile" type="file" accept=".srt,text/plain" />
      <div class="btnrow" style="margin-top:8px">
        <button id="btnReadSrt">讀取 .srt 檔</button>
        <button class="bad" id="btnClearSrt">清空</button>
      </div>

      <label>貼 SRT（支援標準：00:00:01,000 --> 00:00:03,000）</label>
      <textarea id="srtText" placeholder="貼上整份 SRT..."></textarea>

      <div class="btnrow">
        <button class="primary" id="btnPreview">Preview Parse</button>
        <button class="ok" id="btnInsertBeats">Insert Beats</button>
        <button class="ok" id="btnQueueJob">Queue This Job</button>
      </div>

      <div class="note" id="parseNote">尚未解析。</div>
    </div>
  </div>

  <!-- Table -->
  <div class="card tableWrap">
    <div class="hd">
      <div class="h">Media Jobs（最近 50 筆）</div>
      <div class="pill" id="autoPill">Auto refresh: OFF</div>
    </div>
    <div class="toolbar">
      <div class="left">
        <button id="btnRefresh">Refresh</button>
        <button id="btnToggleAuto">Toggle Auto</button>
      </div>
      <div class="right">
        <select id="filterStatus">
          <option value="">All status</option>
          <option value="pending">pending</option>
          <option value="queued">queued</option>
          <option value="processing">processing</option>
          <option value="done">done</option>
          <option value="failed">failed</option>
        </select>
        <input id="searchBox" placeholder="search slug/title/job_id..." />
      </div>
    </div>
    <div style="max-height:520px; overflow:auto;">
      <table>
        <thead>
          <tr>
            <th style="width:290px;">Job</th>
            <th style="width:120px;">Status</th>
            <th style="width:220px;">Progress</th>
            <th>Outputs</th>
            <th style="width:280px;">Actions</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="5" class="small">尚未載入。</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // ---------- state ----------
  let supabase = null;
  let autoTimer = null;
  let lastParsedBeats = [];

  const el = (id)=>document.getElementById(id);

  function setConn(ok, msg){
    const pill = el("pillConn");
    pill.textContent = msg;
    pill.style.color = ok ? "#9ef3c7" : "";
    pill.style.borderColor = ok ? "rgba(21,195,123,.45)" : "rgba(255,255,255,.12)";
    pill.style.background = ok ? "rgba(21,195,123,.12)" : "rgba(255,255,255,.08)";
  }

  function saveCfg(){
    const cfg = {
      url: el("sbUrl").value.trim(),
      anon: el("sbAnon").value.trim(),
      bucket: el("sbBucket").value.trim() || "talk",
      workerId: el("workerId").value.trim() || "WORKER"
    };
    localStorage.setItem("MEDIA_JOBS_CFG", JSON.stringify(cfg));
    return cfg;
  }
  function loadCfg(){
    const raw = localStorage.getItem("MEDIA_JOBS_CFG");
    if(!raw) return null;
    try{ return JSON.parse(raw); }catch{ return null; }
  }
  function applyCfg(cfg){
    if(!cfg) return;
    el("sbUrl").value = cfg.url || "";
    el("sbAnon").value = cfg.anon || "";
    el("sbBucket").value = cfg.bucket || "talk";
    el("workerId").value = cfg.workerId || "WORKER";
  }

  function msToSrt(ms){
    const h = String(Math.floor(ms/3600000)).padStart(2,"0");
    const m = String(Math.floor((ms%3600000)/60000)).padStart(2,"0");
    const s = String(Math.floor((ms%60000)/1000)).padStart(2,"0");
    const z = String(ms%1000).padStart(3,"0");
    return `${h}:${m}:${s},${z}`;
  }
  function srtTimeToMs(t){
    // 00:00:01,000
    const m = t.trim().match(/^(\d+):(\d+):(\d+)[,.](\d+)$/);
    if(!m) return null;
    const hh = parseInt(m[1],10), mm = parseInt(m[2],10), ss = parseInt(m[3],10), ms = parseInt(m[4].padEnd(3,"0").slice(0,3),10);
    return hh*3600000 + mm*60000 + ss*1000 + ms;
  }

  function parseSrtToBeats(srt){
    // tolerant parser: blocks separated by blank lines
    const text = (srt||"").replace(/\r/g,"").trim();
    if(!text) return [];
    const blocks = text.split(/\n{2,}/g);
    const beats = [];
    for(const block of blocks){
      const lines = block.split("\n").map(l=>l.trim()).filter(Boolean);
      if(lines.length < 2) continue;

      // possible formats:
      // 1) index
      // 2) time
      // 3+) text lines
      let timeLineIdx = 0;
      if(/^\d+$/.test(lines[0]) && lines[1]?.includes("-->")) timeLineIdx = 1;
      const timeLine = lines[timeLineIdx];
      const m = timeLine.match(/(.+?)\s*-->\s*(.+)/);
      if(!m) continue;

      const start = srtTimeToMs(m[1]);
      const end = srtTimeToMs(m[2].split(" ")[0]); // ignore trailing cues
      if(start==null || end==null) continue;

      const textLines = lines.slice(timeLineIdx+1);
      const lineText = textLines.join(" ").replace(/\s+/g," ").trim();
      if(!lineText) continue;

      beats.push({ start_ms:start, end_ms:end, line_text: lineText });
    }

    // assign beat_index 1..n
    beats.sort((a,b)=>a.start_ms-b.start_ms);
    return beats.map((b,i)=>({ ...b, beat_index:i+1 }));
  }

  function statusClass(s){
    const v = (s||"").toLowerCase();
    if(v==="pending") return "s_pending";
    if(v==="queued") return "s_queued";
    if(v==="processing") return "s_processing";
    if(v==="done") return "s_done";
    if(v==="failed") return "s_failed";
    return "";
  }

  function safeUrl(u){
    if(!u) return "";
    try{
      // allow absolute
      const x = new URL(u);
      return x.toString();
    }catch{
      return "";
    }
  }

  function renderOutputs(row){
    // show whichever columns exist
    const links = [];
    const candidates = [
      ["MP4", row.output_mp4_url],
      ["MP4", row.output_video_url],
      ["MP4", row.output_url],
      ["ZIP", row.output_zip_url],
      ["Manifest", row.output_manifest_url],
    ];
    const seen = new Set();
    for(const [label,url] of candidates){
      const u = safeUrl(url);
      if(!u) continue;
      const key = label+"|"+u;
      if(seen.has(key)) continue;
      seen.add(key);
      links.push(`<a href="${u}" target="_blank" rel="noreferrer">${label}</a>`);
    }
    if(!links.length) return `<span class="small">—</span>`;
    return `<span class="links">${links.join(" · ")}</span>`;
  }

  async function connect(){
    const cfg = saveCfg();
    if(!cfg.url || !cfg.anon){
      setConn(false, "Missing URL/ANON");
      alert("請先填 SUPABASE_URL / SUPABASE_ANON_KEY");
      return;
    }

    // IMPORTANT: only create ONE client
    supabase = createClient(cfg.url, cfg.anon, {
      auth: { persistSession: false, autoRefreshToken: false, detectSessionInUrl: false }
    });

    // quick check
    const { error } = await supabase.from("media_jobs").select("id").limit(1);
    if(error){
      console.error(error);
      setConn(false, "Connect failed");
      alert("Connect 失敗：\n" + (error.message || JSON.stringify(error)));
      return;
    }
    setConn(true, "Connected");
    await refreshJobs();
  }

  async function createJob(status){
    if(!supabase){ alert("請先 Connect"); return; }
    const slug = el("jobSlug").value.trim();
    const category = el("jobCategory").value;
    const title = el("jobTitle").value.trim();
    if(!slug || !title){ alert("slug/title 需要填"); return; }

    const payload = {
      slug, category, title,
      status, progress: 0,
      stage: null,
      error_code: null,
      error_message: null
    };

    const { data, error } = await supabase.from("media_jobs")
      .insert(payload)
      .select("*")
      .single();

    if(error){
      console.error(error);
      alert("Create job 失敗：\n"+(error.message || JSON.stringify(error)));
      return;
    }
    el("createNote").innerHTML = `<span class="okmsg">✅ 已建立 job：<span class="mono">${data.id}</span></span>`;
    el("beatsJobId").value = data.id;
    await refreshJobs();
  }

  async function updateJobStatus(jobId, status){
    if(!supabase){ alert("請先 Connect"); return; }
    const { error } = await supabase.from("media_jobs")
      .update({ status })
      .eq("id", jobId);
    if(error){
      console.error(error);
      alert(`更新狀態失敗：${error.message || JSON.stringify(error)}`);
      return;
    }
    await refreshJobs();
  }

  async function markFailed(jobId){
    if(!supabase){ alert("請先 Connect"); return; }
    const { error } = await supabase.from("media_jobs")
      .update({ status:"failed", error_message:"marked failed by admin", error_code:"ADMIN_MARK_FAILED" })
      .eq("id", jobId);
    if(error){
      console.error(error);
      alert(`Mark failed 失敗：${error.message || JSON.stringify(error)}`);
      return;
    }
    await refreshJobs();
  }

  async function insertBeats(){
    if(!supabase){ alert("請先 Connect"); return; }
    const jobId = el("beatsJobId").value.trim();
    if(!jobId){ alert("請填 Job ID"); return; }

    if(!lastParsedBeats.length){
      // parse now
      lastParsedBeats = parseSrtToBeats(el("srtText").value);
    }
    if(!lastParsedBeats.length){
      alert("沒有 beats，先 Preview Parse");
      return;
    }

    // delete existing beats for job, then insert fresh
    // NOTE: delete needs RLS allow. If your RLS blocks delete, comment it out.
    await supabase.from("media_job_beats").delete().eq("job_id", jobId);

    const rows = lastParsedBeats.map(b=>({
      job_id: jobId,
      beat_index: b.beat_index,
      start_ms: b.start_ms,
      end_ms: b.end_ms,
      line_text: b.line_text
    }));

    const { error } = await supabase.from("media_job_beats").insert(rows);
    if(error){
      console.error(error);
      alert("Insert beats 失敗：\n"+(error.message || JSON.stringify(error)));
      return;
    }
    el("parseNote").innerHTML = `<span class="okmsg">✅ 已寫入 beats：${rows.length} 筆（job_id=${jobId}）</span>`;
  }

  async function refreshJobs(){
    if(!supabase){
      el("tbody").innerHTML = `<tr><td colspan="5" class="small">尚未 Connect。</td></tr>`;
      return;
    }

    const st = el("filterStatus").value;
    const q = el("searchBox").value.trim().toLowerCase();

    // IMPORTANT: use select('*') to avoid missing column crash (e.g. output_mp4_url)
    let query = supabase.from("media_jobs")
      .select("*")
      .order("created_at", { ascending:false })
      .limit(50);

    if(st) query = query.eq("status", st);

    const { data, error } = await query;
    if(error){
      console.error(error);
      el("tbody").innerHTML = `<tr><td colspan="5" class="err">Load failed: ${error.message || JSON.stringify(error)}</td></tr>`;
      return;
    }

    let rows = data || [];
    if(q){
      rows = rows.filter(r=>{
        const s = `${r.id||""} ${r.slug||""} ${r.title||""}`.toLowerCase();
        return s.includes(q);
      });
    }

    if(!rows.length){
      el("tbody").innerHTML = `<tr><td colspan="5" class="small">沒有資料。</td></tr>`;
      return;
    }

    el("tbody").innerHTML = rows.map(r=>{
      const p = Math.max(0, Math.min(100, Number(r.progress ?? 0)));
      const stage = r.stage ? `<div class="small">${r.stage}</div>` : "";
      const err = (r.error_message || r.error || "").toString().trim();
      const errHtml = err ? `<div class="err small">${err}</div>` : "";
      const created = r.created_at ? new Date(r.created_at).toLocaleString() : "";
      const jobTitle = (r.title || "").toString();
      const jobSlug = (r.slug || "").toString();
      const jobId = r.id;

      return `
        <tr>
          <td>
            <div><b>${jobTitle || "(no title)"}</b></div>
            <div class="small mono">${jobId}</div>
            <div class="small">slug: <span class="mono">${jobSlug}</span></div>
            <div class="small">created: ${created}</div>
          </td>
          <td>
            <span class="status ${statusClass(r.status)}">${r.status || "-"}</span>
            ${stage}
          </td>
          <td>
            <div style="display:flex; gap:10px; align-items:center;">
              <div class="progress"><div class="bar" style="width:${p}%;"></div></div>
              <div class="mono small">${p}%</div>
            </div>
            ${errHtml}
          </td>
          <td>${renderOutputs(r)}</td>
          <td>
            <div class="btnrow" style="margin:0">
              <button class="warn" data-act="pause" data-id="${jobId}">Pause (pending)</button>
              <button class="ok" data-act="resume" data-id="${jobId}">Resume (queued)</button>
              <button data-act="copy" data-id="${jobId}">Copy ID</button>
              <button class="bad" data-act="fail" data-id="${jobId}">Mark failed</button>
            </div>
          </td>
        </tr>
      `;
    }).join("");
  }

  function toggleAuto(){
    const pill = el("autoPill");
    if(autoTimer){
      clearInterval(autoTimer);
      autoTimer = null;
      pill.textContent = "Auto refresh: OFF";
      pill.style.color = "";
      return;
    }
    autoTimer = setInterval(refreshJobs, 5000);
    pill.textContent = "Auto refresh: ON (5s)";
    pill.style.color = "#9ef3c7";
  }

  // ---------- SRT file read ----------
  async function readSrtFile(){
    const f = el("srtFile").files?.[0];
    if(!f){ alert("請先選檔"); return; }
    const text = await f.text();
    el("srtText").value = text;
    el("parseNote").textContent = `已讀取檔案：${f.name}（${Math.round(f.size/1024)} KB）`;
  }

  function previewParse(){
    lastParsedBeats = parseSrtToBeats(el("srtText").value);
    if(!lastParsedBeats.length){
      el("parseNote").innerHTML = `<span class="err">解析失敗：沒有抓到任何 SRT 區塊（請確認時間格式）。</span>`;
      return;
    }
    // show first few
    const sample = lastParsedBeats.slice(0, 5).map(b=>{
      return `${b.beat_index}. ${msToSrt(b.start_ms)} → ${msToSrt(b.end_ms)}\n${b.line_text}`;
    }).join("\n\n");
    el("parseNote").innerHTML =
      `<span class="okmsg">✅ 解析成功：${lastParsedBeats.length} beats</span><br/><pre class="small mono" style="white-space:pre-wrap; margin:8px 0 0;">${escapeHtml(sample)}</pre>`;
  }

  function escapeHtml(s){
    return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  async function queueThisJob(){
    const jobId = el("beatsJobId").value.trim();
    if(!jobId){ alert("請填 Job ID"); return; }
    await updateJobStatus(jobId, "queued");
    el("parseNote").innerHTML = `<span class="okmsg">✅ 已 Queue：${jobId}</span>`;
  }

  // ---------- wire up ----------
  el("btnSave").addEventListener("click", ()=>{ saveCfg(); alert("Saved"); });
  el("btnLoad").addEventListener("click", ()=>{ applyCfg(loadCfg()); });
  el("btnConnect").addEventListener("click", connect);

  el("btnCreatePending").addEventListener("click", ()=>createJob("pending"));
  el("btnCreateQueue").addEventListener("click", ()=>createJob("queued"));

  el("btnReadSrt").addEventListener("click", readSrtFile);
  el("btnClearSrt").addEventListener("click", ()=>{
    el("srtText").value = "";
    lastParsedBeats = [];
    el("parseNote").textContent = "已清空。";
  });

  el("btnPreview").addEventListener("click", previewParse);
  el("btnInsertBeats").addEventListener("click", insertBeats);
  el("btnQueueJob").addEventListener("click", queueThisJob);

  el("btnRefresh").addEventListener("click", refreshJobs);
  el("btnToggleAuto").addEventListener("click", toggleAuto);

  el("filterStatus").addEventListener("change", refreshJobs);
  el("searchBox").addEventListener("input", ()=>{ setTimeout(refreshJobs, 150); });

  el("tbody").addEventListener("click", async (e)=>{
    const btn = e.target.closest("button");
    if(!btn) return;
    const act = btn.dataset.act;
    const id = btn.dataset.id;
    if(!act || !id) return;

    if(act==="pause") return updateJobStatus(id, "pending");
    if(act==="resume") return updateJobStatus(id, "queued");
    if(act==="fail") return markFailed(id);
    if(act==="copy"){
      await navigator.clipboard.writeText(id);
      alert("copied: " + id);
      el("beatsJobId").value = id;
      return;
    }
  });

  // ---------- init ----------
  (function init(){
    applyCfg(loadCfg());
  })();
</script>
</body>
</html>

