<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Media Jobs 控制台</title>
  <style>
    :root{
      --bg:#071225; --card:#0b1a33;
      --line:rgba(255,255,255,.08); --txt:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62); --muted2:rgba(255,255,255,.45);
      --brand:#33d6a6; --warn:#f7c948; --bad:#ff6b6b; --ok:#3ddc84;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --r:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--txt);
      background:radial-gradient(1200px 600px at 30% 10%, rgba(51,214,166,.12), transparent 60%),
                 radial-gradient(1000px 700px at 80% 30%, rgba(60,120,255,.10), transparent 55%),
                 var(--bg);
      padding:18px;
    }
    .wrap{max-width:1280px; margin:0 auto;}
    h1{font-size:18px; margin:0 0 12px 0; color:rgba(255,255,255,.9)}
    .grid3{display:grid; grid-template-columns: 1fr 1fr 1.2fr; gap:14px;}
    @media (max-width:1100px){ .grid3{grid-template-columns:1fr;} }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:14px;
      min-height:140px;
    }
    .card h2{font-size:14px; margin:0 0 10px 0; color:rgba(255,255,255,.85)}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input, select, textarea{
      width:100%;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--txt);
      padding:10px 12px;
      outline:none;
    }
    textarea{min-height:190px; font-family:var(--mono); font-size:12px; line-height:1.35}
    input::placeholder, textarea::placeholder{color:rgba(255,255,255,.35)}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .btnrow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    button{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(16,38,74,.85), rgba(9,22,43,.85));
      color:var(--txt);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition:transform .05s ease, filter .15s ease;
    }
    button:hover{filter:brightness(1.08)}
    button:active{transform:translateY(1px)}
    .primary{
      border-color:rgba(51,214,166,.35);
      background:linear-gradient(180deg, rgba(51,214,166,.20), rgba(16,38,74,.85));
    }
    .danger{
      border-color:rgba(255,107,107,.35);
      background:linear-gradient(180deg, rgba(255,107,107,.18), rgba(16,38,74,.85));
    }
    .ghost{ background:rgba(0,0,0,.15); }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border:1px solid var(--line);
      border-radius:999px; background:rgba(0,0,0,.16);
      font-size:12px; color:var(--muted);
    }
    .note{
      margin-top:10px; font-size:12px; color:var(--muted); line-height:1.4;
      border-top:1px dashed rgba(255,255,255,.08); padding-top:10px;
    }
    .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)}
    .muted2{color:var(--muted2)}
    .hr{height:1px; background:rgba(255,255,255,.08); margin:12px 0}
    .tablewrap{
      margin-top:14px; background:rgba(0,0,0,.16);
      border:1px solid var(--line); border-radius:var(--r); overflow:hidden;
    }
    .toolbar{
      display:flex; gap:10px; align-items:center; padding:10px;
      border-bottom:1px solid rgba(255,255,255,.08); flex-wrap:wrap;
    }
    .toolbar .spacer{flex:1}
    .toolbar input{max-width:320px}
    table{width:100%; border-collapse:collapse; font-size:12px}
    th, td{padding:10px; border-bottom:1px solid rgba(255,255,255,.06); vertical-align:top}
    th{color:rgba(255,255,255,.70); text-align:left; font-weight:600; background:rgba(255,255,255,.03)}
    tr:hover td{background:rgba(255,255,255,.02)}
    .mono{font-family:var(--mono)}
    .small{font-size:11px}

    .status{
      display:inline-flex; align-items:center; gap:6px; padding:5px 8px;
      border-radius:999px; border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      font-size:11px; color:rgba(255,255,255,.75);
    }
    .dot{width:7px; height:7px; border-radius:50%}
    .s_pending .dot{background:#9aa6b2}
    .s_queued .dot{background:#5aa7ff}
    .s_processing .dot{background:#f7c948}
    .s_done .dot{background:#3ddc84}
    .s_failed .dot{background:#ff6b6b}

    .progress{
      width:140px; height:8px; border-radius:999px;
      background:rgba(255,255,255,.08); overflow:hidden; border:1px solid rgba(255,255,255,.08);
    }
    .bar{height:100%; width:0%; background:rgba(51,214,166,.85)}
    .links a{color:rgba(51,214,166,.95); text-decoration:none}
    .links a:hover{text-decoration:underline}
    .hint{font-size:12px; color:rgba(255,255,255,.58); margin-top:6px}
    .fileRow{display:flex; gap:10px; align-items:center; margin-top:10px; flex-wrap:wrap}
    .fileRow input[type="file"]{max-width:360px; padding:8px 10px}
    .k{
      display:inline-block; padding:2px 6px; border:1px solid rgba(255,255,255,.14);
      border-radius:8px; font-family:var(--mono); font-size:11px; color:rgba(255,255,255,.68)
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Media Jobs 控制台（Supabase + Worker）</h1>

    <div class="grid3">
      <!-- Connect -->
      <div class="card">
        <h2>連線設定（只需一次）</h2>

        <div class="row">
          <div>
            <label>SUPABASE_URL</label>
            <input id="sbUrl" placeholder="https://xxxx.supabase.co" />
          </div>
          <div>
            <label>SUPABASE_ANON_KEY</label>
            <input id="sbAnon" placeholder="eyJhbGciOi..." />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Storage Bucket（顯示用）</label>
            <input id="bucket" placeholder="talk" value="talk" />
          </div>
          <div>
            <label>Worker ID（顯示用）</label>
            <input id="workerId" placeholder="LIN-SUKHUAN" value="LIN-SUKHUAN" />
          </div>
        </div>

        <div class="btnrow">
          <button class="primary" id="btnConnect">Connect</button>
          <button id="btnSave">Save</button>
          <button id="btnLoad">Load</button>
          <span class="pill" id="connState">Not connected</span>
        </div>

        <div class="note">
          暫停功能：你的 DB 的 <span class="k">media_jobs_status_check</span> 不允許 <span class="k">paused</span>。<br/>
          所以本頁採用：<span class="k">Pause = pending</span> / <span class="k">Resume = queued</span>（完全不用 SQL）。
        </div>
      </div>

      <!-- Create Job -->
      <div class="card">
        <h2>建立 Job</h2>

        <div class="row">
          <div>
            <label>slug</label>
            <input id="jobSlug" placeholder="stress-10beats-001" />
          </div>
          <div>
            <label>category</label>
            <select id="jobCategory">
              <option value="story">story</option>
              <option value="movie">movie</option>
              <option value="music">music</option>
              <option value="ads">ads</option>
            </select>
          </div>
        </div>

        <label>title</label>
        <input id="jobTitle" placeholder="Stress Test 10 Beats" />

        <div class="btnrow">
          <button id="btnCreatePending">Create Job (pending)</button>
          <button class="primary" id="btnCreateQueue">Create + Queue</button>
        </div>

        <div class="note" id="createInfo">建立後會回傳 job_id，你接著在右邊把 SRT 匯入成 beats。</div>

        <div class="hr"></div>

        <h2>快速控制（不用 SQL）</h2>
        <label>Job ID</label>
        <input id="ctlJobId" placeholder="貼 job_id（uuid）" />
        <div class="btnrow">
          <button class="ghost" id="btnPause">Pause（pending）</button>
          <button class="primary" id="btnResume">Resume（queued）</button>
          <button class="danger" id="btnFail">Mark failed</button>
        </div>
        <div class="hint muted2">⚠️ Pause 是把 job 改回 pending，worker 就不會再 claim 它（不是硬停正在跑的 ffmpeg）。</div>
      </div>

      <!-- SRT/Beats -->
      <div class="card">
        <h2>SRT / Beats 匯入</h2>

        <label>Job ID（要匯入到哪一筆）</label>
        <input id="beatsJobId" placeholder="貼 job_id（uuid）" />

        <div class="fileRow">
          <input id="srtFile" type="file" accept=".srt,text/plain" />
          <button id="btnLoadSrt" class="ghost">讀取 .srt 檔</button>
          <button id="btnClearSrt" class="ghost">清空</button>
        </div>

        <label>貼 SRT（支援標準：00:00:01,000 --> 00:00:03,000）</label>
        <textarea id="srtText" placeholder="1&#10;00:00:00,000 --> 00:00:03,000&#10;A lion stands in the forest.&#10;&#10;2&#10;00:00:03,000 --> 00:00:06,000&#10;A rabbit watches from the bushes."></textarea>

        <div class="btnrow">
          <button id="btnPreview" class="ghost">Preview Parse</button>
          <button id="btnInsert" class="primary">Insert Beats</button>
          <button id="btnQueue" class="primary">Queue This Job</button>
        </div>

        <div class="note" id="previewBox">尚未解析。</div>
      </div>
    </div>

    <!-- Table -->
    <div class="tablewrap">
      <div class="toolbar">
        <div class="pill">Media Jobs（最近 50 筆）</div>
        <button id="btnRefresh">Refresh</button>
        <button id="btnToggleAuto">Auto refresh: OFF</button>
        <div class="spacer"></div>

        <select id="filterStatus" style="max-width:180px">
          <option value="">All status</option>
          <option value="pending">pending</option>
          <option value="queued">queued</option>
          <option value="processing">processing</option>
          <option value="done">done</option>
          <option value="failed">failed</option>
        </select>

        <input id="searchBox" placeholder="search slug/title/job_id..." />
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:280px">Job</th>
            <th style="width:120px">Status</th>
            <th style="width:200px">Progress</th>
            <th>Outputs</th>
            <th style="width:240px">Actions</th>
          </tr>
        </thead>
        <tbody id="jobsBody">
          <tr><td colspan="5" class="muted2">尚未載入。</td></tr>
        </tbody>
      </table>
    </div>

    <div class="note" style="margin-top:14px">
      建議輸出固定：<span class="k">talk/jobs/&lt;job_id&gt;/1.png..N.png</span>、<span class="k">manifest.json</span>、<span class="k">output.mp4</span>、<span class="k">output.zip</span>。<br/>
      這樣後台永遠只看 job_id 就能抓到成果。
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // ---------- helpers ----------
    const $ = (id) => document.getElementById(id);

    function safeText(v){ return (v === null || v === undefined) ? "" : String(v); }

    function setConnState(ok, msg){
      const el = $("connState");
      el.textContent = msg;
      el.style.borderColor = ok ? "rgba(61,220,132,.25)" : "rgba(255,107,107,.25)";
      el.style.color = ok ? "rgba(61,220,132,.95)" : "rgba(255,255,255,.62)";
    }

    function pct(n){
      const v = Number(n);
      if(!Number.isFinite(v)) return 0;
      return Math.max(0, Math.min(100, v));
    }

    function msFromSrtTime(t){
      // HH:MM:SS,mmm or HH:MM:SS.mmm
      const m = t.trim().match(/^(\d+):(\d+):(\d+)[,.](\d+)$/);
      if(!m) return null;
      const hh = Number(m[1]), mm = Number(m[2]), ss = Number(m[3]);
      const ms = Number((m[4] + "000").slice(0,3));
      return ((hh*60+mm)*60+ss)*1000 + ms;
    }

    function parseSrt(srt){
      const text = srt.replace(/\r/g, "").trim();
      if(!text) return [];
      const blocks = text.split(/\n{2,}/);
      const beats = [];
      let idx = 1;

      for(let bi=0; bi<blocks.length; bi++){
        const lines = blocks[bi].split("\n").map(x => x.trimEnd());
        if(lines.length < 2) continue;

        let timeLine = "";
        let textStartAt = 0;

        if(/^\d+$/.test(lines[0]) && lines[1].includes("-->")){
          timeLine = lines[1];
          textStartAt = 2;
        }else if(lines[0].includes("-->")){
          timeLine = lines[0];
          textStartAt = 1;
        }else{
          continue;
        }

        const tm = timeLine.match(/^(.+?)\s*-->\s*(.+?)$/);
        if(!tm) continue;

        const start = msFromSrtTime(tm[1]);
        const endRaw = tm[2].split(/\s+/)[0];
        const end = msFromSrtTime(endRaw);

        if(start === null || end === null) continue;

        const txt = lines.slice(textStartAt).join(" ").trim();
        if(!txt) continue;

        beats.push({
          beat_index: idx++,
          start_ms: start,
          end_ms: end,
          line_text: txt
        });
      }
      return beats;
    }

    function statusBadge(status){
      const s = safeText(status);
      const cls = "status s_" + s;
      return `<span class="${cls}"><span class="dot"></span>${s || "-"}</span>`;
    }

    function linkOrDash(url, label){
      if(!url) return '<span class="muted2">—</span>';
      const u = safeText(url);
      const t = label || u.split("/").slice(-1)[0];
      return `<a href="${u}" target="_blank" rel="noreferrer">${t}</a>`;
    }

    // ---------- state ----------
    let supabase = null;
    let autoTimer = null;

    function saveCfg(){
      const cfg = {
        url: $("sbUrl").value.trim(),
        anon: $("sbAnon").value.trim(),
        bucket: $("bucket").value.trim() || "talk",
        workerId: $("workerId").value.trim() || "LIN-SUKHUAN",
      };
      localStorage.setItem("media_jobs_cfg", JSON.stringify(cfg));
      return cfg;
    }

    function loadCfg(){
      try{
        const raw = localStorage.getItem("media_jobs_cfg");
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(_){
        return null;
      }
    }

    async function connect(){
      const cfg = saveCfg();
      if(!cfg.url || !cfg.anon){
        setConnState(false, "Missing URL/ANON");
        return;
      }
      supabase = createClient(cfg.url, cfg.anon, { auth: { persistSession:false } });
      setConnState(true, "Connected");
      await refreshJobs();
    }

    // ---------- db ops ----------
    async function createJob(status){
      if(!supabase) throw new Error("Not connected");
      const slug = $("jobSlug").value.trim() || ("job-" + Date.now());
      const category = $("jobCategory").value;
      const title = $("jobTitle").value.trim() || slug;

      const res = await supabase
        .from("media_jobs")
        .insert([{
          slug, category, title,
          status: status,
          progress: 0,
          stage: null,
          error_code: null,
          error_message: null,
        }])
        .select("*")
        .single();

      if(res.error) throw res.error;
      const job = res.data;

      $("ctlJobId").value = job.id;
      $("beatsJobId").value = job.id;
      $("createInfo").innerHTML = `<span class="ok">✅ 建立成功</span> job_id = <span class="mono">${job.id}</span>`;
      return job;
    }

    async function updateJobStatus(jobId, status){
      if(!supabase) throw new Error("Not connected");
      const res = await supabase
        .from("media_jobs")
        .update({ status: status, updated_at: new Date().toISOString() })
        .eq("id", jobId);
      if(res.error) throw res.error;
    }

    async function markFailed(jobId, msg){
      if(!supabase) throw new Error("Not connected");
      const res = await supabase
        .from("media_jobs")
        .update({ status: "failed", error_message: msg || "manual fail", updated_at: new Date().toISOString() })
        .eq("id", jobId);
      if(res.error) throw res.error;
    }

    async function listJobs(){
      if(!supabase) throw new Error("Not connected");
      const res = await supabase
        .from("media_jobs")
        .select("id, slug, category, title, status, progress, stage, output_mp4_url, output_zip_url, output_manifest_url, error_message, created_at, updated_at")
        .order("created_at", { ascending:false })
        .limit(50);
      if(res.error) throw res.error;
      return res.data || [];
    }

    async function insertBeats(jobId, beats){
      if(!supabase) throw new Error("Not connected");
      if(!jobId) throw new Error("Missing job_id");
      if(!beats || beats.length === 0) throw new Error("No beats to insert");

      // 刪舊 beats（避免重複）
      const del = await supabase.from("media_job_beats").delete().eq("job_id", jobId);
      if(del.error) throw del.error;

      const rows = beats.map(b => ({
        job_id: jobId,
        beat_index: b.beat_index,
        start_ms: b.start_ms,
        end_ms: b.end_ms,
        line_text: b.line_text
      }));

      // 分批插入
      const chunk = 200;
      for(let i=0;i<rows.length;i+=chunk){
        const part = rows.slice(i, i+chunk);
        const ins = await supabase.from("media_job_beats").insert(part);
        if(ins.error) throw ins.error;
      }
    }

    async function countBeats(jobId){
      if(!supabase) throw new Error("Not connected");
      const res = await supabase
        .from("media_job_beats")
        .select("id", { count:"exact", head:true })
        .eq("job_id", jobId);
      if(res.error) throw res.error;
      return res.count || 0;
    }

    // ---------- UI refresh ----------
    async function refreshJobs(){
      if(!supabase){
        $("jobsBody").innerHTML = '<tr><td colspan="5" class="muted2">尚未連線。</td></tr>';
        return;
      }

      const filter = $("filterStatus").value;
      const q = $("searchBox").value.trim().toLowerCase();

      let jobs = await listJobs();
      if(filter) jobs = jobs.filter(j => j.status === filter);
      if(q){
        jobs = jobs.filter(j => {
          const s = (safeText(j.id) + " " + safeText(j.slug) + " " + safeText(j.title)).toLowerCase();
          return s.includes(q);
        });
      }

      if(jobs.length === 0){
        $("jobsBody").innerHTML = '<tr><td colspan="5" class="muted2">沒有資料。</td></tr>';
        return;
      }

      const html = [];
      for(let i=0;i<jobs.length;i++){
        const j = jobs[i];
        const p = pct(j.progress);
        const stage = safeText(j.stage);
        const err = safeText(j.error_message);

        const outputs = `
          <div class="links small">
            MP4: ${linkOrDash(j.output_mp4_url, "output.mp4")}<br/>
            ZIP: ${linkOrDash(j.output_zip_url, "output.zip")}<br/>
            Manifest: ${linkOrDash(j.output_manifest_url, "manifest.json")}<br/>
            ${err ? `<span class="bad">Error:</span> <span class="muted2">${err}</span>` : `<span class="muted2">—</span>`}
          </div>
        `;

        const created = safeText(j.created_at).replace("T"," ").replace("Z","");
        const act = `
          <div class="btnrow" style="margin:0">
            <button class="ghost" data-act="use" data-id="${j.id}">Use</button>
            <button class="ghost" data-act="pause" data-id="${j.id}">Pause</button>
            <button class="primary" data-act="resume" data-id="${j.id}">Resume</button>
            <button class="danger" data-act="fail" data-id="${j.id}">Fail</button>
          </div>
          <div class="hint mono small muted2" style="margin-top:6px">${j.id}</div>
        `;

        html.push(`
          <tr>
            <td>
              <div style="font-weight:600">${safeText(j.title) || "-"}</div>
              <div class="muted2 small">slug: <span class="mono">${safeText(j.slug) || "-"}</span> ・ cat: <span class="mono">${safeText(j.category) || "-"}</span></div>
              <div class="muted2 small">created: <span class="mono">${created}</span></div>
            </td>
            <td>${statusBadge(j.status)}<div class="muted2 small" style="margin-top:6px">${stage ? ("stage: "+stage) : ""}</div></td>
            <td>
              <div class="progress" title="${p}%"><div class="bar" style="width:${p}%"></div></div>
              <div class="muted2 small" style="margin-top:6px">${p}%</div>
            </td>
            <td>${outputs}</td>
            <td>${act}</td>
          </tr>
        `);
      }

      $("jobsBody").innerHTML = html.join("");

      // bind row actions
      const btns = $("jobsBody").querySelectorAll("button[data-act]");
      btns.forEach(btn => {
        btn.addEventListener("click", async ()=>{
          const id = btn.getAttribute("data-id");
          const act = btn.getAttribute("data-act");
          try{
            if(act === "use"){
              $("ctlJobId").value = id;
              $("beatsJobId").value = id;
              $("previewBox").innerHTML = `已選取 job_id = <span class="mono">${id}</span>`;
              return;
            }
            if(act === "pause") await updateJobStatus(id, "pending");
            if(act === "resume") await updateJobStatus(id, "queued");
            if(act === "fail") await markFailed(id, "manual fail from UI");
            await refreshJobs();
          }catch(e){
            alert("Action error: " + (e && e.message ? e.message : e));
          }
        });
      });
    }

    function toggleAuto(){
      if(autoTimer){
        clearInterval(autoTimer);
        autoTimer = null;
        $("btnToggleAuto").textContent = "Auto refresh: OFF";
        return;
      }
      autoTimer = setInterval(function(){
        refreshJobs().catch(function(){});
      }, 2000);
      $("btnToggleAuto").textContent = "Auto refresh: ON";
    }

    async function readSrtFile(){
      const inp = $("srtFile");
      const f = inp && inp.files ? inp.files[0] : null;
      if(!f){
        alert("請先選擇 .srt 檔");
        return;
      }
      const text = await f.text();
      $("srtText").value = text;
      $("previewBox").innerHTML = `<span class="ok">✅ 已讀取檔案：</span> <span class="mono">${f.name}</span>（${Math.round(f.size/1024)} KB）`;
    }

    // ---------- events ----------
    $("btnConnect").addEventListener("click", function(){ connect().catch(e=>alert(e.message||e)); });
    $("btnSave").addEventListener("click", function(){ saveCfg(); alert("Saved."); });
    $("btnLoad").addEventListener("click", function(){
      const cfg = loadCfg();
      if(!cfg){ alert("No saved cfg."); return; }
      $("sbUrl").value = cfg.url || "";
      $("sbAnon").value = cfg.anon || "";
      $("bucket").value = cfg.bucket || "talk";
      $("workerId").value = cfg.workerId || "LIN-SUKHUAN";
      alert("Loaded.");
    });

    $("btnCreatePending").addEventListener("click", async function(){
      try{
        const job = await createJob("pending");
        $("previewBox").innerHTML = `✅ 建立完成（pending） job_id = <span class="mono">${job.id}</span>`;
        await refreshJobs();
      }catch(e){ alert("Create error: " + (e && e.message ? e.message : e)); }
    });

    $("btnCreateQueue").addEventListener("click", async function(){
      try{
        const job = await createJob("queued");
        $("previewBox").innerHTML = `✅ 建立完成（queued） job_id = <span class="mono">${job.id}</span>`;
        await refreshJobs();
      }catch(e){ alert("Create error: " + (e && e.message ? e.message : e)); }
    });

    $("btnPause").addEventListener("click", async function(){
      const id = $("ctlJobId").value.trim();
      if(!id) return alert("請先貼 job_id");
      try{ await updateJobStatus(id, "pending"); await refreshJobs(); }catch(e){ alert(e.message||e); }
    });

    $("btnResume").addEventListener("click", async function(){
      const id = $("ctlJobId").value.trim();
      if(!id) return alert("請先貼 job_id");
      try{ await updateJobStatus(id, "queued"); await refreshJobs(); }catch(e){ alert(e.message||e); }
    });

    $("btnFail").addEventListener("click", async function(){
      const id = $("ctlJobId").value.trim();
      if(!id) return alert("請先貼 job_id");
      try{ await markFailed(id, "manual fail from UI"); await refreshJobs(); }catch(e){ alert(e.message||e); }
    });

    $("btnLoadSrt").addEventListener("click", function(){ readSrtFile().catch(e=>alert(e.message||e)); });
    $("btnClearSrt").addEventListener("click", function(){
      $("srtText").value = "";
      $("previewBox").textContent = "尚未解析。";
    });

    $("btnPreview").addEventListener("click", function(){
      try{
        const beats = parseSrt($("srtText").value);
        if(beats.length === 0){
          $("previewBox").innerHTML = `<span class="bad">❌ 解析不到 beats</span>（確認時間格式：00:00:01,000 --> 00:00:03,000）`;
          return;
        }
        const head = beats.slice(0,3).map(b => `${b.beat_index}. [${b.start_ms}~${b.end_ms}] ${b.line_text}`).join("<br/>");
        $("previewBox").innerHTML = `<span class="ok">✅ 解析成功</span> beats=${beats.length}<br/><span class="muted2">${head}${beats.length>3?"<br/>...":""}</span>`;
      }catch(e){
        $("previewBox").innerHTML = `<span class="bad">❌ Parse error:</span> <span class="muted2">${e.message||e}</span>`;
      }
    });

    $("btnInsert").addEventListener("click", async function(){
      const jobId = $("beatsJobId").value.trim();
      if(!jobId) return alert("請先貼 job_id（uuid）");
      try{
        const beats = parseSrt($("srtText").value);
        if(beats.length === 0) return alert("解析不到 beats，先按 Preview Parse。");
        await insertBeats(jobId, beats);
        const n = await countBeats(jobId);
        $("previewBox").innerHTML = `<span class="ok">✅ Insert 完成</span> job_id=<span class="mono">${jobId}</span> beats=${n}`;
      }catch(e){
        alert("Insert error: " + (e && e.message ? e.message : e));
      }
    });

    $("btnQueue").addEventListener("click", async function(){
      const jobId = $("beatsJobId").value.trim();
      if(!jobId) return alert("請先貼 job_id（uuid）");
      try{
        await updateJobStatus(jobId, "queued");
        $("previewBox").innerHTML = `<span class="ok">✅ 已排入隊列</span> job_id=<span class="mono">${jobId}</span>`;
        await refreshJobs();
      }catch(e){
        alert("Queue error: " + (e && e.message ? e.message : e));
      }
    });

    $("btnRefresh").addEventListener("click", function(){ refreshJobs().catch(e=>alert(e.message||e)); });
    $("btnToggleAuto").addEventListener("click", function(){ toggleAuto(); });
    $("filterStatus").addEventListener("change", function(){ refreshJobs().catch(function(){}); });
    $("searchBox").addEventListener("input", function(){ refreshJobs().catch(function(){}); });

    // init
    (function init(){
      const cfg = loadCfg();
      if(cfg){
        $("sbUrl").value = cfg.url || "";
        $("sbAnon").value = cfg.anon || "";
        $("bucket").value = cfg.bucket || "talk";
        $("workerId").value = cfg.workerId || "LIN-SUKHUAN";
      }
    })();
  </script>
</body>
</html>
