<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>訂閱到期提醒監控｜BookWide</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root {
    --bg:#f4f6fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0;
    --primary:#0ea5e9; --danger:#ef4444; --ok:#22c55e;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC,Arial;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:5;background:linear-gradient(90deg,#0b1020,#0b2a4a);color:#fff;padding:18px 18px}
  header .row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  header .title{font-size:20px;font-weight:700;letter-spacing:.5px}
  header .sub{font-size:12px;opacity:.85;margin-top:4px}
  header .btns{display:flex;gap:10px;align-items:center}
  button{border:0;border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn-primary{background:var(--primary);color:#001018}
  .btn-ghost{background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.18)}
  main{max-width:1100px;margin:18px auto;padding:0 14px 40px}
  .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
  @media (max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:520px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
  .metric{font-size:32px;font-weight:800;line-height:1;margin:4px 0 8px}
  .label{font-size:13px;color:var(--muted)}
  .hint{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.35}
  .section{margin-top:14px}
  .section h2{margin:0 0 10px;font-size:16px}
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
  .input{flex:1;min-width:220px;border:1px solid var(--line);border-radius:999px;padding:10px 14px;background:#fff}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{text-align:left;padding:10px 10px;border-bottom:1px solid var(--line);font-size:13px}
  th{color:var(--muted);font-weight:700}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:800}
  .b-ok{background:#dcfce7;color:#14532d}
  .b-no{background:#fee2e2;color:#7f1d1d}
  .right{text-align:right}
  .muted{color:var(--muted)}
  .mini{font-size:12px}
  .row2{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .kv{display:flex;gap:8px;align-items:center}
  .kv label{font-size:12px;color:var(--muted)}
  .kv input{border:1px solid var(--line);border-radius:10px;padding:8px 10px;min-width:240px}
  .note{margin-top:10px;color:var(--muted);font-size:12px;line-height:1.45}
  .err{color:#b91c1c;font-weight:800}
</style>
</head>
<body>
<header>
  <div class="row">
    <div>
      <div class="title">訂閱到期提醒監控</div>
      <div class="sub">登入中…</div>
    </div>
    <div class="btns">
<button class="btn-primary" id="btnRefresh">重新整理</button>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <div class="card">
      <div class="label">今天 +7 天到期（總筆數）</div>
      <div class="metric" id="m_total">—</div>
      <div class="hint">orders.status=paid 且 expire_at 落在「台北今天+7天」</div>
    </div>
    <div class="card">
      <div class="label">待寄 7 天提醒</div>
      <div class="metric" id="m_pending">—</div>
      <div class="hint">reminder_sent_at 仍為空</div>
    </div>
    <div class="card">
      <div class="label">今天已寄 7 天提醒</div>
      <div class="metric" id="m_sent_today">—</div>
      <div class="hint">orders.reminder_sent_at 在今天（台北）</div>
    </div>
    <div class="card">
      <div class="label">今天已寄 到期信</div>
      <div class="metric" id="m_expire_today">—</div>
      <div class="hint">orders.expire_reminder_sent_at 在今天（台北）</div>
    </div>
  </div>

  <div class="section card">
    <div class="toolbar">
      <input class="input" id="q" placeholder="搜尋 Email / buyer_id / order_id…" />
      <div class="row2">
        <div class="kv">
          <label></label>
        </div>
      </div>
    </div>
    <div class="mini muted" id="rangeText">到期日（台北）= —</div>

    <h2 style="margin-top:12px">待寄名單（到期前 7 天）</h2>
    <table>
      <thead>
        <tr>
          <th>到期日</th>
          <th>寄送狀態</th>
          <th>Email</th>
          <th>Order / Buyer</th>
        </tr>
      </thead>
      <tbody id="tb_pending">
        <tr><td colspan="4" class="muted">載入中…</td></tr>
      </tbody>
    </table>

    <h2 style="margin-top:16px">今日寄送紀錄（email_logs）</h2>
    
    <table>
      <thead>
        <tr>
          <th>時間</th>
          <th>結果</th>
          <th>Email</th>
          <th>備註</th>
        </tr>
      </thead>
      <tbody id="tb_logs">
        <tr><td colspan="4" class="muted">載入中…</td></tr>
      </tbody>
    </table>

    
  </div>
</main>

<script>
(() => {
  const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
  const FUNCTION_URL = "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/subscription-reminder";
const $ = (id) => document.getElementById(id);

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true,
    }
  });

  function fmtTaipeiDateKey(d = new Date()) {
    return new Intl.DateTimeFormat("en-CA", {
      timeZone: "Asia/Taipei",
      year: "numeric", month: "2-digit", day: "2-digit"
    }).format(d);
  }

  function taipeiDayRangeUtc(dateKey) {
    const [y,m,d] = dateKey.split("-").map(Number);
    const startUtc = new Date(Date.UTC(y, m-1, d, 0,0,0));
    startUtc.setUTCHours(startUtc.getUTCHours() - 8);
    const endUtc = new Date(startUtc);
    endUtc.setUTCDate(endUtc.getUTCDate() + 1);
    return { startUtc, endUtc };
  }

  function safeText(v) {
    if (v === null || v === undefined) return "";
    return String(v);
  }

  function badge(ok, text) {
    return `<span class="badge ${ok ? "b-ok" : "b-no"}">${ok ? "✅" : "❌"} ${text}</span>`;
  }

  async function ensureAuthLabel() {
    const { data } = await supabase.auth.getSession();
    const email = data?.session?.user?.email;
    document.querySelector("header .sub").textContent = email ? `已登入：${email}` : "未登入（可能讀不到資料）";
  }

    const v = localStorage.getItem(LS_SECRET) || "";
  }

    saveCronSecret();
    const sql = buildSQL(secret);
    try {
      await navigator.clipboard.writeText(sql);
      alert("已複製 SQL。打開 Supabase SQL Editor → 貼上 → Run 即可。");
    } catch (e) {
      // fallback
      const ta = document.createElement("textarea");
      ta.value = sql;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      alert("已複製 SQL（fallback）。打開 Supabase SQL Editor → 貼上 → Run 即可。");
    }
  }

  async function loadAll() {
    $("m_total").textContent = "—";
    $("m_pending").textContent = "—";
    $("m_sent_today").textContent = "—";
    $("m_expire_today").textContent = "—";
    $("tb_pending").innerHTML = `<tr><td colspan="4" class="muted">載入中…</td></tr>`;
    $("tb_logs").innerHTML = `<tr><td colspan="4" class="muted">載入中…</td></tr>`;

    await ensureAuthLabel();

    // 今日 + 7 天（台北）
    const todayKey = fmtTaipeiDateKey();
    const target = new Date(todayKey + "T00:00:00");
    target.setDate(target.getDate() + 7);
    const targetKey = fmtTaipeiDateKey(target);

    const { startUtc, endUtc } = taipeiDayRangeUtc(targetKey);
    $("rangeText").textContent = `到期日（台北）= ${targetKey}（UTC: ${startUtc.toISOString()} ~ ${endUtc.toISOString()}）`;

    // 1) pending list
    const { data: orders, error: e1 } = await supabase
      .from("orders")
      .select("id,buyer_id,user_id,email_to,expire_at,reminder_sent_at,status")
      .eq("status", "paid")
      .is("reminder_sent_at", null)
      .gte("expire_at", startUtc.toISOString())
      .lt("expire_at", endUtc.toISOString())
      .order("expire_at", { ascending: true });

    if (e1) {
      $("tb_pending").innerHTML = `<tr><td colspan="4" class="err">無法讀取 orders：${safeText(e1.message || e1)}</td></tr>`;
    } else {
      const q = ($("q").value || "").trim().toLowerCase();
      const list = (orders || []).filter(o => {
        if (!q) return true;
        return safeText(o.id).toLowerCase().includes(q)
          || safeText(o.buyer_id).toLowerCase().includes(q)
          || safeText(o.user_id).toLowerCase().includes(q)
          || safeText(o.email_to).toLowerCase().includes(q);
      });

      $("m_pending").textContent = String((orders || []).length);
      $("m_total").textContent = String((orders || []).length); // 「總筆數」同條件下其實就是 pending（因為你要寄的就是未寄）
      if (!list.length) {
        $("tb_pending").innerHTML = `<tr><td colspan="4" class="muted">沒有待寄資料 ✅</td></tr>`;
      } else {
        $("tb_pending").innerHTML = list.map(o => {
          const exp = new Date(o.expire_at).toLocaleString("zh-TW", { timeZone: "Asia/Taipei" });
          return `<tr>
            <td>${exp}</td>
            <td>${badge(false, "未寄")}</td>
            <td>${safeText(o.email_to || "")}</td>
            <td class="muted">${safeText(o.id)} / ${safeText(o.buyer_id || o.user_id || "")}</td>
          </tr>`;
        }).join("");
      }
    }

    // 2) sent today (7d reminders)
    const todayRange = taipeiDayRangeUtc(todayKey);
    const { data: sentToday, error: e2 } = await supabase
      .from("orders")
      .select("id")
      .gte("reminder_sent_at", todayRange.startUtc.toISOString())
      .lt("reminder_sent_at", todayRange.endUtc.toISOString());

    $("m_sent_today").textContent = e2 ? "—" : String((sentToday || []).length);

    // 3) expire reminders sent today (if field exists)
    try {
      const { data: expireToday, error: e3 } = await supabase
        .from("orders")
        .select("id")
        .gte("expire_reminder_sent_at", todayRange.startUtc.toISOString())
        .lt("expire_reminder_sent_at", todayRange.endUtc.toISOString());
      $("m_expire_today").textContent = e3 ? "—" : String((expireToday || []).length);
    } catch (_e) {
      $("m_expire_today").textContent = "—";
    }

    // 4) email_logs today (best effort)
    const { data: logs, error: e4 } = await supabase
      .from("email_logs")
      .select("created_at,ok,to_email,error,kind,order_id")
      .gte("created_at", todayRange.startUtc.toISOString())
      .lt("created_at", todayRange.endUtc.toISOString())
      .order("created_at", { ascending: false })
      .limit(50);

    if (e4) {
      $("tb_logs").innerHTML = `<tr><td colspan="4" class="err">無法讀取 email_logs：${safeText(e4.message || e4)}</td></tr>`;
    } else if (!logs || !logs.length) {
      $("tb_logs").innerHTML = `<tr><td colspan="4" class="muted">今天沒有紀錄</td></tr>`;
    } else {
      $("tb_logs").innerHTML = logs.map(x => {
        const t = new Date(x.created_at).toLocaleString("zh-TW", { timeZone: "Asia/Taipei" });
        const ok = !!x.ok;
        const memo = ok ? safeText(x.kind || "") : safeText(x.error || "");
        return `<tr>
          <td>${t}</td>
          <td>${badge(ok, ok ? "成功" : "失敗")}</td>
          <td>${safeText(x.to_email || "")}</td>
          <td class="muted">${memo} ${x.order_id ? "(" + safeText(x.order_id) + ")" : ""}</td>
        </tr>`;
      }).join("");
    }
  }

  // events
  $("btnRefresh").addEventListener("click", () => loadAll());
  $("q").addEventListener("input", () => loadAll());

  // init
  loadAll();
})();
</script>
</body>
</html>
