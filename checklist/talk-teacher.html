<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Talk 老師語音 / 影像產生器｜BookWide Admin</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:rgba(255,255,255,.06);
      --line:rgba(255,255,255,.10);
      --ink:#eaf0ff;
      --muted:rgba(234,240,255,.70);
      --brand:#4f7cff;
      --ok:#22c55e;
      --bad:#ef4444;
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "Microsoft JhengHei", sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1000px 600px at 15% 10%, rgba(79,124,255,.22), transparent 55%),
        radial-gradient(900px 500px at 90% 20%, rgba(34,197,94,.12), transparent 55%),
        linear-gradient(180deg, #070b16, var(--bg));
    }
    .topbar{
      position:sticky; top:0; z-index:9;
      padding:14px 18px;
      background:rgba(6,10,22,.75);
      backdrop-filter: blur(14px);
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:900}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 12px; border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      font-weight:800; font-size:13px;
    }
    .btn{
      appearance:none; border:0; cursor:pointer;
      border-radius:14px; padding:10px 14px;
      background:rgba(255,255,255,.08);
      color:var(--ink);
      border:1px solid rgba(255,255,255,.12);
      font-weight:900;
    }
    .btn.primary{background:rgba(79,124,255,.18); border-color:rgba(79,124,255,.35)}
    .btn.ok{background:rgba(34,197,94,.16); border-color:rgba(34,197,94,.35)}
    .wrap{max-width:1100px; margin:18px auto; padding:0 18px}
    .card{
      background:var(--card);
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--r);
      padding:16px;
    }
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px}
    @media (max-width: 980px){ .grid{grid-template-columns: 1fr;} }
    label{display:block; font-weight:900; margin:10px 0 6px}
    input,select,textarea{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:var(--ink);
      padding:12px 12px;
      outline:none;
      font-weight:800;
    }
    textarea{min-height:120px; resize:vertical}
    .row{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px}
    @media (max-width: 780px){ .row{grid-template-columns:1fr;} }
    .hint{color:var(--muted); font-size:12px; font-weight:800; margin-top:8px; line-height:1.6}
    .log{
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.20);
      color:var(--muted);
      font-size:12px;
      white-space:pre-wrap;
      font-weight:800;
      line-height:1.6;
    }
    .badge{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:950; font-size:12px;}
    .badge.ok{border:1px solid rgba(34,197,94,.35); background:rgba(34,197,94,.14)}
    .badge.bad{border:1px solid rgba(239,68,68,.35); background:rgba(239,68,68,.14)}
    audio{width:100%; margin-top:10px}
    .miniBtns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .small{font-size:12px; color:var(--muted); font-weight:800}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <div style="font-size:22px;">BookWide</div>
      <span class="pill">Admin <small style="opacity:.75;font-weight:800">第12項</small></span>
      <span class="pill">Talk 老師語音 / 影像產生器</span>
    </div>
    <div style="display:flex; gap:10px; align-items:center">
      <span class="small">管理員：<b id="adminEmail">檢查中…</b></span>
      <button class="btn" id="btnBack">回主控台</button>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <div class="card">
        <div style="font-weight:950;font-size:18px;">一鍵產生老師 MP3（tts-mp3 → Storage）</div>
        <div class="hint">
          產出路徑固定：<b>talk/teacher/{scenario}/line-XX.mp3</b><br/>
          沒做 MP4 也沒關係：Talk A 先吃 MP3（之後再升級嘴型 MP4）。
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>情境 scenario</label>
            <input id="scn" value="nails" placeholder="例如 nails / coffee" />
          </div>
          <div>
            <label>句號 lineNo（1-10）</label>
            <input id="lineNo" value="1" />
          </div>
          <div>
            <label>老師聲音 voice</label>
            <input id="voice" value="en-US-JennyNeural" />
          </div>
        </div>

        <label style="margin-top:10px">老師要朗讀的英文（text）</label>
        <textarea id="ttsText">Hi! What are you doing?</textarea>

        <div class="miniBtns">
          <button class="btn ok" id="btnMake">產生並上傳 MP3</button>
          <button class="btn primary" id="btnMake10">一鍵產生本情境 10 句（用下方清單）</button>
        </div>

        <div class="log" id="out">狀態：等待操作…</div>
        <audio id="preview" controls style="display:none"></audio>
      </div>

      <div class="card">
        <div style="font-weight:950;font-size:18px;">10 句腳本（貼上就能批次）</div>
        <div class="hint">每行一段老師要朗讀的英文（共 10 行）。按「一鍵產生本情境 10 句」。</div>
        <textarea id="batchLines" spellcheck="false">Hi! What are you doing?
I'm painting my nails.
Do you do it yourself?
Yes, I do.
What color do you like?
I like red.
That looks nice.
Thanks!
Do you want to try?
Sure, maybe later.</textarea>
        <div class="hint">（提示）第 1 行 = line-01、第 2 行 = line-02 …</div>
      </div>
    </div>
  </div>

  <!-- Supabase UMD -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
  <script>
    // ====== Project keys (same style as your admin.html) ======
    const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
    const SUPABASE_ANON =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";

    const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    // ---- deny urls (keep your commercial gating behavior) ----
    const DENY_SIGNIN = "/index.html?denied=signin";
    const DENY_ADMIN  = "/index.html?denied=admin";
    const DENY_PAUSED = "/index.html?denied=paused";
    const DENY_PROFILE= "/index.html?denied=profile";

    function kick(url){
      try { location.replace(url); } catch(e){ location.href = url; }
    }

    async function requireAdmin() {
      const { data: sess } = await supa.auth.getSession();
      const session = sess?.session;
      if (!session?.user) return kick(DENY_SIGNIN);

      const { data: profile, error } = await supa
        .from("profiles")
        .select("email,is_admin,is_paused")
        .eq("id", session.user.id)
        .maybeSingle();

      if (error || !profile) return kick(DENY_PROFILE);
      if (profile.is_paused) return kick(DENY_PAUSED);
      if (!profile.is_admin) return kick(DENY_ADMIN);

      document.getElementById("adminEmail").textContent =
        profile.email || session.user.email || "admin";

      supa.auth.onAuthStateChange((_event, s) => {
        if (!s?.user) kick(DENY_SIGNIN);
      });
    }

    // ====== TTS → MP3 → upload ======
    const FN_TTS_MP3 = "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/tts-mp3";
    const BUCKET = "talk";

    const $ = (id)=>document.getElementById(id);
    const log = (t)=>{ $("out").textContent = t; };

    function pad2(n){ return String(n).padStart(2,'0'); }

    async function makeOne({scenario, lineNo, voice, text}){
      // need login token for function + storage RLS
      const { data: sess } = await supa.auth.getSession();
      const token = sess?.session?.access_token;
      if (!token) throw new Error("請先登入後台（沒有 session）");

      // 1) fetch mp3 blob
      const r = await fetch(FN_TTS_MP3, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": SUPABASE_ANON,
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ text, voice })
      });

      if (!r.ok) throw new Error(await r.text());
      const blob = await r.blob();

      // 2) upload
      const path = `teacher/${scenario}/line-${pad2(lineNo)}.mp3`;
      const { error: upErr } = await supa.storage
        .from(BUCKET)
        .upload(path, blob, { upsert:true, contentType:"audio/mpeg", cacheControl:"3600" });

      if (upErr) throw upErr;

      const { data: pub } = supa.storage.from(BUCKET).getPublicUrl(path);
      return { path, url: pub.publicUrl };
    }

    async function onMake(){
      const scenario = $("scn").value.trim();
      const lineNo = parseInt($("lineNo").value, 10);
      const voice = $("voice").value.trim();
      const text = $("ttsText").value.trim();

      if (!scenario) throw new Error("scenario 不可空");
      if (!lineNo || lineNo < 1 || lineNo > 99) throw new Error("lineNo 需 1..99");
      if (!text) throw new Error("text 不可空");

      log("處理中：產生 MP3 → 上傳…");
      const { path, url } = await makeOne({ scenario, lineNo, voice, text });

      log(`✅ 完成\npath: ${path}\nurl: ${url}`);
      $("preview").src = url;
      $("preview").style.display = "block";
    }

    async function onMake10(){
      const scenario = $("scn").value.trim();
      const voice = $("voice").value.trim();
      if (!scenario) throw new Error("scenario 不可空");

      const lines = $("batchLines").value
        .split("\n")
        .map(s=>s.trim())
        .filter(Boolean);

      if (lines.length < 1) throw new Error("請貼上至少 1 行英文");

      log(`批次處理中：共 ${lines.length} 句…`);
      for (let i=0;i<lines.length;i++){
        const lineNo = i+1;
        const text = lines[i];
        log(`處理第 ${lineNo} 句 / ${lines.length}\n${text}`);
        const { path, url } = await makeOne({ scenario, lineNo, voice, text });
        // 即時顯示最後一個
        $("preview").src = url;
        $("preview").style.display = "block";
      }
      log(`✅ 批次完成：${scenario} 共 ${lines.length} 句\n檔案路徑：talk/teacher/${scenario}/line-01.mp3 ...`);
    }

    // UI bindings
    $("btnBack").addEventListener("click", ()=>location.href="/admin.html");
    $("btnMake").addEventListener("click", async ()=>{
      try{ await onMake(); }catch(e){ log("❌ " + (e?.message||e)); }
    });
    $("btnMake10").addEventListener("click", async ()=>{
      try{ await onMake10(); }catch(e){ log("❌ " + (e?.message||e)); }
    });

    requireAdmin();
  </script>
</body>
</html>
