<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>FOS 出片系統（SRT 批次 → Prompt/JSON → ZIP）</title>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    :root{
      --bg:#0b1220; --panel:#0f1b2d; --panel2:#0c1626;
      --text:#e8eefc; --muted:#aab7d6; --line:#1f2c45;
      --good:#19c37d; --warn:#f59e0b; --bad:#ef4444;
      --btn:#2563eb; --btn2:#1d4ed8; --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", Arial, "PingFang TC", "Microsoft JhengHei", sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(37,99,235,.25), transparent 60%),
                  radial-gradient(900px 500px at 80% 10%, rgba(25,195,125,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{
      padding:18px 16px 10px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(15,27,45,.9), rgba(11,18,32,.2));
      position: sticky; top:0; z-index: 10;
      backdrop-filter: blur(10px);
    }
    .wrap{max-width:1280px;margin:0 auto;padding:0 12px 40px;}
    .toprow{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;}
    h1{margin:0;font-size:18px;letter-spacing:.3px;}
    .sub{margin-top:6px;color:var(--muted);font-size:12px;line-height:1.5}
    .pillrow{display:flex;gap:8px;flex-wrap:wrap}
    .pill{font-size:12px;color:var(--muted);padding:6px 10px;border:1px solid var(--line);background: rgba(18,33,58,.6);border-radius:999px;white-space:nowrap;}
    .grid{display:grid;grid-template-columns: 380px 1fr;gap:14px;margin-top:14px;align-items:start;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{background: linear-gradient(180deg, rgba(15,27,45,.92), rgba(12,22,38,.92));border:1px solid var(--line);border-radius:14px;box-shadow: var(--shadow);overflow:hidden;}
    .card .hd{padding:12px 12px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;background: rgba(10,20,36,.65);}
    .card .hd .t{display:flex;gap:10px;align-items:center;font-weight:800;font-size:14px;}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;background: rgba(37,99,235,.15);border: 1px solid rgba(37,99,235,.35);color:#cfe1ff;}
    .bd{padding:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:0;background: linear-gradient(180deg, var(--btn), var(--btn2));color:white;border-radius:10px;padding:10px 12px;font-weight:800;cursor:pointer;font-size:13px;box-shadow: 0 10px 22px rgba(37,99,235,.25);}
    .btn:disabled{opacity:.45;cursor:not-allowed;box-shadow:none}
    .btn.secondary{background: rgba(18,33,58,.6);border:1px solid var(--line);color:var(--text);box-shadow:none;font-weight:800;}
    .btn.danger{background: rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.35);color:#ffd2d2;box-shadow:none;}
    input[type="file"]{display:none}
    .drop{border:1px dashed rgba(170,183,214,.35);background: rgba(10,20,36,.35);border-radius:12px;padding:12px;min-height:84px;display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .hint{font-size:12px;color:var(--muted);line-height:1.4}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .field{display:flex;flex-direction:column;gap:6px;width:100%;margin-top:10px;}
    label{font-size:12px;color:var(--muted)}
    textarea, input[type="text"], select{width:100%;padding:10px 10px;border-radius:12px;border:1px solid var(--line);background: rgba(10,20,36,.65);color:var(--text);outline:none;font-size:13px;}
    textarea{min-height:120px;resize:vertical}
    .small{font-size:12px;color:var(--muted)}
    .status{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background: rgba(10,20,36,.45);font-size:12px;color:var(--muted);}
    .status b{color:var(--text)}
    .list{display:flex;flex-direction:column;gap:8px;margin-top:10px;max-height:440px;overflow:auto;padding-right:4px;}
    .item{border:1px solid rgba(31,44,69,.8);background: rgba(10,20,36,.35);border-radius:12px;padding:10px 10px;display:flex;align-items:flex-start;justify-content:space-between;gap:10px;cursor:pointer;}
    .item.active{border-color: rgba(37,99,235,.65);background: rgba(37,99,235,.10);}
    .item .name{font-weight:800;font-size:13px;line-height:1.2}
    .item .meta{font-size:12px;color:var(--muted);margin-top:4px}
    .chip{display:inline-flex;align-items:center;gap:6px;background: rgba(18,33,58,.6);border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted);}
    .hr{height:1px;background: var(--line);margin:12px 0}
    table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:12px;overflow:hidden;background: rgba(10,20,36,.35);}
    th, td{padding:10px 10px;border-bottom:1px solid rgba(31,44,69,.75);vertical-align:top;font-size:12px;}
    th{color:#cfe1ff;background: rgba(18,33,58,.55);text-align:left}
    tr:last-child td{border-bottom:none}
    .cellline{white-space:pre-wrap;line-height:1.35}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}
    @media (max-width: 680px){ .two{grid-template-columns:1fr} }
    .kbd{display:inline-block;padding:2px 6px;border:1px solid rgba(170,183,214,.35);border-radius:6px;background: rgba(10,20,36,.5);font-size:11px;color: var(--muted);}
  
    .progressBar{height:10px;border-radius:999px;background:rgba(255,255,255,.10);overflow:hidden;border:1px solid rgba(255,255,255,.12)}
    .progressFill{height:100%;background:linear-gradient(90deg, rgba(90,169,255,.9), rgba(73,255,200,.85));border-radius:999px;transition:width .2s ease}
    .progressWrap{display:flex;align-items:center;gap:10px}

</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="toprow">
      <div>
        <h1>18｜出片系統（SRT → 圖像／動畫）</h1>
        <div class="sub">
          上傳 <span class="mono">*.SRT</span>（可多支／批次），系統依每支 SRT 內容自動產生出圖提示辭（<span class="mono">photo_prompt</span>／英文句／運鏡），並批次生成圖片與打包下載；更換不同 <span class="mono">*.SRT</span> 即依新字幕流程出片。
        </div>
      </div>
      <div class="pillrow">
        <div class="pill">EduEnglish</div>
        <div class="pill mono">/checklist/fos.html</div>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">

    <section class="card">
      <div class="hd">
        <div class="t">
          <span>步驟 A｜批次匯入 SRT</span>
          <span class="badge">不改英文</span>
        </div>
        <div class="row">
          <button id="btnResetAll" class="btn danger">重置全部</button>
        </div>
      </div>

      <div class="bd">
        <div class="drop" id="dropSrt">
          <div>
            <div style="font-weight:800">拖曳多支 .srt 進來</div>
            <div class="hint">或點「選擇 SRT」。每支 SRT 會成為一個出片批次。</div>
          </div>
          <div class="row">
            <label class="btn" for="fileSrts">選擇 SRT</label>
            <input id="fileSrts" type="file" accept=".srt,text/plain" multiple />
          </div>
        </div>

        <div class="two">
          <div class="field" style="margin-top:12px;">
            <label>提示模板（只影響 photo_prompt / camera；英文不動）</label>
            <select id="template">
              <option value="generic">通用（Generic）</option>
              <option value="lion_mouse">The Lion and the Mouse（獅子與老鼠）</option>
              <option value="custom">自訂（不自動填 photo_prompt）</option>
            </select>
            <div class="small">你可在右側表格手動微調每段 prompt / camera。</div>
          </div>
          <div class="field" style="margin-top:12px;">
            <label>風格尾巴（自動加在每段 photo_prompt 後面）</label>
            <input id="styleTail" type="text" value="童話插畫風格，無文字" />
          </div>
        </div>

        <div class="status" id="batchStatus"><b>狀態：</b>尚未匯入 SRT</div>

        <div class="hr"></div>

        <div class="row">
          <button id="btnBuildAll" class="btn secondary" disabled>產生所有 scene.json</button>
          <button id="btnZipJsonOnly" class="btn secondary" disabled>打包：全部 scene.json（ZIP）</button>
        </div>
        <div class="row" style="margin-top:8px;">
          <button id="btnZipAllWithImages" class="btn" disabled>打包：scene.json + 圖片（ZIP）</button>
        </div>

        <div class="field">
          <label>ZIP 檔名</label>
          <input id="zipName" type="text" class="mono" value="fos_batch_package.zip" />
          <div class="small">ZIP 內會為每支 SRT 建一個資料夾：<span class="mono">001_檔名/</span></div>
        </div>

        <div class="hr"></div>

        <div style="font-weight:800;margin-bottom:6px;">SRT 清單（點選右側編輯）</div>
        <div class="list" id="fileList"></div>
      </div>
    </section>

    <section class="card">
      <div class="hd">
        <div class="t">
          <span>編輯區｜當前 SRT</span>
          <span class="badge" id="activeBadge">未選擇</span>
        </div>
        <div class="row">
          <button id="btnDownloadActiveJson" class="btn secondary" disabled>下載此 scene.json</button>
          <button id="btnDownloadActiveSrt" class="btn secondary" disabled>下載此 SRT</button>
          <button id="btnGenImagesActive" class="btn" disabled>先試跑 5 張（本批次）</button>
          <button id="btnGenImagesAll" class="btn" disabled>一鍵慢速跑完（5張/批）</button>
          <button id="btnStopGen" class="btn secondary" disabled>停止</button>
          <button id="btnClearGenImages" class="btn danger" disabled>清除生成圖片</button>
        </div>
      </div>

      <div class="bd">
        <div class="row" style="gap:8px;">
          <div class="chip" id="cueChip">尚未選擇 SRT</div>
          <div class="chip" id="imgChip">尚未匯入圖片</div>
          <div class="chip" id="klingChip">Kling JSON 已就緒：否</div>
        </div>

        <div class="two" style="margin-top:10px;">
          <div class="field" style="margin-top:0;">
            <label>OpenAI Images API（Supabase Edge Function）</label>
            <input id="imgApiUrl" type="text" class="mono" value="https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/fos-generate-image" />
            <div class="small">你已在 Supabase 設定 <span class="mono">OPENAI_API_KEY</span>。此頁只呼叫你的 Edge Function，不會暴露金鑰。</div>
          </div>
          <div class="field" style="margin-top:0;">
            <label>圖片參數</label>
            <div class="two" style="margin-top:0;">
              <input id="imgModel" type="text" class="mono" value="gpt-image-1.5" />
              <select id="imgSize" class="mono">
                <option value="1024x1024" selected>1024x1024</option>
                <option value="1024x1536">1024x1536</option>
                <option value="1536x1024">1536x1024</option>
              </select>
            </div>
            <div class="small">按「生成圖片」會依 cue 順序產出 <span class="mono">001.png</span>、<span class="mono">002.png</span>…（對齊 cue id）。</div>
          </div>
        </div>


        <div class="two">
          <div class="field">
            <label>匯入圖片（可選）</label>
            <div class="drop" id="dropImg" style="min-height:64px;">
              <div class="hint">拖曳圖片或點「選擇圖片」。若匯入，ZIP 會包含 images/。</div>
              <div class="row">
                <label class="btn secondary" for="fileImgs">選擇圖片</label>
                <input id="fileImgs" type="file" accept="image/*" multiple />
              </div>
            </div>
            <div class="small">圖片命名會自動改為 <span class="mono">001.png</span>、<span class="mono">002.png</span>…（依 cue id）。</div>
          </div>
          <div class="field">
            <label>備註（可選，會寫進 README.txt）</label>
            <textarea id="notes" class="mono" placeholder="可填：用途、來源、批次、日期..."></textarea>
          </div>
        </div>

        <div class="hr"></div>

        <div id="emptyEditor" class="status">選擇左側某支 SRT，右側才會顯示 cue 表格與輸出 JSON。</div>

        <div id="editorArea" style="display:none;">
          <div style="overflow:auto;max-height:420px;border-radius:12px;">
            <table>
              <thead>
                <tr>
                  <th style="width:56px;">id</th>
                  <th style="width:190px;">time</th>
                  <th>english_line</th>
                  <th>photo_prompt</th>
                  <th style="width:210px;">camera</th>
                </tr>
              </thead>
              <tbody id="cueTbody"></tbody>
            </table>
          </div>

          <div class="field" style="margin-top:12px;">
            <label>Kling 對齊 JSON（可直接貼入可靈）</label>
            <textarea id="jsonOut" class="mono" readonly></textarea>
            <div class="small">快捷鍵：<span class="kbd">Alt</span> + <span class="kbd">Enter</span> 依模板重建（保留你手動改過的 prompt/camera）</div>
          </div>
        </div>

        <div class="status" id="rightStatus"><b>狀態：</b>等待選擇 SRT</div>
      </div>
    </section>

  </div>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  const fileSrts = $('fileSrts');
  const dropSrt = $('dropSrt');
  const templateSel = $('template');
  const styleTail = $('styleTail');
  const fileList = $('fileList');
  const batchStatus = $('batchStatus');
  const btnResetAll = $('btnResetAll');
  const btnBuildAll = $('btnBuildAll');
  const btnZipJsonOnly = $('btnZipJsonOnly');
  const btnZipAllWithImages = $('btnZipAllWithImages');
  const zipName = $('zipName');

  const activeBadge = $('activeBadge');
  const cueChip = $('cueChip');
  const imgChip = $('imgChip');
  const klingChip = $('klingChip');
  const btnDownloadActiveJson = $('btnDownloadActiveJson');
  const btnDownloadActiveSrt = $('btnDownloadActiveSrt');

  const btnGenImagesActive = $('btnGenImagesActive');
  const btnClearGenImages = $('btnClearGenImages');
  const btnGenImagesAll = $('btnGenImagesAll');
  const btnStopGen = $('btnStopGen');
  const genBar = $('genBar');
  const genHint = $('genHint');
  const imgApiUrl = $('imgApiUrl');
  const imgModel = $('imgModel');
  const imgSize = $('imgSize');

  const dropImg = $('dropImg');
  const fileImgs = $('fileImgs');
  const notes = $('notes');

  const emptyEditor = $('emptyEditor');
  const editorArea = $('editorArea');
  const cueTbody = $('cueTbody');
  const jsonOut = $('jsonOut');
  const rightStatus = $('rightStatus');

  let batches = [];
  let activeIndex = -1;
  let isGenerating = false;
  let stopRequested = false;

  const pad3 = (n)=>String(n).padStart(3,'0');

  function downloadBlob(filename, blob){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }
  function downloadText(filename, text, mime){
    downloadBlob(filename, new Blob([text], {type: mime || 'text/plain'}));
  }

  function b64ToBlob(b64, mime){
    const bin = atob(b64);
    const bytes = new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
    return new Blob([bytes], { type: mime || "image/png" });
  }

  function setProgress(done, total){
    const pct = total ? Math.round((done/total)*100) : 0;
    if(genBar) genBar.style.width = pct + '%';
    if(genHint) genHint.textContent = pct + '%';
  }

  async function genBatch(prompts){
    const url = (imgApiUrl && imgApiUrl.value) ? imgApiUrl.value.trim() : "";
    if(!url) throw new Error("缺少圖片 API URL");
    const model = (imgModel && imgModel.value) ? imgModel.value.trim() : "gpt-image-1.5";
    const size = (imgSize && imgSize.value) ? imgSize.value : "1024x1024";

    const r = await fetch(url, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ prompts, model, size, background: "auto", moderation: "auto" })
    });

    const data = await r.json().catch(()=>null);
    if(!r.ok){
      const msg = data ? JSON.stringify(data) : (""+r.status);
      throw new Error("生圖失敗：" + msg);
    }

    // Edge Function returns {images:[b64...]} OR legacy {b64:"..."}
    const arr = data && (data.images || data.b64s || null);
    if(Array.isArray(arr) && arr.length){
      return arr.map(b64 => b64ToBlob(b64, "image/png"));
    }

    const single = data && (data.b64 || (data.data && data.data[0] && data.data[0].b64_json));
    if(single){
      return [b64ToBlob(single, "image/png")];
    }
    throw new Error("回傳缺少 images/b64");
  }

  async function genOneImage(prompt){
    const blobs = await genBatch([prompt]);
    return blobs[0];
  }

  function normalizeLine(s){
    return (s||"").replace(/\uFEFF/g,'').replace(/\r/g,'').trimEnd();
  }
  function parseSrt(raw){
  raw = raw.replace(/\uFEFF/g,'').replace(/\r/g,'').trim();
  if(!raw) return [];
  const blocks = raw.split(/\n\s*\n/g);
  const cues = [];
  let autoId = 1;
  for(const block of blocks){
    const lines = block.split('\n').map(l=>l.trim()).filter(Boolean);
    if(lines.length < 2) continue;
    let timeLine = lines[0];
    let textStart = 1;
    if(/^\d+$/.test(lines[0]) && lines[1]?.includes('-->')){
      timeLine = lines[1];
      textStart = 2;
    }
    const m = timeLine.match(/(\d{2}:\d{2}:\d{2},\d{3})\s*-->\s*(\d{2}:\d{2}:\d{2},\d{3})/);
    if(!m) continue;
    const text = lines.slice(textStart).join(' ');
    cues.push({
      id: autoId++,
      start: m[1],
      end: m[2],
      text
    });
  }
  return cues;
}

    raw = normalizeLine(raw);
    if(!raw) return [];
    const blocks = raw.split(/\n\s*\n/g).map(b=>b.trim()).filter(Boolean);
    const out = [];
    for (const b of blocks){
      const lines = b.split('\n').map(l=>l.trimEnd());
      if(lines.length < 2) continue;
      let idxLine = lines[0].trim();
      let timeLine = lines[1].trim();
      let id = parseInt(idxLine, 10);
      if(Number.isNaN(id)){
        timeLine = lines[0].trim();
        id = out.length + 1;
      }
      const m = timeLine.match(/^(\d{2}:\d{2}:\d{2},\d{3})\s*-->\s*(\d{2}:\d{2}:\d{2},\d{3})/);
      if(!m) continue;
      const start = m[1], end = m[2];
      const textLines = lines.slice(Number.isNaN(parseInt(idxLine,10)) ? 1 : 2);
      const text = textLines.join(' ').replace(/\s+/g,' ').trim(); // 英文不改，只壓空白
      out.push({id, start, end, text});
    }
    out.sort((a,b)=>a.id-b.id);
    return out.map((c,i)=>({ ...c, id: i+1 }));
  }

  function buildCameraByText(t){
    const s = (t||"").toLowerCase();
    if (/[?]/.test(t)) return "Medium shot, subtle push in";
    if (/(roar|roaring|terrified|trap|escape|struggle|scared|jaws|swallow)/.test(s)) return "Slow push in, slight handheld tension";
    if (/(ran|running|climbed|sliding|jumping|rolled|reached|fastened)/.test(s)) return "Gentle follow shot, slow tracking";
    if (/(thank|kindness|friends|help|happily|prince|forgive)/.test(s)) return "Slow zoom out, warm ending";
    if (/(once upon|lived|forest|jungle|village)/.test(s)) return "Slow push in from wide establishing shot";
    if (t.trim().length <= 6) return "Quick close-up";
    return "Static to slow push in";
  }

  function ensureNoTextTail(tail){
    const tailStr = (tail||"").trim();
    if(!tailStr) return "無文字";
    if(/無文字/.test(tailStr)) return tailStr;
    return `${tailStr}，無文字`;
  }

  function promptGeneric(t, tail){
    const s = (t||"").toLowerCase();
    let p = "通用故事畫面，角色清晰，背景柔和，情緒隨劇情變化";
    if (/(forest|jungle)/.test(s)) p = "森林場景，柔和自然光，層次景深，童話氛圍";
    if (/(trap|ropes|net|hunters|cart|village)/.test(s)) p = "危機場景，陷阱與繩索網子，緊張氛圍，童話插畫";
    if (/(scared|please|forgive|swallow|jaws|terrified)/.test(s)) p = "緊張近景，情緒強烈，光影加深，童話插畫";
    if (/(thank|help|friends|happily|kindness|prince)/.test(s)) p = "溫暖情緒，角色互動，柔和光線，童話插畫";
    const tail2 = ensureNoTextTail(tail);
    return `${p}，${tail2}`;
  }

  function promptLionMouse(t, tail){
    const s = (t||"").toLowerCase();
    let p = "";
    if (s.includes("lion and the mouse")) p = "童話森林開場，清晨薄霧，溫和自然光，故事書風格";
    else if (s.includes("ruled the forest") || s.includes("once upon a time")) p = "雄獅站在森林中央，神情威嚴自信，周圍動物保持距離";
    else if (s.includes("fell asleep") || s.includes("asleep under a tree")) p = "獅子在大樹下熟睡，陽光穿過樹葉，午後安靜森林";
    else if (s.includes("little mouse") && s.includes("fun to play")) p = "小老鼠靠近睡著的獅子，表情好奇調皮，森林背景";
    else if (s.includes("running up and down")) p = "小老鼠在獅子身上跑來跑去，輕快可愛";
    else if (s.includes("tail") && (s.includes("slid") || s.includes("slide"))) p = "小老鼠沿著獅子尾巴滑下，動作趣味，森林背景";
    else if (s.includes("grabbed") || s.includes("huge paw")) p = "獅子驚醒，用巨大前掌抓住小老鼠，緊張瞬間";
    else if (s.includes("struggled")) p = "小老鼠掙扎但無法逃脫，近景聚焦";
    else if (s.includes("swallow") || s.includes("jaws")) p = "獅子張開大嘴準備吞食，畫面張力強";
    else if (s.includes("scared") || s.includes("please") || s.includes("forgive")) p = "小老鼠害怕求饒，眼神驚恐，強烈對比";
    else if (s.includes("amused")) p = "獅子覺得好笑，情緒緩和，光線變柔";
    else if (s.includes("let him go")) p = "獅子抬起前掌放走老鼠，氣氛緩和";
    else if (s.includes("few days later") || s.includes("roaming")) p = "幾天後，獅子在叢林中漫步，遠景開闊";
    else if (s.includes("trap") || s.includes("ropes") || s.includes("net")) p = "獵人設下陷阱與繩索網子，暗藏危機";
    else if (s.includes("cart") || s.includes("transport")) p = "獵人帶著大車返回，遠處車影與人影";
    else if (s.includes("king is in trouble") || s.includes("return the favor")) p = "老鼠決心回報恩情，表情堅定";
    else if (s.includes("bite through the ropes")) p = "老鼠用尖牙咬斷繩索，近景特寫";
    else if (s.includes("freed the lion")) p = "獅子重獲自由，畫面釋放感";
    else if (s.includes("great help") || s.includes("thank you")) p = "獅子感謝老鼠，彼此平視，溫暖收束";
    else if (s.includes("prince")) p = "獅子宣布老鼠成為森林王子，榮耀時刻";
    else if (s.includes("ha!") || s.includes("yay") || s.includes("we are back")) p = "獅子與老鼠玩耍大笑，輕快可愛";
    else p = "森林童話場景，獅子與老鼠同框，情緒依情節變化";
    const tail2 = ensureNoTextTail(tail);
    return `${p}，${tail2}`;
  }

  function buildSceneForBatch(cues){
    const tpl = templateSel.value;
    const tail = styleTail.value;
    return cues.map(c => ({
      id: c.id,
      start: c.start,
      end: c.end,
      photo_prompt: (tpl === 'custom') ? "" : (tpl === 'lion_mouse' ? promptLionMouse(c.text, tail) : promptGeneric(c.text, tail)),
      english_line: c.text,
      camera: buildCameraByText(c.text)
    }));
  }

  function klingArray(scene){
    return (scene||[]).map(s => ({
      id: s.id,
      photo_prompt: s.photo_prompt || "",
      english_line: s.english_line,
      camera: s.camera || ""
    }));
  }

  function escapeHtml(s){
    return (s||"").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
  }

  function refreshLeftList(){
    fileList.innerHTML = "";
    if(!batches.length){
      batchStatus.innerHTML = "<b>狀態：</b>尚未匯入 SRT";
      btnBuildAll.disabled = true;
    btnGenImagesActive.disabled = true;
    btnClearGenImages.disabled = true;
      btnZipJsonOnly.disabled = true;
      btnZipAllWithImages.disabled = true;
      return;
    }
    const totalCues = batches.reduce((sum,b)=>sum+(b.cues?.length||0),0);
    batchStatus.innerHTML = `<b>狀態：</b>已匯入 ${batches.length} 支 SRT（共 ${totalCues} 段字幕）`;
    btnBuildAll.disabled = false;

    const hasAllScene = batches.every(b => Array.isArray(b.scene) && b.scene.length);
    btnZipJsonOnly.disabled = !hasAllScene;
    btnZipAllWithImages.disabled = !hasAllScene;

    batches.forEach((b,idx)=>{
      const div = document.createElement('div');
      div.className = "item" + (idx===activeIndex ? " active":"");
      div.innerHTML = `
        <div>
          <div class="name">${pad3(idx+1)}｜${escapeHtml(b.name)}</div>
          <div class="meta">${b.cues.length} 段 · ${b.scene?.length? "scene.json ✅":"scene.json ❌"}</div>
        </div>
        <div class="chip mono">${(b.imagesGenerated?.length||0) ? ((b.imagesGenerated.length)+" 張生圖") : ((b.images?.length ? (b.images.length+" 張圖") : "0 張圖"))}</div>
      `;
      div.addEventListener('click', ()=>setActive(idx));
      fileList.appendChild(div);
    });
  }

  function setActive(idx){
    activeIndex = idx;
    refreshLeftList();

    const b = batches[idx];
    activeBadge.textContent = `${pad3(idx+1)}｜${b.name}`;
    cueChip.textContent = `字幕段數：${b.cues.length}`;
    imgChip.textContent = `圖片：${(b.imagesGenerated?.length||0) ? (b.imagesGenerated.length+' 張生圖') : ((b.images?.length||0)+' 張')}`;
    klingChip.textContent = `Kling JSON 已就緒：${(b.scene && b.scene.length) ? "是":"否"}`;

    btnDownloadActiveSrt.disabled = false;

    btnGenImagesActive.disabled = !(b.scene && b.scene.length) || isGenerating;
    btnGenImagesAll.disabled = !(b.scene && b.scene.length) || isGenerating;
    btnStopGen.disabled = !isGenerating;
    btnClearGenImages.disabled = !((b.imagesGenerated && b.imagesGenerated.length) || false) || isGenerating;

    // show editor
    emptyEditor.style.display = "none";
    editorArea.style.display = "block";
    renderTable(b);

    if(!b.scene || !b.scene.length){
      rightStatus.innerHTML = `<b>狀態：</b>此 SRT 尚未產生 scene.json（按左側「產生所有 scene.json」）`;
      btnDownloadActiveJson.disabled = true;
    }else{
      rightStatus.innerHTML = `<b>狀態：</b>可直接複製 Kling JSON 貼入可靈`;
      btnDownloadActiveJson.disabled = false;
    }
    syncActiveJson();
  }

  function renderTable(batch){
    cueTbody.innerHTML = "";
    if(!batch.scene || !batch.scene.length){
      batch.scene = batch.cues.map(c=>({
        id: c.id, start:c.start, end:c.end,
        photo_prompt: "",
        english_line: c.text,
        camera: buildCameraByText(c.text)
      }));
    }

    batch.scene.forEach((item)=>{
      const tr = document.createElement('tr');

      const tdId = document.createElement('td'); tdId.textContent = item.id;

      const tdTime = document.createElement('td');
      tdTime.className = "mono";
      tdTime.textContent = `${item.start} → ${item.end}`;

      const tdLine = document.createElement('td');
      tdLine.className = "cellline";
      tdLine.textContent = item.english_line;

      const tdPrompt = document.createElement('td');
      const promptInput = document.createElement('textarea');
      promptInput.value = item.photo_prompt || "";
      promptInput.className = "mono";
      promptInput.style.minHeight = "64px";
      promptInput.style.width = "100%";
      promptInput.addEventListener('input', ()=>{
        item.photo_prompt = promptInput.value;
        syncActiveJson();
      });
      tdPrompt.appendChild(promptInput);

      const tdCam = document.createElement('td');
      const camInput = document.createElement('input');
      camInput.type = "text";
      camInput.value = item.camera || "";
      camInput.className = "mono";
      camInput.style.width = "100%";
      camInput.addEventListener('input', ()=>{
        item.camera = camInput.value;
        syncActiveJson();
      });
      tdCam.appendChild(camInput);

      tr.appendChild(tdId);
      tr.appendChild(tdTime);
      tr.appendChild(tdLine);
      tr.appendChild(tdPrompt);
      tr.appendChild(tdCam);
      cueTbody.appendChild(tr);
    });
  }

  function syncActiveJson(){
    if(activeIndex < 0) return;
    const b = batches[activeIndex];
    const arr = klingArray(b.scene || []);
    jsonOut.value = JSON.stringify(arr, null, 2);
    klingChip.textContent = `Kling JSON 已就緒：${arr.length ? "是":"否"}`;
    btnDownloadActiveJson.disabled = !(b.scene && b.scene.length);
    btnGenImagesActive.disabled = !(b.scene && b.scene.length) || isGenerating;
    btnGenImagesAll.disabled = !(b.scene && b.scene.length) || isGenerating;
    btnStopGen.disabled = !isGenerating;
    btnClearGenImages.disabled = !((b.imagesGenerated && b.imagesGenerated.length) || false) || isGenerating;
    refreshLeftList();
    const hasAllScene = batches.length && batches.every(bb => bb.scene && bb.scene.length);
    btnZipJsonOnly.disabled = !hasAllScene;
    btnZipAllWithImages.disabled = !hasAllScene;
  }

  async function addSrtFiles(files){
    const list = Array.from(files || []).filter(f => f && f.name);
    if(!list.length) return;

    for(const f of list){
      const raw = await f.text();
      const cues = parseSrt(raw);
      batches.push({ name: f.name, rawSrt: raw, cues, scene: [], images: [], imagesGenerated: [] });
    }
    if(activeIndex === -1 && batches.length) activeIndex = 0;
    refreshLeftList();
    if(activeIndex >= 0) setActive(activeIndex);
    btnBuildAll.disabled = false;
  }

  fileSrts.addEventListener('change', (e)=>{ addSrtFiles(e.target.files); e.target.value = ""; });

  ["dragenter","dragover"].forEach(evt=>{
    dropSrt.addEventListener(evt, (e)=>{ e.preventDefault(); dropSrt.style.borderColor = "rgba(37,99,235,.7)"; });
  });
  ["dragleave","drop"].forEach(evt=>{
    dropSrt.addEventListener(evt, (e)=>{ e.preventDefault(); dropSrt.style.borderColor = "rgba(170,183,214,.35)"; });
  });
  dropSrt.addEventListener('drop', (e)=>{ addSrtFiles(e.dataTransfer.files); });

  btnBuildAll.addEventListener('click', ()=>{
    if(!batches.length) return;
    for(const b of batches){ b.scene = buildSceneForBatch(b.cues || []); }
    refreshLeftList();
    if(activeIndex>=0) setActive(activeIndex);
  });

  btnResetAll.addEventListener('click', ()=>{
    batches = []; activeIndex = -1; isGenerating = false;
    refreshLeftList();
    activeBadge.textContent = "未選擇";
    cueChip.textContent = "尚未選擇 SRT";
    imgChip.textContent = "尚未匯入圖片";
    klingChip.textContent = "Kling JSON 已就緒：否";
    btnDownloadActiveJson.disabled = true;
    btnDownloadActiveSrt.disabled = true;
    btnBuildAll.disabled = true;
    btnGenImagesActive.disabled = true;
    btnClearGenImages.disabled = true;
    btnZipJsonOnly.disabled = true;
    btnZipAllWithImages.disabled = true;
    jsonOut.value = "";
    emptyEditor.style.display = "block";
    editorArea.style.display = "none";
    rightStatus.innerHTML = "<b>狀態：</b>等待選擇 SRT";
  });

  btnDownloadActiveSrt.addEventListener('click', ()=>{
    if(activeIndex<0) return;
    const b = batches[activeIndex];
    downloadText(b.name, b.rawSrt, "text/plain");
  });

  btnDownloadActiveJson.addEventListener('click', ()=>{
    if(activeIndex<0) return;
    const b = batches[activeIndex];
    const filename = b.name.replace(/\.srt$/i,'') + ".scene.json";
    downloadText(filename, JSON.stringify(klingArray(b.scene||[]), null, 2), "application/json");
  });

  function setImagesForActive(files){
    if(activeIndex<0) return;
    const b = batches[activeIndex];
    b.images = Array.from(files || []).filter(f => f && f.type && f.type.startsWith("image/"));
    imgChip.textContent = `圖片：${b.images.length} 張`;
    const totalTargets = b.cues.filter(c=> (b.scene?.find(s=>s.id===c.id)?.photo_prompt||'').trim() ).length;
    const done = (b.imagesGenerated?.length||0);
    setProgress(done, totalTargets || 1);
    refreshLeftList();
  }

  fileImgs.addEventListener('change', (e)=>{ setImagesForActive(e.target.files); e.target.value = ""; });

  ["dragenter","dragover"].forEach(evt=>{
    dropImg.addEventListener(evt, (e)=>{ e.preventDefault(); dropImg.style.borderColor = "rgba(37,99,235,.7)"; });
  });
  ["dragleave","drop"].forEach(evt=>{
    dropImg.addEventListener(evt, (e)=>{ e.preventDefault(); dropImg.style.borderColor = "rgba(170,183,214,.35)"; });
  });
  dropImg.addEventListener('drop', (e)=>{ setImagesForActive(e.dataTransfer.files); });


  async function generateImagesForActive(){
    // 先試跑：最多 5 張（跳過已生成）
    if(activeIndex < 0) return;
    const b = batches[activeIndex];
    if(!b.scene || !b.scene.length) throw new Error("先產生 scene.json");
    if(isGenerating) return;

    const existing = new Set((b.imagesGenerated||[]).map(x=>x.id));
    const pending = b.scene.filter(s => (s.photo_prompt||"").trim() && !existing.has(s.id));
    const totalTargets = b.scene.filter(s => (s.photo_prompt||"").trim()).length;
    const doneBefore = (b.imagesGenerated||[]).length;

    if(!pending.length){
      rightStatus.innerHTML = `<b>狀態：</b>已完成：${doneBefore}/${totalTargets}（沒有可生成的段落）`;
      setProgress(doneBefore, totalTargets);
      return;
    }

    const batch = pending.slice(0,5);
    const prompts = batch.map(s => (s.photo_prompt||"").trim());

    isGenerating = true;
    stopRequested = false;
    btnGenImagesActive.disabled = true;
    btnGenImagesAll.disabled = true;
    btnStopGen.disabled = false;
    btnClearGenImages.disabled = true;

    rightStatus.innerHTML = `<b>狀態：</b>試跑中…（本批次 ${batch.length} 張 / 5）`;
    setProgress(doneBefore, totalTargets);

    try{
      const blobs = await genBatch(prompts); // blobs length == batch length
      const out = b.imagesGenerated ? [...b.imagesGenerated] : [];
      for(let i=0;i<batch.length;i++){
        const id = batch[i].id;
        out.push({ id, blob: blobs[i] });
      }
      out.sort((a,b)=>a.id-b.id);
      b.imagesGenerated = out;

      const done = b.imagesGenerated.length;
      imgChip.textContent = `圖片：${done} 張生圖`;
      refreshLeftList();
      rightStatus.innerHTML = `<b>狀態：</b>本次完成 ${batch.length} 張；累積 ${done}/${totalTargets}`;
      setProgress(done, totalTargets);
    }finally{
      isGenerating = false;
      btnStopGen.disabled = true;
      btnGenImagesActive.disabled = !(b.scene && b.scene.length);
      btnGenImagesAll.disabled = !(b.scene && b.scene.length);
      btnClearGenImages.disabled = !(b.imagesGenerated && b.imagesGenerated.length);
    }
  }

  btnGenImagesActive.addEventListener  btnGenImagesActive.addEventListener('click', ()=>{
    generateImagesForActive().catch(err=>{
      rightStatus.innerHTML = `<b>狀態：</b>生圖失敗：${escapeHtml(String(err))}`;
      isGenerating = false;
      if(activeIndex>=0){
        const b = batches[activeIndex];
        btnGenImagesActive.disabled = !(b.scene && b.scene.length);
        btnClearGenImages.disabled = !(b.imagesGenerated && b.imagesGenerated.length);
      }
    });
  });


  async function generateAllSlow(){
    if(activeIndex < 0) return;
    const b = batches[activeIndex];
    if(!b.scene || !b.scene.length) throw new Error("先產生 scene.json");
    if(isGenerating) return;

    const totalTargets = b.scene.filter(s => (s.photo_prompt||"").trim()).length;

    isGenerating = true;
    stopRequested = false;
    btnGenImagesActive.disabled = true;
    btnGenImagesAll.disabled = true;
    btnStopGen.disabled = false;
    btnClearGenImages.disabled = true;

    try{
      while(true){
        if(stopRequested){
          const done = (b.imagesGenerated||[]).length;
          rightStatus.innerHTML = `<b>狀態：</b>已停止（累積 ${done}/${totalTargets}）`;
          setProgress(done, totalTargets);
          break;
        }

        const existing = new Set((b.imagesGenerated||[]).map(x=>x.id));
        const pending = b.scene.filter(s => (s.photo_prompt||"").trim() && !existing.has(s.id));
        if(!pending.length){
          const done = (b.imagesGenerated||[]).length;
          rightStatus.innerHTML = `<b>狀態：</b>全數完成：${done}/${totalTargets}`;
          setProgress(done, totalTargets);
          break;
        }

        const batch = pending.slice(0,5);
        const prompts = batch.map(s => (s.photo_prompt||"").trim());

        const doneBefore = (b.imagesGenerated||[]).length;
        rightStatus.innerHTML = `<b>狀態：</b>慢速生成中…（本批次 ${batch.length} 張 / 5）· 累積 ${doneBefore}/${totalTargets}`;
        setProgress(doneBefore, totalTargets);

        const blobs = await genBatch(prompts);

        const out = b.imagesGenerated ? [...b.imagesGenerated] : [];
        for(let i=0;i<batch.length;i++){
          out.push({ id: batch[i].id, blob: blobs[i] });
        }
        out.sort((a,b)=>a.id-b.id);
        b.imagesGenerated = out;

        const done = b.imagesGenerated.length;
        imgChip.textContent = `圖片：${done} 張生圖`;
        refreshLeftList();
        setProgress(done, totalTargets);

        // 批次間隔（慢速）
        await new Promise(res=>setTimeout(res, 900));
      }
    }catch(err){
      const done = (b.imagesGenerated||[]).length;
      rightStatus.innerHTML = `<b>狀態：</b>慢速生成中斷：${escapeHtml(String(err))}（累積 ${done}/${totalTargets}）`;
      setProgress(done, totalTargets);
    }finally{
      isGenerating = false;
      btnStopGen.disabled = true;
      btnGenImagesActive.disabled = !(b.scene && b.scene.length);
      btnGenImagesAll.disabled = !(b.scene && b.scene.length);
      btnClearGenImages.disabled = !(b.imagesGenerated && b.imagesGenerated.length);
    }
  }

  btnGenImagesAll.addEventListener('click', ()=>{
    generateAllSlow();
  });

  btnStopGen.addEventListener('click', ()=>{
    stopRequested = true;
    btnStopGen.disabled = true;
  });

  btnClearGenImages.addEventListener('click', ()=>{
    if(activeIndex<0) return;
    const b = batches[activeIndex];
    b.imagesGenerated = [];
    imgChip.textContent = `圖片：${(b.images?.length||0)} 張`;
    refreshLeftList();
    btnClearGenImages.disabled = true;
    rightStatus.innerHTML = `<b>狀態：</b>已清除生成圖片（你仍可手動匯入圖片後打包）`;
    setProgress(0,1);
  });

  function sanitizeFolderName(s){ return (s||"batch").replace(/[\\/:*?"<>|]/g,"_").slice(0,80); }
  function guessExt(file){
    const n = (file.name||"").toLowerCase();
    if(n.endsWith(".png")) return ".png";
    if(n.endsWith(".jpg") || n.endsWith(".jpeg")) return ".jpg";
    if(n.endsWith(".webp")) return ".webp";
    if(file.type === "image/png") return ".png";
    if(file.type === "image/jpeg") return ".jpg";
    if(file.type === "image/webp") return ".webp";
    return ".png";
  }

  async function zipJsonOnly(){
    const zip = new JSZip();
    const noteText = (notes.value || "").trim();
    if(noteText) zip.file("README.txt", noteText);

    batches.forEach((b, idx)=>{
      const folderName = `${pad3(idx+1)}_${sanitizeFolderName(b.name.replace(/\.srt$/i,''))}`;
      const folder = zip.folder(folderName);
      folder.file(b.name, b.rawSrt);
      folder.file("scene.json", JSON.stringify(klingArray(b.scene||[]), null, 2));
    });

    const blob = await zip.generateAsync({type:"blob"});
    downloadBlob(zipName.value || "fos_batch_package.zip", blob);
  }

  async function zipAllWithImages(){
    const zip = new JSZip();
    const noteText = (notes.value || "").trim();
    if(noteText) zip.file("README.txt", noteText);

    for (let idx=0; idx<batches.length; idx++){
      const b = batches[idx];
      const folderName = `${pad3(idx+1)}_${sanitizeFolderName(b.name.replace(/\.srt$/i,''))}`;
      const folder = zip.folder(folderName);
      folder.file(b.name, b.rawSrt);
      folder.file("scene.json", JSON.stringify(klingArray(b.scene||[]), null, 2));

      if((b.imagesGenerated && b.imagesGenerated.length) || (b.images && b.images.length)){
        const imgF = folder.folder("images");

        // 1) 優先：系統生成（對齊 cue id）
        if(b.imagesGenerated && b.imagesGenerated.length){
          const sorted = [...b.imagesGenerated].sort((a,b)=>a.id-b.id);
          for(const it of sorted){
            const name = `${pad3(it.id)}.png`;
            const buf = await it.blob.arrayBuffer();
            imgF.file(name, buf);
          }
        }else if(b.images && b.images.length){
          // 2) 次選：手動匯入（依匯入順序 001/002…）
          for (let i=0; i<b.images.length; i++){
            const file = b.images[i];
            const ext = guessExt(file);
            const name = `${pad3(i+1)}${ext}`;
            const buf = await file.arrayBuffer();
            imgF.file(name, buf);
          }
        }
      }
    }

    const blob = await zip.generateAsync({type:"blob"});
    downloadBlob(zipName.value || "fos_batch_package.zip", blob);
  }

  btnZipJsonOnly.addEventListener('click', ()=>{
    const ok = batches.length && batches.every(b => b.scene && b.scene.length);
    if(ok) zipJsonOnly();
  });
  btnZipAllWithImages.addEventListener('click', ()=>{
    const ok = batches.length && batches.every(b => b.scene && b.scene.length);
    if(ok) zipAllWithImages();
  });

  document.addEventListener('keydown', (e)=>{
    if(e.altKey && e.key === "Enter"){
      if(activeIndex<0) return;
      const b = batches[activeIndex];
      if(templateSel.value === "custom"){ syncActiveJson(); return; }
      const rebuilt = buildSceneForBatch(b.cues || []);
      const oldById = new Map((b.scene||[]).map(x=>[x.id, x]));
      rebuilt.forEach(x=>{
        const old = oldById.get(x.id);
        if(old){
          if((old.photo_prompt||"").trim()) x.photo_prompt = old.photo_prompt;
          if((old.camera||"").trim()) x.camera = old.camera;
        }
      });
      b.scene = rebuilt;
      setActive(activeIndex);
    }
  });

})();
</script>
</body>
</html>
