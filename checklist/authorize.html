<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin｜授權／暫停管理員</title>

  <style>
    :root{
      --bg:#f4f6fb;
      --card-bg:#fff;
      --muted:#6b7280;
      --border:#e5e7eb;
      --brand:#2563eb;
      --brand-soft:#e0edff;
      --radius-lg:18px;
      --shadow-card:0 10px 30px rgba(15,23,42,.08);
      --danger:#b91c1c;
    }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC","Microsoft JhengHei";
      background:var(--bg);
      color:#111827;
    }
    .wrap{
      max-width:640px;
      margin:24px auto 80px;
      padding:0 16px 40px;
    }

    header{margin-bottom:10px;}
    .title{font-size:1.5rem;font-weight:700;}
    .subtitle{font-size:.9rem;color:var(--muted);margin-top:4px;}

    .top-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:6px;
      margin-bottom:14px;
    }
    .back-btn{
      font-size:.85rem;
      color:#2563eb;
      cursor:pointer;
      text-decoration:none;
      padding:6px 14px;
      border:1px solid #2563eb;
      border-radius:999px;
      background:#fff;
    }
    .admin-mail{
      font-size:.85rem;
      color:#6b7280;
    }

    .tabs{
      display:flex;
      gap:10px;
      margin-bottom:18px;
      flex-wrap:wrap;
    }
    .tab{
      padding:8px 18px;
      border-radius:30px;
      border:1px solid #d1d5db;
      font-size:.9rem;
      background:#fff;
      color:#374151;
      text-decoration:none;
    }
    .tab.active{
      background:#2563eb;
      color:#fff;
      border-color:#2563eb;
    }

    .card{
      background:var(--card-bg);
      border-radius:var(--radius-lg);
      padding:18px 18px 16px;
      box-shadow:var(--shadow-card);
    }

    .field{
      margin-bottom:14px;
    }
    .label{
      font-size:.88rem;
      font-weight:600;
      margin-bottom:6px;
    }
    .ipt, .select{
      width:100%;
      padding:8px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      font-size:.95rem;
    }
    .hint{
      margin-top:4px;
      font-size:.8rem;
      color:var(--muted);
    }

    .btn-row{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top:6px;
    }
    .btn{
      padding:8px 18px;
      border-radius:999px;
      border:1px solid #2563eb;
      background:#2563eb;
      color:#fff;
      cursor:pointer;
      font-size:.9rem;
    }
    .btn.secondary{
      background:#fff;
      color:#2563eb;
    }

    .result{
      margin-top:14px;
      padding:10px 12px;
      border-radius:10px;
      font-size:.88rem;
      background:#f9fafb;
      border:1px solid var(--border);
      color:#374151;
      white-space:pre-line;
    }
    .result.error{
      background:#fef2f2;
      border-color:#fecaca;
      color:var(--danger);
    }

    .note-box{
      margin-top:14px;
      font-size:.8rem;
      color:var(--muted);
      line-height:1.5;
    }
    .note-box code{
      background:#e5e7eb;
      padding:1px 4px;
      border-radius:4px;
      font-size:.78rem;
    }
  </style>
</head>

<body>
<div class="wrap">

  <header>
    <div class="title">BookWide Admin｜授權／暫停管理員</div>
    <div class="subtitle">依 Email 更新 <code>is_admin</code> 與 <code>is_paused</code> 欄位。</div>
  </header>

  <div class="top-row">
    <a href="/admin.html" class="back-btn">← 回上頁</a>
    <div class="admin-mail">管理員：<span id="adminEmail">檢查中…</span></div>
  </div>

  <!-- 簡單的兩頁 Tab：使用者清單 / 授權頁 -->
  <nav class="tabs">
    <a href="user.html" class="tab">使用者清單</a>
    <span class="tab active">授權／暫停管理員</span>
  </nav>

  <section class="card">

    <div class="field">
      <div class="label">目標 Email</div>
      <input id="emailInput" class="ipt" type="email" placeholder="user@example.com" />
      <div class="hint">請輸入要變更權限的帳號 Email（需存在於 public.profiles）。</div>
    </div>

    <div class="field">
      <div class="label">動作</div>
      <select id="actionSelect" class="select">
        <option value="grant_admin">授予管理員（is_admin = true, is_paused = false）</option>
        <option value="revoke_admin">取消管理員（is_admin = false）</option>
        <option value="pause">停用帳號（is_paused = true）</option>
        <option value="resume">恢復帳號（is_paused = false）</option>
      </select>
      <div class="hint">更新欄位：<code>is_admin</code>、<code>is_paused</code>。</div>
    </div>

    <div class="btn-row">
      <button id="applyBtn" class="btn">執行更新</button>
      <button id="checkBtn" class="btn secondary">只檢查目前狀態</button>
    </div>

    <div id="resultBox" class="result" style="display:none;"></div>

    <div class="note-box">
      ‧ 建議：至少保留 1 個管理員帳號，避免全部被停用。<br>
      ‧ 此頁只改 <code>profiles</code> 表中的欄位，不會動到訂單或其它資料。
    </div>

  </section>
</div>

<!-- Supabase + Admin 守門 -->
<script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
<script>
  const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
  const SUPABASE_ANON =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";

  const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  async function requireAdmin() {
    const { data:{session} } = await supa.auth.getSession();
    if (!session) {
      alert("請先登入");
      location.href = "/index.html";
      throw 0;
    }
    const { data: prof, error } = await supa
      .from("profiles")
      .select("email,is_admin,is_paused")
      .eq("id", session.user.id)
      .single();

    if (error || !prof || !prof.is_admin || prof.is_paused) {
      alert("您沒有後台管理權限");
      location.href = "/index.html";
      throw 0;
    }
    document.getElementById("adminEmail").textContent = prof.email || "";
  }

  // 取得指定 email 的 profile
  async function fetchProfileByEmail(email) {
    const { data, error } = await supa
      .from("profiles")
      .select("id,email,is_admin,is_paused")
      .eq("email", email)
      .maybeSingle();

    if (error) throw error;
    return data;
  }

  function showResult(msg, isError=false) {
    const box = document.getElementById("resultBox");
    box.style.display = "block";
    box.textContent = msg;
    box.classList.toggle("error", !!isError);
  }

  function formatStatus(p) {
    if (!p) return "尚未建立此帳號。";
    return [
      `Email：${p.email}`,
      `is_admin：${p.is_admin ? "true（管理員）" : "false（一般帳號）"}`,
      `is_paused：${p.is_paused ? "true（已停用）" : "false（啟用中）"}`
    ].join("\n");
  }

  async function handleCheck() {
    const email = document.getElementById("emailInput").value.trim();
    if (!email) {
      showResult("請先輸入 Email。", true);
      return;
    }
    try {
      const p = await fetchProfileByEmail(email);
      if (!p) {
        showResult(`找不到此 Email：${email}`, true);
      } else {
        showResult("目前狀態：\n" + formatStatus(p), false);
      }
    } catch (e) {
      console.error(e);
      showResult("讀取失敗，請稍後再試。", true);
    }
  }

  async function handleApply() {
    const email = document.getElementById("emailInput").value.trim();
    const action = document.getElementById("actionSelect").value;
    if (!email) {
      showResult("請先輸入 Email。", true);
      return;
    }
    try {
      const p = await fetchProfileByEmail(email);
      if (!p) {
        showResult(`找不到此 Email：${email}`, true);
        return;
      }

      let patch = {};
      if (action === "grant_admin") {
        patch = { is_admin: true,  is_paused: false };
      } else if (action === "revoke_admin") {
        patch = { is_admin: false };
      } else if (action === "pause") {
        patch = { is_paused: true };
      } else if (action === "resume") {
        patch = { is_paused: false };
      }

      const { error } = await supa
        .from("profiles")
        .update(patch)
        .eq("id", p.id);

      if (error) throw error;

      const p2 = await fetchProfileByEmail(email);
      showResult("更新完成！\n\n" + formatStatus(p2), false);
    } catch (e) {
      console.error(e);
      showResult("更新失敗，請稍後再試。", true);
    }
  }

  // 初始化：先做守門，再綁定按鈕
  requireAdmin().then(() => {
    document.getElementById("checkBtn").addEventListener("click", handleCheck);
    document.getElementById("applyBtn").addEventListener("click", handleApply);
  });
</script>
</body>
</html>
