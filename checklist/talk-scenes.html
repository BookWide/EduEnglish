<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Talk 場景管理｜BookWide Admin</title>
  <style>
    :root{
      --bg:#f4f6fb;
      --card:#fff;
      --muted:#6b7280;
      --border:#e5e7eb;
      --brand:#2563eb;
      --brand2:#1d4ed8;
      --soft:#e0edff;
      --radius:18px;
      --shadow:0 10px 30px rgba(15,23,42,.08);
      --ink:#111827;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC","Microsoft JhengHei",sans-serif;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1100px;margin:22px auto 80px;padding:0 16px}
    header{display:flex;align-items:flex-start;gap:12px;justify-content:space-between;margin-bottom:14px}
    .h1{font-size:1.25rem;font-weight:800}
    .sub{color:var(--muted);font-size:.9rem;margin-top:4px;line-height:1.5}
    .topbtns{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      padding:8px 14px;border-radius:999px;border:1px solid var(--brand);
      background:var(--brand);color:#fff;font-size:.9rem;text-decoration:none;white-space:nowrap;cursor:pointer;
    }
    .btn.secondary{background:#fff;color:var(--brand)}
    .btn.ghost{background:transparent;color:var(--brand)}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:14px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:.82rem;color:var(--muted);display:block;margin:10px 0 6px}
    input,textarea{
      width:100%;border:1px solid var(--border);border-radius:12px;padding:10px 12px;
      font-size:.95rem;background:#fff;color:var(--ink);
    }
    textarea{min-height:160px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .list{margin-top:10px;border-top:1px solid var(--border)}
    .item{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      padding:10px 0;border-bottom:1px solid var(--border)
    }
    .item b{font-size:.95rem}
    .item small{color:var(--muted)}
    .pill{
      display:inline-flex;padding:3px 10px;border-radius:999px;background:var(--soft);
      color:#1e40af;font-size:.78rem;white-space:nowrap
    }
    .hint{font-size:.85rem;color:var(--muted);line-height:1.6}
    .ok{display:none;margin-top:10px;padding:10px 12px;border:1px solid #bbf7d0;background:#ecfdf5;color:#065f46;border-radius:12px}
    .err{display:none;margin-top:10px;padding:10px 12px;border:1px solid #fecaca;background:#fef2f2;color:#991b1b;border-radius:12px}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:700px){.two{grid-template-columns:1fr}}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="h1">Talk 場景管理（可自行新增）</div>
        <div class="sub">
          這頁只做「場景資料設計」：維護 <span class="mono">index.json</span> 與各場景 <span class="mono">scene.json</span>，
          並一鍵匯出下載（方便你再上傳到 GitHub / Supabase）。<br/>
          ✅ 不依賴後端、可離線使用；✅ 檔名對齊；✅ 可新增/刪除/編輯。
        </div>
      </div>
      <div class="topbtns">
        <a class="btn secondary" href="../admin.html">← 回 Admin</a>
        <button class="btn ghost" id="btnLoadSample">載入示例</button>
        <button class="btn" id="btnExport">匯出下載（index + scenes）</button>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div style="font-weight:800">場景清單</div>
          <span class="pill" id="countPill">0</span>
        </div>

        <label>新增場景（先填基本資料）</label>
        <div class="two">
          <div><input id="newId" placeholder="id（英數底線）例如 coffee_shop" /></div>
          <div><input id="newLevel" placeholder="level 例如 A1 / A2" /></div>
        </div>
        <div class="two" style="margin-top:8px">
          <div><input id="newZh" placeholder="中文標題 例如 買一杯咖啡" /></div>
          <div><input id="newEn" placeholder="英文標題 例如 Coffee Shop" /></div>
        </div>
        <div style="margin-top:8px"><input id="newRole" placeholder="角色 例如 Barista / Front Desk / Airline Staff" /></div>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnAdd">＋ 新增到清單</button>
          <button class="btn secondary" id="btnDelete">刪除目前選取</button>
        </div>

        <div class="list" id="sceneList"></div>

        <div class="hint" style="margin-top:10px">
          匯出檔名規則：<b>scene-{{id}}.json</b>（自動產生）。<br/>
          你要給 talk_A 用，可改名為 <span class="mono">{{id}}.json</span> 或在 talk_A 內做 mapping。
        </div>

        <div class="ok" id="okBox"></div>
        <div class="err" id="errBox"></div>
        <!-- ====== SRT 轉 Talk 對話（測試用） ====== -->
        <div class="card" style="margin-top:14px">
          <div class="h">SRT → 對話骨架（測試）</div>
          <div class="sub">先把 SRT 丟進來，快速產生「場景 JSON 的 dialogue」，讓 talk_A 先跑起來。之後再去 JSON 產生器做 speaking-*.json。</div>

          <div class="grid2" style="margin-top:10px">
            <div>
              <label class="lbl">SRT 檔</label>
              <input id="srtFile" type="file" accept=".srt,.txt" />
            </div>
            <div>
              <label class="lbl">生成模式</label>
              <select id="srtMode">
                <option value="ai_only">全部當 AI 台詞（最穩）</option>
                <option value="ai_user_alt">AI / USER 交錯（跟讀用）</option>
              </select>
            </div>
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
            <button class="btn primary" id="btnSrtBuild">用 SRT 生成 dialogue</button>
            <button class="btn" id="btnSrtPreview">預覽前 10 句</button>
          </div>

          <div class="hint" id="srtHint" style="margin-top:10px;display:none"></div>
        </div>

      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:baseline">
          <div style="font-weight:800">編輯器</div>
          <div class="hint">左邊選場景 → 右邊編輯 JSON → 套用。</div>
        </div>

        <label>index.json（場景索引）</label>
        <textarea id="indexEditor" spellcheck="false"></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn secondary" id="btnApplyIndex">套用 index.json</button>
          <button class="btn ghost" id="btnPrettyIndex">美化格式</button>
        </div>

        <label style="margin-top:14px">目前場景：<span class="mono" id="curSceneId">（未選）</span></label>
        <textarea id="sceneEditor" spellcheck="false"></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn secondary" id="btnApplyScene">套用場景 JSON</button>
          <button class="btn ghost" id="btnPrettyScene">美化格式</button>
          <button class="btn ghost" id="btnNewDialogue">快速生成對話骨架</button>
        </div>

        <div class="hint" style="margin-top:12px">
          最小可用欄位：<span class="mono">id/level/title_zh/title_en/role/meta/dialogue</span>。<br/>
          talk_A 主要吃 <span class="mono">dialogue</span>（AI / USER 交錯；USER 用 hint_en）。
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);
  const okBox = $("okBox");
  const errBox = $("errBox");

  function ok(msg){ errBox.style.display="none"; okBox.textContent=msg; okBox.style.display="block"; }
  function err(msg){ okBox.style.display="none"; errBox.textContent=msg; errBox.style.display="block"; }

  function safeId(s){
    s = String(s||"").trim();
    if(!s) return "";
    s = s.replace(/\s+/g,"_").toLowerCase();
    s = s.replace(/[^a-z0-9_]/g,"");
    return s;
  }

  /* ====== SRT helpers (for talk-scenes test) ====== */
  function parseSrtToLines(srtText){
    const raw = (srtText||"").replace(/\r/g,"").trim();
    if(!raw) return [];
    const blocks = raw.split(/\n\s*\n/);
    const out = [];
    for(const b of blocks){
      const lines = b.split("\n").map(s=>s.trim()).filter(Boolean);
      if(lines.length < 2) continue;
      // typical: [idx], [time], [text...]
      let timeLine = lines[1];
      let textLines = lines.slice(2);
      if(/-->\s*/.test(lines[0])){ // some SRT without numeric index
        timeLine = lines[0];
        textLines = lines.slice(1);
      }
      const m = timeLine.match(/(\d{2}:\d{2}:\d{2})[,\.]\d+\s*-->\s*(\d{2}:\d{2}:\d{2})[,\.]\d+/);
      const t0 = m ? m[1] : "";
      const t1 = m ? m[2] : "";
      const text = textLines
        .join(" ")
        .replace(/<[^>]+>/g,"")
        .replace(/\s+/g," ")
        .trim();
      if(!text) continue;
      out.push({t0,t1,text});
    }
    return out;
  }

  function buildDialogueFromSrt(lines, mode){
    const dlg = [];
    // 固定先一個 AI 開場（穩）
    dlg.push({ id:"a1", speaker:"AI", en:"Hi! Let's practice.", zh:"嗨！我們來練習吧。"});
    let i = 0;
    for(const ln of lines){
      i++;
      const aiId = "a" + (i+1);
      dlg.push({ id: aiId, speaker:"AI", en: ln.text, zh: "" });
      if(mode === "ai_user_alt"){
        const uId = "u" + i;
        dlg.push({
          id: uId,
          speaker:"USER",
          hint_en: ln.text,
          hint_zh: "跟讀： " + ln.text
        });
      }
      if(dlg.length >= 60) break; // 防止 SRT 太長把頁面撐爆（先測試）
    }
    return dlg;
  }

  function showSrtHint(msg, ok=true){
    const box = $("#srtHint");
    if(!box) return;
    box.style.display = "block";
    box.style.background = ok ? "#ecfdf5" : "#fef2f2";
    box.style.border = "1px solid " + (ok ? "#a7f3d0" : "#fecaca");
    box.style.color = ok ? "#065f46" : "#991b1b";
    box.textContent = msg;
  }


  let index = { version: "2026-01-06", title: "Talk Scenarios", items: [] };
  let scenes = {};
  let selectedId = "";

  function updateCount(){ $("countPill").textContent = String(index.items.length); }

  function renderList(){
    const root = $("sceneList");
    root.innerHTML = "";
    index.items.forEach(it=>{
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div style="min-width:0">
          <b>${it.title_zh || it.id}</b>
          <div><small class="mono">${it.id}</small> <span class="pill">${it.level||""}</span></div>
        </div>
        <button class="btn secondary" data-id="${it.id}">編輯</button>
      `;
      root.appendChild(div);
    });
    root.querySelectorAll("button[data-id]").forEach(b=>{
      b.addEventListener("click", ()=>selectScene(b.getAttribute("data-id")));
    });
    updateCount();
  }

  function syncIndexEditor(){ $("indexEditor").value = JSON.stringify(index, null, 2); }
  function syncSceneEditor(){
    $("curSceneId").textContent = selectedId ? selectedId : "（未選）";
    $("sceneEditor").value = selectedId ? JSON.stringify((scenes[selectedId]||{}), null, 2) : "";
  }

  function createEmptyScene(it){
    return {
      id: it.id,
      level: it.level || "A1",
      title_zh: it.title_zh || "",
      title_en: it.title_en || "",
      role: { ai_name: "Sara", ai_title: it.role || "Teacher" },
      meta: {
        missions: [{ id: 1, text: "完成第一個目標。", complete_on_step: "u2" }],
        examples: [{ en: "Could you help me, please?", zh: "可以幫我一下嗎？" }],
        key_vocab: [{ w: "please", zh: "請", note: "" }]
      },
      dialogue: [
        { id: "a1", speaker: "AI",   en: "Hi! Let's practice.", zh: "嗨！我們來練習吧。" },
        { id: "u2", speaker: "USER", hint_en: "Sure.", hint_zh: "好呀。" }
      ],
      feedback_tiers: []
    };
  }

  function rebuildFromIndex(){
    for(const it of index.items){
      if(!scenes[it.id]) scenes[it.id] = createEmptyScene(it);
    }
    const keep = new Set(index.items.map(x=>x.id));
    Object.keys(scenes).forEach(id=>{ if(!keep.has(id)) delete scenes[id]; });
  }

  function selectScene(id){
    selectedId = id;
    syncSceneEditor();
    ok("已選取：" + id);
  }

  $("btnAdd").addEventListener("click", ()=>{
    const id = safeId($("newId").value);
    const level = String($("newLevel").value||"A1").trim() || "A1";
    const title_zh = String($("newZh").value||"").trim();
    const title_en = String($("newEn").value||"").trim();
    const role = String($("newRole").value||"Teacher").trim();
    if(!id) return err("請輸入 id（英數底線）。");
    if(index.items.some(x=>x.id===id)) return err("這個 id 已存在：" + id);

    const item = { id, title_zh, title_en, level, role, avatar: "assets/avatars/teacher-blonde.jpg" };
    index.items.push(item);
    scenes[id] = createEmptyScene(item);
    syncIndexEditor();
    renderList();
    selectScene(id);
    ok("新增完成：" + id);
  });

  $("btnDelete").addEventListener("click", ()=>{
    if(!selectedId) return err("請先選一個場景。");
    index.items = index.items.filter(x=>x.id!==selectedId);
    delete scenes[selectedId];
    selectedId = "";
    syncIndexEditor();
    renderList();
    syncSceneEditor();
    ok("已刪除。");
  });

  $("btnPrettyIndex").addEventListener("click", ()=>{
    try{ $("indexEditor").value = JSON.stringify(JSON.parse($("indexEditor").value), null, 2); ok("index.json 已美化。"); }
    catch(e){ err("index.json 不是合法 JSON。"); }
  });

  $("btnPrettyScene").addEventListener("click", ()=>{
    try{ $("sceneEditor").value = JSON.stringify(JSON.parse($("sceneEditor").value), null, 2); ok("場景 JSON 已美化。"); }
    catch(e){ err("場景 JSON 不是合法 JSON。"); }
  });

  $("btnApplyIndex").addEventListener("click", ()=>{
    try{
      const obj = JSON.parse($("indexEditor").value);
      if(!Array.isArray(obj.items)) return err("index.json 必須包含 items[]。");
      index = obj;
      rebuildFromIndex();
      renderList();
      syncIndexEditor();
      if(selectedId && !index.items.some(x=>x.id===selectedId)) selectedId = "";
      if(!selectedId && index.items[0]) selectedId = index.items[0].id;
      syncSceneEditor();
      ok("index.json 已套用。");
    }catch(e){ err("index.json 不是合法 JSON。"); }
  });

  $("btnApplyScene").addEventListener("click", ()=>{
    if(!selectedId) return err("請先選擇場景。");
    try{
      const obj = JSON.parse($("sceneEditor").value);
      obj.id = selectedId;
      scenes[selectedId] = obj;
      ok("場景 JSON 已套用：" + selectedId);
    }catch(e){ err("場景 JSON 不是合法 JSON。"); }
  });

  $("btnNewDialogue").addEventListener("click", ()=>{
    if(!selectedId) return err("請先選擇場景。");
    const base = scenes[selectedId] || {};
    base.dialogue = [
      { id: "a1", speaker: "AI",   en: "Hello! How can I help you today?", zh: "你好！我今天可以怎麼幫你？" },
      { id: "u2", speaker: "USER", hint_en: "I'd like ... , please.", hint_zh: "我想要…，謝謝。" },
      { id: "a3", speaker: "AI",   en: "Sure. Anything else?", zh: "好的。還需要別的嗎？" },
      { id: "u4", speaker: "USER", hint_en: "That's all, thank you.", hint_zh: "就這樣，謝謝。" }
    ];
    scenes[selectedId] = base;
    syncSceneEditor();
    ok("已生成對話骨架。");
  });

  function downloadText(filename, text){
    const blob = new Blob([text], {type:"application/json;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  }

  $("btnExport").addEventListener("click", ()=>{
    try{
      const idxObj = JSON.parse($("indexEditor").value);
      if(!Array.isArray(idxObj.items)) return err("index.json 必須包含 items[]。");
      index = idxObj;
      rebuildFromIndex();

      if(selectedId && $("sceneEditor").value.trim()){
        try{
          const obj = JSON.parse($("sceneEditor").value);
          obj.id = selectedId;
          scenes[selectedId] = obj;
        }catch(_){}
      }

      downloadText("index.json", JSON.stringify(index, null, 2));
      for(const it of index.items){
        const id = it.id;
        downloadText(`scene-${id}.json`, JSON.stringify(scenes[id] || createEmptyScene(it), null, 2));
      }
      ok("已匯出：index.json + scene-*.json");
    }catch(e){ err("匯出失敗：請先確認 JSON 都合法。"); }
  });

  $("btnLoadSample").addEventListener("click", ()=>{
    index = { version:"2026-01-06", title:"Talk Scenarios", items:[{ id:"coffee_shop", title_zh:"買一杯咖啡", title_en:"Coffee Shop", level:"A1", role:"Barista", avatar:"assets/avatars/teacher-blonde.jpg" }] };
    scenes = {};
    rebuildFromIndex();
    syncIndexEditor();
    renderList();
    selectScene("coffee_shop");
    ok("已載入示例。你可以新增更多場景。");
  });

  syncIndexEditor();
  

  /* ====== SRT → dialogue (UI) ====== */
  $("#btnSrtPreview")?.addEventListener("click", async ()=>{
    const f = $("#srtFile")?.files?.[0];
    if(!f){ showSrtHint("請先選擇一個 .srt 檔", false); return; }
    const txt = await f.text();
    const lines = parseSrtToLines(txt);
    if(!lines.length){ showSrtHint("讀不到 SRT 內容（可能格式不標準）", false); return; }
    const preview = lines.slice(0,10).map((x,i)=>`${String(i+1).padStart(2,"0")}  ${x.t0||"--"}  ${x.text}`).join("\n");
    showSrtHint("前 10 句：\n" + preview, true);
  });

  $("#btnSrtBuild")?.addEventListener("click", async ()=>{
    const f = $("#srtFile")?.files?.[0];
    if(!f){ showSrtHint("請先選擇一個 .srt 檔", false); return; }
    const sid = state.selectedId;
    if(!sid){ showSrtHint("請先在左邊清單選一個場景，再用 SRT 生成 dialogue", false); return; }

    const txt = await f.text();
    const lines = parseSrtToLines(txt);
    if(!lines.length){ showSrtHint("讀不到 SRT 內容（可能格式不標準）", false); return; }

    const mode = $("#srtMode")?.value || "ai_only";

    // 以目前 editor 的 JSON 為主（避免你手動改的內容被覆蓋）
    let obj;
    try{
      obj = JSON.parse($("#sceneEditor").value || "{}");
    }catch(e){
      obj = JSON.parse(JSON.stringify(state.scenes[sid] || {}));
    }
    if(!obj || typeof obj!=="object") obj = {};
    if(!obj.id) obj.id = sid;

    obj.dialogue = buildDialogueFromSrt(lines, mode);

    // 方便你目測：丟 meta.examples
    obj.meta = obj.meta || {};
    obj.meta.examples = (lines.slice(0,3).map(x=>x.text));

    state.scenes[sid] = obj;
    $("#sceneEditor").value = JSON.stringify(obj, null, 2);

    showSrtHint(`已用 SRT 生成 dialogue（${lines.length} 句，實際寫入最多 60 段）`, true);
    toast("SRT 生成完成");
  });

renderList();
</script>
</body>
</html>
