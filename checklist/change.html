<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin｜MP4 整理 & JSON 產生器（change checklist）</title>
  <style>
    :root{
      --bg:#f4f6fb;
      --card-bg:#ffffff;
      --muted:#6b7280;
      --border:#e5e7eb;
      --brand:#2563eb;
      --brand-soft:#e0edff;
      --danger:#b91c1c;
      --radius-lg:18px;
      --shadow-card:0 12px 30px rgba(15,23,42,.10);
      --mono:"JetBrains Mono","Cascadia Code","SF Mono",ui-monospace,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      background:var(--bg);
      color:#111827;
    }
    .wrap{
      max-width:1120px;
      margin:24px auto 60px;
      padding:0 16px 32px;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:18px;
    }
    .logo{
      font-weight:700;
      font-size:20px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .logo-badge{
      width:28px;height:28px;
      border-radius:999px;
      background:linear-gradient(135deg,#6366f1,#22c55e);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-size:16px;font-weight:800;
      box-shadow:0 8px 18px rgba(30,64,175,.35);
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:var(--brand-soft);
      color:#1e40af;
      font-size:12px;
    }
    .tag-dot{
      width:7px;height:7px;border-radius:999px;
      background:#22c55e;
    }
    .small{
      font-size:13px;color:var(--muted);
    }
    main{
      display:grid;
      grid-template-columns: minmax(0,2.2fr) minmax(0,1.4fr);
      gap:20px;
    }
    @media (max-width:860px){
      main{grid-template-columns:1fr;}
    }
    .card{
      background:var(--card-bg);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-card);
      padding:18px 18px 20px;
      border:1px solid #e0e7ff;
    }
    h1{
      margin:0 0 6px;
      font-size:20px;
    }
    h2{
      margin:0 0 10px;
      font-size:17px;
    }
    h3{
      margin:18px 0 8px;
      font-size:15px;
    }
    .pill-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin:6px 0 4px;
    }
    .pill{
      padding:2px 10px;
      border-radius:999px;
      font-size:13px;
      border:1px solid #c7d2fe;
      background:#eef2ff;
      color:#1e3a8a;
      white-space:nowrap;
    }
    .pill strong{font-weight:700;}
    .steps{
      list-style:none;
      padding-left:0;
      margin:4px 0 0;
      font-size:14px;
    }
    .steps li{
      padding:6px 0;
      border-bottom:1px dashed #e5e7eb;
    }
    .steps li:last-child{border-bottom:none;}
    .badge-num{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:18px;height:18px;
      border-radius:999px;
      background:#1d4ed8;
      color:#fff;
      font-size:11px;
      margin-right:4px;
    }
    pre{
      margin:8px 0 0;
      padding:10px 12px;
      background:#020617;
      border-radius:12px;
      overflow-x:auto;
      font-size:12px;
      line-height:1.5;
      color:#e5e7eb;
      font-family:var(--mono);
      border:1px solid #1e293b;
    }
    code{font-family:var(--mono);}
    .sub{
      font-size:13px;
      color:var(--muted);
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      margin-top:4px;
    }
    th,td{
      border:1px solid #e5e7eb;
      padding:6px 8px;
      text-align:left;
    }
    th{background:#f3f4ff;font-weight:600;font-size:12px;}
    .highlight{
      padding:8px 10px;
      border-radius:10px;
      background:#ecfdf5;
      border:1px solid #6ee7b7;
      font-size:13px;
      margin:6px 0 0;
      color:#065f46;
    }
    .warn{
      background:#fef2f2;
      border-color:#fecaca;
      color:#991b1b;
    }
    .mark{
      padding:2px 5px;
      border-radius:6px;
      background:#fef3c7;
      border:1px solid #facc15;
      font-size:12px;
      display:inline-block;
      margin-top:4px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="logo">
          <span class="logo-badge">B</span>
          <span>BookWide Admin｜MP4 整理 & JSON 產生器（change）</span>
        </div>
        <div class="small">
          統一記錄：影片「去頭去尾 + 壓縮 + 封面」標準流程（給未來的自己看也看得懂）
        </div>
      </div>
      <div class="tag">
        <span class="tag-dot"></span>
        checklist / SOP
      </div>
    </header>

    <main>
      <!-- 左側：流程與說明 -->
      <section class="card">
        <h1>MP4 標準處理流程（工具跑在本機）</h1>
        <div class="pill-row">
          <div class="pill"><strong>去頭</strong> 10 秒</div>
          <div class="pill"><strong>去尾</strong> 5 秒</div>
          <div class="pill"><strong>封面截圖</strong> 15 秒</div>
          <div class="pill">目標檔案 ≦ 10 MB</div>
        </div>

        <p class="sub">
          這一頁只是「說明與程式碼備份」，實際執行還是在 Windows 本機：放影片 → 點 <code>run.bat</code> →
          自動產生裁好的 mp4 + 封面 jpg。<br>
          下面先記錄整體流程，再放完整程式碼，怕之後忘記。
        </p>

        <h2>一、資料夾結構</h2>
        <p class="sub">在本機（例如 <code>D:\mp4_auto</code>）建立以下結構：</p>
        <pre><code>mp4_auto/
 ├─ input/      ← 原始長版影片放這裡（.mp4）
 ├─ output/     ← 自動產生：裁好 mp4 + 封面 .jpg
 ├─ auto_mp4.py ← Python 主程式
 └─ run.bat     ← 一鍵執行檔</code></pre>

        <h2>二、標準處理步驟（SOP）</h2>
        <ul class="steps">
          <li>
            <span class="badge-num">1</span>
            把「原始影片」通通丟進 <code>input/</code>。
          </li>
          <li>
            <span class="badge-num">2</span>
            在資料夾裡雙擊 <code>run.bat</code>。<br>
            需要已安裝 <strong>Python</strong> 與 <strong>ffmpeg（含 ffprobe）</strong>，並加入 PATH。
          </li>
          <li>
            <span class="badge-num">3</span>
            工具會針對每支影片：
            <ul class="steps" style="margin-top:4px;">
              <li>去頭 10 秒（HEAD_TRIM_SEC = 10）</li>
              <li>去尾 5 秒（TAIL_TRIM_SEC = 5）</li>
              <li>以 CRF 23 起跳壓縮，直到 ≦ 10MB 或 CRF 達 35</li>
              <li>在裁後影片的第 15 秒附近擷取 1 張封面圖（若影片太短，改抓中間）</li>
            </ul>
          </li>
          <li>
            <span class="badge-num">4</span>
            成品會出現在 <code>output/</code>：
            <ul class="steps" style="margin-top:4px;">
              <li><code>xxx_cut.mp4</code>：裁好＋壓好版 mp4（可上傳 Supabase / GitHub）</li>
              <li><code>xxx_cover.jpg</code>：封面圖（可當 assets/{category}/{slug}.jpg）</li>
            </ul>
          </li>
          <li>
            <span class="badge-num">5</span>
            之後再把「這些裁好影片」丟進 BUZZ 產生 <code>.srt</code>（這一步目前仍是手動拖曳）。
          </li>
        </ul>

        <h2>三、固定參數紀錄</h2>
        <table>
          <thead>
            <tr>
              <th>項目</th>
              <th>值</th>
              <th>備註</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>HEAD_TRIM_SEC</td>
              <td><strong>10</strong> 秒</td>
              <td>去掉開頭動畫與多餘空白</td>
            </tr>
            <tr>
              <td>TAIL_TRIM_SEC</td>
              <td><strong>5</strong> 秒</td>
              <td>去掉結尾空白或 OUTRO</td>
            </tr>
            <tr>
              <td>TARGET_MB</td>
              <td><strong>10</strong> MB</td>
              <td>超過就加大 CRF 再壓一次</td>
            </tr>
            <tr>
              <td>COVER_TIME_SEC</td>
              <td><strong>15</strong> 秒</td>
              <td>封面時間點（若影片太短改抓中間）</td>
            </tr>
          </tbody>
        </table>

        <div class="highlight warn">
          ⚠ 提醒：這套工具跑在本機，不會自動上傳到 Supabase / GitHub。
          所有成品仍需手動拖到 <code>videos/</code>、<code>assets/</code> 或用 Admin MP4 上傳分頁處理。
        </div>
      </section>

      <!-- 右側：程式碼備份 -->
      <aside class="card">
        <h2>四、run.bat（一鍵批次檔）</h2>
        <p class="sub">
          放在 <code>mp4_auto</code> 根目錄。雙擊後會呼叫 <code>python auto_mp4.py</code>。
        </p>
        <pre><code>@echo off
REM BookWide MP4 批次處理
REM 1) 去頭 10 秒
REM 2) 去尾 5 秒
REM 3) 壓到 &lt;= 10MB
REM 4) 擷取封面截圖（約裁後的第 15 秒）

echo.
echo ===============================
echo  BookWide MP4 批次處理開始
echo  請確認原始影片放在 input\ 資料夾
echo ===============================
echo.

python auto_mp4.py

echo.
echo 完成！請到 output\ 資料夾查看裁好 mp4 + 封面 jpg。
pause</code></pre>

        <h2 style="margin-top:18px;">五、auto_mp4.py（Python 主程式）</h2>
        <p class="sub">
          使用 <strong>ffmpeg / ffprobe</strong>。若以後要改秒數，只要改檔頭四個常數即可。
        </p>
        <pre><code>import os
import subprocess

# === 參數（標準設定） ===
HEAD_TRIM_SEC = 10     # 去頭 10 秒
TAIL_TRIM_SEC = 5      # 去尾 5 秒
TARGET_MB      = 10    # 目標檔案大小（MB）
COVER_TIME_SEC = 15    # 封面時間點（秒）

INPUT_DIR  = "input"
OUTPUT_DIR = "output"


def run_cmd(cmd):
    print("&gt;&gt;", " ".join(cmd))
    subprocess.run(cmd, check=True)


def get_duration(path):
    "用 ffprobe 取得影片長度（秒）"
    result = subprocess.run(
        [
            "ffprobe", "-v", "error",
            "-show_entries", "format=duration",
            "-of", "default=noprint_wrappers=1:nokey=1",
            path,
        ],
        capture_output=True, text=True, check=True
    )
    return float(result.stdout.strip())


def process_one(src_path: str):
    base = os.path.splitext(os.path.basename(src_path))[0]
    os.makedirs(OUTPUT_DIR, exist_ok=True)

    trimmed_path = os.path.join(OUTPUT_DIR, f"{base}_cut.mp4")
    cover_path   = os.path.join(OUTPUT_DIR, f"{base}_cover.jpg")

    print("\\n========== 處理中:", src_path, "==========")

    # 1) 原始長度
    duration = get_duration(src_path)
    print(f"原始長度: {duration:.2f} 秒")

    # 2) 計算裁切區間（去頭 10 秒、去尾 5 秒）
    start = HEAD_TRIM_SEC
    end   = max(start + 1, duration - TAIL_TRIM_SEC)   # 至少留 1 秒
    print(f"裁切區間: {start:.3f} ~ {end:.3f} 秒")

    # 3) 先裁一版，CRF=23 起跳
    crf = 23
    run_cmd([
        "ffmpeg", "-y",
        "-ss", f"{start:.3f}",
        "-to", f"{end:.3f}",
        "-i", src_path,
        "-c:v", "libx264", "-preset", "veryfast", "-crf", str(crf),
        "-c:a", "aac",
        "-movflags", "+faststart",
        trimmed_path
    ])

    # 4) 檢查大小，不足再壓縮
    max_bytes = TARGET_MB * 1024 * 1024
    while os.path.getsize(trimmed_path) &gt; max_bytes and crf &lt; 35:
        size_mb = os.path.getsize(trimmed_path) / (1024 * 1024)
        print(f"目前 {size_mb:.2f} MB &gt; {TARGET_MB} MB，繼續降畫質壓縮…")
        crf += 2
        tmp_path = os.path.join(OUTPUT_DIR, f"{base}_cut_q{crf}.mp4")
        run_cmd([
            "ffmpeg", "-y",
            "-i", trimmed_path,
            "-c:v", "libx264", "-preset", "veryfast", "-crf", str(crf),
            "-c:a", "aac",
            "-movflags", "+faststart",
            tmp_path
        ])
        os.replace(tmp_path, trimmed_path)

    final_size_mb = os.path.getsize(trimmed_path) / (1024 * 1024)
    print(f"最終檔案大小：約 {final_size_mb:.2f} MB")

    # 5) 擷取封面圖：若影片不夠長，就抓裁後中間
    cut_duration = end - start
    if COVER_TIME_SEC &lt; cut_duration:
        cover_time = start + COVER_TIME_SEC
    else:
        cover_time = start + cut_duration / 2  # 中間

    print(f"封面時間點: {cover_time:.3f} 秒 → {cover_path}")
    run_cmd([
        "ffmpeg", "-y",
        "-ss", f"{cover_time:.3f}",
        "-i", trimmed_path,
        "-frames:v", "1",
        cover_path
    ])

    print("✅ 完成：", base)


def main():
    os.makedirs(INPUT_DIR, exist_ok=True)
    os.makedirs(OUTPUT_DIR, exist_ok=True)

    files = [
        f for f in os.listdir(INPUT_DIR)
        if f.lower().endswith(".mp4")
    ]
    if not files:
        print("input/ 裡沒有 mp4 檔，請先把影片放進去再執行。")
        return

    for name in files:
        src = os.path.join(INPUT_DIR, name)
        try:
            process_one(src)
        except subprocess.CalledProcessError as e:
            print("❌ ffmpeg 發生錯誤，跳過此檔：", src)
            print(e)


if __name__ == "__main__":
    main()</code></pre>

        <div class="mark">
          若未來要改規則，只要修改檔頭的
          <code>HEAD_TRIM_SEC / TAIL_TRIM_SEC / TARGET_MB / COVER_TIME_SEC</code> 即可，
          記得同步更新這一頁的文字說明。
        </div>
      </aside>
    </main>
  </div>
</body>
</html>
