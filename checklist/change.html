<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin｜MP4 整理 & JSON 產生器</title>
  <style>
    :root{
      --bg:#f4f6fb;
      --card-bg:#fff;
      --muted:#6b7280;
      --border:#e5e7eb;
      --brand:#2563eb;
      --brand-soft:#e0edff;
      --radius-lg:18px;
      --shadow-card:0 10px 30px rgba(15,23,42,.08);
      --danger:#b91c1c;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC","Microsoft JhengHei";
      background:var(--bg);
      color:#111827;
    }
    .wrap{
      max-width:900px;
      margin:24px auto 80px;
      padding:0 16px 40px;
    }

    header{margin-bottom:10px;}
    .title{font-size:1.5rem;font-weight:700;}
    .subtitle{font-size:.9rem;color:var(--muted);margin-top:4px;}

    .top-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:6px;
      margin-bottom:14px;
    }
    .back-btn{
      font-size:.85rem;
      color:#2563eb;
      cursor:pointer;
      text-decoration:none;
      padding:6px 14px;
      border:1px solid #2563eb;
      border-radius:999px;
      background:#fff;
    }
    .admin-mail{
      font-size:.85rem;
      color:#6b7280;
    }

    .tabs{
      display:flex;
      gap:10px;
      margin-bottom:18px;
      flex-wrap:wrap;
    }
    .tab{
      padding:8px 18px;
      border-radius:30px;
      border:1px solid #d1d5db;
      font-size:.9rem;
      background:#fff;
      color:#374151;
      text-decoration:none;
    }
    .tab.active{
      background:#2563eb;
      color:#fff;
      border-color:#2563eb;
    }

    .card{
      background:var(--card-bg);
      border-radius:var(--radius-lg);
      padding:18px 18px 20px;
      box-shadow:var(--shadow-card);
      margin-bottom:22px;
    }

    .section-title{
      font-size:1.1rem;
      font-weight:600;
      margin-bottom:10px;
    }

    .field{margin-bottom:12px;}
    .label{
      font-size:.9rem;
      font-weight:600;
      margin-bottom:4px;
    }
    .ipt, .txt{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      font-size:.95rem;
      font-family:inherit;
    }
    .txt{
      min-height:80px;
      resize:vertical;
      white-space:pre;
    }
    .hint{
      font-size:.8rem;
      color:var(--muted);
      margin-top:4px;
    }

    .step-list{
      font-size:.9rem;
      margin:0;
      padding-left:18px;
    }
    .step-list li{margin-bottom:4px;}

    .btn-row{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;}
    .btn{
      padding:7px 14px;
      border-radius:999px;
      border:1px solid #2563eb;
      background:#2563eb;
      color:#fff;
      cursor:pointer;
      font-size:.88rem;
    }
    .btn.secondary{
      background:#fff;
      color:#2563eb;
    }

    .file-row{margin-top:10px;margin-bottom:6px;}

    .result-box{
      margin-top:10px;
      padding:10px 12px;
      border-radius:10px;
      background:#f9fafb;
      border:1px solid var(--border);
      font-size:.86rem;
      color:#374151;
      white-space:pre-line;
    }
    .result-box.error{
      background:#fef2f2;
      border-color:#fecaca;
      color:var(--danger);
    }

    @media (max-width:768px){
      .wrap{margin-top:16px;}
    }
  </style>
</head>

<body>
<div class="wrap">

  <header>
    <div class="title">BookWide Admin｜MP4 整理 & JSON 產生器</div>
    <div class="subtitle">協助整理影片檔案、產生建議指令，並從 SRT 產生 JSON 檔供 GitHub 上傳。</div>
  </header>

  <div class="top-row">
    <a href="/admin.html" class="back-btn">← 回上頁</a>
    <div class="admin-mail">管理員：<span id="adminEmail">檢查中…</span></div>
  </div>

  <nav class="tabs">
    <a href="user.html" class="tab">使用者清單</a>
    <a href="authorize.html" class="tab">授權／暫停管理員</a>
    <span class="tab active">MP4 整理 / JSON 產生</span>
  </nav>

  <!-- 共用：分類 + slug -->
  <section class="card">
    <div class="section-title">基本資訊</div>
    <div class="field">
      <div class="label">分類（category）</div>
      <input id="cat" class="ipt" placeholder="story / music / movie / news / pro">
      <div class="hint">會用在檔名與路徑，例如：<code>videos/story/houyi.mp4</code>。</div>
    </div>
    <div class="field">
      <div class="label">片名（slug）</div>
      <input id="slug" class="ipt" placeholder="mid-autumn / houyi / alittlelove">
      <div class="hint">會用在所有相關檔案：<code>houyi.mp4</code>、<code>cues-houyi.json</code>等等。</div>
    </div>
  </section>

  <!-- MP4 整理 -->
  <section class="card">
    <div class="section-title">1. MP4 整理（壓縮 / 抽封面 / 產生 SRT）</div>

    <div class="field">
      <div class="label">來源影片完整路徑（本機）</div>
      <input id="srcPath" class="ipt" placeholder="例如：D:\\mp4\\source\\houyi.mov">
      <div class="hint">這只是用來幫你組 ffmpeg 指令，不會真的讀取檔案。</div>
    </div>

    <div class="field">
      <div class="label">輸出資料夾（本機）</div>
      <input id="outDir" class="ipt" placeholder="例如：D:\\DATA\\houyi">
      <div class="hint">建議每部影片一個資料夾：內含壓縮後 mp4、封面、SRT、JSON。</div>
    </div>

    <div class="btn-row">
      <button class="btn" onclick="buildCommands()">產生建議 ffmpeg 指令</button>
      <button class="btn secondary" onclick="copyCommands()">複製全部指令</button>
    </div>

    <div class="field" style="margin-top:10px;">
      <div class="label">建議指令（可貼到 PowerShell / CMD 執行）</div>
      <textarea id="cmdBox" class="txt" placeholder="按「產生建議 ffmpeg 指令」後會出現。"></textarea>
    </div>

    <ul class="step-list">
      <li>步驟 1：執行壓縮指令，產生 <code>slug.mp4</code>。</li>
      <li>步驟 2：執行擷取封面指令，產生 <code>slug.jpg</code>。</li>
      <li>步驟 3：使用字幕工具（或 Whisper）產生 <code>slug.srt</code>。</li>
    </ul>
  </section>

  <!-- JSON 產生器 -->
  <section class="card">
    <div class="section-title">2. JSON 產生器（由 SRT → cues.json + 範本檔）</div>

    <div class="file-row">
      <div class="label">上傳英文 SRT 檔</div>
      <input type="file" id="srtFile" accept=".srt,.txt">
      <div class="hint">目前只會讀英文字幕並生成 cues JSON，其它語言可後續人工補齊。</div>
    </div>

    <div class="btn-row">
      <button class="btn" onclick="generateCues()">產生並下載 cues-*.json</button>
      <button class="btn secondary" onclick="generateTemplate('quiz')">下載 quiz-*.json 範本</button>
      <button class="btn secondary" onclick="generateTemplate('vocab')">下載 vocab-*.json 範本</button>
      <button class="btn secondary" onclick="generateTemplate('ai')">下載 ai-*.json 範本</button>
    </div>

    <div id="jsonResult" class="result-box" style="display:none;"></div>

    <div class="hint" style="margin-top:8px;">
      產生後請用 GitHub Desktop 把 JSON 檔放到：
      <code>data/{category}/</code> 例如：<code>data/story/cues-houyi.json</code>。
    </div>
  </section>

</div>

<!-- Supabase + Admin 守門 -->
<script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
<script>
  const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
  const SUPABASE_ANON =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";

  const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  async function requireAdmin(){
    const { data:{session} } = await supa.auth.getSession();
    if(!session){
      alert("請先登入");
      location.href="/index.html";
      throw 0;
    }
    const { data:p, error } = await supa
      .from("profiles")
      .select("email,is_admin,is_paused")
      .eq("id",session.user.id)
      .single();
    if(error || !p || !p.is_admin || p.is_paused){
      alert("沒有後台管理權限");
      location.href="/index.html";
      throw 0;
    }
    document.getElementById("adminEmail").textContent = p.email || "";
  }
  requireAdmin();
</script>

<!-- 本頁專用邏輯 -->
<script>
  function getBasicInfo(){
    const cat  = document.getElementById("cat").value.trim();
    const slug = document.getElementById("slug").value.trim();
    if(!cat || !slug){
      alert("請先填寫分類（category）與片名（slug）");
      return null;
    }
    return {cat, slug};
  }

  function buildCommands(){
    const info = getBasicInfo();
    if(!info) return;
    const src  = document.getElementById("srcPath").value.trim();
    const out  = document.getElementById("outDir").value.trim();
    if(!src || !out){
      alert("請填寫來源影片路徑與輸出資料夾");
      return;
    }
    const { slug } = info;
    const mp4Out = `${out}\\${slug}.mp4`;
    const jpgOut = `${out}\\${slug}.jpg`;
    const srtOut = `${out}\\${slug}.srt`;

    const lines = [];
    lines.push(":: 1) 壓縮影片（示意指令，可依實際需求調整）");
    lines.push(`ffmpeg -i "${src}" -vf scale=-2:720 -c:v libx264 -preset slow -crf 23 -c:a aac -b:a 128k "${mp4Out}"`);
    lines.push("");
    lines.push(":: 2) 擷取封面（取 3 秒處的一張圖）");
    lines.push(`ffmpeg -ss 3 -i "${mp4Out}" -vframes 1 -q:v 2 "${jpgOut}"`);
    lines.push("");
    lines.push(":: 3) 產生英文 SRT（可用 Whisper / 其它字幕工具，輸出下列路徑）");
    lines.push(`:: 目標檔名： "${srtOut}"`);
    lines.push("");
    lines.push(":: 之後可回到本頁第二段「JSON 產生器」，把 SRT 匯入轉成 cues JSON。`);

    document.getElementById("cmdBox").value = lines.join("\n");
  }

  function copyCommands(){
    const txt = document.getElementById("cmdBox");
    if(!txt.value.trim()){
      alert("目前沒有指令可以複製，請先產生一次。");
      return;
    }
    txt.select();
    document.execCommand("copy");
    alert("已複製到剪貼簿。");
  }

  // --- SRT 解析 ---
  function parseSrt(text){
    const blocks = text.trim().split(/\r?\n\r?\n+/);
    const list = [];
    let idx = 1;
    for(const block of blocks){
      const lines = block.split(/\r?\n/);
      if(lines.length < 2) continue;

      // 可能第一行是序號
      let lineIdx = 0;
      if(/^\d+$/.test(lines[0].trim())) lineIdx = 1;

      const timeLine = lines[lineIdx] || "";
      const m = timeLine.match(/(\d{2}:\d{2}:\d{2},\d{3})\s*-->\s*(\d{2}:\d{2}:\d{2},\d{3})/);
      if(!m) continue;
      const start = m[1].replace(",", ".");
      const end   = m[2].replace(",", ".");

      const textLines = lines.slice(lineIdx+1).join(" ").replace(/\s+/g," ").trim();
      if(!textLines) continue;

      list.push({
        index: idx++,
        start,
        end,
        text: textLines
      });
    }
    return list;
  }

  function downloadJson(obj, filename){
    const blob = new Blob([JSON.stringify(obj,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function showJsonResult(msg, isError=false){
    const el = document.getElementById("jsonResult");
    el.style.display = "block";
    el.textContent = msg;
    el.classList.toggle("error", !!isError);
  }

  async function generateCues(){
    const info = getBasicInfo();
    if(!info) return;

    const file = document.getElementById("srtFile").files[0];
    if(!file){
      showJsonResult("請先選擇 SRT 檔案。", true);
      return;
    }
    const text = await file.text();
    const list = parseSrt(text);
    if(!list.length){
      showJsonResult("解析 SRT 失敗，請確認格式是否正確。", true);
      return;
    }

    const filename = `cues-${info.slug}.json`;
    downloadJson(list, filename);
    showJsonResult(`已產生並下載 ${filename}（共 ${list.length} 句）。`);
  }

  function generateTemplate(type){
    const info = getBasicInfo();
    if(!info) return;

    let template = [];
    if(type === "quiz"){
      template = [
        {
          "time": "00:00",
          "question": "示範題目：這部影片的主題是什麼？",
          "options": ["選項 A","選項 B","選項 C","選項 D"],
          "answer": 0,
          "explanation": "這裡填寫解說文字。"
        }
      ];
    }else if(type === "vocab"){
      template = [
        {
          "time": "00:00",
          "word": "example",
          "pos": "n.",
          "zh": "範例",
          "en": "something that is used to show what other similar things are like",
          "en_example": "This is an example sentence.",
          "zh_example": "這是一個例句。",
          "ja": "",
          "ja_example": ""
        }
      ];
    }else if(type === "ai"){
      template = [
        {
          "id": "intro",
          "role": "system",
          "prompt": "你是 BookWide 的英文家教，請根據影片內容出題與解說。"
        }
      ];
    }

    const filename = `${type}-${info.slug}.json`;
    downloadJson(template, filename);
    showJsonResult(`已下載 ${filename} 範本，可自行複製＋編輯內容。`);
  }
</script>

</body>
</html>
