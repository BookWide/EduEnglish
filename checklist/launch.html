<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>BookWide Admin｜影片上下架</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#f6f8fc; --card:#fff; --ink:#0f172a; --muted:#64748b;
      --line:#e5e7eb; --brand:#2563eb; --brand2:#1d4ed8;
      --ok:#16a34a; --bad:#ef4444; --chip:#eef2ff;
      --shadow:0 10px 24px rgba(2,6,23,.08);
      --r:18px;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Heiti TC", Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    body{ margin:0; background:var(--bg); color:var(--ink); }
    .topbar{
      position:sticky; top:0; z-index:10;
      background:linear-gradient(180deg,#0b1224 0%, #0b1730 100%);
      color:#e5e7eb; padding:14px 18px; display:flex; align-items:center; justify-content:space-between;
      box-shadow:0 6px 24px rgba(2,6,23,.2);
    }
    .topbar .left{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px;}
    .beta{font-size:12px; padding:2px 8px; border-radius:999px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.18);}
    .topbar .right{display:flex; align-items:center; gap:10px;}
    .pill{border:1px solid rgba(255,255,255,.2); border-radius:999px; padding:6px 10px; font-size:13px; background:rgba(255,255,255,.06);}
    .btn{appearance:none; border:0; cursor:pointer; border-radius:999px; padding:9px 14px; font-weight:700; background:var(--brand); color:#fff;}
    .btn:hover{background:var(--brand2);}
    .btn.ghost{background:transparent; color:#fff; border:1px solid rgba(255,255,255,.22);}
    .wrap{max-width:1180px; margin:18px auto; padding:0 14px 28px;}
    .card{background:var(--card); border:1px solid var(--line); border-radius:var(--r); box-shadow:var(--shadow);}
    .header{padding:16px 16px 10px; display:flex; align-items:flex-end; justify-content:space-between; gap:10px; flex-wrap:wrap;}
    .h1{font-size:22px; font-weight:900; margin:0;}
    .sub{color:var(--muted); font-size:13px; margin-top:6px; line-height:1.4;}
    .tools{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .input, select{height:40px; border-radius:12px; border:1px solid var(--line); padding:0 12px; font-size:14px; outline:none; background:#fff;}
    .input{min-width:240px;}
    .small{font-size:12px; color:var(--muted);}
    table{width:100%; border-collapse:separate; border-spacing:0;}
    thead th{text-align:left; font-size:12px; color:var(--muted); padding:10px 12px; border-top:1px solid var(--line); border-bottom:1px solid var(--line); background:#fafbff;}
    tbody td{padding:10px 12px; border-bottom:1px solid var(--line); vertical-align:middle; font-size:14px;}
    tbody tr:hover td{background:#fbfdff;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; color:#334155;}
    .chip{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; background:var(--chip); border:1px solid #dbeafe; font-size:12px; color:#1e40af; font-weight:700;}
    .toggle{display:inline-flex; align-items:center; gap:10px;}
    .switch{position:relative; width:44px; height:26px;}
    .switch input{opacity:0; width:0; height:0;}
    .slider{position:absolute; inset:0; background:#e2e8f0; border-radius:999px; transition:.18s;}
    .slider:before{content:""; position:absolute; height:20px; width:20px; left:3px; top:3px; background:white; border-radius:999px; transition:.18s; box-shadow:0 4px 10px rgba(2,6,23,.14);}
    .switch input:checked + .slider{background:#22c55e;}
    .switch input:checked + .slider:before{transform:translateX(18px);}
    .status{font-size:12px; font-weight:800;}
    .status.on{color:var(--ok);}
    .status.off{color:var(--bad);}
    .footer{padding:12px 16px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center;}
    .toast{position:fixed; right:14px; bottom:14px; padding:10px 12px; border-radius:14px; background:#0b1224; color:#fff; box-shadow:0 12px 30px rgba(2,6,23,.3); display:none; max-width:min(420px, calc(100vw - 28px));}
    .toast.show{display:block;}
    .toast .t{font-weight:800; font-size:13px; margin-bottom:3px;}
    .toast .b{font-size:12px; opacity:.9;}
    @media (max-width:720px){
      .input{min-width:160px; flex:1;}
      thead{display:none;}
      table, tbody, tr, td{display:block; width:100%;}
      tbody td{border-bottom:none; padding:8px 12px;}
      tbody tr{border-bottom:1px solid var(--line);}
      tbody td[data-k]::before{content:attr(data-k); display:block; font-size:11px; color:var(--muted); margin-bottom:2px;}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="left">
      <div style="font-size:18px;">BookWide Admin</div>
      <span class="beta">Beta</span>
      <span style="opacity:.85;">影片上下架</span>
    </div>
    <div class="right">
      <span class="pill">管理員：<span id="adminEmail">—</span></span>
      <button class="btn ghost" id="backBtn">回後台</button>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="header">
        <div>
          <h1 class="h1">影片上下架（public.assets.is_published）</h1>
          <div class="sub">
            這頁只做一件事：把影片 <b>上架 / 下架</b>（資料源：assets）。<br>
            你下架後，<b>index / player</b> 只要改成讀 assets + publish filter，就會自動不顯示。
          </div>
        </div>

        <div class="tools">
          <input class="input" id="q" placeholder="搜尋：標題 / slug / 分類…">
          <select id="catSel">
            <option value="">全部分類</option>
          </select>
          <select id="pubSel">
            <option value="">全部狀態</option>
            <option value="1">只看已上架</option>
            <option value="0">只看已下架</option>
          </select>
          <button class="btn" id="reloadBtn">重新整理</button>
          <button class="btn" id="bulkOnBtn" title="只對目前篩選後的清單生效">目前清單全上架</button>
          <button class="btn" id="bulkOffBtn" title="只對目前篩選後的清單生效" style="background:#ef4444;">目前清單全下架</button>
        </div>
      </div>

      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th style="width:140px;">分類</th>
              <th>標題</th>
              <th style="width:220px;">slug</th>
              <th style="width:110px;">難度</th>
              <th style="width:170px;">更新</th>
              <th style="width:160px;">狀態</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="6" style="padding:16px; color:#64748b;">載入中…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="footer">
        <div class="small">共 <b id="count">0</b> 筆（依目前篩選）</div>
        <div class="small">提示：更新後通常 1–2 秒內生效（取決於 CDN/瀏覽器快取）。</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div class="t" id="toastT">完成</div>
    <div class="b" id="toastB">—</div>
  </div>

<script>
  // ===== Supabase + Admin Guard =====
  const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
  const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  const DENY_SIGNIN = "請先登入管理員帳號。";
  const DENY_PROFILE = "找不到管理員資料（profiles）。";
  const DENY_ADMIN = "你不是管理員（is_admin=false）。";
  const DENY_PAUSED = "此帳號已被暫停。";

  function toast(title, body) {
    const el = document.getElementById('toast');
    document.getElementById('toastT').textContent = title || '完成';
    document.getElementById('toastB').textContent = body || '';
    el.classList.add('show');
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=>el.classList.remove('show'), 2400);
  }

  function kick(msg) {
    alert(msg);
    location.href = "/index.html";
  }

  async function requireAdmin() {
    const { data: sess } = await supa.auth.getSession();
    const session = sess?.session;
    if (!session?.user) return kick(DENY_SIGNIN);

    const { data: profile, error } = await supa
      .from("profiles")
      .select("email,is_admin,is_paused")
      .eq("id", session.user.id)
      .maybeSingle();

    if (error || !profile) return kick(DENY_PROFILE);
    if (profile.is_paused) return kick(DENY_PAUSED);
    if (!profile.is_admin) return kick(DENY_ADMIN);

    const email = profile.email || session.user.email || "admin";
    const el = document.getElementById("adminEmail");
    if (el) el.textContent = email;

    supa.auth.onAuthStateChange((_event, s) => {
      if (!s?.user) kick(DENY_SIGNIN);
    });
  }

  document.getElementById('backBtn').onclick = ()=> location.href = "../admin.html";
</script>

<script>
  // ===== Video Publish Manager =====
  const state = {
    rows: [],
    filtered: [],
    catMap: new Map(),
  };

  const els = {
    tbody: document.getElementById('tbody'),
    q: document.getElementById('q'),
    catSel: document.getElementById('catSel'),
    pubSel: document.getElementById('pubSel'),
    count: document.getElementById('count'),
    reloadBtn: document.getElementById('reloadBtn'),
    bulkOnBtn: document.getElementById('bulkOnBtn'),
    bulkOffBtn: document.getElementById('bulkOffBtn'),
  };

  function setBusy(busy, msg) {
    // Disable controls to prevent race conditions during updates
    const disabled = !!busy;
    [els.q, els.catSel, els.pubSel, els.reloadBtn, els.bulkOnBtn, els.bulkOffBtn].forEach(el=>{
      if (!el) return;
      el.disabled = disabled;
    });
    // Disable row toggles too (if present)
    document.querySelectorAll('#tbody input[type="checkbox"][data-id]').forEach(el=>{
      el.disabled = disabled;
    });
    if (busy && msg) toast("同步中…", msg);
  }

  function fmtDate(iso) {
    if (!iso) return "—";
    const d = new Date(iso);
    if (isNaN(d.getTime())) return "—";
    const pad = n => String(n).padStart(2,'0');
    return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function norm(s) {
    return (s||"").toString().toLowerCase();
  }

  function applyFilters() {
    const q = norm(els.q.value).trim();
    const cat = els.catSel.value;
    const pub = els.pubSel.value; // "", "1", "0"
    let rows = state.rows;

    if (cat) rows = rows.filter(r => (r.category||"") === cat);
    if (pub !== "") rows = rows.filter(r => String(!!r.is_published ? 1 : 0) === pub);
    if (q) {
      rows = rows.filter(r => {
        const hay = `${r.title||""} ${r.slug||""} ${r.category||""} `.toLowerCase();
        return hay.includes(q);
      });
    }

    state.filtered = rows;
    render();
  }

  function render() {
    const rows = state.filtered;
    els.count.textContent = rows.length;

    if (!rows.length) {
      els.tbody.innerHTML = `<tr><td colspan="6" style="padding:16px; color:#64748b;">沒有符合的影片。</td></tr>`;
      return;
    }

    els.tbody.innerHTML = rows.map(r => {
      const on = !!r.is_published;
      const diff = (r.difficulty_level ?? r.difficulty ?? r.level ?? "—");
      const upd = fmtDate(r.updated_at || r.updatedAt);
      const cat = r.category || "—";
      const title = r.title || "(無標題)";
      const slug = r.slug || "—";
      const id = r.slug;

      return `
      <tr>
        <td data-k="分類"><span class="chip">${cat}</span></td>
        <td data-k="標題"><div style="font-weight:800;">${escapeHtml(title)}</div></td>
        <td data-k="slug"><div class="mono">${escapeHtml(slug)}</div></td>
        <td data-k="難度">${escapeHtml(String(diff))}</td>
        <td data-k="更新" class="mono">${upd}</td>
        <td data-k="狀態">
          <div class="toggle">
            <label class="switch">
              <input type="checkbox" data-id="${escapeHtml(String(id))}" ${on ? "checked" : ""}>
              <span class="slider"></span>
            </label>
            <span class="status ${on ? "on" : "off"}">${on ? "已上架" : "已下架"}</span>
          </div>
        </td>
      </tr>`;
    }).join("");

    // bind toggles
    els.tbody.querySelectorAll('input[type="checkbox"][data-id]').forEach(chk => {
      chk.onchange = async (e) => {
        const id = e.target.getAttribute('data-id');
        const val = !!e.target.checked;
        e.target.disabled = true;
        try {
        setBusy(true, "更新影片狀態…");
          const payload = { is_published: val };
          const { error } = await supa.from('assets').update(payload).eq('slug', id);
          if (error) throw error;

          toast("已更新", `${id} → ${val ? "上架" : "下架"}`);
          await loadVideos(true);

        } catch (err) {
          console.error(err);
          alert("更新失敗：\n" + (err?.message || err) + "\n\n(提示：如果你看到 uuid/NaN，代表 videos.id 是 UUID，不要用 Number 轉型)");
          // revert UI
          e.target.checked = !val;
        } finally {
          setBusy(false);
          e.target.disabled = false;
        }
      };
    });
  }

  function escapeHtml(s) {
    return (s ?? "").toString()
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }

  async function loadVideos(preserve = true) {
    // Preserve current UI selections
    const prev = preserve ? {
      q: els.q.value,
      cat: els.catSel.value,
      pub: els.pubSel.value,
    } : { q:"", cat:"", pub:"" };

    els.tbody.innerHTML = `<tr><td colspan="6" style="padding:16px; color:#64748b;">載入中…</td></tr>`;
    state.rows = [];
    state.filtered = [];

    // 把常用欄位都抓出來（如果你未來又加欄位也不影響）
    const { data, error } = await supa
      .from('assets')
      .select('slug,category,title,is_published,difficulty_level,duration_sec,cover_url,mp4_url')
      .order('category', { ascending: true }).order('slug', { ascending: true });

    if (error) throw error;

    state.rows = data || [];

    // build categories
    const cats = Array.from(new Set(state.rows.map(r => r.category).filter(Boolean))).sort();
    els.catSel.innerHTML = `<option value="">全部分類</option>` + cats.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");

    // Restore selections (if still valid)
    if (preserve) {
      els.q.value = prev.q || "";
      // Only restore category if it still exists
      if (prev.cat && cats.includes(prev.cat)) els.catSel.value = prev.cat;
      else els.catSel.value = "";
      els.pubSel.value = (prev.pub === "1" || prev.pub === "0") ? prev.pub : "";
    }

    applyFilters();
  }

  async function bulkSet(val) {
    const rows = state.filtered;
    if (!rows.length) return toast("沒有資料", "目前篩選後清單是空的。");
    if (!confirm(`確定要把「目前清單」${val ? "全部上架" : "全部下架"}？\n共 ${rows.length} 筆`)) return;

    setBusy(true, `批次更新：共 ${rows.length} 筆`);

    try {
      // Supabase update 需要分批避免 URL 太長
      const ids = rows.map(r => String(r.slug)).filter(s => s && s !== 'null' && s !== 'undefined');
      const chunk = 100;
      let done = 0;

      for (let i=0; i<ids.length; i+=chunk) {
        const part = ids.slice(i, i+chunk);
        const payload = { is_published: val };
        const { error } = await supa.from('assets').update(payload).in('slug', part);
        if (error) throw error;

        done += part.length;
        toast("批次更新中…", `${done} / ${ids.length}`);
      }

      toast("批次完成", `${val ? "全上架" : "全下架"}：${rows.length} 筆`);
      // Reload from DB as the single source of truth
      await loadVideos(true);
    } finally {
      setBusy(false);
    }
  }

  (async function init() {
    try {
      await requireAdmin();
      await loadVideos();

      els.q.addEventListener('input', ()=>applyFilters());
      els.catSel.addEventListener('change', ()=>applyFilters());
      els.pubSel.addEventListener('change', ()=>applyFilters());
      els.reloadBtn.onclick = ()=>loadVideos().catch(err=>{console.error(err); alert(err?.message||err);});
      els.bulkOnBtn.onclick = ()=>bulkSet(true).catch(err=>{console.error(err); alert(err?.message||err);});
      els.bulkOffBtn.onclick = ()=>bulkSet(false).catch(err=>{console.error(err); alert(err?.message||err);});
    } catch (e) {
      console.error(e);
      alert(e?.message || e);
      location.href="/index.html";
    }
  })();
</script>
</body>
</html>
