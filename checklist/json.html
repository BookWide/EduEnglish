<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Adminï½œJSON ç”¢ç”Ÿå™¨</title>
  <style>
    :root{
      --bg:#f4f6fb;
      --card-bg:#fff;
      --muted:#6b7280;
      --border:#e5e7eb;
      --brand:#2563eb;
      --brand-soft:#e0edff;
      --danger:#b91c1c;
      --radius-lg:18px;
      --shadow-card:0 12px 30px rgba(15,23,42,.10);
      --mono:"JetBrains Mono","Cascadia Code","SF Mono",ui-monospace,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans TC","Microsoft JhengHei",sans-serif;
      background:var(--bg);
      color:#111827;
    }
    .wrap{
      max-width:1120px;
      margin:24px auto 80px;
      padding:0 16px;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:18px;
      gap:12px;
    }
    .logo{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:700;
      font-size:20px;
    }
    .logo-badge{
      width:30px;height:30px;
      border-radius:999px;
      background:linear-gradient(135deg,#6366f1,#22c55e);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-size:17px;
      box-shadow:0 8px 20px rgba(30,64,175,.4);
    }
    .small{font-size:13px;color:var(--muted);}
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:var(--brand-soft);
      color:#1e40af;
      font-size:12px;
    }
    .tag-dot{
      width:7px;height:7px;border-radius:999px;background:#22c55e;
    }

    main{
      display:grid;
      grid-template-columns:minmax(0,1.8fr) minmax(0,1.6fr);
      gap:20px;
    }
    @media (max-width:900px){
      main{grid-template-columns:1fr;}
    }

    .card{
      background:var(--card-bg);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-card);
      padding:18px 18px 22px;
      border:1px solid #e0e7ff;
    }
    h1{
      margin:0 0 8px;
      font-size:20px;
    }
    h2{
      margin:0 0 10px;
      font-size:17px;
    }
    h3{
      margin:18px 0 8px;
      font-size:15px;
    }
    .tagline{
      font-size:13px;
      color:var(--muted);
      margin-bottom:10px;
    }

    label{font-size:14px;font-weight:500;}
    input[type="text"], textarea, select{
      font-family:inherit;
      font-size:14px;
      width:100%;
      padding:7px 9px;
      border-radius:10px;
      border:1px solid var(--border);
      outline:none;
      transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
      background:#f9fafb;
    }
    textarea{
      resize:vertical;
      min-height:120px;
      font-family:var(--mono);
      font-size:13px;
      line-height:1.5;
    }
    input[type="text"]:focus, textarea:focus, select:focus{
      border-color:#3b82f6;
      box-shadow:0 0 0 1px rgba(59,130,246,.35);
      background:#fff;
    }

    .field-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px 16px;
      margin-bottom:10px;
    }
    .field-row > div{flex:1 1 160px;min-width:0;}
    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }

    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
      align-items:center;
    }
    .btn{
      border:none;
      border-radius:999px;
      padding:7px 14px;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      transition:transform .08s ease, box-shadow .08s ease, background .12s ease;
      white-space:nowrap;
    }
    .btn-primary{
      background:#2563eb;
      color:#fff;
      box-shadow:0 8px 20px rgba(37,99,235,.28);
    }
    .btn-primary:hover{
      transform:translateY(-1px);
      box-shadow:0 10px 24px rgba(37,99,235,.32);
      background:#1d4ed8;
    }
    .btn-ghost{
      background:#e5edff;
      color:#1e40af;
    }
    .btn-ghost:hover{
      background:#dbeafe;
    }
    .btn-sm{
      padding:4px 9px;
      font-size:12px;
    }
    .btn:disabled{
      opacity:.55;
      cursor:default;
      transform:none;
      box-shadow:none;
    }

    .block{
      border-top:1px dashed #e5e7eb;
      padding-top:12px;
      margin-top:10px;
    }

    .preview{
      background:#020617;
      color:#e5e7eb;
      border-radius:12px;
      padding:10px 12px;
      margin-top:8px;
      font-family:var(--mono);
      font-size:12px;
      line-height:1.5;
      border:1px solid #1e293b;
      max-height:220px;
      overflow:auto;
    }

    .status{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }
    .status.ok{color:#15803d;}
    .status.err{color:#b91c1c;}

    .pill-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:6px;
    }
    .pill{
      padding:2px 8px;
      border-radius:999px;
      border:1px solid #c7d2fe;
      background:#eef2ff;
      font-size:11px;
      color:#1e3a8a;
    }
    .pill strong{font-weight:600;}

    code{
      font-family:var(--mono);
      font-size:12px;
      background:#e5e7eb;
      border-radius:4px;
      padding:1px 4px;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:#111827;
      color:#f9fafb;
      padding:8px 14px;
      border-radius:999px;
      font-size:12px;
      box-shadow:0 8px 20px rgba(15,23,42,.4);
      opacity:0;pointer-events:none;
      transition:opacity .2s ease,transform .2s ease;
      z-index:50;
    }
    .toast.show{
      opacity:1;pointer-events:auto;
      transform:translateX(-50%) translateY(-4px);
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:11px;
      padding:2px 7px;
      border-radius:999px;
      background:#ecfdf5;
      color:#166534;
      border:1px solid #6ee7b7;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="logo">
          <span class="logo-badge">B</span>
          <span>BookWide Adminï½œJSON ç”¢ç”Ÿå™¨</span>
        </div>
        <div class="small">
          æŠŠä¸€æ”¯å½±ç‰‡çš„ SRT ä¸Ÿé€²ä¾† â†’ ç”¨ GPT å¹«ä½ ç”Ÿå‡º <code>cues / quiz / vocab / ai / index</code> äº”ç¨® JSONã€‚
        </div>
      </div>
      <div class="tag">
        <span class="tag-dot"></span>
        checklist / JSON å·¥å…·
      </div>
    </header>

    <main>
      <!-- å·¦å´ï¼šè¨­å®š + è§£æ SRT -->
      <section class="card">
        <h1>1. ä¸Šå‚³ SRT æª”ï¼Œå…ˆè§£ææˆè‹±æ–‡é€è¡Œ</h1>
        <div class="tagline">
          ç›®å‰åªæ”¯æ´è‹±æ–‡å­—å¹• SRTï¼Œä¹‹å¾Œäº¤çµ¦ GPT ç”¢ç”Ÿä¸­ / æ—¥ç¿»è­¯èˆ‡ JSON çµæ§‹ã€‚
        </div>

        <div class="field-row">
          <div>
            <label for="apiKey">OpenAI API Key</label>
            <div style="display:flex;gap:6px;align-items:center;">
              <input id="apiKey" type="text" placeholder="sk-..." />
              <button id="toggleKey" type="button" class="btn btn-sm btn-ghost">é¡¯ç¤º</button>
            </div>
            <div class="hint">æ­¤ Key åªå­˜æ–¼ç€è¦½å™¨çš„ localStorageï¼Œä¸æœƒä¸Šå‚³åˆ°ä¼ºæœå™¨ã€‚</div>
          </div>
          <div>
            <label for="model">æ¨¡å‹ï¼ˆé è¨­ gpt-4.1-miniï¼‰</label>
            <select id="model">
              <option value="gpt-4.1-mini" selected>gpt-4.1-mini</option>
              <option value="gpt-4.1">gpt-4.1</option>
            </select>
            <div class="hint">è‹¥è¦çœ Token è²»ç”¨ï¼Œç¶­æŒ mini å³å¯ã€‚</div>
          </div>
        </div>

        <div class="field-row">
          <div>
            <label for="slug">å½±ç‰‡ slugï¼ˆè‹±æ–‡æª”åï¼‰</label>
            <input id="slug" type="text" placeholder="ä¾‹å¦‚ï¼šone-way-ticket" />
            <div class="hint">æ‰€æœ‰ JSON æœƒç”¨é€™å€‹ slug ç•¶æª”åå¾Œç¶´ï¼Œä¾‹å¦‚ï¼š<code>cues-one-way-ticket.json</code>ã€‚</div>
          </div>
          <div>
            <label>å½±ç‰‡åˆ†é¡ category</label>
            <select id="category">
              <option value="story">story</option>
              <option value="music">music</option>
              <option value="movie">movie</option>
              <option value="news" selected>news</option>
              <option value="pro">pro</option>
            </select>
            <div class="hint">ç”¨åœ¨ <code>data/{category}/{slug}/...</code> èˆ‡ index.jsonã€‚</div>
          </div>
        </div>

        <h2 style="margin-top:16px;">ä¸Šå‚³ SRT æª”ä¸¦è§£æ</h2>
        <div class="tagline">ç›®å‰åªæ”¯æ´å–®ä¸€ SRT æª”ï¼ŒåŒ…å«å®Œæ•´å½±ç‰‡çš„è‹±æ–‡å­—å¹•ã€‚</div>

        <div class="field-row" style="align-items:flex-end;">
          <div>
            <label for="srtFile">é¸æ“‡ SRT æª”æ¡ˆ</label>
            <input id="srtFile" type="file" accept=".srt" />
          </div>
          <div>
            <button class="btn btn-primary" id="btnParseSrt" type="button">è§£æ SRT</button>
          </div>
        </div>
        <button class="btn btn-ghost" id="btnReparse" type="button">é‡æ–°è§£æ SRT</button>
        <div class="hint">ä¸‹æ–¹æœƒé¡¯ç¤ºå·²è§£æçš„å¹¾è¡Œé è¦½ï¼ˆæ™‚é–“ â†’ è‹±æ–‡å°è©ï¼‰ã€‚</div>
        <pre id="srtPreview" class="preview">å°šæœªè¼‰å…¥ SRT æª”ã€‚</pre>
      </section>

      <!-- å³å´ï¼šJSON ç”¢ç”Ÿå™¨ + é è¦½ -->
      <section class="card">
        <div class="tagline">2. ä½¿ç”¨ GPT ç”¢ç”Ÿ JSONï¼ˆä¸€æ¬¡ä¸€å€‹æª”æ¡ˆï¼‰</div>

        <!-- 2.1 cues -->
        <div class="block">
          <h3>2.1 å¤šèªå­—å¹• cues JSON</h3>

          <div style="margin:10px 0 6px;">
            <label style="font-weight:600;display:block;margin-bottom:4px;">
              å½±ç‰‡ä¾†æºï¼ˆYouTube URLï¼Œå¯ç•™ç©ºï¼‰
            </label>
            <input
              id="videoSourceInput"
              type="text"
              placeholder="https://www.youtube.com/watch?v=xxxxxxx"
              style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:10px;font-size:14px;"
            />
            <div style="font-size:12px;color:var(--muted);margin-top:4px;">
              è‹¥æœ‰å¡«å¯«ï¼ŒæœƒæŠŠç¶²å€å¯«é€² <code>cues-*.json</code> ç¬¬ä¸€ç­†å­—å¹•ç‰©ä»¶çš„ <code>source_url</code> æ¬„ä½ã€‚
            </div>
          </div>

          <div class="tagline">
            è¼¸å‡ºæª”åï¼š<code id="nameCues">cues-.json</code>
          </div>
          <div class="btn-row">
            <button class="btn btn-primary" type="button" onclick="handleGenerate('cues')">
              â‘  ç”¨ GPT ç”¢ç”Ÿ cues JSON
            </button>
            <button class="btn btn-ghost" type="button" id="btnGenerateAll" onclick="handleGenerateAll()">
              ä¸€éµç”¢ç”Ÿå…¨éƒ¨ JSON
            </button>
          </div>
          <div class="status" id="status-cues">å°šæœªç”¢ç”Ÿã€‚</div>
          <div class="btn-row">
            <button class="btn btn-sm btn-ghost" id="downloadCues" type="button" disabled>ä¸‹è¼‰ cues-*.json</button>
            <span class="badge"><span>ğŸ”</span><span>æœƒåŒ…å«è‹± / ä¸­ / æ—¥ä¸‰èªå­—å¹•</span></span>
          </div>
        </div>

        <!-- 2.2 quiz -->
        <div class="block">
          <h3>2.2 æ¸¬é©— quiz JSON</h3>
          <div class="tagline">
            è¼¸å‡ºæª”åï¼š<code id="nameQuiz">quiz-.json</code><br>
            Level 1ï¼šæ¯é¡Œ 5 é¡Œ Ã— 4 é¡ = 20 é¡Œã€‚vocab / AI æœƒéœ€è¦ç­‰ quiz å®Œæˆå¾Œå†ç”¢ç”Ÿã€‚
          </div>
          <div class="btn-row">
            <button class="btn btn-primary" type="button" onclick="handleGenerate('quiz')">
              ç”¨ GPT ç”¢ç”Ÿ quiz JSON
            </button>
          </div>
          <div class="status" id="status-quiz">å°šæœªç”¢ç”Ÿã€‚</div>
          <div class="btn-row">
            <button class="btn btn-sm btn-ghost" id="downloadQuiz" type="button" disabled>ä¸‹è¼‰ quiz-*.json</button>
          </div>
        </div>

        <!-- 2.3 vocab -->
        <div class="block">
          <h3>2.3 å­—å½™ vocab JSON</h3>
          <div class="tagline">è¼¸å‡ºæª”åï¼š<code id="nameVocab">vocab-.json</code></div>
          <div class="btn-row">
            <button class="btn btn-primary" type="button" onclick="handleGenerate('vocab')">
              ç”¨ GPT ç”¢ç”Ÿ vocab JSON
            </button>
          </div>
          <div class="status" id="status-vocab">å°šæœªç”¢ç”Ÿã€‚</div>
          <div class="btn-row">
            <button class="btn btn-sm btn-ghost" id="downloadVocab" type="button" disabled>ä¸‹è¼‰ vocab-*.json</button>
          </div>
        </div>

        <!-- 2.4 ai -->
        <div class="block">
          <h3>2.4 AI äº’å‹•è…³æœ¬ ai JSON</h3>
          <div class="tagline">è¼¸å‡ºæª”åï¼š<code id="nameAi">ai-.json</code></div>
          <div class="btn-row">
            <button class="btn btn-primary" type="button" onclick="handleGenerate('ai')">
              ç”¨ GPT ç”¢ç”Ÿ ai JSON
            </button>
          </div>
          <div class="status" id="status-ai">å°šæœªç”¢ç”Ÿã€‚</div>
          <div class="btn-row">
            <button class="btn btn-sm btn-ghost" id="downloadAi" type="button" disabled>ä¸‹è¼‰ ai-*.json</button>
          </div>
        </div>

        <!-- 2.5 index -->
        <div class="block">
          <h3>2.5 å–®æ”¯å½±ç‰‡ index JSON</h3>
          <div class="tagline">
            è¼¸å‡ºæª”åï¼š<code id="nameIndex">index-.json</code><br>
            çµ¦ <code>data/{category}/index-*.json</code> ä½¿ç”¨ï¼ˆå–®æ”¯å½±ç‰‡æ¢ç›®ï¼‰ã€‚
          </div>
          <div class="btn-row">
            <button class="btn btn-primary" type="button" onclick="handleGenerate('index')">
              ç”¨ GPT ç”¢ç”Ÿ index JSON
            </button>
          </div>
          <div class="status" id="status-index">å°šæœªç”¢ç”Ÿã€‚</div>
          <div class="btn-row">
            <button class="btn btn-sm btn-ghost" id="downloadIndex" type="button" disabled>ä¸‹è¼‰ index-*.json</button>
          </div>
        </div>

        <!-- 3. Prompt + JSON é è¦½ -->
        <div class="block">
          <h3>3. GPT æç¤ºè©èˆ‡çµæœé è¦½</h3>
          <div class="tagline">åªé¡¯ç¤ºæœ€å¾Œä¸€æ¬¡å‘¼å« GPT çš„ Prompt èˆ‡ JSONï¼Œé¿å…ç•«é¢å¤ªé•·ã€‚</div>

          <div class="pill-row">
            <span class="pill"><strong>cues</strong>ï¼šå­—å¹•ä¸‰èªå°ç…§ï¼ˆå«æ™‚é–“ï¼‰</span>
            <span class="pill"><strong>quiz</strong>ï¼šå››é¡é¡Œç›®ï¼ˆè½åŠ› / å–®å­— / æ–‡æ³• / å£èªªï¼‰</span>
            <span class="pill"><strong>vocab</strong>ï¼šä¾‹å¥ + ä¸‰èªè§£é‡‹</span>
            <span class="pill"><strong>ai</strong>ï¼šæƒ…å¢ƒå°è©±è…³æœ¬</span>
          </div>

          <div class="field-row">
            <div>
              <label for="promptPreview">æœ€å¾Œä¸€æ¬¡ä½¿ç”¨çš„ Prompt</label>
              <textarea id="promptPreview" readonly></textarea>
            </div>
          </div>
          <div class="field-row">
            <div>
              <label for="jsonPreview">GPT å›å‚³ JSON é è¦½</label>
              <textarea id="jsonPreview" readonly></textarea>
              <div class="hint">è‹¥æ ¼å¼æœ‰å•é¡Œï¼Œå¯ä»¥åœ¨é€™è£¡æ‰‹å‹•èª¿æ•´ï¼Œå†è¤‡è£½å‡ºå»ç”¨ã€‚</div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const $ = (q) => document.querySelector(q);

    let srtSegments = [];
    const savedJson = {cues:null,quiz:null,vocab:null,ai:null,index:null};

    const apiKeyInput = $('#apiKey');
    const toggleKeyBtn = $('#toggleKey');

    // API Key æš«å­˜ localStorage + é¡¯ç¤º/éš±è—
    if (apiKeyInput) {
      const savedKey = localStorage.getItem('bw_json_api_key') || '';
      if (savedKey) apiKeyInput.value = savedKey;
      apiKeyInput.addEventListener('input', () => {
        localStorage.setItem('bw_json_api_key', apiKeyInput.value.trim());
      });
      apiKeyInput.type = 'password';
    }
    if (toggleKeyBtn && apiKeyInput) {
      toggleKeyBtn.addEventListener('click', () => {
        const type = apiKeyInput.type === 'password' ? 'text' : 'password';
        apiKeyInput.type = type;
        toggleKeyBtn.textContent = type === 'password' ? 'é¡¯ç¤º' : 'éš±è—';
      });
      toggleKeyBtn.textContent = 'é¡¯ç¤º';
    }

    const slugInput = $('#slug');
    const catSel = $('#category');

    function updateFileNames(){
      const slug = (slugInput.value || '').trim();
      $('#nameCues').textContent   = slug ? `cues-${slug}.json`  : 'cues-.json';
      $('#nameQuiz').textContent   = slug ? `quiz-${slug}.json`  : 'quiz-.json';
      $('#nameVocab').textContent  = slug ? `vocab-${slug}.json` : 'vocab-.json';
      $('#nameAi').textContent     = slug ? `ai-${slug}.json`    : 'ai-.json';
      $('#nameIndex').textContent  = slug ? `index-${slug}.json` : 'index-.json';
    }
    slugInput.addEventListener('input', updateFileNames);
    catSel.addEventListener('change', updateFileNames);

    function parseSrtText(raw){
      const lines = raw.replace(/\r/g,'').split('\n');
      const segments = [];
      let buffer = {time:'', text:''};

      function push(){
        if (buffer.time && buffer.text){
          segments.push({time:buffer.time.trim(), text:buffer.text.trim()});
        }
        buffer = {time:'',text:''};
      }

      for (let i=0;i<lines.length;i++){
        const line = lines[i].trim();
        if (/^\d+$/.test(line)) continue;
        const m = line.match(/(\d{2}:\d{2}:\d{2}),\d{3}\s*-->\s*(\d{2}:\d{2}:\d{2}),\d{3}/);
        if (m){
          if (buffer.time || buffer.text) push();
          buffer.time = m[1];
        }else if (line === ''){
          if (buffer.time || buffer.text) push();
        }else{
          buffer.text += (buffer.text ? ' ' : '') + line;
        }
      }
      if (buffer.time || buffer.text) push();

      return segments;
    }

    const srtFileInput = $('#srtFile');
    const srtPreview = $('#srtPreview');

    $('#btnParseSrt').addEventListener('click', () => {
      const file = srtFileInput.files && srtFileInput.files[0];
      if (!file){ alert('è«‹å…ˆé¸æ“‡ SRT æª”æ¡ˆã€‚'); return; }
      const reader = new FileReader();
      reader.onload = e => {
        const text = e.target.result;
        srtSegments = parseSrtText(text);
        if (!srtSegments.length){
          srtPreview.textContent = 'è§£æå¾Œæ²’æœ‰å–å¾—ä»»ä½•å­—å¹•æ®µè½ï¼Œè«‹ç¢ºèª SRT æ ¼å¼ã€‚';
          return;
        }
        const lines = srtSegments.slice(0,12).map(seg => `${seg.time} â†’ ${seg.text}`);
        if (srtSegments.length>12){
          lines.push(`...ï¼ˆå…± ${srtSegments.length} è¡Œå­—å¹•ï¼‰`);
        }
        srtPreview.textContent = lines.join('\n');
        showToast('SRT è§£æå®Œæˆ');
      };
      reader.readAsText(file,'utf-8');
    });

    $('#btnReparse').addEventListener('click', () => {
      srtSegments = [];
      srtPreview.textContent = 'å°šæœªè¼‰å…¥ SRT æª”ã€‚';
      showToast('å·²æ¸…é™¤è§£æçµæœï¼Œå¯ä»¥é‡æ–°ä¸Šå‚³ SRTã€‚');
    });

    function buildChatPayload(kind, model, slug){
      const cat = catSel ? catSel.value : '';
      const isProNoSrt = (cat === 'pro' && !srtSegments.length);
      const srtSample = srtSegments.map(s => `${s.time} ${s.text}`).join('\n');
      let systemMsg = `ä½ æ˜¯ BookWide çš„å…§å®¹ç·¨è¼¯åŠ©æ‰‹ï¼Œè«‹è¼¸å‡ºåˆæ³• JSONï¼ˆä¸è¦åŠ è¨»è§£ï¼‰ã€‚\n`;
      let userMsg = '';

      // PRO é¡åˆ¥ä¸”æ²’æœ‰ SRTï¼šæ”¹ç”¨ slug æ¨è«–æ–‡æ³•ä¸»é¡Œï¼Œä¸å†å¼•ç”¨å­—å¹•
      let grammarTopic = '';
      if (isProNoSrt){
        grammarTopic = inferGrammarTopicFromSlug(slug || '');
      }

      if (kind === 'cues'){
        systemMsg += `
ä»»å‹™ï¼šæ ¹æ“šå­—å¹•ç”¢ç”Ÿå¤šèªå­—å¹• JSON é™£åˆ—ã€‚
æ¯å€‹å…ƒç´ åŒ…å«ï¼š
- "time": "00:19"
- "en": è‹±æ–‡
- "zh": ç¹é«”ä¸­æ–‡
- "ja": æ—¥æ–‡
åƒ…è¼¸å‡º JSON é™£åˆ—ã€‚`;
        userMsg = `ä»¥ä¸‹æ˜¯å½±ç‰‡çš„è‹±æ–‡å­—å¹•ï¼ˆæ™‚é–“ + å…§å®¹ï¼‰ï¼Œè«‹ä¾èªªæ˜ç”¢ç”Ÿ cues JSON é™£åˆ—ï¼š
${srtSample}`;
      } else if (kind === 'quiz'){
        systemMsg += `
ä½ æ˜¯ä¸€å€‹åªæœƒè¼¸å‡º JSON çš„ç³»çµ±ã€‚ä½ çš„å›è¦†æœƒç›´æ¥ä¸Ÿçµ¦ JavaScript çš„ JSON.parseï¼Œå¦‚æœä¸æ˜¯åˆæ³• JSON å°±æœƒæ•´å€‹å¤±æ•—ã€‚

ä»»å‹™ï¼šæ ¹æ“šèª²ç¨‹å…§å®¹è¨­è¨ˆè‹±æ–‡é¸æ“‡é¡Œï¼Œè¼¸å‡ºã€ŒBookWide quiz æ¨™æº–æ ¼å¼ã€çš„ JSON é™£åˆ—ã€‚

ã€æ¬„ä½è¦æ ¼ï¼ˆæ¯ä¸€é¡Œä¸€å€‹ç‰©ä»¶ï¼‰ã€‘
- "section"ï¼šé¡Œç›®é¡åˆ¥ï¼Œä¾‹å¦‚ "Listening" / "Vocabulary" / "Grammar" / "Comprehension" / "Mixed"ã€‚
- "type"ï¼šä¸€å¾‹å¡« "MCQ"ã€‚
- "question"ï¼šé¡Œç›®æ•˜è¿°ï¼ˆè‹±æ–‡ï¼Œå¯åŒ…å« ____ ç©ºæ ¼ï¼‰ã€‚
- "options"ï¼š**æ°å¥½å››å€‹**å­—ä¸²ï¼Œå„è‡ªæ ¼å¼ç‚º "A. è‹±æ–‡ ä¸­æ–‡ æ—¥æ–‡"ã€"B. ..." ç­‰ï¼Œé–‹é ­å¿…é ˆæ˜¯ "A. "ã€"B. "ã€"C. "ã€"D. "ã€‚
- "answer"ï¼šæ­£ç¢ºé¸é …ä»£è™Ÿï¼Œåªèƒ½æ˜¯ "A" / "B" / "C" / "D"ã€‚
- "answer_en"ï¼šæ­£ç¢ºç­”æ¡ˆçš„è‹±æ–‡ã€‚
- "answer_zh"ï¼šæ­£ç¢ºç­”æ¡ˆå°æ‡‰çš„ä¸­æ–‡ç¿»è­¯ã€‚
- "answer_ja"ï¼šæ­£ç¢ºç­”æ¡ˆå°æ‡‰çš„æ—¥æ–‡ç¿»è­¯ã€‚
- "explanation_zh"ï¼šç”¨ä¸­æ–‡èªªæ˜ç‚ºä»€éº¼é€™å€‹é¸é …æ˜¯å°çš„ï¼ˆ1ï½3 å¥ï¼‰ã€‚
- "tts"ï¼šå›ºå®š "ja-JP"ã€‚
- "voice"ï¼šå›ºå®š "ja-JP-NanamiNeural"ã€‚

åš´æ ¼è¦æ±‚ï¼š
- åªèƒ½è¼¸å‡ºä¸€å€‹ JSON é™£åˆ—ï¼ˆæœ€å¤–å±¤ []ï¼‰ï¼Œä¸å¾—è¼¸å‡ºä»»ä½•èªªæ˜æ–‡å­—æˆ–è¨»è§£ã€‚
- é™£åˆ—ä¸­æ¯å€‹ç‰©ä»¶éƒ½å¿…é ˆåŒ…å«ä¸Šè¿°æ‰€æœ‰æ¬„ä½ï¼Œä¸å¾—ç¼ºæ¬„ä½ã€ä¸å¾—å¤šæ¬„ä½ã€‚
- æ‰€æœ‰å­—ä¸²éƒ½é ˆåœ¨å–®è¡Œå…§ï¼Œä¸èƒ½è·¨è¡Œã€‚`;
        if (isProNoSrt){
          userMsg = `æ–‡æ³•æˆ–å•†ç”¨è‹±æ–‡èª²ç¨‹ä¸»é¡Œèˆ‡å…§å®¹å¯ä»¥ç”±èª²ç¨‹åç¨±/slugã€Œ${slug || ''}ã€ä»¥åŠ grammarTopicã€Œ${grammarTopic || ''}ã€æ¨è«–ï¼Œè«‹ä¾ç…§ä¸Šé¢æ ¼å¼è¨­è¨ˆå¤§ç´„ 8ï½20 é¡Œçš„å¤šé¸é¡Œï¼›é¡Œç›®ä»¥è‹±æ–‡å‘ˆç¾ï¼Œå¿…è¦æ™‚å¯ä»¥è‡ªå·±å‰µé€ åˆç†çš„ä¾‹å¥ã€‚`;
        } else {
          userMsg = `ä»¥ä¸‹æ˜¯å½±ç‰‡çš„è‹±æ–‡å­—å¹•ï¼Œè«‹ä¾ç…§ä¸Šé¢æ ¼å¼ç”¢ç”Ÿ quiz JSONï¼ˆæ¯ä¸€é¡Œéƒ½è¦æœ‰ section / type / question / options / answer / answer_en / answer_zh / answer_ja / explanation_zh / tts / voice æ¬„ä½ï¼‰ï¼š\n\n${srtSample}`;
        }
      } else if (kind === 'vocab'){
        if (isProNoSrt){
          systemMsg += `
ä»»å‹™ï¼šæ ¹æ“šã€Œæ–‡æ³•ä¸»é¡Œã€ç”¢å‡ºèˆ‡è©²ä¸»é¡Œç›¸é—œçš„é—œéµå­—å½™ JSON é™£åˆ—ã€‚
æ¯ç­†åŒ…å«ï¼šword, pos, zh, en, en_example, zh_example, ja, ja_exampleã€‚
è«‹æŒ‘é¸ç´„ 8~15 å€‹é—œéµå­—å½™ï¼Œé©åˆåˆç´šå­¸ç¿’è€…ã€‚
åƒ…è¼¸å‡º JSON é™£åˆ—ã€‚`;
          userMsg = `æ–‡æ³•èª²ç¨‹ä¸»é¡Œæ˜¯ï¼šã€Œ${grammarTopic || 'åŸºç¤è‹±æ–‡æ–‡æ³•'}ã€ã€‚
è«‹æ ¹æ“šæ­¤ä¸»é¡Œç”¢å‡ºé©åˆæ”¾åœ¨å–®å­—è¡¨ä¸­çš„é—œéµå­—å½™ï¼ˆä¾‹å¦‚åŠŸèƒ½è©ã€å¸¸è¦‹ä¾‹å¥ä¸­çš„å­—ï¼‰ã€‚`;
        } else {
          systemMsg += `
ä»»å‹™ï¼šæŒ‘å‡ºé©åˆå­¸ç¿’çš„å–®å­—æˆ–ç‰‡èªï¼Œç”¢ç”Ÿ vocab JSON é™£åˆ—ã€‚
æ¯ç­†åŒ…å«ï¼štime, word, pos, zh, en, en_example, zh_example, ja, ja_exampleã€‚
å¤§ç´„ 15~25 ç­†ã€‚åƒ…è¼¸å‡º JSON é™£åˆ—ã€‚`;
          userMsg = `ä»¥ä¸‹æ˜¯å½±ç‰‡å­—å¹•ï¼Œè«‹ä¾èªªæ˜ç”¢ç”Ÿ vocab JSONï¼š
${srtSample}`;
        }
      } else if (kind === 'ai'){
        // AI JSON ä¸€å¾‹è¼¸å‡ºã€Œåœ–ä¸€ã€æ ¼å¼ï¼Œplayer.html æ‰è®€å¾—åˆ°ï¼š
        // [
        //   {
        //     "title": "...",
        //     "prompt": "...",
        //     "hint": "...",
        //     "sample": "...",
        //     "ja": { "prompt": "...", "hint": "...", "sample": "..." },
        //     "zh": { "prompt": "...", "hint": "...", "sample": "..." }
        //   }
        // ]
        if (isProNoSrt){
          systemMsg += `
ä»»å‹™ï¼šæ ¹æ“šã€Œæ–‡æ³•ä¸»é¡Œã€è¨­è¨ˆ AI äº’å‹•ç·´ç¿’é¡Œç›®ï¼Œè¼¸å‡º JSON é™£åˆ—ã€‚
âš ï¸ çµæ§‹å¿…é ˆå®Œå…¨ç¬¦åˆä¸‹åˆ—æ¬„ä½ï¼Œä¸èƒ½å¦å¤–åŒ…ä¸€å±¤ topics æˆ–å…¶ä»–å±¬æ€§ï¼š

[
  {
    "title": "æ¨™é¡Œï¼ˆè‹±æ–‡ï¼‰",
    "prompt": "è«‹å­¸ç”Ÿè¦åšä»€éº¼çš„èªªæ˜ï¼ˆè‹±æ–‡ï¼‰",
    "hint": "çµ¦å­¸ç”Ÿçš„æç¤ºï¼ˆè‹±æ–‡ï¼Œå¯ç°¡çŸ­ï¼‰",
    "sample": "ç¤ºç¯„ç­”æ¡ˆï¼ˆè‹±æ–‡ï¼‰",
    "ja": {
      "prompt": "æ—¥æ–‡ç‰ˆèªªæ˜",
      "hint": "æ—¥æ–‡æç¤º",
      "sample": "æ—¥æ–‡ç¤ºç¯„ç­”æ¡ˆ"
    },
    "zh": {
      "prompt": "ç¹é«”ä¸­æ–‡ç‰ˆèªªæ˜",
      "hint": "ç¹é«”ä¸­æ–‡æç¤º",
      "sample": "ç¹é«”ä¸­æ–‡ç¤ºç¯„ç­”æ¡ˆ"
    }
  }
]

è«‹åªè¼¸å‡ºåƒä¸Šé¢é€™æ¨£çš„ JSON é™£åˆ—æœ¬èº«ï¼ˆæœ€å¤–å±¤ç”¨ []ï¼‰ï¼Œä¸è¦å¤šåŠ æ–‡å­—èªªæ˜ï¼Œä¹Ÿä¸è¦åŒ…åœ¨ç¨‹å¼ç¢¼å€å¡Šå…§ã€‚`;
          userMsg = `æ–‡æ³•èª²ç¨‹ä¸»é¡Œæ˜¯ï¼šã€Œ${grammarTopic || 'åŸºç¤è‹±æ–‡æ–‡æ³•'}ã€ã€‚
è«‹è¨­è¨ˆç´„ 3ï½6 é¡Œ AI ç·´ç¿’ï¼Œæ¯ä¸€é¡Œéƒ½ç”¨ä¸Šè¿°æ¬„ä½æ ¼å¼ï¼Œè®“å­¸ç”Ÿå¯ä»¥ç·´ç¿’é€™å€‹æ–‡æ³•ã€‚`;
        } else {
          systemMsg += `
ä»»å‹™ï¼šæ ¹æ“šå½±ç‰‡æƒ…å¢ƒç”¢ç”Ÿ AI äº’å‹•ç·´ç¿’é¡Œç›®ï¼Œè¼¸å‡º JSON é™£åˆ—ã€‚
âš ï¸ çµæ§‹å¿…é ˆå®Œå…¨ç¬¦åˆä¸‹åˆ—æ¬„ä½ï¼Œä¸èƒ½å¦å¤–åŒ…ä¸€å±¤ topics æˆ–å…¶ä»–å±¬æ€§ï¼š

[
  {
    "title": "æ¨™é¡Œï¼ˆè‹±æ–‡ï¼‰",
    "prompt": "è«‹å­¸ç”Ÿè¦åšä»€éº¼çš„èªªæ˜ï¼ˆè‹±æ–‡ï¼‰",
    "hint": "çµ¦å­¸ç”Ÿçš„æç¤ºï¼ˆè‹±æ–‡ï¼Œå¯ç°¡çŸ­ï¼‰",
    "sample": "ç¤ºç¯„ç­”æ¡ˆï¼ˆè‹±æ–‡ï¼‰",
    "ja": {
      "prompt": "æ—¥æ–‡ç‰ˆèªªæ˜",
      "hint": "æ—¥æ–‡æç¤º",
      "sample": "æ—¥æ–‡ç¤ºç¯„ç­”æ¡ˆ"
    },
    "zh": {
      "prompt": "ç¹é«”ä¸­æ–‡ç‰ˆèªªæ˜",
      "hint": "ç¹é«”ä¸­æ–‡æç¤º",
      "sample": "ç¹é«”ä¸­æ–‡ç¤ºç¯„ç­”æ¡ˆ"
    }
  }
]

è«‹åªè¼¸å‡ºåƒä¸Šé¢é€™æ¨£çš„ JSON é™£åˆ—æœ¬èº«ï¼ˆæœ€å¤–å±¤ç”¨ []ï¼‰ï¼Œä¸è¦å¤šåŠ æ–‡å­—èªªæ˜ï¼Œä¹Ÿä¸è¦åŒ…åœ¨ç¨‹å¼ç¢¼å€å¡Šå…§ã€‚`;
          userMsg = `ä»¥ä¸‹æ˜¯å½±ç‰‡å­—å¹•ï¼Œè«‹ä¾èªªæ˜ç”¢ç”Ÿ ai JSONï¼ˆåŒæ¨£ä½¿ç”¨ title / prompt / hint / sample / ja / zh çµæ§‹ï¼‰ï¼š
${srtSample}`;
        }
      } else if (kind === 'index'){
        const title = slug.replace(/-/g,' ');
        systemMsg += `
ä»»å‹™ï¼šç‚ºå–®æ”¯å½±ç‰‡ç”¢ç”Ÿ index JSON ç‰©ä»¶ï¼ŒåŒ…å«ï¼š
category, slug, title, difficulty_level (1~3), duration_secã€‚
åƒ…è¼¸å‡ºå–®ä¸€ JSON ç‰©ä»¶ã€‚`;
        userMsg = `è«‹å¹«æˆ‘ç‚ºä»¥ä¸‹å½±ç‰‡ç”¢ç”Ÿ index JSONï¼š
category: ${cat}
slug: ${slug}
title: ${title || slug}`;
      }

      return {
        model,
        messages:[
          {role:'system',content:systemMsg},
          {role:'user',content:userMsg}
        ],
        temperature:0.2
      };
    }

    function getFileName(kind, slug){
      if (!slug) return `${kind}-.json`;
      if (kind === 'index') return `index-${slug}.json`;
      return `${kind}-${slug}.json`;
    }

    async function handleGenerate(kind){
      const apiKey = ($('#apiKey').value || '').trim();
      const model  = $('#model').value;
      const slug   = ($('#slug').value || '').trim();
      const cat    = catSel ? catSel.value : '';
      if (!apiKey){ alert('è«‹å…ˆè¼¸å…¥ OpenAI API Keyã€‚'); return; }
      if (!slug){ alert('è«‹å…ˆå¡«å¯«å½±ç‰‡ slugã€‚'); return; }

      // æ²’æœ‰ SRT çš„è™•ç†ï¼š
      // - ä¸€èˆ¬é¡åˆ¥ï¼šç¦æ­¢å‘¼å«ï¼ˆé¿å… GPT æ¯«ç„¡ä¾æ“šäº‚ç·¨ï¼‰
      // - PRO é¡åˆ¥ï¼š
      //     * cuesï¼šç›´æ¥è¼¸å‡ºç©ºç™½æ¨¡æ¿ï¼ˆåƒ…ä¿ç•™æ¬„ä½ï¼‰
      //     * quiz / vocab / ai / indexï¼šå…è¨±ç¹¼çºŒï¼Œç”± buildChatPayload ä¾ slug æ¨è«–æ–‡æ³•ä¸»é¡Œ
      if (!srtSegments.length){
        if (cat === 'pro'){
          if (kind === 'cues'){
            const statusEl = document.getElementById(`status-${kind}`);
            const obj = [
              {
                "time": "",
                "en": "",
                "zh": "",
                "ja": "",
                "source_url": ""
              }
            ];
            savedJson[kind] = obj;
            const fileName = getFileName(kind, slug);
            triggerDownload(JSON.stringify(obj,null,2), fileName);
            document.getElementById(`download${cap(kind)}`).disabled = false;
            statusEl.textContent = `å·²å®Œæˆä¸¦ä¸‹è¼‰ ${fileName}ï¼ˆPRO ç„¡ SRTï¼Œè¼¸å‡ºç©ºç™½æ¨¡æ¿ï¼‰ã€‚`;
            statusEl.className = 'status ok';
            document.getElementById('jsonPreview').value = JSON.stringify(obj,null,2);
            showToast(`å·²ä¸‹è¼‰ ${fileName}`);
            return;
          }
          // PRO ä½†é cuesï¼šå…è¨±ç¹¼çºŒå¾€ä¸‹
        }else{
          alert('è«‹å…ˆä¸Šå‚³ä¸¦è§£æ SRT æª”ã€‚');
          return;
        }
      }

      const statusEl = document.getElementById(`status-${kind}`);
      statusEl.textContent = 'å‘¼å« GPT ç”¢ç”Ÿä¸­â€¦';
      statusEl.className = 'status';

      try{
        const payload = buildChatPayload(kind, model, slug);
        const res = await fetch('https://api.openai.com/v1/chat/completions',{
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Authorization':`Bearer ${apiKey}`
          },
          body:JSON.stringify(payload)
        });
        if (!res.ok){
          const t = await res.text();
          throw new Error(`API éŒ¯èª¤ï¼š${res.status} ${t}`);
        }
        const data = await res.json();
        const content = data.choices?.[0]?.message?.content || '';

        $('#promptPreview').value = payload.messages.map(m => `# ${m.role}\n${m.content}`).join('\n\n');

        let text = content.trim();
        const m = text.match(/```(?:json)?\s*([\s\S]*?)```/i);
        if (m && m[1]) text = m[1].trim();

        let obj;
        try{ obj = JSON.parse(text); }
        catch(e){ throw new Error('GPT å›å‚³å…§å®¹ä¸æ˜¯åˆæ³• JSONï¼Œè«‹é‡è©¦ã€‚'); }

        // åœ¨ cues çš„ç¬¬ä¸€ç­†ç‰©ä»¶å¡ source_urlï¼ˆä¿æŒé™£åˆ—æ ¼å¼ï¼‰
        if (kind === 'cues'){
          const srcInput = document.getElementById('videoSourceInput');
          const src = srcInput ? (srcInput.value || '').trim() : '';
          if (src && Array.isArray(obj) && obj.length > 0){
            obj[0].source_url = src;
          }
        }

        savedJson[kind] = obj;
        const fileName = getFileName(kind, slug);
        triggerDownload(JSON.stringify(obj,null,2), fileName);
        document.getElementById(`download${cap(kind)}`).disabled = false;
        statusEl.textContent = `å·²å®Œæˆä¸¦ä¸‹è¼‰ ${fileName}ã€‚`;
        statusEl.className = 'status ok';
        document.getElementById('jsonPreview').value = JSON.stringify(obj,null,2);
        showToast(`å·²ä¸‹è¼‰ ${fileName}`);
      }catch(err){
        console.error(err);
        statusEl.textContent = `ç™¼ç”ŸéŒ¯èª¤ï¼š${err.message}`;
        statusEl.className = 'status err';
        showToast('ç”¢ç”Ÿ JSON æ™‚ç™¼ç”ŸéŒ¯èª¤');
      }
    }

    function cap(s){return s.charAt(0).toUpperCase()+s.slice(1);}

    function triggerDownload(text, filename){
      const blob = new Blob([text],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function setupDownloadButtons(){
      ['cues','quiz','vocab','ai','index'].forEach(kind => {
        const btn = document.getElementById(`download${cap(kind)}`);
        if (!btn) return;
        btn.addEventListener('click', () => {
          const slug = ($('#slug').value || '').trim();
          if (!slug){ alert('è«‹å…ˆå¡«å¯« slugã€‚'); return; }
          const obj = savedJson[kind];
          if (!obj){ alert(`å°šæœªç”¢ç”Ÿ ${kind} JSONã€‚`); return; }
          const fileName = getFileName(kind, slug);
          triggerDownload(JSON.stringify(obj,null,2), fileName);
        });
      });
    }
    setupDownloadButtons();

    let generatingAll = false;
    async function handleGenerateAll(){
      if (generatingAll) return;
      const apiKey = ($('#apiKey').value || '').trim();
      const slug   = ($('#slug').value || '').trim();
      const cat    = catSel ? catSel.value : '';
      if (!apiKey){ alert('è«‹å…ˆè¼¸å…¥ OpenAI API Keyã€‚'); return; }
      if (!slug){ alert('è«‹å…ˆå¡«å¯«å½±ç‰‡ slugã€‚'); return; }

      // ä¸€éµæ¨¡å¼ä¸‹ï¼šé PRO é¡åˆ¥ä»ç„¶å¼·åˆ¶è¦æœ‰ SRTï¼›PRO å¯å…è¨±ç„¡ SRT
      if (!srtSegments.length && cat !== 'pro'){
        alert('è«‹å…ˆä¸Šå‚³ä¸¦è§£æ SRT æª”ã€‚');
        return;
      }

      const btnAll = document.getElementById('btnGenerateAll');
      const originalText = btnAll.textContent;
      generatingAll = true;
      btnAll.textContent = 'å…¨éƒ¨ç”¢ç”Ÿä¸­â€¦';

      const order = ['cues','quiz','vocab','ai','index'];
      for (const kind of order){
        const statusEl = document.getElementById(`status-${kind}`);
        statusEl.textContent = 'æ’éšŠç”¢ç”Ÿä¸­â€¦';
        statusEl.className = 'status';
      }

      for (const kind of order){
        try{
          await handleGenerate(kind);
        }catch(e){
          console.error(e);
        }
      }

      generatingAll = false;
      btnAll.textContent = originalText;
      showToast('å…¨éƒ¨ JSON ç”¢ç”Ÿæµç¨‹çµæŸ');
    }

    // å¾ slug æ¨æ–‡æ³•ä¸»é¡Œï¼ˆçµ¦ PRO ç„¡ SRT ä½¿ç”¨ï¼‰
    function inferGrammarTopicFromSlug(slug){
      const s = (slug || '').toLowerCase();
      if (!s) return 'åŸºç¤è‹±æ–‡æ–‡æ³•';
      if (s.includes('indefinite-article')) return 'ä¸å®šå† è© a / an';
      if (s.includes('specific-references-the')) return 'å®šå† è© the çš„ç”¨æ³•';
      if (s.includes('personal-pronoun')) return 'äººç¨±ä»£åè©';
      if (s.includes('possessive-pronoun')) return 'ç‰©ä¸»ä»£è©';
      return slug.replace(/-/g,' ');
    }

    const toastEl = $('#toast');
    let toastTimer = null;
    function showToast(msg){
      if (!toastEl) return;
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(() => {
        toastEl.classList.remove('show');
      }, 2000);
    }
  </script>
</body>
</html>








































































