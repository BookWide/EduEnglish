<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin | JSON 產生器</title>
  <style>
    :root{
      --bg:#f4f6fb;
      --card-bg:#fff;
      --muted:#6b7280;
      --border:#e5e7eb;
      --brand:#2563eb;
      --brand-soft:#e0edff;
      --danger:#b91c1c;
      --radius-lg:18px;
      --shadow-card:0 10px 30px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      background:var(--bg);
      color:#111827;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC,Helvetica,Arial,sans-serif;
    }
    a{color:var(--brand);text-decoration:none;}
    .wrap{
      max-width:1080px;
      margin:24px auto 64px;
      padding:0 16px;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:16px;
    }
    header h1{
      margin:0;
      font-size:20px;
      font-weight:700;
    }
    header .meta{
      font-size:13px;
      color:var(--muted);
    }
    .tabs{
      display:flex;
      gap:8px;
      margin:8px 0 20px;
    }
    .tab{
      padding:6px 14px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:14px;
      background:#fff;
      cursor:pointer;
    }
    .tab.active{
      background:var(--brand);
      color:#fff;
      border-color:var(--brand);
    }

    .card{
      background:var(--card-bg);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-card);
      padding:18px 18px 20px;
      margin-bottom:18px;
    }
    .card h2{
      margin:0 0 8px;
      font-size:17px;
    }
    .card p.desc{
      margin:0 0 14px;
      font-size:13px;
      color:var(--muted);
    }

    label{
      font-size:13px;
      color:#374151;
      display:block;
      margin-bottom:4px;
    }
    .row{
      display:flex;
      flex-wrap:wrap;
      gap:12px 16px;
      margin-bottom:10px;
    }
    .col{
      flex:1 1 220px;
      min-width:0;
    }
    input[type="text"],
    input[type="password"],
    select,
    textarea{
      width:100%;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid var(--border);
      font:14px/1.4 inherit;
    }
    textarea{
      resize:vertical;
      min-height:120px;
    }
    input[type="file"]{
      font-size:14px;
    }
    .hint{
      font-size:12px;
      color:var(--muted);
    }

    .btn{
      border-radius:999px;
      border:1px solid transparent;
      padding:7px 14px;
      font-size:14px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .btn-primary{
      background:var(--brand);
      color:#fff;
      border-color:var(--brand);
    }
    .btn-outline{
      background:#fff;
      color:#111827;
      border-color:var(--border);
    }
    .btn[disabled]{
      opacity:.6;
      cursor:default;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      background:var(--brand-soft);
      color:#1e40af;
      margin-left:6px;
    }

    pre{
      margin:8px 0 0;
      padding:10px 12px;
      background:#0f172a;
      color:#e5e7eb;
      border-radius:10px;
      font-size:12px;
      max-height:220px;
      overflow:auto;
      white-space:pre-wrap;
    }

    .json-row{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:8px 12px;
      margin-bottom:10px;
    }
    .json-title{
      font-size:15px;
      font-weight:600;
    }
    .json-filename{
      font-size:13px;
      color:var(--muted);
    }
    .status{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
      min-height:16px;
    }

    footer{
      margin-top:28px;
      font-size:12px;
      color:var(--muted);
      text-align:center;
    }

    @media (max-width:640px){
      .card{padding:14px 12px 16px;}
      header h1{font-size:18px;}
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>BookWide Admin｜JSON 產生器</h1>
      <div class="meta">由英文 SRT 產生 cues / quiz / vocab / ai / index JSON。</div>
    </div>
    <div class="meta">
      管理員：<span id="adminEmail">—</span>
    </div>
  </header>

  <div class="tabs">
    <a class="tab" href="./change.html#mp4">MP4 整理</a>
    <button type="button" class="tab active">JSON 產生器</button>
  </div>

  <!-- OpenAI 設定 -->
  <section class="card">
    <h2>OpenAI 設定</h2>
    <p class="desc">
      API Key 只會存在您的瀏覽器，不會上傳到其他伺服器。每次按按鈕只會產生一個 JSON 檔。
    </p>
    <div class="row">
      <div class="col">
        <label for="apiKey">OpenAI API Key</label>
        <input id="apiKey" type="password" placeholder="sk-..." autocomplete="off" />
        <div class="hint">只用來呼叫 GPT 產生 JSON，不會帶你去 OpenAI 網站。</div>
      </div>
      <div class="col" style="max-width:220px;">
        <label for="model">使用模型</label>
        <select id="model">
          <option value="gpt-4.1-mini">gpt-4.1-mini（建議）</option>
          <option value="gpt-4.1">gpt-4.1</option>
          <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
        </select>
      </div>
    </div>
  </section>

  <!-- 基本資料 -->
  <section class="card">
    <h2>基本資料</h2>
    <p class="desc">這裡決定檔名與路徑文字說明，不會影響 SRT 內容。</p>
    <div class="row">
      <div class="col">
        <label for="category">分類（category）</label>
        <select id="category">
          <option value="story">story</option>
          <option value="music" selected>music</option>
          <option value="movie">movie</option>
          <option value="news">news</option>
          <option value="pro">pro</option>
        </select>
        <div class="hint">會影響 index JSON 內的 category 欄位。</div>
      </div>
      <div class="col">
        <label for="slug">片名（slug）</label>
        <input id="slug" type="text" placeholder="例如：hello、houyi、alittlelove…" value="hello" />
        <div class="hint">會用在 cues-片名.json / quiz-片名.json… 等檔名。</div>
      </div>
    </div>
    <div class="hint">
      將會產生：
      <span id="fileCues"></span>、
      <span id="fileQuiz"></span>、
      <span id="fileVocab"></span>、
      <span id="fileAi"></span>、
      <span id="fileIndex"></span>
    </div>
  </section>

  <!-- 1. 上傳 SRT -->
  <section class="card">
    <h2>1. 上傳英文 SRT 字幕</h2>
    <p class="desc">
      目前只讀英文字幕，GPT 會負責翻譯成中、日文並組成 JSON。
    </p>
    <div class="row">
      <div class="col">
        <label for="srtFile">選擇檔案</label>
        <input id="srtFile" type="file" accept=".srt,.txt" />
        <div class="hint">例如：hello.srt。重新選檔案會自動重新解析。</div>
      </div>
      <div class="col" style="align-self:flex-end;max-width:160px;">
        <button type="button" class="btn btn-outline" id="btnReparse">重新解析 SRT</button>
      </div>
    </div>
    <label>已解析的段落預覽</label>
    <pre id="srtPreview">尚未載入 SRT 檔案。</pre>
  </section>

  <!-- 2. JSON 產生器 -->
  <section class="card">
    <h2>2. 使用 GPT 產生 JSON（一次一個檔）</h2>
    <p class="desc">
      按下左邊藍色按鈕，會把目前 SRT 段落與指示送給 GPT，完成後：
      自動下載檔案到瀏覽器預設下載資料夾，右邊灰色按鈕也會變成可再下載一次。<br>
      （下載資料夾路徑無法由網頁指定，如需修改請在瀏覽器設定中變更。）
    </p>

    <!-- cues -->
    <div class="json-block">
      <div class="json-row">
        <div>
          <div class="json-title">cues JSON<span class="badge">字幕逐句</span></div>
          <div class="json-filename" id="nameCues"></div>
        </div>
        <div style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap;">
          <button type="button" class="btn btn-primary" id="btnGenCues">① 用 GPT 產生 cues JSON</button>
          <button type="button" class="btn btn-outline" id="btnDownCues" disabled>下載 cues-*.json</button>
        </div>
      </div>
      <div class="status" id="statusCues"></div>
    </div>

    <!-- quiz -->
    <div class="json-block">
      <div class="json-row">
        <div>
          <div class="json-title">quiz JSON<span class="badge">測驗題目</span></div>
          <div class="json-filename" id="nameQuiz"></div>
        </div>
        <div style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap;">
          <button type="button" class="btn btn-primary" id="btnGenQuiz">① 用 GPT 產生 quiz JSON</button>
          <button type="button" class="btn btn-outline" id="btnDownQuiz" disabled>下載 quiz-*.json</button>
        </div>
      </div>
      <div class="status" id="statusQuiz"></div>
    </div>

    <!-- vocab -->
    <div class="json-block">
      <div class="json-row">
        <div>
          <div class="json-title">vocab JSON<span class="badge">單字表</span></div>
          <div class="json-filename" id="nameVocab"></div>
        </div>
        <div style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap;">
          <button type="button" class="btn btn-primary" id="btnGenVocab">① 用 GPT 產生 vocab JSON</button>
          <button type="button" class="btn btn-outline" id="btnDownVocab" disabled>下載 vocab-*.json</button>
        </div>
      </div>
      <div class="status" id="statusVocab"></div>
    </div>

    <!-- ai -->
    <div class="json-block">
      <div class="json-row">
        <div>
          <div class="json-title">ai JSON<span class="badge">AI 對話主題</span></div>
          <div class="json-filename" id="nameAi"></div>
        </div>
        <div style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap;">
          <button type="button" class="btn btn-primary" id="btnGenAi">① 用 GPT 產生 ai JSON</button>
          <button type="button" class="btn btn-outline" id="btnDownAi" disabled>下載 ai-*.json</button>
        </div>
      </div>
      <div class="status" id="statusAi"></div>
    </div>

    <!-- index -->
    <div class="json-block">
      <div class="json-row">
        <div>
          <div class="json-title">index JSON<span class="badge">影片索引</span></div>
          <div class="json-filename" id="nameIndex"></div>
        </div>
        <div style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap;">
          <button type="button" class="btn btn-primary" id="btnGenIndex">① 用 GPT 產生 index JSON</button>
          <button type="button" class="btn btn-outline" id="btnDownIndex" disabled>下載 index-*.json</button>
        </div>
      </div>
      <div class="status" id="statusIndex"></div>
    </div>
  </section>

  <footer>
    BookWide Admin JSON 產生器 ｜ v20251127-json<br>
    建議產生後將檔案放到：<code>data/{category}/</code>
  </footer>
</div>

<!-- 隱藏下載用 a 標籤 -->
<a id="hiddenDownload" style="display:none;"></a>

<script type="module">
  import './supa.js?v=20251109g';

  const $ = (q,root=document) => root.querySelector(q);

  // --------------- Supabase / Admin 守門 + 心跳 ---------------
  (async () => {
    try{
      await BW.requireAdmin();
      BW.startHeartbeat(2);
      const { data:{user} } = await BW.supa.auth.getUser();
      if(user?.email) $('#adminEmail').textContent = user.email;
    }catch(e){
      console.error('admin guard error', e);
    }
  })();

  // --------------- 狀態 ---------------
  let parsedSegments = [];   // 由 SRT 解析出的段落 [{time,text},...]
  const state = {
    cues:{json:null,url:null},
    quiz:{json:null,url:null},
    vocab:{json:null,url:null},
    ai:{json:null,url:null},
    index:{json:null,url:null},
  };

  function updateFileNames(){
    const slug = ($('#slug').value || '').trim() || 'untitled';
    $('#fileCues').textContent  = 'cues-'  + slug + '.json';
    $('#fileQuiz').textContent  = 'quiz-'  + slug + '.json';
    $('#fileVocab').textContent = 'vocab-' + slug + '.json';
    $('#fileAi').textContent    = 'ai-'    + slug + '.json';
    $('#fileIndex').textContent = 'index-' + slug + '.json';

    $('#nameCues').textContent  = $('#fileCues').textContent;
    $('#nameQuiz').textContent  = $('#fileQuiz').textContent;
    $('#nameVocab').textContent = $('#fileVocab').textContent;
    $('#nameAi').textContent    = $('#fileAi').textContent;
    $('#nameIndex').textContent = $('#fileIndex').textContent;
  }
  updateFileNames();
  $('#slug').addEventListener('input', updateFileNames);
  $('#category').addEventListener('change', updateFileNames);

  // --------------- SRT 解析 ---------------
  function parseSrt(text){
    const lines = text.replace(/\r\n/g,'\n').split('\n');
    const items = [];
    let i=0;
    while(i < lines.length){
      // skip index line
      if(!lines[i].trim()){ i++; continue; }
      if(/^\d+$/.test(lines[i].trim())) i++;

      const timeLine = lines[i] || '';
      const m = timeLine.match(/(\d{2}:\d{2}:\d{2}),\d{2,3}\s*-->\s*(\d{2}:\d{2}:\d{2}),\d{2,3}/);
      if(!m){ i++; continue; }
      const start = m[1];
      const end   = m[2];
      i++;

      const texts = [];
      while(i < lines.length && lines[i].trim()){
        texts.push(lines[i]);
        i++;
      }
      const en = texts.join(' ').trim();
      if(en){
        items.push({ time:start, end, en });
      }
      while(i < lines.length && !lines[i].trim()) i++;
    }
    return items;
  }

  async function handleSrtFile(file){
    if(!file) return;
    const text = await file.text();
    parsedSegments = parseSrt(text);
    if(!parsedSegments.length){
      $('#srtPreview').textContent = '解析失敗，找不到任何字幕段落。請確認是標準 SRT 格式。';
      return;
    }
    const previewLines = parsedSegments.slice(0,15).map((it,idx)=>(
      String(idx+1).padStart(2,'0') + '. ['+it.time+'] ' + it.en
    ));
    if(parsedSegments.length>15){
      previewLines.push('…… 共 '+parsedSegments.length+' 段。');
    }
    $('#srtPreview').textContent = previewLines.join('\n');
  }

  $('#srtFile').addEventListener('change', e=>{
    const file = e.target.files[0];
    if(file) handleSrtFile(file);
  });
  $('#btnReparse').addEventListener('click', ()=>{
    const file = $('#srtFile').files[0];
    if(file) handleSrtFile(file);
  });

  // --------------- GPT 呼叫共用函式 ---------------
  function getApiConfig(){
    const key = ($('#apiKey').value || '').trim();
    if(!key){
      alert('請先輸入 OpenAI API Key');
      return null;
    }
    const model = $('#model').value || 'gpt-4.1-mini';
    if(!parsedSegments.length){
      alert('請先上傳並解析 SRT 檔案。');
      return null;
    }
    const slug = ($('#slug').value || '').trim() || 'untitled';
    const category = $('#category').value || 'story';
    return { key, model, slug, category };
  }

  function segmentsForPrompt(){
    // 只傳英文部分給 GPT，避免 token 太多
    return parsedSegments.map(s => `[${s.time}] ${s.en}`).join('\n');
  }

  function cleanupJsonFromGPT(text){
    if(!text) throw new Error('GPT 回傳空白');
    const fence = text.match(/```json([\s\S]*?)```/i) || text.match(/```([\s\S]*?)```/i);
    const raw = (fence ? fence[1] : text).trim();
    const obj = JSON.parse(raw); // 讓它拋錯就好
    return JSON.stringify(obj,null,2);
  }

  async function callGPT(kind){
    const cfg = getApiConfig();
    if(!cfg) return;

    const { key, model, slug, category } = cfg;

    const btnGen   = $('#btnGen'+kind);
    const btnDown  = $('#btnDown'+kind);
    const statusEl = $('#status'+kind);
    const fileName = $('#file'+kind).textContent;

    btnGen.disabled = true;
    statusEl.textContent = '⏳ 正在向 GPT 產生 ' + fileName + '，請稍候…';

    const segText = segmentsForPrompt();

    let userPrompt = '';
    if(kind === 'Cues'){
      userPrompt = `
請閱讀以下英文歌曲字幕，每行格式為 [時間] 句子。為每一行建立一個物件，組成 JSON 陣列。
欄位：time（字串，使用該行時間）、en（英文原句）、zh（正體中文翻譯）、ja（日文翻譯）。
不要漏行、不要留空白，翻譯自然、口語即可。

以下為字幕：
${segText}
`;
    }else if(kind === 'Quiz'){
      userPrompt = `
根據以下英文歌曲字幕內容，設計 8~12 題英文理解與字彙題，輸出成 JSON 陣列。
每一題是一個物件，欄位格式請完全比照這個範例：
${JSON.stringify([
  {
    "section":"meaning",
    "type":"mc",
    "question":"What does the singer feel when they say 'I'm not so good'?",
    "choices":["They are hungry.","They are tired.","They feel a bit sad or unwell.","They are very happy."],
    "answer":2,
    "explanation":"\"I'm not so good\" usually means the person is not feeling well or is a bit sad."
  }
], null, 2)}

規則：
1. section 可使用 "meaning" 或 "vocab" 等簡短分類字串。
2. type 使用 "mc"（單選題）或 "sa"（簡答題）。
3. choices 只有 mc 題才要填 4 個選項，sa 題請填空陣列 []。
4. answer：mc 題填正確選項索引（0~3），sa 題請填 0。
5. explanation：用簡單英文說明答案為何。

以下為字幕：
${segText}
`;
    }else if(kind === 'Vocab'){
      userPrompt = `
從以下英文字幕中挑選 10~20 個對學習者有幫助的字或片語，輸出成 JSON 陣列。
每個物件欄位如下（請完全照這個範例的欄位名稱）：
${JSON.stringify([
  {
    "en":"hungry",
    "zh":"肚子餓的",
    "ja":"お腹がすいている",
    "def_en":"feeling that you want or need to eat",
    "example_en":"I'm hungry, so I want to eat something."
  }
], null, 2)}

規則：
1. en：字或片語（小寫即可）。
2. zh：正體中文解釋。
3. ja：自然的日文解釋。
4. def_en：簡單英文定義。
5. example_en：使用該字的簡短英文例句。

字幕內容如下：
${segText}
`;
    }else if(kind === 'Ai'){
      userPrompt = `
根據以下歌曲內容，幫我設計 4~6 個適合 AI 對話練習的主題，輸出成 JSON 物件，
格式參考（請保留 topics 陣列結構與欄位名稱）：
${JSON.stringify({
  "topics":[
    {
      "title":"Greetings and Feelings",
      "prompt":"學生扮演 A，AI 扮演 B，兩人用英文互相問候並聊今天的心情。",
      "hint":"可以用句型：How are you? I'm fine / I'm not so good / I'm tired...",
      "sample":"A: Hello, how are you today?\nB: I'm a little tired, but I'm okay. How about you?"
    }
  ]
}, null, 2)}

欄位說明：
1. title：主題名稱（中文或中英皆可）。
2. prompt：給 AI 的指令，說明角色與任務，用繁體中文撰寫。
3. hint：給學生看的提示與可用句型，用繁體中文。
4. sample：一小段英文對話範例，多行以 \\n 斷行。

以下是字幕內容：
${segText}
`;
    }else if(kind === 'Index'){
      userPrompt = `
請幫我產生一個影片索引 JSON 物件，欄位格式請完全比照下列範例：
${JSON.stringify({
  "title":"A Little Love",
  "category":"music",
  "slug":"applesong",
  "video":"",
  "cover":"",
  "cues": { "zh": "./cues-applesong.json" },
  "vocab":"./vocab-applesong.json",
  "quiz":"./quiz-applesong.json",
  "ai":"./ai-applesong.json",
  "is_public":true
}, null, 2)}

請根據以下資訊填入：
1. title：請根據字幕內容，給一個合適的英文或中英片名。
2. category：固定用 "${category}"。
3. slug：固定用 "${slug}"。
4. video / cover：先留空字串 ""。
5. cues：只保留 zh 這個 key，路徑為 "./cues-${slug}.json"。
6. vocab / quiz / ai：路徑分別為 "./vocab-${slug}.json"、"./quiz-${slug}.json"、"./ai-${slug}.json"。
7. is_public：固定 true。

以下為字幕內容：
${segText}
`;
    }else{
      throw new Error('未知 kind：'+kind);
    }

    const body = {
      model,
      messages:[
        { role:'system', content:'你是 BookWide 英語學習平台的內容產生助手，請嚴格依照指定的 JSON 結構輸出，不要加解說文字。' },
        { role:'user', content:userPrompt }
      ],
      temperature:0.4
    };

    try{
      const res = await fetch('https://api.openai.com/v1/chat/completions',{
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'Authorization':'Bearer ' + key
        },
        body:JSON.stringify(body)
      });
      if(!res.ok){
        const t = await res.text();
        throw new Error('API 錯誤：'+res.status+' '+t);
      }
      const data = await res.json();
      const text = data.choices?.[0]?.message?.content || '';
      const pretty = cleanupJsonFromGPT(text);

      // 建立下載
      if(state[kind.toLowerCase()].url){
        URL.revokeObjectURL(state[kind.toLowerCase()].url);
      }
      const blob = new Blob([pretty], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      state[kind.toLowerCase()].json = pretty;
      state[kind.toLowerCase()].url  = url;

      const hidden = $('#hiddenDownload');
      hidden.href = url;
      hidden.download = fileName;
      hidden.click();

      btnDown.disabled = false;
      statusEl.textContent = '✅ 已完成並下載：' + fileName + '。如需重下可按右邊的下載按鈕。';
    }catch(err){
      console.error(err);
      statusEl.textContent = '⚠️ 產生失敗：' + (err.message || err);
    }finally{
      btnGen.disabled = false;
    }
  }

  // --------------- 綁定按鈕 ---------------
  $('#btnGenCues').addEventListener('click', ()=>callGPT('Cues'));
  $('#btnGenQuiz').addEventListener('click', ()=>callGPT('Quiz'));
  $('#btnGenVocab').addEventListener('click',()=>callGPT('Vocab'));
  $('#btnGenAi').addEventListener('click',   ()=>callGPT('Ai'));
  $('#btnGenIndex').addEventListener('click',()=>callGPT('Index'));

  function setupDownloadBtn(kind){
    const btn = $('#btnDown'+kind);
    btn.addEventListener('click', ()=>{
      const s = state[kind.toLowerCase()];
      if(!s || !s.url){
        alert('尚未產生 ' + kind + ' JSON。請先按左邊的 GPT 按鈕。');
        return;
      }
      const hidden = $('#hiddenDownload');
      hidden.href = s.url;
      hidden.download = $('#file'+kind).textContent;
      hidden.click();
    });
  }
  ['Cues','Quiz','Vocab','Ai','Index'].forEach(setupDownloadBtn);
</script>
</body>
</html>


