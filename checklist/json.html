<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin｜JSON 產生器</title>
  <style>
    :root{
      --bg:#f4f6fb;
      --card-bg:#fff;
      --muted:#6b7280;
      --border:#e5e7eb;
      --brand:#2563eb;
      --brand-soft:#e0edff;
      --danger:#b91c1c;
      --radius-lg:18px;
      --shadow-card:0 10px 30px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,
        "Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      background:var(--bg);
      color:#111827;
    }
    .wrap{max-width:1080px;margin:24px auto 80px;padding:0 16px;}
    header{
      display:flex;align-items:center;justify-content:space-between;
      margin-bottom:18px;
    }
    .title-block h1{
      margin:0;font-size:22px;font-weight:700;
    }
    .title-block p{
      margin:4px 0 0;font-size:13px;color:var(--muted);
    }
    .admin-badge{font-size:13px;color:var(--muted);}
    .back-btn{
      display:inline-flex;align-items:center;gap:.35rem;
      padding:6px 10px;border-radius:999px;
      background:#eef2ff;color:#1e40af;
      text-decoration:none;font-size:13px;
      border:1px solid #c7d2fe;
      margin-bottom:10px;
    }
    .tabs{
      display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;
    }
    .tab{
      padding:8px 18px;border-radius:999px;
      border:1px solid var(--border);
      font-size:13px;background:#fff;color:#111827;
      cursor:pointer;text-decoration:none;
    }
    .tab.active{
      background:var(--brand);border-color:var(--brand);
      color:#fff;
    }
    .card{
      background:var(--card-bg);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-card);
      padding:20px 18px;
      margin-bottom:18px;
    }
    h2{margin:0 0 10px;font-size:17px;}
    .sub{margin:0 0 14px;font-size:13px;color:var(--muted);}
    .row{margin-bottom:10px;}
    .row label{display:block;font-size:13px;margin-bottom:4px;}
    .ipt,.sel{
      width:100%;padding:9px 11px;border-radius:10px;
      border:1px solid var(--border);font-size:14px;
    }
    .file{
      font-size:13px;
    }
    .btn-row{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;}
    .btn{
      border-radius:999px;border:1px solid var(--brand);
      background:var(--brand);color:#fff;
      padding:8px 18px;font-size:13px;cursor:pointer;
    }
    .btn.ghost{
      background:#fff;color:var(--brand);border-style:solid;
    }
    .hint{font-size:12px;color:var(--muted);margin-top:6px;}
    .note-list{font-size:12px;color:var(--muted);margin:6px 0 0;padding-left:18px;}
  </style>
</head>
<body>
  <div class="wrap">
    <a href="../admin.html" class="back-btn">← 回主控台索引</a>

    <header>
      <div class="title-block">
        <h1>BookWide Admin｜JSON 產生器</h1>
        <p>由 SRT 產生 cues / quiz / vocab / ai / index JSON 檔。</p>
      </div>
      <div class="admin-badge">
        管理員：<span id="adminEmail">—</span>
      </div>
    </header>

    <div class="tabs">
      <a href="./change.html#mp4" class="tab">MP4 整理</a>
      <button class="tab active" type="button">JSON 產生器</button>
    </div>

    <!-- 基本資料：category + slug -->
    <section class="card">
      <h2>基本資料</h2>
      <p class="sub">這裡的分類 / 片名 slug，會用來決定輸出的檔名與路徑。</p>

      <div class="row">
        <label for="category">分類（category）</label>
        <select id="category" class="sel">
          <option value="story">story</option>
          <option value="music">music</option>
          <option value="movie">movie</option>
          <option value="news">news</option>
          <option value="pro">pro</option>
        </select>
      </div>

      <div class="row">
        <label for="slug">片名（slug）例如：mid-autumn / houyi / alittlelove…</label>
        <input id="slug" class="ipt" placeholder="請輸入 slug，例如：applesong" />
      </div>
      <p class="hint">
        之後產生的檔名會是：<br>
        <code>cues-片名.json、quiz-片名.json、vocab-片名.json、ai-片名.json、index-片名.json</code>
      </p>
    </section>

    <!-- 2. JSON 產生器 -->
    <section class="card">
      <h2>2. JSON 產生器（由 SRT → cues.json ＋ 範本檔）</h2>
      <p class="sub">
        目前只會讀取「英文 SRT 字幕」產生 <code>cues-*.json</code>，
        其它語言欄位（zh / ja）可之後手動補上。
      </p>

      <div class="row">
        <label for="srtFile">上傳英文 SRT 檔</label>
        <input id="srtFile" type="file" class="file" accept=".srt,.txt" />
        <p class="hint">
          只會使用每段字幕的「起始時間」與英文內容；編號及結束時間會忽略。
        </p>
      </div>

      <div class="btn-row">
        <button id="btnCues" class="btn">產生並下載 cues-*.json</button>
        <button id="btnQuizTpl" class="btn ghost">下載 quiz-*.json 範本</button>
        <button id="btnVocabTpl" class="btn ghost">下載 vocab-*.json 範本</button>
        <button id="btnAiTpl" class="btn ghost">下載 ai-*.json 範本</button>
        <button id="btnIndexTpl" class="btn ghost">下載 index-*.json 範本（自動組路徑）</button>
      </div>

      <ul class="note-list">
        <li>所有檔案建議放在：<code>data/分類/</code> 之下，例如：<code>data/story/cues-houyi.json</code>。</li>
        <li>index-*.json 會自動寫好 cues / quiz / vocab / ai 的相對路徑，你只要微調標題即可。</li>
      </ul>
    </section>
  </div>

  <script type="module">
    // 等 supa.js 準備好（和 user.html 的寫法一樣）
    const ready = () => new Promise(r=>{
      if (window.BW && window.BW.supa) return r();
      const t = setInterval(()=>{
        if (window.BW && window.BW.supa){
          clearInterval(t); r();
        }
      },50);
    });

    await ready();
    await BW.requireAdmin();     // 只允許 admin 使用這頁
    BW.startHeartbeat(2);        // 2 分鐘更新 last_seen_at

    const supa = BW.supa;
    const $ = (q,root=document)=>root.querySelector(q);

    // 顯示目前管理員 email
    try{
      const { data:{user} } = await supa.auth.getUser();
      if(user?.email) $('#adminEmail').textContent = user.email;
    }catch(_){}

    // 工具：下載 JSON
    function downloadJSON(data, filename){
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function getBaseInfo(){
      const category = $('#category').value.trim();
      const slug = ($('#slug').value || '').trim();
      if(!slug){
        alert('請先輸入片名 slug，例如 applesong'); 
        throw new Error('no-slug');
      }
      return { category, slug };
    }

    // 解析 SRT → cues 陣列（只取起始時間 + 英文）
    function parseSrtToCues(text){
      const blocks = text.replace(/\r\n/g,"\n").split(/\n{2,}/);
      const cues = [];

      function toMMSS(t){
        // 00:01:23,456 → 01:23
        const [h,m,sms] = t.split(':');
        const s = (sms || '0').split(',')[0];
        return String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
      }

      for(const block of blocks){
        const lines = block.split('\n').filter(x=>x.trim()!=='');
        if(lines.length < 2) continue;

        let timeLineIdx = lines.findIndex(l=>l.includes('-->'));
        if(timeLineIdx === -1) continue;

        const timeLine = lines[timeLineIdx];
        const m = timeLine.match(/(\d{2}:\d{2}:\d{2},\d{1,3})\s*-->/);
        if(!m) continue;
        const start = toMMSS(m[1]);

        const textLines = lines.slice(timeLineIdx+1);
        if(!textLines.length) continue;

        const en = textLines.join(' ').replace(/\s+/g,' ').trim();
        if(!en) continue;

        cues.push({
          time: start,
          en,
          zh: "",
          ja: ""
        });
      }
      return cues;
    }

    // 產生 cues-*.json
    $('#btnCues').addEventListener('click', async ()=>{
      let file = $('#srtFile').files[0];
      if(!file){
        alert('請先選擇一個英文 SRT 檔。');
        return;
      }
      let text = await file.text();
      const cues = parseSrtToCues(text);
      if(!cues.length){
        alert('解析不到任何字幕，請檢查 SRT 格式。');
        return;
      }
      try{
        const { category, slug } = getBaseInfo();
        downloadJSON(cues, `cues-${slug}.json`);
      }catch(e){}
    });

    // quiz / vocab / ai 範本（空架構，方便你再填內容）
    $('#btnQuizTpl').addEventListener('click', ()=>{
      try{
        const { slug } = getBaseInfo();
        const quiz = [
          {
            section: "A",
            type: "single",
            time: "00:00",
            question: `Sample question for ${slug}`,
            options: ["(A) option 1","(B) option 2","(C) option 3","(D) option 4"],
            answer: "A",
            explanation: ""
          }
        ];
        downloadJSON(quiz, `quiz-${slug}.json`);
      }catch(e){}
    });

    $('#btnVocabTpl').addEventListener('click', ()=>{
      try{
        const { category, slug } = getBaseInfo();
        const vocab = [
          {
            time: "00:00",
            clip_start: "00:00.0",
            clip_end: "00:04.0",
            word: "sample",
            pos: "n.",
            zh: "",
            en: "",
            en_example: "",
            zh_example: "",
            ja: "",
            ja_example: "",
            img: `assets/${category}/${slug}/sample.jpg`
          }
        ];
        downloadJSON(vocab, `vocab-${slug}.json`);
      }catch(e){}
    });

    $('#btnAiTpl').addEventListener('click', ()=>{
      try{
        const { slug } = getBaseInfo();
        const ai = {
          topics: [
            {
              title: `Topic about ${slug}`,
              prompt: `Write a few sentences related to ${slug}.`,
              hint: "2-3 sentences",
              sample: ""
            }
          ]
        };
        downloadJSON(ai, `ai-${slug}.json`);
      }catch(e){}
    });

    // 自動產生 index-*.json 範本
    $('#btnIndexTpl').addEventListener('click', ()=>{
      try{
        const { category, slug } = getBaseInfo();
        const index = {
          category,
          slug,
          title: slug,
          difficulty_level: 1,
          duration_sec: 0,
          video: `videos/${category}/${slug}.mp4`,
          cover: `assets/${category}/${slug}.jpg`,
          cues: `data/${category}/cues-${slug}.json`,
          quiz: `data/${category}/quiz-${slug}.json`,
          vocab: `data/${category}/vocab-${slug}.json`,
          ai: `data/${category}/ai-${slug}.json`,
          is_public: true
        };
        downloadJSON(index, `index-${slug}.json`);
      }catch(e){}
    });
  </script>
  <script type="module" src="../supa.js?v=20251109g"></script>
</body>
</html>
