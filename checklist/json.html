<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Adminï½œJSON ç”¢ç”Ÿå™¨</title>
  <style>
    :root{
      --bg:#f4f6fb;
      --card-bg:#fff;
      --muted:#6b7280;
      --border:#e5e7eb;
      --brand:#2563eb;
      --brand-soft:#e0edff;
      --danger:#b91c1c;
      --radius-lg:18px;
      --shadow-card:0 12px 30px rgba(15,23,42,.10);
      --mono:"JetBrains Mono","Cascadia Code","SF Mono",ui-monospace,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans TC","Microsoft JhengHei",sans-serif;
      background:var(--bg);
      color:#111827;
    }
    .wrap{
      max-width:1120px;
      margin:24px auto 80px;
      padding:0 16px;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:18px;
      gap:12px;
    }
    .logo{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:700;
      font-size:20px;
    }
    .logo-badge{
      width:30px;height:30px;
      border-radius:999px;
      background:linear-gradient(135deg,#6366f1,#22c55e);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-size:17px;
      box-shadow:0 8px 20px rgba(30,64,175,.4);
    }
    .small{font-size:13px;color:var(--muted);}
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:var(--brand-soft);
      color:#1e40af;
      font-size:12px;
    }
    .tag-dot{
      width:7px;height:7px;border-radius:999px;background:#22c55e;
    }

    main{
      display:grid;
      grid-template-columns:minmax(0,1.8fr) minmax(0,1.6fr);
      gap:20px;
    }
    @media (max-width:900px){
      main{grid-template-columns:1fr;}
    }

    .card{
      background:var(--card-bg);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-card);
      padding:18px 18px 22px;
      border:1px solid #e0e7ff;
    }
    h1{
      margin:0 0 8px;
      font-size:20px;
    }
    h2{
      margin:0 0 10px;
      font-size:17px;
    }
    h3{
      margin:18px 0 8px;
      font-size:15px;
    }
    .tagline{
      font-size:13px;
      color:var(--muted);
      margin-bottom:10px;
    }

    label{font-size:14px;font-weight:500;}
    input[type="text"], textarea, select{
      font-family:inherit;
      font-size:14px;
      width:100%;
      padding:7px 9px;
      border-radius:10px;
      border:1px solid var(--border);
      outline:none;
      transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
      background:#f9fafb;
    }
    textarea{
      resize:vertical;
      min-height:120px;
      font-family:var(--mono);
      font-size:13px;
      line-height:1.5;
    }
    input[type="text"]:focus, textarea:focus, select:focus{
      border-color:#3b82f6;
      box-shadow:0 0 0 1px rgba(59,130,246,.35);
      background:#fff;
    }

    .field-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px 16px;
      margin-bottom:10px;
    }
    .field-row > div{flex:1 1 160px;min-width:0;}
    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }

    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
      align-items:center;
    }
    .btn{
      border:none;
      border-radius:999px;
      padding:7px 14px;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      transition:transform .08s ease, box-shadow .08s ease, background .12s ease;
      white-space:nowrap;
    }
    .btn-primary{
      background:#2563eb;
      color:#fff;
      box-shadow:0 8px 20px rgba(37,99,235,.28);
    }
    .btn-primary:hover{
      transform:translateY(-1px);
      box-shadow:0 10px 24px rgba(37,99,235,.32);
      background:#1d4ed8;
    }
    .btn-ghost{
      background:#e5edff;
      color:#1e40af;
    }
    .btn-ghost:hover{
      background:#dbeafe;
    }
    .btn-sm{
      padding:4px 9px;
      font-size:12px;
    }
    .btn:disabled{
      opacity:.55;
      cursor:default;
      transform:none;
      box-shadow:none;
    }

    .block{
      border-top:1px dashed #e5e7eb;
      padding-top:12px;
      margin-top:10px;
    }

    .preview{
      background:#020617;
      color:#e5e7eb;
      border-radius:12px;
      padding:10px 12px;
      margin-top:8px;
      font-family:var(--mono);
      font-size:12px;
      line-height:1.5;
      border:1px solid #1e293b;
      max-height:220px;
      overflow:auto;
    }
    .preview strong{color:#7dd3fc;}

    .status{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }
    .status.ok{color:#15803d;}
    .status.err{color:#b91c1c;}

    .pill-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:6px;
    }
    .pill{
      padding:2px 8px;
      border-radius:999px;
      border:1px solid #c7d2fe;
      background:#eef2ff;
      font-size:11px;
      color:#1e3a8a;
    }
    .pill strong{font-weight:600;}

    code{
      font-family:var(--mono);
      font-size:12px;
      background:#e5e7eb;
      border-radius:4px;
      padding:1px 4px;
    }

    .mono{font-family:var(--mono);font-size:12px;}

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:#111827;
      color:#f9fafb;
      padding:8px 14px;
      border-radius:999px;
      font-size:12px;
      box-shadow:0 8px 20px rgba(15,23,42,.4);
      opacity:0;pointer-events:none;
      transition:opacity .2s ease,transform .2s ease;
      z-index:50;
    }
    .toast.show{
      opacity:1;pointer-events:auto;
      transform:translateX(-50%) translateY(-4px);
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:11px;
      padding:2px 7px;
      border-radius:999px;
      background:#ecfdf5;
      color:#166534;
      border:1px solid #6ee7b7;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="logo">
          <span class="logo-badge">B</span>
          <span>BookWide Adminï½œJSON ç”¢ç”Ÿå™¨</span>
        </div>
        <div class="small">
          æŠŠä¸€æ”¯å½±ç‰‡çš„ SRT ä¸Ÿé€²ä¾† â†’ ç”¨ GPT å¹«ä½ ç”Ÿå‡º <code>cues / quiz / vocab / ai / index</code> äº”ç¨® JSONã€‚
        </div>
      </div>
      <div class="tag">
        <span class="tag-dot"></span>
        checklist / JSON å·¥å…·
      </div>
    </header>

    <main>
      <!-- å·¦å´ï¼šè¨­å®š + è§£æ SRT -->
      <section class="card">
        <h1>1. ä¸Šå‚³ SRT æª”ï¼Œå…ˆè§£ææˆè‹±æ–‡é€è¡Œ</h1>
        <div class="tagline">
          ç›®å‰åªæ”¯æ´è‹±æ–‡å­—å¹• SRTï¼Œä¹‹å¾Œäº¤çµ¦ GPT ç”¢ç”Ÿä¸­ / æ—¥ç¿»è­¯èˆ‡ JSON çµæ§‹ã€‚
        </div>

        <div class="field-row">
          <div>
            <label for="apiKey">OpenAI API Key</label>
            <div style="display:flex;gap:6px;align-items:center;">
              <input id="apiKey" type="text" placeholder="sk-..." />
              <button id="toggleKey" type="button" class="btn btn-sm btn-ghost">é¡¯ç¤º</button>
            </div>
            <div class="hint">æ­¤ Key åªå­˜æ–¼ç€è¦½å™¨çš„ localStorageï¼Œä¸æœƒä¸Šå‚³åˆ°ä¼ºæœå™¨ã€‚</div>
          </div>
          <div>
            <label for="model">æ¨¡å‹ï¼ˆé è¨­ gpt-4.1-miniï¼‰</label>
            <select id="model">
              <option value="gpt-4.1-mini" selected>gpt-4.1-mini</option>
              <option value="gpt-4.1">gpt-4.1</option>
            </select>
            <div class="hint">è‹¥è¦çœ Token è²»ç”¨ï¼Œç¶­æŒ mini å³å¯ã€‚</div>
          </div>
        </div>

        <div class="field-row">
          <div>
            <label for="slug">å½±ç‰‡ slugï¼ˆè‹±æ–‡æª”åï¼‰</label>
            <input id="slug" type="text" placeholder="ä¾‹å¦‚ï¼šone-way-ticket" />
            <div class="hint">æ‰€æœ‰ JSON æœƒç”¨é€™å€‹ slug ç•¶æª”åå¾Œç¶´ï¼Œä¾‹å¦‚ï¼š<code>cues-one-way-ticket.json</code>ã€‚</div>
          </div>
          <div>
            <label>å½±ç‰‡åˆ†é¡ category</label>
            <select id="category">
              <option value="story">story</option>
              <option value="music">music</option>
              <option value="movie">movie</option>
              <option value="news" selected>news</option>
              <option value="pro">pro</option>
            </select>
            <div class="hint">ç”¨åœ¨ <code>data/{category}/{slug}/...</code> èˆ‡ index.jsonã€‚</div>
          </div>
        </div>

        <h2 style="margin-top:16px;">ä¸Šå‚³ SRT æª”ä¸¦è§£æ</h2>
        <div class="tagline">ç›®å‰åªæ”¯æ´å–®ä¸€ SRT æª”ï¼ŒåŒ…å«å®Œæ•´å½±ç‰‡çš„è‹±æ–‡å­—å¹•ã€‚</div>

        <div class="field-row" style="align-items:flex-end;">
          <div>
            <label for="srtFile">é¸æ“‡ SRT æª”æ¡ˆ</label>
            <input id="srtFile" type="file" accept=".srt" />
          </div>
          <div>
            <button class="btn btn-primary" id="btnParseSrt" type="button">è§£æ SRT</button>
          </div>
        </div>
        <button class="btn btn-ghost" id="btnReparse" type="button">é‡æ–°è§£æ SRT</button>
        <div class="hint">ä¸‹æ–¹æœƒé¡¯ç¤ºå·²è§£æçš„å¹¾è¡Œé è¦½ï¼ˆæ™‚é–“ â†’ è‹±æ–‡å°è©ï¼‰ã€‚</div>
        <pre id="srtPreview" class="preview">å°šæœªè¼‰å…¥ SRT æª”ã€‚</pre>
      </section>

      <!-- 2. JSON ç”¢ç”Ÿå™¨ -->
      <section class="card">
        <div class="tagline">2. ä½¿ç”¨ GPT ç”¢ç”Ÿ JSONï¼ˆä¸€æ¬¡ä¸€å€‹æª”ï¼‰</div>

        <!-- cues -->
        <div class="block">
        <h3>2.1 å¤šèªå­—å¹• cues JSON</h3>
        <div class="field-block" style="margin:10px 0 6px;">
          <label style="font-weight:600;display:block;margin-bottom:4px;">å½±ç‰‡ä¾†æºï¼ˆYouTube URLï¼Œå¯ç•™ç©ºï¼‰</label>
          <input
            id="videoSourceInput"
            type="text"
            placeholder="https://www.youtube.com/watch?v=xxxxxxx"
            style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:10px;font-size:14px;"
          />
          <div style="font-size:12px;color:var(--muted);margin-top:4px;">
            è‹¥æœ‰å¡«å¯«ï¼Œå°‡ä¸€ä½µå¯«å…¥ <code>cues-*.json</code> çš„ <code>source_url</code> æ¬„ä½ã€‚
          </div>
        </div>
        <div class="file-label">è¼¸å‡ºæª”åï¼š<code id="nameCues">cues-.json</code></div>
        <div class="btn-row">
          <button class="btn btn-primary" type="button" onclick="handleGenerate('cues')">
            â‘  ç”¨ GPT ç”¢ç”Ÿ cues JSON
          </button>
          <button class="btn btn-ghost" type="button" id="btnGenerateAll" onclick="handleGenerateAll()">
            ä¸€éµç”¢ç”Ÿå…¨éƒ¨ JSON
          </button>
        </div>
        <div class="status" id="status-cues">å°šæœªç”¢ç”Ÿã€‚</div>
        <div class="btn-row">
          <button class="btn btn-sm btn-ghost" id="downloadCues" type="button" disabled>ä¸‹è¼‰ cues-*.json</button>
          <span class="badge"><span>ğŸ”</span><span>æœƒåŒ…å«è‹± / ä¸­ / æ—¥ä¸‰èªå­—å¹•</span></span>
        </div>
      </div>

        <!-- quiz -->
        <div class="block">
          <h3>2.2 æ¸¬é©— quiz JSON</h3>
          <div class="file-label">è¼¸å‡ºæª”åï¼š<code id="nameQuiz">quiz-.json</code></div>
          <div class="tagline">
            Level 1ï¼šæ¯é¡Œ 5 é¡Œ Ã— 4 é¡ = 20 é¡Œ<br/>
            vocab / AI æœƒéœ€è¦ç­‰ quiz å®Œæˆå¾Œå†ç”¢ç”Ÿã€‚
          </div>
          <div class="btn-row">
            <button class="btn btn-primary" type="button" onclick="handleGenerate('quiz')">
              ç”¨ GPT ç”¢ç”Ÿ quiz JSON
            </button>
          </div>
          <div class="status" id="status-quiz">å°šæœªç”¢ç”Ÿã€‚</div>
          <div class="btn-row">
            <button class="btn btn-sm btn-ghost" id="downloadQuiz" type="button" disabled>ä¸‹è¼‰ quiz-*.json</button>
          </div>
        </div>

        <!-- vocab -->
        <div class="block">
          <h3>2.3 å­—å½™ vocab JSON</h3>
          <div class="file-label">è¼¸å‡ºæª”åï¼š<code id="nameVocab">vocab-.json</code></div>
          <div class="btn-row">
            <button class="btn btn-primary" type="button" onclick="handleGenerate('vocab')">
              ç”¨ GPT ç”¢ç”Ÿ vocab JSON
            </button>
          </div>
          <div class="status" id="status-vocab">å°šæœªç”¢ç”Ÿã€‚</div>
          <div class="btn-row">
            <button class="btn btn-sm btn-ghost" id="downloadVocab" type="button" disabled>ä¸‹è¼‰ vocab-*.json</button>
          </div>
        </div>

        <!-- ai -->
        <div class="block">
          <h3>2.4 AI äº’å‹•è…³æœ¬ ai JSON</h3>
          <div class="file-label">è¼¸å‡ºæª”åï¼š<code id="nameAi">ai-.json</code></div>
          <div class="btn-row">
            <button class="btn btn-primary" type="button" onclick="handleGenerate('ai')">
              ç”¨ GPT ç”¢ç”Ÿ ai JSON
            </button>
          </div>
          <div class="status" id="status-ai">å°šæœªç”¢ç”Ÿã€‚</div>
          <div class="btn-row">
            <button class="btn btn-sm btn-ghost" id="downloadAi" type="button" disabled>ä¸‹è¼‰ ai-*.json</button>
          </div>
        </div>

        <!-- index -->
        <div class="block">
          <h3>2.5 å–®æ”¯å½±ç‰‡ index JSON</h3>
          <div class="file-label">è¼¸å‡ºæª”åï¼š<code id="nameIndex">index-one-way-ticket.json</code></div>
          <div class="tagline">çµ¦ <code>data/{category}/index-*.json</code> ä½¿ç”¨ï¼ˆå–®æ”¯å½±ç‰‡æ¢ç›®ï¼‰ã€‚</div>
          <div class="btn-row">
            <button class="btn btn-primary" type="button" onclick="handleGenerate('index')">
              ç”¨ GPT ç”¢ç”Ÿ index JSON
            </button>
          </div>
          <div class="status" id="status-index">å°šæœªç”¢ç”Ÿã€‚</div>
          <div class="btn-row">
            <button class="btn btn-sm btn-ghost" id="downloadIndex" type="button" disabled>ä¸‹è¼‰ index-*.json</button>
          </div>
        </div>
      </section>

      <!-- å³å´ï¼šæç¤ºèˆ‡åŸå§‹ JSON é è¦½ -->
      <section class="card">
        <h2>3. GPT æç¤ºè©ï¼ˆPromptï¼‰èˆ‡çµæœé è¦½</h2>
        <div class="tagline">åªé¡¯ç¤ºæœ€å¾Œä¸€æ¬¡å‘¼å« GPT çš„çµæœï¼ˆé¿å…é é¢å¤ªé•·ï¼‰ã€‚</div>

        <div class="pill-row">
          <span class="pill"><strong>cues</strong>ï¼šå­—å¹•ä¸‰èªå°ç…§ï¼ˆå«æ™‚é–“ï¼‰</span>
          <span class="pill"><strong>quiz</strong>ï¼šå››é¡é¡Œç›®ï¼ˆè½åŠ› / å–®å­— / æ–‡æ³• / å£èªªï¼‰</span>
          <span class="pill"><strong>vocab</strong>ï¼šä¾‹å¥ + ä¸‰èªè§£é‡‹</span>
          <span class="pill"><strong>ai</strong>ï¼šæƒ…å¢ƒå°è©±è…³æœ¬</span>
        </div>

        <div class="field-row">
          <div>
            <label for="promptPreview">æœ€å¾Œä¸€æ¬¡ä½¿ç”¨çš„ Prompt</label>
            <textarea id="promptPreview" readonly></textarea>
          </div>
        </div>

        <div class="field-row">
          <div>
            <label for="jsonPreview">GPT å›å‚³ JSON é è¦½</label>
            <textarea id="jsonPreview" readonly></textarea>
            <div class="hint">å¦‚æœæ ¼å¼æœ‰å•é¡Œï¼Œå¯ä»¥åœ¨é€™è£¡æ‰‹å‹•ä¿®æ”¹ï¼Œå†è¤‡è£½å‡ºå»ç”¨ã€‚</div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // è§£æå¾Œçš„ SRT æ®µè½ï¼š[{time:"00:12", text:"I'm fine."}, ...]
    let srtSegments = [];
    const savedJson = { cues:null, quiz:null, vocab:null, ai:null, index:null };
    const $ = (q) => document.querySelector(q);

    // --- OpenAI API Key localStorage + é¡¯ç¤º/éš±è— ---
    const apiKeyInput = $('#apiKey');
    const toggleKeyBtn = $('#toggleKey');

    if (apiKeyInput) {
      const savedKey = localStorage.getItem('bw_json_api_key') || '';
      if (savedKey) apiKeyInput.value = savedKey;
      apiKeyInput.addEventListener('input', () => {
        localStorage.setItem('bw_json_api_key', apiKeyInput.value.trim());
      });
    }
    if (toggleKeyBtn && apiKeyInput) {
      toggleKeyBtn.addEventListener('click', () => {
        const type = apiKeyInput.getAttribute('type') === 'password' ? 'text' : 'password';
        apiKeyInput.setAttribute('type', type);
        toggleKeyBtn.textContent = type === 'password' ? 'é¡¯ç¤º' : 'éš±è—';
      });
      // é è¨­å…ˆç”¨ password é¡å‹é¡¯ç¤º
      apiKeyInput.setAttribute('type','password');
      toggleKeyBtn.textContent = 'é¡¯ç¤º';
    }

    // --- æ›´æ–°æª”åé¡¯ç¤º ---
    const slugInput = $('#slug');
    const catSel   = $('#category');
    function updateFileNames(){
      const slug = (slugInput.value || '').trim();
      const cat  = catSel.value;
      $('#nameCues').textContent   = slug ? `cues-${slug}.json`  : 'cues-.json';
      $('#nameQuiz').textContent   = slug ? `quiz-${slug}.json`  : 'quiz-.json';
      $('#nameVocab').textContent  = slug ? `vocab-${slug}.json` : 'vocab-.json';
      $('#nameAi').textContent     = slug ? `ai-${slug}.json`    : 'ai-.json';
      $('#nameIndex').textContent  = slug ? `index-${slug}.json` : 'index-.json';
    }
    slugInput.addEventListener('input', updateFileNames);
    catSel.addEventListener('change', updateFileNames);

    // --- è§£æ SRT ---
    function parseSrtText(raw){
      const lines = raw.replace(/\r/g,'').split('\n');
      const segments = [];
      let buffer = { time:'', text:'' };

      function pushSegment(){
        if(buffer.time && buffer.text){
          segments.push({
            time: buffer.time.trim(),
            text: buffer.text.trim()
          });
        }
        buffer = { time:'', text:'' };
      }

      for(let i=0;i<lines.length;i++){
        const line = lines[i].trim();
        if(/^\d+$/.test(line)){
          // index è¡Œï¼šç›´æ¥è·³é
          continue;
        }
        const m = line.match(/(\d{2}:\d{2}:\d{2},\d{3})\s*-->\s*(\d{2}:\d{2}:\d{2},\d{3})/);
        if(m){
          // æ–°çš„ä¸€å¥é–‹å§‹
          if(buffer.time || buffer.text) pushSegment();
          const t = m[1]; // åªä¿ç•™èµ·å§‹æ™‚é–“ï¼ˆ00:00:12,000ï¼‰
          buffer.time = t.substring(0,8); // 00:00:12
        }else if(line === ''){
          // ç©ºè¡Œï¼šçµæŸå‰ä¸€æ®µ
          if(buffer.time || buffer.text) pushSegment();
        }else{
          buffer.text += (buffer.text ? ' ' : '') + line;
        }
      }
      if(buffer.time || buffer.text) pushSegment();

      return segments;
    }

    // --- æŒ‰éˆ•ï¼šè§£æ SRT ---
    const srtFileInput = $('#srtFile');
    const srtPreview = $('#srtPreview');
    $('#btnParseSrt').addEventListener('click', () => {
      const file = srtFileInput.files && srtFileInput.files[0];
      if(!file){ alert('è«‹å…ˆé¸æ“‡ SRT æª”æ¡ˆã€‚'); return; }
      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target.result;
        srtSegments = parseSrtText(text);
        if(!srtSegments.length){
          srtPreview.textContent = 'è§£æå¾Œæ²’æœ‰å–å¾—ä»»ä½•å­—å¹•æ®µè½ï¼Œè«‹ç¢ºèª SRT æ ¼å¼ã€‚';
          return;
        }
        let previewLines = srtSegments.slice(0,12).map(seg => `${seg.time} â†’ ${seg.text}`);
        if(srtSegments.length > 12){
          previewLines.push(`...ï¼ˆå…± ${srtSegments.length} è¡Œå­—å¹•ï¼‰`);
        }
        srtPreview.textContent = previewLines.join('\n');
        showToast('SRT è§£æå®Œæˆ');
      };
      reader.readAsText(file,'utf-8');
    });

    $('#btnReparse').addEventListener('click', () => {
      srtSegments = [];
      srtPreview.textContent = 'å°šæœªè¼‰å…¥ SRT æª”ã€‚';
      showToast('å·²æ¸…é™¤è§£æçµæœï¼Œå¯ä»¥é‡æ–°ä¸Šå‚³ SRTã€‚');
    });

    // --- GPT Chat Payload å»ºæ§‹ ---
    function buildChatPayload(kind, model, slug){
      const baseInstruction = `
ä½ æ˜¯ BookWide çš„å…§å®¹ç·¨è¼¯åŠ©æ‰‹ï¼Œè«‹ä¾ç…§æŒ‡å®šæ ¼å¼ç”¢ç”Ÿ JSONã€‚
æ‰€æœ‰è¼¸å‡ºå¿…é ˆæ˜¯ **åˆæ³• JSON**ï¼Œä¸è¦åŒ…å«è¨»è§£ã€ä¸è¦åŠ å¤šé¤˜éµå€¼ã€‚
`;

      let systemMsg = baseInstruction;
      let userMsg   = '';

      const srtSample = srtSegments.map(s => `${s.time} ${s.text}`).join('\n');

      if(kind === 'cues'){
        systemMsg += `
ä»»å‹™ï¼šæ ¹æ“šæä¾›çš„è‹±æ–‡å­—å¹•ï¼Œç”¢ç”Ÿå¤šèªå­—å¹• JSONã€‚
è¦æ±‚ï¼š
1. ä»¥é™£åˆ—å½¢å¼ï¼Œæ¯å€‹å…ƒç´ ä»£è¡¨ä¸€è¡Œå­—å¹•ã€‚
2. æ¯è¡ŒåŒ…å«ï¼š
   - "time"ï¼šå­—ä¸²ï¼Œä¾‹å¦‚ "00:19"
   - "en"ï¼šè‹±æ–‡åŸæ–‡
   - "zh"ï¼šç¹é«”ä¸­æ–‡ç¿»è­¯
   - "ja"ï¼šæ—¥æ–‡ç¿»è­¯
3. ç¿»è­¯è¦è‡ªç„¶ã€ç¬¦åˆå£èªæƒ…å¢ƒã€‚
4. ä¸è¦åŠ å…¥èªªæ˜æ–‡å­—ï¼Œåªè¼¸å‡º JSON é™£åˆ—ã€‚
        `;
        userMsg = `ä»¥ä¸‹æ˜¯å½±ç‰‡çš„è‹±æ–‡å­—å¹•ï¼ˆæ™‚é–“ + å…§å®¹ï¼‰ï¼Œè«‹ä¾èªªæ˜ç”¢ç”Ÿ cues JSONï¼š
${srtSample}`;
      }
      else if(kind === 'quiz'){
        systemMsg += `
ä»»å‹™ï¼šç‚ºå½±ç‰‡å…§å®¹è¨­è¨ˆæ¸¬é©—é¡Œç›®ï¼Œè¼¸å‡º JSON é™£åˆ—ã€‚
é¡Œå‹åŒ…å«ï¼š
- listeningï¼šè½åŠ›ç†è§£é¸æ“‡é¡Œ
- vocabï¼šå­—å½™é¸æ“‡é¡Œ
- grammarï¼šæ–‡æ³• / å¥å‹é¸æ“‡é¡Œ
- speakingï¼šå£èªªæç¤ºé¡Œï¼ˆæä¾›è‹±æ–‡æç¤ºå¥ï¼Œå­¸ç”Ÿæ¨¡ä»¿èªªï¼‰
åŸºæœ¬è¦å‰‡ï¼š
1. Level 1ï¼šç¸½å…±ç´„ 20 é¡Œï¼Œå››é¡é¡Œå‹å¹³å‡åˆ†é…ã€‚
2. æ¯é¡ŒåŒ…å«ï¼š
   - "id"ï¼šå­—ä¸²ï¼Œä¾‹å¦‚ "q1"
   - "type"ï¼šä¸Šè¿°å››ç¨®é¡å‹ä¹‹ä¸€
   - "time"ï¼šé—œè¯å­—å¹•çš„å¤§æ¦‚æ™‚é–“ï¼ˆä¾‹å¦‚ "00:19"ï¼‰
   - "question_en"ï¼šè‹±æ–‡é¡Œå¹¹
   - "question_zh"ï¼šç¹é«”ä¸­æ–‡é¡Œå¹¹
   - "options"ï¼šè‹¥ç‚ºé¸æ“‡é¡Œï¼Œçµ¦ 3~4 å€‹è‹±æ–‡é¸é …ï¼›å£èªªé¡Œå¯ä»¥æ˜¯ç©ºé™£åˆ—æˆ–çœç•¥
   - "answer"ï¼šæ­£ç¢ºç­”æ¡ˆï¼ˆè‹¥æ˜¯é¸æ“‡é¡Œï¼Œå¡«é¸é …æ–‡å­—ï¼›å£èªªé¡Œå¯å¡«ç¤ºç¯„å¥ï¼‰
3. è«‹ç›¡é‡å¾å­—å¹•å…§å®¹å»¶ä¼¸å‡ºé¡Œï¼Œä¸è¦å®Œå…¨è„«é›¢åŸæ–‡ã€‚
4. åªè¼¸å‡º JSON é™£åˆ—ã€‚
        `;
        userMsg = `ä»¥ä¸‹æ˜¯å½±ç‰‡çš„è‹±æ–‡å­—å¹•ï¼ˆæ™‚é–“ + å…§å®¹ï¼‰ï¼Œè«‹ä¾èªªæ˜ç”¢ç”Ÿ quiz JSONï¼š
${srtSample}`;
      }
      else if(kind === 'vocab'){
        systemMsg += `
ä»»å‹™ï¼šæ ¹æ“šå­—å¹•å…§å®¹ï¼ŒæŒ‘å‡ºé©åˆå­¸ç¿’çš„å–®å­—æˆ–ç‰‡èªï¼Œç”¢ç”Ÿ vocab JSONã€‚
è¦å‰‡ï¼š
1. æ¯å€‹è©å½™ç‰©ä»¶åŒ…å«ï¼š
   - "time"ï¼šèˆ‡è©²è©å½™ç›¸é—œçš„å­—å¹•æ™‚é–“
   - "word"ï¼šå–®å­—æˆ–ç‰‡èªï¼ˆè‹±æ–‡ï¼‰
   - "pos"ï¼šè©æ€§ç°¡å¯«ï¼Œä¾‹å¦‚ "n.", "v.", "phr. v."
   - "zh"ï¼šç¹é«”ä¸­æ–‡è§£é‡‹
   - "en"ï¼šè‹±æ–‡è§£é‡‹ï¼ˆç°¡å–®æ˜“æ‡‚ï¼‰
   - "en_example"ï¼šè‹±æ–‡ä¾‹å¥
   - "zh_example"ï¼šç¹é«”ä¸­æ–‡ä¾‹å¥
   - "ja"ï¼šæ—¥æ–‡å°æ‡‰è©
   - "ja_example"ï¼šæ—¥æ–‡ä¾‹å¥
2. æ¯æ”¯å½±ç‰‡æŒ‘é¸å¤§ç´„ 15~25 å€‹é‡é»å­—å½™æˆ–ç‰‡èªã€‚
3. ä¾‹å¥ç›¡é‡è²¼è¿‘å½±ç‰‡æƒ…å¢ƒã€‚
4. åªè¼¸å‡º JSON é™£åˆ—ã€‚
        `;
        userMsg = `ä»¥ä¸‹æ˜¯å½±ç‰‡çš„è‹±æ–‡å­—å¹•ï¼ˆæ™‚é–“ + å…§å®¹ï¼‰ï¼Œè«‹ä¾èªªæ˜ç”¢ç”Ÿ vocab JSONï¼š
${srtSample}`;
      }
      else if(kind === 'ai'){
        systemMsg += `
ä»»å‹™ï¼šæ ¹æ“šå½±ç‰‡æƒ…å¢ƒï¼Œç”¢ç”Ÿ AI äº’å‹•è…³æœ¬ JSONã€‚
æ ¼å¼ï¼š
[
  {
    "id": "scene1",
    "title": "ç°¡çŸ­æ¨™é¡Œï¼ˆä¸­æ–‡ï¼‰",
    "desc": "æƒ…å¢ƒèªªæ˜ï¼ˆä¸­æ–‡ï¼‰",
    "prompt_en": "çµ¦ GPT çš„è‹±æ–‡æŒ‡ä»¤ï¼Œç”¨ä¾†æ‰®æ¼”é€™å€‹è§’è‰²",
    "prompt_zh": "åŒä¸€ä»½æŒ‡ä»¤çš„ä¸­æ–‡å‚™è¨»ï¼ˆçµ¦è€å¸«çœ‹ï¼‰",
    "sample_questions": [
      "å­¸ç”Ÿå¯èƒ½æœƒå•çš„è‹±æ–‡å•é¡Œ1",
      "å­¸ç”Ÿå¯èƒ½æœƒå•çš„è‹±æ–‡å•é¡Œ2"
    ]
  },
  ...
]
è¦å‰‡ï¼š
1. é‡å°å½±ç‰‡çš„ä¸åŒæƒ…å¢ƒï¼ˆä¾‹å¦‚ï¼šåœ¨å”®ç¥¨äº­ã€åœ¨è»Šä¸Šã€åœ¨é¤å»³ï¼‰æ‹†æˆå¤šå€‹ sceneã€‚
2. æ¯å€‹ scene çš„ prompt_en è¦èƒ½ç›´æ¥çµ¦ GPTï¼Œè®“å®ƒçŸ¥é“å¦‚ä½•å›æ‡‰å­¸ç”Ÿã€‚
3. sample_questions è‡³å°‘çµ¦ 3~4 å€‹ã€‚
4. åªè¼¸å‡º JSON é™£åˆ—ã€‚
        `;
        userMsg = `ä»¥ä¸‹æ˜¯å½±ç‰‡çš„è‹±æ–‡å­—å¹•ï¼ˆæ™‚é–“ + å…§å®¹ï¼‰ï¼Œè«‹ä¾èªªæ˜ç”¢ç”Ÿ ai JSONï¼š
${srtSample}`;
      }
      else if(kind === 'index'){
        const cat  = catSel.value;
        const title = slug.replace(/-/g,' ');
        systemMsg += `
ä»»å‹™ï¼šç‚ºå–®æ”¯å½±ç‰‡ç”¢ç”Ÿä¸€ç­† index JSON æ¢ç›®ã€‚
æ ¼å¼ç‚ºå–®ä¸€ç‰©ä»¶ï¼ŒåŒ…å«ï¼š
- "category": é¡åˆ¥ï¼ˆstory / music / movie / news / proï¼‰
- "slug": æª”å slug
- "title": é¡¯ç¤ºæ¨™é¡Œï¼ˆè‹±æ–‡ï¼‰
- "difficulty_level": æ•¸å­— 1~3ï¼ˆ1 æœ€ç°¡å–®ï¼Œ3 æœ€é›£ï¼‰
- "duration_sec": å½±ç‰‡é•·åº¦ï¼ˆç§’ï¼Œè‹¥ä¸ç¢ºå®šå¯ä¼°ç®—ï¼‰
è«‹åªè¼¸å‡ºå–®ä¸€ JSON ç‰©ä»¶ï¼Œä¸è¦é™£åˆ—ã€‚
        `;
        userMsg = `è«‹å¹«æˆ‘ç‚ºä»¥ä¸‹å½±ç‰‡ç”¢ç”Ÿ index JSONï¼š
category: ${cat}
slug: ${slug}
title: ${title || slug}`;
      }

      return {
        model,
        messages:[
          {role:'system', content:systemMsg},
          {role:'user',   content:userMsg}
        ],
        temperature:0.2
      };
    }

    function getFileName(kind, slug){
      if(!slug) return `${kind}-.json`;
      if(kind === 'index') return `index-${slug}.json`;
      return `${kind}-${slug}.json`;
    }

    // --- å‘¼å« GPT ç”¢ç”Ÿ JSON ---
    async function handleGenerate(kind){
      const apiKey = ($('#apiKey').value || '').trim();
      const model  = $('#model').value;
      const slug   = ($('#slug').value || '').trim();
      if(!apiKey){ alert('è«‹å…ˆè¼¸å…¥ OpenAI API Keyã€‚'); return; }
      if(!slug){ alert('è«‹å…ˆå¡«å¯«ç‰‡å slugï¼ˆç”¨åœ¨æª”åï¼‰ã€‚'); return; }
      if(!srtSegments.length){ alert('è«‹å…ˆä¸Šå‚³ä¸¦è§£æ SRT æª”ã€‚'); return; }

      const statusEl = $(`#status-${kind}`);
      statusEl.textContent = 'å‘¼å« GPT ç”¢ç”Ÿä¸­â€¦';
      statusEl.className = 'status';

      try{
        const payload = buildChatPayload(kind, model, slug);
        const res = await fetch('https://api.openai.com/v1/chat/completions',{
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Authorization':`Bearer ${apiKey}`
          },
          body:JSON.stringify(payload)
        });
        if(!res.ok){
          const errTxt = await res.text();
          throw new Error(`API éŒ¯èª¤ï¼š${res.status} ${errTxt}`);
        }
        const data = await res.json();
        const content = data.choices?.[0]?.message?.content || '';
        $('#promptPreview').value = payload.messages.map(m => `# ${m.role}\n${m.content}`).join('\n\n');

        // å˜—è©¦å¾ content ä¸­æŠ½å– JSON å€å¡Š
        let text = content.trim();
        const m = text.match(/```(?:json)?\s*([\s\S]*?)```/i);
        if(m && m[1]) text = m[1].trim();

        let obj = null;
        try{ obj = JSON.parse(text); }
        catch(e){
          console.error('JSON parse fail, raw text:', text);
          throw new Error('GPT å›å‚³çš„å…§å®¹ä¸æ˜¯åˆæ³• JSONï¼Œè«‹é‡è©¦æˆ–æ‰‹å‹•èª¿æ•´æç¤ºã€‚');
        }

        // è‹¥æ˜¯å­—å¹•æª”ï¼Œå¯«å…¥å½±ç‰‡ä¾†æºï¼ˆYouTube é€£çµï¼‰
        if (kind === 'cues') {
          const srcInput = document.getElementById('videoSourceInput');
          const src = srcInput ? (srcInput.value || '').trim() : '';
          if (src) {
            // åœ¨æœ€å¤–å±¤åŠ ä¸€å€‹æ¬„ä½ï¼Œæ–¹ä¾¿æ’­æ”¾å™¨æˆ–å¾Œç«¯å¼•ç”¨
            obj.source_url = src;
          }
        }

        savedJson[kind] = obj;
        const fileName = getFileName(kind, slug);
        triggerDownload(JSON.stringify(obj,null,2), fileName);
        $(`#download${cap(kind)}`).disabled = false;
        statusEl.textContent = `å·²å®Œæˆä¸¦ä¸‹è¼‰ ${fileName}ã€‚`;
        statusEl.className = 'status ok';
        $('#jsonPreview').value = JSON.stringify(obj,null,2);
        showToast(`å·²ä¸‹è¼‰ ${fileName}`);
      }catch(err){
        console.error(err);
        statusEl.textContent = `ç™¼ç”ŸéŒ¯èª¤ï¼š${err.message}`;
        statusEl.className = 'status err';
        showToast('ç”¢ç”Ÿ JSON æ™‚ç™¼ç”ŸéŒ¯èª¤');
      }
    }

    function cap(s){return s.charAt(0).toUpperCase()+s.slice(1);}

    function triggerDownload(text, filename){
      const blob = new Blob([text],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // --- ä¸‹è¼‰æŒ‰éˆ•ï¼ˆä½¿ç”¨å·²å„²å­˜çš„ savedJsonï¼‰ ---
    function setupDownloadButtons(){
      const kinds = ['cues','quiz','vocab','ai','index'];
      kinds.forEach(kind => {
        const btn = document.getElementById(`download${cap(kind)}`);
        if(!btn) return;
        btn.addEventListener('click', () => {
          const slug = ($('#slug').value || '').trim();
          if(!slug){ alert('è«‹å…ˆå¡«å¯« slugã€‚'); return; }
          const obj = savedJson[kind];
          if(!obj){ alert(`å°šæœªç”¢ç”Ÿ ${kind} JSONã€‚`); return; }
          const fileName = getFileName(kind, slug);
          triggerDownload(JSON.stringify(obj,null,2), fileName);
        });
      });
    }
    setupDownloadButtons();

    // --- ä¸€éµç”¢ç”Ÿå…¨éƒ¨ JSON ---
    let generatingAll = false;
    async function handleGenerateAll(){
      if(generatingAll) return;
      const apiKey = ($('#apiKey').value || '').trim();
      const slug   = ($('#slug').value || '').trim();
      if(!apiKey){ alert('è«‹å…ˆè¼¸å…¥ OpenAI API Keyã€‚'); return; }
      if(!slug){ alert('è«‹å…ˆå¡«å¯«ç‰‡å slugï¼ˆç”¨åœ¨æª”åï¼‰ã€‚'); return; }
      if(!srtSegments.length){ alert('è«‹å…ˆä¸Šå‚³ä¸¦è§£æ SRT æª”ã€‚'); return; }

      const btnAll = document.getElementById('btnGenerateAll');
      const btnLabel = btnAll ? btnAll.textContent : '';
      generatingAll = true;
      if(btnAll) btnAll.textContent = 'å…¨éƒ¨ç”¢ç”Ÿä¸­â€¦';

      const order = ['cues','quiz','vocab','ai','index'];
      for(const kind of order){
        const statusEl = document.getElementById(`status-${kind}`);
        statusEl.textContent = 'æ’éšŠç”¢ç”Ÿä¸­â€¦';
      }

      for(const kind of order){
        await handleGenerate(kind);
      }

      generatingAll = false;
      if(btnAll) btnAll.textContent = btnLabel || 'ä¸€éµç”¢ç”Ÿå…¨éƒ¨ JSON';
    }

    let toastTimer = null;
    function showToast(msg){
      const el = $('#toast');
      el.textContent = msg;
      el.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>el.classList.remove('show'), 2600);
    }
  </script>
</body>
</html>










