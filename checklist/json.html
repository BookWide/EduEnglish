<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin｜JSON 產生器</title>
  <style>
    :root{
      --bg:#f4f6fb;
      --card-bg:#fff;
      --muted:#6b7280;
      --border:#e5e7eb;
      --brand:#2563eb;
      --brand-soft:#e0edff;
      --danger:#b91c1c;
      --radius-lg:18px;
      --shadow-card:0 10px 30px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Noto Sans TC",sans-serif;
      background:var(--bg);
      color:#111827;
    }
    a{color:var(--brand);text-decoration:none;}
    .wrap{max-width:1080px;margin:24px auto 72px;padding:0 16px;}
    .nav{
      display:flex;align-items:center;justify-content:space-between;
      margin-bottom:16px;
    }
    .nav-title{
      font-size:20px;font-weight:650;
    }
    .back{
      display:inline-flex;align-items:center;gap:.4rem;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:#fff;cursor:pointer;font-size:13px;
    }
    .back svg{width:14px;height:14px;}
    .card{
      background:var(--card-bg);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-card);
      padding:18px 20px 20px;
      margin-bottom:18px;
    }
    h2{margin:0 0 10px;font-size:18px;}
    h3{margin:18px 0 6px;font-size:15px;}
    .tagline{font-size:13px;color:var(--muted);margin-bottom:4px;}
    .field{margin:8px 0 12px;}
    label{display:block;font-size:13px;font-weight:500;margin-bottom:4px;}
    input[type="text"],
    input[type="password"],
    input[type="number"],
    select,
    textarea{
      width:100%;padding:7px 9px;border-radius:10px;
      border:1px solid var(--border);
      font:inherit;
    }
    textarea{min-height:120px;resize:vertical;white-space:pre-wrap;}
    .hint{font-size:12px;color:var(--muted);margin-top:4px;}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      border-radius:999px;border:1px solid transparent;
      padding:6px 16px;font-size:13px;font-weight:500;
      cursor:pointer;white-space:nowrap;
    }
    .btn-primary{
      background:var(--brand);color:#fff;border-color:var(--brand);
    }
    .btn-ghost{
      background:#fff;border-color:var(--border);color:#111827;
    }
    .btn:disabled{
      opacity:.45;cursor:not-allowed;
    }
    .btn-row{
      display:flex;flex-wrap:wrap;gap:8px;
      margin-top:4px;
    }
    .badge{
      display:inline-flex;align-items:center;
      border-radius:999px;
      padding:2px 8px;
      font-size:11px;color:var(--muted);
      background:#eef2ff;
    }
    .preview{
      margin-top:8px;
      padding:8px 10px;
      border-radius:10px;
      background:#0f172a;
      color:#e5e7eb;
      font-family:ui-monospace,Menlo,Consolas,monospace;
      font-size:12px;
      max-height:220px;
      overflow:auto;
      white-space:pre-wrap;
    }
    .block{
      border-top:1px dashed var(--border);
      padding-top:10px;
      margin-top:10px;
    }
    .file-label{font-size:12px;color:var(--muted);}
    .status{
      font-size:12px;margin-top:4px;
      color:var(--muted);
    }
    .status.ok{color:#15803d;}
    .status.err{color:#b91c1c;}
    .two-col{
      display:grid;
      grid-template-columns:minmax(0,1fr) minmax(0,1fr);
      gap:10px 18px;
    }
    @media(max-width:720px){
      .two-col{grid-template-columns:minmax(0,1fr);}
    }
    .toast{
      position:fixed;
      left:50%;bottom:18px;
      transform:translateX(-50%);
      background:#111827;
      color:#f9fafb;
      padding:8px 14px;
      border-radius:999px;
      font-size:12px;
      box-shadow:0 8px 20px rgba(15,23,42,.4);
      opacity:0;pointer-events:none;
      transition:opacity .2s ease,transform .2s ease;
      z-index:50;
    }
    .toast.show{
      opacity:1;pointer-events:auto;
      transform:translateX(-50%) translateY(-4px);
    }
    .api-row{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .api-row input{
      flex:1;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="nav">
      <div class="nav-title">BookWide Admin｜JSON 產生器</div>
      <button class="back" onclick="location.href='admin.html'">
        <svg viewBox="0 0 20 20" fill="none">
          <path d="M12.5 4.5 7 10l5.5 5.5" stroke="#4b5563" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        回主控台
      </button>
    </div>

    <!-- 0. OpenAI 設定 -->
    <section class="card">
      <div class="tagline">0. OpenAI 設定</div>
      <div class="field">
        <label for="apiKey">OpenAI API Key（只存在這個瀏覽器，不會傳到 BookWide 伺服器）</label>
        <div class="api-row">
          <input type="password" id="apiKey" placeholder="sk-..." autocomplete="off" />
          <button type="button" class="btn btn-ghost" id="toggleKey">顯示</button>
        </div>
        <div class="hint">
          金鑰會儲存在這台電腦的瀏覽器（localStorage），下次開啟會自動帶入。若是共用電腦，建議用完後在瀏覽器清除。
        </div>
      </div>
      <div class="two-col">
        <div class="field">
          <label for="model">使用模型</label>
          <select id="model">
            <option value="gpt-4.1-mini">gpt-4.1-mini（建議）</option>
            <option value="gpt-4.1">gpt-4.1</option>
          </select>
          <div class="hint">若 token 很多或歌詞很長，可以改成更省的模型。</div>
        </div>
        <div class="field">
          <label for="slug">片名 slug（用在 JSON 檔名）</label>
          <input type="text" id="slug" placeholder="例如：hello、houyi、mid-autumn" />
          <div class="hint">下載檔名會是 <code>cues-.slug.json</code>、<code>quiz-.slug.json</code>…</div>
        </div>
      </div>
    </section>

    <!-- 1. 上傳 SRT -->
    <section class="card">
      <div class="tagline">1. 上傳英文 SRT 字幕</div>
      <div class="field">
        <label for="srtFile">英文 SRT 檔</label>
        <input type="file" id="srtFile" accept=".srt" />
        <div class="hint">目前只讀英文字幕文字，之後交給 GPT 產生中／日翻譯與 JSON 結構。</div>
      </div>
      <button class="btn btn-ghost" id="btnReparse" type="button">重新解析 SRT</button>
      <div class="hint">下方會顯示已解析的幾行預覽（時間 → 英文台詞）。</div>
      <pre id="srtPreview" class="preview">尚未載入 SRT 檔。</pre>
    </section>

    <!-- 2. JSON 產生器 -->
    <section class="card">
      <div class="tagline">2. 使用 GPT 產生 JSON（一次一個檔）</div>

      <!-- cues -->
      <div class="block">
        <h3>2.1 多語字幕 cues JSON</h3>
        <div class="file-label">輸出檔名：<code id="nameCues">cues-.json</code></div>
        <div class="btn-row">
          <button class="btn btn-primary" type="button" onclick="handleGenerate('cues')">
            ① 用 GPT 產生 cues JSON
          </button>
          <button class="btn btn-ghost" type="button" id="downloadCues" disabled onclick="downloadSaved('cues')">
            下載 cues-*.json
          </button>
        </div>
        <div class="status" id="status-cues"></div>
      </div>

      <!-- quiz -->
      <div class="block">
        <h3>2.2 測驗 quiz JSON</h3>
        <div class="file-label">輸出檔名：<code id="nameQuiz">quiz-.json</code></div>

        <!-- Quiz 等級選單 -->
        <div class="field">
          <label for="quizLevel">Quiz 等級（只影響測驗題數）</label>
          <select id="quizLevel">
            <option value="1">Level 1：每類 5 題 × 4 類 = 20 題</option>
            <option value="2">Level 2：每類 10 題 × 4 類 = 40 題</option>
            <option value="3">Level 3：每類 15 題 × 4 類 = 60 題</option>
          </select>
          <div class="hint">vocab / AI 題庫不管控題數，只限制 quiz。</div>
        </div>

        <div class="btn-row">
          <button class="btn btn-primary" type="button" onclick="handleGenerate('quiz')">
            ② 用 GPT 產生 quiz JSON
          </button>
          <button class="btn btn-ghost" type="button" id="downloadQuiz" disabled onclick="downloadSaved('quiz')">
            下載 quiz-*.json
          </button>
        </div>
        <div class="status" id="status-quiz"></div>
      </div>

      <!-- vocab -->
      <div class="block">
        <h3>2.3 字彙 vocab JSON</h3>
        <div class="file-label">輸出檔名：<code id="nameVocab">vocab-.json</code></div>
        <div class="btn-row">
          <button class="btn btn-primary" type="button" onclick="handleGenerate('vocab')">
            ③ 用 GPT 產生 vocab JSON
          </button>
          <button class="btn btn-ghost" type="button" id="downloadVocab" disabled onclick="downloadSaved('vocab')">
            下載 vocab-*.json
          </button>
        </div>
        <div class="status" id="status-vocab"></div>
      </div>

      <!-- ai topics -->
      <div class="block">
        <h3>2.4 AI 對話題庫 ai JSON</h3>
        <div class="file-label">輸出檔名：<code id="nameAi">ai-.json</code></div>
        <div class="btn-row">
          <button class="btn btn-primary" type="button" onclick="handleGenerate('ai')">
            ④ 用 GPT 產生 ai JSON
          </button>
          <button class="btn btn-ghost" type="button" id="downloadAi" disabled onclick="downloadSaved('ai')">
            下載 ai-*.json
          </button>
        </div>
        <div class="status" id="status-ai"></div>
      </div>

      <!-- index -->
      <div class="block">
        <h3>2.5 單一影片索引 index JSON</h3>
        <div class="file-label">輸出檔名：<code id="nameIndex">index-.json</code></div>
        <div class="two-col">
          <div class="field">
            <label for="idxCategory">分類 category</label>
            <input type="text" id="idxCategory" placeholder="story / music / movie / news / pro" />
          </div>
          <div class="field">
            <label for="idxTitle">標題 title</label>
            <input type="text" id="idxTitle" placeholder="顯示給學生看的標題" />
          </div>
          <div class="field">
            <label for="idxLevel">難度 difficulty_level（1～5）</label>
            <input type="number" id="idxLevel" min="1" max="5" value="1" />
          </div>
          <div class="field">
            <label for="idxDuration">影片長度（秒）duration_sec</label>
            <input type="number" id="idxDuration" min="0" value="0" />
          </div>
        </div>
        <div class="btn-row">
          <button class="btn btn-primary" type="button" onclick="generateIndexJson()">
            ⑤ 產生 index JSON（本地）
          </button>
          <button class="btn btn-ghost" type="button" id="downloadIndex" disabled onclick="downloadSaved('index')">
            下載 index-*.json
          </button>
        </div>
        <div class="status" id="status-index"></div>
      </div>
    </section>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // 解析後的 SRT 段落：[{time:"00:12", text:"I'm fine."}, ...]
    let srtSegments = [];
    const savedJson = { cues:null, quiz:null, vocab:null, ai:null, index:null };
    const $ = (q) => document.querySelector(q);

    // --- OpenAI API Key localStorage + 顯示/隱藏 ---
    const apiKeyInput = $('#apiKey');
    const toggleKeyBtn = $('#toggleKey');

    if (apiKeyInput) {
      const savedKey = localStorage.getItem('bw_json_api_key') || '';
      if (savedKey) apiKeyInput.value = savedKey;
      apiKeyInput.addEventListener('input', () => {
        localStorage.setItem('bw_json_api_key', apiKeyInput.value.trim());
      });
    }
    if (toggleKeyBtn && apiKeyInput) {
      toggleKeyBtn.addEventListener('click', () => {
        const isPw = apiKeyInput.type === 'password';
        apiKeyInput.type = isPw ? 'text' : 'password';
        toggleKeyBtn.textContent = isPw ? '隱藏' : '顯示';
      });
    }

    // --- SRT 上傳 & 解析 ---
    $('#srtFile').addEventListener('change', async (ev)=>{
      const file = ev.target.files[0];
      if(!file) return;
      const text = await file.text();
      parseSrt(text);
    });
    $('#btnReparse').addEventListener('click', ()=>{
      if($('#srtFile').files[0]){
        $('#srtFile').dispatchEvent(new Event('change'));
      }else{
        showToast('請先選擇 SRT 檔。');
      }
    });

    function parseSrt(raw){
      const blocks = raw.replace(/\r\n/g,"\n").split(/\n{2,}/);
      const segs = [];
      for(const blk of blocks){
        const lines = blk.trim().split("\n").filter(Boolean);
        if(lines.length < 2) continue;
        let timeLine = lines[0];
        let textStartIdx = 1;
        if(/^\d+$/.test(lines[0]) && lines[1] && lines[1].includes("-->")){
          timeLine = lines[1]; textStartIdx = 2;
        }else if(lines[0].includes("-->")){
          timeLine = lines[0]; textStartIdx = 1;
        }else continue;
        const m = timeLine.match(/(\d{2}:\d{2}:\d{2}),\d{3}\s*-->/);
        if(!m) continue;
        const mmss = toMMSS(m[1]);
        const text = lines.slice(textStartIdx).join(" ").replace(/\s+/g," ").trim();
        if(!text) continue;
        segs.push({time:mmss,text});
      }
      srtSegments = segs;
      if(!segs.length){
        $('#srtPreview').textContent = '無法從 SRT 解析出任何字幕段落，請確認檔案格式。';
      }else{
        const previewLines = segs.slice(0,30).map(s=>`${s.time}  ${s.text}`);
        let extra = '';
        if(segs.length>30) extra = `\n……（共 ${segs.length} 行，只預覽前 30 行）`;
        $('#srtPreview').textContent = previewLines.join("\n") + extra;
      }
    }

    function toMMSS(hhmmss){
      const [hh,mm,ss] = hhmmss.split(":").map(x=>parseInt(x,10)||0);
      const total = hh*3600+mm*60+ss;
      const m2 = Math.floor(total/60);
      const s2 = total%60;
      return String(m2).padStart(2,"0")+":"+String(s2).padStart(2,"0");
    }

    function updateNames(){
      const slug = ($('#slug').value || '').trim();
      const s = slug ? slug : '';
      $('#nameCues').textContent   = `cues-${s||'slug'}.json`;
      $('#nameQuiz').textContent   = `quiz-${s||'slug'}.json`;
      $('#nameVocab').textContent  = `vocab-${s||'slug'}.json`;
      $('#nameAi').textContent     = `ai-${s||'slug'}.json`;
      $('#nameIndex').textContent  = `index-${s||'slug'}.json`;
    }
    $('#slug').addEventListener('input', updateNames);
    updateNames();

    // --- 呼叫 GPT 產 JSON ---
    async function handleGenerate(kind){
      const apiKey = ($('#apiKey').value || '').trim();
      const model  = $('#model').value;
      const slug   = ($('#slug').value || '').trim();
      if(!apiKey){ alert('請先輸入 OpenAI API Key。'); return; }
      if(!slug){ alert('請先填寫片名 slug（用在檔名）。'); return; }
      if(!srtSegments.length){ alert('請先上傳並解析 SRT 檔。'); return; }

      const statusEl = $(`#status-${kind}`);
      statusEl.textContent = '呼叫 GPT 產生中…';
      statusEl.className = 'status';

      try{
        const payload = buildChatPayload(kind, model, slug);
        const res = await fetch('https://api.openai.com/v1/chat/completions',{
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Authorization':`Bearer ${apiKey}`
          },
          body:JSON.stringify(payload)
        });
        if(!res.ok){
          const txt = await res.text();
          throw new Error(`API 錯誤 ${res.status}：${txt.slice(0,120)}`);
        }
        const data = await res.json();
        let text = data.choices?.[0]?.message?.content || '';
        text = text.trim();
        const fenceMatch = text.match(/```(?:json)?\s*([\s\S]*?)```/i);
        if(fenceMatch) text = fenceMatch[1].trim();

        let obj;
        try{ obj = JSON.parse(text); }
        catch(e){
          console.error('JSON parse fail, raw text:', text);
          throw new Error('GPT 回傳的內容不是合法 JSON，請重試或手動調整提示。');
        }

        savedJson[kind] = obj;
        const fileName = getFileName(kind, slug);
        triggerDownload(JSON.stringify(obj,null,2), fileName);
        $(`#download${cap(kind)}`).disabled = false;
        statusEl.textContent = `已完成並下載 ${fileName}，請到瀏覽器的「下載」資料夾查看。`;
        statusEl.className = 'status ok';
        showToast(`已下載 ${fileName}`);
      }catch(err){
        console.error(err);
        statusEl.textContent = '產生失敗：' + err.message;
        statusEl.className = 'status err';
        showToast('產生失敗，請查看訊息。');
      }
    }

    function buildChatPayload(kind, model, slug){
      const transcript = srtSegments.map(s=>`${s.time} ${s.text}`).join('\n');
      const commonSystem = '你是一位幫助製作英語學習教材的助手，會根據英文字幕產生 JSON。回覆時只輸出純 JSON，不要解釋文字，也不要加註解。';

      if(kind === 'cues'){
        const userPrompt =
`請根據下面的英文字幕，產生多語字幕 JSON 陣列。
每個元素格式如下：
{
  "time": "mm:ss",
  "en": "英文句子",
  "zh": "傳統中文自然口語翻譯",
  "ja": "自然的日本語翻譯"
}
注意：
- 一個字幕區塊通常對應一個元素；可以適度合併太短的句子。
- 不要留下空白欄位，也不要多出其它欄位。
- 全部放在一個 JSON 陣列裡輸出。

以下是字幕內容：
${transcript}`;
        return { model, messages:[{role:'system',content:commonSystem},{role:'user',content:userPrompt}] };
      }

      if(kind === 'quiz'){
        const levelValue = parseInt(document.getElementById('quizLevel')?.value || '1', 10);
        const perSection = levelValue === 1 ? 5 : (levelValue === 2 ? 10 : 15);
        const totalQuestions = perSection * 4;

        const userPrompt =
`請根據下面的英文字幕內容，為學生設計「共 ${totalQuestions} 題」的單選題，分成 4 個 section，每個 section 剛好 ${perSection} 題，輸出 JSON 陣列。
每個題目格式如下：
{
  "section": "理解內容",              // 或「細節理解」「字彙與片語」「延伸口說」四類之一
  "type": "single",
  "question": "英語題目句子",
  "options": ["選項 A","選項 B","選項 C","選項 D"],
  "answer": "B",                       // 正確選項代號 A/B/C/D
  "answer_en": "正確答案的英文單字或片語，或簡短英文回答",
  "answer_zh": "對應的繁體中文答案",
  "answer_ja": "對應的日本語答案",
  "explanation_zh": "用繁體中文簡短說明為什麼這個答案是正確的"
}

要求：
- 題目及選項一律使用英文。
- answer_en / answer_zh / answer_ja 要對應同一個正確意思，方便三語朗讀。
- explanation_zh 用繁體中文，給學生或老師看得懂的解釋。
- section 僅能使用以下四個字串，其餘不要出現：
  1. "理解內容"
  2. "細節理解"
  3. "字彙與片語"
  4. "延伸口說"
- 每個 section 必須剛好 ${perSection} 題，總題數要剛好 ${totalQuestions} 題。
- 題目要涵蓋整首歌／全文的重要內容與細節。
- 不要有重複題目，也不要出超出歌詞範圍的知識題。

以下是字幕內容：
${transcript}`;
        return { model, messages:[{role:'system',content:commonSystem},{role:'user',content:userPrompt}] };
      }

      if(kind === 'vocab'){
        const userPrompt =
`請根據下面的英文字幕內容，挑選 15〜25 個適合學習的字詞（單字或片語），輸出 JSON 陣列。
每個元素格式如下：
{
  "time": "mm:ss",
  "word": "英文字或片語",
  "pos": "詞性簡寫，如 n., v., adj., phr. v.",
  "zh": "繁體中文解釋",
  "en": "簡短英文解釋",
  "en_example": "英文例句",
  "zh_example": "對應的中文例句",
  "ja": "日文單字或片語",
  "ja_example": "對應的日文例句"
}
要求：
- 優先挑選跟主題相關、對學生有幫助的字詞。
- 所有欄位都要填，不要空白。
- 例句盡量跟歌詞或內容有關，但不要直接抄歌詞，以避免版權問題，可以做適度改寫。

以下是字幕內容：
${transcript}`;
        return { model, messages:[{role:'system',content:commonSystem},{role:'user',content:userPrompt}] };
      }

      if(kind === 'ai'){
        const userPrompt =
`請根據下面的歌曲或故事主題，幫我設計 8〜12 個「練習說話的題目」，輸出 JSON 物件，格式如下：
{
  "topics": [
    {
      "title": "簡短中文或英文標題",
      "prompt": "給學生的英語說話指示，可以 1〜2 句，使用英文",
      "hint": "中文或英文提示，說明要說幾句、可以包含哪些重點（建議繁體中文）",
      "sample": "示範英文回答，大約 3〜5 句"
    }
  ]
}
要求：
- prompt 必須是英文，適合 B1 程度左右的學生。
- 每個題目聚焦在不同角度，例如：描述個人經驗、喜好、感受、故事延伸等等。
- hint 可以用繁體中文，幫老師或學生理解題目重點。
- sample 一定要填入英文示範答案，不要留空字串；內容可以參考故事／歌詞主題，但不要直接抄原文，以避免版權問題。

以下是字幕內容：
${transcript}`;
        return { model, messages:[{role:'system',content:commonSystem},{role:'user',content:userPrompt}] };
      }

      throw new Error('unknown kind: '+kind);
    }

    function getFileName(kind, slug){
      const s = slug || 'slug';
      if(kind === 'cues')  return `cues-${s}.json`;
      if(kind === 'quiz')  return `quiz-${s}.json`;
      if(kind === 'vocab') return `vocab-${s}.json`;
      if(kind === 'ai')    return `ai-${s}.json`;
      if(kind === 'index') return `index-${s}.json`;
      return `${kind}-${s}.json`;
    }

    function triggerDownload(text, fileName){
      const blob = new Blob([text], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function cap(s){return s.charAt(0).toUpperCase()+s.slice(1);}

    function downloadSaved(kind){
      const slug = ($('#slug').value || '').trim();
      if(!savedJson[kind]){
        showToast('目前沒有可下載的 JSON。');
        return;
      }
      const fileName = getFileName(kind, slug);
      triggerDownload(JSON.stringify(savedJson[kind],null,2), fileName);
      showToast(`已重新下載 ${fileName}`);
    }

    function generateIndexJson(){
      const slug = ($('#slug').value || '').trim();
      if(!slug){ alert('請先填寫片名 slug。'); return; }
      const category = ($('#idxCategory').value || '').trim();
      const title    = ($('#idxTitle').value || '').trim();
      const level    = parseInt($('#idxLevel').value,10) || 1;
      const dur      = parseInt($('#idxDuration').value,10) || 0;

      const obj = {
        category: category || 'story',
        slug,
        title: title || slug,
        difficulty_level: level,
        duration_sec: dur
      };
      savedJson.index = obj;
      const fileName = getFileName('index', slug);
      triggerDownload(JSON.stringify(obj,null,2), fileName);
      $('#downloadIndex').disabled = false;
      $('#status-index').textContent = `已完成並下載 ${fileName}。`;
      $('#status-index').className = 'status ok';
      showToast(`已下載 ${fileName}`);
    }

    let toastTimer = null;
    function showToast(msg){
      const el = $('#toast');
      el.textContent = msg;
      el.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>el.classList.remove('show'), 2600);
    }
  </script>
</body>
</html>




