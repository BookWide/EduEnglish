<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin｜使用者清單</title>

  <!-- ✅ 強制不快取（避免不同瀏覽器吃到舊 JS 造成「還任瀏覽器」） -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#f4f6fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --brand:#2563eb; --brand2:#1d4ed8; --soft:#eff6ff;
      --radius:18px; --shadow:0 10px 30px rgba(15,23,42,.08);
      --ok:#16a34a; --warn:#f97316; --bad:#ef4444; --pill:#0f172a;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1180px;margin:28px auto;padding:0 16px;}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
    .back{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.7);}
    .admin{color:var(--muted);font-weight:600}
    h1{margin:10px 0 4px;font-size:34px;letter-spacing:.5px}
    .sub{margin:0 0 18px;color:var(--muted)}
    .btn{border:0;border-radius:999px;padding:10px 16px;background:var(--brand);color:#fff;font-weight:700;cursor:pointer;box-shadow:0 10px 18px rgba(37,99,235,.18);}
    .btn:active{transform:translateY(1px)}
    .panel{background:var(--card);border-radius:24px;box-shadow:var(--shadow);padding:18px;}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .search{flex:1;min-width:280px;border:1px solid var(--line);border-radius:999px;padding:12px 14px;font-size:16px;background:#fff;}
    .meta{margin:10px 0 14px;color:var(--muted);font-size:14px}
    table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:16px}
    thead th{font-size:14px;text-align:left;color:var(--muted);font-weight:700;padding:12px 10px;border-bottom:1px solid var(--line);background:#fafcff}
    tbody td{padding:12px 10px;border-bottom:1px solid #f1f5f9;vertical-align:middle}
    tbody tr:hover{background:#fafcff}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-weight:800;font-size:12px;border:1px solid var(--line);background:#fff}
    .pill.ok{border-color:rgba(22,163,74,.35);background:rgba(22,163,74,.08);color:#0f6a2b}
    .pill.warn{border-color:rgba(249,115,22,.35);background:rgba(249,115,22,.08);color:#9a3412}
    .pill.bad{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.08);color:#991b1b}
    .pill.dark{border-color:rgba(15,23,42,.2);background:rgba(15,23,42,.06);color:#0f172a}
    .hint{color:var(--muted);padding:18px 10px}
    .small{font-size:12px;color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    footer{opacity:.6;text-align:center;margin:18px 0 6px;color:var(--muted);font-weight:700}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="back" href="/admin.html">← 回上頁</a>
      <div class="admin">管理員：<span id="adminEmail" class="mono">讀取中…</span></div>
    </div>

    <h1>BookWide Admin｜使用者清單</h1>
    <p class="sub">查看所有使用者登入紀錄、在線狀態與訂閱期限。</p>

    <button class="btn" id="btnReload">使用者清單</button>

    <div style="height:12px"></div>

    <div class="panel">
      <div class="row">
        <input id="q" class="search" placeholder="搜尋 Email / 顯示名稱…" autocomplete="off" />
        <button class="btn" id="btnRefresh">重新整理</button>
      </div>

      <div class="meta">
        資料來源：<b>admin_users_overview_v2</b>（僅此一個來源，避免 profiles / orders RLS 打架）<span id="count"></span>
      </div>

      <table id="tbl">
        <thead>
          <tr>
            <th style="width:44px">#</th>
            <th>Email</th>
            <th style="width:140px">顯示名稱</th>
            <th style="width:140px">最後登入</th>
            <th style="width:140px">最近在線</th>
            <th style="width:84px">裝置</th>
            <th style="width:90px">管理員</th>
            <th>狀態</th>
            <th style="width:170px">到期日</th>
          </tr>
        </thead>
        <tbody id="tb">
          <tr><td class="hint" colspan="9">載入中…</td></tr>
        </tbody>
      </table>

      <div class="small" style="margin-top:10px">
        排序：管理員置頂 → 訂閱有效置前 → 最近在線 → 到期日 → 最近登入 → email
      </div>
    </div>

    <footer>BookWide · checklist/user.html · v20251227-R8-fixed</footer>
  </div>

<script type="module">
  // ====== 固定專案設定 ======
  const SUPABASE_URL = 'https://jeajrwpmrgczimmrflxo.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do';
  const VIEW_NAME = 'admin_users_overview_v2';

  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = (s)=>document.querySelector(s);
  const tb = $('#tb');
  const q = $('#q');
  const adminEmailEl = $('#adminEmail');
  const countEl = $('#count');

  /** 本頁只抓一次資料，避免你說的「很容易故障 / 各瀏覽器不同步」 */
  let ALL_ROWS = [];

  function fmt(ts){
    if(!ts) return '—';
    const d = new Date(ts);
    if(Number.isNaN(d.getTime())) return '—';
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const da = String(d.getDate()).padStart(2,'0');
    const hh = String(d.getHours()).padStart(2,'0');
    const mm = String(d.getMinutes()).padStart(2,'0');
    const ss = String(d.getSeconds()).padStart(2,'0');
    return `${y}/${m}/${da} ${hh}:${mm}:${ss}`;
  }

  function toMs(ts){
    if(!ts) return 0;
    const t = new Date(ts).getTime();
    return Number.isFinite(t) ? t : 0;
  }

  function isActive(x){
    // v2 會有 sub_status（active / expired / none…），先用它
    const st = String(x?.sub_status || '').toLowerCase();
    if(st === 'active') return true;
    if(st === 'expired') return false;

    // 再退回 expires_at 判斷
    const t = toMs(x?.expires_at);
    return t > Date.now();
  }

  function pill(text, kind){
    const cls = kind ? `pill ${kind}` : 'pill';
    return `<span class="${cls}">${text}</span>`;
  }

  function sortUsers(rows){
    return rows.slice().sort((a,b)=>{
      const aAdmin = a?.is_admin ? 1 : 0;
      const bAdmin = b?.is_admin ? 1 : 0;
      if(aAdmin !== bAdmin) return bAdmin - aAdmin;

      const aAct = isActive(a) ? 1 : 0;
      const bAct = isActive(b) ? 1 : 0;
      if(aAct !== bAct) return bAct - aAct;

      const aSeen = toMs(a?.last_seen_at);
      const bSeen = toMs(b?.last_seen_at);
      if(aSeen !== bSeen) return bSeen - aSeen;

      const aExp = toMs(a?.expires_at);
      const bExp = toMs(b?.expires_at);
      if(aExp !== bExp) return bExp - aExp;

      const aLogin = toMs(a?.last_login_at || a?.last_sign_in_at || a?.last_login || a?.last_sign_in);
      const bLogin = toMs(b?.last_login_at || b?.last_sign_in_at || b?.last_login || b?.last_sign_in);
      if(aLogin !== bLogin) return bLogin - aLogin;

      return String(a?.email||'').localeCompare(String(b?.email||''));
    });
  }

  function applyFilterAndRender(){
    const kw = (q.value || '').trim().toLowerCase();
    let list = ALL_ROWS;

    if(kw){
      list = ALL_ROWS.filter(x=>{
        const e = String(x?.email||'').toLowerCase();
        const n = String(x?.display_name||'').toLowerCase();
        return e.includes(kw) || n.includes(kw);
      });
    }

    const sorted = sortUsers(list);
    countEl.textContent = `（${sorted.length}）`;

    if(!sorted.length){
      tb.innerHTML = `<tr><td class="hint" colspan="9">沒有資料</td></tr>`;
      return;
    }

    tb.innerHTML = sorted.map((x, idx)=>{
      const active = isActive(x);

      const exp = x.expires_at ? fmt(x.expires_at) : '—';
    const lastLogin = r.last_login || r.last_login_at || r.last_sign_in_at || r.last_sign_in ||
      r.last_seen_at || r.last_seen || r.last_active_at || r.last_active || null;
      const lastSeen = fmt(x.last_seen_at);

      const deviceCount = (x.device_count ?? x.device_used ?? x.devices_used ?? 0);
      const deviceLimit = (x.device_limit ?? x.device_max ?? 2);
      const deviceText = `${deviceCount}/${deviceLimit}`;

      const adminTag = x.is_admin ? pill('管理員','dark') : '—';

      let statusText = '未訂閱';
      let statusKind = 'warn';
      if(active){
        statusText = `有效（active）`;
        statusKind = 'ok';
      }else if(x.expires_at){
        statusText = `已到期（${fmt(x.expires_at)}）`;
        statusKind = 'bad';
      }

      return `
        <tr>
          <td>${idx+1}</td>
          <td class="mono">${x.email || '—'}</td>
          <td>${x.display_name || '—'}</td>
          <td>${lastLogin}</td>
          <td>${lastSeen}</td>
          <td>${pill(deviceText,'dark')}</td>
          <td>${adminTag}</td>
          <td>${pill(statusText, statusKind)}</td>
          <td class="mono">${exp}</td>
        </tr>
      `;
    }).join('');
  }

  async function ensureAdmin(){
    const { data, error } = await supa.auth.getUser();
    if(error || !data?.user){
      adminEmailEl.textContent = '未登入';
      location.href = '/index.html?denied=signin';
      return null;
    }
    adminEmailEl.textContent = data.user.email || '—';
    return data.user;
  }

  async function loadOnce(){
    tb.innerHTML = `<tr><td class="hint" colspan="9">載入中…</td></tr>`;
    const u = await ensureAdmin();
    if(!u) return;

    const { data, error } = await supa.from(VIEW_NAME).select('*');
    if(error){
      tb.innerHTML = `<tr><td class="hint" colspan="9">讀取失敗：${error.message}</td></tr>`;
      return;
    }

    ALL_ROWS = (data || []).filter(x=>x && x.email);
    applyFilterAndRender();
  }

  // events
  $('#btnRefresh').addEventListener('click', loadOnce);
  $('#btnReload').addEventListener('click', loadOnce);
  q.addEventListener('input', applyFilterAndRender);

  // first load
  loadOnce();
</script>
</body>
</html>









































































































































































