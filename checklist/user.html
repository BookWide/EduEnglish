<script type="module">
  // 等 supa.js 準備好
  const ready = () => new Promise(r=>{
    if (window.BW && window.BW.supa) return r();
    const t=setInterval(()=>{
      if (window.BW && window.BW.supa){ clearInterval(t); r(); }
    },50);
  });

  await ready();
  await BW.requireAdmin();      // 只允許 admin 進入
  BW.startHeartbeat(2);         // 2 分鐘心跳一次（更新 last_seen_at）

  const supa = BW.supa;
  const $  = (q,root=document)=>root.querySelector(q);
  const fmtTW = ts => !ts ? '' :
    new Date(ts).toLocaleString('zh-TW',{timeZone:'Asia/Taipei',hour12:false});

  // 顯示目前管理員 email
  try{
    const { data:{user} } = await supa.auth.getUser();
    if(user?.email) $('#adminEmail').textContent = user.email;
  }catch(_){}

  const pillOnline = online =>
    `<span class="pill ${online?'online':'offline'}">${online?'在線':'離線'}</span>`;

  // 先用 IN(...) 抓全部，再對沒抓到的 user 個別補查 1 筆最新訂單
  async function buildOrdersMap(profiles){
    const map = {};
    const ids = profiles.map(p=>p.id).filter(Boolean);

    // 1) 一次性 .in 查詢
    if(ids.length){
      try{
        const oRes = await supa
          .from('orders')
          .select('buyer_id, status, expire_at, period, created_at')
          .in('buyer_id', ids)
          .order('expire_at',{ascending:false});

        if(!oRes.error && oRes.data){
          for(const o of oRes.data){
            if(!map[o.buyer_id]) map[o.buyer_id] = o; // 第一筆就是 expire_at 最大
          }
        }
      }catch(e){
        console.warn('orders IN 查詢錯誤', e);
      }
    }

    // 2) 對仍然沒有訂單的 user，再逐一補查 1 筆
    const missing = profiles
      .map(p=>p.id)
      .filter(id => id && !map[id]);

    for(const id of missing){
      try{
        const r = await supa
          .from('orders')
          .select('buyer_id, status, expire_at, period, created_at')
          .eq('buyer_id', id)
          .order('expire_at',{ascending:false})
          .limit(1);

        if(!r.error && r.data && r.data.length){
          map[id] = r.data[0];
        }
      }catch(e){
        console.warn('orders 單筆查詢錯誤', e);
      }
    }

    return map;
  }

  async function loadProfiles(){
    const tbody = $('#usersTable tbody');
    tbody.innerHTML = '<tr><td class="hint" colspan="8">載入中…</td></tr>';

    try{
      // 1) profiles：帶出 expires_at，必要時當備用
      const cols = 'id, email, display_name, is_admin, is_paused, last_sign_in_at, last_seen_at, expires_at';
      const r = await supa
        .from('profiles')
        .select(cols)
        .order('email',{ascending:true});

      if(r.error){
        tbody.innerHTML =
          `<tr><td class="hint" colspan="8">讀取失敗：${r.error.message}</td></tr>`;
        return;
      }
      const profiles = r.data || [];
      if(!profiles.length){
        tbody.innerHTML =
          '<tr><td class="hint" colspan="8">目前沒有任何使用者</td></tr>';
        return;
      }

      // 2) 建立「每個 user 最新一筆訂單」的 map
      const latestByUser = await buildOrdersMap(profiles);

      // 3) 搜尋（email / display_name）
      const q = ($('#q').value||'').trim().toLowerCase();
      const rows = profiles.filter(x=>{
        if(!q) return true;
        return (x.email||'').toLowerCase().includes(q)
            || (x.display_name||'').toLowerCase().includes(q);
      });

      if(!rows.length){
        tbody.innerHTML =
          '<tr><td class="hint" colspan="8">沒有符合的資料</td></tr>';
        return;
      }

      const now = new Date();

      tbody.innerHTML = rows.map((x,idx)=>{
        // 在線判斷：last_seen_at 10 分鐘內，或 last_sign_in_at 30 分鐘內
        const seenOnline =
          BW.isOnlineWithin(x.last_seen_at, 10);
        let loginOnline = false;
        if(!seenOnline && x.last_sign_in_at){
          const lastLogin = new Date(x.last_sign_in_at);
          if(!isNaN(lastLogin)){
            const diffMs = now - lastLogin;
            if(diffMs >= 0 && diffMs <= 30*60*1000){
              loginOnline = true;
            }
          }
        }
        const online = seenOnline || loginOnline;

        const ord = latestByUser[x.id] || null;

        let expireText = '—';
        let statusHtml = '<span class="pill warn">未訂閱</span>';

        // 4) 優先用 orders.expire_at
        if(ord && ord.expire_at){
          const exp   = new Date(ord.expire_at);
          const start = ord.created_at ? new Date(ord.created_at) : null;

          const startStr =
            (start && !isNaN(start)) ? fmtTW(start.toISOString()) : '—';
          const endStr =
            (!isNaN(exp)) ? fmtTW(exp.toISOString()) : '—';

          expireText = endStr;

          if(!isNaN(exp)){
            if(exp > now){
              statusHtml =
                `<span class="pill ok">有效（期間：${startStr} → ${endStr}）</span>`;
            }else{
              statusHtml =
                `<span class="pill warn">已到期（${endStr}）</span>`;
            }
          }
        }
        // 5) 如果 orders 查不到，最後退回 profiles.expires_at
        else if(x.expires_at){
          const exp = new Date(x.expires_at);
          const endStr = !isNaN(exp) ? fmtTW(exp.toISOString()) : '—';
          expireText = endStr;

          if(!isNaN(exp)){
            if(exp > now){
              statusHtml =
                `<span class="pill ok">有效（profiles.expires_at）</span>`;
            }else{
              statusHtml =
                `<span class="pill warn">已到期（profiles：${endStr}）</span>`;
            }
          }
        }

        return `
          <tr>
            <td>${idx+1}</td>
            <td>${x.email||''}</td>
            <td>${x.display_name||''}</td>
            <td>${fmtTW(x.last_sign_in_at)||''}</td>
            <td>${fmtTW(x.last_seen_at)||''} &nbsp; ${pillOnline(online)}</td>
            <td>${x.is_admin ? '<span class="pill">管理員</span>' : ''}</td>
            <td>${statusHtml}</td>
            <td>${expireText}</td>
          </tr>`;
      }).join('');
    }catch(e){
      tbody.innerHTML =
        `<tr><td class="hint" colspan="8">讀取失敗：${e.message||e}</td></tr>`;
    }
  }

  $('#btnRefresh').addEventListener('click', loadProfiles);
  $('#q').addEventListener('input', loadProfiles);

  loadProfiles();
</script>


