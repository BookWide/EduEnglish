<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin｜使用者清單</title>
  <style>
    :root{
      --bg:#f4f6fb;
      --card-bg:#fff;
      --muted:#6b7280;
      --border:#e5e7eb;
      --brand:#2563eb;
      --brand-soft:#e0edff;
      --danger:#b91c1c;
      --ok:#15803d;
      --radius-lg:18px;
      --shadow-card:0 10px 30px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif;
      background:var(--bg);
      color:#111827;
    }
    .wrap{
      max-width:1100px;
      margin:24px auto 40px;
      padding:0 16px 40px;
    }
    h1{
      font-size:24px;
      margin:0 0 4px;
      font-weight:700;
    }
    .sub{
      margin:0 0 16px;
      color:var(--muted);
      font-size:14px;
    }
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
      gap:12px;
    }
    .back{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-size:14px;
      text-decoration:none;
      color:#111827;
    }
    .back span{font-size:18px;}
    .tabs{
      display:flex;
      gap:8px;
      margin:8px 0 16px;
      flex-wrap:wrap;
    }
    .tab{
      padding:8px 16px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-size:14px;
      text-decoration:none;
      color:#111827;
    }
    .tab.active{
      background:var(--brand);
      color:#fff;
      border-color:var(--brand);
    }
    .card{
      background:var(--card-bg);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-card);
      padding:18px 18px 12px;
    }
    .card-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
      flex-wrap:wrap;
    }
    .search-group{
      display:flex;
      align-items:center;
      gap:8px;
      flex:1;
      min-width:220px;
    }
    #q{
      flex:1;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:14px;
    }
    #btnRefresh{
      padding:8px 14px;
      border-radius:999px;
      border:0;
      background:var(--brand);
      color:#fff;
      font-size:14px;
      cursor:pointer;
      white-space:nowrap;
    }
    .meta{
      font-size:12px;
      color:var(--muted);
      margin-bottom:10px;
    }
    .meta b{color:#374151;}
    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }
    thead th{
      text-align:left;
      padding:8px 6px;
      border-bottom:1px solid var(--border);
      color:#4b5563;
      white-space:nowrap;
      background:#f9fafb;
    }
    tbody td{
      padding:7px 6px;
      border-bottom:1px solid #f1f5f9;
      vertical-align:middle;
    }
    tbody tr:nth-child(even){
      background:#fbfcff;
    }
    .hint{
      text-align:center;
      padding:18px 8px;
      color:var(--muted);
      font-size:13px;
    }
    .pill{
      display:inline-flex;
      padding:2px 9px;
      border-radius:999px;
      border:1px solid #d1d5db;
      font-size:12px;
      align-items:center;
      gap:4px;
      white-space:nowrap;
    }
    .pill.ok{
      border-color:var(--ok);
      color:var(--ok);
      background:#ecfdf3;
    }
    .pill.warn{
      border-color:#ea580c;
      color:#c2410c;
      background:#fff7ed;
    }
    .pill.online{
      border-color:var(--ok);
      color:var(--ok);
      background:#ecfdf3;
    }
    .pill.offline{
      border-color:#9ca3af;
      color:#4b5563;
      background:#f9fafb;
    }
    .pill-admin{
      background:var(--brand-soft);
      border-color:var(--brand);
      color:#1d4ed8;
    }
    .admin-info{
      font-size:13px;
      color:var(--muted);
    }
    .admin-info b{color:#111827;}
    @media (max-width:720px){
      thead{display:none;}
      table,tbody,tr,td{display:block;width:100%;}
      tbody tr{margin-bottom:8px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;}
      tbody td{
        border-bottom:0;
        padding:5px 10px;
      }
      tbody td::before{
        content:attr(data-label);
        display:inline-block;
        min-width:80px;
        margin-right:4px;
        color:#6b7280;
      }
    }
  </style>

  <script type="module" src="../supa.js?v=20251109g"></script>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="back" href="../admin.html">
        <span>←</span> 回上頁
      </a>
      <div class="admin-info">
        管理員：<b id="adminEmail">讀取中…</b>
      </div>
    </div>

    <h1>BookWide Admin｜使用者清單</h1>
    <p class="sub">查看所有使用者登入紀錄、在線狀態與訂閱期限。</p>

    <div class="tabs">
      <a class="tab active" href="user.html">使用者清單</a>
    </div>

    <div class="card">
      <div class="card-head">
        <div class="search-group">
          <input id="q" placeholder="搜尋 Email / 顯示名稱…" />
          <button id="btnRefresh">重新整理</button>
        </div>
      </div>

      <div class="meta" id="metaInfo">
        資料來源：<b>public.profiles + public.orders（自動合併不漏人）</b>．台灣時區顯示．10 分鐘內視為「使用中」。
      </div>

      <div style="overflow-x:auto;">
        <table id="usersTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Email</th>
              <th>顯示名稱</th>
              <th>最後登入</th>
              <th>最近在線</th>
              <th>管理員</th>
              <th>狀態</th>
              <th>到期日</th>
            </tr>
          </thead>
          <tbody>
            <tr><td class="hint" colspan="8">載入中…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    const ready = () => new Promise(r=>{
      if (window.BW && window.BW.supa) return r();
      const t=setInterval(()=>{
        if (window.BW && window.BW.supa){ clearInterval(t); r(); }
      },50);
    });

    await ready();
    await BW.requireAdmin();
    BW.startHeartbeat(2);

    const supa = BW.supa;
    const $  = (q,root=document)=>root.querySelector(q);
    const fmtTW = ts => !ts ? '' :
      new Date(ts).toLocaleString('zh-TW',{timeZone:'Asia/Taipei',hour12:false});

    try{
      const { data:{user} } = await supa.auth.getUser();
      if(user?.email) $('#adminEmail').textContent = user.email;
    }catch(_){}

    const pillOnline = online =>
      `<span class="pill ${online?'online':'offline'}">${online?'使用中':'離線'}</span>`;

    const shortId = (id) => {
      const s = String(id||'');
      if(!s) return '';
      return s.length <= 10 ? s : (s.slice(0,8) + '…');
    };

    function emailToName(email){
      if(!email) return '';
      const s = String(email);
      return s.includes('@') ? s.split('@')[0] : s;
    }

    async function fetchLatestOrdersAll(){
      // 1) try with buyer_email
      let r = await supa
        .from('orders')
        .select('buyer_id, buyer_email, status, expire_at, period, created_at')
        .order('expire_at',{ascending:false});

      if(!r.error) return { data: r.data || [], usedBuyerEmail: true };

      // 2) fallback without buyer_email
      console.warn('[orders] buyer_email 不可用，fallback：', r.error?.message || r.error);

      r = await supa
        .from('orders')
        .select('buyer_id, status, expire_at, period, created_at')
        .order('expire_at',{ascending:false});

      return { data: r.data || [], usedBuyerEmail: false, error: r.error || null };
    }

    function buildLatestOrderMap(orders){
      const map = {};
      for(const o of (orders||[])){
        const id = o.buyer_id;
        if(!id) continue;
        if(!map[id]) map[id] = o; // 已按 expire_at desc，第一筆當最新
      }
      return map;
    }

    function isPaidLike(status){
      const s = String(status||'').toLowerCase().trim();
      // 你系統可能是 paid / success / succeeded / completed 之類
      return ['paid','success','succeeded','completed','ok'].includes(s);
    }

    async function loadUsersMerged(){
      const tbody = $('#usersTable tbody');
      tbody.innerHTML = '<tr><td class="hint" colspan="8">載入中…</td></tr>';

      try{
        const cols = 'id, email, display_name, is_admin, is_paused, last_sign_in_at, last_seen_at, expires_at';
        const pr = await supa.from('profiles').select(cols);

        if(pr.error){
          tbody.innerHTML = `<tr><td class="hint" colspan="8">profiles 讀取失敗：${pr.error.message}</td></tr>`;
          return;
        }

        const profiles = pr.data || [];

        const or = await fetchLatestOrdersAll();
        let orders = or.data || [];

        // ✅ 避免把失敗單也補進來（如果你想全部顯示，把這段刪掉）
        orders = orders.filter(o => {
          // 沒 expire_at 的先不算有效訂閱資料
          if(!o?.buyer_id || !o?.expire_at) return false;
          // status 不是 paid 類型就不補進 users（但 profiles 本來就會顯示）
          return isPaidLike(o.status) || !o.status;
        });

        const latestById = buildLatestOrderMap(orders);

        $('#metaInfo').innerHTML =
          `資料來源：<b>public.profiles + public.orders（自動合併不漏人）</b>．` +
          `orders 欄位：<b>${or.usedBuyerEmail ? 'buyer_email ✓' : 'buyer_email ✗（fallback）'}</b>．` +
          `台灣時區顯示．10 分鐘內視為「使用中」。`;

        const byId = {};
        for(const p of profiles){
          if(p?.id) byId[p.id] = p;
        }

        // 先放 profiles
        const merged = profiles.map(p=>({ ...p, __from:'profiles' }));

        // ✅ orders-only：只補「profiles 沒有」的 buyer_id（去重）
        const added = new Set();
        for(const o of orders){
          const id = o?.buyer_id;
          if(!id) continue;
          if(byId[id]) continue;
          if(added.has(id)) continue;

          added.add(id);

          // email：有 buyer_email 用它；沒有就顯示 ID 方便追查
          const email = (o.buyer_email || '').trim();
          const showEmail = email || `ID:${shortId(id)}`;

          merged.push({
            id,
            email: showEmail,
            display_name: email ? emailToName(email) : '訂閱用戶',
            is_admin: false,
            is_paused: false,
            last_sign_in_at: null,
            last_seen_at: null,
            expires_at: null,
            __from: 'orders_only'
          });
        }

        if(!merged.length){
          tbody.innerHTML = '<tr><td class="hint" colspan="8">目前沒有任何資料</td></tr>';
          return;
        }

        const q = ($('#q').value||'').trim().toLowerCase();
        let rows = merged.filter(x=>{
          if(!q) return true;
          return (x.email||'').toLowerCase().includes(q)
              || (x.display_name||'').toLowerCase().includes(q);
        });

        if(!rows.length){
          tbody.innerHTML = '<tr><td class="hint" colspan="8">沒有符合的資料</td></tr>';
          return;
        }

        const now = new Date();

        rows = rows.map(x=>{
          const seenOnline = BW.isOnlineWithin(x.last_seen_at, 10);
          let loginOnline = false;
          if(!seenOnline && x.last_sign_in_at){
            const lastLogin = new Date(x.last_sign_in_at);
            if(!isNaN(lastLogin)){
              const diffMs = now - lastLogin;
              if(diffMs >= 0 && diffMs <= 30*60*1000) loginOnline = true;
            }
          }
          const online = seenOnline || loginOnline;
          return { ...x, __online: online };
        });

        // 排序：管理員 → 使用中 → 是否有訂閱 → 最近活動 → email
        rows.sort((a,b)=>{
          const aAdmin = a.is_admin ? 1 : 0, bAdmin = b.is_admin ? 1 : 0;
          if(aAdmin !== bAdmin) return bAdmin - aAdmin;

          const aOn = a.__online ? 1 : 0, bOn = b.__online ? 1 : 0;
          if(aOn !== bOn) return bOn - aOn;

          const aOrd = latestById[a.id];
          const bOrd = latestById[b.id];
          const aExp = aOrd?.expire_at || a.expires_at || null;
          const bExp = bOrd?.expire_at || b.expires_at || null;
          const aHas = aExp ? 1 : 0, bHas = bExp ? 1 : 0;
          if(aHas !== bHas) return bHas - aHas;

          const aTs = new Date(a.last_seen_at || a.last_sign_in_at || 0).getTime() || 0;
          const bTs = new Date(b.last_seen_at || b.last_sign_in_at || 0).getTime() || 0;
          if(aTs !== bTs) return bTs - aTs;

          return String(a.email||'').localeCompare(String(b.email||''));
        });

        tbody.innerHTML = rows.map((x,idx)=>{
          const online = !!x.__online;
          const ord = latestById[x.id] || null;

          let expireText = '—';
          let statusHtml = '<span class="pill warn">未訂閱</span>';

          if(ord && ord.expire_at){
            const exp   = new Date(ord.expire_at);
            const start = ord.created_at ? new Date(ord.created_at) : null;

            const startStr = (start && !isNaN(start)) ? fmtTW(start.toISOString()) : '—';
            const endStr   = (!isNaN(exp)) ? fmtTW(exp.toISOString()) : '—';

            expireText = endStr;

            if(!isNaN(exp)){
              if(exp > now){
                statusHtml = `<span class="pill ok">有效（期間：${startStr} → ${endStr}）</span>`;
              }else{
                statusHtml = `<span class="pill warn">已到期（${endStr}）</span>`;
              }
            }
          }else if(x.expires_at){
            const exp = new Date(x.expires_at);
            const endStr = !isNaN(exp) ? fmtTW(exp.toISOString()) : '—';
            expireText = endStr;

            if(!isNaN(exp)){
              if(exp > now){
                statusHtml = `<span class="pill ok">有效（profiles.expires_at）</span>`;
              }else{
                statusHtml = `<span class="pill warn">已到期（profiles：${endStr}）</span>`;
              }
            }
          }

          return `
            <tr>
              <td data-label="#">${idx+1}</td>
              <td data-label="Email">${x.email||''}</td>
              <td data-label="顯示名稱">${x.display_name||''}</td>
              <td data-label="最後登入">${fmtTW(x.last_sign_in_at)||''}</td>
              <td data-label="最近在線">${fmtTW(x.last_seen_at)||''} &nbsp; ${pillOnline(online)}</td>
              <td data-label="管理員">${x.is_admin ? '<span class="pill pill-admin">管理員</span>' : ''}</td>
              <td data-label="狀態">${statusHtml}</td>
              <td data-label="到期日">${expireText}</td>
            </tr>`;
        }).join('');
      }catch(e){
        tbody.innerHTML = `<tr><td class="hint" colspan="8">讀取失敗：${e.message||e}</td></tr>`;
      }
    }

    $('#btnRefresh').addEventListener('click', loadUsersMerged);

    let t=null;
    $('#q').addEventListener('input', ()=>{
      clearTimeout(t);
      t=setTimeout(loadUsersMerged, 250);
    });

    loadUsersMerged();
  </script>
</body>
</html>






