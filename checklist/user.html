<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin｜使用者清單</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#f4f6fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --brand:#2563eb; --brand2:#1d4ed8; --soft:#eef2ff;
      --ok:#16a34a; --warn:#f97316; --bad:#ef4444;
      --radius:18px; --shadow:0 14px 40px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,
      "Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;}
    a{color:inherit;text-decoration:none}
    .topbar{display:flex;align-items:center;justify-content:space-between;
      padding:18px 22px;}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);
      background:#fff;border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .wrap{max-width:1180px;margin:0 auto;padding:0 18px 28px}
    h1{margin:6px 0 4px;font-size:44px;letter-spacing:.2px}
    .sub{color:var(--muted);margin:0 0 14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
      box-shadow:var(--shadow);padding:16px 16px 10px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .grow{flex:1}
    .search{width:100%;max-width:540px;border:1px solid var(--line);border-radius:999px;
      padding:12px 14px;font-size:16px;outline:none}
    .meta{color:var(--muted);font-size:14px;margin:8px 2px 10px}
    table{width:100%;border-collapse:collapse;table-layout:fixed}
    th,td{padding:12px 10px;border-top:1px solid var(--line);vertical-align:middle}
    th{color:var(--muted);font-weight:800;font-size:14px;text-align:left;background:#fafbff}
    td{font-size:15px}
    .colN{width:54px}
    .colEmail{width:240px}
    .colName{width:140px}
    .colLast{width:170px}
    .colOnline{width:170px}
    .colDev{width:86px}
    .colAdmin{width:90px}
    .colStatus{width:190px}
    .colExp{width:170px}
    .pill{display:inline-flex;align-items:center;justify-content:center;
      padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      font-weight:800;font-size:13px;white-space:nowrap}
    .pill.ok{border-color:rgba(22,163,74,.35);background:rgba(22,163,74,.10);color:#14532d}
    .pill.bad{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.10);color:#7f1d1d}
    .pill.warn{border-color:rgba(249,115,22,.35);background:rgba(249,115,22,.10);color:#7c2d12}
    .pill.blue{border-color:rgba(37,99,235,.35);background:rgba(37,99,235,.10);color:#1e3a8a}
    .muted{color:var(--muted)}
    .err{margin-top:10px;border:1px solid rgba(239,68,68,.35);background:rgba(239,68,68,.07);
      color:#7f1d1d;border-radius:12px;padding:10px 12px;font-weight:700;display:none}
    .loading{padding:16px 10px;color:var(--muted)}
    @media (max-width:980px){
      h1{font-size:34px}
      .colStatus{width:160px}
    }
  </style>
</head>
<body>
  <!-- v20251227-R9: user.html（穩定版：只讀 admin_users_overview_v2 + 前端排序） -->
  <div class="wrap">
    <div class="topbar">
      <a class="btn" href="/index.html">← 回上頁</a>
      <div class="muted" id="who">管理員：讀取中…</div>
    </div>

    <h1>BookWide Admin｜使用者清單</h1>
    <p class="sub">查看所有使用者登入紀錄、在線狀態與訂閱期限。</p>

    <div class="card">
      <div class="row">
        <input id="q" class="search grow" placeholder="搜尋 Email / 顯示名稱…" />
        <button id="reload" class="btn primary">重新整理</button>
      </div>
      <div class="meta" id="sourceNote">資料來源：<b>admin_users_overview_v2</b>（僅此一個來源，避免 profiles / orders RLS 打架）</div>
      <div class="err" id="errBox"></div>

      <div style="overflow:auto;border-radius:14px;border:1px solid var(--line)">
        <table>
          <thead>
            <tr>
              <th class="colN">#</th>
              <th class="colEmail">Email</th>
              <th class="colName">顯示名稱</th>
              <th class="colLast">最後登入</th>
              <th class="colOnline">最近在線</th>
              <th class="colDev">裝置</th>
              <th class="colAdmin">管理員</th>
              <th class="colStatus">狀態</th>
              <th class="colExp">到期日</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td class="loading" colspan="9">載入中…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

<script>
(() => {
  const SUPABASE_URL = 'https://jeajrwpmrgczimmrflxo.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do';
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const els = {
    who: document.getElementById('who'),
    q: document.getElementById('q'),
    tbody: document.getElementById('tbody'),
    err: document.getElementById('errBox'),
    reload: document.getElementById('reload'),
  };

  function showErr(msg){
    els.err.style.display = 'block';
    els.err.textContent = msg;
  }
  function clearErr(){
    els.err.style.display = 'none';
    els.err.textContent = '';
  }

  function fmtDT(v){
    if(!v) return '—';
    const d = new Date(v);
    if(isNaN(d.getTime())) return '—';
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    const hh = String(d.getHours()).padStart(2,'0');
    const mi = String(d.getMinutes()).padStart(2,'0');
    const ss = String(d.getSeconds()).padStart(2,'0');
    return `${yyyy}/${mm}/${dd} ${hh}:${mi}:${ss}`;
  }

  function toMs(v){
    if(!v) return 0;
    const t = new Date(v).getTime();
    return isNaN(t) ? 0 : t;
  }

  function calcOnlinePill(lastSeen){
    const t = toMs(lastSeen);
    if(!t) return `<span class="pill muted">離線</span>`;
    const now = Date.now();
    const mins = (now - t) / 60000;
    if(mins <= 10) return `<span class="pill ok">使用中</span>`;
    return `<span class="pill muted">離線</span>`;
  }

  function calcStatus(row){
    const sub = (row.sub_status || '').toLowerCase();
    const exp = row.expires_at;
    if(sub === 'active') return `<span class="pill ok">有效（active）</span>`;
    if(sub === 'expired') return `<span class="pill bad">已到期（expired）</span>`;
    if(sub === 'none' || !sub) return `<span class="pill warn">未訂閱</span>`;
    return `<span class="pill warn">${escapeHtml(row.sub_status)}</span>`;
  }

  function escapeHtml(s){
    return String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function sortRows(rows){
    // 1) 管理員優先
    // 2) 訂閱中（sub_status=active）優先
    // 3) 到期時間晚的優先（expires_at desc）
    // 4) 最近在線優先（last_seen desc）
    return [...rows].sort((a,b)=>{
      const aAdmin = a.is_admin ? 1 : 0;
      const bAdmin = b.is_admin ? 1 : 0;
      if(aAdmin !== bAdmin) return bAdmin - aAdmin;

      const aActive = (String(a.sub_status||'').toLowerCase()==='active') ? 1 : 0;
      const bActive = (String(b.sub_status||'').toLowerCase()==='active') ? 1 : 0;
      if(aActive !== bActive) return bActive - aActive;

      const aExp = toMs(a.expires_at);
      const bExp = toMs(b.expires_at);
      if(aExp !== bExp) return bExp - aExp;

      const aSeen = toMs(a.last_seen || a.last_seen_at || a.last_active_at);
      const bSeen = toMs(b.last_seen || b.last_seen_at || b.last_active_at);
      if(aSeen !== bSeen) return bSeen - aSeen;

      const aEmail = String(a.email||'');
      const bEmail = String(b.email||'');
      return aEmail.localeCompare(bEmail);
    });
  }

  function render(rows){
    const q = (els.q.value || '').trim().toLowerCase();
    const filtered = !q ? rows : rows.filter(r => {
      const e = String(r.email || '').toLowerCase();
      const n = String(r.display_name || r.name || '').toLowerCase();
      return e.includes(q) || n.includes(q);
    });

    if(filtered.length === 0){
      els.tbody.innerHTML = `<tr><td colspan="9" class="loading">沒有資料</td></tr>`;
      return;
    }

    els.tbody.innerHTML = filtered.map((r, idx)=>{
      const devCount = (r.device_count ?? r.devices ?? 0);
      const devLimit = (r.device_limit ?? r.device_max ?? 2);
      const lastLogin = r.last_login || r.last_login_at || r.last_sign_in_at || r.last_sign_in;
      const lastSeen = r.last_seen || r.last_seen_at || r.last_active_at || r.recent_online;
      const exp = r.expires_at;

      const adminPill = r.is_admin ? `<span class="pill blue">管理員</span>` : `—`;
      const statusPill = calcStatus(r);
      const onlinePill = calcOnlinePill(lastSeen);

      return `
        <tr>
          <td class="colN">${idx+1}</td>
          <td class="colEmail"><b>${escapeHtml(r.email)}</b></td>
          <td class="colName">${escapeHtml(r.display_name || '—')}</td>
          <td class="colLast">${fmtDT(lastLogin)}</td>
          <td class="colOnline">${fmtDT(lastSeen)}&nbsp;${onlinePill}</td>
          <td class="colDev"><span class="pill">${escapeHtml(devCount)}/${escapeHtml(devLimit)}</span></td>
          <td class="colAdmin">${adminPill}</td>
          <td class="colStatus">${statusPill}</td>
          <td class="colExp"><b>${fmtDT(exp)}</b></td>
        </tr>
      `;
    }).join('');
  }

  async function getMe(){
    try{
      const { data } = await sb.auth.getUser();
      const email = data?.user?.email || '—';
      els.who.textContent = `管理員：${email}`;
    } catch(e) {
      els.who.textContent = '管理員：—';
    }
  }

  async function load(){
    clearErr();
    els.tbody.innerHTML = `<tr><td colspan="9" class="loading">載入中…</td></tr>`;
    try{
      // 加 timeout，避免卡死
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), 12000);

      const req = sb
        .from('admin_users_overview_v2')
        .select('*');

      // supabase-js v2 不直接吃 signal，這裡用 Promise.race 控制
      const p = req;
      const { data, error } = await Promise.race([
        p,
        new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')), 12500))
      ]);

      clearTimeout(t);

      if(error) throw error;
      const rows = Array.isArray(data) ? data : [];
      const sorted = sortRows(rows);
      render(sorted);
    } catch(err){
      console.error(err);
      showErr('無法讀取統計：' + (err?.message || String(err)));
      els.tbody.innerHTML = `<tr><td colspan="9" class="loading">載入失敗</td></tr>`;
    }
  }

  els.reload.addEventListener('click', load);
  els.q.addEventListener('input', () => load()); // 簡單：輸入就重新 render（資料量小）

  getMe();
  load();
})();
</script>
</body>
</html>









































































































































































