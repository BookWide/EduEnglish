<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin｜使用者清單</title>

  <!-- 共用 Supabase 包裝：跟 admin.html 一樣，只是路徑改成 ../ -->
  <script type="module" src="../supa.js?v=20251109g"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

  <style>
    :root{
      --bg:#f4f6fb;
      --card-bg:#fff;
      --fg:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --brand:#2563eb;
      --brand-soft:#e0edff;
      --radius-lg:18px;
      --shadow-card:0 10px 30px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC","Microsoft JhengHei",sans-serif;
    }
    header{
      padding:18px 20px 8px;
      border-bottom:1px solid var(--border);
    }
    .title-row{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:10px;
    }
    .title{font-size:22px;font-weight:700;}
    .subtitle{font-size:.9rem;color:var(--muted);margin-top:4px;}
    .admin-info{
      margin-left:auto;
      font-size:.85rem;
      color:var(--muted);
    }

    .wrap{
      max-width:1100px;
      margin:18px auto 80px;
      padding:0 16px 32px;
    }

    .top-bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .back-btn{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:7px 14px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-size:.9rem;
      color:#111827;
      text-decoration:none;
    }

    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .tab{
      padding:7px 16px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-size:.9rem;
      color:#374151;
      text-decoration:none;
    }
    .tab.active{
      background:var(--brand);
      border-color:var(--brand);
      color:#fff;
    }

    .card{
      background:var(--card-bg);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-card);
      padding:16px 16px 18px;
    }

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      margin-bottom:10px;
    }
    .ipt{
      min-width:260px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:.95rem;
    }
    .btn{
      padding:7px 16px;
      border-radius:999px;
      border:1px solid var(--brand);
      background:#fff;
      color:var(--brand);
      font-size:.9rem;
      cursor:pointer;
    }
    .hint{font-size:.8rem;color:var(--muted);}

    table{
      width:100%;
      border-collapse:collapse;
      font-size:.9rem;
      background:#fff;
      border-radius:14px;
      overflow:hidden;
    }
    thead th{
      background:#f9fafb;
      border-bottom:1px solid var(--border);
      padding:.6rem .7rem;
      text-align:left;
      white-space:nowrap;
    }
    tbody td{
      border-bottom:1px solid var(--border);
      padding:.6rem .7rem;
      vertical-align:top;
    }
    tbody tr:last-child td{border-bottom:none;}

    .pill{
      display:inline-block;
      padding:.15rem .55rem;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:.75rem;
      white-space:nowrap;
    }
    .pill.ok{color:#16a34a;border-color:#16a34a;}
    .pill.warn{color:#f59e0b;border-color:#f59e0b;}
    .pill.online{color:#16a34a;border-color:#16a34a;}
    .pill.offline{color:#6b7280;border-color:#d1d5db;}

    @media (max-width:768px){
      header{padding:14px 14px 6px;}
      .wrap{margin-top:14px;}
    }
  </style>
</head>
<body>

<header>
  <div class="title-row">
    <div>
      <div class="title">BookWide Admin｜使用者清單</div>
      <div class="subtitle">查看所有使用者登入紀錄、在線狀態與訂閱期限。</div>
    </div>
    <div class="admin-info">管理員：<span id="adminEmail">檢查中…</span></div>
  </div>

  <div class="tabs">
    <a href="/checklist/user.html" class="tab active">使用者清單</a>
    <a href="/checklist/authorize.html" class="tab">授權／暫停管理員</a>
    <a href="/checklist/upload.html" class="tab">MP4 上傳</a>
  </div>
</header>

<main class="wrap">
  <div class="top-bar">
    <a href="/admin.html" class="back-btn">← 回上頁</a>
  </div>

  <section class="card">
    <div class="toolbar">
      <input id="q" class="ipt" placeholder="搜尋 Email / 顯示名稱…" />
      <button id="btnRefresh" class="btn">重新整理</button>
      <span class="hint">資料表：public.profiles · 台灣時區顯示 · 10 分鐘內視為「在線」。</span>
    </div>

    <div style="overflow-x:auto;">
      <table id="usersTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Email</th>
            <th>顯示名稱</th>
            <th>最後登入</th>
            <th>最近在線</th>
            <th>管理員</th>
            <th>狀態</th>
            <th>到期日</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="8" class="hint">載入中…</td></tr>
        </tbody>
      </table>
    </div>
  </section>
</main>

<script type="module">
  const ready = () => new Promise(r=>{
    if (window.BW && window.BW.supa) return r();
    const t=setInterval(()=>{
      if (window.BW && window.BW.supa){ clearInterval(t); r(); }
    },50);
  });

  await ready();
  await BW.requireAdmin();         // 確認 admin + is_paused
  BW.startHeartbeat(2);            // 兩分鐘心跳一次

  const supa = BW.supa;
  const $  = (q,root=document)=>root.querySelector(q);
  const fmtTW = ts => !ts ? '' : new Date(ts).toLocaleString(
    'zh-TW',
    { timeZone:'Asia/Taipei', hour12:false }
  );

  // 顯示登入 admin 的 email
  try{
    const { data:{user} } = await supa.auth.getUser();
    if(user?.email) $('#adminEmail').textContent = user.email;
  }catch(_){}

  const pillOnline = online =>
    `<span class="pill ${online?'online':'offline'}">${online?'在線':'離線'}</span>`;

  async function loadProfiles(){
    const tbody = $('#usersTable tbody');
    tbody.innerHTML = '<tr><td class="hint" colspan="8">載入中…</td></tr>';

    try{
      // 1) 讀 profiles（欄位同舊 admin.html，避免 400）
      const cols = 'id, email, display_name, is_admin, is_paused, last_sign_in_at, last_seen_at';
      const r = await supa
        .from('profiles')
        .select(cols)
        .order('email',{ascending:true});

      if(r.error){
        tbody.innerHTML = `<tr><td class="hint" colspan="8">讀取失敗：${r.error.message}</td></tr>`;
        return;
      }

      const profiles = r.data || [];
      if(!profiles.length){
        tbody.innerHTML = '<tr><td class="hint" colspan="8">目前沒有任何使用者</td></tr>';
        return;
      }

      // 2) 讀 orders，找每個 user 最新一筆「已付款」訂單
      const ids = profiles.map(p=>p.id).filter(Boolean);
      const latestByUser = {};
      if(ids.length){
        const oRes = await supa
          .from('orders')
          .select('buyer_id, status, expire_at, period, created_at')
          .in('buyer_id', ids)
          .order('expire_at',{ascending:false});

        if(!oRes.error && oRes.data){
          for(const o of oRes.data){
            if(o.status !== 'paid') continue;
            if(!latestByUser[o.buyer_id]){
              latestByUser[o.buyer_id] = o; // 第一筆就是 expire_at 最新
            }
          }
        }
      }

      // 3) 搜尋過濾（email / display_name）
      const q = ($('#q').value||'').trim().toLowerCase();
      const rows = profiles.filter(x=>{
        if(!q) return true;
        return (x.email||'').toLowerCase().includes(q)
            || (x.display_name||'').toLowerCase().includes(q);
      });

      if(!rows.length){
        tbody.innerHTML = '<tr><td class="hint" colspan="8">沒有符合的資料</td></tr>';
        return;
      }

      const now = new Date();
      tbody.innerHTML = rows.map((x,idx)=>{
        const online = BW.isOnlineWithin(x.last_seen_at, 10);  // 10 分鐘內視為在線
        const ord = latestByUser[x.id];

        let expireText = '—';
        let statusHtml = '<span class="pill warn">未訂閱</span>';

        if(ord && ord.expire_at){
          const exp   = new Date(ord.expire_at);
          const start = ord.created_at ? new Date(ord.created_at) : null;
          const startStr = (start && !isNaN(start)) ? fmtTW(start.toISOString()) : '—';
          const endStr   = (!isNaN(exp)) ? fmtTW(exp.toISOString()) : '—';

          if(!isNaN(exp)){
            expireText = endStr;
            if(exp > now){
              statusHtml = `<span class="pill ok">有效（期間：${startStr} → ${endStr}）</span>`;
            }else{
              statusHtml = `<span class="pill warn">已到期（${endStr}）</span>`;
            }
          }
        }

        return `
          <tr>
            <td>${idx+1}</td>
            <td>${x.email||''}</td>
            <td>${x.display_name||''}</td>
            <td>${fmtTW(x.last_sign_in_at)||''}</td>
            <td>${fmtTW(x.last_seen_at)||''} &nbsp; ${pillOnline(online)}</td>
            <td>${x.is_admin ? '<span class="pill">管理員</span>' : ''}</td>
            <td>${statusHtml}</td>
            <td>${expireText}</td>
          </tr>`;
      }).join('');
    }catch(e){
      tbody.innerHTML =
        `<tr><td class="hint" colspan="8">讀取失敗：${e.message||e}</td></tr>`;
    }
  }

  $('#btnRefresh').addEventListener('click', loadProfiles);
  $('#q').addEventListener('input', loadProfiles);

  loadProfiles();
</script>

</body>
</html>

