<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin｜使用者清單</title>
  <style>
    :root{
      --bg:#f4f6fb;
      --card-bg:#fff;
      --muted:#6b7280;
      --border:#e5e7eb;
      --brand:#2563eb;
      --brand-soft:#e0edff;
      --danger:#b91c1c;
      --ok:#15803d;
      --radius-lg:18px;
      --shadow-card:0 10px 30px rgba(15,23,42,.08);
      --warn:#ea580c;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif;
      background:var(--bg);
      color:#111827;
    }
    .wrap{
      max-width:1100px;
      margin:24px auto 40px;
      padding:0 16px 40px;
    }
    h1{
      font-size:24px;
      margin:0 0 4px;
      font-weight:700;
    }
    .sub{
      margin:0 0 16px;
      color:var(--muted);
      font-size:14px;
    }
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
      gap:12px;
    }
    .back{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-size:14px;
      text-decoration:none;
      color:#111827;
    }
    .back span{font-size:18px;}
    .tabs{
      display:flex;
      gap:8px;
      margin:8px 0 16px;
      flex-wrap:wrap;
    }
    .tab{
      padding:8px 16px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-size:14px;
      text-decoration:none;
      color:#111827;
    }
    .tab.active{
      background:var(--brand);
      color:#fff;
      border-color:var(--brand);
    }
    .card{
      background:var(--card-bg);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-card);
      padding:18px 18px 12px;
    }
    .card-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
      flex-wrap:wrap;
    }
    .search-group{
      display:flex;
      align-items:center;
      gap:8px;
      flex:1;
      min-width:220px;
    }
    #q{
      flex:1;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:14px;
    }
    #btnRefresh{
      padding:8px 14px;
      border-radius:999px;
      border:0;
      background:var(--brand);
      color:#fff;
      font-size:14px;
      cursor:pointer;
      white-space:nowrap;
    }
    .meta{
      font-size:12px;
      color:var(--muted);
      margin-bottom:10px;
      line-height:1.5;
    }
    .meta b{color:#374151;}
    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }
    thead th{
      text-align:left;
      padding:8px 6px;
      border-bottom:1px solid var(--border);
      color:#4b5563;
      white-space:nowrap;
      background:#f9fafb;
    }
    tbody td{
      padding:7px 6px;
      border-bottom:1px solid #f1f5f9;
      vertical-align:middle;
    }
    tbody tr:nth-child(even){
      background:#fbfcff;
    }
    .hint{
      text-align:center;
      padding:18px 8px;
      color:var(--muted);
      font-size:13px;
    }
    .pill{
      display:inline-flex;
      padding:2px 9px;
      border-radius:999px;
      border:1px solid #d1d5db;
      font-size:12px;
      align-items:center;
      gap:4px;
      white-space:nowrap;
    }
    .pill.ok{
      border-color:var(--ok);
      color:var(--ok);
      background:#ecfdf3;
    }
    .pill.warn{
      border-color:var(--warn);
      color:#c2410c;
      background:#fff7ed;
    }
    .pill.online{
      border-color:var(--ok);
      color:var(--ok);
      background:#ecfdf3;
    }
    .pill.offline{
      border-color:#9ca3af;
      color:#4b5563;
      background:#f9fafb;
    }
    .pill-admin{
      background:var(--brand-soft);
      border-color:var(--brand);
      color:#1d4ed8;
    }
    .pill.dev{
      border-color:#cbd5e1;
      color:#334155;
      background:#f8fafc;
      font-weight:800;
    }
    .pill.dev.warn{
      border-color:#ef4444;
      color:#b91c1c;
      background:#fff1f2;
    }

    .admin-info{
      font-size:13px;
      color:var(--muted);
    }
    .admin-info b{color:#111827;}
    @media (max-width:720px){
      thead{display:none;}
      table,tbody,tr,td{display:block;width:100%;}
      tbody tr{margin-bottom:8px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;}
      tbody td{
        border-bottom:0;
        padding:5px 10px;
      }
      tbody td::before{
        content:attr(data-label);
        display:inline-block;
        min-width:80px;
        margin-right:4px;
        color:#6b7280;
      }
    }
  </style>

  <!-- 載入 supa.js（會把 BW 掛到 window.BW） -->
  <script type="module" src="../supa.js?v=20251109g"></script>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <a class="back" href="../admin.html">
        <span>←</span> 回上頁
      </a>
      <div class="admin-info">
        管理員：<b id="adminEmail">讀取中…</b>
      </div>
    </div>

    <h1>BookWide Admin｜使用者清單</h1>
    <p class="sub">查看所有使用者登入紀錄、在線狀態與訂閱期限。</p>

    <div class="tabs">
      <a class="tab active" href="user.html">使用者清單</a>
    </div>

    <div class="card">
      <div class="card-head">
        <div class="search-group">
          <input id="q" placeholder="搜尋 Email / 顯示名稱…" />
          <button id="btnRefresh">重新整理</button>
        </div>
      </div>

      <div class="meta" id="metaText">
        資料來源：<b>public.profiles</b>（使用者主檔）＋ <b>public.orders</b>（訂閱狀態補充）。<br/>
        合併鍵：<b>orders.buyer_id = profiles.id</b>（不再產生 orders-only/unknown）。台灣時區顯示．10 分鐘內視為「使用中」。
      </div>

      <div style="overflow-x:auto;">
        <table id="usersTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Email</th>
              <th>顯示名稱</th>
              <th>最後登入</th>
              <th>最近在線</th>
              <th>裝置</th>
              <th>管理員</th>
              <th>狀態</th>
              <th>到期日</th>
            </tr>
          </thead>
          <tbody>
            <tr><td class="hint" colspan="9">載入中…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    
// BookWide Admin | 使用者清單  (R6 stable)
// - 先走 RPC: admin_users_overview()（server 端彙總 orders+profiles）
// - RPC 不可用則 fallback profiles（仍可列出使用者，但到期可能不含訂單覆蓋）
// - 全部程式包在 main()，避免頂層語法/return/await 差異造成整頁掛掉

const main = async () => {
  const $ = (q, root=document) => root.querySelector(q);

  const ready = () => new Promise((resolve) => {
    if (window.BW && window.BW.supa) return resolve();
    const t = setInterval(() => {
      if (window.BW && window.BW.supa) { clearInterval(t); resolve(); }
    }, 50);
    setTimeout(() => { clearInterval(t); resolve(); }, 8000);
  });

  const fmtTW = (ts) => {
    if (!ts) return '—';
    try{
      const d = new Date(ts);
      if (isNaN(d.getTime())) return '—';
      return d.toLocaleString('zh-TW', { timeZone:'Asia/Taipei', hour12:false });
    }catch(_){
      return '—';
    }
  };

  const badge = (text, cls='') => `<span class="badge ${cls}">${text}</span>`;

  await ready();

  const supa = BW.supa;

  // admin guard
  try{
    await BW.requireAdmin();
  }catch(e){
    console.error('[BookWide] requireAdmin failed:', e);
    // requireAdmin 通常會自行 redirect；這裡就不硬做
  }

  // heartbeat（存在就啟動）
  try{ BW.startHeartbeat?.(2); }catch(_){}

  // 顯示 admin email
  try{
    const { data } = await supa.auth.getUser();
    $('#adminEmail').textContent = data?.user?.email ? data.user.email : '—';
  }catch(_){
    $('#adminEmail').textContent = '—';
  }

  const tbody = $('#usersTable tbody');
  const q = $('#q');
  const btnRefresh = $('#btnRefresh');
  const metaText = $('#metaText');

  const state = { rows: [] };

  const isValid = (d) => d && !isNaN(d.getTime());
  const nowMs = () => Date.now();

  function computeStatus(row){
    const exp = row?.expires_at ? new Date(row.expires_at) : null;
    const hasExp = isValid(exp);
    const ok = hasExp && exp.getTime() > nowMs();
    const source = row?.expire_source ? String(row.expire_source) : 'profiles';
    const statusText = !hasExp ? '未訂閱' : (ok ? `有效（${source}.expires_at）` : `已到期（${source}：${fmtTW(exp)}）`);
    return { exp, hasExp, ok, source, statusText };
  }

  function render(list){
    tbody.innerHTML = '';
    if (!list.length){
      tbody.innerHTML = `<tr><td class="hint" colspan="9">沒有資料</td></tr>`;
      return;
    }
    list.forEach((r, i) => {
      const st = computeStatus(r);

      const lastSign = fmtTW(r.last_sign_in_at);
      const lastSeen = fmtTW(r.last_seen_at);

      const online = (() => {
        try{
          return BW.isOnlineWithin?.(r.last_seen_at, 10) ? badge('使用中','ok') : badge('離線','');
        }catch(_){
          return badge('—','');
        }
      })();

      const adminTag = r.is_admin ? badge('管理員','ok') : badge('—','');
      const deviceTag = badge('0/2',''); // 這頁目前只顯示佔位（避免讀 device 表造成不穩）

      const statusTag = (() => {
        if (!st.hasExp) return badge('未訂閱','warn');
        return st.ok ? badge('有效','ok') : badge('已到期','bad');
      })();

      const expireText = st.hasExp ? fmtTW(st.exp) : '—';
      const statusNote = st.hasExp ? ` <span class="muted">(${st.statusText})</span>` : '';

      const name = (r.display_name || '—').replaceAll('<','&lt;').replaceAll('>','&gt;');
      const email = (r.email || '—').replaceAll('<','&lt;').replaceAll('>','&gt;');

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${email}</td>
        <td>${name}</td>
        <td>${lastSign}</td>
        <td>${lastSeen} ${online}</td>
        <td>${deviceTag}</td>
        <td>${adminTag}</td>
        <td>${statusTag}${statusNote}</td>
        <td>${expireText}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function fetchRows(){
    metaText.textContent = '讀取中…';
    // 1) RPC
    try{
      const vr = await supa.rpc('admin_users_overview');
      if (vr.error) throw vr.error;
      const rows = (vr.data || []).filter(x => x && x.id);
      metaText.textContent = `資料來源：admin_users_overview（${rows.length}）`;
      return rows;
    }catch(e){
      console.warn('[BookWide] RPC admin_users_overview 不可用，fallback profiles：', e?.message || e);
    }

    // 2) fallback profiles
    const cols = 'id, email, display_name, is_admin, is_paused, last_sign_in_at, last_seen_at, expires_at';
    const r = await supa.from('profiles').select(cols);
    if (r.error) throw r.error;
    const rows = (r.data || []).filter(x => x && x.id).map(x => ({...x, expire_source:'profiles'}));
    metaText.textContent = `資料來源：profiles（${rows.length}）`;
    return rows;
  }

  async function load(){
    tbody.innerHTML = `<tr><td class="hint" colspan="9">載入中…</td></tr>`;
    try{
      state.rows = await fetchRows();
      applyFilterAndRender();
    }catch(e){
      console.error('[BookWide] load failed:', e);
      tbody.innerHTML = `<tr><td class="hint" colspan="9">讀取失敗：${String(e?.message || e)}</td></tr>`;
      metaText.textContent = '讀取失敗';
    }
  }

  function applyFilterAndRender(){
    const kw = (q.value || '').trim().toLowerCase();
    const list = !kw ? state.rows : state.rows.filter(r => {
      const a = String(r.email || '').toLowerCase();
      const b = String(r.display_name || '').toLowerCase();
      return a.includes(kw) || b.includes(kw);
    });
    render(list);
  }

  q.addEventListener('input', applyFilterAndRender);
  btnRefresh.addEventListener('click', load);

  load();
};

main().catch(err => console.error('[BookWide] user.html R6 main() failed:', err));

  </script>
</body>
</html>


















































































































































































































