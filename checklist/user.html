<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin｜使用者清單</title>

  <style>
    :root{
      --bg:#f4f6fb;
      --card-bg:#fff;
      --muted:#6b7280;
      --border:#e5e7eb;
      --brand:#2563eb;
      --brand-soft:#e0edff;
      --online:#16a34a;
      --radius-lg:18px;
      --shadow-card:0 10px 30px rgba(15,23,42,.08);
    }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC","Microsoft JhengHei";
      background:var(--bg);
      color:#111827;
    }
    .wrap{
      max-width:1080px;
      margin:24px auto 80px;
      padding:0 16px 40px;
    }

    /* Header */
    header{
      margin-bottom:10px;
    }
    .title{
      font-size:1.5rem;
      font-weight:700;
    }
    .subtitle{
      font-size:.9rem;
      color:var(--muted);
      margin-top:4px;
    }

    /* 上方返回與 Email */
    .top-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:14px;
      margin-top:6px;
    }
    .back-btn{
      font-size:.85rem;
      color:#2563eb;
      cursor:pointer;
      text-decoration:none;
      padding:6px 14px;
      border:1px solid #2563eb;
      border-radius:999px;
      background:#fff;
    }
    .admin-mail{
      font-size:.85rem;
      color:#6b7280;
    }

    /* Tabs */
    .tabs{
      display:flex;
      gap:10px;
      margin-bottom:18px;
    }
    .tab{
      padding:8px 18px;
      border-radius:30px;
      border:1px solid #d1d5db;
      font-size:.9rem;
      background:#fff;
      color:#374151;
      text-decoration:none;
    }
    .tab.active{
      background:#2563eb;
      color:#fff;
      border-color:#2563eb;
    }

    /* 搜尋欄 */
    .card{
      background:var(--card-bg);
      border-radius:var(--radius-lg);
      padding:18px;
      box-shadow:var(--shadow-card);
    }
    .toolbar{
      display:flex;
      gap:10px;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .ipt{
      flex:1;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--border);
    }
    .btn{
      padding:8px 18px;
      border-radius:999px;
      border:1px solid #2563eb;
      background:#2563eb;
      color:#fff;
      cursor:pointer;
    }

    /* Table */
    .table-wrap{
      max-height:520px;
      overflow:auto;
      margin-top:10px;
    }
    table{width:100%;border-collapse:collapse;font-size:.9rem;min-width:750px;}
    th,td{
      padding:10px 8px;
      border-bottom:1px solid var(--border);
    }
    th{
      background:#f9fafb;
      text-align:left;
      position:sticky;
      top:0;
      font-size:.8rem;
      color:#6b7280;
    }
    td.email{font-family:Consolas, monospace;}

    .pill{
      padding:3px 10px;
      border-radius:999px;
      border:1px solid #d1d5db;
      font-size:.78rem;
      white-space:nowrap;
    }
    .pill-online{background:#ecfdf5;border-color:#bbf7d0;color:#166534;}
    .pill-offline{background:#f3f4f6;color:#6b7280;}
    .pill-admin{background:#e0edff;border-color:#93c5fd;color:#1d4ed8;}
    .pill-status-active{background:#ecfdf3;border-color:#86efac;color:#166534;}
    .pill-status-none{background:#fff7ed;border-color:#fdba74;color:#c2410c;}

    .empty{text-align:center;color:#6b7280;padding:18px 0;}
  </style>
</head>

<body>
<div class="wrap">

  <!-- Header -->
  <header>
    <div class="title">BookWide Admin｜使用者清單</div>
    <div class="subtitle">查看所有使用者登入紀錄、在線狀態與訂閱期限。</div>
  </header>

  <!-- 返回 + email -->
  <div class="top-row">
    <a href="/admin.html" class="back-btn">← 回上頁</a>
    <div class="admin-mail">管理員：<span id="adminEmail">檢查中…</span></div>
  </div>

  <!-- 只保留一個 tab（依你畫掉紅線） -->
  <nav class="tabs">
    <a class="tab active">使用者清單</a>
  </nav>

  <!-- 主卡片 -->
  <section class="card">

    <div class="toolbar">
      <input id="searchInput" class="ipt" placeholder="搜尋 Email / 顯示名稱…">
      <button id="refreshBtn" class="btn">重新整理</button>
    </div>

    <div style="margin-top:8px;font-size:.8rem;color:var(--muted);">
      資料表：<code>public.profiles</code>・台灣時區顯示・10 分鐘內視為「在線」
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>#</th><th>Email</th><th>顯示名稱</th>
            <th>最後登入</th><th>最近在線</th><th>管理員</th>
            <th>狀態</th><th>到期日</th>
          </tr>
        </thead>
        <tbody id="userTbody">
          <tr><td colspan="8" class="empty">讀取中…</td></tr>
        </tbody>
      </table>
    </div>

  </section>

</div>

<!-- Supabase + Admin 守門 -->
<script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
<script>
  const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
  const SUPABASE_ANON =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";

  const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  async function requireAdmin() {
    const { data:{session} } = await supa.auth.getSession();
    if (!session) {
      alert("請先登入");
      location.href = "/index.html";
      throw 0;
    }
    const { data: prof } = await supa
      .from("profiles")
      .select("email,is_admin,is_paused")
      .eq("id", session.user.id)
      .single();

    if (!prof || !prof.is_admin || prof.is_paused) {
      alert("沒有後台權限");
      location.href = "/index.html";
      throw 0;
    }

    document.getElementById("adminEmail").textContent = prof.email;
  }

  // 資料處理 ---------------------------
  const tbody = document.getElementById("userTbody");
  const searchInput = document.getElementById("searchInput");

  function toTwString(t){
    if(!t) return "";
    const d = new Date(t);
    return d.toLocaleString("zh-TW",{hour12:false,timeZone:"Asia/Taipei"});
  }

  async function loadProfiles(){
    tbody.innerHTML=`<tr><td colspan="8" class="empty">讀取中…</td></tr>`;
    const { data, error } = await supa.from("profiles").select("*").order("last_login_at",{ascending:false});
    if(error){
      tbody.innerHTML=`<tr><td colspan="8" class="empty">讀取失敗，請稍後再試。</td></tr>`;
      return;
    }
    render(data);
    window._raw = data;
  }

  function render(list){
    tbody.innerHTML=list.map((p,i)=>{
      const email=p.email||"";
      const name=p.display_name||p.nickname||email.split("@")[0];
      const lastLogin=toTwString(p.last_login_at);
      const lastSeen=toTwString(p.last_seen_at);
      const now=new Date();
      const online = p.last_seen_at && (now - new Date(p.last_seen_at) < 10*60000);

      const adminPill = p.is_admin
        ? `<span class="pill pill-admin">管理員</span>`
        : `<span class="pill pill-offline">一般</span>`;

      const statusPill = p.sub_end_at
        ? `<span class="pill pill-status-active">有效</span>`
        : `<span class="pill pill-status-none">未訂閱</span>`;

      return `
      <tr>
        <td>${i+1}</td>
        <td class="email">${email}</td>
        <td>${name}</td>
        <td>${lastLogin||"—"}</td>
        <td><span class="pill ${online?'pill-online':'pill-offline'}">${online?'在線':'離線'}</span></td>
        <td>${adminPill}</td>
        <td>${statusPill}</td>
        <td>${p.sub_end_at?toTwString(p.sub_end_at):"—"}</td>
      </tr>`;
    }).join("");
  }

  // 搜尋功能
  searchInput.addEventListener("input",()=>{
    const kw=searchInput.value.trim().toLowerCase();
    if(!kw){ render(window._raw||[]); return; }
    const f=(window._raw||[]).filter(p=>{
      return p.email.toLowerCase().includes(kw)
          || (p.display_name||"").toLowerCase().includes(kw);
    });
    render(f);
  });

  // 初始化 -----------------------------
  requireAdmin().then(loadProfiles);
  document.getElementById("refreshBtn").onclick=loadProfiles;
</script>
</body>
</html>
