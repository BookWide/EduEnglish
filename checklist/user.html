<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin｜使用者清單</title>
  <style>
    :root{
      --bg:#f4f6fb;
      --card-bg:#fff;
      --muted:#6b7280;
      --border:#e5e7eb;
      --brand:#2563eb;
      --brand-soft:#e0edff;
      --danger:#b91c1c;
      --ok:#15803d;
      --radius-lg:18px;
      --shadow-card:0 10px 30px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif;
      background:var(--bg);
      color:#111827;
    }
    .wrap{
      max-width:1100px;
      margin:24px auto 40px;
      padding:0 16px 40px;
    }
    h1{
      font-size:24px;
      margin:0 0 4px;
      font-weight:700;
    }
    .sub{
      margin:0 0 16px;
      color:var(--muted);
      font-size:14px;
    }
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
      gap:12px;
    }
    .back{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-size:14px;
      text-decoration:none;
      color:#111827;
    }
    .back span{font-size:18px;}
    .tabs{
      display:flex;
      gap:8px;
      margin:8px 0 16px;
      flex-wrap:wrap;
    }
    .tab{
      padding:8px 16px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-size:14px;
      text-decoration:none;
      color:#111827;
    }
    .tab.active{
      background:var(--brand);
      color:#fff;
      border-color:var(--brand);
    }
    .card{
      background:var(--card-bg);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-card);
      padding:18px 18px 12px;
    }
    .card-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
      flex-wrap:wrap;
    }
    .search-group{
      display:flex;
      align-items:center;
      gap:8px;
      flex:1;
      min-width:220px;
    }
    #q{
      flex:1;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:14px;
    }
    #btnRefresh{
      padding:8px 14px;
      border-radius:999px;
      border:0;
      background:var(--brand);
      color:#fff;
      font-size:14px;
      cursor:pointer;
      white-space:nowrap;
    }
    .meta{
      font-size:12px;
      color:var(--muted);
      margin-bottom:10px;
      line-height:1.6;
    }
    .meta b{color:#374151;}
    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }
    thead th{
      text-align:left;
      padding:8px 6px;
      border-bottom:1px solid var(--border);
      color:#4b5563;
      white-space:nowrap;
      background:#f9fafb;
    }
    tbody td{
      padding:7px 6px;
      border-bottom:1px solid #f1f5f9;
      vertical-align:middle;
    }
    tbody tr:nth-child(even){
      background:#fbfcff;
    }
    .hint{
      text-align:center;
      padding:18px 8px;
      color:var(--muted);
      font-size:13px;
    }
    .pill{
      display:inline-flex;
      padding:2px 9px;
      border-radius:999px;
      border:1px solid #d1d5db;
      font-size:12px;
      align-items:center;
      gap:4px;
      white-space:nowrap;
    }
    .pill.ok{
      border-color:var(--ok);
      color:var(--ok);
      background:#ecfdf3;
    }
    .pill.warn{
      border-color:#ea580c;
      color:#c2410c;
      background:#fff7ed;
    }
    .pill.online{
      border-color:var(--ok);
      color:var(--ok);
      background:#ecfdf3;
    }
    .pill.offline{
      border-color:#9ca3af;
      color:#4b5563;
      background:#f9fafb;
    }
    .pill-admin{
      background:var(--brand-soft);
      border-color:var(--brand);
      color:#1d4ed8;
    }
    .admin-info{
      font-size:13px;
      color:var(--muted);
    }
    .admin-info b{color:#111827;}

    @media (max-width:720px){
      thead{display:none;}
      table,tbody,tr,td{display:block;width:100%;}
      tbody tr{margin-bottom:8px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;}
      tbody td{
        border-bottom:0;
        padding:5px 10px;
      }
      tbody td::before{
        content:attr(data-label);
        display:inline-block;
        min-width:80px;
        margin-right:4px;
        color:#6b7280;
      }
    }
  </style>

  <!-- 載入 supa.js（會把 BW 掛到 window.BW） -->
  <script type="module" src="../supa.js?v=20251109g"></script>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <a class="back" href="../admin.html"><span>←</span> 回上頁</a>
      <div class="admin-info">管理員：<b id="adminEmail">讀取中…</b></div>
    </div>

    <h1>BookWide Admin｜使用者清單</h1>
    <p class="sub">查看所有使用者登入紀錄、在線狀態與訂閱期限。</p>

    <div class="tabs">
      <a class="tab active" href="user.html">使用者清單</a>
    </div>

    <div class="card">
      <div class="card-head">
        <div class="search-group">
          <input id="q" placeholder="搜尋 Email / 顯示名稱…" />
          <button id="btnRefresh">重新整理</button>
        </div>
      </div>

      <div class="meta">
        資料來源：<b>public.profiles + public.orders</b>（自動合併不漏人）<br>
        合併鍵：<b>orders.buyer_id</b>（⚠️ 你的 orders 沒有 buyer_email 欄位，所以不再做 buyer_email 容錯）<br>
        台灣時區顯示．10 分鐘內視為「使用中」。
      </div>

      <div style="overflow-x:auto;">
        <table id="usersTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Email</th>
              <th>顯示名稱</th>
              <th>最後登入</th>
              <th>最近在線</th>
              <th>管理員</th>
              <th>狀態</th>
              <th>到期日</th>
            </tr>
          </thead>
          <tbody>
            <tr><td class="hint" colspan="8">載入中…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    const ready = () => new Promise(r=>{
      if (window.BW && window.BW.supa) return r();
      const t=setInterval(()=>{
        if (window.BW && window.BW.supa){ clearInterval(t); r(); }
      },50);
    });

    await ready();
    await BW.requireAdmin();
    BW.startHeartbeat(2);

    const supa = BW.supa;
    const $  = (q,root=document)=>root.querySelector(q);

    const fmtTW = (ts) => !ts ? '' :
      new Date(ts).toLocaleString('zh-TW',{timeZone:'Asia/Taipei',hour12:false});

    try{
      const { data:{user} } = await supa.auth.getUser();
      if(user?.email) $('#adminEmail').textContent = user.email;
    }catch(_){}

    const pillOnline = online =>
      `<span class="pill ${online?'online':'offline'}">${online?'使用中':'離線'}</span>`;

    // 取 profiles 內所有人 + orders-only（profiles 沒這個 id 的 buyer）
    async function getProfilesAndOrdersOnly(){
      // 1) profiles
      const cols = 'id, email, display_name, is_admin, is_paused, last_sign_in_at, last_seen_at, expires_at';
      const pRes = await supa.from('profiles').select(cols);
      if(pRes.error) throw new Error(pRes.error.message);

      const profiles = (pRes.data || []).filter(x=>x && x.id);

      // 2) orders（取近期足夠多筆，讓 orders-only 不漏）
      //    這裡用 expire_at desc；若你有超大量訂單可再調大 limit
      const oRes = await supa
        .from('orders')
        .select('buyer_id, status, expire_at, period, created_at')
        .order('expire_at',{ascending:false})
        .limit(500);

      if(oRes.error) throw new Error(oRes.error.message);

      const orders = oRes.data || [];

      // buyer_id -> latest order（以 expire_at 最新為準）
      const latestOrderByBuyer = {};
      for(const o of orders){
        if(!o?.buyer_id) continue;
        if(!latestOrderByBuyer[o.buyer_id]) latestOrderByBuyer[o.buyer_id] = o;
      }

      // 3) 找出 orders-only：buyer_id 不在 profiles
      const profileIdSet = new Set(profiles.map(p=>p.id));
      const ordersOnlyIds = Object.keys(latestOrderByBuyer).filter(id => !profileIdSet.has(id));

      const ordersOnlyProfiles = ordersOnlyIds.map(id => ({
        id,
        email: `ID:${String(id).slice(0,8)}…`,
        display_name: '訂閱用戶',
        is_admin: false,
        is_paused: false,
        last_sign_in_at: null,
        last_seen_at: null,
        expires_at: null,
        __orders_only: true
      }));

      return { profiles: profiles.concat(ordersOnlyProfiles), latestOrderByBuyer };
    }

    function computeOnline(x){
      const now = new Date();

      const seenOnline = BW.isOnlineWithin(x.last_seen_at, 10);
      let loginOnline = false;

      if(!seenOnline && x.last_sign_in_at){
        const lastLogin = new Date(x.last_sign_in_at);
        if(!isNaN(lastLogin)){
          const diffMs = now - lastLogin;
          if(diffMs >= 0 && diffMs <= 30*60*1000) loginOnline = true;
        }
      }
      return (seenOnline || loginOnline);
    }

    function renderStatusAndExpire(x, ord){
      const now = new Date();
      let expireText = '—';
      let statusHtml = '<span class="pill warn">未訂閱</span>';

      if(ord && ord.expire_at){
        const exp = new Date(ord.expire_at);
        const start = ord.created_at ? new Date(ord.created_at) : null;

        const startStr = (start && !isNaN(start)) ? fmtTW(start.toISOString()) : '—';
        const endStr = (!isNaN(exp)) ? fmtTW(exp.toISOString()) : '—';

        expireText = endStr;

        if(!isNaN(exp)){
          if(exp > now){
            statusHtml = `<span class="pill ok">有效（期間：${startStr} → ${endStr}）</span>`;
          }else{
            statusHtml = `<span class="pill warn">已到期（${endStr}）</span>`;
          }
        }
      }else if(x.expires_at){
        const exp = new Date(x.expires_at);
        const endStr = !isNaN(exp) ? fmtTW(exp.toISOString()) : '—';
        expireText = endStr;

        if(!isNaN(exp)){
          if(exp > now){
            statusHtml = `<span class="pill ok">有效（profiles.expires_at）</span>`;
          }else{
            statusHtml = `<span class="pill warn">已到期（profiles：${endStr}）</span>`;
          }
        }
      }

      return { expireText, statusHtml };
    }

    async function loadUsers(){
      const tbody = $('#usersTable tbody');
      tbody.innerHTML = '<tr><td class="hint" colspan="8">載入中…</td></tr>';

      try{
        const { profiles, latestOrderByBuyer } = await getProfilesAndOrdersOnly();

        if(!profiles.length){
          tbody.innerHTML = '<tr><td class="hint" colspan="8">目前沒有任何使用者</td></tr>';
          return;
        }

        const q = ($('#q').value||'').trim().toLowerCase();
        let rows = profiles.filter(x=>{
          if(!q) return true;
          return (x.email||'').toLowerCase().includes(q)
              || (x.display_name||'').toLowerCase().includes(q);
        });

        if(!rows.length){
          tbody.innerHTML = '<tr><td class="hint" colspan="8">沒有符合的資料</td></tr>';
          return;
        }

        // 計算在線
        rows = rows.map(x => ({...x, __online: computeOnline(x)}));

        // 排序：管理員 → 使用中 → 有效訂閱 → 最近活動 → Email
        rows.sort((a,b)=>{
          const aAdmin = a.is_admin ? 1 : 0, bAdmin = b.is_admin ? 1 : 0;
          if(aAdmin !== bAdmin) return bAdmin - aAdmin;

          const aOn = a.__online ? 1 : 0, bOn = b.__online ? 1 : 0;
          if(aOn !== bOn) return bOn - aOn;

          const aOrd = latestOrderByBuyer[a.id];
          const bOrd = latestOrderByBuyer[b.id];
          const aExp = aOrd?.expire_at ? new Date(aOrd.expire_at).getTime() : 0;
          const bExp = bOrd?.expire_at ? new Date(bOrd.expire_at).getTime() : 0;
          if(aExp !== bExp) return bExp - aExp;

          const aTs = new Date(a.last_seen_at || a.last_sign_in_at || 0).getTime() || 0;
          const bTs = new Date(b.last_seen_at || b.last_sign_in_at || 0).getTime() || 0;
          if(aTs !== bTs) return bTs - aTs;

          return String(a.email||'').localeCompare(String(b.email||''));
        });

        tbody.innerHTML = rows.map((x,idx)=>{
          const ord = latestOrderByBuyer[x.id] || null;
          const { expireText, statusHtml } = renderStatusAndExpire(x, ord);

          return `
            <tr>
              <td data-label="#">${idx+1}</td>
              <td data-label="Email">${x.email||''}${x.__orders_only ? ' <span class="pill">orders-only</span>' : ''}</td>
              <td data-label="顯示名稱">${x.display_name||''}</td>
              <td data-label="最後登入">${fmtTW(x.last_sign_in_at)||''}</td>
              <td data-label="最近在線">${fmtTW(x.last_seen_at)||''} &nbsp; ${pillOnline(!!x.__online)}</td>
              <td data-label="管理員">${x.is_admin ? '<span class="pill pill-admin">管理員</span>' : ''}</td>
              <td data-label="狀態">${statusHtml}</td>
              <td data-label="到期日">${expireText}</td>
            </tr>`;
        }).join('');

      }catch(e){
        tbody.innerHTML = `<tr><td class="hint" colspan="8">讀取失敗：${e.message||e}</td></tr>`;
      }
    }

    $('#btnRefresh').addEventListener('click', loadUsers);

    let t=null;
    $('#q').addEventListener('input', ()=>{
      clearTimeout(t);
      t=setTimeout(loadUsers, 250);
    });

    loadUsers();
  </script>
</body>
</html>










