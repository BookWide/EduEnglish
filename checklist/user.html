<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin｜使用者清單</title>
  <style>
    :root{
      --bg:#f4f6fb;
      --card-bg:#fff;
      --muted:#6b7280;
      --border:#e5e7eb;
      --brand:#2563eb;
      --brand-soft:#e0edff;
      --danger:#b91c1c;
      --radius-lg:18px;
      --shadow-card:0 10px 30px rgba(15,23,42,.08);
      --online:#16a34a;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC","Microsoft JhengHei",sans-serif;
      background:var(--bg);
      color:#111827;
    }
    .wrap{
      max-width:1080px;
      margin:24px auto 80px;
      padding:0 16px 40px;
    }
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:16px;
    }
    .title{
      font-size:1.4rem;
      font-weight:700;
    }
    .subtitle{
      font-size:.9rem;
      color:var(--muted);
      margin-top:4px;
    }
    .tag-ver{
      display:inline-flex;
      align-items:center;
      padding:4px 10px;
      border-radius:999px;
      background:var(--brand-soft);
      color:#1e40af;
      font-size:.8rem;
    }

    /* tabs */
    .tabs{
      display:flex;
      gap:12px;
      margin-bottom:16px;
      flex-wrap:wrap;
    }
    .tab{
      padding:8px 18px;
      border:1px solid #d1d5db;
      border-radius:999px;
      background:#fff;
      color:#374151;
      text-decoration:none;
      font-size:.9rem;
    }
    .tab.active{
      background:var(--brand);
      border-color:var(--brand);
      color:#fff;
    }
    .tab:hover{
      background:#f3f4f6;
    }

    /* card + toolbar */
    .card{
      background:var(--card-bg);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-card);
      padding:18px 18px 10px;
    }
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .search-row{
      display:flex;
      align-items:center;
      gap:8px;
      flex:1 1 260px;
    }
    .ipt{
      flex:1 1 0;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:.9rem;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:7px 16px;
      border-radius:999px;
      border:1px solid var(--brand);
      background:var(--brand);
      color:#fff;
      font-size:.9rem;
      cursor:pointer;
      text-decoration:none;
      white-space:nowrap;
    }
    .btn-outline{
      background:#fff;
      color:var(--brand);
    }
    .hint{
      font-size:.8rem;
      color:var(--muted);
      margin-top:4px;
    }

    /* table */
    .table-wrap{
      max-height:520px;
      overflow:auto;
      margin-top:8px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:.9rem;
      min-width:720px;
    }
    th,td{
      padding:9px 8px;
      border-bottom:1px solid var(--border);
      vertical-align:middle;
    }
    th{
      text-align:left;
      font-weight:600;
      color:var(--muted);
      font-size:.8rem;
      white-space:nowrap;
      background:#f9fafb;
      position:sticky;
      top:0;
      z-index:1;
    }
    td.email{
      font-family:Consolas,monospace;
      font-size:.86rem;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      border-radius:999px;
      padding:2px 10px;
      font-size:.78rem;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      color:#4b5563;
      white-space:nowrap;
    }
    .pill-online{
      border-color:rgba(22,163,74,.2);
      background:rgba(22,163,74,.06);
      color:var(--online);
    }
    .pill-offline{
      border-color:#e5e7eb;
      background:#f9fafb;
      color:#6b7280;
    }
    .pill-admin{
      border-color:#1d4ed8;
      background:#e0edff;
      color:#1d4ed8;
    }
    .pill-status-none{
      border-color:#f97316;
      background:#fff7ed;
      color:#c2410c;
    }
    .pill-status-active{
      border-color:#16a34a;
      background:#ecfdf3;
      color:#166534;
    }
    .text-muted{
      color:#6b7280;
      font-size:.8rem;
    }
    .empty{
      padding:20px 0;
      text-align:center;
      color:var(--muted);
      font-size:.9rem;
    }
    @media (max-width:768px){
      .wrap{margin-top:16px;}
      .toolbar{align-items:stretch;}
      .search-row{flex:1 1 100%;}
      .table-wrap{max-height:calc(100vh - 220px);}
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <div class="title">BookWide Admin｜使用者清單</div>
      <div class="subtitle">查看所有使用者的登入紀錄、在線狀態與訂閱期限。</div>
    </div>
    <div class="tag-ver">三分頁 · 內嵌 Supabase · v20251106</div>
  </header>

  <!-- 三分頁選單：checklist 目錄內相互切換 -->
  <nav class="tabs">
    <a href="user.html" class="tab active">使用者清單</a>
    <a href="authorize.html" class="tab">授權 / 暫停管理員</a>
    <a href="upload.html" class="tab">MP4 上傳</a>
  </nav>

  <section class="card">
    <div class="toolbar">
      <div class="search-row">
        <input id="searchInput" class="ipt" type="search"
               placeholder="搜尋 Email / 顯示名稱…">
        <button class="btn" id="refreshBtn">重新整理</button>
      </div>
      <div class="text-muted">
        資料表：<code>public.profiles</code><br>
        台灣時區顯示・10 分鐘內視為「在線」
      </div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="width:36px;">#</th>
            <th>Email</th>
            <th>顯示名稱</th>
            <th>最後登入</th>
            <th>最近在線</th>
            <th>管理員</th>
            <th>狀態</th>
            <th>到期日</th>
          </tr>
        </thead>
        <tbody id="userTbody">
          <tr><td colspan="8" class="empty">讀取中…</td></tr>
        </tbody>
      </table>
    </div>

    <div class="hint" id="summaryHint"></div>
  </section>
</div>

<!-- Supabase JS v2（CDN 版） -->
<script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
<script>
  // === Supabase 設定（沿用你現有專案） ===
  const SUPABASE_URL = 'https://jeajrwpmrgczimmrflxo.supabase.co';
  const SUPABASE_ANON_KEY =
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do';

  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const tbody = document.getElementById('userTbody');
  const searchInput = document.getElementById('searchInput');
  const summaryHint = document.getElementById('summaryHint');
  let fullData = [];

  function toTwString(value) {
    if (!value) return '';
    const d = new Date(value);
    if (isNaN(d.getTime())) return '';
    return d.toLocaleString('zh-TW', {
      timeZone: 'Asia/Taipei',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: false
    }).replace(/\//g,'/');
  }

  function minutesDiff(a, b) {
    return (a.getTime() - b.getTime()) / 60000;
  }

  function renderTable(data) {
    if (!data || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" class="empty">目前尚無資料。</td></tr>';
      summaryHint.textContent = '';
      return;
    }

    const now = new Date();
    const rows = data.map((p, idx) => {
      const email = p.email || '';
      const name = p.display_name || p.nickname || email.split('@')[0] || '';
      const lastLogin = toTwString(p.last_login_at);
      const lastOnline = toTwString(p.last_seen_at || p.last_online_at);

      // 判斷在線 / 離線（10 分鐘內）
      let onlinePill = '';
      if (lastOnline) {
        const last = new Date(p.last_seen_at || p.last_online_at);
        const diffMin = minutesDiff(now, last);
        const isOnline = diffMin >=0 && diffMin <= 10;
        onlinePill = `<span class="pill ${isOnline ? 'pill-online' : 'pill-offline'}">
          ${isOnline ? '在線' : '離線'}
        </span>`;
      } else {
        onlinePill = '<span class="pill pill-offline">—</span>';
      }

      // 管理員
      const isAdmin = !!p.is_admin;
      const isPaused = !!p.is_paused;
      let adminPill = isAdmin
        ? '<span class="pill pill-admin">管理員</span>'
        : '<span class="pill pill-offline">一般</span>';

      if (isPaused) {
        adminPill += ' <span class="pill pill-status-none">已暫停</span>';
      }

      // 訂閱狀態與到期日
      const start = p.sub_start_at || p.subscription_start_at;
      const end = p.sub_end_at || p.subscription_end_at;
      let statusHtml = '';
      let endStr = '';

      if (end) {
        const endDate = new Date(end);
        endStr = toTwString(end);
        const isValid = endDate.getTime() > now.getTime();
        const startStr = start ? toTwString(start) : '';
        const text = startStr
          ? `有效（期限：${startStr} → ${endStr}）`
          : `有效（到期：${endStr}）`;
        statusHtml = `<span class="pill pill-status-active">${text}</span>`;
      } else {
        statusHtml = '<span class="pill pill-status-none">未訂閱</span>';
      }

      return `
        <tr>
          <td>${idx + 1}</td>
          <td class="email">${email}</td>
          <td>${name}</td>
          <td>${lastLogin || '<span class="text-muted">—</span>'}</td>
          <td>${onlinePill}</td>
          <td>${adminPill}</td>
          <td>${statusHtml}</td>
          <td>${endStr || '<span class="text-muted">—</span>'}</td>
        </tr>
      `;
    });

    tbody.innerHTML = rows.join('');
    summaryHint.textContent = `共 ${data.length} 位使用者（顯示中），全部 ${fullData.length} 筆。`;
  }

  function applyFilter() {
    const kw = (searchInput.value || '').trim().toLowerCase();
    if (!kw) {
      renderTable(fullData);
      return;
    }
    const filtered = fullData.filter(p => {
      const email = (p.email || '').toLowerCase();
      const name = (p.display_name || p.nickname || '').toLowerCase();
      return email.includes(kw) || name.includes(kw);
    });
    renderTable(filtered);
  }

  async function loadProfiles() {
    tbody.innerHTML = '<tr><td colspan="8" class="empty">讀取中…</td></tr>';
    summaryHint.textContent = '';

    // 這裡直接 select *，欄位名稱請在資料表中維持：
    // email, display_name/nickname, last_login_at, last_seen_at 或 last_online_at,
    // is_admin, is_paused, sub_start_at/sub_end_at 或 subscription_start_at/subscription_end_at
    const { data, error } = await client
      .from('profiles')
      .select('*')
      .order('last_login_at', { ascending:false });

    if (error) {
      console.error(error);
      tbody.innerHTML =
        '<tr><td colspan="8" class="empty">讀取失敗，請稍後再試。</td></tr>';
      summaryHint.textContent = '';
      return;
    }

    fullData = data || [];
    renderTable(fullData);
  }

  document.getElementById('refreshBtn').addEventListener('click', loadProfiles);
  searchInput.addEventListener('input', applyFilter);

  // 初次載入
  loadProfiles();
</script>
</body>
</html>
