<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/><title>é‡ç”¢å°ˆå®¶ V47 - åµéŒ¯æ¢å¾©ç‰ˆ</title>
<style>
  :root{ --bg:#050a14; --panel:#111827; --text:#f3f4f6; --ok:#10b981; --err:#ef4444; --btn:#3b82f6; --line:#374151; }
  body{ background:var(--bg); color:var(--text); font-family: system-ui; padding:20px; }
  .card{ background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:20px; margin-bottom:20px; }
  textarea, select, input { width:100%; background:#000; border:1px solid var(--line); color:#22c55e; border-radius:10px; padding:12px; outline:none; }
  .btn{ background:var(--btn); color:white; border:none; padding:15px; border-radius:10px; cursor:pointer; font-weight:bold; width:100%; }
  .log { background:#000; color:var(--err); font-family: monospace; padding:10px; border-radius:5px; font-size:12px; margin-top:10px; display:none; }
</style>
</head>
<body onload="init()">

<div class="card">
  <h1>ğŸ¬ é‡ç”¢å·¥å»  V47 (é–å®šèˆ‡åµéŒ¯ç‰ˆ)</h1>
  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
    <div>
      <label>1. ä¸»è§’ç‰¹å¾µ (é–å®šä¸­)</label>
      <textarea id="charSpec" rows="3" oninput="save()"></textarea>
    </div>
    <div>
      <label>2. åƒè€ƒåœ–ç¶²å€ (é–å®šä¸­)</label>
      <textarea id="imgRef" rows="3" oninput="save()"></textarea>
    </div>
  </div>
  <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px;">
    <select id="vStyle" onchange="save()"><option value="Epic cinematic">å²è©©é›»å½±</option><option value="Ink painting">æ°´å¢¨</option></select>
    <select id="density" onchange="save()"><option value="1">1å¥ä¸€åœ–</option><option value="5" selected>5å¥ä¸€åœ–</option></select>
    <input type="file" onchange="run(this)" />
  </div>
</div>

<div id="debugLog" class="log"></div>

<table id="list" style="width:100%; border-collapse:collapse;">
  <thead><tr style="color:#94a3b8;"><th>ID</th><th>åŠ‡æœ¬</th><th>æŒ‡ä»¤</th><th>æ“ä½œ</th></tr></thead>
  <tbody></tbody>
</table>

<script>
const KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
const IMG_API = "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/img-one";
const TTS_API = "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/tts-mp3";

function init(){ ['charSpec','imgRef','vStyle','density'].forEach(k=>{if(localStorage.getItem('v47_'+k))document.getElementById(k).value=localStorage.getItem('v47_'+k);}); }
function save(){ ['charSpec','imgRef','vStyle','density'].forEach(k=>{localStorage.setItem('v47_'+k, document.getElementById(k).value);}); }

async function run(input) {
  const text = await input.files[0].text();
  const step = parseInt(document.getElementById('density').value);
  const items = text.match(/(\d+)\s+(\d{2}:\d{2}:\d{2},\d{3} --> \d{2}:\d{2}:\d{2},\d{3})\s+([\s\S]*?)(?=\n\d+\s+\d{2}:\d{2}:\d{2},\d{3} -->|$)/g);
  const tbody = document.querySelector('#list tbody');
  tbody.innerHTML = "";
  
  for(let i=0; i<items.length; i+=step) {
    const chunk = items.slice(i, i+step).map(x => x.split('\n')[2]).join(" ");
    const id = `Task_${i}`;
    const prompt = `Ref: ${document.getElementById('imgRef').value}. Scene: ${chunk}. Char: ${document.getElementById('charSpec').value}.`;
    tbody.innerHTML += `<tr><td>${id}</td><td><textarea id="t_${id}">${chunk}</textarea></td><td><textarea id="p_${id}">${prompt}</textarea></td><td><button class="btn" onclick="gen('${id}')">ç”¢å‡º</button></td></tr>`;
  }
}

async function gen(id) {
  const log = document.getElementById('debugLog');
  log.style.display = "none";
  try {
    const res = await fetch(IMG_API, {
      method: "POST",
      headers: { "Content-Type":"application/json", "apikey":KEY, "Authorization":"Bearer "+KEY },
      body: JSON.stringify({ prompt: document.getElementById('p_'+id).value, model: "imagen-3" })
    });
    
    if(!res.ok) {
      const errTxt = await res.text();
      log.innerText = `éŒ¯èª¤è¨ºæ–·ï¼šAPI å›å‚³ç‹€æ…‹ ${res.status}ã€‚è©³ç´°å…§å®¹ï¼š${errTxt}`;
      log.style.display = "block";
      return;
    }
    
    const blob = await res.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${id}.png`;
    a.click();
  } catch(e) {
    log.innerText = `ç¶²è·¯é€£ç·šéŒ¯èª¤ï¼š${e.message}`;
    log.style.display = "block";
  }
}
</script>
</body>
</html>
