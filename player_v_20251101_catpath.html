<!-- player_v20251101-catpath.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BookWide Player</title>
</head>
<body>
  <!-- 保留原有結構，僅示意重點修改 -->
  <video id="player" controls></video>
  <script>
  const params = new URLSearchParams(location.search);
  const primarySlug = params.get('slug') || 'mid-autumn';
  const cat = (params.get('cat') || 'story').toLowerCase();
  const DATA_BASE  = `./data/${cat}/`;
  const VIDEO_BASE = `./videos/${cat}/`;

  async function fetchWithFallback(primary, fallback, kind){
    try {
      const r = await fetch(primary, {cache:'no-store'});
      if(r.ok) return {data:await r.json(), used:primary};
    }catch(e){ console.warn(e); }
    const r2 = await fetch(fallback, {cache:'no-store'});
    return {data:await r2.json(), used:fallback};
  }

  async function loadVideo(){
    const video=document.getElementById('player');
    video.src = `${VIDEO_BASE}${primarySlug}.mp4`;
    video.addEventListener('error', ()=>{ video.src = `${VIDEO_BASE}mid-autumn.mp4`; }, { once:true });
  }

  async function loadCues(){
    const {data,used}=await fetchWithFallback(`${DATA_BASE}cues-${primarySlug}.json?v=${Date.now()}`, `${DATA_BASE}cues-mid-autumn.json?v=${Date.now()}`, 'cues');
    console.log('[cues] loaded', used, data.length);
  }

  async function loadQuiz(){
    const {data,used}=await fetchWithFallback(`${DATA_BASE}quiz-${primarySlug}.json?v=${Date.now()}`, `${DATA_BASE}quiz-mid-autumn.json?v=${Date.now()}`, 'quiz');
    console.log('[quiz] loaded', used, data.length);
  }

  async function loadVocab(){
    const {data,used}=await fetchWithFallback(`${DATA_BASE}vocab-${primarySlug}.json?v=${Date.now()}`, `${DATA_BASE}vocab-mid-autumn.json?v=${Date.now()}`, 'vocab');
    console.log('[vocab] loaded', used, data.length);
  }

  loadVideo();
  loadCues();
  loadQuiz();
  loadVocab();
  </script>
</body>
</html>
