<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Talk · Mobile Lite MVP</title>
<style>
  :root{--bg:#0b0f14;--card:#111827;--muted:#94a3b8;--fg:#e5e7eb;--accent:#3b82f6;--line:#1f2937;}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Helvetica Neue",Arial;}
  *{box-sizing:border-box;}
  header{position:sticky;top:0;z-index:20;background:rgba(11,15,20,.92);backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid var(--line);}
  .bar{display:flex;align-items:center;gap:10px;padding:10px 12px;}
  .back{width:36px;height:28px;border-radius:10px;border:1px solid var(--line);background:#0f172a;color:var(--fg);font-weight:700;}
  .sel{display:flex;gap:8px;align-items:center;min-width:0;flex:1;}
  select{appearance:none;-webkit-appearance:none;border:1px solid var(--line);background:#0f172a;color:var(--fg);border-radius:12px;padding:8px 10px;font-weight:700;max-width:48vw;}
  .prog{margin-left:auto;font-weight:800;color:#93c5fd;}
  main{padding:14px 12px 18px;}
  .card{background:linear-gradient(180deg,rgba(17,24,39,.96),rgba(17,24,39,.86));border:1px solid var(--line);border-radius:18px;padding:14px;margin-bottom:12px;}
  .row{display:flex;gap:12px;align-items:flex-start;}
  .avatar{width:52px;height:52px;border-radius:18px;background:#0f172a;border:1px solid var(--line);flex:0 0 auto;overflow:hidden}
  .avatar img{width:100%;height:100%;object-fit:cover;display:block}
  .bubble{min-width:0;flex:1;}
  .en{font-size:22px;line-height:1.15;font-weight:900;letter-spacing:.2px;word-break:break-word;}
  .sub{margin-top:6px;color:var(--muted);font-weight:700;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%;}
  .hint{margin-top:10px;color:var(--muted);font-size:13px;line-height:1.35;}
  .choices{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
  .choices button{border:1px solid var(--line);background:#0f172a;color:#60a5fa;border-radius:999px;padding:10px 16px;font-weight:800;font-size:18px}
  .answerBox{margin-top:12px;border:1px solid var(--line);background:#0f172a;border-radius:16px;padding:12px 14px;font-size:18px;font-weight:800;min-height:44px;display:flex;align-items:center;word-break:break-word;}
  .actions{display:flex;gap:12px;margin-top:12px;}
  .primary{flex:1;border:0;border-radius:16px;background:linear-gradient(180deg,#3b82f6,#2563eb);color:white;font-weight:900;padding:14px 16px;font-size:18px}
  .ghost{flex:0 0 auto;border:1px solid var(--line);border-radius:16px;background:#0f172a;color:var(--fg);font-weight:900;padding:14px 18px;font-size:18px}
  .err{color:#fca5a5;font-weight:800;font-size:13px;margin-top:10px;white-space:pre-wrap}
  /* mobile menu text smaller */
  @media (max-width: 520px){
    select{font-size:14px;padding:7px 9px}
    .choices button{font-size:16px;padding:9px 14px}
    .en{font-size:20px}
  }
</style>
</head>
<body>
<header>
  <div class="bar">
    <button class="back" onclick="history.back()">←</button>
    <div class="sel">
      <select id="weekSel" aria-label="Week"></select>
      <select id="sceneSel" aria-label="Scene"></select>
    </div>
    <div class="prog" id="prog">1/15</div>
  </div>
</header>

<main>
  <div class="card">
    <div class="row">
      <div class="avatar" aria-hidden="true">
        <img id="avatarImg" alt="" src=""/>
      </div>
      <div class="bubble">
        <div class="en" id="teacherLine">Loading...</div>
        <div class="sub" id="meta">—</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="en" style="font-size:18px;font-weight:900;margin-bottom:6px">你的回覆</div>
    <div class="hint" id="hint">先用「填空」完成一句，再改成你自己的說法。</div>
    <div class="choices" id="choices"></div>
    <div class="answerBox" id="answerBox">—</div>
    <div class="actions">
      <button class="primary" id="submitBtn">✅ 送出填好句</button>
      <button class="ghost" id="skipBtn">跳過</button>
    </div>
    <div class="err" id="err"></div>
  </div>
</main>

<script>
(() => {
  const state = {
    weeks: new Map(), // weekNum -> [fileUrl,...]
    week: 1,
    sceneIdx: 0,
    turnIdx: 0,
    total: 15,
    scene: null,
    answer: '',
    prompt: '',
    choices: [],
    teacher: '',
    meta: ''
  };

  const $ = (id) => document.getElementById(id);

  function baseName(u){
    try{
      const s=String(u||'');
      const p=s.split('/').pop();
      return p || s;
    }catch(e){ return String(u||''); }
  }

  function getWeekFromFile(u){
    const s=String(u||'');
    // w01.01.xxx or w108.06.xxx
    let m = s.match(/\bw(\d{1,3})\./i);
    if(m) return parseInt(m[1],10);
    m = s.match(/week\s*(\d{1,3})/i);
    if(m) return parseInt(m[1],10);
    return null;
  }

  async function fetchJsonSmart(url){
    const res = await fetch(url, {cache:'no-store'}).catch(()=>null);
    if(!res) throw new Error('Fetch failed: '+url);
    if(!res.ok) throw new Error('HTTP '+res.status+' for '+url);
    const ct = (res.headers.get('content-type')||'').toLowerCase();
    const txt = await res.text();
    // allow json even if content-type not perfect, but reject html
    if(txt.trim().startsWith('<')) throw new Error('Not JSON (got HTML) from '+url);
    try{
      return JSON.parse(txt);
    }catch(e){
      throw new Error('JSON parse error from '+url+': '+e.message);
    }
  }

  async function loadIndex(){
    // bookwide.net root: index.json is under /talk/index.json
    const candidates = [
      '/talk/index.json',
      './talk/index.json',
      '../talk/index.json',
      './index.json'
    ];
    let lastErr = null;
    for(const u of candidates){
      try{
        const j = await fetchJsonSmart(u);
        return {json:j, url:u};
      }catch(e){ lastErr = e; }
    }
    throw lastErr || new Error('No index.json found');
  }

  function normalizeIndex(idx){
    const weeks = new Map();
    const add = (w, fileUrl) => {
      if(!w || !fileUrl) return;
      if(!weeks.has(w)) weeks.set(w, []);
      weeks.get(w).push(fileUrl);
    };

    if(Array.isArray(idx)){
      for(const it of idx){
        const fileUrl = (typeof it === 'string') ? it : (it && (it.file || it.url || it.path));
        const w = getWeekFromFile(fileUrl);
        if(w) add(w, fileUrl);
      }
    }else if(idx && typeof idx === 'object'){
      // support {weeks:{1:[...]}}, {weeks:[{week:1,scenes:[...]}]}
      if(Array.isArray(idx.weeks)){
        for(const wobj of idx.weeks){
          const w = Number(wobj.week || wobj.w || wobj.id);
          const scenes = wobj.scenes || wobj.files || [];
          if(Array.isArray(scenes)){
            scenes.forEach(s => add(w, s.file || s.url || s.path || s));
          }
        }
      }else if(idx.weeks && typeof idx.weeks === 'object'){
        for(const [k,v] of Object.entries(idx.weeks)){
          const w = parseInt(k,10);
          if(Array.isArray(v)) v.forEach(s => add(w, s.file||s.url||s.path||s));
        }
      }
    }

    // sort
    for(const [w, arr] of weeks.entries()){
      const uniq = Array.from(new Set(arr));
      uniq.sort((a,b)=>baseName(a).localeCompare(baseName(b)));
      weeks.set(w, uniq);
    }
    return weeks;
  }

  function setError(msg){
    $('err').textContent = msg || '';
  }

  function setProgress(){
    const cur = Math.min(state.turnIdx+1, state.total);
    $('prog').textContent = cur + '/' + state.total;
  }

  function extractDialogue(scene){
    if(!scene || typeof scene!=='object') return [];
    const cand = scene.dialogue || scene.turns || scene.lines || scene.conversation || scene.script || [];
    if(!Array.isArray(cand)) return [];
    return cand;
  }

  function extractTeacherLine(scene, turnIdx){
    const dia = extractDialogue(scene);
    if(dia.length){
      // try pick teacher turn at/after turnIdx
      for(let i=turnIdx;i<dia.length;i++){
        const t = dia[i]||{};
        const role = (t.role||t.speaker||t.who||'').toString().toLowerCase();
        const en = t.en || t.english || t.text || t.line;
        if(en && (!role || role.includes('teacher') || role.includes('t') || role.includes('ai'))){
          return {text:String(en), meta: (t.zh||t.tw||t.cn||t.ja||'')};
        }
      }
      // fallback: any line
      const t = dia[Math.min(turnIdx, dia.length-1)] || {};
      const en = t.en || t.english || t.text || t.line || '';
      return {text:String(en||''), meta: (t.zh||t.tw||t.cn||t.ja||'')};
    }
    // other possible fields
    const en = scene.teacher || scene.teacher_line || scene.prompt_en || scene.en || scene.title || baseName(scene.__file||'');
    return {text:String(en||'—'), meta:''};
  }

  function extractCloze(scene, turnIdx){
    if(!scene || typeof scene!=='object') return null;
    const pools = [
      scene.cloze, scene.clozes, scene.quiz, scene.quizzes, scene.practice, scene.exercises, scene.questions
    ].filter(Boolean);
    let arr = null;
    for(const p of pools){
      if(Array.isArray(p)){ arr = p; break; }
    }
    if(arr && arr.length){
      const it = arr[Math.min(turnIdx, arr.length-1)] || {};
      const prompt = it.prompt || it.q || it.question || it.text || it.en || '';
      const choices = it.choices || it.options || it.words || [];
      return {prompt:String(prompt||''), choices:Array.isArray(choices)?choices.map(String):[]};
    }
    // if scene has direct prompt/choices
    if(scene.prompt || scene.question){
      const prompt = scene.prompt || scene.question;
      const choices = scene.choices || scene.options || scene.words || [];
      return {prompt:String(prompt||''), choices:Array.isArray(choices)?choices.map(String):[]};
    }
    return null;
  }

  function render(){
    // teacher
    $('teacherLine').textContent = state.teacher || '—';
    $('meta').textContent = state.meta || '';
    // answer
    $('answerBox').textContent = state.answer || state.prompt || '—';

    // choices
    const c = $('choices'); c.innerHTML = '';
    (state.choices||[]).slice(0,3).forEach(word=>{
      const b=document.createElement('button');
      b.type='button';
      b.textContent=word;
      // prevent iOS scroll-jump and keyboard focus
      b.addEventListener('touchstart', (e)=>{ e.preventDefault(); }, {passive:false});
      b.addEventListener('click', (e)=>{
        e.preventDefault();
        const y = window.scrollY;
        const base = state.answer || state.prompt || '';
        if(base.includes('____')) state.answer = base.replace('____', word);
        else if(base.includes('___')) state.answer = base.replace('___', word);
        else state.answer = base ? (base + ' ' + word) : word;
        $('answerBox').textContent = state.answer;
        requestAnimationFrame(()=>window.scrollTo(0,y));
      });
      c.appendChild(b);
    });

    setProgress();
  }

  async function loadScene(){
    setError('');
    state.turnIdx = 0;
    state.answer = '';
    $('teacherLine').textContent='Loading...';
    $('meta').textContent='—';
    $('answerBox').textContent='—';

    const files = state.weeks.get(state.week) || [];
    const fileUrl = files[state.sceneIdx];
    if(!fileUrl){
      setError('這週沒有場景資料。');
      return;
    }

    try{
      const scene = await fetchJsonSmart(fileUrl);
      scene.__file = fileUrl;
      state.scene = scene;

      // teacher line
      const t = extractTeacherLine(scene, 0);
      state.teacher = t.text || '—';
      state.meta = (t.meta ? String(t.meta) : '');

      // cloze
      const cz = extractCloze(scene, 0);
      if(cz){
        state.prompt = cz.prompt || '';
        state.choices = cz.choices || [];
      }else{
        // fallback: create prompt from teacher line
        state.prompt = '（無填空題）';
        state.choices = [];
      }

      // total progress: prefer cloze length, else dialogue length, else 15
      const dia = extractDialogue(scene);
      const czArr = (scene && (scene.cloze||scene.clozes||scene.quiz||scene.quizzes||scene.practice||scene.exercises||scene.questions));
      const czLen = Array.isArray(czArr) ? czArr.length : 0;
      state.total = Math.max(1, Math.min(15, (czLen||dia.length||15)));
      render();
    }catch(e){
      setError(String(e.message||e));
      $('teacherLine').textContent='Loading...';
    }
  }

  function fillWeekOptions(){
    const ws = Array.from(state.weeks.keys()).sort((a,b)=>a-b);
    const wsel = $('weekSel');
    wsel.innerHTML = '';
    ws.forEach(w=>{
      const opt=document.createElement('option');
      opt.value=String(w);
      opt.textContent='W'+w;
      wsel.appendChild(opt);
    });
    // keep in range
    if(!state.weeks.has(state.week)) state.week = ws[0] || 1;
    wsel.value = String(state.week);
  }

  function fillSceneOptions(){
    const ssel = $('sceneSel');
    ssel.innerHTML = '';
    const files = state.weeks.get(state.week) || [];
    files.forEach((u,i)=>{
      const opt=document.createElement('option');
      opt.value=String(i);
      opt.textContent=baseName(u).replace(/\.json$/i,'');
      ssel.appendChild(opt);
    });
    if(state.sceneIdx >= files.length) state.sceneIdx = 0;
    ssel.value = String(state.sceneIdx);
  }

  function persist(){
    try { stateToStore(); }
    catch(e){}
  }
  function stateToStore(){
    localStorage.setItem('TALK_MVP_WEEK', String(state.week));
    localStorage.setItem('TALK_MVP_SCENE', String(state.sceneIdx));
  }

  function restore(){
    const w = parseInt(localStorage.getItem('TALK_MVP_WEEK')||'1',10);
    const s = parseInt(localStorage.getItem('TALK_MVP_SCENE')||'0',10);
    if(Number.isFinite(w)) state.week = w;
    if(Number.isFinite(s)) state.sceneIdx = s;
    // URL param overrides
    const p = new URLSearchParams(location.search);
    const uw = parseInt(p.get('w')||'',10);
    const us = parseInt(p.get('s')||'',10);
    if(Number.isFinite(uw) && uw>0) state.week = uw;
    if(Number.isFinite(us) && us>=0) state.sceneIdx = us;
  }

  function hookUI(){
    $('weekSel').addEventListener('change', ()=>{
      state.week = parseInt($('weekSel').value,10) || 1;
      state.sceneIdx = 0;
      fillSceneOptions();
      persist();
      loadScene();
    });

    $('sceneSel').addEventListener('change', ()=>{
      state.sceneIdx = parseInt($('sceneSel').value,10) || 0;
      persist();
      loadScene();
    });

    // submit / skip: just advance progress + show next teacher/cloze if exists
    function advance(){
      const y = window.scrollY; // prevent scroll-jump
      state.turnIdx = Math.min(state.turnIdx+1, state.total-1);
      state.answer = '';
      const t = extractTeacherLine(state.scene, state.turnIdx);
      state.teacher = t.text || state.teacher;
      // update cloze
      const cz = extractCloze(state.scene, state.turnIdx);
      if(cz){
        state.prompt = cz.prompt || state.prompt;
        state.choices = cz.choices || state.choices;
      }
      render();
      requestAnimationFrame(()=>window.scrollTo(0,y));
    }

    $('submitBtn').addEventListener('touchstart', e=>{e.preventDefault();},{passive:false});
    $('skipBtn').addEventListener('touchstart', e=>{e.preventDefault();},{passive:false});
    $('submitBtn').addEventListener('click', (e)=>{e.preventDefault(); advance();});
    $('skipBtn').addEventListener('click', (e)=>{e.preventDefault(); advance();});
  }

  async function init(){
    restore();
    try{
      const {json} = await loadIndex();
      state.weeks = normalizeIndex(json);
      if(!state.weeks.size){
        setError('index.json 讀到了，但格式不認得。');
        return;
      }
      fillWeekOptions();
      fillSceneOptions();
      hookUI();
      // avatar: keep it light; if your assets has talk.mp4, show static placeholder
      $('avatarImg').src = 'https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/assets/avatars/talk.png';
      loadScene();
    }catch(e){
      setError(String(e.message||e));
    }
  }

  init();
})();
</script>
</body>
</html>
