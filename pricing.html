<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide｜方案與定價</title>
  <style>
    :root{
      --bg:#fff; --fg:#111; --muted:#666; --border:#e5e7eb;
      --brand:#0ea5e9; --ok:#16a34a; --warn:#b45309; --notice-bg:#fff7ed; --notice-bd:#fed7aa;
    }
    html,body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",Arial,"Apple Color Emoji","Segoe UI Emoji";}
    a{color:var(--brand);text-decoration:none}
    .container{max-width:1120px;margin:24px auto;padding:0 16px}
    .back{display:inline-flex;align-items:center;gap:6px;color:var(--brand)}
    h1{font-size:40px;line-height:1.15;margin:18px 0 8px}
    .subtitle{color:var(--muted);margin-bottom:18px}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:18px}
    @media (max-width:960px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:640px){.grid{grid-template-columns:1fr}}
    .card{border:1px solid var(--border);border-radius:14px;padding:22px;background:#fff;box-shadow:0 1px 2px rgb(0 0 0 / 4%)}
    .card h2{font-size:26px;margin:0 0 10px}
    .price{font-weight:600;margin:0 0 12px}
    .card ul{margin:0 0 8px 1.2em}
    .select-row{display:flex;align-items:center;gap:8px;margin-top:10px}
    .tiers{display:flex;gap:18px;align-items:center;border-top:1px solid var(--border);margin-top:18px;padding-top:14px;flex-wrap:wrap}
    .tiers label{display:flex;align-items:center;gap:8px}
    .notice{display:none;border:1px solid var(--notice-bd);background:var(--notice-bg);border-radius:12px;padding:12px 14px;margin:10px 0 18px;color:var(--warn)}
    .banner-title{font-weight:700;margin-right:6px}
    .actions{margin:20px 0}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
    .btn-print{border-color:#cbd5e1}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <a class="back" href="./index.html">← 回首頁</a>
    <h1>BookWide｜方案與定價</h1>
    <p class="subtitle">每個主題皆為 <strong>NT$200 / 月</strong>；你可以一次勾選多個主題，<span class="muted">一筆訂單一起結帳。</span></p>

    <!-- 公告／調價預告（從 pricing_notice 讀到才顯示） -->
    <div id="notice" class="notice">
      <span class="banner-title">公告</span><span id="notice-text"></span>
    </div>

    <div class="grid" id="topics-grid">
      <!-- 預設靜態（若讀表成功會覆寫） -->
      <div class="card" data-slug="story">
        <h2>故事 Story</h2>
        <p class="price">NT$200 / 月</p>
        <ul>
          <li>分級故事影片與字幕</li>
          <li>單字／文法／閱讀測驗</li>
          <li>可列印成績單</li>
        </ul>
        <label class="select-row"><input type="checkbox" data-topic="story"> 勾選這個主題</label>
      </div>
      <div class="card" data-slug="music">
        <h2>音樂 Music</h2>
        <p class="price">NT$200 / 月</p>
        <ul>
          <li>歌曲影片，歌詞雙語字幕</li>
          <li>關鍵單詞小測驗</li>
          <li>收藏精選歌曲</li>
        </ul>
        <label class="select-row"><input type="checkbox" data-topic="music"> 勾選這個主題</label>
      </div>
      <div class="card" data-slug="movie">
        <h2>電影 Movie</h2>
        <p class="price">NT$200 / 月</p>
        <ul>
          <li>電影片段學英文</li>
          <li>情境會話／片語重點</li>
          <li>主題測驗可列印</li>
        </ul>
        <label class="select-row"><input type="checkbox" data-topic="movie"> 勾選這個主題</label>
      </div>
      <div class="card" data-slug="news">
        <h2>新聞 News</h2>
        <p class="price">NT$200 / 月</p>
        <ul>
          <li>國際新聞精讀</li>
          <li>重點單字／時事測驗</li>
          <li>每週更新</li>
        </ul>
        <label class="select-row"><input type="checkbox" data-topic="news"> 勾選這個主題</label>
      </div>
      <div class="card" data-slug="pro">
        <h2>專業行業 Professional</h2>
        <p class="price">NT$200 / 月</p>
        <ul>
          <li>商務／科技／設計等領域</li>
          <li>商務情境對話</li>
          <li>術語與案例剖析</li>
        </ul>
        <label class="select-row"><input type="checkbox" data-topic="pro"> 勾選這個主題</label>
      </div>
    </div>

    <div class="tiers" id="tiers">
      <label><input type="radio" name="billing" value="month" checked> 月繳 <span id="p-month">NT$200 / 主題</span></label>
      <label><input type="radio" name="billing" value="half"> 半年 <span id="p-half">NT$960 / 主題</span></label>
      <label><input type="radio" name="billing" value="year"> 年繳 <span id="p-year">NT$1680 / 主題</span></label>
    </div>

    <div class="actions">
      <button class="btn btn-print" id="btn-print">列印帳單（測試）</button>
      <a class="btn" href="./account/subscription.html">前往「我的訂閱」</a>
    </div>

    <p class="muted">＊此頁會在有設定「公告」與「價格設定」的情況下自動更新顯示；若資料表為空，則維持目前預設內容。</p>
  </div>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <script>
  (function(){
    const projectUrl = "https://jeajrwpmrgczimmrflxo.supabase.co";
    // 建議在 GitHub Pages 用 <script> 注入 anon key，或由 admin 第四分頁寫入公開 readable 的 view。
    const anonKey   = window.BOOKWIDE_ANON_KEY || "YOUR_PUBLIC_ANON_KEY";

    let supa = null;
    try {
      supa = window.supabase.createClient(projectUrl, anonKey, {auth: {persistSession:false}});
    } catch (err) { /* 靜默失敗，保留預設畫面 */ }

    async function safeSelect(table, columns='*', opts={}){
      if(!supa) return { data:null, error:null };
      try{
        let q = supa.from(table).select(columns);
        if(opts.eq) Object.entries(opts.eq).forEach(([k,v])=> q = q.eq(k,v));
        if(opts.order) q = q.order(opts.order, { ascending: opts.ascending !== false });
        if(opts.limit) q = q.limit(opts.limit);
        const { data, error } = await q;
        return { data, error };
      }catch(e){ return { data:null, error:e }; }
    }

    // 讀公告（可選：pricing_notice 表）
    async function loadNotice(){
      const el = document.getElementById('notice');
      const txt = document.getElementById('notice-text');
      const { data } = await safeSelect('pricing_notice','message,effective_date,active',{ eq:{ active:true }, order:'effective_date', ascending:false, limit:1 });
      if(Array.isArray(data) && data.length){
        const n = data[0];
        const when = n.effective_date ? new Date(n.effective_date).toISOString().slice(0,10) : '';
        txt.textContent = when ? `${when} 起生效｜${n.message}` : n.message;
        el.style.display = 'block';
      }
    }

    // 讀價格設定（pricing_config）
    async function loadPrices(){
      const { data } = await safeSelect('pricing_config',
        'slug,title,features,price_month,price_half,price_year,is_active,sort',{ order:'sort' });

      if(!Array.isArray(data) || data.length===0) return; // 無資料 → 保留預設

      // 更新單價區塊（若以整體設定提供）
      try{
        const pm   = document.getElementById('p-month');
        const ph   = document.getElementById('p-half');
        const py   = document.getElementById('p-year');
        // 取平均/或讀第一筆全域設定（若有 global 設定可用 eq）
        const any = data.find(x=>x.price_month);
        if(any){
          if(any.price_month) pm.textContent = `NT$${any.price_month} / 主題`;
          if(any.price_half)  ph.textContent = `NT$${any.price_half} / 主題`;
          if(any.price_year)  py.textContent = `NT$${any.price_year} / 主題`;
        }
      }catch(_){}

      // 更新每張卡
      const cards = document.querySelectorAll('.card[data-slug]');
      cards.forEach(card=>{
        const slug = card.getAttribute('data-slug');
        const row  = data.find(x=>x.slug===slug && x.is_active!==false);
        if(!row) return;
        // 標題
        if(row.title){
          const h2 = card.querySelector('h2');
          h2.textContent = row.title;
        }
        // 價格（以月價為主顯示）
        if(row.price_month){
          const p = card.querySelector('.price');
          p.textContent = `NT$${row.price_month} / 月`;
        }
        // features 字串或 JSON 陣列
        if(row.features){
          const ul = card.querySelector('ul');
          ul.innerHTML = '';
          let feats = [];
          try{
            feats = typeof row.features === 'string'
              ? JSON.parse(row.features) : row.features;
          }catch(_){ feats = String(row.features).split(/\n|、|,|;/).map(s=>s.trim()).filter(Boolean); }
          feats.slice(0,6).forEach(t=>{
            const li = document.createElement('li'); li.textContent=t; ul.appendChild(li);
          });
        }
      });
    }

    // 列印（模擬）
    document.getElementById('btn-print').addEventListener('click', ()=> {
      window.print();
    });

    // 啟動
    loadNotice();
    loadPrices();
  })();
  </script>
</body>
</html>


