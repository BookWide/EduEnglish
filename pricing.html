<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BookWide｜方案與定價</title>
  <style>
    :root{--bg:#0b1324;--panel:#0f1b31;--ink:#eaf1ff;--muted:#9bb0d1;--brand:#83a6ff}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,"Noto Sans TC",Arial}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    h1{font-size:28px;margin:8px 0 16px}
    .cards{display:grid;grid-template-columns:repeat(5,1fr);gap:16px}
    .card{background:var(--panel);border-radius:12px;padding:20px;display:flex;flex-direction:column;gap:10px}
    .card h3{margin:0 0 6px;font-size:20px}
    .price{font-size:28px;margin:8px 0 12px}
    .feat{color:var(--muted);font-size:14px;line-height:1.6}
    label.ck{display:flex;align-items:center;gap:8px;margin-top:auto}
    input[type="checkbox"],input[type="radio"]{width:18px;height:18px}
    .panel{background:#0e1a2f;border-radius:12px;padding:16px;margin-top:18px}
    .row{display:flex;flex-wrap:wrap;gap:18px;align-items:center}
    .btn{background:var(--brand);color:#021; font-weight:700;border:0;border-radius:10px;padding:12px 18px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .total{font-size:18px;margin-top:10px}
    a.back{color:var(--muted);text-decoration:none}
    @media (max-width:1100px){.cards{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:640px){.cards{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <a class="back" href="index.html">回首頁</a>
    <h1>BookWide｜方案與定價</h1>
    <p>每個主題定價皆為 <b>NT$200 / 月</b>；你可以一次勾選多個主題一起結帳。</p>

    <div class="cards">
      <div class="card">
        <h3>故事 Story</h3>
        <div class="price">NT$200 / 月</div>
        <div class="feat">分級故事影片與字幕、單字 / 文法 / 閱讀測驗、可列印成績單</div>
        <label class="ck"><input type="checkbox" class="pick" value="story"> 勾選這個主題</label>
      </div>

      <div class="card">
        <h3>音樂 Music</h3>
        <div class="price">NT$200 / 月</div>
        <div class="feat">歌曲影片、歌詞雙語字幕、關鍵用語小測驗、收藏精選歌曲</div>
        <label class="ck"><input type="checkbox" class="pick" value="music"> 勾選這個主題</label>
      </div>

      <div class="card">
        <h3>電影 Movie</h3>
        <div class="price">NT$200 / 月</div>
        <div class="feat">電影片段學英文、情境會話 / 片語重點、主題測驗可列印</div>
        <label class="ck"><input type="checkbox" class="pick" value="movie"> 勾選這個主題</label>
      </div>

      <div class="card">
        <h3>新聞 News</h3>
        <div class="price">NT$200 / 月</div>
        <div class="feat">國際新聞精讀、重點單字 / 時事測驗、每週更新</div>
        <label class="ck"><input type="checkbox" class="pick" value="news"> 勾選這個主題</label>
      </div>

      <div class="card">
        <h3>專業行業 Professional</h3>
        <div class="price">NT$200 / 月</div>
        <div class="feat">商務 / 科技 / 設計等領域、商務情境對話、術語與案例剖析</div>
        <label class="ck"><input type="checkbox" class="pick" value="pro"> 勾選這個主題</label>
      </div>
    </div>

    <div class="panel">
      <div class="row">
        <strong>選擇方案週期：</strong>
        <label class="ck"><input type="radio" name="period" value="month" checked> 月繳 NT$200 / 主題</label>
        <label class="ck"><input type="radio" name="period" value="halfyear"> 半年 NT$960 / 主題</label>
        <label class="ck"><input type="radio" name="period" value="year"> 年繳 NT$1680 / 主題</label>
      </div>
      <div class="total" id="totalText">目前尚未選擇主題</div>
      <div class="row" style="margin-top:10px">
        <button id="checkoutBtn" class="btn">前往結帳</button>
      </div>
    </div>
  </div>

  <script>
    // ===== 只改這兩行 =====
    const EDGE_URL = 'https://qtgwedankftrqjmzuset.supabase.co/functions/v1/ecpay-checkout';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF0Z3dlZGFua2Z0cnFqbXp1c2V0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NDYxMDMsImV4cCI6MjA3NDQyMjEwM30.jyETpt09pgm66aCZheMgsjtbKlVmYo-lt-hrrt6BF8g';

    // 價目表（單價）
    const PRICES = {
      month: 200,
      halfyear: 960,
      year: 1680,
    };
    const PERIOD_LABEL = { month:'月繳', halfyear:'半年繳', year:'年繳' };

    const picks = Array.from(document.querySelectorAll('.pick'));
    const periodRadios = Array.from(document.querySelectorAll('input[name="period"]'));
    const totalText = document.getElementById('totalText');
    const checkoutBtn = document.getElementById('checkoutBtn');

    function getPeriod(){
      const r = periodRadios.find(r => r.checked);
      return r ? r.value : 'month';
    }
    function getSelected(){
      return picks.filter(p => p.checked).map(p => p.value);
    }
    function renderTotal(){
      const period = getPeriod();
      const unit = PRICES[period];
      const selected = getSelected();
      if(selected.length === 0){
        totalText.textContent = '目前尚未選擇主題';
        return;
      }
      const total = unit * selected.length;
      totalText.textContent = `${selected.length} 個主題，${PERIOD_LABEL[period]}，合計 NT$${total.toLocaleString()}`;
    }
    picks.forEach(p => p.addEventListener('change', renderTotal));
    periodRadios.forEach(r => r.addEventListener('change', renderTotal));
    renderTotal();

    // ===== 結帳（呼叫 Edge Function -> 轉到綠界收銀台）=====
    checkoutBtn.addEventListener('click', async () => {
      const selected = getSelected();
      if(selected.length === 0){
        alert('請至少勾選一個主題'); return;
      }
      const period = getPeriod();
      const unit = PRICES[period];
      const total = unit * selected.length;

      const namesMap = {
        story:'故事 Story', music:'音樂 Music', movie:'電影 Movie', news:'新聞 News', pro:'專業行業 Professional'
      };
      const itemName = selected.map(k => namesMap[k] || k).join('、') + `（${PERIOD_LABEL[period]}）`;

      // 可先預覽
      if(!confirm(`已勾選：${itemName}\n總金額：NT$${total.toLocaleString()}\n\n是否前往付款？`)){
        return;
      }

      try{
        const resp = await fetch(EDGE_URL, {
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Authorization':'Bearer ' + SUPABASE_ANON_KEY
          },
          body: JSON.stringify({
            // Edge 端參數：orderId / itemName / amount / email / planId
            orderId: 'OD' + Date.now(),
            itemName,
            amount: total,
            email: '',          // 若頁面有登入可填 email，否則留空
            planId: 'cart-' + period
          })
        });

        if(!resp.ok){
          const t = await resp.text();
          throw new Error(`呼叫失敗 (${resp.status})：${t}`);
        }

        // Edge 回傳 HTML（會自動 POST 到綠界），這裡以開新視窗載入
        const html = await resp.text();
        const w = window.open('', '_blank');
        w.document.open();
        w.document.write(html);
        w.document.close();
      }catch(err){
        console.error(err);
        alert('錯誤：' + err.message);
      }
    });
  </script>
</body>
</html>






