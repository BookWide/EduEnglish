<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide | 方案與定價</title>
  <style>
    :root{--bg:#0b1324;--panel:#0f1b31;--ink:#eaf1ff;--muted:#9bb0d1;--brand:#83a6ff}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,"Noto Sans TC",Arial}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    h1{font-size:28px;margin:8px 0 16px}
    .cards{display:grid;grid-template-columns:repeat(5,1fr);gap:16px}
    .card{background:var(--panel);border-radius:12px;padding:20px;display:flex;flex-direction:column;gap:10px}
    .card h3{margin:0 0 6px;font-size:20px}
    .price{font-size:28px;margin:6px 0 10px}
    .feat{color:var(--muted);font-size:14px;line-height:1.6}
    .ctrl{display:flex;align-items:center;gap:8px;margin-top:auto}
    .period{margin-top:24px;display:flex;gap:24px;align-items:center}
    .total{margin-top:8px;color:#cde}
    .go{margin-top:16px}
    button{background:#1f2b47;border:1px solid #2b3a5f;border-radius:10px;padding:12px 18px;color:#fff;cursor:pointer}
    button:hover{opacity:.9}
  </style>
</head>
<body>
<div class="wrap">
  <a href="./index.html" style="color:#9bb0d1;text-decoration:none">回首頁</a>
  <h1>BookWide | 方案與定價</h1>

  <div class="cards" id="plans"></div>

  <div class="period">
    <label><input type="radio" name="period" value="month" checked> 月繳 NT$200 / 主題</label>
    <label><input type="radio" name="period" value="halfyear"> 半年 NT$960 / 主題</label>
    <label><input type="radio" name="period" value="year"> 年繳 NT$1680 / 主題</label>
  </div>

  <div class="total" id="summary">已勾選 0 個主題，月繳，合計 NT$0</div>

  <div class="go">
    <button id="checkoutBtn">前往結帳</button>
  </div>
</div>

<script>
/* ========= 1) 你的設定 ========= */
const SUPABASE_FUNCTION_URL =
  'https://jeajrwpmrgczimmrflxo.functions.supabase.co/functions/v1/ecpay-checkout';

// ✅ 只貼 key，不要加 Bearer
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do';

/* ========= 2) 價格表 ========= */
const PRICES = { month: 200, halfyear: 960, year: 1680 };
const PERIOD_LABEL = { month: '月繳', halfyear: '半年繳', year: '年繳' };
const PRODUCTS = [
  { id: 'story', name: '故事 Story' },
  { id: 'music', name: '音樂 Music' },
  { id: 'movie', name: '電影 Movie' },
  { id: 'news',  name: '新聞 News' },
  { id: 'pro',   name: '專業行業 Professional' }
];

/* ========= 3) 畫面生成 ========= */
const $plans = document.getElementById('plans');
$plans.innerHTML = PRODUCTS.map(p => `
  <div class="card">
    <h3>${p.name}</h3>
    <div class="price">NT$200 / 月</div>
    <div class="feat">重點單字 / 雙語字幕 / 主題測驗 / 可列印成績單</div>
    <label class="ctrl">
      <input type="checkbox" data-pid="${p.id}"> 勾選這個主題
    </label>
  </div>
`).join('');

const selected = new Set();
const summary = document.getElementById('summary');
function refreshSummary(){
  const period = document.querySelector('input[name="period"]:checked').value;
  const unit = PRICES[period];
  const total = unit * selected.size;
  summary.textContent = `已勾選 ${selected.size} 個主題，${PERIOD_LABEL[period]}，合計 NT$${total.toLocaleString()}`;
}
$plans.addEventListener('change', (e)=>{
  const el = e.target;
  if (el && el.dataset.pid) {
    el.checked ? selected.add(el.dataset.pid) : selected.delete(el.dataset.pid);
    refreshSummary();
  }
});
document.querySelectorAll('input[name="period"]').forEach(r => r.addEventListener('change', refreshSummary));
refreshSummary();

/* ========= 4) 結帳 ========= */
document.getElementById('checkoutBtn').addEventListener('click', async () => {
  if (selected.size === 0) return alert('請至少勾選一個主題');

  const period = document.querySelector('input[name="period"]:checked').value;
  const unit = PRICES[period];

  const lineItems = [...selected].map(pid => ({
    name: PRODUCTS.find(p => p.id === pid).name + `（${PERIOD_LABEL[period]}）`,
    qty: 1,
    unit_price: unit
  }));

  try {
    const resp = await fetch(SUPABASE_FUNCTION_URL, {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + SUPABASE_ANON_KEY,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        orderId: 'OD' + Date.now(),
        lineItems
      })
    });

    if (!resp.ok) {
      const t = await resp.text().catch(()=> '');
      throw new Error(`HTTP ${resp.status} ${t}`);
    }

    // ✅ 不開新視窗，直接同頁導向綠界
    const html = await resp.text();
    document.open();
    document.write(html);
    document.close();
  } catch (err) {
    alert('錯誤：' + (err?.message || err));
  }
});
</script>
</body>
</html>
















