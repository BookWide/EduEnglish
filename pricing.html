<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>BookWide | 方案與定價</title>
<style>
  :root{ --bg:#fff; --text:#000; --muted:#444; --border:#e5e7eb; --pill:#111; --pillText:#fff; --accent:#111; }
  html,body{background:var(--bg);color:var(--text);font-family:"Microsoft JhengHei",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0}
  .wrap{max-width:1180px;margin:32px auto 24px;padding:0 16px}
  h1{font-size:36px;margin:0 0 8px}
  p.lead{color:var(--muted);margin:0 0 24px}
  .grid{display:grid;grid-template-columns: repeat(5, 1fr);gap:16px}
  @media (max-width:1100px){ .grid{grid-template-columns: repeat(3, 1fr);} }
  @media (max-width:720px){ .grid{grid-template-columns: repeat(2, 1fr);} }
  @media (max-width:480px){ .grid{grid-template-columns: 1fr;} }
  .card{border:1px solid var(--border);border-radius:14px;padding:18px 16px;background:#fff}
  .title{font-size:22px;font-weight:700;margin-bottom:6px}
  .price{font-size:22px;font-weight:700;margin:6px 0 12px}
  ul{margin:0 0 10px 18px;padding:0}
  li{margin:6px 0}
  .pick{display:flex;align-items:center;gap:8px;margin-top:6px;color:var(--muted)}
  .pick input{width:18px;height:18px}
  .controls{margin-top:22px;border:1px solid var(--border);border-radius:14px;padding:16px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .period{display:flex;align-items:center;gap:18px;flex-wrap:wrap}
  .pill{display:inline-block;background:var(--pill);color:var(--pillText);padding:6px 10px;border-radius:999px;font-size:14px}
  .summary{color:#111}
  .btn{padding:14px 18px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;font-weight:700;cursor:pointer}
  .btn[disabled]{opacity:.45;cursor:not-allowed}
  .right{margin-left:auto}
  .muted{color:var(--muted)}
  /* 頂部列：顯示登入狀態 */
  .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border)}
  .acc{font-size:14px;color:#111}
  .acc .email{font-weight:700}
  .lock-mask{opacity:.6;pointer-events:none}
  .tip{font-size:13px;color:#e11d48;margin-left:8px}
  .back-home {display:inline-block;margin:8px 0 0 16px;font-size:16px;color:#2563eb;text-decoration:none;font-weight:500}
  .back-home:hover { text-decoration:underline; }
</style>
</head>
<body>
  <a class="back-home" href="https://bookwide.github.io/EduEnglish/">← 回首頁</a>

  <!-- 頂部登入狀態列 -->
  <div class="topbar">
    <div></div>
    <div class="acc" id="accBox">未登入</div>
  </div>

  <div class="wrap">
    <h1>BookWide | 方案與定價</h1>
    <p class="lead">每個主題皆為 <b>NT$200 / 月</b>；你可以一次勾選多個主題，一筆訂單一起結帳。</p>

    <div class="grid" id="plansGrid">
      <div class="card">
        <div class="title">故事 Story</div><div class="price">NT$200 / 月</div>
        <ul><li>分級故事影片與字幕</li><li>單字 / 文法 / 閱讀測驗</li><li>可列印成績單</li></ul>
        <label class="pick"><input type="checkbox" data-item="story"> 勾選這個主題</label>
      </div>
      <div class="card">
        <div class="title">音樂 Music</div><div class="price">NT$200 / 月</div>
        <ul><li>歌曲影片、歌詞雙語字幕</li><li>關鍵單詞小測驗</li><li>收藏精選歌曲</li></ul>
        <label class="pick"><input type="checkbox" data-item="music"> 勾選這個主題</label>
      </div>
      <div class="card">
        <div class="title">電影 Movie</div><div class="price">NT$200 / 月</div>
        <ul><li>電影片段學英文</li><li>情境會話 / 片語重點</li><li>主題測驗可列印</li></ul>
        <label class="pick"><input type="checkbox" data-item="movie"> 勾選這個主題</label>
      </div>
      <div class="card">
        <div class="title">新聞 News</div><div class="price">NT$200 / 月</div>
        <ul><li>國際新聞精讀</li><li>重點單字 / 時事測驗</li><li>每週更新</li></ul>
        <label class="pick"><input type="checkbox" data-item="news"> 勾選這個主題</label>
      </div>
      <div class="card">
        <div class="title">專業行業 Professional</div><div class="price">NT$200 / 月</div>
        <ul><li>商務 / 科技 / 設計等領域</li><li>商務情境對話</li><li>術語與案例剖析</li></ul>
        <label class="pick"><input type="checkbox" data-item="pro"> 勾選這個主題</label>
      </div>
    </div>

    <div class="controls">
      <div class="period">
        <span class="muted">選擇方案週期：</span>
        <label><input type="radio" name="period" value="month" checked> 月繳 NT$200 / 主題</label>
        <label><input type="radio" name="period" value="half"> 半年 NT$960 / 主題</label>
        <label><input type="radio" name="period" value="year"> 年繳 NT$1680 / 主題</label>
      </div>
      <div class="right summary">
        <span id="count">0 個主題</span>，<span id="fee" class="muted">合計 NT$0</span>
      </div>
    </div>

    <div class="controls">
      <div class="muted" id="refRow">推薦碼：<span id="refLabel" class="pill">無</span></div>
      <button id="goBtn" class="btn right" disabled>前往結帳</button>
    </div>

    <div class="muted" id="lockTip" style="display:none;margin-top:6px;">
      <span class="tip">＊請先登入才能勾選主題與結帳。</span>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supa.js';

    const accBox = document.getElementById('accBox');
    const grid = document.getElementById('plansGrid');
    const lockTip = document.getElementById('lockTip');

    const UNIT = { month:200, half:960, year:1680 };
    const checks = Array.from(document.querySelectorAll('input[type="checkbox"][data-item]'));
    const radios = Array.from(document.querySelectorAll('input[name="period"]'));
    const goBtn = document.getElementById('goBtn');
    const refLabel = document.getElementById('refLabel');
    const countEl = document.getElementById('count');
    const feeEl = document.getElementById('fee');

    const usp = new URLSearchParams(location.search);
    const referral = (usp.get('ref')||'').trim();
    if (referral) refLabel.textContent = referral; else document.getElementById('refRow').style.display='none';

    function getSelected(){ return checks.filter(c=>c.checked).map(c=>c.dataset.item); }
    function getPeriod(){ return (radios.find(r=>r.checked)||{}).value || 'month'; }

    function refresh(){
      const items = getSelected();
      const period = getPeriod();
      const subtotal = items.length * (UNIT[period] || UNIT.month);
      countEl.textContent = `${items.length} 個主題`;
      feeEl.textContent   = `合計 NT$${subtotal}`;
      goBtn.disabled = items.length===0 || goBtn.dataset.locked==='1';

      const itemsParam = encodeURIComponent(items.join(','));
      const pParam     = encodeURIComponent(period);
      const refParam   = referral ? `&ref=${encodeURIComponent(referral)}` : '';
      goBtn.dataset.href = `./checkout.html?items=${itemsParam}&period=${pParam}${refParam}`;
    }

    function setLocked(locked, email=''){
      // UI 鎖/解
      checks.forEach(el=> el.disabled = locked);
      radios.forEach(el=> el.disabled = locked);
      grid.classList.toggle('lock-mask', locked);
      goBtn.dataset.locked = locked ? '1' : '0';
      lockTip.style.display = locked ? '' : 'none';
      // 右上顯示
      accBox.textContent = locked ? '未登入' : `已登入：${email}`;
      refresh();
    }

    async function init(){
      const { data:auth } = await supabase.auth.getUser();
      if (auth?.user){
        setLocked(false, auth.user.email || '');
      }else{
        setLocked(true);
      }
    }

    checks.forEach(c=> c.addEventListener('change', refresh));
    radios.forEach(r=> r.addEventListener('change', refresh));
    goBtn.addEventListener('click', ()=>{
      if (goBtn.dataset.locked==='1'){ alert('請先登入'); return; }
      if (goBtn.dataset.href) location.href = goBtn.dataset.href;
    });

    // 登入狀態變化
    supabase.auth.onAuthStateChange((_e, session)=>{
      if (session?.user) setLocked(false, session.user.email||'');
      else setLocked(true);
    });

    refresh();
    init();
  </script>
  <script type="module">
  import { supabase } from './supa.js';

  // 讀取網址上的推薦碼 (?ref=xxxx)
  function readRef() {
    try {
      const sp = new URLSearchParams(location.search);
      return (sp.get('ref') || '').trim();
    } catch { return ''; }
  }

  // 開啟你現有的「Email 登入」UI（盡量不改你的 HTML 結構）
  function openEmailLoginUI() {
    // 1) 有 Bootstrap Modal：#loginModal
    const modalEl = document.querySelector('#loginModal');
    if (modalEl && window.bootstrap?.Modal) {
      new window.bootstrap.Modal(modalEl, { backdrop: 'static' }).show();
      return;
    }
    // 2) 有「登入」按鈕可以打開視窗
    const loginBtn =
      document.querySelector('[data-bs-target="#loginModal"]') ||
      document.querySelector('[data-action="open-login"]') ||
      document.querySelector('button.login, a.login');
    if (loginBtn) { loginBtn.click(); return; }

    // 3) 沒有 modal，就至少把焦點移到 email 欄
    const emailInput = document.querySelector('input[type="email"], input[name*="email" i]');
    if (emailInput) {
      emailInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
      setTimeout(() => emailInput.focus(), 300);
    }
  }

  // 把右上的帳號顯示更新為「未登入」（或你頁面上對應的元素）
  function setHeaderToLoggedOut() {
    const accText = document.querySelector('#accBox, .acc, .account-email');
    if (accText) accText.textContent = '未登入';
  }

  // 主流程：處理推薦碼與登入狀態
  async function handleReferralOnPricing() {
    const ref = readRef();
    if (!ref) return; // 沒有 ref 就不干預任何東西

    // 1) 找出推薦碼的擁有者
    const { data: owner, error } = await supabase
      .from('profiles')
      .select('id')
      .eq('referral_code', ref)
      .single();

    if (error || !owner) return; // 找不到這個推薦碼就不處理

    // 2) 查目前登入使用者
    const { data: auth } = await supabase.auth.getUser();
    const me = auth?.user?.id || null;

    if (me && owner.id === me) {
      // ✅ 自己推薦自己 → 立即登出，並把 UI 切回未登入
      try { await supabase.auth.signOut(); } catch (e) {}
      setHeaderToLoggedOut();

      // 有 toast/提示就用，沒有就 alert
      try {
        const toastMsg = document.querySelector('#toastMsg');
        const toastEl  = document.querySelector('#toast');
        if (toastMsg && toastEl && window.bootstrap) {
          toastMsg.textContent = '不能使用自己的推薦碼，已為你登出。';
          new window.bootstrap.Toast(toastEl).show();
        } else {
          alert('不能使用自己的推薦碼，已為你登出。');
        }
      } catch {}

      // （可選）避免重複彈提示
      sessionStorage.setItem('self_ref_logged_out', '1');
      return;
    }

    if (!me) {
      // ✅ 別人的推薦碼 & 目前未登入 → 直接打開登入視窗
      // 避免來回重新整理一直跳，僅一次
      if (sessionStorage.getItem('opened_login_for_ref') !== '1') {
        sessionStorage.setItem('opened_login_for_ref', '1');
        openEmailLoginUI();
      }
    }
  }

  // 自動執行
  handleReferralOnPricing();

  // 若登入狀態變化（例如剛登入），重新檢查一次
  supabase.auth.onAuthStateChange((_evt, session) => {
    if (session?.user) {
      // 已登入後，不再彈
      sessionStorage.removeItem('opened_login_for_ref');
    } else {
      // 已登出，再次遇到別人推薦碼時允許彈一次
      sessionStorage.removeItem('opened_login_for_ref');
    }
  });
</script>

</body>
</html>



