<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>方案與定價 | BookWide</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{ --bw-bg:#f7f9fc; --bw-card:#fff; --bw-text:#0b1220; --bw-mute:#6b7280; --accent:#0f172a; }
    body{background:var(--bw-bg);color:var(--bw-text)}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .login-btn{font-weight:800}
    .login-btn a{font-size:20px}
    .grid{display:grid;grid-template-columns:repeat(5, minmax(170px,1fr));gap:16px}
    @media(max-width:1200px){ .grid{grid-template-columns:repeat(4,minmax(170px,1fr));} }
    @media(max-width:900px){ .grid{grid-template-columns:repeat(2,minmax(170px,1fr));} }
    @media(max-width:560px){ .grid{grid-template-columns:repeat(1,minmax(170px,1fr));} }
    .plan{background:var(--bw-card);border:1px solid #e5e7eb;border-radius:18px;padding:18px;box-shadow:0 2px 8px rgba(15,23,42,.04)}
    .plan h3{font-weight:800;font-size:22px}
    .muted{color:var(--bw-mute)}
    .footer{display:flex;align-items:center;gap:14px;margin-top:18px}
    .toast-container{position:fixed;right:16px;bottom:16px;z-index:1060}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a href="./index.html" class="text-decoration-none">&larr; 回首頁</a>
      <div class="login-btn"><a id="authBtn" href="#" class="text-decoration-none">請登入</a></div>
    </div>

    <h1 class="fw-bolder mb-3">BookWide｜方案與定價</h1>
    <p class="text-secondary">每個主題皆為 NT$200 / 月；你可以一次勾選多個主題，一筆訂單一起結帳。</p>

    <div id="refWarn" class="alert alert-info d-none"></div>

    <div class="grid" id="plans">
      <div class="plan">
        <h3>故事 Story</h3>
        <ul class="mb-2">
          <li>分級故事影片與字幕</li><li>單字 / 文法 / 閱讀測驗</li><li>可列印成績單</li>
        </ul>
        <div class="form-check"><input disabled class="form-check-input pick" id="p1" type="checkbox" value="story"><label class="form-check-label" for="p1">勾選這個主題</label></div>
      </div>
      <div class="plan">
        <h3>音樂 Music</h3>
        <ul class="mb-2"><li>歌曲影片、歌詞雙語字幕</li><li>關鍵單詞小測驗</li><li>收藏精選歌曲</li></ul>
        <div class="form-check"><input disabled class="form-check-input pick" id="p2" type="checkbox" value="music"><label class="form-check-label" for="p2">勾選這個主題</label></div>
      </div>
      <div class="plan">
        <h3>電影 Movie</h3>
        <ul class="mb-2"><li>電影片段學英文</li><li>情境會話 / 片語重點</li><li>主題測驗可列印</li></ul>
        <div class="form-check"><input disabled class="form-check-input pick" id="p3" type="checkbox" value="movie"><label class="form-check-label" for="p3">勾選這個主題</label></div>
      </div>
      <div class="plan">
        <h3>新聞 News</h3>
        <ul class="mb-2"><li>國際新聞精讀</li><li>重點單字 / 時事測驗</li><li>每週更新</li></ul>
        <div class="form-check"><input disabled class="form-check-input pick" id="p4" type="checkbox" value="news"><label class="form-check-label" for="p4">勾選這個主題</label></div>
      </div>
      <div class="plan">
        <h3>專業行業 Professional</h3>
        <ul class="mb-2"><li>商務 / 科技 / 設計等領域</li><li>商務情境對話</li><li>術語與案例剖析</li></ul>
        <div class="form-check"><input disabled class="form-check-input pick" id="p5" type="checkbox" value="pro"><label class="form-check-label" for="p5">勾選這個主題</label></div>
      </div>
    </div>

    <div class="footer">
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="period" id="r1" value="month" checked>
        <label class="form-check-label" for="r1">月繳 NT$200 / 主題</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="period" id="r2" value="half">
        <label class="form-check-label" for="r2">半年 NT$960 / 主題</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="period" id="r3" value="year">
        <label class="form-check-label" for="r3">年繳 NT$1680 / 主題</label>
      </div>
      <button id="goBtn" class="btn btn-primary px-4 ms-auto" disabled>前往結帳</button>
    </div>
  </div>

  <div class="toast-container">
    <div id="toast" class="toast align-items-center text-bg-dark border-0">
      <div class="d-flex">
        <div id="toastBody" class="toast-body">…</div>
        <button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import { supabase } from './supa.js';

    const authBtn = document.getElementById('authBtn');
    const picks = [...document.querySelectorAll('.pick')];
    const goBtn = document.getElementById('goBtn');
    const toast = new bootstrap.Toast(document.getElementById('toast'));
    const toastBody = document.getElementById('toastBody');
    const refWarn = document.getElementById('refWarn');

    const show = (m)=>{ toastBody.textContent=m; toast.show(); };
    const qp = new URLSearchParams(location.search);
    const ref = (qp.get('ref')||'').trim();

    let authedUser = null;

    function setAuthedUI(user){
      authedUser = user || null;
      const isAuthed = !!authedUser;
      authBtn.textContent = isAuthed ? `已登入：${authedUser.email||''}` : '請登入';
      picks.forEach(el => el.disabled = !isAuthed);
      goBtn.disabled = !isAuthed;
    }

    async function ensureAuth(){
      const { data } = await supabase.auth.getUser();
      setAuthedUI(data?.user || null);
    }

    authBtn.addEventListener('click', async (e)=>{
      e.preventDefault();
      if(authedUser){
        await supabase.auth.signOut();
        show('已登出');
      }else{
        show('請使用首頁或右上帳號下拉的登入功能登入。');
      }
    });

    function selfReferCheck(userId, refCode){
      if(!userId || !refCode) return false;
      const mine = userId.replace(/-/g,'').slice(0,8);
      return mine === refCode;
    }

    function renderRefBanner(self){
      if(!ref) { refWarn.classList.add('d-none'); return; }
      if(self){
        refWarn.classList.remove('alert-info'); refWarn.classList.add('alert-warning');
        refWarn.textContent = '偵測到你使用自己的推薦碼，將不計折扣與分潤。';
      }else{
        refWarn.classList.remove('alert-warning'); refWarn.classList.add('alert-info');
        refWarn.textContent = `已套用推薦碼 ${ref}：結帳將自動帶入 10% 折扣（再計 5% 稅）。`;
      }
      refWarn.classList.remove('d-none');
    }

    function currentItems(){
      return picks.filter(p=>p.checked).map(p=>p.value);
    }
    function updateGoState(){
      goBtn.disabled = !authedUser || currentItems().length===0;
    }
    picks.forEach(p=>p.addEventListener('change', updateGoState));

    goBtn.addEventListener('click', ()=>{
      const items = currentItems();
      const period = document.querySelector('[name=period]:checked').value;
      if(items.length===0){ show('請先勾選至少一個主題'); return; }
      const url = './checkout.html?items='+encodeURIComponent(items.join(','))+'&period='+encodeURIComponent(period)+(ref?('&ref='+encodeURIComponent(ref)):'');
      location.href = url;
    });

    supabase.auth.onAuthStateChange((_e, session)=>{
      setAuthedUI(session?.user || null);
      if(session?.user){
        renderRefBanner(selfReferCheck(session.user.id, ref));
      }else{
        renderRefBanner(false);
      }
    });

    await ensureAuth();
    renderRefBanner(false);
    updateGoState();
  </script>
</body>
</html>









