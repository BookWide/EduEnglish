<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BookWide｜方案與定價</title>
<style>
:root{
  --bg:#0b1324; --panel:#0f1b31; --ink:#eaf1ff; --muted:#9bb0d1; --brand:#83a6ff;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,"Noto Sans TC",Arial}
.wrap{max-width:1200px;margin:0 auto;padding:24px}
h1{font-size:28px;margin:8px 0 16px}
.cards{display:grid;grid-template-columns:repeat(5,1fr);gap:16px}
.card{background:var(--panel);border-radius:12px;padding:20px;display:flex;flex-direction:column;gap:10px}
.card h3{margin:0 0 6px;font-size:20px}
.price{font-size:26px;margin:4px 0 8px}
.feat{color:var(--muted);font-size:14px;line-height:1.6}
label.ck{display:flex;align-items:center;gap:8px;margin-top:auto}
input[type="checkbox"],input[type="radio"]{width:18px;height:18px}

.control{display:flex;align-items:center;flex-wrap:wrap;gap:18px;background:#0e1830;border-radius:12px;padding:16px;margin-top:18px}
.control .total{margin-left:auto;font-size:18px}
.btn{
  background:#2b62ff;border:none;color:#fff;border-radius:10px;
  padding:12px 18px;font-size:16px;cursor:pointer
}
.btn:disabled{opacity:.5;cursor:not-allowed}

.note{color:#9fb2d9;font-size:13px;margin-top:10px}
a.back{display:inline-block;margin:6px 0 16px;color:#a8c1ff;text-decoration:none}
a.back:hover{text-decoration:underline}
.badge{display:inline-block;background:#142346;border:1px solid #234; color:#9fb2d9;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:6px}
</style>
</head>
<body>
<div class="wrap">
  <a class="back" href="./index.html">回首頁</a>
  <h1>BookWide｜方案與定價 <span class="badge">可一次勾選多個主題一起結帳</span></h1>

  <!-- 5 個主題卡片 -->
  <div class="cards" id="cards">
    <div class="card" data-id="story" data-name="故事 Story">
      <h3>故事 Story</h3>
      <div class="price">NT$200 / 月</div>
      <div class="feat">．分級故事影片與字幕／單字／文法／閱讀測驗</div>
      <div class="feat">．可列印成績單</div>
      <label class="ck"><input type="checkbox" class="pick"> 勾選這個主題</label>
    </div>

    <div class="card" data-id="music" data-name="音樂 Music">
      <h3>音樂 Music</h3>
      <div class="price">NT$200 / 月</div>
      <div class="feat">．歌曲影片、歌詞雙語字幕</div>
      <div class="feat">．關鍵用語小測驗／收藏精選歌曲</div>
      <label class="ck"><input type="checkbox" class="pick"> 勾選這個主題</label>
    </div>

    <div class="card" data-id="movie" data-name="電影 Movie">
      <h3>電影 Movie</h3>
      <div class="price">NT$200 / 月</div>
      <div class="feat">．電影片段學英文／情境會話／片語重點</div>
      <div class="feat">．主題測驗可列印</div>
      <label class="ck"><input type="checkbox" class="pick"> 勾選這個主題</label>
    </div>

    <div class="card" data-id="news" data-name="新聞 News">
      <h3>新聞 News</h3>
      <div class="price">NT$200 / 月</div>
      <div class="feat">．國際新聞精讀／重點單字／時事測驗</div>
      <div class="feat">．每週更新</div>
      <label class="ck"><input type="checkbox" class="pick"> 勾選這個主題</label>
    </div>

    <div class="card" data-id="pro" data-name="專業行業 Professional">
      <h3>專業行業 Professional</h3>
      <div class="price">NT$200 / 月</div>
      <div class="feat">．商務／科技／設計等領域</div>
      <div class="feat">．商務情境對話／術語與案例剖析</div>
      <label class="ck"><input type="checkbox" class="pick"> 勾選這個主題</label>
    </div>
  </div>

  <!-- 週期與結帳 -->
  <div class="control">
    <div>
      <label class="ck"><input type="radio" name="period" value="month" checked> 月繳 NT$200 / 主題</label>
      <label class="ck"><input type="radio" name="period" value="halfyear"> 半年 NT$960 / 主題</label>
      <label class="ck"><input type="radio" name="period" value="year"> 年繳 NT$1680 / 主題</label>
    </div>
    <div class="total" id="summary">0 個主題，月繳，合計 NT$0</div>
    <button class="btn" id="checkout">前往結帳</button>
  </div>

  <div class="note">提示：若之後想加/減主題或更換週期，回到本頁重新結帳即可（系統會以你的帳號整合權限）。</div>
</div>

<script>
/* ========================
   1) 價格與顯示邏輯
   ======================== */
const UNIT_PRICE = {
  month: 200,
  halfyear: 960,
  year: 1680,
};
const PERIOD_LABEL = { month: '月繳', halfyear: '半年', year: '年繳' };

const picks = [...document.querySelectorAll('.pick')];
const periodRadios = [...document.querySelectorAll('input[name="period"]')];
const summaryEl = document.getElementById('summary');

function currentPeriod(){ return periodRadios.find(r => r.checked).value; }
function selectedCards(){
  return picks
    .map((ck,i) => ck.checked ? ck.closest('.card') : null)
    .filter(Boolean)
    .map(card => ({
      product_id: card.dataset.id,
      name: card.dataset.name
    }));
}
function redraw(){
  const sel = selectedCards();
  const p = currentPeriod();
  const total = sel.length * UNIT_PRICE[p];
  summaryEl.textContent = `${sel.length} 個主題，${PERIOD_LABEL[p]}，合計 NT$${total.toLocaleString()}`;
}
picks.forEach(ck => ck.addEventListener('change', redraw));
periodRadios.forEach(r => r.addEventListener('change', redraw));
redraw();

/* ========================
   2) 前往結帳（呼叫 Edge Function）
   ======================== */
const checkoutBtn = document.getElementById('checkout');

checkoutBtn.addEventListener('click', async () => {
  const sel = selectedCards();
  if (sel.length === 0){
    alert('請至少勾選一個主題');
    return;
  }
  const period = currentPeriod();
  const unit = UNIT_PRICE[period];
  const names = sel.map(s => s.name).join('、');
  if (!confirm(`已勾選：${names}\n週期：${PERIOD_LABEL[period]}\n\n總金額：NT$${(unit*sel.length).toLocaleString()}\n\n是否前往付款？`)){
    return;
  }

  // 先同步開一個空白視窗，以避免被瀏覽器擋彈窗
  const payWin = window.open('', '_blank');
  if(!payWin){
    alert('錯誤：瀏覽器封鎖彈出視窗，請允許彈出視窗再試一次。');
    return;
  }

  try{
    // 將多個主題轉成 line items（後端會組合為訂單）
    const lineItems = sel.map(s => ({
      product_id: s.product_id,
      period,          // month / halfyear / year
      qty: 1,
      unit_price: unit
    }));

    const resp = await fetch(SUPABASE_FUNCTION_URL, {
      method: 'POST',
      mode: 'cors',
      headers:{
        'Content-Type': 'application/json',
        'Authorization': SUPABASE_ANON_KEY   // <== 直接帶 Bearer xxx
      },
      body: JSON.stringify({ lineItems })
    });

    if(!resp.ok){
      const errText = await resp.text();
      throw new Error(`HTTP ${resp.status}\n${errText}`);
    }

    // 後端會回一個 HTML（含 form 自動送到綠界）
    const html = await resp.text();
    payWin.document.open();
    payWin.document.write(html);
    payWin.document.close();

  }catch(err){
    console.error(err);
    payWin.close();
    alert('錯誤：' + err.message);
  }
});

/* ========================
   3) TODO: 改成你的設定
   ========================
   SUPABASE_FUNCTION_URL：你的 Edge Function 公開 URL
   SUPABASE_ANON_KEY：    你的 anon key，前面要有 "Bearer "
*/
const SUPABASE_FUNCTION_URL = 'https://qtgwedankftrqjmzuset.functions.supabase.co/functions/v1/ecpay-checkout';
const SUPABASE_ANON_KEY     = 'BearereyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF0Z3dlZGFua2Z0cnFqbXp1c2V0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NDYxMDMsImV4cCI6MjA3NDQyMjEwM30.jyETpt09pgm66aCZheMgsjtbKlVmYo-lt-hrrt6BF8g';
</script>
</body>
</html>










