<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide｜方案與定價（登入＋自推自拒補丁）</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#f7f9fc;}
    .wrap{max-width:1100px;margin:40px auto;padding:0 16px;}
    .card-topic{border:1px solid #e5e7eb;border-radius:16px;background:#fff;box-shadow:0 1px 5px rgba(2,6,23,.05)}
    .card-topic .title{font-weight:800;font-size:24px}
    .card-topic ul{margin:0 0 8px 18px}
    .muted{color:#64748b}
    #authStatus{position:fixed;right:20px;top:16px;font-weight:800;font-size:20px;color:#0ea5e9;cursor:pointer;z-index:9999;}
    #authStatus:hover{text-decoration:underline}
    .bar{height:6px;background:#e5e7eb;border-radius:999px}
  </style>
</head>
<body>
  <!-- 右上帳號 -->
  <div id="authStatus">請登入</div>

  <div class="wrap">
    <a href="./index.html" class="text-decoration-none">&larr; 回首頁</a>
    <h1 class="fw-bold mt-2">BookWide | 方案與定價</h1>
    <p class="text-secondary">每個主題皆為 <strong>NT$200 / 月</strong>；你可以一次勾選多個主題，一筆訂單一起結帳。</p>

    <div class="row g-3">
      <!-- 五大主題 -->
      <div class="col-12 col-md-6 col-lg-4">
        <div class="card-topic p-3">
          <div class="title">故事 Story</div>
          <div class="text-secondary">NT$200 / 月</div>
          <ul>
            <li>分級故事影片與字幕</li>
            <li>單字／文法／閱讀測驗</li>
            <li>可列印成績單</li>
          </ul>
          <div class="form-check">
            <input class="form-check-input topic" type="checkbox" value="story" id="t1">
            <label class="form-check-label" for="t1">勾選這個主題</label>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-6 col-lg-4">
        <div class="card-topic p-3">
          <div class="title">音樂 Music</div>
          <div class="text-secondary">NT$200 / 月</div>
          <ul>
            <li>歌曲影片，歌詞雙語字幕</li>
            <li>關鍵單詞小測驗</li>
            <li>收藏精選歌曲</li>
          </ul>
          <div class="form-check">
            <input class="form-check-input topic" type="checkbox" value="music" id="t2">
            <label class="form-check-label" for="t2">勾選這個主題</label>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-6 col-lg-4">
        <div class="card-topic p-3">
          <div class="title">電影 Movie</div>
          <div class="text-secondary">NT$200 / 月</div>
          <ul>
            <li>電影片段學英文</li>
            <li>情境會話 / 片語重點</li>
            <li>主題測驗可列印</li>
          </ul>
          <div class="form-check">
            <input class="form-check-input topic" type="checkbox" value="movie" id="t3">
            <label class="form-check-label" for="t3">勾選這個主題</label>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-6 col-lg-4">
        <div class="card-topic p-3">
          <div class="title">新聞 News</div>
          <div class="text-secondary">NT$200 / 月</div>
          <ul>
            <li>國際新聞精讀</li>
            <li>重點單字 / 時事測驗</li>
            <li>每週更新</li>
          </ul>
          <div class="form-check">
            <input class="form-check-input topic" type="checkbox" value="news" id="t4">
            <label class="form-check-label" for="t4">勾選這個主題</label>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-6 col-lg-4">
        <div class="card-topic p-3">
          <div class="title">專業行業 Professional</div>
          <div class="text-secondary">NT$200 / 月</div>
          <ul>
            <li>商務 / 科技 / 設計等領域</li>
            <li>商務情境對話</li>
            <li>術語與案例剖析</li>
          </ul>
          <div class="form-check">
            <input class="form-check-input topic" type="checkbox" value="pro" id="t5">
            <label class="form-check-label" for="t5">勾選這個主題</label>
          </div>
        </div>
      </div>
    </div>

    <div class="my-4 bar"></div>

    <!-- 週期選擇 -->
    <div class="mb-3">
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="period" id="pMonth" value="month" checked>
        <label class="form-check-label" for="pMonth">月繳 NT$200 / 主題</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="period" id="pHalf" value="half">
        <label class="form-check-label" for="pHalf">半年 NT$960 / 主題</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="period" id="pYear" value="year">
        <label class="form-check-label" for="pYear">年繳 NT$1680 / 主題</label>
      </div>
    </div>

    <div class="alert alert-warning py-2 small" id="tipMustLogin" role="alert" style="display:none">
      請先登入，才能勾選主題與結帳。
    </div>

    <button id="goCheckout" class="btn btn-dark btn-lg">前往結帳</button>
  </div>

  <!-- Login / SignUp Modal -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-md">
      <div class="modal-content" style="background:#0f172a;color:#fff">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="loginModalTitle">登入</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <ul class="nav nav-tabs" id="authTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="tab-login" data-bs-toggle="tab" data-bs-target="#pane-login" type="button" role="tab">登入</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab-signup" data-bs-toggle="tab" data-bs-target="#pane-signup" type="button" role="tab">註冊</button>
            </li>
          </ul>

          <div class="tab-content mt-3">
            <div class="tab-pane fade show active" id="pane-login" role="tabpanel">
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input id="loginEmail" type="email" class="form-control" placeholder="you@example.com">
              </div>
              <div class="mb-3">
                <label class="form-label">密碼</label>
                <input id="loginPassword" type="password" class="form-control" placeholder="••••••••">
              </div>
              <div class="d-flex gap-2">
                <button id="btnLogin" class="btn btn-light">送出</button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              </div>
            </div>

            <div class="tab-pane fade" id="pane-signup" role="tabpanel">
              <div class="mb-2 small text-warning">沒有帳號？在這裡註冊新帳號。</div>
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input id="signupEmail" type="email" class="form-control" placeholder="you@example.com">
              </div>
              <div class="mb-3">
                <label class="form-label">密碼</label>
                <input id="signupPassword" type="password" class="form-control" placeholder="至少 6 碼">
              </div>
              <div class="d-flex gap-2">
                <button id="btnSignup" class="btn btn-light">註冊</button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              </div>
            </div>
          </div>

          <div id="authMsg" class="mt-3 small text-info"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import { supabase } from './supa.js';

    const authStatus = document.getElementById('authStatus');
    const loginModalEl = document.getElementById('loginModal');
    const loginModal = new bootstrap.Modal(loginModalEl);
    const authMsg = document.getElementById('authMsg');
    const tipMustLogin = document.getElementById('tipMustLogin');

    const loginEmail = document.getElementById('loginEmail');
    const loginPassword = document.getElementById('loginPassword');
    const btnLogin = document.getElementById('btnLogin');

    const signupEmail = document.getElementById('signupEmail');
    const signupPassword = document.getElementById('signupPassword');
    const btnSignup = document.getElementById('btnSignup');

    const goBtn = document.getElementById('goCheckout');
    const qp = new URLSearchParams(location.search);
    const refCodeInUrl = (qp.get('ref') || '').trim();

    function showMsg(msg, type='info'){
      authMsg.className = 'mt-3 small text-' + type;
      authMsg.textContent = msg;
    }

    function setAuthUI(loggedIn, email=''){
      authStatus.textContent = loggedIn ? '已登入：' + (email || '') : '請登入';
      document.querySelectorAll('.topic').forEach(cb => cb.disabled = !loggedIn);
      goBtn.disabled = !loggedIn;
      tipMustLogin.style.display = loggedIn ? 'none' : '';
    }

    async function refreshAuthUI(){
      const { data } = await supabase.auth.getUser();
      if (data?.user) setAuthUI(true, data.user.email || '');
      else setAuthUI(false);
    }

    // 自推自拒
    async function rejectSelfReferralIfNeeded(){
      if (!refCodeInUrl) return;
      const { data: auth } = await supabase.auth.getUser();
      if (!auth?.user) return;

      const { data: owner } = await supabase
        .from('profiles')
        .select('id, referral_code')
        .eq('referral_code', refCodeInUrl)
        .single();

      if (owner && owner.id === auth.user.id){
        await supabase.auth.signOut();
        setAuthUI(false);
        showMsg('不能使用自己的推薦碼。已登出。', 'warning');
        loginModal.show();
      }
    }

    // 事件：點右上「請登入」
    authStatus.addEventListener('click', async () => {
      const { data } = await supabase.auth.getUser();
      if (!data?.user) loginModal.show();
    });

    // 登入
    btnLogin?.addEventListener('click', async () => {
      showMsg('登入中...');
      const email = loginEmail.value.trim();
      const password = loginPassword.value;
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error){ showMsg(error.message || '登入失敗', 'danger'); return; }
      showMsg('登入成功。');
      await refreshAuthUI();
      await rejectSelfReferralIfNeeded();
      const { data } = await supabase.auth.getUser();
      if (data?.user) loginModal.hide();
    });

    // 註冊
    btnSignup?.addEventListener('click', async () => {
      showMsg('註冊中...');
      const email = signupEmail.value.trim();
      const password = signupPassword.value;
      const { error } = await supabase.auth.signUp({
        email, password,
        options: { emailRedirectTo: location.origin + location.pathname }
      });
      if (error){ showMsg(error.message || '註冊失敗', 'danger'); return; }
      showMsg('註冊成功，請前往信箱驗證後再登入。');
    });

    // 初始
    (async () => {
      await refreshAuthUI();
      if (refCodeInUrl){
        const { data } = await supabase.auth.getUser();
        if (!data?.user) loginModal.show();
      }
    })();

    // auth 狀態改變
    supabase.auth.onAuthStateChange((_e, session) => {
      if (session?.user) setAuthUI(true, session.user.email || '');
      else setAuthUI(false);
    });

    // Demo：前往結帳（你可改成導向你現有的 checkout.html）
    goBtn.addEventListener('click', () => {
      const items = Array.from(document.querySelectorAll('.topic:checked')).map(el => el.value);
      const period = (document.querySelector('input[name="period"]:checked')?.value) || 'month';
      const params = new URLSearchParams();
      if (items.length) params.set('items', items.join(','));
      params.set('period', period);
      if (refCodeInUrl) params.set('ref', refCodeInUrl);
      location.href = './checkout.html?' + params.toString();
    });
  </script>
</body>
</html>
