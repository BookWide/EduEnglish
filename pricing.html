<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>訂單摘要 | BookWide</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{ --bw-bg:#f7f9fc;--bw-card:#fff;--bw-text:#15202b;--bw-mute:#6b7280;--bw-accent:#111827; }
    body{background:var(--bw-bg);color:var(--bw-text);}
    .wrap{max-width:980px;margin:40px auto;padding:0 16px;}
    .card-box{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 2px 8px rgba(15,23,42,.04)}
    .row-item{display:flex;justify-content:space-between;align-items:center;padding:18px 20px;border-bottom:1px dashed #e5e7eb}
    .row-item:last-child{border-bottom:none}
    .label{font-weight:700}
    .money{font-size:24px;font-weight:800;letter-spacing:.5px}
    .pill{display:inline-flex;align-items:center;gap:.25rem;padding:.2rem .6rem;border:1px solid #111827;border-radius:999px;font-weight:600}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="mb-3"><a href="./pricing.html">← 返回方案與定價</a></div>
    <h1 class="fw-bolder mb-3">訂單摘要</h1>

    <div class="card-box">
      <div class="row-item"><div class="label">週期：</div><div id="periodUI" class="badge bg-dark">—</div></div>
      <div class="row-item"><div class="label">方案：</div><div id="itemsUI"></div></div>
      <div class="row-item" id="refRow" style="display:none;">
        <div class="label">折扣（推薦碼） <span id="refCode" class="text-muted"></span></div>
        <div id="refUI" class="money">- NT$0</div>
      </div>
      <div class="row-item"><div class="label">小計</div><div id="subtotalUI" class="money">—</div></div>
      <div class="row-item"><div class="label">稅額 <span id="taxLabel" class="text-muted">(5%)</span></div><div id="taxUI" class="money">NT$0</div></div>
      <div class="row-item"><div class="label">應付金額</div><div id="totalUI" class="money text-primary">—</div></div>
      <div class="row-item justify-content-center">
        <button id="payBtn" class="btn btn-dark btn-lg px-5" type="button"><span class="btn-text">確認付款</span></button>
      </div>
    </div>
  </div>

  <div class="position-fixed end-0 bottom-0 p-3" style="z-index:1060">
    <div id="toast" class="toast align-items-center text-bg-dark border-0" role="alert">
      <div class="d-flex">
        <div id="toastMsg" class="toast-body">…</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import { supabase } from './supa.js';

    const PRICE_TABLE = { month:200, half:960, year:1680 };
    const TAX_RATE = 0.05;

    const qp = new URLSearchParams(location.search);
    const items = (qp.get('items')||'').split(',').map(s=>s.trim()).filter(Boolean);
    const period = (qp.get('period')||'month').toLowerCase();
    const ref = (qp.get('ref')||'').trim();

    const periodUI = document.getElementById('periodUI');
    const itemsUI = document.getElementById('itemsUI');
    const refRow  = document.getElementById('refRow');
    const refCodeUI = document.getElementById('refCode');
    const refUI   = document.getElementById('refUI');
    const subtotalUI = document.getElementById('subtotalUI');
    const taxUI = document.getElementById('taxUI');
    const totalUI = document.getElementById('totalUI');
    const payBtn = document.getElementById('payBtn');

    const toast = new bootstrap.Toast(document.getElementById('toast'));
    const toastMsg = document.getElementById('toastMsg');
    const showToast = (m)=>{ toastMsg.textContent=m; toast.show(); };

    const fmt = n => 'NT$' + Number(n||0).toLocaleString('en-US');

    function computeAmounts(subtotal, hasValidRef){
      const discount = hasValidRef ? Math.round(subtotal * 0.10) : 0;
      const taxable  = Math.max(0, subtotal - discount);
      const tax      = Math.round(taxable * TAX_RATE);
      const total    = taxable + tax;
      return { discount, tax, total };
    }

    async function getMyRefCode(userId){
      const { data, error } = await supabase
        .from('profiles')
        .select('ref_code')
        .eq('id', userId)
        .single();
      return data?.ref_code || '';
    }

    async function checkSelfReferral(userId, incomingRef){
      if(!incomingRef) return { self:false, myRef:'' };
      const myRef = await getMyRefCode(userId);
      return { self: (myRef && myRef === incomingRef), myRef };
    }

    async function render(){
      periodUI.textContent = ({month:'月繳',half:'半年',year:'年繳'})[period] || period;
      itemsUI.innerHTML = items.map(s=>`<span class="pill me-2">${s}</span>`).join('');

      const unit = PRICE_TABLE[period] ?? PRICE_TABLE.month;
      const subtotal = unit * items.length;

      let hasValidRef = false;
      let selfTipShown = false;

      if(ref){
        refRow.style.display = '';
        refCodeUI.textContent = ' ' + ref;

        // 若有登入，做「自推檢查」
        const { data:auth } = await supabase.auth.getUser();
        if(auth?.user){
          const ck = await checkSelfReferral(auth.user.id, ref);
          if(ck.self){
            hasValidRef = false;
            selfTipShown = true;
            showToast('不能使用自己的推薦碼（不計折扣與分潤）');
          }else{
            hasValidRef = true;
          }
        }else{
          // 未登入也先顯示折扣預估（你原本也是這樣），實際送單時仍會以登入後結果再檢
          hasValidRef = true;
        }
      }

      const { discount, tax, total } = computeAmounts(subtotal, hasValidRef);
      subtotalUI.textContent = fmt(subtotal);
      taxUI.textContent = fmt(tax);
      totalUI.textContent = fmt(total);
      refUI.textContent = '- ' + fmt(discount);

      // 準備事件：送單
      payBtn.onclick = async ()=>{
        const { data:auth } = await supabase.auth.getUser();
        if(!auth?.user){ showToast('請先登入帳號再結帳。'); return; }

        // 以登入的身份再檢一次自推
        let useRef = false, self = false, ownerId = null;
        if(ref){
          const ck = await checkSelfReferral(auth.user.id, ref);
          self = ck.self;
          useRef = !ck.self;
          if(self && !selfTipShown) showToast('不能使用自己的推薦碼（不計折扣與分潤）');
          // 取推薦碼擁有者（可有可無；若你之後要計分潤才需要）
          const { data:r } = await supabase.from('profiles').select('id').eq('ref_code', ref).single();
          ownerId = r?.id || null;
        }

        const final = computeAmounts(subtotal, useRef);

        // 呼叫你的 Edge Function（維持你原來的 payload 欄位）
        const token = (await supabase.auth.getSession())?.data?.session?.access_token || '';
        if(!token){ showToast('無法取得授權，請重新登入再試。'); return; }

        const payload = {
          order_id: 'BW' + Date.now(),
          user_id: auth.user.id,
          email: auth.user.email || '',
          items, period,
          subtotal,
          discount: final.discount,
          tax: final.tax,
          amount: final.total,
          ref_code: ref || '',
          ref_valid: useRef,
          ref_owner_id: ownerId,
          source: 'web-github-pages'
        };

        const FUNCTION_URL = 'https://jeajrwpmrgczimmrflxo.functions.supabase.co/create-ecpay-order';
        payBtn.disabled = true;
        const btnText = payBtn.querySelector('.btn-text'); const old = btnText.textContent;
        btnText.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> 建立訂單中…';

        try{
          const res = await fetch(FUNCTION_URL, {
            method:'POST',
            headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${token}` },
            body: JSON.stringify(payload), credentials:'omit', mode:'cors'
          });
          const data = await res.json().catch(()=>({}));
          if(!res.ok) throw new Error(data?.message || '建立訂單失敗');
          showToast('訂單建立成功！即將導向金流頁面…');
          // if(data?.payment_url) location.href = data.payment_url;
        }catch(e){
          console.error(e);
          showToast(String(e?.message||e));
        }finally{
          payBtn.disabled = false;
          btnText.textContent = old;
        }
      };
    }

    render();
  </script>
</body>
</html>











