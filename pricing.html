<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide | 方案與定價</title>
  <style>
    :root{--bg:#fff;--text:#111;--muted:#6b7280;--panel:#fff;--border:#e5e7eb;--pill:#111;--pillText:#fff;--btn:#111;--btnText:#fff;--accent:#0ea5e9}
    html,body{background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue","Noto Sans","Microsoft JhengHei",Arial,sans-serif;margin:0}
    .wrap{max-width:1080px;margin:32px auto;padding:0 16px}
    h1{font-size:34px;margin:8px 0 16px}
    .sub{color:var(--muted);margin-bottom:24px}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:18px}
    @media (max-width:1000px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:640px){.grid{grid-template-columns:1fr}}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:18px}
    .card h3{margin:0 0 8px 0;font-size:24px}
    .price{font-size:26px;font-weight:700;margin:6px 0 10px}
    ul{margin:0 0 14px 18px;padding:0}
    li{margin:6px 0}
    label.chk{display:flex;align-items:center;gap:8px;margin-top:6px;font-weight:600}
    .row{display:flex;align-items:center;gap:16px;flex-wrap:wrap;margin-top:18px}
    .pill{display:inline-block;background:var(--pill);color:var(--pillText);padding:6px 10px;border-radius:999px;font-size:13px}
    .muted{color:var(--muted)}
    .bar{border:1px dashed var(--border);border-radius:12px;padding:14px 16px;margin-top:20px}
    .btn{background:var(--btn);color:var(--btnText);border:0;border-radius:10px;padding:14px 20px;font-weight:700;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>BookWide | 方案與定價</h1>
    <div class="sub">每個主題皆為 <b>NT$200 / 月</b>；你可以一次勾選多個主題，一筆訂單一起結帳。</div>

    <div class="grid" id="planGrid">
      <!-- Story -->
      <div class="card">
        <h3>故事 Story</h3>
        <div class="price">NT$200 / 月</div>
        <ul>
          <li>分級故事影片與字幕</li>
          <li>單字 / 文法 / 閱讀測驗</li>
          <li>可列印成績單</li>
        </ul>
        <label class="chk"><input type="checkbox" data-item="story"> 勾選這個主題</label>
      </div>

      <!-- Music -->
      <div class="card">
        <h3>音樂 Music</h3>
        <div class="price">NT$200 / 月</div>
        <ul>
          <li>歌曲影片、歌詞雙語字幕</li>
          <li>關鍵單詞小測驗</li>
          <li>收藏精選歌曲</li>
        </ul>
        <label class="chk"><input type="checkbox" data-item="music"> 勾選這個主題</label>
      </div>

      <!-- Movie -->
      <div class="card">
        <h3>電影 Movie</h3>
        <div class="price">NT$200 / 月</div>
        <ul>
          <li>電影片段學英文</li>
          <li>情境會話 / 片語重點</li>
          <li>主題測驗可列印</li>
        </ul>
        <label class="chk"><input type="checkbox" data-item="movie"> 勾選這個主題</label>
      </div>

      <!-- Professional -->
      <div class="card">
        <h3>專業行業 Professional</h3>
        <div class="price">NT$200 / 月</div>
        <ul>
          <li>商務 / 科技 / 設計等領域</li>
          <li>商務情境對話</li>
          <li>術語與案例剖析</li>
        </ul>
        <label class="chk"><input type="checkbox" data-item="pro"> 勾選這個主題</label>
      </div>
    </div>

    <div class="bar">
      <div class="row">
        <div class="muted">選擇方案週期：</div>
        <label><input type="radio" name="period" value="month" checked> 月繳 NT$200 / 主題</label>
        <label><input type="radio" name="period" value="half"> 半年 NT$960 / 主題</label>
        <label><input type="radio" name="period" value="year"> 年繳 NT$1680 / 主題</label>

        <span class="right muted">推薦碼：<span id="refShow" class="pill muted">無</span></span>
      </div>

      <div class="row">
        <div class="muted" id="summary">0 個主題，合計 NT$0</div>
        <button class="btn right" id="go">前往結帳</button>
      </div>
    </div>
  </div>

  <script>
  // === 推薦碼：URL → localStorage (含 TTL) → 顯示 ===
  const REF_KEY = 'referral_v1';
  const REF_TTL_MS = 30 * 24 * 60 * 60 * 1000; // 30 天

  function saveRef(code) {
    const data = { code, ts: Date.now(), ttl: REF_TTL_MS };
    localStorage.setItem(REF_KEY, JSON.stringify(data));
    sessionStorage.setItem(REF_KEY, JSON.stringify(data));
  }
  function readRef() {
    // 1) URL
    const usp = new URLSearchParams(location.search);
    const r = usp.get('ref');
    if (r) { saveRef(r); return r; }
    // 2) session
    try { const s = sessionStorage.getItem(REF_KEY);
      if (s) { const o=JSON.parse(s)||{}; if (o.code) return o.code; }
    } catch {}
    // 3) local + TTL
    try { const s = localStorage.getItem(REF_KEY);
      if (!s) return '';
      const o = JSON.parse(s)||{};
      if (!o.code) return '';
      if ((o.ts||0)+(o.ttl||0) < Date.now()) { localStorage.removeItem(REF_KEY); return ''; }
      return o.code;
    } catch { return ''; }
  }

  // === UI 互動 ===
  const grid = document.getElementById('planGrid');
  const refShow = document.getElementById('refShow');
  const summary = document.getElementById('summary');
  const btn = document.getElementById('go');

  const selected = new Set();
  grid.addEventListener('change', (e)=>{
    if (e.target && e.target.matches('input[type="checkbox"][data-item]')) {
      const k = e.target.getAttribute('data-item');
      e.target.checked ? selected.add(k) : selected.delete(k);
      refreshSummary();
    }
  });

  function unitPrice(period){ return period==='year'?1680: period==='half'?960:200; }
  function refreshSummary(){
    const period = document.querySelector('input[name="period"]:checked').value;
    const total = unitPrice(period) * selected.size;
    summary.textContent = `${selected.size} 個主題，合計 NT$${total}`;
  }
  document.querySelectorAll('input[name="period"]').forEach(r=>r.addEventListener('change', refreshSummary));

  // 初始：讀取推薦碼並顯示
  const currentRef = readRef();
  if (currentRef) { refShow.textContent = currentRef; refShow.classList.remove('muted'); }
  refreshSummary();

  // 前往結帳
  btn.addEventListener('click', ()=>{
    if (!selected.size) { alert('請先勾選主題'); return; }
    const items = Array.from(selected).join(',');
    const period = document.querySelector('input[name="period"]:checked').value;
    const ref = readRef();
    const refParam = ref ? `&ref=${encodeURIComponent(ref)}` : '';
    location.href = `./checkout.html?items=${encodeURIComponent(items)}&period=${encodeURIComponent(period)}${refParam}`;
  });
  </script>
</body>
</html>
