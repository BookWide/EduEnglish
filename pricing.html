<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>方案與定價 | BookWide</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{ --bw-bg:#f7f9fc; --bw-card:#fff; --bw-text:#15202b; --bw-mute:#6b7280; --bw-accent:#111827; }
    body{ background:var(--bw-bg); color:var(--bw-text); }
    .wrap{ max-width:1080px; margin:32px auto; padding:0 16px; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; padding:12px 16px; background:#fff;
             border-bottom:1px solid #e5e7eb; position:sticky; top:0; z-index:10; }
    .brand{ font-weight:800; letter-spacing:.5px; }
    .acc{ font-size:14px; color:#111; }
    .card-plan{ background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:20px; height:100%; }
    .plan-title{ font-size:24px; font-weight:800; }
    .price{ font-size:22px; font-weight:800; }
    .muted{ color:var(--bw-mute); }
    .footer-bar{ position:sticky; bottom:0; background:#fff; border-top:1px solid #e5e7eb; padding:12px 16px; }
  </style>
</head>
<body>
  <!-- 頂部列：左品牌 / 右登入狀態 -->
  <div class="topbar">
    <div class="brand">BookWide | 方案與定價</div>
    <div class="d-flex align-items-center gap-2">
      <div id="accBox" class="acc">未登入</div>
      <div class="btn-group">
        <button id="btnLogin" class="btn btn-sm btn-outline-dark">登入</button>
        <button id="btnLogout" class="btn btn-sm btn-outline-secondary d-none">登出</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <p class="muted mb-4">每個主題皆為 <strong>NT$200 / 月</strong>；可一次勾選多個主題，一筆訂單一起結帳。推薦網址的 <code>?ref=推薦碼</code> 會沿用到結帳頁。</p>

    <!-- 方案清單 -->
    <div class="row g-3">
      <div class="col-md-6 col-lg-3">
        <div class="card-plan h-100">
          <div class="plan-title">故事 Story</div>
          <div class="price mt-2">NT$200 / 月</div>
          <ul class="mt-2 mb-3 small">
            <li>分級故事影片與字幕</li><li>單字/文法/閱讀測驗</li><li>可列印成績單</li>
          </ul>
          <div class="form-check">
            <input id="item-story" class="form-check-input plan" type="checkbox" value="story">
            <label class="form-check-label" for="item-story">勾選這個主題</label>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-lg-3">
        <div class="card-plan h-100">
          <div class="plan-title">音樂 Music</div>
          <div class="price mt-2">NT$200 / 月</div>
          <ul class="mt-2 mb-3 small">
            <li>歌曲影片，歌詞雙語</li><li>關鍵單詞小測驗</li><li>收藏精選歌單</li>
          </ul>
          <div class="form-check">
            <input id="item-music" class="form-check-input plan" type="checkbox" value="music">
            <label class="form-check-label" for="item-music">勾選這個主題</label>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-lg-3">
        <div class="card-plan h-100">
          <div class="plan-title">電影 Movie</div>
          <div class="price mt-2">NT$200 / 月</div>
          <ul class="mt-2 mb-3 small">
            <li>電影片段學英文</li><li>情境會話/片語重點</li><li>主題測驗可列印</li>
          </ul>
          <div class="form-check">
            <input id="item-movie" class="form-check-input plan" type="checkbox" value="movie">
            <label class="form-check-label" for="item-movie">勾選這個主題</label>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-lg-3">
        <div class="card-plan h-100">
          <div class="plan-title">新聞 News</div>
          <div class="price mt-2">NT$200 / 月</div>
          <ul class="mt-2 mb-3 small">
            <li>國際新聞精讀</li><li>重點單字/時事測驗</li><li>每週更新</li>
          </ul>
          <div class="form-check">
            <input id="item-news" class="form-check-input plan" type="checkbox" value="news">
            <label class="form-check-label" for="item-news">勾選這個主題</label>
          </div>
        </div>
      </div>
    </div>

    <!-- 週期 -->
    <div class="mt-4">
      <div class="fw-bold mb-2">選擇方案週期：</div>
      <div class="d-flex align-items-center gap-3 flex-wrap">
        <div class="form-check">
          <input class="form-check-input" type="radio" name="period" id="p-month" value="month" checked>
          <label class="form-check-label" for="p-month">月繳 NT$200 / 主題</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="period" id="p-half" value="half">
          <label class="form-check-label" for="p-half">半年 NT$960 / 主題</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="period" id="p-year" value="year">
          <label class="form-check-label" for="p-year">年繳 NT$1680 / 主題</label>
        </div>
      </div>
    </div>

    <div class="alert alert-light border mt-3 small" id="refHint" style="display:none;"></div>
  </div>

  <!-- 底部結帳條 -->
  <div class="footer-bar">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
      <div id="summary" class="small muted">尚未選擇主題</div>
      <div class="d-flex align-items-center gap-2">
        <button id="btnGoCheckout" class="btn btn-dark px-4">前往結帳</button>
      </div>
    </div>
  </div>

  <!-- 內建 Email 登入 Modal（以防你的站上沒有現成的登入彈窗） -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="loginForm">
        <div class="modal-header">
          <h5 class="modal-title">登入</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" id="loginEmail" class="form-control" placeholder="you@example.com" required>
          </div>
          <div class="mb-2">
            <label class="form-label">密碼</label>
            <input type="password" id="loginPass" class="form-control" required>
          </div>
          <div class="form-text">若尚未註冊，請先註冊後再登入。</div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">取消</button>
          <button class="btn btn-dark" type="submit">送出</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div class="position-fixed end-0 bottom-0 p-3" style="z-index:1060">
    <div id="toast" class="toast text-bg-dark border-0">
      <div class="d-flex">
        <div id="toastMsg" class="toast-body">…</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import { supabase } from './supa.js';

    const accBox = document.getElementById('accBox');
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');
    const btnGoCheckout = document.getElementById('btnGoCheckout');
    const summary = document.getElementById('summary');
    const refHint = document.getElementById('refHint');

    const toast = new bootstrap.Toast(document.getElementById('toast'));
    const toastMsg = document.getElementById('toastMsg');
    function showToast(m){ toastMsg.textContent=m; toast.show(); }

    const qp = new URLSearchParams(location.search);
    const ref = (qp.get('ref') || '').trim();

    // ====== 基本 UI ======
    function getChosenItems(){
      return Array.from(document.querySelectorAll('.plan:checked')).map(el=>el.value);
    }
    function getPeriod(){
      const el = document.querySelector('input[name="period"]:checked');
      return (el?.value || 'month');
    }
    function renderSummary(){
      const items = getChosenItems();
      if(items.length===0){ summary.textContent = '尚未選擇主題'; return; }
      summary.textContent = `${items.length} 個主題，週期：${({month:'月繳',half:'半年',year:'年繳'})[getPeriod()]}`;
    }
    document.querySelectorAll('.plan,input[name="period"]').forEach(el => el.addEventListener('change', renderSummary));
    renderSummary();

    // ====== 登入/登出 ======
    async function refreshAccBox(){
      const { data:auth } = await supabase.auth.getUser();
      if(auth?.user){
        accBox.textContent = `已登入：${auth.user.email||''}`;
        btnLogin.classList.add('d-none');
        btnLogout.classList.remove('d-none');
      }else{
        accBox.textContent = '未登入';
        btnLogin.classList.remove('d-none');
        btnLogout.classList.add('d-none');
      }
    }

    btnLogin.addEventListener('click', () => openLoginModal());
    btnLogout.addEventListener('click', async () => {
      await supabase.auth.signOut();
      await refreshAccBox();
      showToast('已登出');
    });

    // 內建 email 登入（若你的站已有登入彈窗，可改成觸發那個）
    const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
    function openLoginModal(){
      // 若頁面上已有你的既有登入按鈕，可觸發它（保留相容性）
      const legacyTrigger = document.querySelector('[data-login-trigger], .js-login, .btn-login');
      if(legacyTrigger){ legacyTrigger.click(); return; }
      loginModal.show();
      setTimeout(()=>document.getElementById('loginEmail')?.focus(), 300);
    }
    document.getElementById('loginForm')?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = document.getElementById('loginEmail').value.trim();
      const pass  = document.getElementById('loginPass').value;
      const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
      if(error){ showToast('登入失敗：'+error.message); return; }
      loginModal.hide();
      await refreshAccBox();
      showToast('登入成功');
    });

    // ====== 前往結帳：沿用 ref 參數 ======
    btnGoCheckout.addEventListener('click', () => {
      const items = getChosenItems();
      if(items.length===0){ showToast('請先勾選至少一個主題'); return; }
      const period = getPeriod();
      const usp = new URLSearchParams({ items: items.join(','), period });
      if(ref) usp.set('ref', ref);
      location.href = `./checkout.html?${usp.toString()}`;
    });

    // ====== 規則：自推即登出；他人推薦且未登入 => 跳登入 ======
    async function enforceReferralRules(){
      if(!ref){
        refHint.style.display='none';
        return;
      }
      // 顯示來源提示
      refHint.style.display='';
      refHint.innerHTML = `偵測到推薦碼：<code>${ref}</code>。將沿用至結帳頁。`;

      // 查詢推薦碼擁有者
      let ownerId = null;
      try{
        const { data, error } = await supabase
          .from('profiles')
          .select('id, referral_code')
          .eq('referral_code', ref)
          .single();
        if(!error && data) ownerId = data.id;
      }catch(e){ /* ignore */ }

      const { data:auth } = await supabase.auth.getUser();
      const currentUser = auth?.user || null;

      // 自己推薦自己 → 立即登出（保持頁面其他功能不變）
      if(currentUser && ownerId && currentUser.id === ownerId){
        await supabase.auth.signOut();
        await refreshAccBox();
        showToast('偵測到「自己推薦自己」，已幫你登出（避免自推）。');
        return;
      }

      // 他人推薦 + 目前未登入 → 自動彈出登入視窗（多半是新用戶）
      if(!currentUser && ownerId){
        // 小延遲，避免載入抖動
        setTimeout(openLoginModal, 300);
      }
    }

    // 首次載入
    await refreshAccBox();
    await enforceReferralRules();

    // 監聽登入狀態變化
    supabase.auth.onAuthStateChange((_evt, session)=>{
      refreshAccBox();
      // 重新檢查一次規則（避免登入後又變自推）
      setTimeout(enforceReferralRules, 200);
    });
  </script>
</body>
</html>



