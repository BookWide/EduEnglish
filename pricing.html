<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BookWide｜方案與定價</title>
  <style>
    :root{--bg:#0b1324;--panel:#0f1b31;--ink:#eaf1ff;--muted:#9bb0d1;--brand:#83a6ff}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,"Noto Sans TC",Arial}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    h1{font-size:28px;margin:8px 0 16px}
    .cards{display:grid;grid-template-columns:repeat(5,1fr);gap:16px}
    .card{background:var(--panel);border:1px solid #233153;border-radius:12px;padding:20px;display:flex;flex-direction:column;gap:10px}
    .card h3{margin:0 0 6px;font-size:20px}
    .price{font-size:28px;margin:8px 0 14px}
    .feat{color:var(--muted);font-size:14px;line-height:1.6}
    label.ck{display:flex;align-items:center;gap:8px;margin-top:auto}
    input[type="checkbox"],input[type="radio"]{width:18px;height:18px}
    .bar{margin-top:22px;background:#0c1833;border:1px solid #233153;border-radius:12px;padding:16px;display:flex;flex-wrap:wrap;gap:18px;align-items:center}
    .bar .total{margin-left:auto;font-size:18px}
    .btn{appearance:none;border:0;cursor:pointer;background:#2d5bff;color:#fff;padding:12px 18px;border-radius:10px;font-size:16px}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .note{color:#9bb0d1;margin-top:16px;font-size:14px}
    @media (max-width:1100px){.cards{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:640px){.cards{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <a href="index.html" style="color:#9bb0d1;text-decoration:none">回首頁</a>
    <h1>BookWide｜方案與定價</h1>
    <p class="feat">每個主題定價皆為 <b>NT$200 / 月</b>；你可以一次勾選多個主題一起結帳。</p>

    <div id="cards" class="cards">
      <!-- 5 個主題 -->
      <div class="card" data-id="story">
        <h3>故事 Story</h3>
        <div class="price">NT$200 / 月</div>
        <div class="feat">分級故事影片與字幕／單字、文法、閱讀測驗／可列印成績單</div>
        <label class="ck"><input type="checkbox" data-id="story" /> 勾選這個主題</label>
      </div>

      <div class="card" data-id="music">
        <h3>音樂 Music</h3>
        <div class="price">NT$200 / 月</div>
        <div class="feat">歌曲影片、歌詞雙語字幕／關鍵用語小測驗／收藏精選歌單</div>
        <label class="ck"><input type="checkbox" data-id="music" /> 勾選這個主題</label>
      </div>

      <div class="card" data-id="movie">
        <h3>電影 Movie</h3>
        <div class="price">NT$200 / 月</div>
        <div class="feat">電影片段學英文／情境會話、片語重點／主題測驗可列印</div>
        <label class="ck"><input type="checkbox" data-id="movie" /> 勾選這個主題</label>
      </div>

      <div class="card" data-id="news">
        <h3>新聞 News</h3>
        <div class="price">NT$200 / 月</div>
        <div class="feat">國際新聞精讀／重點單字、時事測驗／每週更新</div>
        <label class="ck"><input type="checkbox" data-id="news" /> 勾選這個主題</label>
      </div>

      <div class="card" data-id="pro">
        <h3>專業行業 Professional</h3>
        <div class="price">NT$200 / 月</div>
        <div class="feat">商務／科技／設計等領域／商務情境對話／術語與案例剖析</div>
        <label class="ck"><input type="checkbox" data-id="pro" /> 勾選這個主題</label>
      </div>
    </div>

    <!-- 結帳區 -->
    <div class="bar" id="bar">
      <div>
        <b>選擇方案週期：</b>
        <label class="ck"><input type="radio" name="period" value="month" checked /> 月繳 NT$200 / 主題</label>
        <label class="ck"><input type="radio" name="period" value="halfyear" /> 半年 NT$960 / 主題</label>
        <label class="ck"><input type="radio" name="period" value="year" /> 年繳 NT$1680 / 主題</label>
      </div>
      <div class="total" id="total">0 個主題，月繳，合計 NT$0</div>
      <button class="btn" id="checkout">前往結帳</button>
    </div>

    <p class="note">提示：你可以一次勾選多個主題一併付款；日後要增減主題，回本頁再點即可，系統會以你的帳號整合權限。</p>
  </div>

  <!-- ￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣ -->
  <!-- 這裡只要改一行：把 anon key 貼上去就完成                         -->
  <!-- ＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿ -->
  <script>
    // 你的 Supabase Edge Functions URL（已幫你填好專案網域）
    const SUPABASE_FUNCTION_URL =
      'https://qtgwedankftrqjmzuset.functions.supabase.co/functions/v1/ecpay-checkout';

    // ←← 只要把下面這個 anon key 改掉就好
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF0Z3dlZGFua2Z0cnFqbXp1c2V0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NDYxMDMsImV4cCI6MjA3NDQyMjEwM30.jyETpt09pgm66aCZheMgsjtbKlVmYo-lt-hrrt6BF8g';   // 必填
  </script>

  <script>
    // 價格表
    const PRICES = {
      month:   200,
      halfyear: 960,
      year:    1680,
    };
    const PERIOD_LABEL = { month:'月繳', halfyear:'半年繳', year:'年繳' };

    const qs = (sel, el=document)=>el.querySelector(sel);
    const qsa = (sel, el=document)=>[...el.querySelectorAll(sel)];

    const barTotal = qs('#total');
    const checkoutBtn = qs('#checkout');

    // 勾選/變更時計算
    function calc() {
      const selected = qsa('input[type="checkbox"][data-id]:checked').map(i=>i.dataset.id);
      const period = qs('input[name="period"]:checked').value;
      const unit = PRICES[period];
      const sum = unit * selected.length;
      barTotal.textContent = `${selected.length} 個主題，${PERIOD_LABEL[period]}，合計 NT$${sum.toLocaleString()}`;
      return {selected, period, unit, sum};
    }
    qsa('input[type="checkbox"], input[name="period"]').forEach(i=>i.addEventListener('change', calc));
    calc();

    // 前往結帳（呼叫 Edge Function → 綠界）
    checkoutBtn.addEventListener('click', async () => {
      const {selected, period, unit} = calc();
      if(!selected.length) return alert('請至少勾選一個主題');

      if(!SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.includes('PASTE_YOUR_ANON_KEY_HERE')){
        alert('尚未設定 Supabase Anon Key：請開啟 pricing.html，搜尋 SUPABASE_ANON_KEY 並貼上你的 anon key 後再試一次。');
        return;
      }
      // 組訂單行（後端可用 CustomField1/2 搭配）
      const lineItems = selected.map(pid => ({
        product_id: pid,        // 你在後端可依此顯示名稱
        period,                 // month / halfyear / year
        qty: 1,
        unit_price: unit
      }));

      // 確認視窗
      const names = lineItems.map(li=>li.product_id).join('、');
      if(!confirm(`已勾選：${names}\n週期：${PERIOD_LABEL[period]}\n\n總金額：NT$${(unit*lineItems.length).toLocaleString()}\n\n是否前往付款？`)) return;

      try{
        checkoutBtn.disabled = true;

        const resp = await fetch(SUPABASE_FUNCTION_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            // ↓ Authorization 與 apikey 兩個都帶，Supabase Functions 最穩
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'apikey': SUPABASE_ANON_KEY,
          },
          body: JSON.stringify({ lineItems }),
        });

        if(!resp.ok){
          const t = await resp.text();
          throw new Error(`HTTP ${resp.status}\n${t}`);
        }

        // 後端回的是綠界表單 HTML → 開新視窗自動送出
        const html = await resp.text();
        const w = window.open('', '_blank', 'noopener,noreferrer');
        if(!w) throw new Error('瀏覽器封鎖彈出視窗，請允許彈出視窗再試一次。');
        w.document.open();
        w.document.write(html);
        w.document.close();
      }catch(err){
        console.error(err);
        alert('錯誤：' + err.message);
      }finally{
        checkoutBtn.disabled = false;
      }
    });
  </script>
</body>
</html>







