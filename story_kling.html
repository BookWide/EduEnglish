<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide - Story Kling JSON</title>
  <style>
    :root{
      --bg:#070b14;
      --panel:#0c1426;
      --panel2:#0a1020;
      --border:rgba(255,255,255,.08);
      --muted:rgba(255,255,255,.65);
      --text:rgba(255,255,255,.92);
      --soft:rgba(255,255,255,.08);
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:14px;
      --gap:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 600px at 20% -20%, rgba(85,140,255,.22), transparent 55%),
                  radial-gradient(900px 500px at 90% 10%, rgba(0,255,209,.10), transparent 55%),
                  radial-gradient(900px 500px at 40% 110%, rgba(255,142,0,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{
      padding:18px 18px 8px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(to bottom, rgba(255,255,255,.03), transparent);
    }
    header h1{
      margin:0 0 6px;
      font-size:18px;
      letter-spacing:.2px;
    }
    header .sub{
      margin:0;
      font-size:13px;
      color:var(--muted);
      line-height:1.4;
    }
    .wrap{
      display:grid;
      grid-template-columns: 390px 1fr;
      gap:16px;
      padding:16px;
      max-width: 1500px;
      margin:0 auto;
    }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent 18%),
                  var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .panel .hd .title{
      font-size:14px;
      font-weight:700;
      margin:0;
    }
    .panel .hd .hint{
      margin:2px 0 0;
      font-size:12px;
      color:var(--muted);
    }
    .panel .bd{
      padding:14px;
    }

    .field{ margin: 0 0 12px; }
    .label{
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .label b{ color:rgba(255,255,255,.85); font-weight:700; }
    input[type="file"]{
      width:100%;
      padding:10px;
      border-radius:12px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.20);
      color:var(--muted);
    }
    input[type="text"], input[type="number"], select, textarea{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
    }
    textarea{
      min-height:88px;
      resize:vertical;
      font-family:var(--mono);
      font-size:12px;
      line-height:1.35;
    }
    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .row3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      font-size:12px;
      color:rgba(255,255,255,.78);
      white-space:nowrap;
    }
    .btnrow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:8px;
    }
    button{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:rgba(255,255,255,.92);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      letter-spacing:.2px;
    }
    button.primary{
      background: linear-gradient(180deg, rgba(0,255,209,.18), rgba(0,255,209,.08));
      border-color: rgba(0,255,209,.25);
    }
    button.danger{
      background: linear-gradient(180deg, rgba(255,88,88,.18), rgba(255,88,88,.08));
      border-color: rgba(255,88,88,.25);
    }
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    .rightTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:14px;
      border-bottom:1px solid var(--border);
    }
    .rightTop .meta{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      color:var(--muted);
      font-size:12px;
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(260px, 1fr));
      gap:14px;
      padding:14px;
    }
    @media (max-width:1200px){
      .wrap{ grid-template-columns: 1fr; }
      .grid{ grid-template-columns: repeat(2, minmax(240px, 1fr)); }
    }
    @media (max-width:720px){
      .grid{ grid-template-columns: 1fr; }
    }
    .card{
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent 30%),
                  rgba(0,0,0,.20);
      border-radius: var(--radius);
      overflow:hidden;
    }
    .thumb{
      position:relative;
      background:#000;
      aspect-ratio: 16/9;
      overflow:hidden;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      filter: saturate(1.05) contrast(1.02);
    }
    .badgeRow{
      position:absolute;
      left:10px;
      bottom:10px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .badge{
      padding:6px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.16);
      color:rgba(255,255,255,.92);
      font-size:12px;
      backdrop-filter: blur(6px);
    }
    .cardBody{
      padding:12px;
    }
    .capLine{
      font-size:13px;
      color:rgba(255,255,255,.90);
      line-height:1.35;
      margin:0 0 10px;
      min-height: 38px;
    }
    .mini2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .miniLabel{
      font-size:12px;
      color:var(--muted);
      margin: 0 0 6px;
    }
    .miniTA{
      min-height:78px;
      font-family:var(--mono);
      font-size:12px;
    }
    .note{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding:10px 12px;
      border-radius:12px;
      font-size:12px;
      color:rgba(255,255,255,.78);
      line-height:1.4;
    }
    .note b{color:rgba(255,255,255,.90)}
    .smallmuted{
      font-size:12px;
      color:var(--muted);
    }
    .mono{
      font-family:var(--mono);
    }
  </style>
</head>
<body>
  <header>
    <h1>故事影片 → Kling 動畫提示 JSON（5/10 秒模式）</h1>
    <p class="sub">
      流程：匯入切好的圖片 → 匯入 SRT（依 min/max 秒合併 chunk）→ 產出每段「Kling 動畫提示」→ 匯出 JSON。<br/>
      <b>重要：</b>你已決定「Kling 生 5 秒 → ffmpeg 拉長 10 秒」，所以 MP3 仍維持 10 秒不改（完全符合你現有 audio_10s）。
    </p>
  </header>

  <div class="wrap">
    <!-- LEFT -->
    <section class="panel">
      <div class="hd">
        <div>
          <p class="title">設定</p>
          <p class="hint">先選圖片與 SRT，再按「產生分鏡」。</p>
        </div>
        <span class="pill" id="statusPill">尚未產生</span>
      </div>

      <div class="bd">
        <div class="field">
          <p class="label"><b>1) 匯入切好的圖片</b><span class="smallmuted">多選：*_0001.jpg…</span></p>
          <input id="imgInput" type="file" accept="image/*" multiple />
          <div class="smallmuted" id="imgInfo" style="margin-top:6px;">尚未選擇圖片</div>
        </div>

        <div class="field">
          <p class="label"><b>2) 匯入 SRT</b><span class="smallmuted">會依 min/max 秒合併 chunk</span></p>
          <input id="srtInput" type="file" accept=".srt,text/plain" />
          <div class="smallmuted" id="srtInfo" style="margin-top:6px;">尚未選擇 SRT</div>
        </div>

        <div class="row2">
          <div class="field">
            <p class="label"><b>每段最短秒數（min）</b></p>
            <input id="minSec" type="number" min="1" step="1" value="10" />
          </div>
          <div class="field">
            <p class="label"><b>每段最長秒數（max）</b></p>
            <input id="maxSec" type="number" min="1" step="1" value="10" />
          </div>
        </div>

        <div class="field">
          <p class="label"><b>動態模式</b><span class="smallmuted">MP3 一律 10 秒不動</span></p>
          <select id="modeSelect">
            <option value="k5_to_10">Kling 5秒生成 → ffmpeg 拉長到 10秒（省成本）</option>
            <option value="k10">Kling 10秒生成（不拉長）</option>
          </select>
          <div class="note" style="margin-top:8px;">
            <b>5→10 模式：</b>JSON 會輸出 <span class="mono">generate_sec=5</span>、<span class="mono">target_sec=10</span>、<span class="mono">stretch_factor=2.0</span><br/>
            <b>10 秒模式：</b><span class="mono">generate_sec=10</span>、<span class="mono">target_sec=10</span>、<span class="mono">stretch_factor=1.0</span>
          </div>
        </div>

        <div class="row2">
          <div class="field">
            <p class="label"><b>類別</b></p>
            <select id="catSelect">
              <option value="story">故事</option>
              <option value="movie">電影</option>
              <option value="music">音樂</option>
              <option value="news">新聞</option>
              <option value="grammar">文法</option>
            </select>
          </div>
          <div class="field">
            <p class="label"><b>風格（A/B/C/D/E）</b></p>
            <select id="styleSelect">
              <option value="A">A 童話風</option>
              <option value="B">B 歐美故事書風</option>
              <option value="C">C 寫實插畫風</option>
              <option value="D">D 家庭向動畫風（避開IP）</option>
              <option value="E">E 自訂</option>
            </select>
          </div>
        </div>

        <div class="field" id="customStyleWrap" style="display:none;">
          <p class="label"><b>自訂風格（E）</b><span class="smallmuted">會附加到每段提示尾巴</span></p>
          <input id="customStyle" type="text" value="original illustration, clean lines, warm color palette, cinematic lighting, high detail, no text" />
        </div>

        <div class="field">
          <p class="label"><b>反轉型節奏（每段秒數序列）</b><span class="smallmuted">例：3,2,2,1,2（可留空）</span></p>
          <input id="rhythm" type="text" value="" placeholder="例如：3,2,2,1,2" />
        </div>

        <div class="field">
          <p class="label"><b>全域畫面加成（會加到每段提示尾巴）</b></p>
          <textarea id="globalSuffix" placeholder="例如：cinematic lighting, professional color grading, subtle film grain, high detail, 4k"></textarea>
        </div>

        <div class="btnrow">
          <button class="primary" id="buildBtn">產生分鏡</button>
          <button id="applyDefaultBtn">套用「角色鎖定」預設</button>
          <button id="copyJsonBtn" disabled>複製 JSON</button>
          <button class="primary" id="downloadJsonBtn" disabled>下載 JSON</button>
          <button class="danger" id="clearBtn">清空</button>
        </div>

        <div class="note" style="margin-top:12px;">
          <b>命名規則（你已選「跟圖片同名」）：</b><br/>
          下載 Kling 影片請放到：<span class="mono">motion_raw\BASE\BASE_0001.mp4</span>（與圖片同名，只差副檔名）
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="panel">
      <div class="rightTop">
        <div>
          <div style="font-weight:800; font-size:14px;">分鏡清單</div>
          <div class="smallmuted">可手動改每段「動畫提示詞 / 運鏡」。匯出 JSON 後直接餵 Kling。</div>
        </div>
        <div class="meta">
          <span class="pill" id="countPill">分鏡：0</span>
          <span class="pill" id="modePill">模式：—</span>
          <span class="pill" id="durPill">Kling：—</span>
        </div>
      </div>
      <div class="grid" id="cards"></div>
    </section>
  </div>

  <script>
    // ===== state =====
    const state = {
      images: [], // {name, url}
      srtText: "",
      cues: [],   // {start,end,text}
      chunks: [], // {start,end,text}
      shots: [],  // final list
      baseName: ""
    };

    const el = (id)=>document.getElementById(id);

    // ===== utils =====
    function pad4(n){ return String(n).padStart(4,'0'); }
    function safeBaseFromImages(images){
      if(!images.length) return "";
      // try BASE_0001.jpg -> BASE
      const n = images[0].name;
      const m = n.match(/^(.*)_\d{4}\.(jpg|jpeg|png|webp)$/i);
      if(m) return m[1];
      return n.replace(/\.[^.]+$/,'');
    }
    function sortByName(a,b){
      return a.name.localeCompare(b.name, undefined, {numeric:true, sensitivity:'base'});
    }

    function parseSrtTime(t){
      // "00:01:02,345"
      const m = t.trim().match(/(\d+):(\d+):(\d+)[,\.](\d+)/);
      if(!m) return 0;
      const hh = parseInt(m[1],10), mm=parseInt(m[2],10), ss=parseInt(m[3],10), ms=parseInt(m[4],10);
      return hh*3600 + mm*60 + ss + ms/1000;
    }

    function parseSrt(text){
      const blocks = text.replace(/\r/g,'').trim().split(/\n\s*\n/);
      const cues = [];
      for(const b of blocks){
        const lines = b.split('\n').map(x=>x.trim()).filter(Boolean);
        if(lines.length < 2) continue;
        let timeLineIdx = 0;
        if(!lines[0].includes('-->') && lines[1] && lines[1].includes('-->')) timeLineIdx = 1;
        const tl = lines[timeLineIdx];
        if(!tl || !tl.includes('-->')) continue;
        const [a,b2] = tl.split('-->').map(s=>s.trim());
        const start = parseSrtTime(a);
        const end = parseSrtTime(b2);
        const textLines = lines.slice(timeLineIdx+1);
        const txt = textLines.join(' ')
          .replace(/<[^>]+>/g,'')
          .replace(/\s+/g,' ')
          .trim();
        if(!txt) continue;
        cues.push({start,end,text:txt});
      }
      cues.sort((x,y)=>x.start-y.start);
      return cues;
    }

    function buildChunks(cues, minSec, maxSec){
      // Greedy accumulate cues into chunks between min/max (seconds)
      const chunks = [];
      let cur = null;

      for(const cue of cues){
        if(!cur){
          cur = {start: cue.start, end: cue.end, text: cue.text};
          continue;
        }
        const nextEnd = Math.max(cur.end, cue.end);
        const nextDur = nextEnd - cur.start;

        if(nextDur <= maxSec){
          cur.end = nextEnd;
          cur.text = (cur.text + " " + cue.text).trim();
        }else{
          // close cur
          chunks.push(cur);
          // start new
          cur = {start: cue.start, end: cue.end, text: cue.text};
        }
      }
      if(cur) chunks.push(cur);

      // Ensure each chunk >= minSec by merging small ones forward
      const merged = [];
      for(let i=0;i<chunks.length;i++){
        let c = chunks[i];
        while((c.end - c.start) < minSec && i < chunks.length-1){
          const n = chunks[i+1];
          c = {start: c.start, end: n.end, text: (c.text + " " + n.text).trim()};
          i++;
        }
        merged.push(c);
      }
      return merged;
    }

    function styleSuffix(style, custom){
      const map = {
        A: "watercolor fairy-tale illustration, soft paper texture, warm gentle palette, hand-painted feel",
        B: "western storybook illustration, clean linework, textured paint, classic children book look",
        C: "realistic illustration, detailed lighting, natural textures, painterly realism",
        D: "family-friendly animated illustration, bright colors, expressive characters, ORIGINAL design (avoid any existing IP)",
        E: (custom || "")
      };
      return map[style] || map.B;
    }

    function defaultMotionPrompt(){
      return [
        "Preserve exact face and identity.",
        "No new characters.",
        "No drastic pose change.",
        "",
        "Subtle cinematic motion only.",
        "Gentle breathing movement.",
        "Soft eye blink.",
        "Minimal cloth or hair movement.",
        "Slight background parallax.",
        "Slow push-in camera.",
        "",
        "Maintain original lighting and composition.",
        "No facial distortion."
      ].join("\n");
    }

    function defaultCameraPrompt(){
      return "slow push-in, subtle parallax, steady, no shake";
    }

    function getModeConfig(){
      const mode = el("modeSelect").value;
      if(mode === "k10"){
        return { mode, generateSec: 10, targetSec: 10, stretchFactor: 1.0, label: "Kling 10s（不拉長）" };
      }
      return { mode, generateSec: 5, targetSec: 10, stretchFactor: 2.0, label: "Kling 5s → 拉長10s（省成本）" };
    }

    // ===== render =====
    function setStatus(text){
      el("statusPill").textContent = text;
    }

    function updateTopMeta(){
      const cfg = getModeConfig();
      el("countPill").textContent = `分鏡：${state.shots.length}`;
      el("modePill").textContent = `模式：${cfg.label}`;
      el("durPill").textContent = `Kling：${cfg.generateSec}s → 片段：${cfg.targetSec}s`;
    }

    function renderCards(){
      const cards = el("cards");
      cards.innerHTML = "";
      const cfg = getModeConfig();

      state.shots.forEach((shot, idx)=>{
        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
          <div class="thumb">
            <img src="${shot.image.url}" alt="">
            <div class="badgeRow">
              <span class="badge">#${pad4(idx+1)}</span>
              <span class="badge">${shot.style}</span>
              <span class="badge">${cfg.generateSec}s</span>
              <span class="badge">${cfg.targetSec}s</span>
            </div>
          </div>
          <div class="cardBody">
            <p class="capLine">${escapeHtml(shot.text)}</p>
            <div class="mini2">
              <div>
                <div class="miniLabel">動畫提示詞（Kling prompt）</div>
                <textarea class="miniTA" data-k="motion">${escapeTextarea(shot.motionPrompt)}</textarea>
              </div>
              <div>
                <div class="miniLabel">運鏡（camera / movement）</div>
                <textarea class="miniTA" data-k="camera">${escapeTextarea(shot.cameraPrompt)}</textarea>
              </div>
            </div>
            <div class="smallmuted" style="margin-top:10px;">
              <span class="mono">${shot.image.name}</span> ｜ SRT: ${shot.start.toFixed(2)}–${shot.end.toFixed(2)}
            </div>
          </div>
        `;

        // bind updates
        const tas = card.querySelectorAll("textarea");
        tas.forEach(ta=>{
          ta.addEventListener("input", ()=>{
            const kind = ta.getAttribute("data-k");
            if(kind === "motion") shot.motionPrompt = ta.value;
            if(kind === "camera") shot.cameraPrompt = ta.value;
          });
        });

        cards.appendChild(card);
      });

      updateTopMeta();
      el("copyJsonBtn").disabled = state.shots.length === 0;
      el("downloadJsonBtn").disabled = state.shots.length === 0;
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[c]));
    }
    function escapeTextarea(s){
      // keep plain but avoid breaking HTML
      return escapeHtml(s);
    }

    // ===== build shots =====
    function buildShots(){
      if(state.images.length === 0){
        alert("請先匯入圖片");
        return;
      }
      if(!state.srtText){
        alert("請先匯入 SRT");
        return;
      }

      const minSec = Math.max(1, parseInt(el("minSec").value || "10", 10));
      const maxSec = Math.max(minSec, parseInt(el("maxSec").value || String(minSec), 10));

      const cfg = getModeConfig();
      const cat = el("catSelect").value;
      const style = el("styleSelect").value;
      const custom = el("customStyle").value.trim();
      const suffix = el("globalSuffix").value.trim();

      state.cues = parseSrt(state.srtText);
      state.chunks = buildChunks(state.cues, minSec, maxSec);

      const n = Math.min(state.images.length, state.chunks.length);
      const base = state.baseName || safeBaseFromImages(state.images);

      // optional rhythm (not forcing timing here; reserved for your future use)
      const rhythm = el("rhythm").value.trim();

      const ss = styleSuffix(style, custom);
      const globalTail = [ss, suffix].filter(Boolean).join(", ");

      state.shots = [];
      for(let i=0;i<n;i++){
        const img = state.images[i];
        const ch = state.chunks[i];

        // default prompts (you can still edit per-shot)
        const motion = defaultMotionPrompt();
        const cam = defaultCameraPrompt();

        state.shots.push({
          id: i+1,
          base,
          category: cat,
          style,
          image: img,
          start: ch.start,
          end: ch.end,
          text: ch.text,
          mode: cfg.mode,
          generate_sec: cfg.generateSec,
          target_sec: cfg.targetSec,
          stretch_factor: cfg.stretchFactor,
          rhythm: rhythm,
          global_suffix: globalTail,
          motionPrompt: motion,
          cameraPrompt: cam
        });
      }

      setStatus(`已產生 ${state.shots.length} 段`);
      renderCards();
    }

    // ===== export json =====
    function buildJson(){
      const cfg = getModeConfig();
      const style = el("styleSelect").value;
      const custom = el("customStyle").value.trim();
      const ss = styleSuffix(style, custom);
      const suffix = el("globalSuffix").value.trim();
      const globalTail = [ss, suffix].filter(Boolean).join(", ");

      const base = state.baseName || safeBaseFromImages(state.images);

      const payload = {
        meta: {
          base,
          category: el("catSelect").value,
          style: style,
          mode: cfg.mode,
          kling_generate_sec: cfg.generateSec,
          target_sec: cfg.targetSec,
          stretch_factor: cfg.stretchFactor,
          mp3_sec: 10, // ✅ 你指定：mp3 不改，一律10秒
          min_chunk_sec: parseInt(el("minSec").value || "10", 10),
          max_chunk_sec: parseInt(el("maxSec").value || "10", 10),
          rhythm: el("rhythm").value.trim() || null,
          global_suffix: globalTail || null,
          created_at: new Date().toISOString()
        },
        shots: state.shots.map(s => ({
          id: s.id,
          image_name: s.image.name,
          srt_start: s.start,
          srt_end: s.end,
          narration: s.text,

          // ✅ 核心：Kling 生成 vs 最終片段
          generate_sec: s.generate_sec,
          target_sec: s.target_sec,
          stretch_factor: s.stretch_factor,

          // 你要餵 Kling 的提示（可直接用）
          kling_prompt: [
            s.motionPrompt.trim(),
            `Scene: ${s.text}`,
            s.cameraPrompt.trim() ? `Camera: ${s.cameraPrompt.trim()}` : "",
            (globalTail ? `Style/Quality: ${globalTail}` : ""),
            `Duration: ${s.generate_sec} seconds.`
          ].filter(Boolean).join("\n\n")
        }))
      };

      return payload;
    }

    async function copyJson(){
      const payload = buildJson();
      const txt = JSON.stringify(payload, null, 2);
      await navigator.clipboard.writeText(txt);
      alert("已複製 JSON");
    }

    function downloadJson(){
      const payload = buildJson();
      const txt = JSON.stringify(payload, null, 2);
      const base = state.baseName || safeBaseFromImages(state.images) || "kling";
      const blob = new Blob([txt], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `${base}_kling.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
    }

    // ===== bindings =====
    el("imgInput").addEventListener("change", async (e)=>{
      const files = Array.from(e.target.files || []);
      if(!files.length){
        state.images = [];
        el("imgInfo").textContent = "尚未選擇圖片";
        return;
      }
      // create object urls
      const imgs = files.map(f => ({ name: f.name, url: URL.createObjectURL(f), file: f }));
      imgs.sort(sortByName);

      // revoke old
      state.images.forEach(x=>{ try{ URL.revokeObjectURL(x.url);}catch{} });
      state.images = imgs;
      state.baseName = safeBaseFromImages(imgs);

      el("imgInfo").textContent = `已選擇 ${imgs.length} 張（base：${state.baseName || "—"}）`;
      setStatus("已匯入圖片");
    });

    el("srtInput").addEventListener("change", async (e)=>{
      const f = (e.target.files || [])[0];
      if(!f){
        state.srtText = "";
        el("srtInfo").textContent = "尚未選擇 SRT";
        return;
      }
      const txt = await f.text();
      state.srtText = txt;
      el("srtInfo").textContent = `已匯入：${f.name}`;
      setStatus("已匯入 SRT");
    });

    el("styleSelect").addEventListener("change", ()=>{
      const v = el("styleSelect").value;
      el("customStyleWrap").style.display = (v === "E") ? "block" : "none";
    });

    el("modeSelect").addEventListener("change", ()=>{
      updateTopMeta();
      // also update card badges without rebuilding data
      if(state.shots.length) renderCards();
    });

    el("buildBtn").addEventListener("click", buildShots);

    el("copyJsonBtn").addEventListener("click", copyJson);
    el("downloadJsonBtn").addEventListener("click", downloadJson);

    el("applyDefaultBtn").addEventListener("click", ()=>{
      // apply defaults to all shots
      if(!state.shots.length){
        alert("請先產生分鏡");
        return;
      }
      state.shots.forEach(s=>{
        s.motionPrompt = defaultMotionPrompt();
        s.cameraPrompt = defaultCameraPrompt();
      });
      renderCards();
      alert("已套用角色鎖定預設到全部分鏡");
    });

    el("clearBtn").addEventListener("click", ()=>{
      // revoke urls
      state.images.forEach(x=>{ try{URL.revokeObjectURL(x.url)}catch{} });
      state.images = [];
      state.srtText = "";
      state.cues = [];
      state.chunks = [];
      state.shots = [];
      state.baseName = "";

      el("imgInput").value = "";
      el("srtInput").value = "";
      el("imgInfo").textContent = "尚未選擇圖片";
      el("srtInfo").textContent = "尚未選擇 SRT";
      el("cards").innerHTML = "";
      setStatus("尚未產生");
      updateTopMeta();
      el("copyJsonBtn").disabled = true;
      el("downloadJsonBtn").disabled = true;
    });

    // init
    updateTopMeta();
    setStatus("尚未產生");
  </script>
</body>
</html>
