<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Story → Kling Prompts (Twist Arc)</title>
  <style>
    :root{
      --bg:#0b0f1a; --card:#111a2e; --muted:#93a4c7; --text:#eaf0ff;
      --line:rgba(255,255,255,.08); --btn:#2b63ff; --btn2:#1f2a44;
      --ok:#29d391; --warn:#ffb020;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial;
      background: radial-gradient(900px 450px at 30% 0%, rgba(43,99,255,.18), transparent 60%),
                  radial-gradient(700px 350px at 90% 10%, rgba(41,211,145,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{
      padding:18px 16px; border-bottom:1px solid var(--line);
      position:sticky; top:0; background:rgba(11,15,26,.85); backdrop-filter: blur(10px);
      z-index:10;
    }
    .wrap{max-width:1200px; margin:0 auto;}
    h1{font-size:18px; margin:0 0 6px}
    .sub{color:var(--muted); font-size:12px}
    .grid{
      display:grid; grid-template-columns: 360px 1fr; gap:14px; padding:14px 16px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      box-shadow: 0 12px 35px rgba(0,0,0,.25);
    }
    .card h2{font-size:14px; margin:0 0 10px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:10px 0}
    label{font-size:12px; color:var(--muted)}
    input[type="number"], select, textarea, input[type="text"]{
      width:100%; padding:10px 10px; border-radius:10px;
      background:rgba(0,0,0,.25); border:1px solid var(--line); color:var(--text);
      outline:none;
    }
    textarea{min-height:80px; resize:vertical}
    .btn{
      border:0; padding:10px 12px; border-radius:12px; cursor:pointer; color:white;
      background:var(--btn); font-weight:700; font-size:13px;
    }
    .btn.secondary{background:var(--btn2); color:var(--text); border:1px solid var(--line)}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .pill{
      font-size:11px; padding:6px 8px; border-radius:999px; border:1px solid var(--line);
      color:var(--muted); background:rgba(0,0,0,.18);
    }
    .ok{color:var(--ok)}
    .warn{color:var(--warn)}
    .list{
      display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px;
    }
    @media (max-width: 980px){
      .list{grid-template-columns: repeat(2, minmax(0,1fr))}
    }
    @media (max-width: 520px){
      .list{grid-template-columns: 1fr}
    }
    .item{
      border:1px solid var(--line); border-radius:14px; overflow:hidden;
      background:rgba(0,0,0,.18);
    }
    .thumb{
      aspect-ratio: 16/9;
      background:#0a0d16;
      display:flex; align-items:center; justify-content:center;
      position:relative;
    }
    .thumb img{width:100%; height:100%; object-fit:cover}
    .meta{padding:10px}
    .meta .top{display:flex; justify-content:space-between; align-items:center; gap:8px}
    .meta .idx{font-weight:800; font-size:12px}
    .meta .small{font-size:11px; color:var(--muted)}
    .meta .controls{display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:8px}
    .kv{display:grid; grid-template-columns: 1fr; gap:6px; margin-top:10px}
    .kv textarea{min-height:70px}
    .hr{height:1px; background:var(--line); margin:12px 0}
    .help{font-size:12px; color:var(--muted); line-height:1.55}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>故事影片 → 可靈/Kling 10秒動畫提示 JSON（反轉型節奏）</h1>
      <div class="sub">流程：先用 ffmpeg 切圖 → 這裡載入圖片 → 自動分配風格/運鏡 → 一鍵匯出 JSON</div>
    </div>
  </header>

  <main class="wrap grid">
    <!-- LEFT -->
    <section class="card">
      <h2>1) 載入圖片（切好的 output_*.jpg/png）</h2>
      <div class="row">
        <input id="fileInput" type="file" accept="image/*" multiple />
      </div>
      <div class="help">
        建議切圖指令（每 6 秒 1 張）：<br/>
        <span class="mono">ffmpeg -i input.mp4 -vf fps=1/6 output_%03d.jpg</span>
      </div>

      <div class="hr"></div>

      <h2>2) 反轉型（B）節奏設定</h2>
      <div class="row">
        <div style="flex:1 1 160px">
          <label>每段輸出秒數（可靈通常 10 秒）</label>
          <input id="durationSec" type="number" min="1" step="1" value="10" />
        </div>
        <div style="flex:1 1 160px">
          <label>分鏡節奏比例（10張範例：3/2/2/1/2）</label>
          <input id="ratio" type="text" value="3,2,2,1,2" />
        </div>
      </div>

      <div class="row">
        <div style="flex:1 1 160px">
          <label>反轉段（Reval）使用風格</label>
          <select id="revealStyle">
            <option value="REVEAL">專用揭露（推薦）</option>
            <option value="B_REAL">寫實</option>
            <option value="E_DARK">黑暗懸疑</option>
            <option value="D_WARM">情感溫馨</option>
            <option value="A_FAIRY">童話</option>
            <option value="C_HIST">歷史</option>
          </select>
        </div>
        <div style="flex:1 1 160px">
          <label>自動插入「轉場」張數（情緒大跳時）</label>
          <select id="transitionMode">
            <option value="auto">自動（建議）</option>
            <option value="off">不插入</option>
          </select>
        </div>
      </div>

      <div class="hr"></div>

      <h2>3) 提示詞全域加成（讓多風格一致）</h2>
      <label>全段共用尾巴（建議保留）</label>
      <textarea id="globalTail">professional movie lighting, cinematic color grading, film grain texture, high detail 4k</textarea>

      <div class="hr"></div>

      <div class="row">
        <button class="btn" id="applyAuto" disabled>套用反轉節奏（自動分配）</button>
        <button class="btn secondary" id="exportJson" disabled>匯出 JSON</button>
      </div>
      <div class="row">
        <span class="pill" id="statusPill">尚未載入圖片</span>
      </div>

      <div class="hr"></div>

      <h2>風格速記（你那 5 大類）</h2>
      <div class="help">
        <div><span class="pill">A 童話</span> 柔光、微粒、夢幻</div>
        <div><span class="pill">B 寫實</span> 自然光、像電影</div>
        <div><span class="pill">C 歷史</span> 燭光、塵埃、史詩</div>
        <div><span class="pill">D 溫馨</span> 金色光、親密</div>
        <div><span class="pill">E 懸疑</span> 低光、霧、陰影</div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="card">
      <h2>分鏡清單（可手動改每一張風格/提示）</h2>
      <div id="list" class="list"></div>
    </section>
  </main>

  <script>
    // ----- Templates -----
    const T = {
      A_FAIRY: {
        name: "A 童話",
        anim: "storybook fairy tale atmosphere, soft glowing light, gentle magical particles floating, subtle character breathing, light wind in trees, warm pastel color palette, cinematic soft focus, dreamy mood, detailed illustration texture",
        cam:  "slow gentle push in, smooth cinematic dolly forward, soft parallax depth, dreamy shallow depth of field"
      },
      B_REAL: {
        name: "B 寫實",
        anim: "realistic cinematic atmosphere, natural lighting, subtle environmental motion, detailed texture, authentic color grading, slight character breathing",
        cam:  "slow steady push in, cinematic dolly forward, minimal handheld feel, natural focus shift"
      },
      C_HIST: {
        name: "C 歷史",
        anim: "historical cinematic lighting, dramatic warm candlelight, subtle cloth movement, gentle atmospheric dust particles, realistic fabric texture, epic storytelling tone, classical color grading",
        cam:  "slow epic push in, cinematic framing, dramatic shallow depth of field, steady grand dolly"
      },
      D_WARM: {
        name: "D 溫馨",
        anim: "warm golden sunlight, soft emotional atmosphere, subtle breathing movement, gentle light flicker, natural warm color grading, intimate storytelling mood",
        cam:  "very slow push in, intimate close framing, soft focus pull, smooth cinematic movement"
      },
      E_DARK: {
        name: "E 懸疑",
        anim: "dark cinematic atmosphere, subtle fog movement, low key lighting, dramatic shadow contrast, slow ambient motion, tense storytelling mood, realistic depth",
        cam:  "slow creeping push in, minimal movement, dramatic focus shift, cinematic suspense framing"
      },
      TRANSITION: {
        name: "轉場",
        anim: "cinematic transitional lighting, subtle neutral atmosphere, smooth tonal shift, gentle ambient motion",
        cam:  "slow controlled push in, stable frame, smooth cinematic movement"
      },
      REVEAL: {
        name: "揭露",
        anim: "cinematic reveal lighting, subtle atmosphere shift, emotional intensity, high contrast but balanced tone, controlled realism",
        cam:  "controlled steady push in, slow dramatic focus shift, cinematic framing"
      }
    };

    // Twist arc: Calm → Unease → Conflict → Reveal → Aftermath
    // Default mapping: Calm(D/A), Unease(B), Conflict(E), Reveal(REVEAL), Aftermath(D/A)
    const ARC_DEFAULT = ["D_WARM", "B_REAL", "E_DARK", "REVEAL", "D_WARM"];

    // ----- State -----
    let frames = []; // {id, file, url, styleKey, anim, cam, duration}

    const $ = (id) => document.getElementById(id);
    const fileInput = $("fileInput");
    const listEl = $("list");
    const applyAutoBtn = $("applyAuto");
    const exportBtn = $("exportJson");
    const statusPill = $("statusPill");

    function setStatus(text, kind=""){
      statusPill.textContent = text;
      statusPill.className = "pill " + (kind || "");
    }

    function sortFilesByName(files){
      return [...files].sort((a,b)=> a.name.localeCompare(b.name, undefined, {numeric:true, sensitivity:"base"}));
    }

    function rebuildList(){
      listEl.innerHTML = "";
      frames.forEach((f, i)=>{
        const item = document.createElement("div");
        item.className = "item";

        const thumb = document.createElement("div");
        thumb.className = "thumb";
        const img = document.createElement("img");
        img.src = f.url;
        img.alt = f.file.name;
        thumb.appendChild(img);

        const meta = document.createElement("div");
        meta.className = "meta";

        const top = document.createElement("div");
        top.className = "top";
        top.innerHTML = `
          <div>
            <div class="idx">#${String(i+1).padStart(2,"0")} <span class="small">${escapeHtml(f.file.name)}</span></div>
          </div>
          <div class="pill">${escapeHtml(T[f.styleKey]?.name || f.styleKey)}</div>
        `;

        const controls = document.createElement("div");
        controls.className = "controls";

        // style select
        const styleWrap = document.createElement("div");
        styleWrap.innerHTML = `<label>風格</label>`;
        const sel = document.createElement("select");
        Object.keys(T).forEach(k=>{
          if(k === "TRANSITION") return; // hide in dropdown? keep it accessible below
        });
        const keys = ["A_FAIRY","B_REAL","C_HIST","D_WARM","E_DARK","REVEAL","TRANSITION"];
        keys.forEach(k=>{
          const opt = document.createElement("option");
          opt.value = k; opt.textContent = T[k].name;
          if(k === f.styleKey) opt.selected = true;
          sel.appendChild(opt);
        });
        sel.addEventListener("change", ()=>{
          f.styleKey = sel.value;
          f.anim = T[f.styleKey].anim;
          f.cam = T[f.styleKey].cam;
          rebuildList();
        });
        styleWrap.appendChild(sel);

        // duration
        const durWrap = document.createElement("div");
        durWrap.innerHTML = `<label>秒數</label>`;
        const dur = document.createElement("input");
        dur.type="number"; dur.min="1"; dur.step="1";
        dur.value = f.duration;
        dur.addEventListener("input", ()=>{
          const v = parseInt(dur.value,10);
          f.duration = isNaN(v) ? 10 : Math.max(1,v);
        });
        durWrap.appendChild(dur);

        controls.appendChild(styleWrap);
        controls.appendChild(durWrap);

        // prompts
        const kv = document.createElement("div");
        kv.className = "kv";
        const ta1 = document.createElement("textarea");
        ta1.value = f.anim;
        ta1.addEventListener("input", ()=> f.anim = ta1.value);

        const ta2 = document.createElement("textarea");
        ta2.value = f.cam;
        ta2.addEventListener("input", ()=> f.cam = ta2.value);

        kv.innerHTML = `<label>動畫提示辭</label>`;
        kv.appendChild(ta1);
        const l2 = document.createElement("label");
        l2.textContent = "運鏡辭";
        kv.appendChild(l2);
        kv.appendChild(ta2);

        meta.appendChild(top);
        meta.appendChild(controls);
        meta.appendChild(kv);

        item.appendChild(thumb);
        item.appendChild(meta);
        listEl.appendChild(item);
      });
    }

    function escapeHtml(s){
      return (s||"").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }

    function parseRatio(str){
      const parts = (str||"").split(",").map(x=>parseInt(x.trim(),10)).filter(n=>!isNaN(n) && n>0);
      if(parts.length !== 5) return null;
      return parts;
    }

    function applyTwistArc(){
      if(!frames.length) return;

      const ratioStr = $("ratio").value;
      const ratio = parseRatio(ratioStr) || [3,2,2,1,2];

      // normalize ratio to frame count
      const n = frames.length;
      const sum = ratio.reduce((a,b)=>a+b,0);

      // initial allocation by proportional scaling
      let alloc = ratio.map(r => Math.max(1, Math.round(r * n / sum)));

      // fix alloc sum to n
      let diff = n - alloc.reduce((a,b)=>a+b,0);
      while(diff !== 0){
        if(diff > 0){
          // add to calm/after first
          const idx = diff % 2 === 0 ? 0 : 4;
          alloc[idx]++; diff--;
        }else{
          // remove from largest buckets but keep >=1
          let idx = alloc.indexOf(Math.max(...alloc));
          if(alloc[idx] > 1){ alloc[idx]--; diff++; }
          else break;
        }
      }

      // build style plan
      const revealStyle = $("revealStyle").value;
      const arc = [...ARC_DEFAULT];
      arc[3] = revealStyle;

      const styleByIndex = [];
      let cursor = 0;
      for(let seg=0; seg<5; seg++){
        for(let k=0; k<alloc[seg] && cursor<n; k++){
          styleByIndex[cursor++] = arc[seg];
        }
      }
      // if still missing due to rounding
      while(styleByIndex.length < n) styleByIndex.push(arc[4]);

      // optional transitions when big jump
      const transitionMode = $("transitionMode").value;
      const bigJump = (a,b)=>{
        const hot = new Set(["E_DARK","C_HIST"]);
        const soft = new Set(["A_FAIRY","D_WARM"]);
        // jumping between hot<->soft or reveal to dark
        if((hot.has(a) && soft.has(b)) || (soft.has(a) && hot.has(b))) return true;
        if(a === "REVEAL" && b === "E_DARK") return true;
        return false;
      };

      // apply duration + prompts + style, and optionally insert transition by converting a boundary frame
      const durDefault = parseInt($("durationSec").value,10) || 10;
      const tail = $("globalTail").value.trim();

      frames.forEach((f, i)=>{
        f.duration = durDefault;
        f.styleKey = styleByIndex[i] || "D_WARM";
        f.anim = T[f.styleKey].anim;
        f.cam  = T[f.styleKey].cam;
      });

      if(transitionMode === "auto" && frames.length >= 6){
        // at boundaries between segments, if big jump, convert the first frame after boundary into TRANSITION
        let boundaries = [];
        let s = 0;
        for(let seg=0; seg<5; seg++){
          s += alloc[seg];
          boundaries.push(s); // boundary index (start of next seg)
        }
        boundaries.slice(0,4).forEach(b=>{
          const i = b; // first frame of next segment
          if(i>0 && i<frames.length){
            const prev = frames[i-1].styleKey;
            const next = frames[i].styleKey;
            if(bigJump(prev, next)){
              frames[i].styleKey = "TRANSITION";
              frames[i].anim = T.TRANSITION.anim;
              frames[i].cam  = T.TRANSITION.cam;
            }
          }
        });
      }

      // append tail to all anim prompts if not already included
      frames.forEach(f=>{
        if(tail){
          const norm = (s)=> (s||"").toLowerCase().replace(/\s+/g," ").trim();
          if(!norm(f.anim).includes(norm(tail))){
            f.anim = f.anim.replace(/\s+$/,"") + ", " + tail;
          }
        }
      });

      rebuildList();
      setStatus(`已套用反轉節奏：${frames.length} 張`, "ok");
    }

    function exportJSON(){
      const payload = frames.map((f, i)=>({
        id: i+1,
        image: f.file.name,
        duration_sec: f.duration,
        style: f.styleKey,
        animation_prompt: f.anim,
        camera_prompt: f.cam
      }));

      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "kling_prompts.json";
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 250);
    }

    fileInput.addEventListener("change", ()=>{
      // revoke old
      frames.forEach(f=> URL.revokeObjectURL(f.url));
      frames = [];

      const files = sortFilesByName(fileInput.files || []);
      if(!files.length){
        listEl.innerHTML = "";
        applyAutoBtn.disabled = true;
        exportBtn.disabled = true;
        setStatus("尚未載入圖片");
        return;
      }

      const durDefault = parseInt($("durationSec").value,10) || 10;
      frames = files.map((file, idx)=>({
        id: idx+1,
        file,
        url: URL.createObjectURL(file),
        styleKey: "D_WARM",
        anim: T.D_WARM.anim,
        cam: T.D_WARM.cam,
        duration: durDefault
      }));

      rebuildList();
      applyAutoBtn.disabled = false;
      exportBtn.disabled = false;
      setStatus(`已載入 ${frames.length} 張圖片`, "ok");
    });

    $("applyAuto").addEventListener("click", applyTwistArc);
    $("exportJson").addEventListener("click", exportJSON);
  </script>
</body>
</html>
