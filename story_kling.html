<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>故事影片 → Kling 10秒動畫提示 JSON（10–15秒 chunk）</title>
  <style>
    :root{--bg:#0b1220;--card:#111a2e;--muted:#93a4c7;--txt:#e8eefc;--line:#1f2a44;--btn:#2f6bff;}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;background:linear-gradient(180deg,#050812, #0b1220 30%, #050812);color:var(--txt);}
    header{padding:18px 18px 10px;border-bottom:1px solid var(--line);position:sticky;top:0;background:rgba(5,8,18,.9);backdrop-filter:blur(8px);z-index:5}
    h1{margin:0 0 6px;font-size:18px}
    .sub{color:var(--muted);font-size:13px}
    .wrap{padding:18px;max-width:1200px;margin:0 auto}
    .grid{display:grid;grid-template-columns:420px 1fr;gap:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px}
    input[type="file"], textarea, select, input[type="number"], input[type="text"]{
      width:100%;box-sizing:border-box;border:1px solid var(--line);background:#0b1326;color:var(--txt);
      padding:10px;border-radius:10px;font-size:14px;outline:none
    }
    textarea{min-height:92px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      border:0;background:var(--btn);color:white;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer
    }
    button.secondary{background:#223255}
    button.danger{background:#ff3b57}
    .hint{color:var(--muted);font-size:12px;margin-top:6px;line-height:1.4}
    .list{display:grid;grid-template-columns:repeat(3, minmax(0,1fr));gap:10px}
    @media (max-width:1100px){.grid{grid-template-columns:1fr}.list{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:680px){.list{grid-template-columns:1fr}}
    .shot{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#0b1326}
    .shot img{width:100%;display:block;aspect-ratio:16/9;object-fit:cover;background:#000}
    .shot .meta{padding:10px}
    .shot .title{font-weight:800;font-size:13px}
    .pill{display:inline-block;border:1px solid var(--line);padding:4px 8px;border-radius:999px;color:var(--muted);font-size:12px;margin-left:6px}
    .mini{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
    .mini textarea{min-height:70px}
    .ok{color:#7CFFA6}
    .warn{color:#ffd37c}
    code{color:#cfe1ff}
  </style>
</head>
<body>
<header>
  <h1>故事影片 → Kling 10秒動畫提示 JSON（10–15秒 chunk 對齊）</h1>
  <div class="sub">流程：匯入切好的圖片 → 匯入 SRT → 自動合併成 10–15 秒段落 → 產出每張 10 秒動畫提示 + 運鏡 → 匯出 JSON</div>
</header>

<div class="wrap">
  <div class="grid">
    <div class="card">
      <label>1) 匯入切好的圖片（多選：*_0001.jpg ...）</label>
      <input id="imgFiles" type="file" multiple accept="image/*"/>

      <label>2) 匯入 SRT（會自動依 10–15 秒合併）</label>
      <input id="srtFile" type="file" accept=".srt,text/plain"/>

      <div class="row">
        <div>
          <label>每段最短秒數（min）</label>
          <input id="minSec" type="number" value="10" min="5" max="60"/>
        </div>
        <div>
          <label>每段最長秒數（max）</label>
          <input id="maxSec" type="number" value="15" min="6" max="60"/>
        </div>
      </div>

      <label>3) 類別</label>
      <select id="category">
        <option value="story">故事</option>
        <option value="music">音樂</option>
        <option value="movie">電影</option>
        <option value="news">資訊</option>
        <option value="grammar">語法</option>
      </select>

      <label>4) 風格（A/B/C/D/E）</label>
      <select id="style">
        <option value="A">A 童話風</option>
        <option value="B">B 寫實風</option>
        <option value="C">C 歷史人物</option>
        <option value="D">D 情感溫馨</option>
        <option value="E">E 黑暗懸疑</option>
      </select>

      <label>5) 反轉型節奏（每段秒數序列，例：3,2,2,1,2）</label>
      <input id="beat" type="text" value="3,2,2,1,2"/>

      <label>6) 全域畫面加成（會加到每段提示詞尾巴）</label>
      <textarea id="global" spellcheck="false">cinematic lighting, professional color grading, subtle film grain, high detail, 4k</textarea>
      <div class="hint">建議保持一致，讓整支影片風格穩。</div>

      <div class="btns">
        <button id="build">生成分鏡（對齊 SRT chunk）</button>
        <button class="secondary" id="export">匯出 kling_prompts.json</button>
        <button class="danger" id="clear">清空</button>
      </div>
      <div class="hint">
        ✅ 你已經切好 <code>10–15秒</code> 的圖片/MP3 → 這頁把 SRT 合併成相同 chunk，確保 <b>圖片#0001 對應字幕#0001</b>。
      </div>
    </div>

    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <div>
          <div style="font-weight:900">分鏡清單</div>
          <div class="sub">可手動改每段的「動畫提示詞 / 運鏡」。</div>
        </div>
        <div id="status" class="sub"></div>
      </div>
      <div id="shots" class="list" style="margin-top:12px"></div>
    </div>
  </div>
</div>

<script>
  // ---------- helpers ----------
  const $ = (id) => document.getElementById(id);
  const pad4 = (n) => String(n).padStart(4,'0');

  function srtTimeToSec(t){
    // 00:00:12,345 or 00:00:12.345
    const m = t.match(/(\d{2}):(\d{2}):(\d{2})[,.](\d{3})/);
    if(!m) return 0;
    const hh=+m[1], mm=+m[2], ss=+m[3], ms=+m[4];
    return hh*3600+mm*60+ss+ms/1000;
  }

  function parseSrt(text){
    const blocks = text.replace(/\r/g,'').split(/\n\s*\n/);
    const segs = [];
    for(const b of blocks){
      const lines = b.trim().split('\n').filter(Boolean);
      if(lines.length < 3) continue;
      const timeLine = lines[1];
      if(!timeLine.includes('-->')) continue;
      const [a,b2] = timeLine.split('-->').map(s=>s.trim());
      const s = srtTimeToSec(a), e = srtTimeToSec(b2);
      const caption = lines.slice(2).join(' ').trim();
      if(e>s && caption) segs.push({s,e,caption});
    }
    return segs;
  }

  function chunkSegs(segs, minSec, maxSec){
    if(!segs.length) return [];
    const out = [];
    let cs = segs[0].s, ce = segs[0].e, texts=[segs[0].caption];
    for(let i=1;i<segs.length;i++){
      const candEnd = segs[i].e;
      const candDur = candEnd - cs;
      if(candDur <= maxSec){
        ce = candEnd;
        texts.push(segs[i].caption);
      }else{
        out.push({s:cs, e:ce, caption:texts.join(' ')});
        cs = segs[i].s; ce = segs[i].e; texts=[segs[i].caption];
      }
    }
    out.push({s:cs, e:ce, caption:texts.join(' ')});
    return out;
  }

  function stylePrefix(style){
    switch(style){
      case 'A': return "original fairy-tale fable, animal characters, storybook illustration";
      case 'B': return "original cinematic realism, animal characters, natural textures";
      case 'C': return "historical period illustration, authentic costumes, documentary tone";
      case 'D': return "warm emotional storytelling, gentle light, intimate mood";
      case 'E': return "dark suspense mood, dramatic shadows, tense atmosphere";
      default: return "original cinematic storytelling";
    }
  }

  function cameraMoveForBeat(i, beats){
    const b = beats[i % beats.length] || 2;
    // 反轉型：短→更緊張/更動；長→更平穩
    if(b <= 1) return "fast push-in, slight handheld, dramatic focus shift";
    if(b == 2) return "slow push-in, subtle parallax, smooth cinematic movement";
    if(b == 3) return "very slow push-in, steady framing, gentle camera drift";
    return "slow dolly, smooth movement";
  }

  function buildPrompt(style, caption, globalTail){
    // 強制圍繞字幕（可靈 prompt）
    return `${stylePrefix(style)}, match the scene described: ${caption}. no subtitles, no logos, no text on screen. ${globalTail}`.trim();
  }

  // ---------- state ----------
  let imgs = [];      // {name, url}
  let srtSegs = [];
  let chunks = [];
  let shots = [];     // final

  // ---------- UI ----------
  $('imgFiles').addEventListener('change', async (e)=>{
    imgs = [];
    for(const f of [...e.target.files]){
      const url = URL.createObjectURL(f);
      imgs.push({name:f.name, url});
    }
    // sort by ..._0001, ..._0002
    const re = /_(\d{4})\./;
    imgs.sort((a,b)=>{
      const ma = a.name.match(re), mb = b.name.match(re);
      const ia = ma?+ma[1]:999999, ib = mb?+mb[1]:999999;
      return ia-ib;
    });
    $('status').textContent = `已載入圖片：${imgs.length} 張`;
  });

  $('srtFile').addEventListener('change', async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    const text = await f.text();
    srtSegs = parseSrt(text);
    $('status').textContent = `已載入 SRT：${srtSegs.length} 段`;
  });

  function render(){
    const root = $('shots');
    root.innerHTML = "";
    shots.forEach((s, idx)=>{
      const div = document.createElement('div');
      div.className = 'shot';
      div.innerHTML = `
        <img src="${s.image_url}" alt="">
        <div class="meta">
          <div class="title">#${pad4(idx+1)} <span class="pill">${s.style}</span> <span class="pill">${s.seconds}s</span></div>
          <div class="hint" style="margin-top:6px;max-height:40px;overflow:auto">${s.caption}</div>
          <div class="mini">
            <div>
              <label style="margin:0 0 6px">動畫提示詞</label>
              <textarea data-k="prompt">${s.prompt}</textarea>
            </div>
            <div>
              <label style="margin:0 0 6px">運鏡</label>
              <textarea data-k="camera">${s.camera}</textarea>
            </div>
          </div>
        </div>
      `;
      // bind changes
      div.querySelectorAll('textarea').forEach(t=>{
        t.addEventListener('input', ()=>{
          const k = t.getAttribute('data-k');
          shots[idx][k] = t.value;
        });
      });
      root.appendChild(div);
    });
    $('status').innerHTML = `分鏡：<span class="ok">${shots.length}</span>（圖片 vs chunk 取最小）`;
  }

  $('build').addEventListener('click', ()=>{
    const minSec = +$('minSec').value || 10;
    const maxSec = +$('maxSec').value || 15;
    const style = $('style').value;
    const beats = $('beat').value.split(',').map(x=>parseInt(x.trim(),10)).filter(Boolean);
    const globalTail = $('global').value.trim();

    if(!imgs.length){ alert("請先匯入切好的圖片（多選）"); return; }
    if(!srtSegs.length){ alert("請先匯入 SRT"); return; }

    chunks = chunkSegs(srtSegs, minSec, maxSec);

    const n = Math.min(imgs.length, chunks.length);
    shots = [];
    for(let i=0;i<n;i++){
      const caption = chunks[i].caption.trim();
      shots.push({
        index: i+1,
        image_name: imgs[i].name,
        image_url: imgs[i].url,
        seconds: 10,
        style,
        caption,
        prompt: buildPrompt(style, caption, globalTail),
        camera: cameraMoveForBeat(i, beats)
      });
    }
    render();
  });

  $('export').addEventListener('click', ()=>{
    if(!shots.length){ alert("先按「生成分鏡」"); return; }
    // export minimal json for Kling
    const payload = {
      meta: {
        category: $('category').value,
        style: $('style').value,
        chunk_rule: {min:+$('minSec').value||10, max:+$('maxSec').value||15},
        seconds_per_clip: 10,
        beat_pattern: $('beat').value,
        global_tail: $('global').value.trim()
      },
      shots: shots.map(s=>({
        index: s.index,
        image_name: s.image_name,
        seconds: s.seconds,
        caption: s.caption,
        prompt: s.prompt,
        camera: s.camera
      }))
    };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = "kling_prompts.json";
    a.click();
  });

  $('clear').addEventListener('click', ()=>{
    shots=[]; chunks=[]; srtSegs=[]; imgs=[];
    $('imgFiles').value=""; $('srtFile').value="";
    $('shots').innerHTML=""; $('status').textContent="";
  });
</script>
</body>
</html>

