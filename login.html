<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç™»å…¥ï½œBookWide</title>
  <meta name="color-scheme" content="light" />
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --brand:#2563eb;
      --brand2:#1d4ed8;
      --danger:#b91c1c;
      --ok:#166534;
      --radius:16px;
      --shadow:0 20px 60px rgba(2,6,23,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      background:linear-gradient(180deg,#ffffff 0%, var(--bg) 80%);
      color:var(--ink);
    }
    a{color:var(--brand);text-decoration:none}
    a:hover{text-decoration:underline}

    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:28px 16px;}
    .card{
      width:min(980px, 100%);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:24px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .head{
      display:flex;align-items:center;justify-content:space-between;
      padding:18px 22px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg,#fff, #fafbff);
    }
    .brand{display:flex;gap:10px;align-items:baseline}
    .brand .logo{font-weight:900;font-size:22px;letter-spacing:.2px}
    .brand .tag{font-size:12px;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
    .head .hint{font-size:12px;color:var(--muted)}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:0}
    .col{padding:22px}
    .col + .col{border-left:1px solid var(--line);background:#fbfbff}

    h1{margin:0 0 12px;font-size:22px}
    .sub{margin:0 0 18px;color:var(--muted);font-size:14px;line-height:1.5}

    .field{margin:14px 0}
    .label{display:block;font-size:13px;color:var(--muted);margin:0 0 6px}

    .input{
      display:flex;align-items:center;gap:10px;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
    }
    .input:focus-within{border-color:#93c5fd;box-shadow:0 0 0 3px rgba(59,130,246,.15)}

    .icon{
      width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center;
      color:#475569;
      flex:0 0 auto;
    }
    input{
      border:0;outline:none;background:transparent;
      width:100%;
      font-size:15px;
      color:var(--ink);
    }

    .pwwrap{position:relative;flex:1}
    .eye{
      position:absolute;right:2px;top:50%;transform:translateY(-50%);
      border:0;background:transparent;cursor:pointer;
      padding:6px;border-radius:10px;color:#334155;
    }
    .eye:hover{background:#f1f5f9}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    .btn{
      appearance:none;border:1px solid var(--line);
      background:#fff;color:var(--ink);
      padding:10px 14px;border-radius:12px;
      font-weight:700;cursor:pointer;
      transition:transform .05s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.primary:hover{background:var(--brand2);border-color:var(--brand2)}
    .btn.ghost{background:transparent}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .msg{margin-top:12px;font-size:13px;line-height:1.4;display:none}
    .msg.ok{color:var(--ok)}
    .msg.err{color:var(--danger)}

    .providerTitle{font-weight:800;margin:2px 0 10px}
    .pbtn{
      width:100%;
      display:flex;align-items:center;justify-content:center;gap:10px;
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 14px;
      background:#fff;
      cursor:pointer;
      font-weight:800;
      margin:10px 0;
    }
    .pbtn:hover{border-color:#cbd5e1;box-shadow:0 8px 20px rgba(2,6,23,.06)}
    .pbtn:disabled{opacity:.6;cursor:not-allowed}

    .picon{width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center}

    .note{margin-top:10px;font-size:12px;color:var(--muted);line-height:1.5}

    .foot{padding:14px 22px;border-top:1px solid var(--line);display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;font-size:12px;color:var(--muted)}

    @media (max-width:860px){
      .grid{grid-template-columns:1fr}
      .col + .col{border-left:0;border-top:1px solid var(--line)}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="dialog" aria-labelledby="title">
      <div class="head">
        <div class="brand">
          <div class="logo">BookWide</div>
          <div class="tag">Login</div>
        </div>
        <div class="hint">ç™»å…¥å¾Œæœƒè‡ªå‹•å›åˆ°åŸé ï¼ˆ?next=...ï¼‰</div>
      </div>

      <div class="grid">
        <!-- Left: Email / Password -->
        <section class="col">
          <h1 id="title">ç™»å…¥</h1>
          <p class="sub">æ”¯æ´ <b>Email/å¯†ç¢¼</b>ï¼Œä»¥åŠ <b>Google</b> ä¸€éµç™»å…¥ï¼ˆFacebook / LINE / å¾®ä¿¡ å…ˆé ç•™ï¼‰ã€‚</p>

          <div class="field">
            <label class="label" for="email">é›»å­ä¿¡ç®±</label>
            <div class="input">
              <span class="icon" aria-hidden="true">âœ‰ï¸</span>
              <input id="email" type="email" autocomplete="email" placeholder="mail@example.com" />
            </div>
          </div>

          <div class="field">
            <label class="label" for="password">å¯†ç¢¼</label>
            <div class="input" style="gap:8px;">
              <span class="icon" aria-hidden="true">ğŸ”’</span>
              <div class="pwwrap">
                <input id="password" type="password" autocomplete="current-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
                <button class="eye" id="btnEye" type="button" aria-label="é¡¯ç¤ºå¯†ç¢¼">ğŸ‘ï¸</button>
              </div>
            </div>
          </div>

          <div class="row">
            <button class="btn primary" id="btnLogin" type="button">ç™»å…¥</button>
            <button class="btn" id="btnSignup" type="button">æ–°ç”¨æˆ¶è¨»å†Š</button>
            <button class="btn ghost" id="btnBack" type="button">å›é¦–é </button>
          </div>

          <div class="row" style="justify-content:space-between">
            <a id="forgot" href="#" style="font-size:13px">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ</a><span style="display:inline-block;width:10px"></span><a id="resend" href="#" style="font-size:13px">é‡å¯„é©—è­‰ä¿¡</a>
            <a id="openNext" href="#" style="font-size:13px">ç›®å‰å°å›ï¼š<span id="nextLabel">/</span></a>
          </div>

          <div id="msg" class="msg"></div>

          <div class="note">
            è‹¥ä½ é‡åˆ°ã€Œç™»å‡ºå¾Œåˆè‡ªå‹•ç™»å…¥ã€ï¼šé€™é€šå¸¸æ˜¯ Google æœ¬èº«è¨˜ä½äº†ä½ åœ¨ç€è¦½å™¨çš„ç™»å…¥ç‹€æ…‹ã€‚BookWide é€™é‚Šæœƒå¼·åˆ¶æ¯æ¬¡ Google ç™»å…¥éƒ½è·³é¸å¸³è™Ÿï¼ˆselect_accountï¼‰ã€‚
          </div>
        </section>

        <!-- Right: Social buttons -->
        <aside class="col">
          <div class="providerTitle">ç”¨å…¶ä»–å¸³è™Ÿç™»å…¥</div>

          <button class="pbtn" id="btnGoogle" type="button">
            <span class="picon" aria-hidden="true">G</span>
            ç”¨ Google å¸³è™Ÿç™»å…¥
          </button>

          <button class="pbtn" id="btnFacebook" type="button" disabled>
            <span class="picon" aria-hidden="true">f</span>
            ç”¨ Facebook å¸³è™Ÿç™»å…¥ï¼ˆé ç•™ï¼‰
          </button>

          <button class="pbtn" id="btnLine" type="button" disabled>
            <span class="picon" aria-hidden="true">LINE</span>
            ç”¨ LINE å¸³è™Ÿç™»å…¥ï¼ˆé ç•™ï¼‰
          </button>

          <button class="pbtn" id="btnWeChat" type="button" disabled>
            <span class="picon" aria-hidden="true">å¾®</span>
            ç”¨ å¾®ä¿¡ å¸³è™Ÿç™»å…¥ï¼ˆé ç•™ï¼‰
          </button>

          <div class="note">
            ç›®å‰å·²å…ˆæŠŠ Google (Supabase Providers) æ‰“é€šï¼›æ¥ä¸‹ä¾†æˆ‘å€‘å†ä¸€å€‹ä¸€å€‹æŠŠ LINE / FB / å¾®ä¿¡æ¥ä¸Šã€‚
          </div>
        </aside>
      </div>

      <div class="foot">
        <div>Â© 2025 BookWide</div>
        <div>å»ºè­°ä½¿ç”¨æœ€æ–° Chrome / Edge / Safari</div>
      </div>
    </div>
  </div>

  <!-- Supabase JS (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js" crossorigin="anonymous"></script>
  <script>
  // ================================
  // âœ… é€™è£¡å·²ç›´æ¥å…§å»ºä½ çš„å°ˆæ¡ˆ URL / anon keyï¼ˆä¸ç”¨å†æ‰‹å‹•å¡«ï¼‰
  // ================================
  const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";

  const $ = (id)=>document.getElementById(id);

  function getNextUrl(){
    const u = new URL(location.href);
    const next = u.searchParams.get('next');
    // å…è¨±ç›¸å°è·¯å¾‘æˆ–åŒæºç¶²å€ï¼Œé¿å… open redirect
    if(!next) return location.origin + '/index.html';
    try{
      const nextUrl = new URL(next, location.origin);
      if(nextUrl.origin !== location.origin) return location.origin + '/index.html';
      return nextUrl.toString();
    }catch(e){
      return location.origin + '/index.html';
    }
  }

  function showMsg(text, kind){
    const el = $('msg');
    el.className = 'msg ' + (kind || '');
    el.textContent = text;
    el.style.display = 'block';
  }
  function hideMsg(){
    const el = $('msg');
    el.style.display = 'none';
  }

  // password eye
  (function(){
    const pw = $('password');
    const btn = $('btnEye');
    let shown = false;
    btn.addEventListener('click', ()=>{
      shown = !shown;
      pw.type = shown ? 'text' : 'password';
      btn.textContent = shown ? 'ğŸ™ˆ' : 'ğŸ‘ï¸';
      btn.setAttribute('aria-label', shown ? 'éš±è—å¯†ç¢¼' : 'é¡¯ç¤ºå¯†ç¢¼');
      pw.focus();
    });
  })();

  // next label
  $('nextLabel').textContent = new URL(getNextUrl()).pathname;
  $('openNext').addEventListener('click', (e)=>{ e.preventDefault(); window.open(getNextUrl(), '_blank'); });

  $('btnBack').addEventListener('click', ()=> location.href = '/index.html');

  // é˜²æ­¢ supabase-js åœ¨æŸäº›ç€è¦½å™¨ / ç¶²è·¯è¢«æ“‹ï¼šçµ¦æ˜ç¢ºéŒ¯èª¤
  if(!window.supabase){
    showMsg('è¼‰å…¥ Supabase SDK å¤±æ•—ï¼ˆå¯èƒ½è¢«ç€è¦½å™¨æˆ–ç¶²è·¯é˜»æ“‹ï¼‰ã€‚è«‹ç¢ºèªèƒ½é€£åˆ° jsdelivrï¼Œæˆ–æ”¹ç”¨ Chrome/Edgeã€‚', 'err');
  }

  const supabaseClient = window.supabase
    ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: true
        }
      })
    : null;

  async function redirectIfLoggedIn(){
    if(!supabaseClient) return;
    try{
      const { data: { session } } = await supabaseClient.auth.getSession();
      if(session){
        showMsg('å·²ç™»å…¥ï¼Œæ­£åœ¨å°å›â€¦', 'ok');
        location.replace(getNextUrl());
      }
    }catch(e){
      // ignore
    }
  }

  async function signInWithGoogle(){
    if(!supabaseClient) return;
    hideMsg();
    $('btnGoogle').disabled = true;
    try{
      await supabaseClient.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: location.origin + '/login.html',
          // âœ… æ¯æ¬¡éƒ½è·³é¸å¸³è™Ÿï¼Œé¿å…è‡ªå‹•å¸¶å…¥
          queryParams: { prompt: 'select_account' }
        }
      });
    }catch(err){
      console.error(err);
      showMsg('Google ç™»å…¥å¤±æ•—ï¼š' + (err?.message || err), 'err');
      $('btnGoogle').disabled = false;
    }
  }

  
  async function signInWithLine(){
    if(!supabaseClient) return;
    hideMsg();
    const btn = $('btnLine');
    if(btn) btn.disabled = true;
    try{
      await supabaseClient.auth.signInWithOAuth({
        provider: 'line',
        options: { redirectTo: location.origin + '/login.html' }
      });
    }catch(err){
      console.error(err);
      showMsg('LINE ç™»å…¥å¤±æ•—ï¼š' + (err?.message || err) + 'ï¼ˆè«‹ç¢ºèª Supabase å·²å•Ÿç”¨ LINE Providerï¼Œä¸¦è¨­å®š Redirect URLï¼‰', 'err');
      if(btn) btn.disabled = false;
    }
  }
async function signInWithEmail(){
    if(!supabaseClient) return;
    hideMsg();
    const email = $('email').value.trim();
    const password = $('password').value;
    if(!email || !password) return showMsg('è«‹è¼¸å…¥ Email èˆ‡å¯†ç¢¼ã€‚', 'err');

    $('btnLogin').disabled = true;
    try{
      const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if(error) throw error;
      showMsg('ç™»å…¥æˆåŠŸï¼Œæ­£åœ¨å°å›â€¦', 'ok');
      location.replace(getNextUrl());
    }catch(err){
      console.error(err);
      showMsg('ç™»å…¥å¤±æ•—ï¼š' + (err?.message || err), 'err');
    }finally{
      $('btnLogin').disabled = false;
    }
  }

  async function signUpWithEmail(){
    if(!supabaseClient) return;
    hideMsg();
    const email = $('email').value.trim();
    const password = $('password').value;
    if(!email || !password) return showMsg('è«‹è¼¸å…¥ Email èˆ‡å¯†ç¢¼ã€‚', 'err');

    $('btnSignup').disabled = true;
    try{
      const { data, error } = await supabaseClient.auth.signUp({
        email,
        password,
        options: { emailRedirectTo: location.origin + '/login.html' }
      });

      if(error){
        const msg = String(error.message || error);
        // å¸¸è¦‹ï¼šå·²è¨»å†Šï¼ˆæˆ–å·²å­˜åœ¨ä½†å°šæœªé©—è­‰ï¼‰
        if(/already registered/i.test(msg) || /User already registered/i.test(msg) || error.status === 422){
          showMsg('æ­¤ Email å·²è¨»å†Šã€‚è«‹æ”¹ç”¨ã€Œç™»å…¥ã€æˆ–é»ã€Œå¿˜è¨˜å¯†ç¢¼ã€ã€‚è‹¥æœªæ”¶åˆ°é©—è­‰ä¿¡ï¼Œå¯é»ã€Œé‡å¯„é©—è­‰ä¿¡ã€ã€‚', 'err');
          return;
        }
        throw error;
      }

      // âœ… supabase çš„ signUp åœ¨ã€ŒEmail å·²å­˜åœ¨ã€æ™‚ï¼Œæœ‰æ™‚ä¸ä¸Ÿ errorï¼Œ
      // ä½†æœƒå›å‚³ user ä¸” identities ç‚ºç©ºé™£åˆ—ï¼ˆä»£è¡¨æ²’æœ‰å»ºç«‹æ–°èº«ä»½ï¼‰
      const ids = data?.user?.identities;
      if(data?.user && Array.isArray(ids) && ids.length === 0){
        showMsg('æ­¤ Email å·²è¨»å†Šã€‚è«‹æ”¹ç”¨ã€Œç™»å…¥ã€æˆ–é»ã€Œå¿˜è¨˜å¯†ç¢¼ã€ã€‚è‹¥æœªæ”¶åˆ°é©—è­‰ä¿¡ï¼Œå¯é»ã€Œé‡å¯„é©—è­‰ä¿¡ã€ã€‚', 'err');
        return;
      }



      // éœ€è¦ä¿¡ç®±é©—è­‰æ™‚ï¼šdata.session æœƒæ˜¯ null
      if(data?.user && !data?.session){
        showMsg('è¨»å†ŠæˆåŠŸï¼è«‹åˆ°ä¿¡ç®±é»é©—è­‰é€£çµå¾Œï¼Œå†å›ä¾†ç™»å…¥ã€‚è‹¥æ²’æ”¶åˆ°ï¼Œè«‹å…ˆçœ‹åƒåœ¾éƒµä»¶ï¼Œæˆ–é»ã€Œé‡å¯„é©—è­‰ä¿¡ã€ã€‚', 'ok');
      }else{
        showMsg('è¨»å†ŠæˆåŠŸï¼Œæ­£åœ¨å°å›â€¦', 'ok');
        location.replace(getNextUrl());
      }
    }catch(err){
      console.error(err);
      showMsg('è¨»å†Šå¤±æ•—ï¼š' + (err?.message || err), 'err');
    }finally{
      $('btnSignup').disabled = false;
    }
  }

  $('btnGoogle').addEventListener('click', signInWithGoogle);
  $('btnLine')?.addEventListener('click', signInWithLine);
  $('btnLogin').addEventListener('click', signInWithEmail);
  $('btnSignup').addEventListener('click', signUpWithEmail);

  $('forgot').addEventListener('click', async (e)=>{
    e.preventDefault();
    if(!supabaseClient) return;
    const email = $('email').value.trim();
    if(!email) return showMsg('è«‹å…ˆè¼¸å…¥ Emailï¼Œå†é»å¿˜è¨˜å¯†ç¢¼ã€‚', 'err');
    try{
      await supabaseClient.auth.resetPasswordForEmail(email, { redirectTo: location.origin + '/reset.html' });
      showMsg('å·²å¯„å‡ºé‡è¨­å¯†ç¢¼ä¿¡ï¼Œè«‹åˆ°ä¿¡ç®±æ”¶ä¿¡ã€‚', 'ok');
    }catch(err){
      console.error(err);
      showMsg('å¯„é€å¤±æ•—ï¼š' + (err?.message || err), 'err');
    }
  });
  $('resend')?.addEventListener('click', async (e)=>{
    e.preventDefault();
    if(!supabaseClient) return;
    hideMsg();
    const email = $('email').value.trim();
    if(!email) return showMsg('è«‹å…ˆè¼¸å…¥ Emailï¼Œå†é»é‡å¯„é©—è­‰ä¿¡ã€‚', 'err');
    try{
      // Supabase v2ï¼šresend signup confirmation
      const { error } = await supabaseClient.auth.resend({
        type: 'signup',
        email,
        options: { emailRedirectTo: location.origin + '/login.html' }
      });
      if(error) throw error;
      showMsg('å·²ç™¼é€é©—è­‰ä¿¡ï¼ˆè‹¥ä»æ”¶ä¸åˆ°ï¼Œè«‹çœ‹åƒåœ¾éƒµä»¶ï¼Œæˆ–åˆ° Supabase è¨­å®š SMTPï¼‰ã€‚', 'ok');
    }catch(err){
      console.error(err);
      showMsg('é‡å¯„å¤±æ•—ï¼š' + (err?.message || err), 'err');
    }
  });


  if(supabaseClient){
    redirectIfLoggedIn();
    supabaseClient.auth.onAuthStateChange((event, session)=>{
      if(session){
        showMsg('å·²ç™»å…¥ï¼Œæ­£åœ¨å°å›â€¦', 'ok');
        location.replace(getNextUrl());
      }
    });
  }
  </script>
</body>
</html>


