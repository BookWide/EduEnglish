<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>訂閱到期提醒監控｜BookWide Admin</title>
<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --text:#0f172a; --muted:#64748b;
    --line:#e5e7eb; --blue:#2563eb; --green:#16a34a; --red:#dc2626; --amber:#d97706;
    --radius:16px;
  }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC,Helvetica,Arial;background:var(--bg);color:var(--text);}
  .topbar{position:sticky;top:0;z-index:5;background:linear-gradient(90deg,#0b1220,#0f1a33);color:#fff;padding:14px 16px;display:flex;align-items:center;gap:12px}
  .topbar h1{font-size:16px;margin:0;font-weight:700;letter-spacing:.2px}
  .topbar .sub{font-size:12px;opacity:.85}
  .btn{appearance:none;border:0;background:var(--blue);color:#fff;padding:10px 14px;border-radius:999px;cursor:pointer;font-weight:700;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
  .btn.secondary{background:#0b1220;border:1px solid rgba(255,255,255,.25)}
  .wrap{max-width:1100px;margin:16px auto;padding:0 12px 40px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 1px 2px rgba(15,23,42,.06);padding:14px}
  .kpi{flex:1;min-width:220px}
  .kpi .label{color:var(--muted);font-size:12px;margin-bottom:6px}
  .kpi .value{font-size:26px;font-weight:800;line-height:1}
  .kpi .hint{color:var(--muted);font-size:12px;margin-top:6px}
  .value.ok{color:var(--green)} .value.warn{color:var(--amber)} .value.bad{color:var(--red)}
  .sectionTitle{display:flex;align-items:end;justify-content:space-between;margin:18px 2px 10px}
  .sectionTitle h2{margin:0;font-size:16px}
  .sectionTitle .meta{color:var(--muted);font-size:12px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  .tableWrap{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch}
  td,th{word-break:break-word}
  th,td{font-size:13px;padding:10px 10px;border-bottom:1px solid var(--line);vertical-align:top}
  th{color:var(--muted);font-weight:700;text-align:left;background:#fafafa;position:static}
  tr:hover td{background:#fcfcff}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:800}
  .pill.ok{background:rgba(22,163,74,.10);color:var(--green)}
  .pill.bad{background:rgba(220,38,38,.10);color:var(--red)}
  .pill.warn{background:rgba(217,119,6,.10);color:var(--amber)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .input{border:1px solid var(--line);border-radius:999px;padding:10px 12px;background:#fff;min-width:260px}
  .small{font-size:12px;color:var(--muted)}
  .grid2{display:grid;grid-template-columns:1fr;gap:12px}
    .hide{display:none}

/* ===== Responsive table: avoid horizontal scrolling, prevent "covered" rows ===== */
.table-wrap{ overflow-x:hidden; }
.table-wrap table{ width:100%; table-layout:fixed; }
.table-wrap th, .table-wrap td{ white-space:normal; word-break:break-word; }

@media (max-width: 1024px){
  /* remove min width that forces sideways scroll */
  .table-wrap table{ min-width:0 !important; }
  /* tighten spacing */
  .table-wrap th, .table-wrap td{ padding:10px 10px; font-size:13px; }
  /* hide least important column: "Order / Buyer" (4th col) */
  .table-wrap thead th:nth-child(4),
  .table-wrap tbody td:nth-child(4){ display:none; }
}

@media (max-width: 640px){
  /* turn each row into a card */
  .table-wrap{ max-height:none !important; overflow:visible !important; }
  .table-wrap table, .table-wrap thead, .table-wrap tbody, .table-wrap th, .table-wrap td, .table-wrap tr{
    display:block;
    width:100%;
  }
  .table-wrap thead{ display:none; }
  .table-wrap tr{
    border:1px solid rgba(0,0,0,.06);
    border-radius:12px;
    padding:10px 12px;
    margin:10px 0;
    background:#fff;
  }
  .table-wrap td{
    border:none !important;
    padding:6px 0 !important;
  }
  .table-wrap td::before{
    display:block;
    font-size:12px;
    color:var(--muted);
    margin-bottom:2px;
  }
  /* labels for 4-column tables: 到期日 / 寄送狀態 / Email / Order */
  #tbPending tr td:nth-child(1)::before{ content:"到期日"; }
  #tbPending tr td:nth-child(2)::before{ content:"寄送狀態"; }
  #tbPending tr td:nth-child(3)::before{ content:"Email"; }
  #tbPending tr td:nth-child(4)::before{ content:"Order / Buyer"; }

  #tbLogs tr td:nth-child(1)::before{ content:"時間"; }
  #tbLogs tr td:nth-child(2)::before{ content:"結果"; }
  #tbLogs tr td:nth-child(3)::before{ content:"Email"; }
}

</style>
</head>
<body>
  <div class="topbar">
    <a class="btn secondary" href="/admin.html">← 回後台</a>
    <div>
      <h1>訂閱到期提醒監控</h1>
      <div class="sub" id="subtitle">載入中…</div>
    </div>
    <div style="margin-left:auto;display:flex;gap:10px;align-items:center">
      <button class="btn" id="btnRefresh">重新整理</button>
      <button class="btn secondary" id="btnResendTest">補寄測試</button>
    </div>
  </div>

  <div class="wrap">
    <div class="row">
      <div class="card kpi">
        <div class="label">今日 +7 天到期（總筆數）</div>
        <div class="value" id="k_due_total">—</div>
        <div class="hint">orders.status=paid 且 expire_at 落在「台北今天+7天」</div>
      </div>
      <div class="card kpi">
        <div class="label">待寄 7 天提醒</div>
        <div class="value" id="k_due_pending">—</div>
        <div class="hint">reminder_sent_at 仍為空</div>
      </div>
      <div class="card kpi">
        <div class="label">今天已寄 7 天提醒</div>
        <div class="value" id="k_sent_today">—</div>
        <div class="hint">orders.reminder_sent_at 在今天（台北）</div>
      </div>
      <div class="card kpi">
        <div class="label">今天已寄 到期信</div>
        <div class="value" id="k_expired_today">—</div>
        <div class="hint">orders.expire_reminder_sent_at 在今天（台北）</div>
      </div>
    </div>

    <div class="grid2" style="margin-top:12px">
      <div class="card">
        <div class="sectionTitle">
          <h2>待寄名單（到期前 7 天）</h2>
          <div class="meta" id="dueWindow">—</div>
        </div>
        <div class="toolbar" style="margin:8px 0 12px">
          <input id="q" class="input" placeholder="搜尋 Email / buyer_id / order_id…"/>
          <span class="small">提示：用 email_to 或 buyer_id 找</span>
        </div>
        <div class="table-wrap" style="overflow:auto;max-height:520px;border:1px solid var(--line);border-radius:12px">
          <table>
            <thead>
              <tr>
                <th style="min-width:160px">到期日</th>
                <th style="min-width:220px">寄送狀態</th>
                <th style="min-width:260px">Email</th>
                <th style="min-width:260px">Order / Buyer</th>
              </tr>
            </thead>
            <tbody id="tbPending">
              <tr><td colspan="4" class="small">載入中…</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="sectionTitle">
          <h2>今日寄送紀錄（email_logs）</h2>
          <div class="meta" id="logWindow">—</div>
        </div>
        <div class="small" style="margin-bottom:10px">若你的資料庫沒有 email_logs 或 RLS 擋住，這區會顯示「無法讀取」。</div>
        <div class="table-wrap" style="overflow:auto;max-height:520px;border:1px solid var(--line);border-radius:12px">
          <table>
            <thead>
              <tr>
                <th style="min-width:160px">時間</th>
                <th style="min-width:120px">結果</th>
                <th style="min-width:260px">Email</th>
                <th>備註</th>
              </tr>
            </thead>
            <tbody id="tbLogs">
              <tr><td colspan="4" class="small">載入中…</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="sectionTitle">
        <h2>說明（你只要看這裡）</h2>
        <div class="meta">單一真相：orders / 快取：profiles</div>
      </div>
      <ul class="small" style="margin:0 0 0 18px;line-height:1.7">
        <li><b>7 天前提醒是否寄出</b>：以 <span class="mono">orders.reminder_sent_at</span> 為準。</li>
        <li><b>到期信是否寄出</b>：以 <span class="mono">orders.expire_reminder_sent_at</span> 為準。</li>
        <li>前端是否放行：建議只看 <span class="mono">profiles.expires_at</span>（快取），付款真相仍以 orders 為準。</li>
      </ul>
    </div>
  </div>

<script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
<script>
  const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
  const SUPABASE_ANON =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
  const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  const DENY_SIGNIN = "/index.html?denied=signin";
  const DENY_ADMIN  = "/index.html?denied=admin";
  const DENY_PAUSED = "/index.html?denied=paused";
  const DENY_PROFILE= "/index.html?denied=profile";

  function kick(url){
    try { location.replace(url); } catch(e){ location.href = url; }
  }

  async function requireAdmin() {
    const { data: sess } = await supa.auth.getSession();
    const session = sess?.session;
    if (!session?.user) return kick(DENY_SIGNIN);

    const { data: profile, error } = await supa
      .from("profiles")
      .select("email,is_admin,is_paused")
      .eq("id", session.user.id)
      .maybeSingle();

    if (error || !profile) return kick(DENY_PROFILE);
    if (profile.is_paused) return kick(DENY_PAUSED);
    if (!profile.is_admin) return kick(DENY_ADMIN);

    return { session, profile };
  }

  function fmtDateTimeTW(iso){
    if(!iso) return "";
    try{
      return new Date(iso).toLocaleString("zh-TW", { timeZone:"Asia/Taipei", hour12:false });
    }catch(e){ return iso; }
  }

  function dateKeyTW(d=new Date()){
    return new Intl.DateTimeFormat("en-CA", {
      timeZone:"Asia/Taipei", year:"numeric", month:"2-digit", day:"2-digit"
    }).format(d);
  }

  function twDayToUtcRange(dateKey){
    // dateKey: YYYY-MM-DD (Taipei day)
    const [y,m,d] = dateKey.split("-").map(Number);
    // Taipei 00:00 == UTC-8 in clock (Asia/Taipei is UTC+8)
    // So UTC time = Date.UTC(y,m-1,d,0) - 8h
    const start = new Date(Date.UTC(y, m-1, d, 0,0,0));
    start.setUTCHours(start.getUTCHours() - 8);
    const end = new Date(start);
    end.setUTCDate(end.getUTCDate() + 1);
    return { start, end };
  }

  function setKpi(id, val, cls){
    const el = document.getElementById(id);
    el.textContent = String(val ?? "—");
    el.className = "value " + (cls || "");
  }

  function pill(ok, text){
    const cls = ok === true ? "ok" : ok === false ? "bad" : "warn";
    return `<span class="pill ${cls}">${text}</span>`;
  }

  let pendingRows = [];

  function renderPending(filter=""){
    const tb = document.getElementById("tbPending");
    const q = (filter||"").trim().toLowerCase();

    const rows = !q ? pendingRows : pendingRows.filter(r=>{
      const s = [
        r.id, r.buyer_id, r.email_to, r.user_id
      ].filter(Boolean).join(" ").toLowerCase();
      return s.includes(q);
    });

    if(!rows.length){
      tb.innerHTML = `<tr><td colspan="4" class="small">沒有待寄資料 ✅</td></tr>`;
      return;
    }

    tb.innerHTML = rows.map(o=>{
      const expire = fmtDateTimeTW(o.expire_at);
      const mail = o.email_to || "（尚未寫入 email_to）";
      const sent = o.reminder_sent_at
        ? pill(true, "已寄：" + fmtDateTimeTW(o.reminder_sent_at))
        : pill(false, "未寄");
      const ids = `<div class="mono">order: ${o.id}</div><div class="mono">buyer: ${o.buyer_id||""}</div>`;
      return `
        <tr>
          <td>${expire}</td>
          <td>${sent}</td>
          <td>${mail}</td>
          <td>${ids}</td>
        </tr>`;
    }).join("");
  }

  async function loadAll(){
    const admin = await requireAdmin();
    const email = admin.profile.email || admin.session.user.email || "admin";
    document.getElementById("subtitle").textContent = "已登入 " + email;

    // today and windows in Taipei
    const todayKey = dateKeyTW();
    const { start: todayStartUtc, end: todayEndUtc } = twDayToUtcRange(todayKey);

    const d7 = new Date();
    d7.setDate(d7.getDate() + 7);
    const d7Key = dateKeyTW(d7);
    const { start: d7StartUtc, end: d7EndUtc } = twDayToUtcRange(d7Key);

    document.getElementById("dueWindow").textContent =
      `到期日（台北）= ${d7Key}（UTC: ${d7StartUtc.toISOString()} ~ ${d7EndUtc.toISOString()}）`;
    document.getElementById("logWindow").textContent =
      `今日（台北）= ${todayKey}`;

    // KPI 1: due total
    const dueTotal = await supa.from("orders")
      .select("id", { count:"exact", head:true })
      .eq("status","paid")
      .gte("expire_at", d7StartUtc.toISOString())
      .lt("expire_at", d7EndUtc.toISOString());

    // KPI 2: due pending
    const duePending = await supa.from("orders")
      .select("id", { count:"exact", head:true })
      .eq("status","paid")
      .is("reminder_sent_at", null)
      .gte("expire_at", d7StartUtc.toISOString())
      .lt("expire_at", d7EndUtc.toISOString());

    // KPI 3: sent today (reminder_sent_at)
    const sentToday = await supa.from("orders")
      .select("id", { count:"exact", head:true })
      .eq("status","paid")
      .gte("reminder_sent_at", todayStartUtc.toISOString())
      .lt("reminder_sent_at", todayEndUtc.toISOString());

    // KPI 4: expired mail today (expire_reminder_sent_at)
    const expiredToday = await supa.from("orders")
      .select("id", { count:"exact", head:true })
      .eq("status","paid")
      .gte("expire_reminder_sent_at", todayStartUtc.toISOString())
      .lt("expire_reminder_sent_at", todayEndUtc.toISOString());

    const nTotal = dueTotal.count || 0;
    const nPend  = duePending.count || 0;
    const nSent  = sentToday.count || 0;
    const nExp   = expiredToday.count || 0;

    setKpi("k_due_total", nTotal, nTotal ? "" : "ok");
    setKpi("k_due_pending", nPend, nPend ? "bad" : "ok");
    setKpi("k_sent_today", nSent, nSent ? "" : "warn");
    setKpi("k_expired_today", nExp, nExp ? "" : "warn");

    // pending table
    const { data: pendingData, error: pendErr } = await supa.from("orders")
      .select("id,buyer_id,user_id,email_to,expire_at,reminder_sent_at,period,items")
      .eq("status","paid")
      .is("reminder_sent_at", null)
      .gte("expire_at", d7StartUtc.toISOString())
      .lt("expire_at", d7EndUtc.toISOString())
      .order("expire_at", { ascending:true })
      .limit(200);

    pendingRows = pendingData || [];
    renderPending(document.getElementById("q").value);

    if(pendErr){
      document.getElementById("tbPending").innerHTML =
        `<tr><td colspan="4" class="small">讀取 orders 失敗：${String(pendErr.message||pendErr)}</td></tr>`;
    }

    // logs table (optional)
    const tbLogs = document.getElementById("tbLogs");
    try{
      const { data: logs, error: logErr } = await supa.from("email_logs")
        .select("created_at,kind,order_id,to_email,ok,error")
        .gte("created_at", todayStartUtc.toISOString())
        .lt("created_at", todayEndUtc.toISOString())
        .order("created_at", { ascending:false })
        .limit(200);

      if(logErr) throw logErr;

      const rows = (logs || []).filter(x=>x.kind === "subscription_reminder_7d" || x.kind === "subscription_expire" || x.kind === "subscription_expired");
      if(!rows.length){
        tbLogs.innerHTML = `<tr><td colspan="4" class="small">今天沒有 email_logs 記錄（或 kind 不在範圍）</td></tr>`;
      }else{
        tbLogs.innerHTML = rows.map(l=>{
          const t = fmtDateTimeTW(l.created_at);
          const res = l.ok === true ? pill(true,"成功") : l.ok === false ? pill(false,"失敗") : pill(null,"未知");
          const memo = l.ok === false ? (l.error || "未知錯誤") : (l.kind || "");
          return `<tr>
            <td>${t}</td>
            <td>${res}</td>
            <td>${l.to_email || ""}</td>
            <td><div class="mono">${memo}</div><div class="mono">order: ${l.order_id||""}</div></td>
          </tr>`;
        }).join("");
      }
    }catch(e){
      tbLogs.innerHTML = `<tr><td colspan="4" class="small">無法讀取 email_logs：${String(e)}</td></tr>`;
    }
  }

  document.getElementById("btnRefresh").addEventListener("click", ()=>loadAll());


  
async function runReminderNow(){
  // 不走瀏覽器 fetch（會被 CORS 擋），改成「產生 SQL → 你貼到 Supabase SQL Editor 執行」
  let secret = localStorage.getItem("BW_CRON_SECRET") || "";
  secret = prompt(`請輸入 CRON_SECRET（只存本機 localStorage，不會上傳）\n用途：SQL 觸發 subscription-reminder`, secret || "bw_reminder_test_2026") || "";
  secret = secret.trim();
  if(!secret) return;

  localStorage.setItem("BW_CRON_SECRET", secret);

  // SQL 內單引號要逃逸
  const esc = (v)=> String(v).replace(/'/g,"''");

  const sql = `select net.http_post(
  url := '${esc(FUNCTION_URL)}',
  headers := jsonb_build_object(
    'x-cron-secret', '${esc(secret)}',
    'content-type', 'application/json'
  ),
  body := '{}'::jsonb
) as resp;`;

  const taId = "sqlBox_" + Math.random().toString(16).slice(2);

  showModal(
    "用 SQL 觸發（建議）",
    `
      <div style="line-height:1.6">
        <div style="margin-bottom:10px;color:#0b3d3b">
          1) 點「複製 SQL」→ 2) 到 Supabase「SQL Editor」貼上按 Run → 3) 回來按「重新整理」。
        </div>
        <textarea id="${taId}" style="width:100%;height:180px;box-sizing:border-box;padding:10px;border:1px solid #d5dde5;border-radius:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;font-size:12px;">${sql}</textarea>
      </div>
    `,
    [
      { label:"複製 SQL", kind:"primary", onClick: async ()=>{
          try{
            const ta = document.getElementById(taId);
            ta.focus(); ta.select();
            await navigator.clipboard.writeText(ta.value);
            toast("已複製 SQL");
          }catch(e){
            alert("複製失敗，請手動選取複製。");
          }
        }
      },
      { label:"重新整理", kind:"ghost", onClick: ()=> location.reload() },
      { label:"關閉", kind:"ghost", onClick: ()=>{} }
    ]
  );
}


document.getElementById("btnResendTest").addEventListener("click", ()=>runReminderNow());
  document.getElementById("q").addEventListener("input", (e)=>renderPending(e.target.value));

  loadAll();

  // ===== tiny toast =====
  function toast(msg){
    try{ alert(msg); }catch(e){ console.log(msg); }
  }

  // ===== SQL panel handlers =====
  (function(){
    const panel = document.getElementById("sqlPanel");
    const close = ()=>{ panel.style.display="none"; };
    document.getElementById("sqlClose").addEventListener("click", close);
    panel.addEventListener("click", (e)=>{ if(e.target===panel) close(); });

    const projectRef = (SUPABASE_URL||"").split("//")[1]?.split(".")[0] || "";
    const sqlUrl = projectRef ? `https://supabase.com/dashboard/project/${projectRef}/sql/new` : "https://supabase.com/dashboard";
    document.getElementById("openSqlEditor").href = sqlUrl;

    document.getElementById("sqlCopy").addEventListener("click", async ()=>{
      const txt = document.getElementById("sqlText").value || "";
      try{
        await navigator.clipboard.writeText(txt);
        toast("已複製 ✅");
      }catch(e){
        toast("瀏覽器不允許剪貼簿，請手動全選複製");
      }
    });

    document.getElementById("sqlDone").addEventListener("click", ()=>{
      close();
      location.reload();
    });
  })();

</script>

<!-- ===== SQL Trigger Panel (no CORS) ===== -->
<div id="sqlPanel" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:9999; align-items:center; justify-content:center; padding:16px;">
  <div style="width:min(920px, 96vw); background:#fff; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.25); overflow:hidden;">
    <div style="display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid #eee;">
      <div style="font-weight:800;">一鍵 SQL（貼到 Supabase SQL Editor → Run）</div>
      <button id="sqlClose" style="border:none; background:transparent; font-size:22px; cursor:pointer;">✕</button>
    </div>
    <div style="padding:14px 16px;">
      <div style="font-size:13px; color:#555; margin-bottom:8px;">
        這段 SQL 會用 <b>pg_net (net.http_post)</b> 從資料庫端呼叫 Edge Function，完全不走瀏覽器 fetch，所以不會遇到 CORS。
      </div>
      <textarea id="sqlText" spellcheck="false" style="width:100%; height:220px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12.5px; line-height:1.5; padding:12px; border:1px solid #e6e6e6; border-radius:12px; resize:vertical;"></textarea>
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; justify-content:flex-end;">
        <a id="openSqlEditor" target="_blank" rel="noopener" style="text-decoration:none;">
          <button style="padding:10px 14px; border-radius:999px; border:1px solid #d7d7d7; background:#fff; cursor:pointer;">開啟 Supabase SQL Editor</button>
        </a>
        <button id="sqlCopy" style="padding:10px 14px; border-radius:999px; border:none; background:#0a7; color:#fff; cursor:pointer;">複製</button>
        <button id="sqlDone" style="padding:10px 14px; border-radius:999px; border:none; background:#0b5; color:#fff; cursor:pointer;">我已 Run → 重新整理</button>
      </div>
    </div>
  </div>
</div>

</body>
</html>
