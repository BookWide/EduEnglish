<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>è‹±æ–‡ç¨‹åº¦æ¸¬é©—ï½œBookWide</title>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg0:#04070f;
  --bg1:#07142a;
  --ink:#eaf2ff;
  --muted:rgba(234,242,255,.72);
  --line:rgba(255,255,255,.10);
  --card:rgba(10,20,45,.58);
  --card2:rgba(8,16,36,.66);
  --brand:#b8ff1f;
  --brand2:#7bff00;
  --danger:#ff4d6d;
  --ok:#22c55e;
  --shadow:0 18px 80px rgba(0,0,0,.45);
  --r:22px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
  color:var(--ink);
  background:
    radial-gradient(900px 420px at 20% 8%, rgba(120,200,255,.22), transparent 55%),
    radial-gradient(900px 420px at 75% 20%, rgba(170,255,30,.16), transparent 55%),
    radial-gradient(1100px 520px at 55% 90%, rgba(70,120,255,.15), transparent 60%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
  overflow-x:hidden;
}
a{color:inherit}
.wrap{
  max-width:980px;
  margin:0 auto;
  padding:18px 14px 26px;
}
.top{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  margin-bottom:12px;
}
.brand{
  display:flex; align-items:center; gap:12px; min-width:0;
}
.logo{
  width:44px; height:44px; border-radius:14px;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.25), rgba(255,255,255,.06));
  border:1px solid var(--line);
  box-shadow: 0 10px 30px rgba(0,0,0,.35);
  display:grid; place-items:center;
  font-size:20px;
}
.brandTitle{font-weight:900; letter-spacing:.2px}
.brandSub{font-size:12px; color:var(--muted); margin-top:2px}
.right{
  display:flex; gap:10px; align-items:center;
}
.pill{
  border:1px solid var(--line);
  background:rgba(255,255,255,.06);
  color:var(--ink);
  border-radius:999px;
  padding:10px 12px;
  font-weight:900;
  display:flex; align-items:center; gap:8px;
}
.pill small{font-weight:800; color:var(--muted)}
.btn{
  border:1px solid var(--line);
  background:rgba(255,255,255,.06);
  color:var(--ink);
  border-radius:999px;
  padding:10px 14px;
  font-weight:950;
  cursor:pointer;
}
.btn:active{transform:translateY(1px)}
.btnPrimary{
  border:none;
  background:linear-gradient(180deg, var(--brand), var(--brand2));
  color:#0b1220;
  box-shadow: 0 16px 50px rgba(146,255,30,.22);
}
.card{
  border:1px solid var(--line);
  background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
  border-radius:var(--r);
  box-shadow:var(--shadow);
  overflow:hidden;
}
.progressWrap{
  padding:14px 16px 10px;
  border-bottom:1px solid var(--line);
  background:rgba(0,0,0,.18);
}
.progressRow{display:flex; justify-content:space-between; gap:10px; align-items:center}
.progressLabel{font-size:12px; color:var(--muted); font-weight:850}
.progressBar{
  height:8px;
  border-radius:999px;
  background:rgba(255,255,255,.10);
  overflow:hidden;
  margin-top:10px;
}
.progressFill{
  height:100%;
  width:0%;
  background:linear-gradient(90deg, var(--brand), #8bff00, #64ffda);
  border-radius:999px;
  transition:width .28s ease;
}
.body{
  padding:18px 16px;
}
.h1{font-size:22px; font-weight:950; letter-spacing:.2px}
.p{margin-top:8px; color:var(--muted); font-weight:700; line-height:1.5}
.grid{
  display:grid;
  grid-template-columns: 1.1fr .9fr;
  gap:14px;
  align-items:start;
  padding:16px;
}
@media (max-width:860px){
  .grid{grid-template-columns:1fr; padding:14px}
}
.panel{
  border:1px solid var(--line);
  border-radius:20px;
  background:linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.05));
  padding:14px;
}
.qTitle{
  font-size:18px;
  font-weight:950;
  line-height:1.25;
}
.qSub{
  margin-top:10px;
  font-size:12px;
  color:var(--muted);
  font-weight:800;
}
.options{margin-top:14px; display:grid; gap:10px}
.opt{
  text-align:left;
  width:100%;
  border:1px solid var(--line);
  background:rgba(255,255,255,.05);
  color:var(--ink);
  border-radius:16px;
  padding:12px 12px;
  font-weight:900;
  cursor:pointer;
  display:flex; justify-content:space-between; gap:12px; align-items:center;
}
.opt:active{transform:translateY(1px)}
.opt .hint{font-size:12px; color:var(--muted); font-weight:800}
.opt.sel{
  border-color: rgba(184,255,31,.85);
  box-shadow: 0 0 0 3px rgba(184,255,31,.18) inset;
}
.opt.ok{
  border-color: rgba(34,197,94,.85);
  box-shadow: 0 0 0 3px rgba(34,197,94,.15) inset;
}
.opt.bad{
  border-color: rgba(255,77,109,.9);
  box-shadow: 0 0 0 3px rgba(255,77,109,.15) inset;
}
.sideStat{
  display:grid; gap:12px;
}
.stat{
  padding:14px;
  border:1px solid var(--line);
  border-radius:20px;
  background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
}
.stat .k{font-size:12px; color:var(--muted); font-weight:850}
.stat .v{margin-top:6px; font-weight:950; font-size:18px}
.badge{
  display:inline-flex; align-items:center; gap:8px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.05);
  padding:10px 12px;
  border-radius:999px;
  font-weight:950;
}
.badge .dot{width:10px; height:10px; border-radius:999px; background:var(--brand)}
.formRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
.inp{
  flex:1 1 220px;
  height:44px;
  border-radius:14px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.05);
  color:var(--ink);
  font-weight:900;
  padding:0 12px;
  outline:none;
}
.foot{
  display:flex; justify-content:space-between; align-items:center; gap:10px;
  padding:14px 16px;
  border-top:1px solid var(--line);
  background:rgba(0,0,0,.18);
}
.small{font-size:12px; color:var(--muted); font-weight:800}
.toast{
  position:fixed;
  left:50%; transform:translateX(-50%);
  bottom:18px;
  background:rgba(0,0,0,.72);
  border:1px solid rgba(255,255,255,.16);
  color:var(--ink);
  padding:10px 12px;
  border-radius:999px;
  font-weight:900;
  font-size:13px;
  box-shadow: 0 18px 60px rgba(0,0,0,.45);
  display:none;
  max-width:min(92vw,720px);
}
.resultHero{
  display:grid; gap:10px;
  padding:18px 16px;
}
.bigLevel{
  font-size:42px;
  font-weight:1000;
  letter-spacing:1px;
}
.spark{
  font-size:14px; font-weight:950; color:var(--muted);
}
.kpis{display:flex; gap:10px; flex-wrap:wrap; margin-top:6px}
.kpi{
  border:1px solid var(--line);
  background:rgba(255,255,255,.05);
  border-radius:16px;
  padding:10px 12px;
  font-weight:950;
}
.kpi b{color:var(--brand)}
</style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="logo">ğŸ§ </div>
      <div style="min-width:0">
        <div class="brandTitle">è‹±æ–‡ç¨‹åº¦æ¸¬é©—</div>
        <div class="brandSub">BookWide Â· è¨‚é–±æˆ¶å°ˆç”¨ Â· å®Œæˆå¾Œè‡ªå‹•è§£é– Talk Week</div>
      </div>
    </div>
    <div class="right">
      <div class="pill" id="pillUser"><small>ç™»å…¥</small> <span id="userEmail">â€”</span></div>
      <button class="btn" id="btnBack">è¿”å›</button>
    </div>
  </div>

  <div class="card" id="cardMain">
    <div class="progressWrap">
      <div class="progressRow">
        <div class="progressLabel" id="progressText">è¼‰å…¥ä¸­â€¦</div>
        <div class="badge"><span class="dot"></span><span id="modeLabel">LEVEL</span></div>
      </div>
      <div class="progressBar"><div class="progressFill" id="progressFill"></div></div>
    </div>

    <div class="grid" id="screenIntro" style="display:none">
      <div class="panel">
        <div class="h1">å…ˆç”¨ 3â€“5 åˆ†é˜ï¼Œå¿«é€Ÿåˆ¤å®šä½ çš„è‹±æ–‡ç¨‹åº¦</div>
        <div class="p">
          é€™ä»½æ¸¬é©—æœƒä¼°ç®—ä½ çš„ CEFR ç­‰ç´šï¼ˆA1â€“C1ï¼‰ï¼Œä¸¦æŠŠçµæœå¯«å…¥ä½ çš„å¸³è™Ÿè³‡æ–™ã€‚ä¹‹å¾Œ Talk æœƒä¾ç…§ä½ çš„ç¨‹åº¦è§£é– Weekã€‚
        </div>

        <div class="formRow">
          <input class="inp" id="inpName" placeholder="ä½ çš„åå­—ï¼ˆé¸å¡«ï¼Œä¾‹å¦‚ï¼šRaymondï¼‰"/>
          <input class="inp" id="inpGoal" placeholder="ä½ çš„ç›®æ¨™ï¼ˆé¸å¡«ï¼Œä¾‹å¦‚ï¼šèƒ½ç”¨è‹±æ–‡é–‹æœƒï¼‰"/>
        </div>

        <div class="p" style="margin-top:12px">
          æé†’ï¼šé¡Œç›®æœƒã€Œç”±æ˜“åˆ°é›£ã€ã€‚ä¸æœƒçš„é¡Œç›®ç›´æ¥çŒœä¹Ÿæ²’é—œä¿‚ã€‚
        </div>
      </div>

      <div class="sideStat">
        <div class="stat">
          <div class="k">é¡Œç›®æ•¸</div>
          <div class="v"><span id="statCount">â€”</span> é¡Œ</div>
        </div>
        <div class="stat">
          <div class="k">ç›®å‰å¸³è™Ÿ</div>
          <div class="v" id="statEmail">â€”</div>
        </div>
        <div class="stat">
          <div class="k">å·²æ¸¬ç­‰ç´š</div>
          <div class="v" id="statExisting">ï¼ˆå°šæœªæ¸¬ï¼‰</div>
        </div>
        <button class="btn btnPrimary" id="btnStart">é–‹å§‹æ¸¬é©—</button>
        <button class="btn" id="btnRetake" style="display:none">é‡æ–°æ¸¬ä¸€æ¬¡</button>
      </div>
    </div>

    <div class="grid" id="screenQuiz" style="display:none">
      <div class="panel">
        <div class="qTitle" id="qTitle">â€”</div>
        <div class="qSub" id="qSub">â€”</div>
        <div class="options" id="options"></div>
      </div>

      <div class="sideStat">
        <div class="stat">
          <div class="k">é€²åº¦</div>
          <div class="v"><span id="statNow">0</span>/<span id="statTotal2">0</span></div>
        </div>
        <div class="stat">
          <div class="k">ç›®å‰ä¼°è¨ˆ</div>
          <div class="v" id="statEst">â€”</div>
        </div>
        <div class="stat">
          <div class="k">æç¤º</div>
          <div class="v" style="font-size:14px; font-weight:850; color:var(--muted)">ä¸ç¢ºå®šå°±çŒœï¼Œä¿æŒç¯€å¥ã€‚</div>
        </div>
      </div>
    </div>

    <div id="screenResult" style="display:none">
      <div class="resultHero">
        <div class="spark">æ¸¬é©—å®Œæˆ</div>
        <div class="bigLevel" id="resultLevel">A2</div>
        <div class="p" id="resultText">â€”</div>
        <div class="kpis">
          <div class="kpi">æ­£ç¢ºç‡ <b id="kpiAcc">â€”</b></div>
          <div class="kpi">å»ºè­°è§£é– <b id="kpiWeek">â€”</b></div>
          <div class="kpi">å¯éš¨æ™‚ <b>é‡æ¸¬</b></div>
        </div>
      </div>
      <div class="foot">
        <div class="small" id="saveHint">æ­£åœ¨å¯«å…¥ä½ çš„å¸³è™Ÿè³‡æ–™â€¦</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn" id="btnHome">å›é¦–é </button>
          <button class="btn btnPrimary" id="btnGoTalk">å‰å¾€ Talk</button>
          <button class="btn" id="btnAgain">å†æ¸¬ä¸€æ¬¡</button>
        </div>
      </div>
    </div>

    <div class="foot" id="footQuiz" style="display:none">
      <div class="small" id="footSmall">é¸ä¸€å€‹ç­”æ¡ˆå³å¯è‡ªå‹•ä¸‹ä¸€é¡Œã€‚</div>
      <div style="display:flex; gap:10px; flex-wrap:wrap">
        <button class="btn" id="btnSkip">è·³é</button>
        <button class="btn" id="btnQuit">é€€å‡º</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
</div>

<script>
/* ============================
   BookWide Level Survey (MVP)
   - Requires login + active subscription
   - Writes profiles.cefr_level + cefr_score + level_updated_at
   - Stores week cap into localStorage (BW_LEVEL_WEEK_CAP)
   ============================ */

const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
});

const $ = (id)=>document.getElementById(id);
const toastEl = $("toast");
function toast(msg){
  toastEl.textContent = msg;
  toastEl.style.display = "block";
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>toastEl.style.display="none", 1700);
}

function todayTW(){
  return new Date().toLocaleDateString("en-CA", { timeZone:"Asia/Taipei" });
}

// ----- CEFR week cap (can tweak later) -----
const CEFR_WEEK_CAP = { A0:1, A1:4, A2:8, B1:16, B2:32, C1:999, C2:999 };
function weekCapFromCefr(cefr){
  const k = String(cefr||"").toUpperCase().trim();
  return CEFR_WEEK_CAP[k] || 1;
}

const LEVEL_TEXT = {
  A1:"ä½ é©åˆå…ˆæŠŠã€Œé«˜é »å¥å‹ + åŸºç¤è©å½™ã€ç·´ç©©ï¼ŒTalk æœƒå…ˆé–‹åˆ° W4ã€‚",
  A2:"ä½ å¯ä»¥æµæš¢è™•ç†æ—¥å¸¸æƒ…å¢ƒï¼ŒTalk æœƒé–‹åˆ° W8ï¼Œé–‹å§‹ç·´è®ŠåŒ–å¥ã€‚",
  B1:"ä½ å·²ç¶“èƒ½æ‡‰ä»˜å¤šæ•¸å·¥ä½œ/æ—…éŠæƒ…å¢ƒï¼ŒTalk æœƒé–‹åˆ° W16ï¼ŒåŠ å…¥æŒ‘æˆ°é¡Œã€‚",
  B2:"ä½ å·²å…·å‚™é€²éšè¡¨é”èƒ½åŠ›ï¼ŒTalk æœƒé–‹åˆ° W32ï¼Œé–‹å§‹è¨“ç·´æ›´è‡ªç„¶èªæ„Ÿã€‚",
  C1:"ä½ å·²æ¥è¿‘æµåˆ©ï¼ŒTalk å¹¾ä¹å…¨é–‹ï¼Œå»ºè­°åŠ å¼·ç²¾æº–åº¦èˆ‡é¢¨æ ¼ã€‚"
};

// ----- Question bank (MVP 18 questions, tagged by difficulty) -----
const QUESTIONS = [
  // A1
  {id:"q01", tag:"A1", type:"vocab", q:"Choose the correct meaning of â€œbusyâ€.", sub:"Vocabulary Â· A1", opts:[
    {t:"not free / having a lot to do", ok:true},
    {t:"very big", ok:false},
    {t:"very sad", ok:false},
    {t:"very hungry", ok:false},
  ]},
  {id:"q02", tag:"A1", type:"grammar", q:"I ___ a student.", sub:"Grammar Â· A1", opts:[
    {t:"am", ok:true},{t:"is", ok:false},{t:"are", ok:false},{t:"be", ok:false},
  ]},
  {id:"q03", tag:"A1", type:"usage", q:"Which is correct?", sub:"Usage Â· A1", opts:[
    {t:"I have two sisters.", ok:true},
    {t:"I has two sisters.", ok:false},
    {t:"I having two sisters.", ok:false},
    {t:"I am have two sisters.", ok:false},
  ]},
  {id:"q04", tag:"A1", type:"grammar", q:"He ___ to school every day.", sub:"Grammar Â· A1", opts:[
    {t:"goes", ok:true},{t:"go", ok:false},{t:"going", ok:false},{t:"gone", ok:false},
  ]},

  // A2
  {id:"q05", tag:"A2", type:"grammar", q:"We ___ dinner when you called.", sub:"Past continuous Â· A2", opts:[
    {t:"were having", ok:true},{t:"are having", ok:false},{t:"have", ok:false},{t:"had", ok:false},
  ]},
  {id:"q06", tag:"A2", type:"vocab", q:"â€œarriveâ€ is closest to:", sub:"Vocabulary Â· A2", opts:[
    {t:"get to a place", ok:true},{t:"leave", ok:false},{t:"forget", ok:false},{t:"sleep", ok:false},
  ]},
  {id:"q07", tag:"A2", type:"grammar", q:"Iâ€™ve lived here ___ 2020.", sub:"Preposition Â· A2", opts:[
    {t:"since", ok:true},{t:"for", ok:false},{t:"at", ok:false},{t:"to", ok:false},
  ]},
  {id:"q08", tag:"A2", type:"reading", q:"Choose the best response: â€œCould you help me?â€", sub:"Everyday English Â· A2", opts:[
    {t:"Sure. What do you need?", ok:true},
    {t:"Iâ€™m help you yesterday.", ok:false},
    {t:"No, I could.", ok:false},
    {t:"Help is not.", ok:false},
  ]},

  // B1
  {id:"q09", tag:"B1", type:"grammar", q:"If I ___ more time, I would travel.", sub:"Conditional Â· B1", opts:[
    {t:"had", ok:true},{t:"have", ok:false},{t:"will have", ok:false},{t:"am having", ok:false},
  ]},
  {id:"q10", tag:"B1", type:"vocab", q:"â€œreliableâ€ means:", sub:"Vocabulary Â· B1", opts:[
    {t:"can be trusted", ok:true},{t:"very cheap", ok:false},{t:"very noisy", ok:false},{t:"hard to find", ok:false},
  ]},
  {id:"q11", tag:"B1", type:"grammar", q:"This report needs ___ by Friday.", sub:"Passive Â· B1", opts:[
    {t:"to be finished", ok:true},{t:"finish", ok:false},{t:"finishing", ok:false},{t:"finished", ok:false},
  ]},
  {id:"q12", tag:"B1", type:"reading", q:"Which sentence is more natural?", sub:"Fluency Â· B1", opts:[
    {t:"Iâ€™ll get back to you soon.", ok:true},
    {t:"I will return you soon.", ok:false},
    {t:"I am back you soon.", ok:false},
    {t:"I get to you returning.", ok:false},
  ]},

  // B2
  {id:"q13", tag:"B2", type:"grammar", q:"Hardly ___ when the storm broke.", sub:"Inversion Â· B2", opts:[
    {t:"had I left the house", ok:true},
    {t:"I had left the house", ok:false},
    {t:"I left the house had", ok:false},
    {t:"had left I the house", ok:false},
  ]},
  {id:"q14", tag:"B2", type:"vocab", q:"â€œambiguousâ€ is closest to:", sub:"Vocabulary Â· B2", opts:[
    {t:"unclear / can mean more than one thing", ok:true},
    {t:"very important", ok:false},
    {t:"extremely fast", ok:false},
    {t:"completely silent", ok:false},
  ]},
  {id:"q15", tag:"B2", type:"grammar", q:"The proposal, ___ we discussed, needs revision.", sub:"Relative clause Â· B2", opts:[
    {t:"which", ok:true},{t:"what", ok:false},{t:"who", ok:false},{t:"where", ok:false},
  ]},
  {id:"q16", tag:"B2", type:"usage", q:"Pick the best option:", sub:"Comparatives Â· B2", opts:[
    {t:"It was the most impressive movie I had ever seen.", ok:true},
    {t:"It was the more impressive movie I ever saw.", ok:false},
    {t:"It was most impressive than I see.", ok:false},
    {t:"It was impressiver the movie.", ok:false},
  ]},

  // C1 (still MVP)
  {id:"q17", tag:"C1", type:"vocab", q:"â€œmitigateâ€ is closest to:", sub:"Vocabulary Â· C1", opts:[
    {t:"reduce the severity", ok:true},
    {t:"make worse", ok:false},
    {t:"memorize", ok:false},
    {t:"translate", ok:false},
  ]},
  {id:"q18", tag:"C1", type:"grammar", q:"No sooner ___ the meeting started than the fire alarm rang.", sub:"Inversion Â· C1", opts:[
    {t:"had", ok:true},{t:"has", ok:false},{t:"did", ok:false},{t:"was", ok:false},
  ]},
];

function estimateFromScore(score){
  // score 0..100
  if(score < 35) return "A1";
  if(score < 55) return "A2";
  if(score < 75) return "B1";
  if(score < 90) return "B2";
  return "C1";
}

let session=null, user=null, uid=null, profile=null;

// quiz state
let idx=0;
let correct=0;
let answered=0;
let est="A1";

function setProgress(){
  const total=QUESTIONS.length;
  const pct = total ? Math.round((idx/total)*100) : 0;
  $("progressFill").style.width = pct + "%";
  $("progressText").textContent = (idx===0)
    ? "æº–å‚™é–‹å§‹"
    : `ç¬¬ ${Math.min(idx+1,total)} / ${total} é¡Œ`;
  $("statNow").textContent = String(Math.min(idx+1,total));
  $("statTotal2").textContent = String(total);
  $("statEst").textContent = est ? `ä¼°è¨ˆï¼š${est}` : "â€”";
}

function showScreen(name){
  $("screenIntro").style.display = (name==="intro") ? "" : "none";
  $("screenQuiz").style.display  = (name==="quiz")  ? "" : "none";
  $("screenResult").style.display= (name==="result")? "" : "none";
  $("footQuiz").style.display    = (name==="quiz")  ? "" : "none";
}

function renderQuestion(){
  const q = QUESTIONS[idx];
  if(!q){ return finish(); }
  $("qTitle").textContent = q.q;
  $("qSub").textContent = q.sub + " Â· (ä¸ç¢ºå®šå°±çŒœ)";
  const box = $("options");
  box.innerHTML = "";
  q.opts.forEach((o, i)=>{
    const b = document.createElement("button");
    b.className = "opt";
    b.type="button";
    b.innerHTML = `<div style="min-width:0"><div style="font-weight:950">${o.t}</div></div><div class="hint">${q.tag}</div>`;
    b.onclick = ()=>choose(i);
    box.appendChild(b);
  });
  setProgress();
}

function updateEstimate(){
  // weighted by tag difficulty
  // A1=1, A2=2, B1=3, B2=4, C1=5
  const w = {A1:1,A2:2,B1:3,B2:4,C1:5,C2:5};
  // simple: base from raw acc + average difficulty attempted
  const acc = answered ? (correct/answered) : 0;
  const avgDiff = answered ? (QUESTIONS.slice(0,idx).reduce((s,q)=>s+(w[q.tag]||1),0)/answered) : 1;
  const score = Math.round((acc*70) + (avgDiff/5*30) * 100/100); // 0..100-ish
  est = estimateFromScore(score);
}

function choose(optIndex){
  const q = QUESTIONS[idx];
  if(!q) return;
  const opts = Array.from(document.querySelectorAll(".opt"));
  opts.forEach(o=>o.disabled=true);
  const picked = q.opts[optIndex];
  const ok = !!picked.ok;

  // mark
  opts[optIndex].classList.add("sel");
  if(ok){
    opts[optIndex].classList.add("ok");
    correct++;
  }else{
    opts[optIndex].classList.add("bad");
    // also show correct quickly
    const ci = q.opts.findIndex(x=>x.ok);
    if(ci>=0) opts[ci].classList.add("ok");
  }
  answered++;
  updateEstimate();
  setProgress();

  // next
  setTimeout(()=>{
    idx++;
    renderQuestion();
  }, 480);
}

function finish(){
  const acc = answered ? Math.round((correct/answered)*100) : 0;
  const rawScore = Math.max(0, Math.min(100, Math.round(acc))); // simple score for now
  const level = est || estimateFromScore(rawScore);
  const cap = weekCapFromCefr(level);

  $("resultLevel").textContent = level;
  $("kpiAcc").textContent = acc + "%";
  $("kpiWeek").textContent = "W" + cap;
  $("resultText").textContent = LEVEL_TEXT[level] || "å·²å®Œæˆæ¸¬é©—ï¼ŒTalk å°‡ä¾ä½ çš„ç¨‹åº¦è§£é–ã€‚";

  showScreen("result");
  $("progressFill").style.width = "100%";
  $("progressText").textContent = "å®Œæˆ";

  // persist to localStorage for fast reads
  try{
    localStorage.setItem("BW_CEFR_LEVEL", level);
    localStorage.setItem("BW_LEVEL_WEEK_CAP", String(cap));
  }catch(_e){}

  // write to profiles
  saveToProfile(level, rawScore, cap).catch(()=>{});
}

async function saveToProfile(level, score, cap){
  $("saveHint").textContent = "æ­£åœ¨å¯«å…¥ä½ çš„å¸³è™Ÿè³‡æ–™â€¦";
  try{
    const payload = {
      id: uid,
      email: (user && user.email) ? user.email : null,
      cefr_level: level,
      cefr_score: score,
      level_updated_at: new Date().toISOString(),
    };

    // 1) å„ªå…ˆç”¨ upsertï¼šæ–°å¸³è™Ÿå¯èƒ½é‚„æ²’æœ‰ profiles row
    let { error } = await supabase
      .from("profiles")
      .upsert(payload, { onConflict: "id" });

    // 2) è‹¥ RLS æœªé–‹ insert æ¬Šé™ï¼Œupsert å¯èƒ½å¤±æ•—ï¼›é€€å› update
    if(error){
      const r = await supabase
        .from("profiles")
        .update({
          cefr_level: level,
          cefr_score: score,
          level_updated_at: payload.level_updated_at,
        })
        .eq("id", uid);
      error = r.error;
    }

    if(error){
      $("saveHint").textContent = "å¯«å…¥å¤±æ•—ï¼ˆæ¬Šé™æˆ–ç¶²è·¯å•é¡Œï¼‰ï¼Œä½†æœ¬æ©Ÿå·²è¨˜ä½çµæœã€‚";
      return;
    }
    $("saveHint").textContent = `å·²æ›´æ–°ï¼š${level}ï¼ˆTalk å°‡è§£é–åˆ° W${cap}ï¼‰`;
  }catch(_e){
    $("saveHint").textContent = "å¯«å…¥å¤±æ•—ï¼ˆç¶²è·¯æˆ–æ¬Šé™å•é¡Œï¼‰ï¼Œä½†æœ¬æ©Ÿå·²è¨˜ä½çµæœã€‚";
  }
}

async function guard(){
  // require login
  const { data: sess } = await supabase.auth.getSession();
  session = sess && sess.session;
  if(!session || !session.user){
    const red = encodeURIComponent(location.pathname + location.search + location.hash);
    location.replace("/account/login.html?redirect=" + red);
    return false;
  }
  user = session.user;
  uid = user.id;
  $("userEmail").textContent = user.email || "å·²ç™»å…¥";
  $("statEmail").textContent = user.email || "å·²ç™»å…¥";

  // NOTE: æœ¬é æ˜¯ã€Œè‹±èªç¨‹åº¦æ¸¬é©—ã€ï¼šä¸åšè¨‚é–±å®ˆé–€ã€‚
  // ç›®çš„ï¼šè®“æ–°è¨»å†Šä½¿ç”¨è€…å…ˆå®Œæˆæ¸¬é©— â†’ å†å¼•å°åˆ°è¨‚é–± / å­¸ç¿’æ§åˆ¶å°ã€‚
  const { data: prof, error } = await supabase
    .from("profiles")
    .select("id, cefr_level, cefr_score")
    .eq("id", uid)
    .maybeSingle();

  if(!error && prof) profile = prof;

  // show existing level (if any)
  if(profile && profile.cefr_level){
    const cap = weekCapFromCefr(profile.cefr_level);
    $("statExisting").textContent = `${String(profile.cefr_level).toUpperCase()}ï¼ˆå·²è§£é–åˆ° W${cap}ï¼‰`;
    $("btnRetake").style.display = "";
  }else{
    $("statExisting").textContent = "ï¼ˆå°šæœªæ¸¬ï¼‰";
  }

  $("statCount").textContent = String(QUESTIONS.length);
  return true;
}

// ----- events -----
$("btnBack").onclick = ()=>history.back();
$("btnHome").onclick = ()=>location.replace("/");
$("btnGoTalk").onclick = ()=>location.replace("/talk.html");
$("btnAgain").onclick = ()=>startQuiz(true);
$("btnRetake").onclick = ()=>startQuiz(true);
$("btnQuit").onclick = ()=>location.replace("/");
$("btnSkip").onclick = ()=>{
  // skip counts as answered? no
  idx++;
  renderQuestion();
};
$("btnStart").onclick = ()=>startQuiz(false);

function startQuiz(force){
  idx = 0;
  correct = 0;
  answered = 0;
  est = "A1";
  showScreen("quiz");
  renderQuestion();
}

(async function init(){
  try{
    const ok = await guard();
    if(!ok) return;

    // intro
    showScreen("intro");
    $("progressText").textContent = "æº–å‚™é–‹å§‹";
    $("progressFill").style.width = "0%";
  }catch(e){
    toast("è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†ã€‚");
  }
})();
</script>
</body>
</html>
