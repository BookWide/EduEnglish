<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dialogue Practice</title>
<style>
:root{
  --bg:#0b1220; --panel:#0f172a; --border:#24324f;
  --text:#e5e7eb; --muted:#9ca3af; --accent:#3b82f6;
}
*{box-sizing:border-box}
body{
  margin:0; background:linear-gradient(180deg,var(--bg),#070b14);
  color:var(--text);
  font-family:system-ui,-apple-system,"Segoe UI","Noto Sans TC","Microsoft JhengHei",sans-serif;
}
.app{max-width:1200px;margin:0 auto;padding:14px;display:grid;grid-template-rows:auto 1fr auto;gap:12px}
header{display:flex;align-items:center;justify-content:space-between;gap:10px}
h1{font-size:18px;margin:0}
.meta{font-size:12px;color:var(--muted)}
.langs button{
  background:#0b1430;border:1px solid var(--border);color:var(--text);
  padding:4px 10px;border-radius:999px;cursor:pointer;font-size:12px
}
.langs button.active{border-color:var(--accent);background:rgba(59,130,246,.18)}
.main{display:grid;grid-template-columns:360px 1fr;gap:12px;min-height:60vh}
@media (max-width:900px){.main{grid-template-columns:1fr}}
.panel{
  background:rgba(15,23,42,.8);border:1px solid var(--border);
  border-radius:14px;overflow:hidden
}
.list{max-height:60vh;overflow:auto}
.item{
  padding:10px 12px;border-top:1px solid rgba(36,50,79,.7);
  cursor:pointer
}
.item.active{background:rgba(59,130,246,.12)}
.item .sp{font-size:11px;color:var(--muted)}
.item .tx{font-size:13px;line-height:1.45}
.stage{padding:16px}
.speaker{font-size:12px;color:var(--muted)}
.line{font-size:22px;line-height:1.5;margin:6px 0}
footer{display:flex;gap:10px;justify-content:center}
button.ctrl{
  background:#0b1430;border:1px solid var(--border);color:var(--text);
  padding:8px 14px;border-radius:999px;cursor:pointer
}
button.ctrl.primary{border-color:var(--accent);background:rgba(59,130,246,.18)}
.status{font-size:12px;color:var(--muted);text-align:center}
</style>
</head>
<body>
<div class="app">
  <header>
    <div>
      <h1>Dialogue Practice</h1>
      <div class="meta" id="meta">—</div>
    </div>
    <div class="langs">
      <button data-lang="en" class="active">EN</button>
      <button data-lang="zh">中</button>
      <button data-lang="ja">日</button>
    </div>
  </header>

  <div class="main">
    <section class="panel">
      <div class="list" id="list"></div>
    </section>

    <section class="panel">
      <div class="stage">
        <div class="speaker" id="speaker">—</div>
        <div class="line" id="line">—</div>
      </div>
    </section>
  </div>

  <footer>
    <button class="ctrl" id="prev">◀ 上一句</button>
    <button class="ctrl primary" id="next">下一句 ▶</button>
  </footer>

  <div class="status" id="status">請以 ?src=xxx.dialogue.json 載入</div>
</div>

<script>
(() => {
  const $ = q => document.querySelector(q);
  const listEl = $('#list');
  const speakerEl = $('#speaker');
  const lineEl = $('#line');
  const metaEl = $('#meta');
  const statusEl = $('#status');
  const prevBtn = $('#prev');
  const nextBtn = $('#next');
  const langBtns = document.querySelectorAll('.langs button');

  let data = null;
  let idx = 0;
  let lang = 'en';

  function getLine(item){
    const key = 'line_' + lang;
    return item[key] || '—';
  }

  function renderList(){
    listEl.innerHTML = '';
    data.dialogue.forEach((d,i)=>{
      const div = document.createElement('div');
      div.className = 'item' + (i===idx?' active':'');
      div.innerHTML = `<div class="sp">${d.speaker||''}</div>
                       <div class="tx">${getLine(d)}</div>`;
      div.onclick = ()=>{ idx=i; render(); };
      listEl.appendChild(div);
    });
  }

  function render(){
    const d = data.dialogue[idx];
    speakerEl.textContent = d.speaker || '—';
    lineEl.textContent = getLine(d);
    renderList();
    metaEl.textContent = `${data.meta.slug} · ${idx+1}/${data.dialogue.length}`;
  }

  prevBtn.onclick = ()=>{ if(idx>0){idx--; render();} };
  nextBtn.onclick = ()=>{ if(idx<data.dialogue.length-1){idx++; render();} };

  langBtns.forEach(b=>{
    b.onclick = ()=>{
      langBtns.forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      lang = b.dataset.lang;
      render();
    };
  });

  async function load(src){
    const res = await fetch(src,{cache:'no-store'});
    data = await res.json();
    idx = 0;
    render();
    statusEl.textContent = '已載入';
  }

  const qs = new URLSearchParams(location.search);
  const src = qs.get('src');
  if(src){ load(src); }
})();
</script>
</body>
</html>
