<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dialogue</title>
<style>
:root{
  --bg:#f3f6fb;
  --card:#ffffff;
  --ink:#0f172a;
  --muted:#64748b;
  --line:#e2e8f0;
  --accent:#2563eb;
  --accent2:#1d4ed8;
  --ok:#16a34a;
  --bad:#dc2626;
  --shadow:0 10px 30px rgba(15,23,42,.08);
  --r:18px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,"Segoe UI","Noto Sans TC","Microsoft JhengHei",sans-serif;
  background:var(--bg);
  color:var(--ink);
}
.wrap{max-width:980px;margin:0 auto;padding:18px 14px 28px}
.topbar{
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  padding:14px 16px;background:var(--card);border:1px solid var(--line);
  border-radius:999px;box-shadow:var(--shadow);
}
.leftTop{display:flex;align-items:center;gap:12px;min-width:0}
.back{
  width:40px;height:40px;border-radius:999px;border:1px solid var(--line);
  background:#fff;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;
}
.title{min-width:0}
.title .h{font-weight:800;font-size:22px;line-height:1}
.title .s{font-size:12px;color:var(--muted);margin-top:4px}
.rightTop{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
.pill{
  border:1px solid var(--line);background:#fff;border-radius:999px;
  padding:8px 10px;font-size:13px;color:var(--ink);display:flex;align-items:center;gap:8px;
}
.pill input{
  border:0;outline:none;font-size:13px;width:320px;max-width:50vw;color:var(--ink);
}
.pill button{
  border:0;background:var(--accent);color:#fff;border-radius:999px;
  padding:6px 10px;cursor:pointer;font-size:12px;
}
.langs{display:flex;gap:8px}
.langs button{
  border:1px solid var(--line);background:#fff;border-radius:999px;
  padding:8px 10px;font-size:12px;cursor:pointer;color:var(--ink);
}
.langs button.active{border-color:var(--accent);background:rgba(37,99,235,.08);color:var(--accent2);font-weight:700}

.shell{
  margin-top:16px;
  background:var(--card);border:1px solid var(--line);border-radius:22px;
  box-shadow:var(--shadow);padding:18px;
}
.npcCard{
  display:flex;gap:14px;align-items:flex-start;
  border:1px solid var(--line);border-radius:22px;padding:14px;
  background:linear-gradient(180deg,#ffffff,#fbfdff);
}
.avatar{
  width:66px;height:66px;border-radius:18px;border:1px solid var(--line);
  background:#eef2ff;display:flex;align-items:center;justify-content:center;
  font-weight:800;color:#334155;flex:0 0 auto;overflow:hidden;
}
.avatar img{width:100%;height:100%;object-fit:cover}
.npcBody{min-width:0;flex:1}
.npcEn{font-size:22px;font-weight:800;line-height:1.35}
.npcSub{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.5}
.metaRow{
  margin-top:8px;color:var(--muted);font-size:12px;
  display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
}

.modeRow{
  margin-top:16px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;
}
.bigMic{
  width:64px;height:64px;border-radius:999px;background:var(--accent);
  display:flex;align-items:center;justify-content:center;color:#fff;font-size:26px;
  box-shadow:0 10px 20px rgba(37,99,235,.25);
}
.modeBtn{
  border:1px solid var(--line);background:#fff;border-radius:999px;
  padding:10px 14px;font-size:13px;cursor:pointer;color:var(--ink);
}
.modeBtn.active{border-color:var(--accent);background:rgba(37,99,235,.08);color:var(--accent2);font-weight:700}

.userBox{
  margin-top:14px;border:1px solid var(--line);border-radius:22px;padding:16px;
  background:#fff;
}
.userHead{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.userHead .t{font-size:18px;font-weight:900}
.userHead .chips{display:flex;gap:8px;align-items:center}
.badge{
  border:1px solid var(--line);background:#fff;border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)
}
.hideBtn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer;color:var(--muted)}
.userPrompt{margin-top:10px;font-size:20px;font-weight:800}
.userPromptSub{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.5}
.choiceRow{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
.choice{
  border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 12px;cursor:pointer;font-size:13px;
}
.choice:hover{border-color:#cbd5e1}
.inputWrap{margin-top:12px}
.input{
  width:100%;padding:16px 16px;border-radius:18px;border:1px solid var(--line);
  font-size:16px;outline:none;
}
.actions{margin-top:14px;display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.send{
  border:0;border-radius:999px;background:var(--accent);color:#fff;
  padding:14px 18px;font-size:14px;font-weight:800;cursor:pointer;display:flex;align-items:center;gap:10px;
}
.send:disabled{opacity:.45;cursor:not-allowed}
.reset{
  border:1px solid var(--line);border-radius:999px;background:#fff;color:var(--accent2);
  padding:14px 18px;font-size:14px;font-weight:800;cursor:pointer;
}
.feedback{margin-top:10px;font-size:13px}
.feedback.ok{color:var(--ok);font-weight:800}
.feedback.bad{color:var(--bad);font-weight:800}

.bottomNav{
  margin-top:16px;display:flex;gap:14px;justify-content:center;align-items:center;flex-wrap:wrap
}
.navBtn{
  border:1px solid var(--line);background:#fff;border-radius:999px;
  padding:10px 18px;font-size:14px;font-weight:800;cursor:pointer;color:var(--ink);
}
.navBtn.primary{border-color:var(--accent);background:rgba(37,99,235,.08);color:var(--accent2)}
.hintText{margin-top:10px;text-align:center;color:var(--muted);font-size:12px}
.hidden{display:none !important}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="leftTop">
      <button class="back" id="backBtn" title="Back">â†</button>
      <div class="title">
        <div class="h">Dialogue</div>
        <div class="s" id="subTitle">å›åˆå¼å°è©±ç·´ç¿’ï¼ˆtalk æ¶æ§‹ï¼‰</div>
      </div>
    </div>
    <div class="rightTop">
      <div class="pill" title="è¼‰å…¥ dialogue.jsonï¼ˆåŒç¶²åŸŸæª”æ¡ˆï¼‰">
        <span style="color:var(--muted);font-size:12px;">src</span>
        <input id="srcInput" placeholder="english-idioms-2.dialogue.talk-level.zhja.json"/>
        <button id="loadBtn">è¼‰å…¥</button>
      </div>
      <div class="langs" aria-label="Language">
        <button data-lang="en" class="active">EN</button>
        <button data-lang="zh">ä¸­</button>
        <button data-lang="ja">æ—¥</button>
      </div>
    </div>
  </div>

  <div class="shell" id="app">
    <div class="npcCard">
      <div class="avatar" id="avatarBox"><span id="avatarFallback">T</span></div>
      <div class="npcBody">
        <div class="npcEn" id="npcLine">è«‹å…ˆè¼‰å…¥ ?src=xxx.dialogue.json</div>
        <div class="npcSub" id="npcSub">ï¼ˆå¯åˆ‡æ› EN / ä¸­ / æ—¥ï¼›ç¼ºèªè¨€é¡¯ç¤ºã€Œâ€”ã€ï¼‰</div>
        <div class="metaRow">
          <div id="metaLeft">â€”</div>
          <div id="metaRight">â€”</div>
        </div>
      </div>
    </div>

    <div class="modeRow" id="modeRow">
      <div class="bigMic" title="ï¼ˆé€™è£¡å…ˆç•¶ä½œ UI æ¨™ç¤ºï¼Œä¸åšèªéŸ³ï¼‰">ğŸ¤</div>
      <button class="modeBtn active" data-mode="input">è¼¸å…¥</button>
      <button class="modeBtn" data-mode="hint">æç¤º</button>
      <button class="modeBtn" data-mode="collect">æ”¶è—</button>
      <button class="modeBtn" data-mode="fill">å¡«ç©ºå¼•å°</button>
    </div>

    <div class="userBox" id="userBox">
      <div class="userHead">
        <div class="t">ä½ çš„å›è¦†</div>
        <div class="chips">
          <span class="badge" id="levelBadge">A1</span>
          <button class="hideBtn" id="hideBtn">éš±è—</button>
        </div>
      </div>

      <div id="userContent">
        <div class="userPrompt" id="userPrompt">â€”</div>
        <div class="userPromptSub" id="userPromptSub">â€”</div>

        <div class="choiceRow" id="choiceRow"></div>

        <div class="inputWrap">
          <input class="input" id="answerInput" placeholder="è¼¸å…¥ä½ çš„ç­”æ¡ˆâ€¦" />
        </div>

        <div class="actions">
          <button class="send" id="sendBtn">âœ… é€å‡ºå¡«å¥½å¥</button>
          <button class="reset" id="resetBtn">é‡ä¾†</button>
        </div>

        <div class="feedback" id="feedback"></div>
      </div>
    </div>

    <div class="bottomNav">
      <button class="navBtn" id="prevBtn">â—€ ä¸Šä¸€å¥</button>
      <button class="navBtn primary" id="nextBtn">ä¸‹ä¸€å¥ â–¶</button>
    </div>
    <div class="hintText" id="footHint">æç¤ºï¼šç”¨ <code>?src=xxx.dialogue.json</code> æˆ–å³ä¸Šè¼¸å…¥æª”åè¼‰å…¥ï¼ˆéœ€åŒç¶²åŸŸï¼‰ã€‚</div>
  </div>
</div>

<script>
(() => {
  const $ = (q) => document.querySelector(q);
  const langBtns = document.querySelectorAll('.langs button');
  const modeBtns = document.querySelectorAll('.modeBtn');

  const srcInput = $('#srcInput');
  const loadBtn = $('#loadBtn');

  const npcLine = $('#npcLine');
  const npcSub  = $('#npcSub');
  const metaLeft = $('#metaLeft');
  const metaRight = $('#metaRight');

  const avatarBox = $('#avatarBox');
  const avatarFallback = $('#avatarFallback');

  const userBox = $('#userBox');
  const hideBtn = $('#hideBtn');
  const userContent = $('#userContent');

  const userPrompt = $('#userPrompt');
  const userPromptSub = $('#userPromptSub');
  const choiceRow = $('#choiceRow');
  const answerInput = $('#answerInput');

  const sendBtn = $('#sendBtn');
  const resetBtn = $('#resetBtn');
  const feedback = $('#feedback');

  const prevBtn = $('#prevBtn');
  const nextBtn = $('#nextBtn');
  const backBtn = $('#backBtn');

  let DATA = null;
  let idx = 0;
  let lang = 'en';
  let mode = 'input';
  let locked = false;

  function getText(obj, baseKey){
    const key = baseKey + '_' + lang;
    const val = (obj && obj[key]) ? String(obj[key]).trim() : '';
    return val || 'â€”';
  }

  function setAvatar(avatar){
    avatarBox.innerHTML = '';
    if (avatar && typeof avatar === 'string' && avatar.trim()){
      const img = document.createElement('img');
      img.src = avatar;
      img.alt = 'avatar';
      img.onerror = () => {
        avatarBox.innerHTML = '';
        const span = document.createElement('span');
        span.textContent = (DATA?.turns?.[idx]?.npc?.speaker || 'T').slice(0,1).toUpperCase();
        avatarBox.appendChild(span);
      };
      avatarBox.appendChild(img);
    } else {
      const span = document.createElement('span');
      span.textContent = (DATA?.turns?.[idx]?.npc?.speaker || 'T').slice(0,1).toUpperCase();
      avatarBox.appendChild(span);
    }
  }

  function setMode(newMode){
    mode = newMode;
    modeBtns.forEach(b => b.classList.toggle('active', b.dataset.mode === mode));
    // For now, mode is UI only. We keep the core flow stable.
  }

  function normalize(s){
    return String(s || '').trim().toLowerCase();
  }

  function clearFeedback(){
    feedback.textContent = '';
    feedback.className = 'feedback';
  }

  function renderChoices(choices){
    choiceRow.innerHTML = '';
    (choices || []).forEach(c => {
      const btn = document.createElement('button');
      btn.className = 'choice';
      btn.type = 'button';
      btn.textContent = c;
      btn.onclick = () => {
        // Fill blank input
        answerInput.value = c;
      };
      choiceRow.appendChild(btn);
    });
  }

  function getUserPrompt(u){
    if (!u) return {prompt:'â€”', sub:'â€”'};
    const p = getText(u, 'prompt');
    // show small helper line describing the rule
    let sub = 'å›åˆæ¨¡å¼ï¼šå°æ–¹ä¸€å¥ â†’ ä½ ä¸€å¥ã€‚å¡«å…¥ç©ºæ ¼å¾Œé€å‡ºã€‚';
    if (u.type === 'choice') sub = 'è«‹å¾é¸é …ä¸­é¸ä¸€å€‹æœ€åˆé©çš„å›è¦†ã€‚';
    if (u.type === 'free') sub = 'è«‹ç”¨ä¸€å¥çŸ­å¥å›è¦†ï¼ˆå¯è‡ªç”±è¼¸å…¥ï¼‰ã€‚';
    return {prompt:p, sub};
  }

  function render(){
    if (!DATA || !Array.isArray(DATA.turns) || DATA.turns.length === 0) return;

    const t = DATA.turns[idx];
    const m = DATA.meta || {};

    // NPC
    const npc = t.npc || {};
    setAvatar(npc.avatar);
    const speaker = npc.speaker ? String(npc.speaker) : 'Teacher';
    const npcText = getText(npc, 'line');

    npcLine.textContent = npcText;
    npcSub.textContent = speaker;

    metaLeft.textContent = `slugï¼š${m.slug || 'â€”'} Â· turnï¼š${idx+1}/${DATA.turns.length}`;
    metaRight.textContent = m.title ? `titleï¼š${m.title}` : (m.category ? `catï¼š${m.category}` : '');

    // USER
    const u = t.user || {};
    const {prompt, sub} = getUserPrompt(u);
    userPrompt.textContent = prompt;
    userPromptSub.textContent = sub;

    renderChoices(u.choices || []);
    answerInput.value = '';
    clearFeedback();
    locked = false;
    sendBtn.disabled = false;

    // Nav disabled states
    prevBtn.disabled = (idx <= 0);
    nextBtn.disabled = (idx >= DATA.turns.length - 1);
  }

  function checkAnswer(){
    if (!DATA) return;
    const t = DATA.turns[idx];
    const u = t.user || {};
    clearFeedback();

    if (u.type === 'free'){
      feedback.textContent = 'å·²é€å‡ºï¼ˆè‡ªç”±è¼¸å…¥ä¸åˆ¤æ–·æ­£ç¢ºï¼‰ã€‚';
      feedback.classList.add('ok');
      locked = true;
      sendBtn.disabled = true;
      return;
    }

    const ans = normalize(u.answer);
    const got = normalize(answerInput.value);
    if (!got){
      feedback.textContent = 'è«‹å…ˆå¡«å…¥ç­”æ¡ˆæˆ–é»é¸ä¸Šæ–¹é¸é …ã€‚';
      feedback.classList.add('bad');
      return;
    }

    if (ans && got === ans){
      feedback.textContent = 'âœ… æ­£ç¢ºï¼å¯ä»¥ä¸‹ä¸€å¥ã€‚';
      feedback.classList.add('ok');
      locked = true;
      sendBtn.disabled = true;
    } else {
      feedback.textContent = 'âŒ ä¸å°ï¼Œå†è©¦ä¸€æ¬¡ã€‚';
      feedback.classList.add('bad');
    }
  }

  async function loadBySrc(src){
    const res = await fetch(src, {cache:'no-store'});
    if (!res.ok) throw new Error('fetch failed');
    const j = await res.json();
    // Basic schema check
    if (!j || !Array.isArray(j.turns)) throw new Error('bad json schema');
    DATA = j;
    idx = 0;
    // Fill subtitle
    const slug = (DATA.meta && DATA.meta.slug) ? DATA.meta.slug : 'Dialogue';
    $('#subTitle').textContent = slug;
    render();
  }

  function boot(){
    // wire
    backBtn.onclick = () => history.back();

    langBtns.forEach(b=>{
      b.onclick = () => {
        langBtns.forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        lang = b.dataset.lang;
        if (DATA) render();
      };
    });

    modeBtns.forEach(b=>{
      b.onclick = () => setMode(b.dataset.mode);
    });

    hideBtn.onclick = () => {
      const hidden = userContent.classList.toggle('hidden');
      hideBtn.textContent = hidden ? 'é¡¯ç¤º' : 'éš±è—';
    };

    sendBtn.onclick = () => checkAnswer();
    resetBtn.onclick = () => { if (DATA) render(); };

    prevBtn.onclick = () => { if (DATA && idx>0){ idx--; render(); } };
    nextBtn.onclick = () => { if (DATA && idx < DATA.turns.length-1){ idx++; render(); } };

    loadBtn.onclick = async () => {
      const s = srcInput.value.trim();
      if (!s) return;
      try{
        await loadBySrc(s);
      }catch(e){
        npcLine.textContent = 'è¼‰å…¥å¤±æ•—ï¼šè«‹ç¢ºèª src æª”å/è·¯å¾‘ï¼ˆåŒç¶²åŸŸï¼‰èˆ‡ JSON çµæ§‹æ˜¯å¦æ­£ç¢ºã€‚';
        npcSub.textContent = 'â€”';
      }
    };

    // Auto from query
    const qs = new URLSearchParams(location.search);
    const src = qs.get('src') || '';
    if (src){
      srcInput.value = src;
      loadBySrc(src).catch(()=>{
        // show error in UI
        npcLine.textContent = 'è¼‰å…¥å¤±æ•—ï¼šè«‹ç¢ºèª ?src=xxx.dialogue.json';
        npcSub.textContent = 'â€”';
      });
    }
  }

  boot();
})();
</script>
</body>
</html>
