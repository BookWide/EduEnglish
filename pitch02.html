<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/><title>é€šç”¨å½±éŸ³é‡ç”¢å·¥ä½œå° V16</title>
<style>
  :root{ --bg:#050a14; --panel:#0f172a; --text:#f1f5f9; --ok:#10b981; --btn:#3b82f6; --line:#1e293b; }
  body{ background:var(--bg); color:var(--text); font-family: system-ui; padding:20px; margin:0; }
  .card{ background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:20px; margin-bottom:20px; box-shadow:0 10px 15px rgba(0,0,0,0.5); }
  h1{ margin:0 0 15px 0; font-size:20px; color:var(--ok); }
  .control-grid{ display:grid; grid-template-columns: 2fr 1.5fr 1fr; gap:12px; margin-bottom:15px; }
  label{ display:block; color:#94a3b8; font-size:12px; margin-bottom:5px; }
  input, select, textarea{ width:100%; background:#000; border:1px solid var(--line); color:#22c55e; border-radius:10px; padding:10px; outline:none; font-size:14px; }
  
  /* é€²åº¦æ¢çµ„ä»¶ */
  #progContainer { display:none; margin-top:15px; }
  .prog-track { background:rgba(255,255,255,0.1); height:14px; border-radius:20px; overflow:hidden; }
  .prog-bar { background:var(--ok); width:0%; height:100%; transition:0.3s; }
  .prog-msg { font-size:12px; color:var(--ok); text-align:center; margin-bottom:5px; font-weight:bold; }

  .btn{ background:var(--btn); color:#fff; border:none; padding:12px; border-radius:10px; cursor:pointer; font-weight:bold; width:100%; }
  .btn:active{ transform:scale(0.98); }
  table{ width:100%; border-collapse:collapse; margin-top:20px; }
  th, td{ border:1px solid var(--line); padding:12px; text-align:left; }
  th{ color:#94a3b8; background:rgba(255,255,255,0.05); }
  .badge-merge { background:var(--ok); color:#000; font-size:10px; padding:2px 6px; border-radius:4px; font-weight:bold; }
</style>
</head>
<body>

<div class="card">
  <h1>ğŸš€ é€šç”¨å½±éŸ³é‡ç”¢å·¥ä½œå° V16 (åŠ‡æƒ…è‡ªé©æ‡‰ç‰ˆ)</h1>
  <div class="control-grid">
    <div>
      <label>1. ä¸Šå‚³ SRT (çµå°¾åŠ  ">>" åˆä½µåŠ‡æƒ…ï¼ŒçœéŒ¢ä¸”ç•«é¢ç©©å®š)</label>
      <input type="file" id="srtFile" accept=".srt"/>
    </div>
    <div>
      <label>2. åŠ‡æƒ…é—œéµå­—é–å®š (æ‰‹å‹•è¼¸å…¥æœ¬ç‰‡ä¸»è§’ï¼Œå¦‚ï¼šç´…é¾ã€åµæ¢ã€ç…å­)</label>
      <input id="subjectLock" type="text" placeholder="ä¾‹å¦‚ï¼šA golden retriever dog"/>
    </div>
    <div>
      <label>3. å½±ç‰‡æ‰¹æ¬¡ ID</label>
      <input id="batchId" type="text" placeholder="å¦‚ï¼šep001"/>
    </div>
  </div>

  <div id="progContainer">
    <div class="prog-msg" id="progMsg">ç­‰å¾…æŒ‡ä»¤...</div>
    <div class="prog-track"><div id="progBar" class="prog-bar"></div></div>
  </div>

  <button class="btn" style="background:var(--ok); margin-top:10px;" onclick="generateTasks()">è§£æåŠ‡æœ¬ä¸¦å•Ÿå‹•é‡ç”¢ä»»å‹™</button>
</div>

<table id="mainTable">
  <thead>
    <tr>
      <th width="100">ä»»å‹™ ID</th>
      <th width="150">æ™‚é–“è»¸</th>
      <th>å­—å¹•å…§å®¹ (ç”¢å‡º MP3)</th>
      <th>ç”Ÿåœ–æŒ‡ä»¤ (Imagen 3)</th>
      <th width="120">æ“ä½œ</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
const IMG_API = "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/img-one";
const TTS_API = "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/tts-mp3";

async function generateTasks() {
  const file = document.getElementById('srtFile').files[0];
  if(!file) return alert("è«‹å…ˆé¸å– SRT æª”æ¡ˆ");
  
  document.getElementById('progContainer').style.display = 'block';
  const bar = document.getElementById('progBar');
  const msg = document.getElementById('progMsg');
  
  msg.innerText = "æ­£åœ¨æ·±åº¦è®€å–åŠ‡æœ¬åŠ‡æƒ…...";
  bar.style.width = "30%";

  const text = await file.text();
  const subject = document.getElementById('subjectLock').value;
  const bid = document.getElementById('batchId').value || "vid";
  
  const blocks = text.trim().split(/\n\s*\n/).map(b => {
    const lines = b.split('\n');
    return { time: lines[1], text: lines.slice(2).join(" ").trim() };
  });

  const tbody = document.querySelector('#mainTable tbody');
  tbody.innerHTML = "";
  let group = [], startT = "", counter = 1;

  bar.style.width = "70%";
  msg.innerText = "æ­£åœ¨æ ¹æ“šåŠ‡æƒ…åˆ†é…åœ–ç‰‡å¯†åº¦èˆ‡é…éŸ³ä»»å‹™...";

  blocks.forEach((item, idx) => {
    const isMerging = item.text.includes(">>");
    const cleanContent = item.text.replace(">>", "").trim();
    if(!startT) startT = item.time.split(" --> ")[0];
    group.push(cleanContent);

    if(!isMerging || idx === blocks.length - 1) {
      const fullText = group.join(" ");
      const taskId = `${bid}_${String(counter).padStart(3, '0')}`;
      
      // é€™è£¡ä¸å†ç¡¬ç·¨ç¢¼è€é¼ ï¼Œè€Œæ˜¯å®Œå…¨è½å¾æ‚¨çš„ subject è¼¸å…¥èˆ‡åŠ‡æœ¬å…§å®¹
      const prompt = `Cinematic photo, realistic 8k, professional photography. [Subject: ${subject}]. Action: ${fullText}. (No humans unless specified)`;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><b>${taskId}</b> ${group.length > 1 ? '<span class="badge-merge">å·²åˆä½µ</span>' : ''}</td>
        <td><small>${startT}</small></td>
        <td><textarea rows="3" id="txt_${taskId}">${fullText}</textarea></td>
        <td><textarea rows="3" id="pmt_${taskId}">${prompt}</textarea></td>
        <td><button class="btn" onclick="executeOne('${taskId}')">ä¸€éµå½±éŸ³</button></td>
      `;
      tbody.appendChild(tr);
      group = []; startT = ""; counter++;
    }
  });

  bar.style.width = "100%";
  msg.innerText = "è§£æå®Œç•¢ï¼è«‹æŒ‰é †åºåŸ·è¡Œæˆ–é€²è¡Œæ‰¹æ¬¡ç”¢å‡ºã€‚";
}

async function executeOne(id) {
  const t = document.getElementById('txt_'+id).value;
  const p = document.getElementById('pmt_'+id).value;
  
  // å½±éŸ³åŒæ­¥ç”¢å‡ºé‚è¼¯
  [TTS_API, IMG_API].forEach((api, i) => {
    fetch(api, {
      method: "POST",
      headers: { "Content-Type":"application/json", "apikey":SUPA_KEY, "Authorization":"Bearer "+SUPA_KEY },
      body: JSON.stringify(i === 0 ? { text: t, voice: "en-US-GuyNeural" } : { prompt: p, model: "imagen-3", size: "1536x1024" })
    }).then(r => r.blob()).then(blob => {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = i === 0 ? `${id}.mp3` : `${id}.png`;
      a.click();
    });
  });
}
</script>
</body>
</html>

