<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/><title>é‡ç”¢å·¥å»  V24 - å½±ç‰‡é©…å‹•å®šè£ç‰ˆ</title>
<style>
  :root{ --bg:#050a14; --panel:#0f172a; --text:#f1f5f9; --ok:#10b981; --btn:#3b82f6; --line:#1e293b; --done:#334155; }
  body{ background:var(--bg); color:var(--text); font-family: system-ui; padding:20px; }
  .card{ background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:20px; margin-bottom:20px; box-shadow:0 8px 32px rgba(0,0,0,0.5); }
  .grid{ display:grid; grid-template-columns: 2fr 1fr 1fr; gap:12px; margin-bottom:15px; }
  input, select, textarea{ width:100%; background:#000; border:1px solid var(--line); color:#22c55e; border-radius:10px; padding:10px; font-size:14px; outline:none; }
  
  /* é€²åº¦ç›£æ§ */
  .status-info { background:rgba(255,255,255,0.05); padding:10px; border-radius:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; }
  .prog-fill { background: var(--ok); height: 8px; border-radius: 4px; width: 0%; transition: 0.3s; margin-top: 5px; }
  
  .btn{ background:var(--btn); color:white; border:none; padding:12px; border-radius:10px; cursor:pointer; font-weight:bold; transition: 0.2s; }
  .btn:active { transform: scale(0.98); }
  .btn.is-done { background:var(--done); color:#94a3b8; }
  
  table{ width:100%; border-collapse:collapse; margin-top:20px; }
  th, td{ border:1px solid var(--line); padding:12px; text-align:left; }
  tr.is-done { opacity: 0.5; background: rgba(0,0,0,0.2); }
  .badge { background:var(--ok); color:#000; font-size:11px; padding:2px 6px; border-radius:4px; font-weight:bold; }
</style>
</head>
<body>

<div class="card">
  <h1>ğŸ¬ å½±éŸ³æ‰¹æ¬¡é‡ç”¢å·¥å»  V24 (Video-to-Video é©…å‹•ç‰ˆ)</h1>
  <div class="grid">
    <div>
      <label style="font-size:12px;color:#94a3b8;">1. ä¸»è§’è¦–è¦º ID (æŠŠ Gemini åˆ†æçš„ç‰¹å¾µè²¼é€™)</label>
      <input id="charLock" type="text" placeholder="ä¾‹ï¼šA cinematic brown mouse with a tiny scar over its left eye"/>
    </div>
    <div>
      <label style="font-size:12px;color:#94a3b8;">2. é¢¨æ ¼å¤§é¡</label>
      <select id="vStyle">
        <option value="Hyper-realistic photography, 8k">å¯«å¯¦æ”å½±</option>
        <option value="3D render, Pixar style">3D å¡é€š</option>
        <option value="Classic Storybook illustration">ç«¥è©±æ’åœ–</option>
      </select>
    </div>
    <div>
      <label style="font-size:12px;color:#94a3b8;">3. æ‰¹æ¬¡ç·¨è™Ÿ</label>
      <input id="batchId" type="text" placeholder="Ep001"/>
    </div>
  </div>
  <input type="file" id="srtFile" style="margin-bottom:15px;" />
  <button class="btn" style="background:var(--ok); width:100%;" onclick="startProcess()">è§£æä¸¦å»ºç«‹ç‹€æ…‹ç›£æ§ä»»å‹™</button>
</div>

<div class="status-info" id="progUI" style="display:none; flex-direction:column; align-items:start;">
  <div style="display:flex; justify-content:space-between; width:100%">
    <span id="progText" style="color:var(--ok); font-weight:bold;">å·²å®Œæˆ 0 / 0</span>
    <span style="font-size:11px; color:#94a3b8;">* é»éæŒ‰éˆ•å¾Œè®Šç°è‰²ä»£è¡¨å·²å­˜æª”</span>
  </div>
  <div style="width:100%; background:rgba(255,255,255,0.1); border-radius:4px; margin-top:5px;">
    <div id="progBar" class="prog-fill"></div>
  </div>
</div>

<table id="mainTable">
  <thead>
    <tr><th width="100">ID</th><th width="140">æ™‚é–“è»¸</th><th>é…éŸ³æ–‡å­— (MP3)</th><th>è¦–è¦ºé–å®š (PNG)</th><th width="130">ä¸€éµä¸‹è¼‰</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
const IMG_API = "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/img-one";
const TTS_API = "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/tts-mp3";

async function startProcess() {
  const file = document.getElementById('srtFile').files[0];
  if(!file) return alert("è«‹é¸ SRT");
  
  const text = await file.text();
  const char = document.getElementById('charLock').value || "subject";
  const style = document.getElementById('vStyle').value;
  const bid = document.getElementById('batchId').value || "v";
  
  const blocks = text.trim().split(/\n\s*\n/).map(b => {
    const lines = b.split('\n');
    return { time: lines[1], text: lines.slice(2).join(" ").trim() };
  });

  const tbody = document.querySelector('#mainTable tbody');
  tbody.innerHTML = "";
  document.getElementById('progUI').style.display = 'flex';
  
  let group = [], startT = "", counter = 1;

  blocks.forEach((item, idx) => {
    const isMerging = item.text.includes(">>");
    const clean = item.text.replace(">>", "").trim();
    if(!startT) startT = item.time.split(" --> ")[0];
    group.push(clean);

    if(!isMerging || idx === blocks.length - 1) {
      const fullText = group.join(" ");
      const id = `${bid}_${String(counter).padStart(3, '0')}`;
      const prompt = `[Style: ${style}]. [Character ID: ${char}]. Action: ${fullText}. (Strict: Keep subject as ${char})`;

      const tr = document.createElement('tr');
      tr.id = `row_${id}`;
      tr.innerHTML = `
        <td><b>${id}</b><br>${group.length > 1 ? '<span class="badge">å·²åˆä½µ</span>' : ''}</td>
        <td><small>${startT}</small></td>
        <td><textarea id="t_${id}" rows="3">${fullText}</textarea></td>
        <td><textarea id="p_${id}" rows="3">${prompt}</textarea></td>
        <td><button class="btn" id="btn_${id}" onclick="genAll('${id}')">å½±éŸ³é›™å‡º</button></td>
      `;
      tbody.appendChild(tr);
      group = []; startT = ""; counter++;
    }
  });
  updateProg();
}

async function genAll(id) {
  const t = document.getElementById('t_'+id).value;
  const p = document.getElementById('p_'+id).value;
  const btn = document.getElementById('btn_'+id);
  const row = document.getElementById('row_'+id);

  [TTS_API, IMG_API].forEach((api, i) => {
    fetch(api, {
      method: "POST",
      headers: { "Content-Type":"application/json", "apikey":SUPA_KEY, "Authorization":"Bearer "+SUPA_KEY },
      body: JSON.stringify(i === 0 ? { text: t, voice: "en-US-GuyNeural" } : { prompt: p, model: "imagen-3", size: "1536x1024" })
    }).then(r => r.blob()).then(blob => {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = i === 0 ? `${id}.mp3` : `${id}.png`;
      a.click();
      btn.classList.add('is-done'); row.classList.add('is-done'); updateProg();
    });
  });
}

function updateProg() {
  const all = document.querySelectorAll('tbody tr').length;
  const done = document.querySelectorAll('tbody tr.is-done').length;
  const pct = all === 0 ? 0 : Math.round((done / all) * 100);
  document.getElementById('progBar').style.width = pct + "%";
  document.getElementById('progText').innerText = `å·²å®Œæˆé€²åº¦ï¼š${pct}% (${done} / ${all})`;
}
</script>
</body>
</html>


