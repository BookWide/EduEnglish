<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/><title>é‡ç”¢å°ˆå®¶ V33 - é€šç”¨æ——è‰¦ç‰ˆ</title>
<style>
  :root{ --bg:#050a14; --panel:#111827; --text:#f3f4f6; --ok:#10b981; --btn:#3b82f6; --line:#374151; --done:#4b5563; }
  body{ background:var(--bg); color:var(--text); font-family: system-ui, sans-serif; padding:20px; margin:0; }
  .card{ background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:25px; margin-bottom:20px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
  .grid{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px; margin-bottom:20px; }
  label{ display:block; font-size:13px; color:#9ca3af; margin-bottom:8px; font-weight: 500; }
  input, select, textarea{ width:100%; background:#000; border:1px solid var(--line); color:#22c55e; border-radius:10px; padding:12px; font-size:14px; outline:none; transition: 0.2s; }
  input:focus, textarea:focus{ border-color: var(--btn); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
  
  .char-area { margin-bottom: 20px; }
  .btn{ background:var(--btn); color:white; border:none; padding:15px; border-radius:10px; cursor:pointer; font-weight:bold; font-size:16px; transition: 0.2s; }
  .btn:hover{ filter: brightness(1.1); }
  .btn:active{ transform: scale(0.98); }
  .btn.is-done { background:var(--done); color:#d1d5db; }
  .btn.is-done::after { content: " (å·²ç”¢å‡º)"; }

  table{ width:100%; border-collapse:collapse; margin-top:20px; background: rgba(255,255,255,0.02); }
  th, td{ border:1px solid var(--line); padding:15px; text-align:left; vertical-align:top; }
  th{ background: rgba(255,255,255,0.05); color: #9ca3af; font-size: 13px; }
  tr.is-done { opacity: 0.4; background: rgba(0,0,0,0.3); }
  .batch-tag { background:var(--ok); color:#000; font-size:11px; padding:3px 8px; border-radius:5px; font-weight:bold; }
  #statusMsg { color:var(--ok); font-weight:bold; padding: 10px 0; border-bottom: 1px solid var(--line); margin-bottom: 10px; }
</style>
</head>
<body>

<div class="card">
  <h1 style="margin-top:0; color:var(--btn);">ğŸ¬ é€šç”¨å½±éŸ³é‡ç”¢å·¥å»  V33</h1>
  
  <div class="char-area">
    <label>1. å…¨å±€ä¸»è§’ç‰¹å¾µé–å®š (æ”¯æ´å¤šè¡Œé•·ç¯‡æè¿°ï¼Œé˜²æ­¢ AI éš¨æ©Ÿè®Šå½¢)</label>
    <textarea id="charSpec" rows="4" placeholder="åœ¨é€™è£¡è²¼å…¥è©³ç´°çš„è§’è‰²å®šè£è©ï¼Œä¾‹å¦‚ï¼šå­”æ˜çš„ç¾½æ‰‡ã€è€é¼ çš„æ¯›è‰²ç´°ç¯€ã€å¤ªç©ºäººçš„é ­ç›”ç‰¹å¾µ..."></textarea>
  </div>

  <div class="grid">
    <div>
      <label>2. å½±ç‰‡å¤§é¡ (æ±ºå®šæ•´é«”è¦–è¦ºé¢¨æ ¼)</label>
      <select id="vCategory" onchange="autoProcess()">
        <option value="Cinematic realistic photography, nature documentary style, 8k, highly detailed">1. è‡ªç„¶å¯«å¯¦ (å¯«å¯¦å‹•ç‰©/ç§‘æ™®)</option>
        <option value="Disney/Pixar style 3D animation, bright and vivid colors, cute character design">2. å¤¢å¹»ç«¥è©± (3D å¡é€š/æº«é¦¨)</option>
        <option value="Moody dark cinematic drama, high contrast, atmospheric lighting, mystery">3. æš—é»‘å¯“è¨€ (å²è©©/ç¥ç¥•)</option>
        <option value="Classic watercolor illustration, storybook hand-drawn style, soft colors">4. æ°´å½©ç¹ªæœ¬ (å‚³çµ±/ç¹ªæœ¬)</option>
        <option value="Epic fantasy movie scene, wide angle lens, breathtaking cinematic scale">5. å²è©©é›»å½± (ä¸‰åœ‹/å†’éšª/å¤§ç‰‡)</option>
      </select>
    </div>
    <div>
      <label>3. åŠ‡æƒ…åˆä½µå¯†åº¦ (è‡ªå‹•åˆ†çµ„)</label>
      <select id="density" onchange="autoProcess()">
        <option value="1">1 å¥ä¸€æ®µ (æœ€ç²¾ç´°)</option>
        <option value="3">3 å¥ä¸€æ®µ (å¹³è¡¡)</option>
        <option value="5" selected>5 å¥ä¸€æ®µ (é‡ç”¢æ¨è–¦)</option>
        <option value="10">10 å¥ä¸€æ®µ (æ¥µé€ŸçœéŒ¢)</option>
      </select>
    </div>
    <div>
      <label>4. è®€å– Buzz SRT æª”æ¡ˆ</label>
      <input type="file" id="srtFile" onchange="autoProcess()" />
    </div>
  </div>
  
  <div id="statusMsg">ç­‰å¾…è¼‰å…¥åŠ‡æœ¬...</div>
  <button class="btn" style="background:var(--ok); width: 100%;" onclick="autoProcess()">ğŸ”„ é‡æ–°åŒæ­¥æ‰€æœ‰ä»»å‹™</button>
</div>

<table id="mainTable">
  <thead>
    <tr><th width="110">ä»»å‹™ ID</th><th width="120">é–‹å§‹æ™‚é–“</th><th>åŠ‡æƒ…å…§å®¹ (MP3)</th><th>è¦–è¦ºæŒ‡ä»¤ (PNG)</th><th width="130">åŸ·è¡Œç‹€æ…‹</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
const IMG_API = "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/img-one";
const TTS_API = "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/tts-mp3";

let srtData = [];

async function autoProcess() {
  const file = document.getElementById('srtFile').files[0];
  if(!file) return;

  const rawText = await file.text();
  const style = document.getElementById('vCategory').value;
  const char = document.getElementById('charSpec').value || "the protagonist";
  const step = parseInt(document.getElementById('density').value);
  
  // å¼·æ•ˆæ­£å‰‡è§£æ
  const regex = /(\d+)\s+(\d{2}:\d{2}:\d{2},\d{3} --> \d{2}:\d{2}:\d{2},\d{3})\s+([\s\S]*?)(?=\n\d+\s+\d{2}:\d{2}:\d{2},\d{3} -->|$)/g;
  let match;
  srtData = [];
  while ((match = regex.exec(rawText)) !== null) {
    srtData.push({ time: match[2], text: match[3].trim().replace(/\r?\n/g, " ") });
  }

  const tbody = document.querySelector('#mainTable tbody');
  tbody.innerHTML = "";
  
  for (let i = 0; i < srtData.length; i += step) {
    const chunk = srtData.slice(i, i + step);
    const fullText = chunk.map(c => c.text).join(" ");
    const idx = Math.floor(i/step) + 1;
    const id = `Task_${String(idx).padStart(3, '0')}`;
    const prompt = `Style: ${style}. Character: ${char}. Scene: ${fullText}. (Maintain consistency, high quality, no human distortion if animal)`;

    const tr = document.createElement('tr');
    tr.id = `row_${id}`;
    tr.innerHTML = `
      <td><b>${id}</b><br><span class="batch-tag">${chunk.length} å¥åˆä½µ</span></td>
      <td><small>${chunk[0].time.split(' --> ')[0]}</small></td>
      <td><textarea rows="3" id="t_${id}">${fullText}</textarea></td>
      <td><textarea rows="3" id="p_${id}">${prompt}</textarea></td>
      <td><button class="btn" id="b_${id}" onclick="execute('${id}')">ä¸€éµç”¢å‡º</button></td>
    `;
    tbody.appendChild(tr);
  }
  document.getElementById('statusMsg').innerText = `âœ… åŠ‡æœ¬è¼‰å…¥æˆåŠŸï¼šå·²è‡ªå‹•åˆ†çµ„ç‚º ${Math.ceil(srtData.length/step)} å€‹åŠ‡æƒ…ä»»å‹™ã€‚`;
}

async function execute(id) {
  const t = document.getElementById('t_'+id).value;
  const p = document.getElementById('p_'+id).value;
  const btn = document.getElementById('b_'+id);
  const row = document.getElementById('row_'+id);

  [TTS_API, IMG_API].forEach((api, i) => {
    fetch(api, {
      method: "POST",
      headers: { "Content-Type":"application/json", "apikey":SUPA_KEY, "Authorization":"Bearer "+SUPA_KEY },
      body: JSON.stringify(i === 0 ? { text: t, voice: "en-US-GuyNeural" } : { prompt: p, model: "imagen-3", size: "1536x1024" })
    }).then(r => r.blob()).then(blob => {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = i === 0 ? `${id}.mp3` : `${id}.png`;
      a.click();
      btn.classList.add('is-done'); row.classList.add('is-done');
    });
  });
}
</script>
</body>
</html>






