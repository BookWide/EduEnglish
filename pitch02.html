<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/><title>å½±ç‰‡ç”Ÿå½±ç‰‡é‡ç”¢å·¥ä½œå° V22</title>
<style>
  :root{ --bg:#050a14; --panel:#0f172a; --text:#f1f5f9; --ok:#10b981; --btn:#3b82f6; --line:#1e293b; --done:#334155; }
  body{ background:var(--bg); color:var(--text); font-family: system-ui; padding:20px; margin:0; }
  .card{ background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:20px; margin-bottom:20px; }
  .grid{ display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:12px; margin-bottom:15px; }
  input, select, textarea{ width:100%; background:#000; border:1px solid var(--line); color:#22c55e; border-radius:10px; padding:10px; font-size:14px; outline:none; }
  .btn{ background:var(--btn); color:white; border:none; padding:12px; border-radius:10px; cursor:pointer; font-weight:bold; width:100%; transition:0.2s; }
  .btn.is-done { background:var(--done); color:#94a3b8; }
  .btn:hover { filter: brightness(1.2); }
  table{ width:100%; border-collapse:collapse; margin-top:20px; }
  th, td{ border:1px solid var(--line); padding:12px; text-align:left; vertical-align:top; }
  th{ color:#94a3b8; background:rgba(255,255,255,0.05); }
  tr.is-done { opacity: 0.5; background: rgba(0,0,0,0.3); }
  .tag { background:#f59e0b; color:#000; font-size:10px; padding:2px 6px; border-radius:4px; font-weight:bold; }
</style>
</head>
<body>

<div class="card">
  <h1>ğŸ¬ å½±ç‰‡ç”Ÿå½±ç‰‡é‡ç”¢å·¥å»  V22 (åŠ‡æƒ…èˆ‡ç‰¹å¾µé–å®š)</h1>
  <div class="grid">
    <div>
      <label style="font-size:12px;color:#94a3b8;">1. å½±ç‰‡è¦–è¦ºé¢¨æ ¼ (å½±ç‰‡ç”Ÿå½±ç‰‡é¢¨æ ¼)</label>
      <select id="vidType">
        <option value="Hyper-realistic cinematic film, 8k">é›»å½±é‡ç¹ª (å¯«å¯¦)</option>
        <option value="3D animation, Pixar style, vivid texture">3D å‹•ç•«åŒ–</option>
        <option value="Traditional hand-drawn anime style">2D å‹•æ¼«åŒ–</option>
        <option value="Oil painting, artistic brushstrokes">è—è¡“æ²¹ç•«æ„Ÿ</option>
      </select>
    </div>
    <div>
      <label style="font-size:12px;color:#94a3b8;">2. ä¸»è§’èˆ‡ç‰¹å¾µæè¿° (é˜²è®Šè‰²è®Šäºº)</label>
      <input id="charSpec" type="text" placeholder="ä¾‹å¦‚ï¼šä¸€éš»æˆ´è—è‰²åœå·¾çš„å°æ¾é¼ "/>
    </div>
    <div>
      <label style="font-size:12px;color:#94a3b8;">3. æ¯å¹¾å¥åˆ‡æ›ä¸€æ¬¡å ´æ™¯?</label>
      <select id="stepSize">
        <option value="3">3 å¥ (ç©©å®šé€£è²«)</option>
        <option value="5" selected>5 å¥ (é«˜æ•ˆé‡ç”¢)</option>
        <option value="10">10 å¥ (è¶…é•·å ´æ™¯)</option>
      </select>
    </div>
    <div>
      <label style="font-size:12px;color:#94a3b8;">4. å½±ç‰‡æ‰¹æ¬¡ ID</label>
      <input id="vidBatch" type="text" placeholder="Vid_001"/>
    </div>
  </div>
  <div style="padding:10px; border:1px dashed var(--line); border-radius:10px;">
    <label style="color:var(--ok)">ä¸Šå‚³ SRT åŠ‡æœ¬æª”æ¡ˆ</label>
    <input type="file" id="srtFile" />
  </div>
  <button class="btn" style="background:var(--ok); margin-top:15px;" onclick="initBatch()">è§£æåŠ‡æƒ…ï¼šå»ºç«‹ç‰¹å¾µé–å®šä»»å‹™</button>
</div>

<div id="progBar" style="text-align:center; color:var(--ok); font-weight:bold; margin-bottom:10px;"></div>

<table id="mainTable">
  <thead>
    <tr><th width="120">æ‰¹æ¬¡ ID</th><th width="150">æ™‚é–“å€æ®µ</th><th>åŠ‡æƒ…å…§å®¹ (ç”¢å‡ºèªéŸ³)</th><th>è¦–è¦ºé–å®šæç¤ºè© (Imagen 3)</th><th width="130">ç”Ÿæˆç‹€æ…‹</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
// å»¶ç”¨æ‚¨åŸæœ¬ç©©å®šé‹ä½œçš„ API é…ç½®
const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
const IMG_API = "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/img-one";
const TTS_API = "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/tts-mp3";

async function initBatch() {
  const file = document.getElementById('srtFile').files[0];
  if(!file) return alert("è«‹ä¸Šå‚³åŠ‡æœ¬");
  
  const text = await file.text();
  const vStyle = document.getElementById('vidType').value;
  const vChar = document.getElementById('charSpec').value || "Main protagonist";
  const step = parseInt(document.getElementById('stepSize').value);
  const bid = document.getElementById('vidBatch').value || "V";
  
  const blocks = text.trim().split(/\n\s*\n/).map(b => {
    const lines = b.split('\n');
    return { time: lines[1], text: lines.slice(2).join(" ").trim() };
  });

  const tbody = document.querySelector('#mainTable tbody');
  tbody.innerHTML = "";
  
  for (let i = 0; i < blocks.length; i += step) {
    const chunk = blocks.slice(i, i + step);
    const combinedText = chunk.map(c => c.text.replace(">>","")).join(" ");
    const startTime = chunk[0].time.split(" --> ")[0];
    const taskId = `${bid}_${String(Math.floor(i/step)+1).padStart(3, '0')}`;
    
    // é–å®šè¦–è¦ºéŒ¨é»ï¼Œé˜²æ­¢ç”Ÿå½±ç‰‡æ™‚è§’è‰²å´©å£
    const finalPrompt = `[Visual Consistency: ${vChar}]. Style: ${vStyle}. Narrative Arc: ${combinedText}. (Ensure the subject is strictly a ${vChar}, avoid humans)`;

    const tr = document.createElement('tr');
    tr.id = `row_${taskId}`;
    tr.innerHTML = `
      <td><b>${taskId}</b><br><span class="tag">${chunk.length} å¥åˆä½µ</span></td>
      <td><small>${startTime}</small></td>
      <td><textarea rows="4" id="t_${taskId}">${combinedText}</textarea></td>
      <td><textarea rows="4" id="p_${taskId}">${finalPrompt}</textarea></td>
      <td><button class="btn" id="btn_${taskId}" onclick="runSingle('${taskId}')">ä¸‹è¼‰å½±éŸ³åŒ…</button></td>
    `;
    tbody.appendChild(tr);
  }
  updateStatus();
}

async function runSingle(id) {
  const t = document.getElementById('t_'+id).value;
  const p = document.getElementById('p_'+id).value;
  const btn = document.getElementById('btn_'+id);
  const row = document.getElementById('row_'+id);

  [TTS_API, IMG_API].forEach((api, i) => {
    fetch(api, {
      method: "POST",
      headers: { "Content-Type":"application/json", "apikey":SUPA_KEY, "Authorization":"Bearer "+SUPA_KEY },
      body: JSON.stringify(i === 0 ? { text: t, voice: "en-US-GuyNeural" } : { prompt: p, model: "imagen-3", size: "1536x1024" })
    }).then(r => r.blob()).then(blob => {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = i === 0 ? `${id}.mp3` : `${id}.png`;
      a.click();
      btn.classList.add('is-done'); row.classList.add('is-done'); updateStatus();
    });
  });
}

function updateStatus() {
  const all = document.querySelectorAll('tbody tr').length;
  const done = document.querySelectorAll('tbody tr.is-done').length;
  document.getElementById('progBar').innerText = `âœ… é‡ç”¢é€²åº¦ï¼šå·²ç”¢å‡º ${done} / ç¸½å…± ${all} çµ„åŠ‡æƒ…ç´ æ`;
}
</script>
</body>
</html>



