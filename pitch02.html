<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<title>é‡ç”¢å°ˆå®¶ V10 - å½±ç‰‡é©…å‹•èˆ‡é€²åº¦ç›£æ§</title>
<style>
  :root{ --bg:#0b1220; --panel:#0f1b33; --text:#e8eefc; --line:#1b2b4b; --ok:#22c55e; --btn:#1f6feb; }
  body{ background:var(--bg); color:var(--text); font-family: system-ui; padding:20px; }
  .card{ background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:20px; margin-bottom:20px; }
  .grid{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px; margin-bottom:15px; }
  input, select, textarea{ background:#000; border:1px solid var(--line); color:#22c55e; border-radius:8px; padding:10px; width:100%; font-size:14px; }
  
  /* é€²åº¦æ¢çµ„ä»¶ */
  #progressSection { display:none; margin: 20px 0; }
  .progress-bg { background: rgba(255,255,255,0.1); border-radius:10px; height:12px; overflow:hidden; }
  .progress-fill { background: var(--ok); width: 0%; height: 100%; transition: width 0.3s; }
  .status-label { font-size:12px; color:var(--ok); margin-bottom:5px; text-align:center; }

  .btn{ background:var(--btn); color:#fff; border:none; padding:12px; border-radius:10px; cursor:pointer; font-weight:bold; width:100%; }
  table{ width:100%; border-collapse:collapse; margin-top:20px; }
  th, td{ border:1px solid var(--line); padding:10px; font-size:13px; }
</style>
</head>
<body>

<div class="card">
  <h1>ğŸ¬ é‡ç”¢å°ˆå®¶ V10 (å½±ç‰‡é©…å‹•æ¨¡å¼)</h1>
  <div class="grid">
    <div>
      <label style="font-size:12px;color:#9fb1d1;">1. ä¸Šå‚³ SRT (åŠ  >> åˆä½µ)</label>
      <input type="file" id="srtFile" />
    </div>
    <div>
      <label style="font-size:12px;color:#9fb1d1;">2. å½±ç‰‡åƒè€ƒ/ä¸»è§’å®šè£</label>
      <select id="mainChar">
        <option value="A realistic brown field mouse">è€é¼  (ä¸è®Šäººæ¨¡å¼)</option>
        <option value="A cinematic African lion">ç…å­ (å¯«å¯¦æ¨¡å¼)</option>
        <option value="Custom">è‡ªå®šç¾©åŠ‡æƒ…ä¸»è§’...</option>
      </select>
    </div>
    <div>
      <label style="font-size:12px;color:#9fb1d1;">3. å½±ç‰‡æ‰¹æ¬¡ç·¨è™Ÿ</label>
      <input id="shortName" type="text" placeholder="å¦‚: 001_lion" />
    </div>
  </div>

  <div id="progressSection">
    <div class="status-label" id="statusMsg">æº–å‚™å°±ç·’</div>
    <div class="progress-bg"><div class="progress-fill" id="progBar"></div></div>
  </div>

  <button class="btn" style="background:var(--ok)" onclick="startV10()">é–‹å§‹è§£æä¸¦é–å®šè¦–è¦ºé¢¨æ ¼</button>
</div>

<table id="taskTable">
  <thead>
    <tr>
      <th width="80">ç·¨è™Ÿ</th>
      <th width="150">æ™‚é–“è»¸</th>
      <th>å­—å¹• (é…éŸ³)</th>
      <th>Imagen 3 æŒ‡ä»¤ (å·²é–å®šè§’è‰²åœ–)</th>
      <th width="80">ç”Ÿåœ–</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
const IMG_API = "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/img-one";

async function startV10() {
  const file = document.getElementById('srtFile').files[0];
  if(!file) return alert("è«‹å…ˆé¸æ“‡ SRT æª”");
  
  // å•Ÿå‹•é€²åº¦æ¢
  document.getElementById('progressSection').style.display = 'block';
  const bar = document.getElementById('progBar');
  const msg = document.getElementById('statusMsg');

  msg.innerText = "æ­£åœ¨åˆ†æå½±ç‰‡åƒè€ƒä¸¦è®€å–åŠ‡æœ¬...";
  bar.style.width = "30%";

  const text = await file.text();
  const char = document.getElementById('mainChar').value;
  const sname = document.getElementById('shortName').value || "vid";
  
  const items = text.trim().split(/\n\s*\n/).map(b => {
    const lines = b.split('\n');
    return { time: lines[1], text: lines.slice(2).join(" ").trim() };
  });

  const tbody = document.querySelector('#taskTable tbody');
  tbody.innerHTML = "";
  
  let group = [];
  let startT = "";
  let counter = 1;

  bar.style.width = "60%";
  msg.innerText = "æ­£åœ¨å»ºç«‹è¦–è¦ºé€£è²«æ€§æç¤ºè©...";

  items.forEach((item, idx) => {
    const isMerging = item.text.includes(">>");
    const clean = item.text.replace(">>", "").trim();
    if(!startT) startT = item.time.split(" --> ")[0];
    group.push(clean);

    if(!isMerging || idx === items.length - 1) {
      const full = group.join(" ");
      const id = `${sname}_${String(counter).padStart(3, '0')}`;
      
      // æ ¸å¿ƒä¿®æ­£ï¼šå¼·åˆ¶é–å®šä¸»è§’å½¢æ…‹ï¼Œè§£æ±ºè€é¼ è®Šäººçš„å•é¡Œ
      const prompt = `[Visual Reference: ${char}]. Cinematic 8k photography. Scene: ${full}. (Important: Maintain character as ${char}, no humans).`;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${id}</td>
        <td><small>${startT}</small></td>
        <td><textarea rows="2">${full}</textarea></td>
        <td><textarea rows="2">${prompt}</textarea></td>
        <td><button class="btn" onclick="exec('${id}','${prompt.replace(/'/g,"\\'")}')" style="font-size:12px;padding:5px;">ç”Ÿåœ–</button></td>
      `;
      tbody.appendChild(tr);
      group = []; startT = ""; counter++;
    }
  });

  bar.style.width = "100%";
  msg.innerText = "å®Œæˆï¼ç´ æå·²æŒ‰åŠ‡æœ¬é‚è¼¯åˆ†é…ã€‚";
}

async function exec(id, prompt) {
  const resp = await fetch(IMG_API, {
    method: "POST",
    headers: { "Content-Type":"application/json", "apikey":SUPA_KEY, "Authorization":"Bearer "+SUPA_KEY },
    body: JSON.stringify({ prompt: prompt, model: "imagen-3", size: "1536x1024" })
  });
  if(resp.ok) {
    const blob = await resp.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${id}.png`;
    a.click();
  }
}
</script>
</body>
</html>