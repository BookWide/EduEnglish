<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/><title>é‡ç”¢å°ˆå®¶ V13 - é¡åº¦èˆ‡å½±éŸ³å°é½Š</title>
<style>
  :root{ --bg:#0b1220; --panel:#0f1b33; --text:#e8eefc; --ok:#22c55e; --btn:#1f6feb; --line:#1b2b4b; }
  body{ background:var(--bg); color:var(--text); font-family: system-ui; padding:20px; }
  .card{ background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:20px; margin-bottom:20px; }
  .grid{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px; margin-bottom:15px; }
  input, select, textarea{ background:#000; border:1px solid var(--line); color:#22c55e; border-radius:8px; padding:10px; width:100%; }
  .prog-bg{ background:rgba(255,255,255,0.05); height:12px; border-radius:10px; margin:15px 0; overflow:hidden; border:1px solid var(--line); }
  .prog-bar{ background:var(--ok); width:0%; height:100%; transition:0.3s; }
  .stats{ font-size:12px; color:var(--ok); display:flex; justify-content:space-between; margin-bottom:5px; }
  .btn{ background:var(--btn); color:#fff; border:none; padding:12px; border-radius:10px; cursor:pointer; font-weight:bold; width:100%; }
  table{ width:100%; border-collapse:collapse; margin-top:20px; }
  th, td{ border:1px solid var(--line); padding:10px; font-size:13px; }
</style>
</head>
<body>

<div class="card">
  <h1>ğŸ¬ å½±éŸ³é‡ç”¢å·¥ä½œå° V13 (é¡åº¦ç›£æ§æ¨¡å¼)</h1>
  <div class="grid">
    <div><label>1. ä¸Šå‚³ SRT (åŠ  >> åˆä½µ)</label><input type="file" id="srtFile" /></div>
    <div><label>2. ä¸»è§’å®šè£ (é˜²è®Šäºº)</label>
      <select id="charLock">
        <option value="A tiny realistic brown field mouse">è€é¼  (Mouse)</option>
        <option value="A majestic African lion">ç…å­ (Lion)</option>
        <option value="Custom">è‡ªå®šç¾©...</option>
      </select>
    </div>
    <div><label>3. å½±ç‰‡æ‰¹æ¬¡ ID</label><input id="shortName" type="text" placeholder="å¦‚: 001_lion" /></div>
  </div>

  <div id="progUI" style="display:none;">
    <div class="stats">
      <span id="statMsg">æº–å‚™å°±ç·’</span>
      <span>é è¨ˆæ¶ˆè€—é¡åº¦: <b id="costEst">0</b> / 1000</span>
    </div>
    <div class="prog-bg"><div id="progBar" class="prog-bar"></div></div>
  </div>

  <button class="btn" style="background:var(--ok)" onclick="runV13()">åˆ†æåŠ‡æœ¬ä¸¦è¨ˆç®—é¡åº¦</button>
</div>

<table id="mainTable">
  <thead>
    <tr><th width="80">ID</th><th width="150">æ™‚é–“è»¸</th><th>å­—å¹• (MP3å…§å®¹)</th><th>ç”Ÿåœ–æŒ‡ä»¤ (å·²é–å®šè€é¼ )</th><th width="80">ç”¢å‡º</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
const IMG_API = "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/img-one";
const TTS_API = "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/tts-mp3";

async function runV13() {
  const file = document.getElementById('srtFile').files[0];
  if(!file) return alert("è«‹é¸ SRT");
  
  document.getElementById('progUI').style.display = 'block';
  const bar = document.getElementById('progBar');
  const msg = document.getElementById('statMsg');
  const cost = document.getElementById('costEst');

  const text = await file.text();
  const char = document.getElementById('charLock').value;
  const sname = document.getElementById('shortName').value || "vid";
  const items = text.trim().split(/\n\s*\n/).map(b => {
    const lines = b.split('\n');
    return { time: lines[1], text: lines.slice(2).join(" ").trim() };
  });

  const tbody = document.querySelector('#mainTable tbody');
  tbody.innerHTML = "";
  let group = [], startT = "", counter = 1;

  items.forEach((item, idx) => {
    const isMerging = item.text.includes(">>");
    const clean = item.text.replace(">>", "").trim();
    if(!startT) startT = item.time.split(" --> ")[0];
    group.push(clean);

    if(!isMerging || idx === items.length - 1) {
      const full = group.join(" ");
      const id = `${sname}_${String(counter).padStart(3, '0')}`;
      const prompt = `[Character: ${char}]. Realistic photography style. Action: ${full}. (Keep character as mouse, no human form)`;
      
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><b>${id}</b></td>
        <td>${startT}</td>
        <td><textarea rows="2" id="txt_${id}">${full}</textarea></td>
        <td><textarea rows="2" id="pmt_${id}">${prompt}</textarea></td>
        <td><button class="btn" style="padding:5px;font-size:11px;" onclick="genAll('${id}')">å½±éŸ³ç”Ÿæˆ</button></td>
      `;
      tbody.appendChild(tr);
      group = []; startT = ""; counter++;
    }
  });

  cost.innerText = counter - 1;
  bar.style.width = "100%";
  msg.innerText = "åŠ‡æœ¬è§£æå®Œç•¢ï¼Œå·²æŒ‰åŠ‡æƒ…å°é½Šã€‚";
}

async function genAll(id) {
  const t = document.getElementById('txt_'+id).value;
  const p = document.getElementById('pmt_'+id).value;
  
  // ç”Ÿ MP3
  fetch(TTS_API, {
    method:"POST", headers:{"apikey":SUPA_KEY,"Authorization":"Bearer "+SUPA_KEY,"Content-Type":"application/json"},
    body: JSON.stringify({text:t, voice:"en-US-GuyNeural"})
  }).then(r=>r.blob()).then(b=>{
    const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`${id}.mp3`; a.click();
  });

  // ç”Ÿåœ–
  fetch(IMG_API, {
    method:"POST", headers:{"apikey":SUPA_KEY,"Authorization":"Bearer "+SUPA_KEY,"Content-Type":"application/json"},
    body: JSON.stringify({prompt:p, model:"imagen-3", size:"1536x1024"})
  }).then(r=>r.blob()).then(b=>{
    const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`${id}.png`; a.click();
  });
}
</script>
</body>
</html>

