<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/><title>é‡ç”¢å°ˆå®¶ V45 - å·¥æ¥­ç´šç©©å®šç‰ˆ</title>
<style>
  :root{ --bg:#050a14; --panel:#111827; --text:#f3f4f6; --ok:#10b981; --btn:#3b82f6; --line:#374151; --done:#4b5563; }
  body{ background:var(--bg); color:var(--text); font-family: system-ui, sans-serif; padding:20px; }
  .card{ background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:25px; margin-bottom:20px; box-shadow: 0 8px 30px rgba(0,0,0,0.5); }
  .grid{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px; margin-bottom:15px; }
  label{ display:block; font-size:13px; color:#9ca3af; margin-bottom:8px; font-weight:bold; }
  textarea, select, input { width:100%; background:#000; border:1px solid var(--line); color:#22c55e; border-radius:10px; padding:12px; outline:none; font-size:14px; }
  .btn{ background:var(--btn); color:white; border:none; padding:15px; border-radius:10px; cursor:pointer; font-weight:bold; width:100%; transition: 0.2s; }
  .btn:disabled { opacity: 0.5; cursor: wait; }
  .btn.is-done { background:var(--done); }
  table{ width:100%; border-collapse:collapse; margin-top:20px; }
  th, td{ border:1px solid var(--line); padding:12px; text-align:left; vertical-align:top; }
  .lock-indicator { color:var(--ok); font-size:11px; margin-top:5px; font-weight: bold; }
</style>
</head>
<body onload="initApp()">

<div class="card">
  <h1 style="color:var(--btn); margin-top:0;">ğŸ¬ å½±éŸ³é‡ç”¢å·¥å»  V45 (å·¥æ¥­ç´šç©©å®šç‰ˆ)</h1>
  
  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
    <div>
      <label>1. ä¸»è§’æ ¸å¿ƒç‰¹å¾µ (CharSpec - å·²å¼·åŠ›é–å®š)</label>
      <textarea id="charSpec" rows="4" oninput="persist()" placeholder="è²¼å…¥è§’è‰²æ ¸å¿ƒç´°ç¯€..."></textarea>
      <div class="lock-indicator">âœ“ ç‰¹å¾µè¨˜æ†¶é–å®šä¸­</div>
    </div>
    <div>
      <label>2. åƒè€ƒåœ–ç‰‡ç¶²å€ (ImgRef - å·²å¼·åŠ›é–å®š)</label>
      <textarea id="imgRef" rows="4" oninput="persist()" placeholder="è²¼å…¥åƒè€ƒåœ–ç‰‡ç¶²å€..."></textarea>
      <div class="lock-indicator">âœ“ è¦–è¦ºåƒè€ƒé–å®šä¸­</div>
    </div>
  </div>

  <div class="grid">
    <div>
      <label>3. å½±ç‰‡é¢¨æ ¼å¤§é¡ (é–å®š)</label>
      <select id="vCategory" onchange="persist(); processSRT()">
        <option value="Epic cinematic historical film, 8k, detailed">1. å²è©©é›»å½± (ä¸‰åœ‹/å¤§ç‰‡)</option>
        <option value="Disney Pixar animation style, vivid colors">2. å¤¢å¹»ç«¥è©± (3D å¡é€š)</option>
        <option value="Classic ink wash painting, traditional artistic">3. æ°´å¢¨ç¹ªæœ¬ (å¤é¢¨è—è¡“)</option>
        <option value="Nature photography, realistic documentary style">4. è‡ªç„¶å¯«å¯¦ (å‹•ç‰©/å¯«å¯¦)</option>
        <option value="Atmospheric dark mystery, cinematic shadows">5. æš—é»‘å¯“è¨€ (ç¥ç¥•/å£“æŠ‘)</option>
      </select>
    </div>
    <div>
      <label>4. åˆä½µå¯†åº¦ (1/3/5/10 å¥é–å®š)</label>
      <select id="density" onchange="persist(); processSRT()">
        <option value="1">1 å¥ä¸€æ®µ</option>
        <option value="3">3 å¥ä¸€æ®µ</option>
        <option value="5" selected>5 å¥ä¸€æ®µ</option>
        <option value="10">10 å¥ä¸€æ®µ</option>
      </select>
    </div>
    <div>
      <label>5. è¼‰å…¥ Buzz SRT</label>
      <input type="file" id="srtFile" onchange="processSRT()" />
    </div>
  </div>
  <button class="btn" style="background:var(--ok);" onclick="processSRT()">âš¡ åŒæ­¥å…¨åŠŸèƒ½ä»»å‹™åˆ—è¡¨</button>
</div>

<table id="mainTable">
  <thead>
    <tr><th width="100">ä»»å‹™ ID</th><th>åŠ‡æƒ…åŠ‡æœ¬ (MP3)</th><th>è¦–è¦ºæŒ‡ä»¤ (PNG)</th><th width="120">åŸ·è¡Œç‹€æ…‹</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
const IMG_API = "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/img-one";
const TTS_API = "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/tts-mp3";

function initApp() {
  const keys = ['charSpec', 'imgRef', 'vCategory', 'density'];
  keys.forEach(k => {
    const val = localStorage.getItem('v45_' + k);
    if(val) document.getElementById(k).value = val;
  });
}

function persist() {
  const keys = ['charSpec', 'imgRef', 'vCategory', 'density'];
  keys.forEach(k => {
    localStorage.setItem('v45_' + k, document.getElementById(k).value);
  });
}

async function processSRT() {
  const file = document.getElementById('srtFile').files[0];
  if(!file) return;
  const rawText = await file.text();
  const char = document.getElementById('charSpec').value;
  const ref = document.getElementById('imgRef').value;
  const style = document.getElementById('vCategory').value;
  const step = parseInt(document.getElementById('density').value);
  
  const regex = /(\d+)\s+(\d{2}:\d{2}:\d{2},\d{3} --> \d{2}:\d{2}:\d{2},\d{3})\s+([\s\S]*?)(?=\n\d+\s+\d{2}:\d{2}:\d{2},\d{3} -->|$)/g;
  let match, srtData = [];
  while ((match = regex.exec(rawText)) !== null) {
    srtData.push(match[3].trim().replace(/\r?\n/g, " "));
  }

  const tbody = document.querySelector('#mainTable tbody');
  tbody.innerHTML = "";
  for (let i = 0; i < srtData.length; i += step) {
    const chunk = srtData.slice(i, i + step);
    const fullText = chunk.join(" ");
    const id = `Task_${String(Math.floor(i/step)+1).padStart(3, '0')}`;
    let prompt = `${ref ? '[Image Reference: '+ref+'] ' : ''}Action/Scene: [${fullText}]. Style: ${style}. Character: (${char}).`;
    tbody.innerHTML += `
      <tr id="row_${id}">
        <td><b>${id}</b></td>
        <td><textarea rows="2" id="t_${id}">${fullText}</textarea></td>
        <td><textarea rows="2" id="p_${id}">${prompt}</textarea></td>
        <td><button class="btn" id="b_${id}" onclick="executeTask('${id}')">ä¸€éµç”¢å‡º</button></td>
      </tr>`;
  }
}

async function executeTask(id) {
  const t = document.getElementById('t_'+id).value;
  const p = document.getElementById('p_'+id).value;
  const btn = document.getElementById('b_'+id);
  
  const originalText = btn.innerText;
  btn.innerText = "â³ ä¸‹è¼‰ä¸­...";
  btn.disabled = true;

  try {
    // 1. åŒæ­¥è«‹æ±‚èªéŸ³èˆ‡åœ–ç‰‡ï¼Œä½†åš´æ ¼ç­‰å¾…è¿”å›
    const [ttsRes, imgRes] = await Promise.all([
      fetch(TTS_API, {
        method: "POST",
        headers: { "Content-Type":"application/json", "apikey":SUPA_KEY, "Authorization":"Bearer "+SUPA_KEY },
        body: JSON.stringify({ text: t, voice: "en-US-GuyNeural" })
      }),
      fetch(IMG_API, {
        method: "POST",
        headers: { "Content-Type":"application/json", "apikey":SUPA_KEY, "Authorization":"Bearer "+SUPA_KEY },
        body: JSON.stringify({ prompt: p, model: "imagen-3", size: "1536x1024" })
      })
    ]);

    const ttsBlob = await ttsRes.blob();
    const imgBlob = await imgRes.blob();

    // å¼·åˆ¶æª¢æŸ¥åœ–ç‰‡æ•¸æ“šæ˜¯å¦å®Œæ•´ (Imagen-3 åœ–ç‰‡é€šå¸¸å¤§æ–¼ 500KB)
    if (imgBlob.size < 10000) {
      throw new Error("åœ–ç‰‡æ•¸æ“šæ¥æ”¶ä¸å®Œæ•´ï¼Œè«‹é‡è©¦ã€‚");
    }

    // è§¸ç™¼ä¸‹è¼‰
    saveBlob(ttsBlob, `${id}.mp3`);
    saveBlob(imgBlob, `${id}.png`);

    btn.innerText = "âœ“ å·²å®Œæˆ";
    btn.classList.add('is-done');
  } catch (err) {
    alert("ä»»å‹™ " + id + " å¤±æ•—: " + err.message);
    btn.innerText = "âŒ é‡è©¦";
    btn.disabled = false;
  }
}

function saveBlob(blob, fileName) {
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  setTimeout(() => {
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
  }, 200);
}
</script>
</body>
</html>








