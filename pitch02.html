<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/><title>é‡ç”¢å°ˆå®¶ V30 - è‡ªå‹•åŠ‡æƒ…åˆ†çµ„æ——è‰¦ç‰ˆ</title>
<style>
  :root{ --bg:#050a14; --panel:#0f172a; --text:#f1f5f9; --ok:#10b981; --btn:#3b82f6; --line:#1e293b; --done:#334155; }
  body{ background:var(--bg); color:var(--text); font-family: system-ui; padding:20px; line-height:1.5; }
  .card{ background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:20px; margin-bottom:20px; box-shadow:0 8px 32px rgba(0,0,0,0.5); }
  .grid{ display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:12px; margin-bottom:15px; }
  label{ display:block; font-size:12px; color:#94a3b8; margin-bottom:5px; }
  input, select, textarea{ width:100%; background:#000; border:1px solid var(--line); color:#22c55e; border-radius:10px; padding:10px; font-size:14px; outline:none; }
  .btn{ background:var(--btn); color:white; border:none; padding:12px; border-radius:10px; cursor:pointer; font-weight:bold; transition:0.2s; }
  .btn.is-done { background:var(--done); color:#94a3b8; }
  .btn.is-done::after { content: " (å·²å­˜)"; }
  table{ width:100%; border-collapse:collapse; margin-top:20px; }
  th, td{ border:1px solid var(--line); padding:10px; text-align:left; vertical-align:top; }
  tr.is-done { opacity: 0.4; background: rgba(0,0,0,0.2); }
  .batch-badge { background:#f59e0b; color:#000; font-size:10px; padding:2px 6px; border-radius:4px; font-weight:bold; }
  #statusInfo { color:var(--ok); font-weight:bold; margin:10px 0; }
</style>
</head>
<body>

<div class="card">
  <h1>ğŸ¬ é‡ç”¢å·¥å»  V30 (è‡ªå‹•åˆ†çµ„ & åŠ‡æƒ…é–å®š)</h1>
  <div class="grid">
    <div>
      <label>1. å½±ç‰‡åŠ‡æƒ…å¤§é¡</label>
      <select id="vStyle" onchange="reProcess()">
        <option value="Cinematic realistic photography, 8k, natural lighting">å¯«å¯¦é›»å½±é¢¨æ ¼</option>
        <option value="3D animation, Pixar style, vivid colors">3D å‹•ç•«é¢¨æ ¼</option>
        <option value="Classic oil painting, storybook illustration">ç¹ªæœ¬æ•…äº‹é¢¨æ ¼</option>
      </select>
    </div>
    <div>
      <label>2. ä¸»è§’ç´°ç¯€æè¿° (é˜²è®Šäººæ ¸å¿ƒ)</label>
      <input id="charSpec" type="text" placeholder="ä¾‹ï¼šA realistic brown mouse (No human)" oninput="reProcess()"/>
    </div>
    <div>
      <label>3. åŠ‡æƒ…åˆä½µå¯†åº¦ (åŠŸèƒ½é–‹é—œ)</label>
      <select id="autoMergeCount" onchange="reProcess()">
        <option value="1">1 å¥ä¸€åœ– (ä¸åˆä½µ)</option>
        <option value="3">3 å¥ä¸€æ®µ (é€£è²«)</option>
        <option value="5" selected>5 å¥ä¸€æ®µ (çœéŒ¢é‡ç”¢)</option>
        <option value="10">10 å¥ä¸€æ®µ (æ¥µé€Ÿ)</option>
      </select>
    </div>
    <div>
      <label>4. è®€å– Buzz SRT</label>
      <input type="file" id="srtInput" onchange="reProcess()" />
    </div>
  </div>
  <div id="statusInfo">è«‹å…ˆä¸Šå‚³ SRT æª”æ¡ˆ...</div>
</div>

<table id="mainTable">
  <thead>
    <tr><th width="100">ä»»å‹™ ID</th><th width="120">æ™‚é–“è»¸</th><th>åˆä½µåŠ‡æœ¬ (MP3)</th><th>è¦–è¦ºæŒ‡ä»¤ (PNG)</th><th width="120">æ“ä½œ</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
const IMG_API = "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/img-one";
const TTS_API = "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/tts-mp3";

let allSentences = [];

async function reProcess() {
  const file = document.getElementById('srtInput').files[0];
  if(!file) return;

  // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ä¸Šå‚³ï¼Œè®€å–å…§å®¹ï¼›å¦å‰‡ä½¿ç”¨ç·©å­˜
  if (allSentences.length === 0 || document.getElementById('srtInput').dataset.changed === "true") {
    const rawText = await file.text();
    const regex = /(\d+)\s+(\d{2}:\d{2}:\d{2},\d{3} --> \d{2}:\d{2}:\d{2},\d{3})\s+([\s\S]*?)(?=\n\d+\s+\d{2}:\d{2}:\d{2},\d{3} -->|$)/g;
    let match;
    allSentences = [];
    while ((match = regex.exec(rawText)) !== null) {
      allSentences.push({ time: match[2], text: match[3].trim().replace(/\r?\n/g, " ") });
    }
  }

  const style = document.getElementById('vStyle').value;
  const char = document.getElementById('charSpec').value || "the protagonist";
  const mergeNum = parseInt(document.getElementById('autoMergeCount').value);
  const tbody = document.querySelector('#mainTable tbody');
  tbody.innerHTML = "";

  // æ ¹æ“šé¸æ“‡çš„ 3/5/10 é€²è¡Œè‡ªå‹•å¾ªç’°åˆä½µ
  for (let i = 0; i < allSentences.length; i += mergeNum) {
    const chunk = allSentences.slice(i, i + mergeNum);
    const fullTxt = chunk.map(c => c.text).join(" ");
    const startTime = chunk[0].time.split(' --> ')[0];
    const taskId = `P_${String(Math.floor(i/mergeNum)+1).padStart(3, '0')}`;
    
    // å°‡ã€Œå¤§é¡ã€ã€ã€Œä¸»è§’æè¿°ã€èˆ‡ã€ŒåŠ‡æƒ…ã€é–å®šåœ¨ä¸€èµ·
    const prompt = `Style: ${style}. Character: ${char}. Scene: ${fullTxt}. (Strictly maintain subject as ${char}, No humans)`;

    const tr = document.createElement('tr');
    tr.id = `row_${taskId}`;
    tr.innerHTML = `
      <td><b>${taskId}</b><br><span class="batch-badge">${chunk.length} å¥åˆä¸€</span></td>
      <td><small>${startTime}</small></td>
      <td><textarea rows="3" id="t_${taskId}">${fullTxt}</textarea></td>
      <td><textarea rows="3" id="p_${taskId}">${prompt}</textarea></td>
      <td><button class="btn" id="b_${taskId}" onclick="genTask('${taskId}')">ä¸€éµç”¢å‡º</button></td>
    `;
    tbody.appendChild(tr);
  }
  document.getElementById('statusInfo').innerText = `ğŸ“Š åˆ†çµ„æ¨¡å¼: æ¯ ${mergeNum} å¥ä¸€æ®µ | ç¸½è¨ˆ: ${Math.ceil(allSentences.length/mergeNum)} çµ„ä»»å‹™`;
}

async function genTask(id) {
  const t = document.getElementById('t_'+id).value;
  const p = document.getElementById('p_'+id).value;
  const btn = document.getElementById('b_'+id);
  const row = document.getElementById('row_'+id);

  [TTS_API, IMG_API].forEach((api, i) => {
    fetch(api, {
      method: "POST",
      headers: { "Content-Type":"application/json", "apikey":SUPA_KEY, "Authorization":"Bearer "+SUPA_KEY },
      body: JSON.stringify(i === 0 ? { text: t, voice: "en-US-GuyNeural" } : { prompt: p, model: "imagen-3", size: "1536x1024" })
    }).then(r => r.blob()).then(blob => {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = i === 0 ? `${id}.mp3` : `${id}.png`;
      a.click();
      btn.classList.add('is-done'); row.classList.add('is-done');
    });
  });
}
</script>
</body>
</html>



