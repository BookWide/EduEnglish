<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/><title>é‡ç”¢å°ˆå®¶ V26 - å¼·åŠ›è§£æèˆ‡åŠ‡æƒ…é–å®š</title>
<style>
  :root{ --bg:#050a14; --panel:#0f172a; --text:#f1f5f9; --ok:#10b981; --btn:#3b82f6; --line:#1e293b; --done:#334155; }
  body{ background:var(--bg); color:var(--text); font-family: system-ui; padding:20px; margin:0; }
  .card{ background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:20px; margin-bottom:20px; box-shadow:0 8px 32px rgba(0,0,0,0.5); }
  .grid{ display:grid; grid-template-columns: 1fr 1fr 1fr 0.8fr; gap:12px; margin-bottom:15px; }
  input, select, textarea{ width:100%; background:#000; border:1px solid var(--line); color:#22c55e; border-radius:10px; padding:12px; font-size:14px; outline:none; }
  
  /* é€²åº¦å„€è¡¨ */
  .monitor { background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center; }
  .prog-bg { flex:1; background:rgba(255,255,255,0.1); height:12px; border-radius:6px; margin:0 15px; overflow:hidden; }
  .prog-bar { background:var(--ok); height:100%; width:0%; transition:0.3s; }
  
  .btn{ background:var(--btn); color:white; border:none; padding:12px; border-radius:10px; cursor:pointer; font-weight:bold; transition: 0.2s; }
  .btn.is-done { background:var(--done); color:#94a3b8; }
  .btn.is-done::after { content: " (å·²å­˜)"; }

  table{ width:100%; border-collapse:collapse; margin-top:20px; }
  th, td{ border:1px solid var(--line); padding:12px; text-align:left; vertical-align:top; }
  th { background:rgba(255,255,255,0.05); color:#94a3b8; font-size:12px; }
  tr.is-done { opacity: 0.4; background: rgba(0,0,0,0.2); }
  .tag { background:var(--ok); color:#000; font-size:10px; padding:2px 6px; border-radius:4px; font-weight:bold; }
</style>
</head>
<body>

<div class="card">
  <h1>ğŸ¬ é‡ç”¢å·¥å»  V26 (åŠ‡æƒ…æ·±åº¦è¾¨è­˜ç‰ˆ)</h1>
  <div class="grid">
    <div>
      <label style="font-size:12px;color:#94a3b8;">1. å½±ç‰‡å¤§é¡ (è®“ AI çŸ¥é“åŠ‡æƒ…æ°›åœ)</label>
      <select id="vType">
        <option value="Nature documentary, cinematic, realistic animals">å‹•ç‰©åŠ‡æƒ… (å¯«å¯¦è‡ªç„¶)</option>
        <option value="Disney 3D animation, bright and cute">ç«¥è©±åŠ‡æƒ… (3D å¡é€š)</option>
        <option value="Classic oil painting illustration">å¯“è¨€åŠ‡æƒ… (ç¹ªæœ¬é¢¨æ ¼)</option>
      </select>
    </div>
    <div>
      <label style="font-size:12px;color:#94a3b8;">2. ä¸»è§’ç´°ç¯€é–å®š (é˜²æ­¢è®Šäºº)</label>
      <input id="charSpec" type="text" placeholder="ä¾‹ï¼šA small brown mouse, realistic ears"/>
    </div>
    <div>
      <label style="font-size:12px;color:#94a3b8;">3. å½±ç‰‡æ‰¹æ¬¡ ID</label>
      <input id="vidId" type="text" placeholder="Ep001"/>
    </div>
    <div>
      <label style="font-size:12px;color:#94a3b8;">4. è¼‰å…¥åŠ‡æœ¬</label>
      <input type="file" id="srtFile" />
    </div>
  </div>
  <button class="btn" style="background:var(--ok); width:100%;" onclick="runForceParser()">è§£æå…¨éƒ¨åŠ‡æœ¬ä¸¦å»ºç«‹ä»»å‹™</button>
</div>

<div class="monitor" id="monUI" style="display:none;">
  <div id="statText" style="color:var(--ok); font-weight:bold; min-width:140px;">é€²åº¦ï¼š0 / 0</div>
  <div class="prog-bg"><div id="pBar" class="prog-bar"></div></div>
  <div style="font-size:12px; color:#94a3b8;">* ç‹€æ…‹è¨˜éŒ„ï¼šæŒ‰éˆ•è®Šç°å³ä»£è¡¨ PNG/MP3 å·²ç”¢å‡º</div>
</div>

<table id="mainTable">
  <thead>
    <tr><th width="100">ä»»å‹™</th><th width="120">æ™‚é–“é»</th><th>åŠ‡æœ¬å…§å®¹ (MP3)</th><th>è¦–è¦ºæŒ‡ä»¤ (Imagen 3)</th><th width="130">ä¸€éµä¸‹è¼‰</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
const IMG_API = "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/img-one";
const TTS_API = "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/tts-mp3";

async function runForceParser() {
  const file = document.getElementById('srtFile').files[0];
  if(!file) return alert("è«‹å…ˆé¸æ“‡ SRT æª”æ¡ˆ");
  
  const rawText = await file.text();
  const style = document.getElementById('vType').value;
  const char = document.getElementById('charSpec').value || "subject";
  const bid = document.getElementById('vidId').value || "V";

  // å¼·åŠ›è§£æé‚è¼¯ï¼šä¸è«–æ›è¡Œç¬¦è™Ÿï¼Œæš´åŠ›åˆ†å‰²
  const blocks = rawText.trim().split(/\n\s*\n|\r\n\s*\r\n/).filter(b => b.includes('-->'));
  
  const tbody = document.querySelector('#mainTable tbody');
  tbody.innerHTML = "";
  document.getElementById('monUI').style.display = 'flex';

  let group = [], startT = "", counter = 1;

  blocks.forEach((block, idx) => {
    const lines = block.split(/\n|\r\n/).map(l => l.trim()).filter(l => l !== "");
    if(lines.length < 3) return;

    const timeLine = lines[1];
    const textLines = lines.slice(2).join(" ");
    const isMerging = textLines.includes(">>");
    const cleanText = textLines.replace(">>", "").trim();

    if(!startT) startT = timeLine.split(" --> ")[0];
    group.push(cleanText);

    // æ¯é‡åˆ°æ²’æœ‰ >> çš„å¥å­ï¼Œæˆ–æ˜¯æœ€å¾Œä¸€å¥ï¼Œå°±æ‰“åŒ…æˆä¸€å€‹ä»»å‹™
    if(!isMerging || idx === blocks.length - 1) {
      const fullTxt = group.join(" ");
      const id = `${bid}_${String(counter).padStart(3, '0')}`;
      
      // åŠ‡æƒ…è¾¨è­˜æŒ‡ä»¤çµæ§‹
      const prompt = `Category: ${style}. Subject: ${char}. Action: ${fullTxt}. (Strict: Animals remain animals, No humans, No prince clothes)`;

      const tr = document.createElement('tr');
      tr.id = `r_${id}`;
      tr.innerHTML = `
        <td><b>${id}</b><br>${group.length > 1 ? '<span class="tag">æ‰¹æ¬¡åˆä½µ</span>' : ''}</td>
        <td><small>${startT}</small></td>
        <td><textarea id="t_${id}" rows="3">${fullTxt}</textarea></td>
        <td><textarea id="p_${id}" rows="3">${prompt}</textarea></td>
        <td><button class="btn" id="b_${id}" onclick="genPair('${id}')">å½±éŸ³ç”¢å‡º</button></td>
      `;
      tbody.appendChild(tr);
      group = []; startT = ""; counter++;
    }
  });
  updateProg();
}

async function genPair(id) {
  const txt = document.getElementById('t_'+id).value;
  const pmt = document.getElementById('p_'+id).value;
  const btn = document.getElementById('b_'+id);
  const row = document.getElementById('r_'+id);

  [TTS_API, IMG_API].forEach((api, i) => {
    fetch(api, {
      method: "POST",
      headers: { "Content-Type":"application/json", "apikey":SUPA_KEY, "Authorization":"Bearer "+SUPA_KEY },
      body: JSON.stringify(i === 0 ? { text: txt, voice: "en-US-GuyNeural" } : { prompt: pmt, model: "imagen-3



