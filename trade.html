<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>交易說明｜BookWide</title>
  <meta name="description" content="BookWide 訂閱方案、付款方式、續訂、取消與退費、客服聯絡等交易相關說明。" />
  <style>
    :root{
      --bg:#ffffff; --ink:#111827; --muted:#6b7280; --line:#e5e7eb; --soft:#f8fafc;
      --brand:#2563eb; --shadow:0 10px 24px rgba(15,23,42,.06); --radius:14px;
      --ok:#16a34a; --bad:#b91c1c;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",Helvetica,Arial;background:var(--bg);color:var(--ink)}
    a{color:var(--brand);text-decoration:none} a:hover{text-decoration:underline}
    .wrap{max-width:980px;margin:0 auto;padding:28px 18px 90px}
    header{border-bottom:1px solid var(--line);padding-bottom:18px;margin-bottom:18px}
    h1{margin:0 0 8px;font-size:24px;font-weight:900} header p{margin:0;color:var(--muted);line-height:1.8}
    nav.toc{background:var(--soft);border:1px solid var(--line);border-radius:var(--radius);padding:14px;margin:14px 0 20px}
    nav.toc b{display:block;margin-bottom:8px} nav.toc a{margin-right:12px;font-size:14px;display:inline-block;margin-bottom:6px}
    section{border:1px solid var(--line);border-radius:var(--radius);background:#fff;box-shadow:var(--shadow);padding:16px;margin-bottom:14px}
    section h2{margin:0 0 10px;font-size:16px;font-weight:900}
    .sub{color:var(--muted);margin:0 0 12px;line-height:1.8}
    ul{margin:0;padding-left:18px;line-height:1.9} li{margin:6px 0}
    .note{margin-top:12px;padding:12px;border:1px dashed #c7d2fe;border-radius:12px;background:#f8fbff;line-height:1.8}
    .cta{height:40px;padding:0 16px;border-radius:12px;border:1px solid var(--brand);background:var(--brand);color:#fff;font-weight:900;cursor:pointer;box-shadow:0 10px 20px rgba(37,99,235,.18)}
    .cta:hover{filter:brightness(.95)} .cta:disabled{opacity:.6;cursor:not-allowed}
    .cta.ghost{background:#fff;color:var(--brand);border-color:var(--line);box-shadow:none}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;z-index:9999}
    .modal.on{display:block}
    .backdrop{position:absolute;inset:0;background:rgba(15,23,42,.45)}
    .panel{position:relative;width:min(780px,calc(100% - 28px));margin:7vh auto;background:#fff;border-radius:16px;border:1px solid var(--line);box-shadow:0 30px 80px rgba(15,23,42,.25);overflow:hidden}
    .head{padding:16px;border-bottom:1px solid var(--line);background:#fbfbfb;display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
    .head h3{margin:0;font-size:16px;font-weight:900}
    .head .muted{margin-top:4px;font-size:13px;color:var(--muted);line-height:1.6}
    .close{width:34px;height:34px;border-radius:10px;border:1px solid var(--line);background:#fff;font-size:20px;cursor:pointer;flex:0 0 auto}
    form{padding:16px}
    .row{margin-bottom:12px}
    label{display:block;font-size:13px;font-weight:800;margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);font-size:14px;outline:none}
    input:focus,select:focus,textarea:focus{border-color:#c7d2fe;box-shadow:0 0 0 4px rgba(99,102,241,.12)}
    textarea{resize:vertical}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:720px){.grid2{grid-template-columns:1fr}}
    .actions{display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap}
    .hint{margin-top:10px;font-size:13px;line-height:1.7;white-space:pre-wrap;word-break:break-word}
    .hint.ok{color:var(--ok);font-weight:900}
    .hint.bad{color:var(--bad);font-weight:900}
    footer{margin-top:16px;color:var(--muted);font-size:12px;text-align:right}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>交易說明</h1>
    <p>本頁說明 BookWide 的訂閱方案、付款方式、續訂、取消與退費，以及客服聯絡方式。</p>
  </header>

  <nav class="toc">
    <b>快速導覽</b>
    <a href="#plans">訂閱方案</a>
    <a href="#payment">付款方式</a>
    <a href="#renew">續訂與扣款</a>
    <a href="#refund">取消與退費</a>
    <a href="#support">客服聯絡</a>
  </nav>

  <section id="plans">
    <h2>訂閱方案</h2>
    <p class="sub">BookWide 採訂閱制服務，實際方案與價格以 <a href="/pricing.html">方案頁</a> 顯示為準。</p>
    <ul>
      <li>訂閱期間內可使用已開放的學習內容與功能。</li>
      <li>部分功能可能依方案或裝置/瀏覽器支援有所差異。</li>
    </ul>
  </section>

  <section id="payment">
    <h2>付款方式</h2>
    <p class="sub">實際可用的付款方式以結帳頁面顯示為準。</p>
    <ul>
      <li>信用卡／簽帳卡</li>
      <li>第三方金流（依地區提供）</li>
    </ul>
  </section>

  <section id="renew">
    <h2>續訂與扣款</h2>
    <ul>
      <li>部分方案為自動續訂，將於到期時扣款。</li>
      <li>若扣款失敗，訂閱可能暫停，重新付款即可恢復。</li>
    </ul>
  </section>

  <section id="refund">
    <h2>取消與退費</h2>
    <p class="sub">退費將依購買方案、付款方式與實際使用情況評估。</p>

    <div class="note">
      <b>退費申請入口</b><br/>
      請點擊下方按鈕填寫退費申請。送出後會建立申請紀錄，並通知管理員（Email）。
      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="cta" id="openRefund" type="button">提出退費申請</button>
        <button class="cta ghost" id="testConn" type="button">測試連線</button>
      </div>
      <div class="hint" style="margin-top:8px;">
        ※ 本申請寫入 Supabase：<b>refund_requests</b>，並呼叫 Edge Function：<b>refund-notify</b>
      </div>
    </div>
  </section>

  <section id="support">
    <h2>客服聯絡</h2>
    <ul>
      <li>請提供：帳號 Email、訂單號、付款方式、問題描述。</li>
      <li>Email：support@bookwide.net（可自行替換）</li>
    </ul>
  </section>

  <footer>BookWide · trade.html · v20251216-2</footer>
</div>

<!-- Modal -->
<div class="modal" id="refundModal" aria-hidden="true">
  <div class="backdrop" id="backdropRefund"></div>
  <div class="panel" role="dialog" aria-modal="true" aria-labelledby="refundTitle">
    <div class="head">
      <div>
        <h3 id="refundTitle">退費申請表</h3>
        <div class="muted">送出後：先寫入 <b>refund_requests</b>，再呼叫 <b>refund-notify</b> 寄信通知管理員。</div>
      </div>
      <button class="close" id="closeRefund" aria-label="關閉">×</button>
    </div>

    <form id="refundForm" autocomplete="on">
      <div class="row">
        <label>Email *</label>
        <input required type="email" name="email" placeholder="例如：yourname@gmail.com">
      </div>

      <div class="row">
        <label>訂單號（若有）</label>
        <input name="order_no" placeholder="例如：BW-2025xxxx">
      </div>

      <div class="row grid2">
        <div>
          <label>付款方式 *</label>
          <select required name="pay_method">
            <option value="">請選擇</option>
            <option>信用卡</option>
            <option>ATM</option>
            <option>第三方金流</option>
            <option>其他</option>
          </select>
        </div>
        <div>
          <label>付款日期（大概即可）</label>
          <input type="date" name="pay_date">
        </div>
      </div>

      <div class="row">
        <label>退費原因 *</label>
        <textarea required name="reason" rows="4" placeholder="例如：重複訂閱 / 無法使用 / 內容不符合期待..."></textarea>
      </div>

      <div class="row">
        <label>聯絡方式（手機或 LINE ID）</label>
        <input name="contact" placeholder="例如：09xx-xxx-xxx / LINE：xxxx">
      </div>

      <div class="row">
        <label>補充說明（可貼錯誤訊息/截圖連結）</label>
        <textarea name="extra" rows="3" placeholder="可貼上你看到的錯誤文字或圖片連結"></textarea>
      </div>

      <div class="actions">
        <button type="button" class="cta ghost" id="cancelRefund">取消</button>
        <button type="submit" class="cta" id="submitRefund">送出申請</button>
      </div>

      <div class="hint" id="refundHint"></div>
    </form>
  </div>
</div>

<script>
  // ===== Supabase (REST + Function Invoke) =====
  const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do"; // ←換成你那串 ANON KEY
  const TABLE = "refund_requests";
  const FUNCTION_NAME = "refund-notify";
  const FUNCTION_URL = `${SUPABASE_URL}/functions/v1/${FUNCTION_NAME}`;

  const modal = document.getElementById('refundModal');
  const btnOpen = document.getElementById('openRefund');
  const btnClose = document.getElementById('closeRefund');
  const btnCancel = document.getElementById('cancelRefund');
  const backdrop = document.getElementById('backdropRefund');

  const form = document.getElementById('refundForm');
  const hint = document.getElementById('refundHint');
  const btnSubmit = document.getElementById('submitRefund');
  const btnTest = document.getElementById('testConn');

  function openModal(){
    modal.classList.add('on');
    modal.setAttribute('aria-hidden','false');
    hint.textContent = '';
    hint.className = 'hint';
    setTimeout(()=> form.querySelector('input[name="email"]')?.focus(), 80);
  }
  function closeModal(){
    modal.classList.remove('on');
    modal.setAttribute('aria-hidden','true');
  }
  btnOpen?.addEventListener('click', openModal);
  btnClose?.addEventListener('click', closeModal);
  btnCancel?.addEventListener('click', closeModal);
  backdrop?.addEventListener('click', closeModal);
  document.addEventListener('keydown', (e)=> {
    if(e.key === 'Escape' && modal.classList.contains('on')) closeModal();
  });

  function showHint(msg, ok=false){
    hint.textContent = msg;
    hint.className = ok ? 'hint ok' : 'hint bad';
  }

  // 把任何 JS 錯誤直接顯示在表單底部（你就不會再遇到「沒反應」）
  window.addEventListener('error', (e)=>{
    try{ showHint("❌ JS 錯誤：\n" + (e.message || String(e.error||e))); }catch(_){}
  });
  window.addEventListener('unhandledrejection', (e)=>{
    try{ showHint("❌ Promise 錯誤：\n" + (e.reason?.message || String(e.reason||e))); }catch(_){}
  });

  function fetchWithTimeout(url, options, ms=12000){
    return new Promise((resolve, reject)=>{
      const t = setTimeout(()=>reject(new Error("Request timeout (12s)")), ms);
      fetch(url, options).then((r)=>{clearTimeout(t); resolve(r);}).catch((e)=>{clearTimeout(t); reject(e);});
    });
  }

  function keyOk(){
    return SUPABASE_ANON_KEY && !SUPABASE_ANON_KEY.includes("REPLACE_WITH_YOUR_ANON_KEY");
  }

  async function restInsert(payload){
    const url = `${SUPABASE_URL}/rest/v1/${TABLE}?select=id,created_at`;
    const res = await fetchWithTimeout(url, {
      method: "POST",
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
        "Content-Type": "application/json",
        Prefer: "return=representation"
      },
      body: JSON.stringify(payload)
    });
    const txt = await res.text();
    console.log("[trade] insert", res.status, res.statusText, txt);
    if(!res.ok) throw new Error(`INSERT HTTP ${res.status} ${res.statusText}\n${txt}`);
    const json = txt ? JSON.parse(txt) : null;
    return Array.isArray(json) ? json[0] : json;
  }

  async function callNotify(payload){
    const res = await fetchWithTimeout(FUNCTION_URL, {
      method: "POST",
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload)
    });
    const txt = await res.text();
    console.log("[trade] notify", res.status, res.statusText, txt);
    if(!res.ok) throw new Error(`NOTIFY HTTP ${res.status} ${res.statusText}\n${txt}`);
    return txt ? JSON.parse(txt) : null;
  }

  // 重要：有些瀏覽器/外掛會吃掉 submit，這裡強制把按鈕 click 導到 requestSubmit()
  btnSubmit?.addEventListener('click', ()=>{
    try{ form.requestSubmit(); }catch(_e){}
  });

  // 測試：一定會打出 Network（你可以立刻看到是不是被擋）
  btnTest?.addEventListener('click', async ()=>{
    if(!keyOk()){
      alert("你還沒把 SUPABASE_ANON_KEY 換成真的那串，先換再測。");
      return;
    }
    try{
      showHint("測試中…（請看 Network → Fetch/XHR）");
      // 1) 測 INSERT 但不真的寫入：OPTIONS 預檢（看 CORS/blocked）
      await fetchWithTimeout(`${SUPABASE_URL}/rest/v1/${TABLE}`, {
        method:"OPTIONS",
        mode:"cors"
      }, 8000).catch(()=>{});
      // 2) 測 function ping（如果 function 需要 auth/被擋，會回 401/500）
      const res = await fetchWithTimeout(FUNCTION_URL, {
        method:"POST",
        headers:{
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
          "Content-Type":"application/json"
        },
        body: JSON.stringify({ ping:true })
      }, 12000);
      const txt = await res.text();
      console.log("[trade] test notify", res.status, txt);
      showHint("✅ 測試完成：refund-notify 回應\nHTTP " + res.status + "\n" + txt, res.ok);
    }catch(err){
      showHint("❌ 測試失敗：\n" + (err?.message || String(err)));
    }
  });

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();

    if(!keyOk()){
      showHint("❌ 你還沒把 SUPABASE_ANON_KEY 換成真的那串（目前是佔位字串）。");
      return;
    }

    btnSubmit.disabled = true;
    hint.textContent = "送出中…（請看 Network → Fetch/XHR）";
    hint.className = "hint";

    try{
      const fd = new FormData(form);
      const data = Object.fromEntries(fd.entries());

      const payload = {
        email: (data.email || '').trim(),
        order_no: (data.order_no || '').trim() || null,
        pay_method: (data.pay_method || '').trim(),
        pay_date: (data.pay_date || '').trim() || null,
        reason: (data.reason || '').trim(),
        contact: (data.contact || '').trim() || null,
        extra: (data.extra || '').trim() || null,
        page_url: location.href,
        user_agent: navigator.userAgent
      };

      // 1) 寫入 Supabase
      const row = await restInsert(payload);

      // 2) 寄信通知（Edge Function）
      await callNotify({
        id: row?.id,
        created_at: row?.created_at,
        email: payload.email,
        order_no: payload.order_no,
        pay_method: payload.pay_method,
        reason: payload.reason,
        contact: payload.contact,
        extra: payload.extra,
        page_url: payload.page_url,
        user_agent: payload.user_agent
      });

      showHint("✅ 已送出申請（已建立紀錄並通知管理員）。", true);
      form.reset();
      setTimeout(closeModal, 700);

    }catch(err){
      console.error(err);
      showHint("❌ 送出失敗：\n" + (err?.message || String(err)));
    }finally{
      btnSubmit.disabled = false;
    }
  });
</script>

<script src="/shared/footer.js"></script>
</body>
</html>
















