<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>交易說明｜BookWide</title>
  <meta name="description" content="BookWide 訂閱方案、付款方式、續訂、取消與退費、客服聯絡等交易相關說明。" />
  <style>
    :root{
      --bg:#ffffff; --ink:#111827; --muted:#6b7280; --line:#e5e7eb; --soft:#f8fafc;
      --brand:#2563eb; --shadow:0 10px 24px rgba(15,23,42,.06); --radius:14px;
      --ok:#16a34a; --bad:#b91c1c;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",Helvetica,Arial;background:var(--bg);color:var(--ink)}
    a{color:var(--brand);text-decoration:none} a:hover{text-decoration:underline}
    .wrap{max-width:980px;margin:0 auto;padding:28px 18px 90px}
    header{border-bottom:1px solid var(--line);padding-bottom:18px;margin-bottom:18px}
    h1{margin:0 0 8px;font-size:22px;font-weight:900} header p{margin:0;color:var(--muted);line-height:1.8}
    nav.toc{background:var(--soft);border:1px solid var(--line);border-radius:var(--radius);padding:14px;margin-bottom:20px}
    nav.toc b{display:block;margin-bottom:8px} nav.toc a{margin-right:12px;font-size:14px}
    section{border:1px solid var(--line);border-radius:var(--radius);background:#fff;box-shadow:var(--shadow);padding:16px;margin-bottom:14px}
    section h2{margin:0 0 10px;font-size:16px;font-weight:900}
    .sub{color:var(--muted);margin:0 0 12px;line-height:1.8}
    ul{margin:0;padding-left:18px;line-height:1.9} li{margin:6px 0}
    .note{margin-top:12px;padding:12px;border:1px dashed #c7d2fe;border-radius:12px;background:#f8fbff;line-height:1.8}
    .cta{height:40px;padding:0 16px;border-radius:12px;border:1px solid var(--brand);background:var(--brand);color:#fff;font-weight:900;cursor:pointer;box-shadow:0 10px 20px rgba(37,99,235,.18)}
    .cta:hover{filter:brightness(.95)} .cta:disabled{opacity:.6;cursor:not-allowed}
    .cta.ghost{background:#fff;color:var(--brand);border-color:var(--line);box-shadow:none}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;z-index:9999}
    .modal.on{display:block}
    .backdrop{position:absolute;inset:0;background:rgba(15,23,42,.45)}
    .panel{position:relative;width:min(780px,calc(100% - 28px));margin:7vh auto;background:#fff;border-radius:16px;border:1px solid var(--line);box-shadow:0 30px 80px rgba(15,23,42,.25);overflow:hidden}
    .head{padding:16px;border-bottom:1px solid var(--line);background:#fbfbfb;display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
    .head h3{margin:0;font-size:16px;font-weight:900}
    .head .muted{margin-top:4px;font-size:13px;color:var(--muted);line-height:1.6}
    .close{width:34px;height:34px;border-radius:10px;border:1px solid var(--line);background:#fff;font-size:20px;cursor:pointer;flex:0 0 auto}
    form{padding:16px}
    .row{margin-bottom:12px}
    label{display:block;font-size:13px;font-weight:800;margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);font-size:14px;outline:none}
    input:focus,select:focus,textarea:focus{border-color:#c7d2fe;box-shadow:0 0 0 4px rgba(99,102,241,.12)}
    textarea{resize:vertical}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:720px){.grid2{grid-template-columns:1fr}}
    .actions{display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap}
    .hint{margin-top:10px;font-size:13px;color:var(--muted);line-height:1.7;white-space:pre-wrap;word-break:break-word}
    .hint.ok{color:var(--ok);font-weight:900}
    .hint.bad{color:var(--bad);font-weight:900}
    .hp{position:absolute;left:-9999px;top:-9999px;opacity:0}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>交易說明</h1>
    <p>本頁說明 BookWide 的訂閱方案、付款方式、續訂、取消與退費，以及客服聯絡方式。</p>
  </header>

  <nav class="toc">
    <b>快速導覽</b>
    <a href="#plans">訂閱方案</a>
    <a href="#payment">付款方式</a>
    <a href="#renew">續訂與扣款</a>
    <a href="#refund">取消與退費</a>
    <a href="#support">客服聯絡</a>
  </nav>

  <section id="plans">
    <h2>訂閱方案</h2>
    <p class="sub">BookWide 採訂閱制服務，實際方案與價格以 <a href="/pricing.html">方案頁</a> 顯示為準。</p>
    <ul>
      <li>訂閱期間內可使用已開放的學習內容與功能。</li>
      <li>部分功能可能依方案或裝置/瀏覽器支援有所差異。</li>
    </ul>
  </section>

  <section id="payment">
    <h2>付款方式</h2>
    <p class="sub">實際可用的付款方式以結帳頁面顯示為準。</p>
    <ul>
      <li>信用卡／簽帳卡</li>
      <li>第三方金流（依地區提供）</li>
    </ul>
  </section>

  <section id="renew">
    <h2>續訂與扣款</h2>
    <ul>
      <li>部分方案為自動續訂，將於到期時扣款。</li>
      <li>若扣款失敗，訂閱可能暫停，重新付款即可恢復。</li>
    </ul>
  </section>

  <section id="refund">
    <h2>取消與退費</h2>
    <p class="sub">退費將依購買方案、付款方式與實際使用情況評估。</p>

    <div class="note">
      <b>退費申請入口</b><br/>
      請點擊下方按鈕填寫退費申請。送出後會直接建立申請紀錄，客服將以 Email 聯絡你。
      <div style="margin-top:10px;">
        <button class="cta" id="openRefund" type="button">提出退費申請</button>
      </div>
      <div class="hint" style="margin-top:8px;">
        ※ 本申請直接寫入 BookWide 的 Supabase（不會跳出郵件安全警示）。
      </div>
    </div>
  </section>

  <section id="support">
    <h2>客服聯絡</h2>
    <ul>
      <li>請提供：帳號 Email、訂單號、付款方式、問題描述。</li>
      <li>Email：support@bookwide.net（可自行替換）</li>
    </ul>
  </section>
</div>

<!-- Modal -->
<div class="modal" id="refundModal" aria-hidden="true">
  <div class="backdrop" id="backdropRefund"></div>
  <div class="panel" role="dialog" aria-modal="true" aria-labelledby="refundTitle">
    <div class="head">
      <div>
        <h3 id="refundTitle">退費申請表</h3>
        <div class="muted">送出後會建立申請紀錄（表格寫入 Supabase）。若送出失敗，請按「測試連線」查看原因。</div>
      </div>
      <button class="close" id="closeRefund" aria-label="關閉">×</button>
    </div>

    <form id="refundForm" autocomplete="on">
      <input class="hp" type="text" name="website" tabindex="-1" autocomplete="off">

      <div class="row">
        <label>Email *</label>
        <input required type="email" name="email" placeholder="例如：yourname@gmail.com">
      </div>

      <div class="row">
        <label>訂單號（若有）</label>
        <input name="order_no" placeholder="例如：BW-2025xxxx">
      </div>

      <div class="row grid2">
        <div>
          <label>付款方式 *</label>
          <select required name="pay_method">
            <option value="">請選擇</option>
            <option>信用卡</option>
            <option>ATM</option>
            <option>第三方金流</option>
            <option>其他</option>
          </select>
        </div>
        <div>
          <label>付款日期（大概即可）</label>
          <input type="date" name="pay_date">
        </div>
      </div>

      <div class="row">
        <label>退費原因 *</label>
        <textarea required name="reason" rows="4" placeholder="例如：重複訂閱/無法使用/內容不符合期待..."></textarea>
      </div>

      <div class="row">
        <label>聯絡方式（手機或 LINE ID）</label>
        <input name="contact" placeholder="例如：09xx-xxx-xxx / LINE：xxxx">
      </div>

      <div class="row">
        <label>補充說明（可貼錯誤訊息/截圖連結）</label>
        <textarea name="extra" rows="3" placeholder="可貼上你看到的錯誤文字或圖片連結"></textarea>
      </div>

      <div class="actions">
        <button type="button" class="cta ghost" id="testConn">測試連線</button>
        <button type="button" class="cta ghost" id="cancelRefund">取消</button>
        <button type="submit" class="cta" id="submitRefund">送出申請</button>
      </div>

      <div class="hint" id="refundHint"></div>
    </form>
  </div>
</div>

<script>
  // ===== Supabase (REST) =====
  const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
  const TABLE = "refund_requests"; // 你的 table 名稱（public.refund_requests）

  const modal = document.getElementById('refundModal');
  const btnOpen = document.getElementById('openRefund');
  const btnClose = document.getElementById('closeRefund');
  const btnCancel = document.getElementById('cancelRefund');
  const backdrop = document.getElementById('backdropRefund');

  const form = document.getElementById('refundForm');
  const hint = document.getElementById('refundHint');
  const btnSubmit = document.getElementById('submitRefund');
  const btnTest = document.getElementById('testConn');

  function openModal(){
    modal.classList.add('on');
    modal.setAttribute('aria-hidden','false');
    hint.textContent = '';
    hint.className = 'hint';
    setTimeout(()=> {
      const first = form.querySelector('input[name="email"]');
      if(first) first.focus();
    }, 80);
  }
  function closeModal(){
    modal.classList.remove('on');
    modal.setAttribute('aria-hidden','true');
  }

  btnOpen?.addEventListener('click', openModal);
  btnClose?.addEventListener('click', closeModal);
  btnCancel?.addEventListener('click', closeModal);
  backdrop?.addEventListener('click', closeModal);
  document.addEventListener('keydown', (e)=> {
    if(e.key === 'Escape' && modal.classList.contains('on')) closeModal();
  });

  function showHint(msg, ok=false){
    hint.textContent = msg;
    hint.className = ok ? 'hint ok' : 'hint bad';
    try{ hint.scrollIntoView({block:'nearest'}); }catch(_e){}
  }

  function fetchWithTimeout(url, options, ms=12000){
    return new Promise((resolve, reject)=>{
      const t = setTimeout(()=>reject(new Error("Request timeout (12s)")), ms);
      fetch(url, options).then((r)=>{clearTimeout(t); resolve(r);}).catch((e)=>{clearTimeout(t); reject(e);});
    });
  }

  async function supabaseRequest(path, method, body=null){
    const url = `${SUPABASE_URL}/rest/v1/${path}`;
    const res = await fetchWithTimeout(url, {
      method,
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
        "Content-Type": "application/json",
        Prefer: "return=representation"
      },
      body: body ? JSON.stringify(body) : undefined
    });
    const txt = await res.text();
    console.log("[trade] supabase", method, url, "=>", res.status, res.statusText, txt);
    if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}\n${txt}`);
    return txt ? JSON.parse(txt) : null;
  }

  // 連線測試：會出現在 Network 的 Fetch/XHR
  btnTest?.addEventListener('click', async ()=>{
    try{
      showHint("測試中…（請看 Network → Fetch/XHR）");
      // 用 GET 測試：如果你沒有開 SELECT policy，可能會 401/403，這是正常的提示
      await supabaseRequest(`${TABLE}?select=id&limit=1`, "GET");
      showHint("✅ 連線 OK（REST 可用）。如果仍無法寫入，多半是 INSERT policy 或欄位限制。", true);
    }catch(err){
      showHint("❌ 測試失敗（通常是 RLS/CORS/Key 問題）：\n" + (err?.message || String(err)));
      alert("測試失敗，請把 Console/Network 的錯誤貼給我，我一次修到能寫入。");
    }
  });

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();

    // honeypot 防機器人
    const hp = (form.website?.value || '').trim();
    if(hp) return showHint("送出失敗，請稍後再試。");

    btnSubmit.disabled = true;
    hint.textContent = "送出中…（12 秒內無回應會顯示錯誤）";
    hint.className = "hint";

    try{
      const fd = new FormData(form);
      const data = Object.fromEntries(fd.entries());

      const payload = {
        email: (data.email || '').trim(),
        order_no: (data.order_no || '').trim() || null,
        pay_method: (data.pay_method || '').trim(),
        pay_date: (data.pay_date || '').trim() || null,
        reason: (data.reason || '').trim(),
        contact: (data.contact || '').trim() || null,
        extra: (data.extra || '').trim() || null,
        page_url: location.href,
        user_agent: navigator.userAgent,
        client_time: new Date().toISOString()
      };

      console.log("[trade] submit payload", payload);

      await supabaseRequest(TABLE, "POST", payload);

      showHint("✅ 已送出申請（已建立紀錄）。客服將以 Email 聯絡你。", true);
      alert("已送出申請（已建立紀錄）。");
      form.reset();
      setTimeout(closeModal, 600);

    }catch(err){
      console.error(err);
      showHint("❌ 送出失敗：\n" + (err?.message || String(err)));
      alert("送出失敗：通常是 Supabase RLS policy 未開放 INSERT。請照我給你的 SQL 修正後再試。");
    }finally{
      btnSubmit.disabled = false;
    }
  });
</script>

<!-- BookWide 共用 Footer -->
<script src="/shared/footer.js"></script>
</body>
</html>





