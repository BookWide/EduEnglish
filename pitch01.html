<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<title>å½±ç‰‡é‡ç”¢å°ˆå®¶ V8 - åŠ‡æœ¬é‚è¼¯ç‰ˆ (Imagen 3)</title>
<style>
  :root{ --bg:#0b1220; --panel:#0f1b33; --text:#e8eefc; --line:#1b2b4b; --ok:#22c55e; }
  body{ background:var(--bg); color:var(--text); font-family: system-ui; padding:20px; }
  .card{ background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:20px; margin-bottom:20px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
  .input-grid{ display:grid; grid-template-columns: 2fr 2fr 1fr; gap:15px; margin-bottom:15px; }
  input, textarea{ background:#000; border:1px solid var(--line); color:#22c55e; border-radius:8px; padding:10px; width:100%; font-size:14px; }
  label{ display:block; color:#9fb1d1; font-size:12px; margin-bottom:5px; }
  .btn{ background:#1f6feb; color:#fff; border:none; padding:12px 20px; border-radius:10px; cursor:pointer; font-weight:bold; }
  table{ width:100%; border-collapse:collapse; margin-top:20px; background:rgba(0,0,0,0.2); }
  th, td{ border:1px solid var(--line); padding:12px; text-align:left; font-size:13px; }
  th{ color:#22c55e; background:rgba(255,255,255,0.05); }
</style>
</head>
<body>

<div class="card">
  <h1>ğŸ¬ é€šç”¨å½±éŸ³é‡ç”¢å·¥ä½œå° - åŠ‡æœ¬æ„è­˜å¼·åŒ–ç‰ˆ</h1>
  <div class="input-grid">
    <div>
      <label>1. ä¸Šå‚³ SRT (åŠ  ">>" å¯è‡ªç”±åˆä½µå¥å­)</label>
      <input type="file" id="srtFile" />
    </div>
    <div>
      <label>2. æ ¸å¿ƒè§’è‰²å®šè£ (é˜²æ­¢ AI äº‚ç•«ï¼Œå¦‚: A tiny brown mouse)</label>
      <input id="charLock" type="text" placeholder="ä¸»è§’å¤–è²Œæè¿°..." />
    </div>
    <div>
      <label>3. å½±ç‰‡ç°¡ç¨±</label>
      <input id="shortName" type="text" placeholder="001_lion" />
    </div>
  </div>
  <div style="margin-top:10px;">
    <label>æ•…äº‹èƒŒæ™¯/æ•´é«”é¢¨æ ¼ (å¦‚: Realistic forest, Aesop's Fables style)</label>
    <input id="contextLock" type="text" placeholder="è¨­å®šæ•…äº‹èƒŒæ™¯..." />
  </div>
  <button class="btn" style="margin-top:15px; width:100%; background:var(--ok);" onclick="runV8()">è§£æåŠ‡æœ¬ä¸¦è‡ªå‹•å°é½Š</button>
</div>

<table id="mainTable">
  <thead>
    <tr>
      <th width="100">ç·¨è™Ÿ</th>
      <th width="150">æ™‚é–“è»¸</th>
      <th>å­—å¹•å…§å®¹ (é…éŸ³)</th>
      <th>Imagen 3 æç¤ºè© (é–å®šåŠ‡æƒ…é‚è¼¯)</th>
      <th width="80">ç”Ÿåœ–</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
// å»¶ç”¨æ‚¨åŸæœ‰çš„ Supabase è¨­å®šï¼Œä½†ç§»é™¤ OpenAI é‚è¼¯
const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
const IMG_API = "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/img-one";

async function runV8() {
  const file = document.getElementById('srtFile').files[0];
  if(!file) return alert("è«‹ä¸Šå‚³ SRT");
  
  const text = await file.text();
  const charLock = document.getElementById('charLock').value || "";
  const context = document.getElementById('contextLock').value || "";
  const sname = document.getElementById('shortName').value || "vid";
  
  const blocks = text.trim().split(/\n\s*\n/).map(b => {
    const lines = b.split('\n');
    return { time: lines[1], text: lines.slice(2).join(" ").trim() };
  });

  const tbody = document.querySelector('#mainTable tbody');
  tbody.innerHTML = "";
  
  let currentGroup = [];
  let startTime = "";
  let counter = 1;

  blocks.forEach((item, idx) => {
    const isMerging = item.text.includes(">>");
    const cleanText = item.text.replace(">>", "").trim();
    if(!startTime) startTime = item.time.split(" --> ")[0];
    currentGroup.push(cleanText);

    if(!isMerging || idx === blocks.length - 1) {
      const fullText = currentGroup.join(" ");
      const fileID = `${sname}_${String(counter).padStart(3, '0')}`;
      
      // ã€åŠ‡æƒ…æ„è­˜æ ¸å¿ƒé‚è¼¯ã€‘ï¼šå¼·åˆ¶é–å®šè§’è‰²èˆ‡èƒŒæ™¯
      const prompt = `[Core Character: ${charLock}]. [Environment: ${context}]. Cinematic photo, 8k, realistic. Action: ${fullText}. (Note: The prince is the ${charLock})`;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><b>${fileID}</b></td>
        <td><small>${startTime}</small></td>
        <td><textarea rows="2">${fullText}</textarea></td>
        <td><textarea rows="3">${prompt}</textarea></td>
        <td><button class="btn" onclick="genImg('${fileID}','${prompt.replace(/'/g,"\\'")}')">åŸ·è¡Œ</button></td>
      `;
      tbody.appendChild(tr);
      currentGroup = []; startTime = ""; counter++;
    }
  });
}

async function genImg(id, prompt) {
  const resp = await fetch(IMG_API, {
    method: "POST",
    headers: { "Content-Type":"application/json", "apikey":SUPA_KEY, "Authorization":"Bearer "+SUPA_KEY },
    body: JSON.stringify({ prompt: prompt, model: "imagen-3", size: "1536x1024" })
  });
  if(resp.ok) {
    const blob = await resp.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${id}.png`;
    a.click();
  }
}
</script>
</body>
</html>
