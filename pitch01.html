<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>å½±ç‰‡é‡ç”¢å·¥å…· V5 - Google Imagen 3 å°ˆæ¥­ç‰ˆ</title>
<style>
  :root{
    --bg:#0b1220;--panel:#0f1b33;--panel2:#0c172d;--text:#e8eefc;--muted:#9fb1d1;
    --line:#1b2b4b;--btn:#1f6feb;--btn2:#12264d;--danger:#ff5d5d;--ok:#22c55e;
    --radius:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Arial; background:var(--bg); color:var(--text); padding:20px;}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:20px;margin-bottom:20px;box-shadow:0 8px 32px rgba(0,0,0,0.3)}
  h1{margin:0 0 15px 0;font-size:18px;color:var(--ok)}
  .control-row{display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap;margin-bottom:15px}
  .field{flex:1;min-width:180px}
  label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
  input, select, textarea{width:100%;background:var(--panel2);border:1px solid var(--line);color:var(--text);border-radius:10px;padding:10px;outline:none;font-size:14px}
  .btn{border:none;border-radius:10px;padding:10px 18px;font-weight:700;background:var(--btn);color:white;cursor:pointer;transition:0.2s}
  .btn:hover{filter:brightness(1.2)}
  .btn-ok{background:var(--ok)}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid var(--line);padding:12px;text-align:left;font-size:13px}
  th{background:rgba(255,255,255,0.05);color:var(--muted)}
  textarea{font-family:monospace;background:#000;color:#22c55e}
  .merge-hint{color:var(--ok);font-size:11px;font-weight:bold}
</style>
</head>
<body>

<div class="card">
  <h1>ğŸ¬ è¬ç”¨å½±ç‰‡é‡ç”¢å·¥ä½œå° (Imagen 3 & è‡ªç”±å°é½Š)</h1>
  <div class="control-row">
    <div class="field">
      <label>1. ä¸Šå‚³ SRT (å…§å®¹çµå°¾åŠ  ">>" å³å¯åˆä½µè‡³ä¸‹ä¸€å¼µåœ–)</label>
      <input type="file" id="srtFile" accept=".srt"/>
    </div>
    <div style="width:120px">
      <label>çŸ­æª”å</label>
      <input id="shortName" type="text" placeholder="vid"/>
    </div>
    <button class="btn btn-ok" onclick="bwProcessSrt()">è§£æä¸¦å„ªåŒ–ä»»å‹™</button>
  </div>
  <p style="font-size:12px;color:var(--muted);margin:0">â€» æœ¬ç¨‹åºå·²ç§»é™¤ OpenAI æ’ä»¶ï¼Œç”Ÿåœ–å°‡ç›´æ¥é€éæ‚¨è¨­å®šçš„å¾Œç«¯èª¿ç”¨ Google Imagen 3ã€‚</p>
</div>

<table id="taskTable">
  <thead>
    <tr>
      <th width="90">æª”æ¡ˆç·¨è™Ÿ</th>
      <th width="150">æ™‚é–“è»¸</th>
      <th>å­—å¹•å…§å®¹ (è‡ªå‹•ä¿®æ­£æ‹¼éŸ³)</th>
      <th>Imagen 3 æç¤ºè© (å¯«å¯¦é¢¨æ ¼)</th>
      <th width="90">æ“ä½œ</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
// æ‰¿è¥²æ‚¨åŸå§‹ç¨‹åºçš„ API é…ç½®
const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";
const IMG_API = "https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/img-one";

let PROCESSED_TASKS = [];

async function bwProcessSrt() {
  const file = document.getElementById('srtFile').files[0];
  if(!file) return alert("è«‹å…ˆé¸æ“‡ SRT æª”æ¡ˆ");
  
  const text = await file.text();
  const blocks = text.trim().split(/\n\s*\n/);
  const rows = blocks.map(b => {
    const lines = b.split('\n');
    return { time: lines[1], text: lines.slice(2).join(" ").trim() };
  });
  
  bwRender(rows);
}

function bwRender(items) {
  const tbody = document.querySelector('#taskTable tbody');
  tbody.innerHTML = "";
  const sname = document.getElementById('shortName').value || "v";
  PROCESSED_TASKS = [];
  
  let currentGroup = [];
  let startTime = "";
  let counter = 1;

  items.forEach((item, idx) => {
    const isMerging = item.text.includes(">>");
    // è‡ªå‹•ä¿®æ­£ï¼šçµ±ä¸€å°‡æ‹¼éŸ³è½‰å›æ­£ç¢ºæ­·å²åç¨±
    let clean = item.text.replace(">>", "").trim()
                        .replace(/Shugo Yang|Zhugo Yang/g, "Zhuge Liang")
                        .replace(/Lubay/g, "Liu Bei");
    
    if(!startTime) startTime = item.time.split(" --> ")[0];
    currentGroup.push(clean);

    if(!isMerging || idx === items.length - 1) {
      const fullContent = currentGroup.join(" ");
      const fileID = `${sname}_${String(counter).padStart(3, '0')}`;
      const endTime = item.time.split(" --> ")[1];
      
      // ç”Ÿæˆç¬¦åˆ Imagen 3 é«˜å“è³ªå¯«å¯¦é¢¨æ ¼çš„æç¤ºè©
      const prompt = `Cinematic photo, 8k, realistic historical setting, high detail, professional photography. Scene: ${fullContent}. --ar 16:9`;
      
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><b>${fileID}</b></td>
        <td><small>${startTime}<br>è‡³<br>${endTime}</small></td>
        <td><textarea rows="3">${fullContent}</textarea></td>
        <td><textarea rows="3">${prompt}</textarea></td>
        <td><button class="btn" onclick="bwImgOne('${fileID}', '${prompt.replace(/'/g,"\\'")}')">ç›´æ¥ç”Ÿåœ–</button></td>
      `;
      tbody.appendChild(tr);
      
      PROCESSED_TASKS.push({ id: fileID, prompt: prompt });
      currentText = []; startTime = ""; currentGroup = []; counter++;
    }
  });
}

async function bwImgOne(id, prompt) {
  // å°æ¥æ‚¨çš„ Supabase å¾Œç«¯ï¼Œä¸¦å¼·åˆ¶è¦æ±‚ Imagen 3 æ¨¡å‹
  try {
    const resp = await fetch(IMG_API, {
      method: "POST",
      headers: { 
        "Content-Type": "application/json", 
        "apikey": SUPA_KEY, 
        "Authorization": "Bearer " + SUPA_KEY 
      },
      body: JSON.stringify({ 
        prompt: prompt, 
        model: "imagen-3", // å®Œå…¨é¿é–‹ OpenAI
        size: "1536x1024",
        aspect_ratio: "16:9"
      })
    });

    if(resp.ok) {
      const blob = await resp.blob();
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${id}.png`;
      a.click();
    } else {
      alert("ç”Ÿåœ–å¤±æ•—ï¼Œè«‹ç¢ºèªå¾Œç«¯ Edge Function æ˜¯å¦æ”¯æ´ Imagen 3");
    }
  } catch(e) {
    console.error(e);
    alert("é€£ç·šéŒ¯èª¤");
  }
}
</script>
</body>
</html>