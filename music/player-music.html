<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Music Player</title>
<style>
  :root{--ink:#e6f0ff;--bg:#0b1520;--card:#0f2030;--line:#264a6a}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  .layout{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
  .panel{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
  iframe{width:100%;aspect-ratio:16/9;border:0;border-radius:12px}
  .tabs{display:flex;gap:8px;margin-bottom:12px}
  .tabs button{padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#0c1a28;color:var(--ink);cursor:pointer}
  .tabs button.on{background:#10334d}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{vertical-align:top}
  .time{opacity:.8;white-space:nowrap;width:60px}
  .en{font-size:16px;line-height:1.4}
  .zh{opacity:.85;margin-top:4px}
  .q{margin:10px 0;padding:12px;border:1px solid var(--line);border-radius:10px}
  .choices label{display:block;margin:6px 0;cursor:pointer}
  .ok{color:#8ef58e}.bad{color:#ff9f9f}
  @media (max-width:960px){.layout{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <a href="./index.html" style="padding:8px 10px;border:1px solid var(--line);border-radius:10px;text-decoration:none;color:inherit">← 回音樂清單</a>
  <div class="layout" style="margin-top:12px">
    <div class="panel"><div id="media"></div></div>
    <div class="panel">
      <div class="tabs">
        <button class="t on" data-tab="lyrics">歌詞</button>
        <button class="t" data-tab="quiz">測驗</button>
        <button class="t" data-tab="ai">AI互動</button>
      </div>
      <div id="tab-lyrics"></div>
      <div id="tab-quiz" hidden></div>
      <div id="tab-ai" hidden>（之後接 AI 功能）</div>
    </div>
  </div>
</div>

<script type="module">
  const qs = new URLSearchParams(location.search);
  const slug = qs.get('slug');

  const list = await (await fetch('./data/index.json')).json();
  const meta = list.find(x=>x.slug===slug) || list[0];
  const YT = (id, start=0)=>`https://www.youtube.com/embed/${id}?rel=0&modestbranding=1&start=${Math.floor(start)}`;

  // 左：YouTube
  const media = document.getElementById('media');
  function loadVideo(at=0){ media.innerHTML =
    `<iframe src="${YT(meta.youtubeId, at)}"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
      allowfullscreen></iframe>`; }
  loadVideo(0);

  // 右：分頁
  document.querySelectorAll('.t').forEach(b=>{
    b.onclick=()=>{
      document.querySelectorAll('.t').forEach(x=>x.classList.remove('on'));
      b.classList.add('on');
      const id=b.dataset.tab;
      ['lyrics','quiz','ai'].forEach(k=>{
        document.getElementById('tab-'+k).hidden=(k!==id);
      });
    };
  });

  // 歌詞（JSON：/music/data/cues-<slug>.json）
  const lyrBox = document.getElementById('tab-lyrics');
  lyrBox.innerHTML = `<h2 style="margin:.2rem 0">${meta.title}</h2>
  <div style="opacity:.85">${meta.artist}</div>
  <div style="opacity:.8;margin:.5rem 0">${meta.level} · ${meta.topic||''}</div>
  <div id="lyrics-body" class="hint">載入歌詞中…</div>`;

  try{
    const cuesResp = await fetch(`./data/cues-${meta.slug}.json`);
    if (cuesResp.ok){
      const {cues=[]} = await cuesResp.json();
      document.getElementById('lyrics-body').innerHTML = renderLyrics(cues);
      document.getElementById('lyrics-body').addEventListener('click', e=>{
        const tr = e.target.closest('tr[data-t]'); if(!tr) return;
        loadVideo(Number(tr.dataset.t)); window.scrollTo({top:0,behavior:'smooth'});
      });
    }else{
      document.getElementById('lyrics-body').innerHTML =
        `（找不到 <code>cues-${meta.slug}.json</code>。先用這份示範，之後請換成你有授權或 CC 的歌詞。）`;
    }
  }catch{ /* ignore */ }

  // 測驗（/music/data/quiz-<slug>.json）
  const quizBox = document.getElementById('tab-quiz');
  try{
    const qResp = await fetch(`./data/quiz-${meta.slug}.json`);
    if (qResp.ok){
      const {questions=[]} = await qResp.json();
      quizBox.innerHTML = renderQuiz(questions);
      quizBox.addEventListener('click', e=>{
        const b = e.target.closest('button[data-q]');
        if(!b) return;
        const qi = Number(b.dataset.q);
        const ans = b.dataset.ans;
        const pick = quizBox.querySelector(`input[name="q${qi}"]:checked`)?.value;
        const msg = quizBox.querySelector(`#msg${qi}`);
        msg.textContent = (pick===ans) ? '✔ 正確！' : '✘ 再想想';
        msg.className = (pick===ans) ? 'ok' : 'bad';
      });
    }else{
      quizBox.innerHTML = `（之後接 <code>quiz-${meta.slug}.json</code> 測驗檔）`;
    }
  }catch{ /* ignore */ }

  // helpers
  function fmt(sec){const m=Math.floor(sec/60).toString().padStart(2,'0'); const s=Math.floor(sec%60).toString().padStart(2,'0'); return `${m}:${s}`;}
  function esc(s){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
  function renderLyrics(cues){
    return `<table><thead><tr><th class="time">時間</th><th>內容</th></tr></thead><tbody>
      ${cues.map(c=>`
      <tr data-t="${c.t}">
        <td class="time">${fmt(c.t)}</td>
        <td>
          <div class="en">${esc(c.en||'')}</div>
          ${c.zh?`<div class="zh">${esc(c.zh)}</div>`:''}
        </td>
      </tr>`).join('')}
    </tbody></table>`;
  }
  function renderQuiz(qs){
    return qs.map((q,i)=>`
      <div class="q">
        <div style="margin-bottom:6px"><b>Q${i+1}.</b> ${esc(q.text)}</div>
        <div class="choices">
          ${q.choices.map((c,j)=>`
            <label><input type="radio" name="q${i}" value="${esc(c)}"> ${esc(c)}</label>
          `).join('')}
        </div>
        <button data-q="${i}" data-ans="${esc(q.answer)}">提交</button>
        <span id="msg${i}" style="margin-left:8px"></span>
      </div>`).join('');
  }
</script>
</body>
</html>

