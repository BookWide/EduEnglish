<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Music Player</title>
<style>
  :root{--ink:#e6f0ff;--bg:#0b1520;--card:#0f2030;--line:#264a6a}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  .layout{display:grid;grid-template-columns:1.25fr .75fr;gap:16px}
  .panel{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
  iframe,video{width:100%;aspect-ratio:16/9;border:0;border-radius:12px;background:#000}
  .toolbar{margin-top:12px;background:#0c1a28;border:1px solid var(--line);border-radius:12px;padding:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#10334d;color:var(--ink);cursor:pointer}
  .tabs{display:flex;gap:8px;margin-bottom:12px}
  .tabs button{padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#0c1a28;color:var(--ink);cursor:pointer}
  .tabs button.on{background:#10334d}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{vertical-align:top}
  .time{opacity:.8;white-space:nowrap;width:60px}
  .en{font-size:16px;line-height:1.45}
  .zh{opacity:.85;margin-top:4px}
  .q{margin:10px 0;padding:12px;border:1px solid var(--line);border-radius:10px}
  .choices label{display:block;margin:6px 0;cursor:pointer}
  .ok{color:#8ef58e}.bad{color:#ff9f9f}
  #lyrics-body tr.cur{outline:2px solid #2b7fff;outline-offset:2px;border-radius:6px}
  @media (max-width:960px){.layout{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <a href="./index.html" class="btn">← 回音樂清單</a>

  <div class="layout" style="margin-top:12px">
    <!-- 左：影片 + 工具列 -->
    <div class="panel">
      <div id="mediaMount"></div>

      <!-- 工具列 -->
      <div class="toolbar">
        <button class="btn" id="btnPrev">上一句</button>
        <button class="btn" id="btnPlay">播放/暫停</button>
        <button class="btn" id="btnNext">下一句</button>
        <button class="btn" id="btnRepeat">重複本句</button>
        <label style="margin-left:6px"><input type="checkbox" id="follow" checked> 跟隨</label>
        <label>偏移 <input id="offset" type="number" step="0.1" value="0" style="width:70px">s</label>
        <label>速度
          <select id="rate">
            <option>0.75</option><option selected>1.0</option><option>1.25</option>
            <option>1.5</option><option>1.75</option><option>2</option>
          </select>
        </label>
      </div>
    </div>

    <!-- 右：歌詞 / 測驗 / AI互動 -->
    <div class="panel">
      <div class="tabs">
        <button class="t on" data-tab="lyrics">歌詞</button>
        <button class="t" data-tab="quiz">測驗</button>
        <button class="t" data-tab="ai">AI互動</button>
      </div>
      <div id="tab-lyrics"></div>
      <div id="tab-quiz" hidden></div>
      <div id="tab-ai" hidden>（之後接 AI 功能）</div>
    </div>
  </div>
</div>

<!-- YouTube IFrame API（控制播放/跳播/倍速必須） -->
<script src="https://www.youtube.com/iframe_api"></script>

<script type="module">
  const qs   = new URLSearchParams(location.search);
  const slug = qs.get('slug');

  // 讀清單
  const list = await (await fetch('./data/index.json')).json();
  const meta = list.find(x=>x.slug===slug) || list[0];
  const isYT = !!meta.youtubeId;

  // 共用播放介面：YouTube / HTML5 都走同一套 API
  const Media = {
    mode: isYT ? 'yt' : 'html5',
    ready: false,
    _el: null,      // HTMLVideoElement
    _yt: null,      // YT.Player
    mount(start=0){
      const mount = document.getElementById('mediaMount');
      if (this.mode==='yt'){
        mount.innerHTML =
          `<iframe id="ytp"
             src="https://www.youtube.com/embed/${meta.youtubeId}?enablejsapi=1&rel=0&modestbranding=1&start=${Math.floor(start)}"
             allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
             allowfullscreen></iframe>`;
        // YT 準備好後才算 ready
        window.__onYTReady = () => {
          this._yt = new YT.Player('ytp', {
            events: { 'onReady': () => {
              this.ready = true;
              syncAvailableRates(this._yt);
            }}
          });
        };
        if (window.YT && window.YT.Player) window.__onYTReady();
        else window.onYouTubeIframeAPIReady = window.__onYTReady;
      }else{
        // 本地 mp4：路徑回到專案根 videos（../videos）
        const src = meta.file ? `../videos/${meta.file}` : `../videos/${meta.slug}.mp4`;
        mount.innerHTML = `<video id="v" src="${src}" controls playsinline></video>`;
        this._el = document.getElementById('v');
        this._el.onloadeddata = () => { this.ready = true; };
        if (start) this._el.currentTime = start;
      }
    },
    play(){ this.mode==='yt' ? this._yt?.playVideo() : this._el?.play(); },
    pause(){ this.mode==='yt' ? this._yt?.pauseVideo() : this._el?.pause(); },
    toggle(){ const s=this.state(); (s==='playing')?this.pause():this.play(); },
    seek(t){ t=Math.max(0,t); this.mode==='yt' ? this._yt?.seekTo(t,true) : (this._el && (this._el.currentTime=t)); },
    time(){ return this.mode==='yt' ? (this._yt?.getCurrentTime?.()||0) : (this._el?.currentTime||0); },
    setRate(r){ this.mode==='yt' ? this._yt?.setPlaybackRate?.(r) : (this._el && (this._el.playbackRate=r)); },
    getRate(){ return this.mode==='yt' ? (this._yt?.getPlaybackRate?.()||1) : (this._el?.playbackRate||1); },
    state(){
      if (this.mode==='yt'){ const s=this._yt?.getPlayerState?.(); return s===1?'playing':(s===2?'paused':'idle'); }
      if (!this._el) return 'idle'; return this._el.paused?'paused':'playing';
    }
  };
  Media.mount(0);

  // 畫面分頁
  document.querySelectorAll('.t').forEach(b=>{
    b.onclick=()=>{
      document.querySelectorAll('.t').forEach(x=>x.classList.remove('on'));
      b.classList.add('on');
      const id=b.dataset.tab;
      ['lyrics','quiz','ai'].forEach(k=>{ document.getElementById('tab-'+k).hidden=(k!==id); });
    };
  });

  // 右側：歌詞
  const lyrBox = document.getElementById('tab-lyrics');
  lyrBox.innerHTML = `<h2 style="margin:.2rem 0">${meta.title}</h2>
  <div style="opacity:.85">${meta.artist||''}</div>
  <div style="opacity:.8;margin:.5rem 0">${meta.level||''} · ${meta.topic||''}</div>
  <div id="lyrics-body" class="hint">載入歌詞中…</div>`;

  let cues = [];
  try{
    const r = await fetch(`./data/cues-${meta.slug}.json`);
    if(r.ok){
      cues = (await r.json()).cues || [];
      document.getElementById('lyrics-body').innerHTML = renderLyrics(cues);
      // 點一句 → 跳播
      document.getElementById('lyrics-body').addEventListener('click', e=>{
        const tr = e.target.closest('tr[data-t]'); if(!tr) return;
        jumpToTime(Number(tr.dataset.t));
        window.scrollTo({top:0,behavior:'smooth'});
      });
    }else{
      document.getElementById('lyrics-body').innerHTML = `（找不到 <code>cues-${meta.slug}.json</code>）`;
    }
  }catch{ document.getElementById('lyrics-body').textContent='（歌詞載入失敗）'; }

  // 右側：測驗（可選）
  const quizBox = document.getElementById('tab-quiz');
  try{
    const q = await fetch(`./data/quiz-${meta.slug}.json`);
    if(q.ok){
      const {questions=[]} = await q.json();
      quizBox.innerHTML = renderQuiz(questions);
      quizBox.addEventListener('click', e=>{
        const b = e.target.closest('button[data-q]'); if(!b) return;
        const qi = Number(b.dataset.q), ans=b.dataset.ans;
        const pick = quizBox.querySelector(`input[name="q${qi}"]:checked`)?.value;
        const msg  = quizBox.querySelector(`#msg${qi}`);
        msg.textContent = (pick===ans) ? '✔ 正確！' : '✘ 再想想';
        msg.className   = (pick===ans) ? 'ok' : 'bad';
      });
    }else{
      quizBox.innerHTML = '（之後可加入 quiz-*.json 題目）';
    }
  }catch{ quizBox.textContent='（測驗載入失敗）'; }

  // 工具列邏輯（同影片播放器）
  let curIdx=0, repeat=false, offset=0;
  const $ = s=>document.querySelector(s);
  $('#btnPlay').onclick   = ()=> Media.toggle();
  $('#btnPrev').onclick   = ()=> jumpByIndex(curIdx-1);
  $('#btnNext').onclick   = ()=> jumpByIndex(curIdx+1);
  $('#btnRepeat').onclick = ()=> repeat = !repeat;
  $('#rate').onchange     = e => Media.setRate(parseFloat(e.target.value));
  $('#offset').oninput    = e => offset = parseFloat(e.target.value||0);

  function jumpByIndex(i){
    if(!cues.length) return;
    curIdx = Math.min(Math.max(0,i), cues.length-1);
    jumpToTime(cues[curIdx].t);
  }
  function jumpToTime(sec){
    const t = Math.max(0,(sec||0)+offset);
    Media.seek(t); Media.play();
  }

  // 定時更新：鎖定當前句 / repeat / 跟隨歌詞
  (function tick(){
    if(Media.ready && cues.length){
      const ct = Media.time();
      for(let i=0;i<cues.length;i++){
        const start = cues[i].t + offset;
        const end   = (cues[i+1]?.t ?? 1e9) + offset;
        if(ct >= start && ct < end){ curIdx=i; break; }
      }
      if(repeat){
        const start = cues[curIdx]?.t + offset;
        const end   = (cues[curIdx+1]?.t ?? 1e9) + offset;
        if(ct >= end - 0.05) Media.seek(Math.max(0,start));
      }
      if($('#follow').checked){
        const row = document.querySelector(`#lyrics-body tr[data-t="${cues[curIdx]?.t}"]`);
        if(row && !row.classList.contains('cur')){
          document.querySelectorAll('#lyrics-body tr.cur').forEach(x=>x.classList.remove('cur'));
          row.classList.add('cur');
          row.scrollIntoView({block:'center',behavior:'smooth'});
        }
      }
    }
    requestAnimationFrame(tick);
  })();

  // Utils
  function fmt(sec){const m=Math.floor(sec/60).toString().padStart(2,'0'); const s=Math.floor(sec%60).toString().padStart(2,'0'); return `${m}:${s}`;}
  function esc(s){return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
  function renderLyrics(arr){
    return `<table><thead><tr><th class="time">時間</th><th>內容</th></tr></thead><tbody>
      ${arr.map(c=>`
        <tr data-t="${c.t}">
          <td class="time">${fmt(c.t)}</td>
          <td>
            <div class="en">${esc(c.en||'')}</div>
            ${c.zh?`<div class="zh">${esc(c.zh)}</div>`:''}
          </td>
        </tr>`).join('')}
    </tbody></table>`;
  }
  function renderQuiz(qs){
    return qs.map((q,i)=>`
      <div class="q">
        <div style="margin-bottom:6px"><b>Q${i+1}.</b> ${esc(q.text)}</div>
        <div class="choices">
          ${q.choices.map(c=>`<label><input type="radio" name="q${i}" value="${esc(c)}"> ${esc(c)}</label>`).join('')}
        </div>
        <button class="btn" data-q="${i}" data-ans="${esc(q.answer)}">提交</button>
        <span id="msg${i}" style="margin-left:8px"></span>
      </div>`).join('');
  }

  // 依 YouTube 可用倍速修剪下拉選單
  function syncAvailableRates(player){
    try{
      const rates = player.getAvailablePlaybackRates?.() || [];
      const sel = document.getElementById('rate');
      if(rates.length){
        const keep = new Set(rates.map(String));
        [...sel.options].forEach(o=>{ if(!keep.has(o.value)) o.remove(); });
      }
    }catch(e){}
  }
</script>
</body>
</html>

