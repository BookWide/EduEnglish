<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Music Player</title>
<style>
  :root{--ink:#e6f0ff;--bg:#0b1520;--card:#0f2030;--line:#264a6a}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  .layout{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
  .panel{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
  iframe{width:100%;aspect-ratio:16/9;border:0;border-radius:12px}
  .tabs{display:flex;gap:8px;margin-bottom:12px}
  .tabs button{padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#0c1a28;color:var(--ink);cursor:pointer}
  .tabs button.on{background:#10334d}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{vertical-align:top}
  .time{opacity:.8;white-space:nowrap;width:60px}
  .en{font-size:16px;line-height:1.4}
  .zh{opacity:.85;margin-top:4px}
  .hint{opacity:.8}
  @media (max-width:960px){.layout{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <p><a href="./index.html" style="padding:8px 10px;border:1px solid var(--line);border-radius:10px;text-decoration:none;color:inherit">← 回音樂清單</a></p>

  <div class="layout">
    <div class="panel">
      <div id="media"></div>
      <!-- 之後可在這裡加：上一句 / 下一句 / AB Loop / 速度 -->
    </div>

    <div class="panel">
      <div class="tabs">
        <button class="t on" data-tab="lyrics">歌詞</button>
        <button class="t" data-tab="quiz">測驗</button>
        <button class="t" data-tab="ai">AI互動</button>
      </div>

      <div id="tab-lyrics"></div>
      <div id="tab-quiz" hidden>（之後接 quiz 模組）</div>
      <div id="tab-ai" hidden>（之後接 AI 模組）</div>
    </div>
  </div>
</div>

<script type="module">
  const qs = new URLSearchParams(location.search);
  const slug = qs.get('slug');

  const list = await (await fetch('./data/index.json')).json();
  const meta = list.find(x=>x.slug===slug) || list[0];

  // 左：YouTube embed
  const YT = (id)=>`https://www.youtube.com/embed/${id}?rel=0&modestbranding=1`;
  document.getElementById('media').innerHTML =
    `<iframe src="${YT(meta.youtubeId)}"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
      allowfullscreen></iframe>`;

  // 右：歌詞區（先顯示標題資訊；之後可接 VTT -> 表格）
  const lyr = document.getElementById('tab-lyrics');
  lyr.innerHTML = `
    <h2 style="margin:.2rem 0">${meta.title}</h2>
    <div style="opacity:.85">${meta.artist}</div>
    <div class="hint" style="margin:.6rem 0 1rem">${meta.level} · ${meta.topic||''}</div>
    <div id="lyrics-body" class="hint">若你有 VTT/JSON 歌詞檔，可在 <code>/music/data/cues-${meta.slug}.vtt</code> 與 <code>trans-${meta.slug}.json</code>，我幫你載入顯示中英對照。</div>
  `;

  // 若你之後放了 VTT 與中文對照，這段會自動載入與渲染（檔案可選）
  try {
    const [vttResp, zhResp] = await Promise.all([
      fetch(`./data/cues-${meta.slug}.vtt`).catch(()=>null),
      fetch(`./data/trans-${meta.slug}.json`).catch(()=>null)
    ]);
    if (vttResp && vttResp.ok) {
      const vttText = await vttResp.text();
      const zhMap = (zhResp && zhResp.ok) ? await zhResp.json() : {};
      const cues = parseVTT(vttText);
      document.getElementById('lyrics-body').innerHTML = renderLyrics(cues, zhMap);
      // 點擊一句 → 在 YouTube 內跳播：用時間片段參數 start=
      document.getElementById('lyrics-body').addEventListener('click', e=>{
        const tr = e.target.closest('tr[data-t]');
        if(!tr) return;
        const t = Number(tr.dataset.t);
        document.getElementById('media').innerHTML =
          `<iframe src="${YT(meta.youtubeId)}&start=${Math.floor(t)}"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen></iframe>`;
        window.scrollTo({top:0,behavior:'smooth'});
      });
    }
  } catch(e){ /* 沒有歌詞檔就保持提示文字 */ }

  // 分頁切換
  document.querySelectorAll('.t').forEach(b=>{
    b.onclick=()=>{
      document.querySelectorAll('.t').forEach(x=>x.classList.remove('on'));
      b.classList.add('on');
      const id=b.dataset.tab;
      ['lyrics','quiz','ai'].forEach(k=>{
        document.getElementById('tab-'+k).hidden=(k!==id);
      });
    };
  });

  // --- helpers ---
  function parseVTT(text){
    return text
      .replace(/\r/g,'')
      .split('\n\n')
      .map(block=>{
        const m = block.match(/(\d+):(\d+):(\d+\.\d+)\s*-->\s*(\d+):(\d+):(\d+\.\d+)/);
        if(!m) return null;
        const [_,h1,m1,s1,h2,m2,s2]=m;
        const start = (+h1)*3600+(+m1)*60+(+s1);
        const end   = (+h2)*3600+(+m2)*60+(+s2);
        const lines = block.split('\n').slice(1).join(' ').trim();
        return {start,end,text:lines};
      }).filter(Boolean);
  }
  function fmt(sec){
    const m=Math.floor(sec/60).toString().padStart(2,'0');
    const s=Math.floor(sec%60).toString().padStart(2,'0');
    return `${m}:${s}`;
  }
  function renderLyrics(cues, zh){
    return `
      <table>
        <thead><tr><th class="time">時間</th><th>內容</th></tr></thead>
        <tbody>
          ${cues.map(c=>`
            <tr data-t="${c.start}">
              <td class="time">${fmt(c.start)}</td>
              <td>
                <div class="en">${escapeHTML(c.text)}</div>
                ${zh[c.start]?.trim()?`<div class="zh">${escapeHTML(zh[c.start])}</div>`:''}
              </td>
            </tr>`).join('')}
        </tbody>
      </table>`;
  }
  function escapeHTML(s){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
</script>
</body>
</html>
