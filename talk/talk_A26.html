<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Talkï¼ˆæ¯é€±å£èªªï¼‰ï½œBookWide</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#f4f6fb;
    --card:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --line:#e5e7eb;
    --blue:#2563eb;
    --blue2:#1d4ed8;
    --chip:#eef2ff;
    --chipText:#1e40af;
    --danger:#ef4444;
    --shadow: 0 10px 30px rgba(17,24,39,.08);
    --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    color:var(--text);
    background:linear-gradient(180deg,#f7f8ff 0%, var(--bg) 70%);
  }
  .app{
    height:100%;
    display:flex;
    flex-direction:column;
    padding:14px 14px calc(14px + env(safe-area-inset-bottom));
    gap:10px;
    max-width:1100px;
    margin:0 auto;
  }
  .topbar{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:999px;
    padding:10px 12px;
    display:flex;
    align-items:center;
    gap:10px;
    box-shadow:var(--shadow);
  }
  .brand{
    display:flex;
    flex-direction:column;
    gap:2px;
    padding:0 6px;
    min-width:160px;
  }
  .brand .t{font-weight:800; font-size:18px; line-height:1}
  .brand .s{font-size:12px; color:var(--muted)}
  .spacer{flex:1}
  .ctrls{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
  select, button{
    height:36px;
    border-radius:999px;
    border:1px solid var(--line);
    background:#fff;
    color:var(--text);
    padding:0 12px;
    font-size:14px;
    outline:none;
  }
  select{max-width:290px}
  button{
    cursor:pointer;
    user-select:none;
  }
  button.primary{
    background:var(--blue);
    border-color:var(--blue);
    color:#fff;
  }
  button.primary:hover{background:var(--blue2); border-color:var(--blue2)}
  button.ghost{
    background:#fff;
  }
  button:disabled{
    opacity:.45;
    cursor:not-allowed;
  }

  .banner{
    display:none;
    background:#fff;
    border:1px solid rgba(239,68,68,.35);
    border-left:6px solid var(--danger);
    border-radius:14px;
    padding:10px 12px;
    box-shadow:var(--shadow);
    color:#7f1d1d;
    font-size:13px;
  }
  .banner strong{color:#991b1b}
  .main{
    display:grid;
    grid-template-rows: 1fr auto;
    gap:10px;
    min-height:0;
    flex:1;
  }
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:hidden;
    min-height:0;
  }
  .stage{
    display:grid;
    grid-template-columns: 180px 1fr;
    gap:12px;
    padding:14px;
    min-height:0;
  }
  .teacher{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:10px;
  }
  .teacherVideo{
    width:150px;
    height:150px;
    border-radius:999px;
    overflow:hidden;
    border:1px solid var(--line);
    background:#000;
    position:relative;
  }
  .teacherVideo video{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
  }
  .onlineDot{
    width:12px;height:12px;border-radius:99px;background:#22c55e;
    border:2px solid #fff;
    position:absolute; left:12px; top:12px;
    box-shadow:0 4px 10px rgba(34,197,94,.35);
  }
  .teacherLabel{
    font-size:13px;
    color:var(--muted);
  }

  .bubbleWrap{
    display:flex;
    flex-direction:column;
    gap:10px;
    min-width:0;
    min-height:0;
  }
  .bubble{
    border:1px solid var(--line);
    border-radius:18px;
    padding:12px 14px;
    display:flex;
    gap:10px;
    align-items:flex-start;
    background:linear-gradient(180deg,#ffffff 0%, #fbfbff 100%);
    min-height:84px;
  }
  .bubbleText{
    flex:1;
    min-width:0;
  }
  .bubbleText .en{
    font-weight:800;
    font-size:20px;
    line-height:1.25;
    word-break:break-word;
  }
  .bubbleText .sub{
    margin-top:6px;
    font-size:13px;
    color:var(--muted);
    white-space:pre-wrap;
  }
  .bubbleActions{
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .iconBtn{
    width:36px;height:36px;border-radius:999px;
    display:inline-flex; align-items:center; justify-content:center;
    border:1px solid var(--line); background:#fff;
  }
  .iconBtn:hover{background:#f8fafc}
  .metaRow{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:0 2px;
    font-size:13px;
    color:var(--muted);
  }
  .metaRow .left{display:flex; gap:10px; flex-wrap:wrap}
  .pill{
    padding:6px 10px;
    border:1px solid var(--line);
    border-radius:999px;
    background:#fff;
    font-size:12px;
  }
  .pill strong{color:var(--text)}
  .hintArea{
    display:flex;
    flex-direction:column;
    gap:10px;
    min-height:0;
  }
  .modeRow{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }
  .bigMic{
    width:60px;height:60px;border-radius:999px;
    border:0;
    background:var(--blue);
    color:#fff;
    display:inline-flex; align-items:center; justify-content:center;
    box-shadow:0 12px 30px rgba(37,99,235,.25);
  }
  .modeRow .miniBtn{height:38px; padding:0 14px}
  .replyCard{
    border-top:1px solid var(--line);
    padding:14px;
    display:flex;
    flex-direction:column;
    gap:10px;
    min-height:0;
  }
  .replyHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .replyHeader h3{
    margin:0;
    font-size:18px;
    font-weight:900;
  }
  .replyHeader .tag{
    border:1px solid var(--line);
    background:#fff;
    border-radius:999px;
    padding:4px 10px;
    font-size:12px;
    color:var(--muted);
  }
  .prompt{
    font-size:18px;
    font-weight:800;
    line-height:1.35;
  }
  .prompt .blank{
    display:inline-block;
    min-width:90px;
    border-bottom:2px solid var(--line);
    transform:translateY(-2px);
  }
  .assist{
    font-size:12px;
    color:var(--muted);
    line-height:1.4;
  }
  .chips{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
  }
  .chip{
    background:var(--chip);
    color:var(--chipText);
    border:1px solid rgba(30,64,175,.15);
    border-radius:999px;
    padding:8px 12px;
    font-size:13px;
    cursor:pointer;
    user-select:none;
  }
  .chip:hover{filter:brightness(.98)}
  .inputRow{
    display:flex;
    gap:10px;
    align-items:center;
  }
  input[type="text"]{
    flex:1;
    height:44px;
    border-radius:14px;
    border:1px solid var(--line);
    padding:0 12px;
    font-size:15px;
    outline:none;
    background:#fff;
  }
  .actionsRow{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }
  .status{
    font-size:13px;
    color:var(--muted);
    min-height:18px;
  }
  .status.good{color:#065f46}
  .status.bad{color:#7f1d1d}
  .footer{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:space-between;
    padding:12px 14px;
    border-top:1px solid var(--line);
    background:linear-gradient(180deg,#fff 0%, #fbfbff 100%);
  }
  .footer .small{font-size:12px; color:var(--muted)}
  .debug{
    display:none;
    border-top:1px dashed var(--line);
    padding:10px 14px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size:12px;
    color:#334155;
    white-space:pre-wrap;
  }

  @media (max-width: 740px){
    .stage{grid-template-columns: 150px 1fr}
    .brand{min-width:120px}
    .teacherVideo{width:132px;height:132px}
    .bubbleText .en{font-size:18px}
    select{max-width:220px}
  }
  @media (max-width: 560px){
    .stage{grid-template-columns: 1fr; }
    .teacher{flex-direction:row; justify-content:flex-start}
    .teacherVideo{width:110px;height:110px}
    .bigMic{width:54px;height:54px}
  }
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="brand">
      <div class="t">Talk</div>
      <div class="s">æ¯é€±å£èªª Â· Browser Speech</div>
    </div>

    <div class="spacer"></div>

    <div class="ctrls">
      <select id="weekSelect" title="é€±æ¬¡"></select>
      <select id="lessonSelect" title="èª²ç¨‹"></select>
      <select id="teacherSelect" title="è€å¸«">
        <option value="Emma">Emma</option>
        <option value="Diana">Diana</option>
        <option value="Sophia">Sophia</option>
      </select>
      <button id="replayBtn" class="ghost">é‡æ’­</button>
      <button id="debugBtn" class="ghost">Debug</button>
    </div>
  </div>

  <div id="banner" class="banner"></div>

  <div class="main">
    <div class="card">
      <div class="stage">
        <div class="teacher">
          <div class="teacherVideo">
            <div class="onlineDot" title="online"></div>
            <video id="teacherVideo" autoplay muted loop playsinline preload="auto" crossorigin="anonymous"></video>
          </div>
          <div class="teacherLabel" id="teacherLabel">Teacher</div>
        </div>

        <div class="bubbleWrap">
          <div class="bubble">
            <div class="bubbleText">
              <div class="en" id="aiText">Loadingâ€¦</div>
              <div class="sub" id="aiSub"></div>
            </div>
            <div class="bubbleActions">
              <button id="speakBtn" class="iconBtn" title="æ’­æ”¾">
                ğŸ”Š
              </button>
              <button id="nextBtn" class="iconBtn" title="ä¸‹ä¸€å¥">â¡ï¸</button>
            </div>
          </div>

          <div class="metaRow">
            <div class="left">
              <div class="pill">æœ¬é€±ï¼š<strong id="weekCount">0</strong> å€‹ç·´ç¿’</div>
              <div class="pill">é€²åº¦ï¼š<strong id="progress">0/0</strong></div>
              <div class="pill">æ¨¡å¼ï¼š<strong id="modeLabel">Teacher</strong></div>
            </div>
            <div class="pill"><span id="userBadge">æœªç™»å…¥</span></div>
          </div>

          <div class="hintArea">
            <div class="modeRow">
              <button id="micBtn" class="bigMic" title="èªéŸ³è¼¸å…¥ï¼ˆå¯é¸ï¼‰">ğŸ¤</button>
              <button id="inputModeBtn" class="miniBtn ghost">è¼¸å…¥</button>
              <button id="skipBtn" class="miniBtn ghost">è·³é</button>
              <button id="hintBtn" class="miniBtn ghost">æç¤º</button>
            </div>

            <div class="replyCard">
              <div class="replyHeader">
                <h3>ä½ çš„å›è¦†</h3>
                <div class="tag" id="answerTag">A1</div>
              </div>

              <div class="prompt" id="studentPrompt">â€”</div>
              <div class="assist" id="assistText">å°è©±æ¨¡å¼ï¼šAI å…ˆèªªä¸€å¥ï¼Œç­‰ä½ å›è¦†ï¼ˆèªéŸ³æˆ–è¼¸å…¥ï¼‰æ‰æœƒé€²ä¸‹ä¸€å¥ã€‚æŒ‰ã€Œæç¤ºã€å¯é¡¯ç¤ºå¡«ç©ºå¼•å°ã€‚</div>

              <div class="chips" id="chips"></div>

              <div class="inputRow">
                <input id="replyInput" type="text" placeholder="å¡«å…¥ç©ºæ ¼..." autocomplete="off" />
              </div>

              <div class="actionsRow">
                <button id="submitBtn" class="primary">âœ… é€å‡ºå¡«å¥½å¥</button>
                <button id="retryBtn" class="ghost">é‡ä¾†</button>
                <div class="status" id="status"></div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <div class="footer">
        <div class="small" id="lessonMeta">â€”</div>
        <div class="small">è³‡æ–™ä¾†æºï¼š/talk/index.jsonï¼ˆå”¯ä¸€è³‡æ–™æºï¼‰</div>
      </div>

      <div id="debug" class="debug"></div>
    </div>
  </div>
</div>

<script>
/** =========================
 *  Talk_A.html (Single file)
 *  - ONLY reads /talk/index.json
 *  - Lesson JSON via meta.file or meta.filename
 *  - Admin: full unlock
 *  ========================= */

const SUPABASE_URL = 'https://jeajrwpmrgczimmrflxo.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do';

const TALK_BASES = [
  '/talk',
  // GitHub raw fallback (useful if /talk isn't deployed on the site)
  'https://raw.githubusercontent.com/BookWide/EduEnglish/main/talk'
];

// runtime chosen base
let TALK_BASE = TALK_BASES[0];
let INDEX_URL = `${TALK_BASE}/index.json`;

// Supabase Storage (PUBLIC)
const TEACHER_VIDEO_BASE = `${SUPABASE_URL}/storage/v1/object/public/talk/teacher`;
const TEACHERS = {
  Emma:   `${TEACHER_VIDEO_BASE}/Emma.mp4`,
  Diana:  `${TEACHER_VIDEO_BASE}/Diana.mp4`,
  Sophia: `${TEACHER_VIDEO_BASE}/Sophia.mp4`,
};

// Admin whitelist (ä½ å¯ä»¥è‡ªè¡ŒåŠ )
const ADMIN_EMAILS = new Set([
  'pmktools@gmail.com'
]);

/** ---------- DOM ---------- */
const $ = (id)=>document.getElementById(id);
const weekSelect = $('weekSelect');
const lessonSelect = $('lessonSelect');
const teacherSelect = $('teacherSelect');
const teacherVideo = $('teacherVideo');
const teacherLabel = $('teacherLabel');

const aiText = $('aiText');
const aiSub = $('aiSub');
const speakBtn = $('speakBtn');
const nextBtn = $('nextBtn');

const weekCount = $('weekCount');
const progress = $('progress');
const modeLabel = $('modeLabel');
const userBadge = $('userBadge');

const micBtn = $('micBtn');
const inputModeBtn = $('inputModeBtn');
const skipBtn = $('skipBtn');
const hintBtn = $('hintBtn');

const studentPrompt = $('studentPrompt');
const chips = $('chips');
const replyInput = $('replyInput');
const submitBtn = $('submitBtn');
const retryBtn = $('retryBtn');
const statusEl = $('status');
const lessonMetaEl = $('lessonMeta');

const banner = $('banner');
const debugEl = $('debug');
const debugBtn = $('debugBtn');
const replayBtn = $('replayBtn');

/** ---------- State ---------- */
const state = {
  talkBaseUsed: TALK_BASE,

  indexRaw: [],
  weeks: [],
  byWeek: new Map(), // week -> metas[]
  byId: new Map(),   // id -> meta
  profile: { isAdmin:false, email:'', maxWeek:'W01' },

  currentWeek: '',
  currentMeta: null,
  lesson: null,
  dialogue: [],
  turn: 0,

  cloze: null, // { promptText, answerText, blankWord, options[] }
  lastSpoken: '',
  debugOn: false,

  // Speech
  recognition: null,
  recognizing: false,
};

/** ---------- Utils ---------- */
function showBanner(msg){
  banner.style.display = msg ? 'block' : 'none';
  banner.innerHTML = msg ? msg : '';
}
function setDebug(objOrStr){
  if(!state.debugOn) return;
  debugEl.style.display = 'block';
  debugEl.textContent = typeof objOrStr === 'string' ? objOrStr : JSON.stringify(objOrStr, null, 2);
}
function safeText(x){ return (x ?? '').toString(); }

function normalizeText(s){
  return safeText(s)
    .trim()
    .toLowerCase()
    .replace(/[â€œâ€"']/g,'')
    .replace(/\s+/g,' ')
    .replace(/[.,!?;:()]/g,'')
    ;
}
function compareAnswer(input, expected){
  return normalizeText(input) === normalizeText(expected);
}

function weekToNum(w){
  const m = /^W(\d{2,3})$/i.exec(w || '');
  return m ? parseInt(m[1],10) : 0;
}
function numToWeek(n){
  const s = String(n).padStart(2,'0');
  return `W${s}`;
}

function pickVoice(prefer){
  const voices = speechSynthesis.getVoices ? speechSynthesis.getVoices() : [];
  if(!voices.length) return null;

  // prefer: "Aria" / "Ana" / "Natasha" (best-effort in Browser TTS)
  const byName = voices.find(v => v.name.toLowerCase().includes(prefer.toLowerCase()));
  if(byName) return byName;

  // fallback: en-US
  const enus = voices.find(v => (v.lang || '').toLowerCase().startsWith('en-us'));
  if(enus) return enus;

  // fallback any en
  const en = voices.find(v => (v.lang || '').toLowerCase().startsWith('en'));
  return en || voices[0] || null;
}

function teacherToVoiceHint(t){
  // Browser voices are not Azure voices. We just approximate by searching names.
  if(t === 'Diana') return 'Ana';
  if(t === 'Emma') return 'Aria';
  if(t === 'Sophia') return 'Natasha';
  return 'en';
}

function speak(text){
  text = safeText(text);
  if(!text) return;
  try{
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    const hint = teacherToVoiceHint(teacherSelect.value);
    u.voice = pickVoice(hint);
    u.rate = 1.0;
    u.pitch = 1.0;
    u.onend = ()=>{ /* noop */ };
    speechSynthesis.speak(u);
    state.lastSpoken = text;
  }catch(e){
    console.warn(e);
  }
}

/** ---------- Access Profile ---------- */
async function getEmailFromSupabase(){
  try{
    if(!window.supabase || !window.supabase.createClient) return '';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const { data } = await sb.auth.getUser();
    const email = data?.user?.email || '';
    return email;
  }catch(e){
    return '';
  }
}

function getEmailFromStorage(){
  const keys = [
    'BW_EMAIL','BW_USER_EMAIL','bookwide_email','email','userEmail',
    'BW_AUTH_EMAIL'
  ];
  for(const k of keys){
    const v = localStorage.getItem(k);
    if(v && v.includes('@')) return v;
  }
  return '';
}

async function loadProfile(){
  const email = (await getEmailFromSupabase()) || getEmailFromStorage() || '';
  const isAdmin = email && ADMIN_EMAILS.has(email.toLowerCase());
  // Non-admin maxWeek can be controlled by localStorage (optional)
  const maxWeekLS = localStorage.getItem('BW_TALK_MAX_WEEK') || '';
  const maxWeek = /^W\d{2,3}$/i.test(maxWeekLS) ? maxWeekLS.toUpperCase() : '';
  state.profile = {
    email,
    isAdmin: !!isAdmin,
    maxWeek: maxWeek || 'W01'
  };
  userBadge.textContent = state.profile.email
    ? (state.profile.isAdmin ? `Adminï¼š${state.profile.email}` : state.profile.email)
    : 'æœªç™»å…¥';
}

/** ---------- Index Loading ---------- */
function validateIndexItem(it){
  if(!it || typeof it !== 'object') return 'not object';
  if(!it.week || !/^W\d{2,3}$/i.test(it.week)) return 'bad week';
  if(typeof it.lesson !== 'number') return 'bad lesson';
  if(!it.filename || !it.filename.endsWith('.json')) return 'bad filename';
  if(!it.file || !it.file.endsWith('.json')) return 'bad file';
  if(it.filename && it.file && !it.file.endsWith('/' + it.filename) && !it.file.endsWith(it.filename)) return 'file/filename mismatch';
  return '';
}

function buildIndexMaps(arr){
  state.indexRaw = arr;
  state.byWeek.clear();
  state.byId.clear();

  for(const it of arr){
    state.byId.set(it.id, it);
    const wk = it.week.toUpperCase();
    if(!state.byWeek.has(wk)) state.byWeek.set(wk, []);
    state.byWeek.get(wk).push(it);
  }
  // sort lessons
  for(const [wk, list] of state.byWeek.entries()){
    list.sort((a,b)=> (a.lesson||0) - (b.lesson||0));
  }
  // build weeks list sorted
  state.weeks = Array.from(state.byWeek.keys()).sort((a,b)=>weekToNum(a)-weekToNum(b));
}

function getVisibleWeeks(){
  if(state.profile.isAdmin) return state.weeks;
  const maxN = weekToNum(state.profile.maxWeek || 'W01');
  return state.weeks.filter(w => weekToNum(w) <= maxN);
}

/** ---------- Lesson Loading ---------- */
function resolveLessonUrl(meta){
  // meta.file can be like "/talk/w01.01....json"
  // meta.filename can be like "w01.01...json"
  const base = state.talkBaseUsed || TALK_BASE || '/talk';

  const f = safeText(meta?.file);
  if(f.startsWith('http')) return f;

  if(f.startsWith('/')){
    // If we're using an absolute http base (e.g. GitHub raw) and file is "/talk/xxx.json"
    if(base.startsWith('http') && f.startsWith('/talk/')){
      return base.replace(/\/$/, '') + '/' + f.slice('/talk/'.length);
    }
    return f;
  }

  if(f.startsWith('talk/')){
    if(base.startsWith('http')){
      return base.replace(/\/$/, '') + '/' + f.slice('talk/'.length);
    }
    return '/' + f;
  }

  const fn = safeText(meta?.filename);
  if(fn){
    return base.replace(/\/$/, '') + '/' + fn;
  }

  return '';
}

async function loadJson(url){
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok){
    const txt = await res.text().catch(()=> '');
    const err = new Error(`Fetch failed ${res.status} ${res.statusText}`);
    err.status = res.status;
    err.body = txt.slice(0,300);
    throw err;
  }
  return await res.json();
}

async function loadLesson(meta){
  const url = resolveLessonUrl(meta);
  if(!url) throw new Error('Invalid lesson url');
  const data = await loadJson(url);
  if(!data || !Array.isArray(data.dialogue)) throw new Error('Lesson JSON missing dialogue[]');
  state.lesson = data;
  state.dialogue = data.dialogue;
  state.turn = 0;
  renderAll();
}

/** ---------- Cloze / Options ---------- */
const STOPWORDS = new Set([
  'i','me','my','we','our','you','your','he','she','they','them','it','its',
  'a','an','the','to','of','and','or','but','so','for','with','in','on','at','from','as',
  'is','am','are','was','were','be','been','being',
  'do','did','does','can','could','will','would','should','may','might','must',
  'this','that','these','those',
  'please','yeah','yes','no','ok','okay','hi','hello','thanks','thank'
]);

function tokenizeWords(s){
  return safeText(s)
    .replace(/[^A-Za-z0-9'\- ]+/g,' ')
    .split(/\s+/)
    .map(x=>x.trim())
    .filter(Boolean);
}

function buildWordBankFromLesson(){
  const bank = new Set();
  for(const t of state.dialogue){
    const words = tokenizeWords(t.text);
    for(const w of words){
      const lw = w.toLowerCase();
      if(lw.length >= 4 && !STOPWORDS.has(lw)) bank.add(w);
    }
  }
  return Array.from(bank);
}

function chooseBlankWord(expected){
  const words = tokenizeWords(expected).filter(w=>{
    const lw = w.toLowerCase();
    return lw.length >= 4 && !STOPWORDS.has(lw) && !/^\d+$/.test(lw);
  });
  if(!words.length) return '';
  // prefer last meaningful word
  return words[words.length-1];
}

function makeCloze(expected){
  const blankWord = chooseBlankWord(expected);
  if(!blankWord){
    return { promptText: expected, answerText: expected, blankWord:'', options:[] };
  }
  const re = new RegExp(`\\b${blankWord.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}\\b`);
  const promptText = expected.replace(re, '___');
  const bank = buildWordBankFromLesson().filter(w=> w.toLowerCase() !== blankWord.toLowerCase());
  // pick 2 distractors
  const options = [blankWord];
  while(options.length < 3 && bank.length){
    const pick = bank.splice(Math.floor(Math.random()*bank.length), 1)[0];
    if(pick && !options.some(x=>x.toLowerCase()===pick.toLowerCase())) options.push(pick);
  }
  // if still not enough, add generic distractors
  const generic = ['gate','terminal','receipt','menu','charge','refund','upgrade','size','today'];
  for(const g of generic){
    if(options.length>=3) break;
    if(!options.some(x=>x.toLowerCase()===g)) options.push(g);
  }
  // shuffle
  for(let i=options.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [options[i],options[j]] = [options[j],options[i]];
  }
  return { promptText, answerText: expected, blankWord, options };
}

/** ---------- Rendering ---------- */
function setTeacherMedia(){
  const t = teacherSelect.value;
  teacherLabel.textContent = t;

  const src = TEACHERS[t] || TEACHERS.Emma;

  // Force refresh frames on file:// and cross-origin mp4
  if (teacherVideo.src !== src) {
    try { teacherVideo.pause(); } catch(e){}
    teacherVideo.src = src;
    try { teacherVideo.load(); } catch(e){}
  }

  const tryPlay = () => {
    try { teacherVideo.muted = true; } catch(e){}
    try { teacherVideo.playsInline = true; } catch(e){}
    teacherVideo.play().catch(()=>{});
  };

  tryPlay();
  setTimeout(tryPlay, 300);
}

function currentTurn(){
  return state.dialogue[state.turn] || null;
}

function setStatus(msg, type=''){
  statusEl.className = 'status ' + (type || '');
  statusEl.textContent = msg || '';
}

function splitZhJa(zhField){
  const raw = safeText(zhField);
  if(!raw) return '';
  // Many files store "ä¸­æ–‡ã€€æ—¥æ–‡" separated by newline
  return raw;
}

function renderTopMeta(){
  const wk = state.currentWeek || '';
  const count = state.byWeek.get(wk)?.length || 0;
  weekCount.textContent = String(count);
  progress.textContent = `${Math.min(state.turn+1, state.dialogue.length)}/${state.dialogue.length}`;
}

function renderLessonMeta(){
  const m = state.currentMeta;
  if(!m){
    lessonMetaEl.textContent = 'â€”';
    return;
  }
  const title = m.title_zh ? ` Â· ${m.title_zh}` : '';
  lessonMetaEl.textContent = `${m.week} Â· ${String(m.lesson).padStart(2,'0')} Â· ${m.scene || ''}${title} Â· ${m.filename || ''}`;
}

function renderTurn(){
  renderTopMeta();
  renderLessonMeta();

  const t = currentTurn();
  if(!t){
    aiText.textContent = 'ï¼ˆæ²’æœ‰å°è©±ï¼‰';
    aiSub.textContent = '';
    modeLabel.textContent = 'â€”';
    studentPrompt.textContent = 'â€”';
    chips.innerHTML = '';
    submitBtn.disabled = true;
    replyInput.disabled = true;
    return;
  }

  const role = safeText(t.role).toLowerCase();
  const isTeacher = role === 'teacher';

  // Main bubble always shows the current line (teacher/student expected)
  aiText.textContent = safeText(t.text) || 'â€”';
  aiSub.textContent = splitZhJa(t.zh);

  modeLabel.textContent = isTeacher ? 'Teacher' : 'Student';

  // Student UI
  if(isTeacher){
    // Disable answering UI
    studentPrompt.textContent = 'ï¼ˆç­‰å¾…ä½ æŒ‰ä¸‹ä¸€å¥ï¼Œæˆ–æŒ‰é‡æ’­è½ä¸€æ¬¡ï¼‰';
    chips.innerHTML = '';
    submitBtn.disabled = true;
    replyInput.disabled = true;
    replyInput.value = '';
    state.cloze = null;
    setStatus('');
    // auto speak
    speak(t.text);
  }else{
    // Build cloze for this expected student line
    state.cloze = makeCloze(t.text);
    const p = state.cloze.promptText;
    // Show blank underline nicely
    const html = p.replace('___', '<span class="blank">&nbsp;</span>');
    studentPrompt.innerHTML = html;

    // Options chips
    chips.innerHTML = '';
    for(const opt of (state.cloze.options || [])){
      const el = document.createElement('div');
      el.className = 'chip';
      el.textContent = opt;
      el.onclick = ()=>{
        if(state.cloze.blankWord){
          // fill blank word into input by replacing ___ or appending
          const current = replyInput.value.trim();
          if(!current){
            replyInput.value = state.cloze.promptText.replace('___', opt);
          }else{
            // try to replace last ___
            replyInput.value = current.replace('___', opt);
          }
        }else{
          replyInput.value = opt;
        }
        replyInput.focus();
      };
      chips.appendChild(el);
    }

    submitBtn.disabled = false;
    replyInput.disabled = false;
    // prefill prompt for easier editing
    replyInput.value = state.cloze.promptText;
    replyInput.focus();
    setStatus('');
  }
}

function renderAll(){
  setTeacherMedia();
  renderTopMeta();
  renderLessonMeta();
  renderTurn();
  setDebug({
    profile: state.profile,
    currentWeek: state.currentWeek,
    currentMeta: state.currentMeta,
    turn: state.turn,
    dialogueLen: state.dialogue.length,
    resolvedLessonUrl: state.currentMeta ? resolveLessonUrl(state.currentMeta) : ''
  });
}

/** ---------- Controls ---------- */
function populateWeekSelect(){
  const weeks = getVisibleWeeks();
  weekSelect.innerHTML = '';
  for(const w of weeks){
    const opt = document.createElement('option');
    opt.value = w;
    opt.textContent = w;
    weekSelect.appendChild(opt);
  }
  // pick last visible week by default
  state.currentWeek = weeks[weeks.length-1] || (state.weeks[0] || 'W01');
  weekSelect.value = state.currentWeek;
}

function populateLessonSelect(week){
  const list = state.byWeek.get(week) || [];
  lessonSelect.innerHTML = '';
  for(const m of list){
    const opt = document.createElement('option');
    opt.value = m.id;
    const code = `${m.week}.${String(m.lesson).padStart(2,'0')}`;
    const short = `${m.filename || m.id}`;
    opt.textContent = `${code}  ${short}`; // keep close to your current style
    lessonSelect.appendChild(opt);
  }
  // default first lesson
  const first = list[0] || null;
  if(first){
    lessonSelect.value = first.id;
    state.currentMeta = first;
  }else{
    state.currentMeta = null;
  }
}

async function onWeekChange(){
  const w = weekSelect.value;
  state.currentWeek = w;
  populateLessonSelect(w);
  if(state.currentMeta){
    await onLessonChange();
  }else{
    renderAll();
  }
}

async function onLessonChange(){
  const id = lessonSelect.value;
  const meta = state.byId.get(id);
  state.currentMeta = meta || null;
  if(!meta){
    showBanner(`<strong>æ‰¾ä¸åˆ°èª²ç¨‹ï¼š</strong>${id}`);
    renderAll();
    return;
  }
  showBanner('');
  try{
    aiText.textContent = 'Loadingâ€¦';
    aiSub.textContent = '';
    setStatus('');
    const url = resolveLessonUrl(meta);
    await loadLesson(meta);
  }catch(e){
    console.error(e);
    const url = state.currentMeta ? resolveLessonUrl(state.currentMeta) : '';
    showBanner(`<strong>è®€å–å¤±æ•—ï¼š</strong>${url}<br>(${e.message || e})<br><span style="color:#6b7280">è«‹ç¢ºèªæª”æ¡ˆæ˜¯å¦å­˜åœ¨æ–¼ /talk/ ä»¥åŠ index.json çš„ file/filename æ˜¯å¦æ­£ç¢ºã€‚</span>`);
    setDebug({error: String(e), url, status: e.status, body: e.body});
  }
}

function nextTurn(){
  if(state.turn < state.dialogue.length - 1){
    state.turn += 1;
    renderTurn();
  }else{
    setStatus('æœ¬èª²å®Œæˆ âœ…ï¼ˆå¯æŒ‰ã€Œé‡ä¾†ã€å†ç·´ä¸€æ¬¡ï¼‰','good');
  }
}

function prevOrRestart(){
  state.turn = 0;
  renderTurn();
}

/** ---------- Student Flow ---------- */
function revealHint(){
  const t = currentTurn();
  if(!t || safeText(t.role).toLowerCase() !== 'student') return;
  // Put full correct answer into input
  replyInput.value = t.text;
  replyInput.focus();
  setStatus('å·²é¡¯ç¤ºæç¤ºï¼ˆå®Œæ•´å¥ï¼‰','');
}

function submitAnswer(){
  const t = currentTurn();
  if(!t || safeText(t.role).toLowerCase() !== 'student') return;

  const input = replyInput.value;
  const expected = t.text;
  if(compareAnswer(input, expected)){
    setStatus('æ­£ç¢º âœ…','good');
    // advance
    setTimeout(()=> nextTurn(), 250);
  }else{
    // If input still has ___, nudge
    if(input.includes('___')){
      setStatus('é‚„æ²’å¡«å®Œç©ºæ ¼å–”ï¼ˆé»é¸ä¸Šæ–¹é¸é …æˆ–æŒ‰æç¤ºï¼‰','bad');
    }else{
      setStatus('å†è©¦ä¸€æ¬¡ï½ï¼ˆå¯æŒ‰æç¤ºï¼‰','bad');
    }
  }
}

/** ---------- Speech Recognition (Optional) ---------- */
function setupRecognition(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR) return;
  const r = new SR();
  r.lang = 'en-US';
  r.interimResults = false;
  r.maxAlternatives = 1;
  r.onresult = (evt)=>{
    const txt = evt.results?.[0]?.[0]?.transcript || '';
    if(txt){
      // If student turn, paste into input; else ignore
      const t = currentTurn();
      if(t && safeText(t.role).toLowerCase()==='student'){
        replyInput.value = txt;
        submitAnswer();
      }else{
        // for teacher turn, treat as "next"
        nextTurn();
      }
    }
  };
  r.onend = ()=>{
    state.recognizing = false;
    micBtn.textContent = 'ğŸ¤';
  };
  r.onerror = ()=>{
    state.recognizing = false;
    micBtn.textContent = 'ğŸ¤';
  };
  state.recognition = r;
}

function toggleMic(){
  if(!state.recognition){
    setStatus('æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼ˆå¯ç›´æ¥è¼¸å…¥ï¼‰','');
    return;
  }
  if(state.recognizing){
    try{ state.recognition.stop(); }catch(e){}
    state.recognizing=false;
    micBtn.textContent='ğŸ¤';
    return;
  }
  state.recognizing=true;
  micBtn.textContent='âº';
  try{ state.recognition.start(); }catch(e){
    state.recognizing=false;
    micBtn.textContent='ğŸ¤';
  }
}


function extractIndexArray(raw){
  if(Array.isArray(raw)) return raw;
  if(raw && typeof raw === 'object'){
    const keys = ['index','items','data','rows','lessons','records'];
    for(const k of keys){
      if(Array.isArray(raw[k])) return raw[k];
    }
  }
  return null;
}

async function loadIndexWithProbe(){
  // If running from file://, the site-relative /talk won't exist. Prefer an absolute base.
  const isFile = location.protocol === 'file:';
  const bases = isFile
    ? [TALK_BASES[1], TALK_BASES[0]].filter(Boolean)
    : TALK_BASES.slice();

  let lastErr = null;

  for(const base of bases){
    const baseClean = (base || '').replace(/\/$/, '');
    const urls = [
      `${baseClean}/index.json`,
      `${baseClean}/index.json?ts=` + Date.now(),
    ];

    for(const url of urls){
      try{
        const raw = await loadJson(url);
        const arr = extractIndexArray(raw);
        if(!arr){
          lastErr = new Error('index.json must be an array');
          lastErr.raw = raw;
          lastErr.url = url;
          continue;
        }
        // record chosen base for later lesson fetching
        state.talkBaseUsed = baseClean;
        TALK_BASE = baseClean;
        INDEX_URL = `${baseClean}/index.json`;
        return { url, arr, raw, base: baseClean };
      }catch(e){
        lastErr = e;
        lastErr.url = url;
        continue;
      }
    }
  }

  throw lastErr || new Error('Failed to load index.json');
}

/** ---------- Init ---------- */
async function init(){
  showBanner('');
  setTeacherMedia();
  setupRecognition();

  // Load profile first (for week visibility)
  await loadProfile();

  // Load index
  try{
    const { url: usedIndexUrl, arr, raw } = await loadIndexWithProbe();

    // Validate a few rows (soft)
    const bad = [];
    for(let i=0;i<Math.min(arr.length, 30);i++){
      const err = validateIndexItem(arr[i]);
      if(err) bad.push({i, id: arr[i]?.id, err});
    }
    if(bad.length){
      console.warn('Index validation warnings:', bad);
    }

    buildIndexMaps(arr);

    // If not admin and maxWeek not set, default to the last week in index (safer for testing)
    if(!state.profile.isAdmin){
      const ls = localStorage.getItem('BW_TALK_MAX_WEEK');
      if(!ls){
        const latest = state.weeks[state.weeks.length-1] || 'W01';
        state.profile.maxWeek = latest;
      }
    }

    populateWeekSelect();
    populateLessonSelect(state.currentWeek);
    await onLessonChange();

    // show in debug
    setDebug({ indexUrlUsed: usedIndexUrl, talkBaseUsed: state.talkBaseUsed, sample: arr[0] });

  }catch(e){catch(e){
    console.error(e);
    showBanner(`<strong>è¼‰å…¥ index.json å¤±æ•—ï¼š</strong>${INDEX_URL}<br>(${e.message || e})<br><span style="color:#6b7280">è«‹ç¢ºèª talk_A.html èˆ‡ /talk/index.json åŒç¶²åŸŸå¯å­˜å–ã€‚</span>`);
    setDebug({error: String(e), indexUrl: INDEX_URL});
  }
}

/** ---------- Events ---------- */
weekSelect.addEventListener('change', ()=> onWeekChange());
lessonSelect.addEventListener('change', ()=> onLessonChange());
teacherSelect.addEventListener('change', ()=>{
  setTeacherMedia();
  // replay current line with new voice
  const t = currentTurn();
  if(t) speak(t.text);
});
speakBtn.addEventListener('click', ()=>{
  const t = currentTurn();
  if(t) speak(t.text);
});
replayBtn.addEventListener('click', ()=>{
  const t = currentTurn();
  if(t) speak(t.text);
});
nextBtn.addEventListener('click', ()=> nextTurn());
skipBtn.addEventListener('click', ()=> nextTurn());
hintBtn.addEventListener('click', ()=> revealHint());
submitBtn.addEventListener('click', ()=> submitAnswer());
retryBtn.addEventListener('click', ()=> prevOrRestart());
micBtn.addEventListener('click', ()=> toggleMic());
replyInput.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){ e.preventDefault(); submitAnswer(); }
});
debugBtn.addEventListener('click', ()=>{
  state.debugOn = !state.debugOn;
  debugEl.style.display = state.debugOn ? 'block' : 'none';
  if(state.debugOn) setDebug({note:'debug on'});
});
inputModeBtn.addEventListener('click', ()=>{
  replyInput.focus();
  setStatus('');
});

// iOS Safari sometimes loads voices async
if (window.speechSynthesis && speechSynthesis.onvoiceschanged !== undefined) {
  speechSynthesis.onvoiceschanged = ()=>{/* noop */};
}

init();
</script>
</body>
</html>
