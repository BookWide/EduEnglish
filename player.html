<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BookWide Player · Slim v2</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#141821; --muted:#1b2030; --text:#e8ecf1; --sub:#9fb0c3;
      --accent:#4ea1ff; --ok:#25c18a; --ng:#ff6b6b;
      --h:56px;  /* header fixed 高度 */
      --f:74px;  /* footer fixed 高度（工具列） */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text); font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      overflow:hidden; /* 讓主區域自己滾動 */
    }
    /* Header 固定 */
    .topbar{
      position:fixed; inset:0 0 auto 0; height:var(--h);
      display:flex; align-items:center; gap:12px; padding:0 14px;
      background:rgba(10,12,18,.9); border-bottom:1px solid #1f2636; backdrop-filter:saturate(130%) blur(6px);
      z-index:10;
    }
    .topbar .title{font-weight:700}
    .crumb{display:inline-flex; gap:8px; padding:2px 8px; border-radius:999px; background:#182132; color:#c9d6e6; font-size:12px}

    /* Footer 工具列固定 */
    .toolbar{
      position:fixed; inset:auto 0 0 0; height:var(--f);
      display:flex; align-items:center; gap:10px; padding:10px 12px;
      background:rgba(10,12,18,.92); border-top:1px solid #1f2636; z-index:10;
    }
    .toolbar .btn{min-width:72px}
    .toolbar .range{flex:1}

    /* 主區域：左右 50/50；中間捲動 */
    .main{
      position:fixed; inset:var(--h) 0 var(--f) 0; display:grid; grid-template-columns:1fr 1fr; gap:10px; padding:10px;
    }
    /* 左：影片容器，內容等比置中，遇直立影片會留黑邊 */
    #videoWrap{
      background:#000; border-radius:10px; overflow:hidden; display:flex; align-items:center; justify-content:center;
      outline:1px solid #1b2233;
    }
    video, iframe{width:100%; height:100%; object-fit:contain; background:#000}
    video{outline:none}

    /* 右：分頁 */
    .pane{
      background:var(--panel); border-radius:10px; outline:1px solid #1b2233; display:flex; flex-direction:column; overflow:hidden;
    }
    .tabs{display:flex; gap:2px; background:#0e1320; border-bottom:1px solid #1f2636}
    .tabs button{
      flex:1; padding:10px 12px; color:#c8d6ea; background:transparent; border:0; cursor:pointer; font-weight:600;
    }
    .tabs button.active{background:#182032; color:#fff}
    .pane-body{flex:1; overflow:auto; padding:10px 12px}
    .badge{display:inline-block; padding:4px 10px; border-radius:999px; background:#1d2740; color:#b9c7de; font-size:12px}

    /* 字幕清單 */
    .cue{padding:10px 10px; border-radius:8px; border:1px solid #21283a; margin:6px 0; cursor:pointer}
    .cue:hover{border-color:#2f3c56; background:#151c2a}
    .cue .en{font-weight:700}
    .cue .zh{color:#a9bad3}

    /* 測驗 */
    .chips{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 10px}
    .chip{padding:6px 10px; border-radius:999px; background:#1b2233; color:#cfe0ff; border:1px solid #223048; cursor:pointer}
    .chip.active{background:#21406b; border-color:#2d70ff}
    .quiz-header{display:flex; justify-content:space-between; align-items:center; gap:12px}
    .quiz-actions{display:flex; gap:8px}
    .btn{background:#1a2235; color:#e6f0ff; border:1px solid #2a3a58; border-radius:8px; padding:8px 12px; cursor:pointer}
    .btn:hover{background:#212c46}
    .q{border:1px solid #22314b; border-radius:10px; padding:10px; margin:10px 0}
    .q-title{font-weight:700; margin-bottom:8px}
    .q-opts{display:grid; gap:8px}
    .opt{display:flex; gap:8px; align-items:center; background:#121a2a; border:1px solid #1f2a40; padding:8px 10px; border-radius:8px}
    .q.ok{outline:2px solid var(--ok)}
    .q.ng{outline:2px solid var(--ng)}
    .q-feedback{margin-top:8px; color:#c8d9ff}
    .q-feedback .ans{color:#fff}
    input[type="text"]{width:min(520px,100%); padding:8px 10px; border-radius:8px; border:1px solid #2a3a58; background:#12182a; color:#edf3ff}

    /* 單字表 */
    .vocab{display:grid; grid-template-columns:1fr auto; gap:6px; padding:8px 10px; border:1px solid #22314b; border-radius:10px; margin:8px 0}
    .vocab .ph{color:#9eb4ce}

    /* 工具小件 */
    .btn.small{padding:6px 10px; font-size:13px}
    .split{width:1px; height:26px; background:#25314a; margin:0 6px}
    .hint{color:#9fb0c3; font-size:12px}
  </style>
</head>
<body>
  <!-- Header -->
  <div class="topbar">
    <span class="title">BookWide Player · Slim v2</span>
    <span id="crumbs" class="crumb">cat=<b>story</b> · slug=<b>mid-autumn</b></span>
  </div>

  <!-- Main -->
  <div class="main">
    <div id="videoWrap">
      <video id="player" controls preload="metadata"></video>
    </div>

    <div class="pane" id="rightPane">
      <div class="tabs">
        <button data-tab="cues" class="active">字幕</button>
        <button data-tab="quiz">測驗</button>
        <button data-tab="vocab">單字</button>
        <button data-tab="ai">AI 互動</button>
      </div>
      <div class="pane-body" id="pane-cues"></div>
      <div class="pane-body" id="pane-quiz" hidden></div>
      <div class="pane-body" id="pane-vocab" hidden></div>
      <div class="pane-body" id="pane-ai" hidden></div>
    </div>
  </div>

  <!-- Footer 工具列 -->
  <div class="toolbar">
    <button id="btnPrev" class="btn">上一句</button>
    <button id="btnPlay" class="btn">播放/暫停</button>
    <button id="btnNext" class="btn">下一句</button>
    <button id="btnRepeat" class="btn">重複本句</button>
    <div class="split"></div>
    <label class="btn small"><input id="chkFollow" type="checkbox" checked> 跟隨</label>
    <div class="btn small" id="btnShiftNeg">-0.5s</div>
    <div class="btn small" id="btnShiftPos">+0.5s</div>
    <div class="split"></div>
    <span class="hint">速度</span>
    <input id="rate" class="range" type="range" min="0.5" max="2" step="0.05" value="1.0"/>
    <span id="rateVal" class="hint">1.00x</span>
    <div class="split"></div>
    <button id="btnCalibrate" class="btn">完成校準</button>
  </div>

  <script>
    // -----------------------------
    // 參數與基本工具
    // -----------------------------
    const params = new URLSearchParams(location.search);
    const cat  = (params.get('cat')  || 'story').toLowerCase();   // story / music / movie / news / pro
    const slug = (params.get('slug') || 'mid-autumn');

    document.getElementById('crumbs').innerHTML =
      `cat=<b>${cat}</b> · slug=<b>${slug}</b>`;

    const elVideo = document.getElementById('player');
    const elPaneCues  = document.getElementById('pane-cues');
    const elPaneQuiz  = document.getElementById('pane-quiz');
    const elPaneVocab = document.getElementById('pane-vocab');
    const elPaneAI    = document.getElementById('pane-ai');

    function $(sel,root=document){ return root.querySelector(sel) }
    function $all(sel,root=document){ return [...root.querySelectorAll(sel)] }
    async function fetchJSON(url){
      const r = await fetch(url, {cache:'no-store'});
      if(!r.ok) throw new Error(`HTTP ${r.status} on ${url}`);
      return r.json();
    }
    const sleep = ms=>new Promise(r=>setTimeout(r,ms));

    // -----------------------------
    // 影片載入（先 cat/ 再根）
    // -----------------------------
    async function loadVideo(){
      const srcA = `./videos/${cat}/${slug}.mp4`;
      const srcB = `./videos/${slug}.mp4`;
      const okA = await fetch(srcA, {method:'HEAD'}).then(r=>r.ok).catch(()=>false);
      const final = okA ? srcA : srcB;
      elVideo.src = final;
      elVideo.play().catch(()=>{ /* 靜音自動播放可能被擋，無妨 */ });
    }

    // -----------------------------
    // 字幕（story 格式：[{start,end,en,zh}]）
    // -----------------------------
    let cues = [];           // 供工具列控制使用
    let curIdx = 0;
    let timeShift = 0;       // 校準偏移（秒）

    async function loadCues(){
      const url = `./data/${cat}/cues-${slug}.json`;
      cues = await fetchJSON(url);               // 直接吃你統一格式
      renderCues();
      tickFollow();                              // 啟動跟隨
    }

    function renderCues(){
      elPaneCues.innerHTML = cues.map((c,i)=>`
        <div class="cue" data-i="${i}">
          <div class="en">${escapeHtml(c.en||'')}</div>
          <div class="zh">${escapeHtml(c.zh||'')}</div>
        </div>
      `).join('');
      // 點句跳播
      $all('.cue', elPaneCues).forEach(div=>{
        div.addEventListener('click', ()=>{
          const i = +div.dataset.i;
          const t = (cues[i]?.start ?? 0) + timeShift;
          elVideo.currentTime = Math.max(0, t);
          elVideo.play();
          curIdx = i;
          if ($('#chkFollow').checked) div.scrollIntoView({block:'center',behavior:'smooth'});
        });
      });
    }

    function escapeHtml(s){return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}

    function tickFollow(){
      const loop = ()=>{
        const t = elVideo.currentTime - timeShift;
        // 找到當前句
        for(let i=0;i<cues.length;i++){
          const c = cues[i];
          if (t>=c.start && t<c.end){ curIdx = i; break; }
        }
        // 高亮可加樣式(簡化：靠滾動居中)
        if ($('#chkFollow').checked){
          const node = $(`.cue[data-i="${curIdx}"]`, elPaneCues);
          if (node) node.scrollIntoView({block:'center'});
        }
        requestAnimationFrame(loop);
      };
      requestAnimationFrame(loop);
    }

    // 工具列控制
    $('#btnPrev').addEventListener('click', ()=>{
      curIdx = Math.max(0, curIdx-1);
      elVideo.currentTime = Math.max(0, (cues[curIdx]?.start || 0) + timeShift);
      elVideo.play();
    });
    $('#btnNext').addEventListener('click', ()=>{
      curIdx = Math.min(cues.length-1, curIdx+1);
      elVideo.currentTime = Math.max(0, (cues[curIdx]?.start || 0) + timeShift);
      elVideo.play();
    });
    $('#btnPlay').addEventListener('click', ()=> elVideo.paused ? elVideo.play() : elVideo.pause());
    $('#btnRepeat').addEventListener('click', ()=>{
      const c = cues[curIdx]; if(!c) return;
      elVideo.currentTime = Math.max(0, c.start + timeShift);
      const end = c.end + timeShift;
      elVideo.play();
      const once = ()=>{
        if (elVideo.currentTime >= end - 0.03){
          elVideo.pause();
          elVideo.currentTime = Math.max(0, c.start + timeShift);
          elVideo.play();
        } else requestAnimationFrame(once);
      };
      requestAnimationFrame(once);
    });
    $('#btnShiftNeg').addEventListener('click', ()=>{ timeShift -= .5; toastShift(); });
    $('#btnShiftPos').addEventListener('click', ()=>{ timeShift += .5; toastShift(); });
    $('#rate').addEventListener('input', e=>{
      elVideo.playbackRate = +e.target.value;
      $('#rateVal').textContent = `${(+e.target.value).toFixed(2)}x`;
    });
    $('#btnCalibrate').addEventListener('click', ()=> alert(`校準完成：${timeShift.toFixed(2)}s`));
    function toastShift(){ /* 可自行換成浮動吐司 */
      $('#btnCalibrate').textContent = `完成校準（偏移 ${timeShift.toFixed(2)}s）`;
    }

    // -----------------------------
    // 測驗（直接使用你的 quiz-*.json）
    // -----------------------------
    const I18N = {
      sections: { Vocabulary:'單字', Grammar:'文法', Reading:'閱讀', Mixed:'綜合' },
      submit:'交卷', reveal:'顯示答案', print:'列印成績單', score:'本分區分數：', correct:'正解', wrong:'錯誤'
    };

    async function loadQuiz(){
      const url = `./data/${cat}/quiz-${slug}.json`;
      const data = await fetchJSON(url);               // 你的既有格式：Array<Question>
      renderQuiz(data);
    }

    function renderQuiz(items){
      if (!Array.isArray(items)){ elPaneQuiz.innerHTML = `<div class="badge">測驗載入格式錯誤</div>`; return; }
      // 依 section 分組
      const group = {};
      for (const q of items) (group[q.section||'Mixed'] ||= []).push(q);
      const secs = Object.keys(group);
      const chips = secs.map(k=>`<button class="chip" data-sec="${k}">${I18N.sections[k]||k} (${group[k].length})</button>`).join('');
      elPaneQuiz.innerHTML = `
        <div class="quiz-header">
          <div class="chips">${chips}</div>
          <div class="quiz-actions">
            <button id="quizSubmit" class="btn">${I18N.submit}</button>
            <button id="quizReveal" class="btn">${I18N.reveal}</button>
            <button id="quizPrint" class="btn">${I18N.print}</button>
          </div>
        </div>
        <div id="quizBody"></div>
        <div id="quizScore" class="quiz-score"></div>
      `;

      const mount = (sec)=>{
        const list = group[sec]||[];
        $('#quizBody', elPaneQuiz).innerHTML = list.map((q,i)=> renderQ(q,i)).join('');
        $('#quizScore', elPaneQuiz).textContent = `${I18N.score} 0 / ${list.length*5}`;
      };
      $all('.chip', elPaneQuiz).forEach(btn=>{
        btn.addEventListener('click', ()=>{
          $all('.chip', elPaneQuiz).forEach(b=>b.classList.remove('active'));
          btn.classList.add('active'); mount(btn.dataset.sec);
        });
      });
      // 預設第一區
      $(`.chip`, elPaneQuiz)?.click();

      $('#quizSubmit', elPaneQuiz).addEventListener('click', ()=>{
        const active = $('.chip.active', elPaneQuiz)?.dataset.sec;
        const list = group[active]||[];
        const nodes = $all('#quizBody .q', elPaneQuiz);
        let score = 0;
        nodes.forEach((node,i)=>{
          const ans = (list[i]?.answer ?? '').toString().trim();
          const exp = list[i]?.explanation ?? '';
          let ok=false, your='';

          if (node.classList.contains('mcq')){
            your = node.querySelector('input[type=radio]:checked')?.value ?? '';
            ok = your.toLowerCase() === ans.toLowerCase();
          }else{
            your = node.querySelector('input')?.value ?? '';
            ok = your.trim().toLowerCase() === ans.toLowerCase();
          }
          node.classList.remove('ok','ng');
          node.classList.add(ok?'ok':'ng');
          node.querySelector('.q-feedback').innerHTML =
            (ok?'✅ ':'❌ ')+ (ok?'':`${I18N.wrong} `)+
            `<span class="ans">${I18N.correct}：${escapeHtml(ans)}</span>`+
            (exp? `<div class="exp">${escapeHtml(exp)}</div>`:'');
          if (ok) score += 5;
        });
        $('#quizScore', elPaneQuiz).textContent = `${I18N.score} ${score} / ${nodes.length*5}`;
      });
      $('#quizReveal', elPaneQuiz).addEventListener('click', ()=>{
        $all('#quizBody .q', elPaneQuiz).forEach(node=>{
          const ans = node.dataset.ans || '';
          node.querySelector('.q-feedback').innerHTML = `🧠 <span class="ans">${I18N.correct}：${escapeHtml(ans)}</span>`;
        });
      });
      $('#quizPrint', elPaneQuiz).addEventListener('click', ()=>window.print());

      function renderQ(q, idx){
        const num = idx+1, t = (q.type||'MCQ').toUpperCase();
        if (t==='SA'){
          return `
          <div class="q sa" data-ans="${escapeHtml(q.answer||'')}">
            <div class="q-title">${num}. ${escapeHtml(q.question||'')}</div>
            <div class="q-input"><input type="text" placeholder="輸入答案…">
              <button class="btn small check">檢查</button></div>
            <div class="q-feedback"></div>
          </div>`;
        }
        const ops = (q.options||[]).map(o=>`
          <label class="opt">
            <input type="radio" name="q${idx}" value="${escapeHtml(String(o))}">
            <span>${escapeHtml(String(o))}</span>
          </label>`).join('');
        return `
          <div class="q mcq" data-ans="${escapeHtml(q.answer||'')}">
            <div class="q-title">${num}. ${escapeHtml(q.question||'')}</div>
            <div class="q-opts">${ops}</div>
            <div class="q-feedback"></div>
          </div>`;
      }
    }

    // -----------------------------
    // 單字（若無檔顯示空狀態）
    // -----------------------------
    async function loadVocab(){
      const url = `./data/${cat}/vocab-${slug}.json`;
      try{
        const list = await fetchJSON(url);  // array: [{word, phonetic, zh}] 任你既有
        if (!Array.isArray(list) || !list.length){
          elPaneVocab.innerHTML = `<div class="badge">暫無單字資料</div>`; return;
        }
        elPaneVocab.innerHTML = list.map(v=>`
          <div class="vocab">
            <div><b>${escapeHtml(v.word||'')}</b> <span class="ph">${escapeHtml(v.phonetic||'')}</span></div>
            <div>${escapeHtml(v.zh||'')}</div>
          </div>
        `).join('');
      }catch{
        elPaneVocab.innerHTML = `<div class="badge">暫無單字資料</div>`;
      }
    }

    // -----------------------------
    // AI 互動（若無檔顯示空狀態）
    // -----------------------------
    async function loadAI(){
      const url = `./data/${cat}/ai-${slug}.json`;
      try{
        const js = await fetchJSON(url); // 自由結構：{topics:[{title,prompt,hint,sample}]}
        const topics = js?.topics || [];
        if (!topics.length){ elPaneAI.innerHTML = `<div class="badge">暫無 AI 資料</div>`; return;}
        elPaneAI.innerHTML = topics.map(t=>`
          <div class="q">
            <div class="q-title">${escapeHtml(t.title||'')}</div>
            <div class="hint">提示：${escapeHtml(t.hint||'')}</div>
            <div class="q-feedback">示例：${escapeHtml(t.sample||'')}</div>
          </div>
        `).join('');
      }catch{
        elPaneAI.innerHTML = `<div class="badge">暫無 AI 資料</div>`;
      }
    }

    // -----------------------------
    // 分頁切換
    // -----------------------------
    $all('.tabs button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        $all('.tabs button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.dataset.tab;
        $('#pane-cues').hidden  = tab!=='cues';
        $('#pane-quiz').hidden  = tab!=='quiz';
        $('#pane-vocab').hidden = tab!=='vocab';
        $('#pane-ai').hidden    = tab!=='ai';
      });
    });

    // -----------------------------
    // 守門（你若有原本 JS，可在此呼叫）
    // -----------------------------
    async function initGate(){ /* 預留：你的 player-guard.js 可在這裡掛載 */ }

    // -----------------------------
    // 啟動
    // -----------------------------
    (async function boot(){
      await initGate();
      await Promise.allSettled([
        loadVideo(),
        loadCues(),
        loadQuiz(),
        loadVocab(),
        loadAI()
      ]);
    })();
  </script>
</body>
</html>

















































