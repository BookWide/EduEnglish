
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>BookWide Player · Slim v2 (Two-Page Mobile)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0f1a24;
  --bg-2:#111c28;
  --panel:#102232;
  --muted:#7da0b8;
  --txt:#e8f1f7;
  --acc:#2dd4bf;
  --btn:#183449;
  --btn2:#1f4060;
  --tab:#142b3d;
  --ok:#22c55e;
  --err:#ef4444;
  --border:rgba(255,255,255,.08);
}
*{box-sizing:border-box}
html,body{height:100%;background:var(--bg);color:var(--txt);font-family:"Noto Sans TC",system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
a{color:var(--txt);text-decoration:none}
.badge{display:inline-block;padding:.2rem .5rem;border:1px solid var(--border);border-radius:.5rem;background:rgba(255,255,255,.04);color:var(--muted);font-size:.85rem}
.btn{display:inline-flex;align-items:center;gap:.4rem;padding:.5rem .8rem;border-radius:.6rem;background:var(--btn);border:1px solid var(--border);cursor:pointer}
.btn:active{transform:translateY(1px)}
.btn.pri{background:var(--acc);color:#06221f;border-color:#0b3c35}
.icon{width:1.1rem;height:1.1rem;opacity:.9}

.topbar{position:sticky;top:0;z-index:20;display:flex;align-items:center;gap:.8rem;padding:12px 16px;background:linear-gradient(180deg,#0d1720,#0d1720f0 70%,#0d172000);backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid var(--border)}
.topbar h1{font-size:1.05rem;margin:0 8px 0 0;color:#cfe9f6}
.topbar .spacer{flex:1}

.shell{height:calc(100dvh - 56px);display:flex;gap:12px;padding:12px}
.left,.right{background:var(--panel);border:1px solid var(--border);border-radius:14px;overflow:hidden}
.left{flex:1;min-width:0;display:flex;flex-direction:column}
.right{flex:1;min-width:0;display:flex;flex-direction:column}

.videoWrap{position:relative;aspect-ratio:16/9;background:#06090f}
video,iframe{width:100%;height:100%;display:block;background:black}
.tools{border-top:1px solid var(--border);padding:10px;background:linear-gradient(180deg,#0f2232,#0c1b29)}
.tools .row{display:flex;gap:8px;flex-wrap:wrap}
.tools .row label{display:flex;align-items:center;gap:.5rem;background:var(--btn);border:1px solid var(--border);padding:.45rem .6rem;border-radius:.55rem;color:#d9e8f1}
.tools input[type="range"]{width:260px}

.tabs{display:flex;gap:8px;padding:8px;background:var(--tab);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10}
.tabs button{background:var(--btn2);border:1px solid var(--border);color:#cfe4f6;padding:.5rem .8rem;border-radius:.55rem;cursor:pointer}
.tabs button.active{background:#0b2a40;border-color:#1e90ff;color:#abdcff}
.pane{flex:1;min-height:0;overflow:auto;padding:12px}
.sectionTitle{font-weight:700;margin:6px 0 10px;font-size:1rem;color:#cfe4f6}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--border);padding:10px;vertical-align:top}
.table th{color:#9cc7df;font-weight:600}

.qwrap{display:flex;flex-direction:column;gap:16px}
.q{border:1px solid var(--border);border-radius:10px;background:rgba(255,255,255,.02);padding:12px}
.q .title{font-weight:600;margin-bottom:8px}
.options{display:flex;flex-direction:column;gap:6px}
.options label{display:flex;gap:8px;align-items:center}
.kv{display:flex;flex-direction:column;gap:10px}
.card{border:1px solid var(--border);background:rgba(255,255,255,.02);border-radius:10px;padding:12px}
.small{font-size:.9rem;color:#a9c7da}
.right .pane h3{margin:.6rem 0}

.footerSwitch{display:none}

@media (max-width: 820px){
  /* two-page mobile: use scroll-snap */
  .shell{padding:0;height:calc(100dvh - 56px)}
  .left,.right{border-radius:0;border:none;height:100%;width:100%}
  .carousel{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;width:100%;height:100%}
  .carousel > section{width:100%;height:100%;flex:0 0 100%;scroll-snap-align:start}
  .tabs{top:0}
  .footerSwitch{position:sticky;bottom:0;display:flex;gap:8px;justify-content:center;padding:8px;background:linear-gradient(0deg,#0d1720,#0d1720cc 70%,#0d172000);border-top:1px solid var(--border);z-index:30}
}

@media print{
  .topbar,.left,.footerSwitch{display:none}
  .right{border:none}
  body{background:#fff;color:#000}
  .pane{background:#fff;color:#000}
  .tabs{position:static;background:#fff;border:1px solid #ccc}
  .tabs button{background:#fff;border:1px solid #aaa;color:#000}
}
</style>
</head>
<body>
<header class="topbar">
  <a class="btn" href="index.html" id="btnHome">
    <svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M10 19v-5h4v5h5v-7h3L12 3 2 12h3v7z"/></svg>
    回首頁
  </a>
  <h1>播放器</h1>
  <div class="spacer"></div>
  <span class="badge">cat=<span id="dbgCat">?</span></span>
  <span class="badge">slug=<span id="dbgSlug">?</span></span>
</header>

<main class="shell">
  <div class="carousel" id="carousel">
    <!-- 左頁：影片 + 工具列 -->
    <section class="left">
      <div class="videoWrap" id="videoWrap">
        <video id="video" controls crossorigin="anonymous"></video>
      </div>
      <div class="tools">
        <div class="row">
          <button class="btn" id="btnPrevSent">⬅️ 上一句</button>
          <button class="btn" id="btnPlay">▶️ 播放 / 暫停</button>
          <button class="btn" id="btnNextSent">下一句 ➡️</button>
          <label><input type="checkbox" id="cbRepeat"/> 重複本句</label>
          <label><input type="checkbox" id="cbFollow"/> 跟隨</label>
          <span class="badge">偏移 <span id="offsetLabel">0.0</span>s</span>
          <button class="btn" id="btnOffMinus">-0.5s</button>
          <button class="btn" id="btnOffPlus">+0.5s</button>
          <label>速度 <input type="range" id="speed" min="0.5" max="1.75" step="0.05" value="1"/></label>
          <button class="btn" id="btnCalib">🧭 簡易校準</button>
        </div>
      </div>
    </section>

    <!-- 右頁：四分頁 -->
    <section class="right">
      <nav class="tabs">
        <button data-tab="subs" class="active">字幕</button>
        <button data-tab="quiz">測驗</button>
        <button data-tab="vocab">單字</button>
        <button data-tab="ai">AI 互動</button>
      </nav>
      <div class="pane" id="pane-subs" role="region" aria-label="字幕">
        <div class="sectionTitle">已載入字幕（<span id="subtitleInfo">—</span>）</div>
        <table class="table" id="tblSubs">
          <thead><tr><th style="width:80px">時間</th><th>英文</th><th>中文</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="pane" id="pane-quiz" hidden>
        <div class="sectionTitle">測驗分區</div>
        <div class="small" id="quizMeta"></div>
        <div style="margin:8px 0; display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn" data-qbucket="Vocabulary">Vocabulary</button>
          <button class="btn" data-qbucket="Grammar">Grammar</button>
          <button class="btn" data-qbucket="Reading">Reading</button>
          <button class="btn" data-qbucket="Mixed">Mixed</button>
          <button class="btn pri" id="btnSubmit">交卷</button>
          <button class="btn" id="btnShowAns">顯示答案</button>
          <button class="btn" id="btnPrint">列印成績單</button>
        </div>
        <div class="qwrap" id="quizWrap"></div>
        <div style="margin-top:10px" class="badge">本分區分數：<span id="score">0</span> / 100</div>
      </div>
      <div class="pane" id="pane-vocab" hidden>
        <h3>已載入單字（<span id="vocabInfo">—</span>）</h3>
        <div class="kv" id="vocabWrap"></div>
      </div>
      <div class="pane" id="pane-ai" hidden>
        <h3>AI 互動</h3>
        <div id="aiWrap" class="card"><span class="badge">暫無 AI 資料</span></div>
      </div>
      <div class="footerSwitch">
        <button class="btn" id="gotoVideo">影片</button>
        <button class="btn" id="gotoContent">內容</button>
      </div>
    </section>
  </div>
</main>

<script>
/* ---------------------- Params ---------------------- */
const qs = new URLSearchParams(location.search);
const cat = (qs.get('cat')||'story').trim();
const slug = (qs.get('slug')||'mid-autumn').trim();
document.getElementById('dbgCat').textContent = cat;
document.getElementById('dbgSlug').textContent = slug;

/* ---------------------- Supabase Gate Hook ---------------------- */
window.initGate = window.initGate || function(){/* 你的守門程式會覆寫這裡 */};

/* ---------------------- Elements ---------------------- */
const elVideo = document.getElementById('video');
const elTblBody = document.querySelector('#tblSubs tbody');
const elSubtitleInfo = document.getElementById('subtitleInfo');
const elVocabInfo = document.getElementById('vocabInfo');
const elQuizMeta = document.getElementById('quizMeta');
const wrapQuiz = document.getElementById('quizWrap');
const wrapVocab = document.getElementById('vocabWrap');
const wrapAI = document.getElementById('aiWrap');

/* ---------------------- State ---------------------- */
let rawCues = [];
let cues = [];
let cueIdx = 0;
let offset = 0;

/* ---------------------- Helpers ---------------------- */
const fmtTime = s => {
  s = Math.max(0, s|0);
  const m = String((s/60|0)).padStart(2,'0');
  const ss = String(s%60).padStart(2,'0');
  return `${m}:${ss}`;
};
async function fetchJSON(url){
  const r = await fetch(url, {cache:'no-store'});
  if(!r.ok) throw new Error(url+': '+r.status);
  return r.json();
}
function smoothScrollInto(el){
  el.scrollIntoView({behavior:'smooth',block:'center'});
}
function activateTab(name){
  document.querySelectorAll('.tabs button').forEach(b=>b.classList.toggle('active', b.dataset.tab===name));
  document.querySelectorAll('.pane').forEach(p=>p.hidden = !p.id.endsWith(name));
}

/* ---------------------- Build UI ---------------------- */
document.querySelectorAll('.tabs button').forEach(btn=>{
  btn.addEventListener('click', ()=>activateTab(btn.dataset.tab));
});

/* Mobile switch */
const carousel = document.getElementById('carousel');
document.getElementById('gotoVideo').onclick = ()=>{ carousel.scrollTo({left:0,behavior:'smooth'}) };
document.getElementById('gotoContent').onclick = ()=>{ carousel.scrollTo({left:carousel.clientWidth,behavior:'smooth'}) };

/* Tools */
document.getElementById('btnPlay').onclick = ()=> elVideo.paused ? elVideo.play() : elVideo.pause();
document.getElementById('btnPrevSent').onclick = ()=> jumpRel(-1);
document.getElementById('btnNextSent').onclick = ()=> jumpRel(1);
document.getElementById('btnOffMinus').onclick = ()=> updateOffset(-0.5);
document.getElementById('btnOffPlus').onclick = ()=> updateOffset(+0.5);
document.getElementById('speed').oninput = e => elVideo.playbackRate = parseFloat(e.target.value);
document.getElementById('btnCalib').onclick = ()=>{ offset = 0; document.getElementById('offsetLabel').textContent = offset.toFixed(1); };

/* Subs follow / repeat */
const cbFollow = document.getElementById('cbFollow');
const cbRepeat = document.getElementById('cbRepeat');

function updateOffset(d){
  offset = +(offset + d).toFixed(1);
  document.getElementById('offsetLabel').textContent = offset.toFixed(1);
}

/* ---------------------- Load resources ---------------------- */
(async function boot(){
  try{
    // video
    const vurls = [
      `./videos/${cat}/${slug}.mp4`,
      `./videos/${slug}.mp4`
    ];
    // set the first as src and let <video> handle fallback via source list
    const src = document.createElement('source');
    src.src = vurls[0];
    src.type = 'video/mp4';
    elVideo.appendChild(src);
    const src2 = document.createElement('source');
    src2.src = vurls[1];
    src2.type = 'video/mp4';
    elVideo.appendChild(src2);

    // cues
    rawCues = await fetchJSON(`./data/${cat}/cues-${slug}.json`);
    cues = rawCues.map((c,i)=>({i, start: +c.start, end:+c.end, en:c.en||'', zh:c.zh||''}));
    elSubtitleInfo.textContent = `${slug}`;
    renderCues();

    // quiz
    try{
      const quiz = await fetchJSON(`./data/${cat}/quiz-${slug}.json`);
      buildQuiz(quiz);
    }catch(e){
      elQuizMeta.textContent = '（找不到 quiz）';
    }

    // vocab
    try{
      const vocab = await fetchJSON(`./data/${cat}/vocab-${slug}.json`);
      buildVocab(vocab);
    }catch(e){
      elVocabInfo.textContent = '（找不到單字）';
    }

    // AI
    try{
      const ai = await fetchJSON(`./data/${cat}/ai-${slug}.json`);
      buildAI(ai);
    }catch(e){
      // keep default
    }

    // timeupdate
    elVideo.addEventListener('timeupdate', onTick);
  }catch(err){
    console.error(err);
    alert('載入失敗：'+ err.message);
  }

  // init gate hook
  try{ if(typeof window.initGate === 'function') window.initGate(); }catch(e){ console.warn('initGate error', e); }
})();

/* ---------------------- Subtitles ---------------------- */
function renderCues(){
  elTblBody.innerHTML = '';
  for(const c of cues){
    const tr = document.createElement('tr');
    tr.dataset.i = c.i;
    const td0 = document.createElement('td'); td0.textContent = fmtTime(c.start);
    const td1 = document.createElement('td'); td1.textContent = c.en;
    const td2 = document.createElement('td'); td2.textContent = c.zh;
    tr.append(td0,td1,td2);
    tr.addEventListener('click',()=>{ cueIdx=c.i; elVideo.currentTime = c.start + offset; elVideo.play(); if(cbFollow.checked) smoothScrollInto(tr); });
    elTblBody.appendChild(tr);
  }
}
function onTick(){
  const t = elVideo.currentTime - offset;
  const i = cues.findIndex(c => t>=c.start && t<c.end);
  if(i>=0){
    cueIdx = i;
    if(cbFollow.checked){
      const row = elTblBody.querySelector(`tr[data-i="${i}"]`);
      if(row){ row.classList.add('hl'); smoothScrollInto(row); }
    }
    if(cbRepeat.checked && t > cues[i].end - 0.05){ elVideo.currentTime = cues[i].start + offset; }
  }
  // clear highlight
  elTblBody.querySelectorAll('tr').forEach(tr=> tr.classList.toggle('active', +tr.dataset.i===cueIdx));
}
/* highlight styles */
const styleHL = document.createElement('style');
styleHL.textContent = `.table tr.active{background:#153149}`;
document.head.appendChild(styleHL);

function jumpRel(d){
  cueIdx = Math.min(Math.max(0, cueIdx + d), cues.length-1);
  const c = cues[cueIdx];
  elVideo.currentTime = c.start + offset;
  if(cbFollow.checked){
    const row = elTblBody.querySelector(`tr[data-i="${cueIdx}"]`);
    if(row) smoothScrollInto(row);
  }
}

/* ---------------------- Quiz ---------------------- */
let quizCurrentBucket = 'Vocabulary';
function buildQuiz(quiz){
  // quiz JSON may be {title, category, sections:[ {type,title,questions:[...]} ] } or flat array.
  let items = [];
  if(Array.isArray(quiz)) items = quiz;
  if(quiz && Array.isArray(quiz.sections)){
    quiz.sections.forEach(sec=>{
      const sectionName = (sec.type||'').trim()||'Mixed';
      (sec.questions||[]).forEach(q=> items.push({...q, section: sectionName}));
    });
  }
  items = items.map((q,i)=>({id:i+1, section:q.section||guessSection(q), q:q.q||q.question, options:q.options||[], a:q.a||q.answer, explain:q.explanation||q.explain||''}));
  elQuizMeta.textContent = `已載入（ ${slug} ），共 ${items.length} 題`;

  function renderBucket(name){
    quizCurrentBucket = name;
    wrapQuiz.innerHTML='';
    let idx=0;
    items.filter(x=> norm(x.section)===norm(name)).forEach(x=>{
      const card=document.createElement('div'); card.className='q';
      const h=document.createElement('div'); h.className='title'; h.textContent = `${++idx}. ${x.q}`;
      const opt=document.createElement('div'); opt.className='options';
      x.options.forEach((op,j)=>{
        const id=`q${x.id}-${j}`;
        const label=document.createElement('label');
        label.innerHTML=`<input type="radio" name="q${x.id}" value="${escapeHtml(op)}"> ${escapeHtml(op)}`;
        opt.appendChild(label);
      });
      const exp=document.createElement('div'); exp.className='small'; exp.innerHTML = `正解：<span data-ans>${escapeHtml(x.a||'')}</span>${x.explain?`　說明：${escapeHtml(x.explain)}`:''}`;
      exp.hidden=true;
      card.append(h,opt,exp);
      wrapQuiz.appendChild(card);
    });
    document.getElementById('score').textContent='0';
  }
  ['Vocabulary','Grammar','Reading','Mixed'].forEach(name=>{
    document.querySelector(`[data-qbucket="${name}"]`).onclick=()=>renderBucket(name);
  });
  renderBucket('Vocabulary');

  document.getElementById('btnShowAns').onclick = ()=>{
    wrapQuiz.querySelectorAll('.q .small').forEach(x=> x.hidden=false);
  };
  document.getElementById('btnSubmit').onclick = ()=>{
    let picked=0, correct=0;
    wrapQuiz.querySelectorAll('.q').forEach(card=>{
      const ans = card.querySelector('[data-ans]').textContent.trim();
      const cho = card.querySelector('input[type=radio]:checked');
      if(cho){ picked++; if(cho.value.trim()===ans) correct++; }
    });
    const score = Math.round((correct / Math.max(1,picked)) * 100);
    document.getElementById('score').textContent = isFinite(score)?score:0;
  };
  document.getElementById('btnPrint').onclick = ()=> window.print();
}
function norm(s){ return String(s||'').toLowerCase(); }
function guessSection(q){
  const s = (q.section||q.type||'').toLowerCase();
  if(s) return s;
  if((q.q||'').match(/\b(choose|which|not|mean|closest|synonym)\b/i)) return 'Vocabulary';
  return 'Mixed';
}
function escapeHtml(s){ return String(s).replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]))}

/* ---------------------- Vocab ---------------------- */
function buildVocab(vocab){
  const items = Array.isArray(vocab)?vocab: (vocab.words||[]);
  elVocabInfo.textContent = slug;
  wrapVocab.innerHTML = '';
  items.forEach(w=>{
    const c = document.createElement('div'); c.className='card';
    c.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:700;font-size:1.1rem">${escapeHtml(w.word||w.en||'')}</div>
      <div class="small">${escapeHtml(w.pos||w.part||'')}</div>
    </div>
    <div class="small" style="margin-top:.25rem">${escapeHtml(w.zh||w.def||w.cn||'')}</div>
    <div class="small">${escapeHtml(w.example||'')}</div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn btn-sm" data-jump="${w.time||w.t||0}">跳到片段</button>
      <button class="btn btn-sm" data-say="${escapeHtml(w.word||w.en||'')}">🔈 朗讀</button>
    </div>`;
    wrapVocab.appendChild(c);
  });
  wrapVocab.addEventListener('click', e=>{
    const j = e.target.closest('[data-jump]');
    if(j){ elVideo.currentTime = parseFloat(j.dataset.jump)||0; elVideo.play(); }
    const s = e.target.closest('[data-say]');
    if(s){ try{ const u = new SpeechSynthesisUtterance(s.dataset.say); u.lang='en-US'; speechSynthesis.speak(u);}catch(err){} }
  });
}

/* ---------------------- AI ---------------------- */
function buildAI(ai){
  const topics = ai.topics || ai || [];
  if(!topics.length){ return; }
  wrapAI.innerHTML = `
  <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
    <select id="aiTopic"></select>
    <label><input type="checkbox" id="aiAutoNext" checked/> 作答後自動下一題</label>
    <button class="btn" id="aiSpeakQ">🔈 朗讀題目</button>
    <button class="btn" id="aiStart">🖋️ 開始說</button>
    <button class="btn" id="aiStop">⏹ 停止</button>
  </div>
  <div class="small">題目：</div>
  <textarea id="aiQ" rows="3" style="width:100%;background:#0b1e2c;color:#dff2ff;border:1px solid var(--border);border-radius:8px;padding:8px"></textarea>
  <div class="small" id="aiHint" style="margin:8px 0"></div>
  <div class="small">第 <span id="aiNum">1</span>/<span id="aiTotal">1</span> 題</div>
  <div class="sectionTitle">AI 示範：</div>
  <div id="aiSample" class="card"></div>`;

  const sel = document.getElementById('aiTopic');
  topics.forEach((t,i)=>{
    const o = document.createElement('option'); o.value=i; o.textContent = t.title||`Topic ${i+1}`; sel.appendChild(o);
  });
  const state = {t:0,q:0};
  function refresh(){
    const T = topics[state.t];
    const qs = T.questions || T.qa || T.items || [];
    const cur = qs[state.q] || {};
    document.getElementById('aiQ').value = cur.prompt || cur.q || '';
    document.getElementById('aiHint').textContent = cur.hint || '';
    document.getElementById('aiSample').textContent = cur.sample || cur.a || '';
    document.getElementById('aiNum').textContent = state.q+1;
    document.getElementById('aiTotal').textContent = qs.length||1;
  }
  sel.onchange = ()=>{ state.t = +sel.value; state.q = 0; refresh(); };
  document.getElementById('aiStart').onclick = ()=>{ /* external ASR 可在此接入 */ };
  document.getElementById('aiStop').onclick = ()=>{};
  document.getElementById('aiSpeakQ').onclick = ()=>{
    try{ const u=new SpeechSynthesisUtterance(document.getElementById('aiQ').value||''); u.lang='en-US'; speechSynthesis.speak(u);}catch(e){}
  };
  refresh();
}

/* accessibility: keyboard ESC to stop follow */
document.addEventListener('keydown', e=>{
  if(e.key==='Escape'){ cbFollow.checked=false; }
});

</script>
</body>
</html>

























































