<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BookWide Player – Clean SoT JA Always v2025-11-10</title>
  <!-- Canonical JSON schema (future-proof)
    index-<slug>.json {
      title, category, slug, video, cover, is_public,
      cues: { zh: "./cues-<slug>.json" },
      vocab: "./vocab-<slug>.json",
      quiz:  "./quiz-<slug>.json",
      ai:    "./ai-<slug>.json"
    }
    cues-<slug>.json  : [ { time, en, zh, ja } ]
    vocab-<slug>.json : [ { en, zh, ja, def_en, example_en } ]
    quiz-<slug>.json  : [ { section, type, question, options, answer, explanation } ]
    ai-<slug>.json    : { topics: [ { title, prompt, hint, sample } ] } or { tasks: [ { q, a } ] }
  -->
  <style>
    :root{ --bg:#0e1620; --panel:#0f1b2a; --ink:#d7e3f4; --muted:#86a2c3; --accent:#6cc3ff; --line:#1e2b3e }
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{display:grid;grid-template-columns:minmax(320px,1fr) 1.1fr;gap:20px;max-width:1200px;margin:24px auto;padding:0 16px}
    .video{background:#000;border-radius:12px;overflow:hidden;box-shadow:0 0 0 1px #122036}
    .panel{background:var(--panel);border-radius:12px;box-shadow:0 0 0 1px #17263b}
    .tabs{display:flex;gap:8px;border-bottom:1px solid var(--line);padding:10px 12px}
    .tabs button{background:#142236;border:1px solid #1b314f;color:var(--ink);padding:8px 14px;border-radius:10px;cursor:pointer}
    .tabs button.active{background:#1a2e4a;color:#fff}
    .section{display:none}
    .section.active{display:block}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:8px 10px;vertical-align:top}
    .toolbar{display:flex;align-items:center;gap:12px;padding:10px 12px;border-bottom:1px solid var(--line)}
    .badge{font-size:12px;color:var(--muted)}
    .ja-line{color:#a3e1ff;margin-top:4px;font-size:13px}
    textarea{width:100%;min-height:84px;background:#0f1826;color:var(--ink);border:1px solid #20324e;border-radius:10px;padding:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="video">
      <video id="playerVideo" src="" controls style="display:block;width:100%;height:auto;aspect-ratio:16/9"></video>
    </div>

    <div class="panel">
      <div class="tabs">
        <button class="tab active" data-tab="cues">字幕</button>
        <button class="tab" data-tab="quiz">測驗</button>
        <button class="tab" data-tab="vocab">單字</button>
        <button class="tab" data-tab="ai">AI互動</button>
        <span class="badge" id="sourceHint" title="目前 JSON 來源"></span>
      </div>

      <!-- 字幕 -->
      <section class="section active" id="sec-cues">
        <div class="toolbar">
          <span>已載入：<span id="cuesPath" class="badge"></span></span>
          <span style="margin-left:auto" class="badge">字幕：中 + 日（固定顯示）</span>
        </div>
        <table>
          <thead><tr><th style="width:80px">時間</th><th style="width:45%">英文</th><th>中文＋日文</th></tr></thead>
          <tbody id="cuesBody"></tbody>
        </table>
      </section>

      <!-- 測驗 -->
      <section class="section" id="sec-quiz">
        <div class="toolbar">
          <span>已載入：<span id="quizPath" class="badge"></span></span>
        </div>
        <div id="quizBody" style="padding:12px 14px"></div>
      </section>

      <!-- 單字 -->
      <section class="section" id="sec-vocab">
        <div class="toolbar">
          <span>已載入：<span id="vocabPath" class="badge"></span></span>
        </div>
        <div id="vocabBody" style="padding:12px 14px"></div>
      </section>

      <!-- AI -->
      <section class="section" id="sec-ai">
        <div class="toolbar">
          <span>已載入：<span id="aiPath" class="badge"></span></span>
          <span id="aiCatSlug" class="badge" style="margin-left:auto"></span>
        </div>
        <div style="padding:12px 14px">
          <select id="aiTopic" style="background:#0f1826;border:1px solid #20324e;color:#fff;border-radius:10px;padding:6px 8px"></select>
          <textarea id="aiPrompt" placeholder="題目將出現在這裡…"></textarea>
          <div id="aiSample" class="badge"></div>
        </div>
      </section>
    </div>
  </div>

  <script>
  // ① 單一事實來源（SoT）— 統一路徑、來源與 cat/slug 管理
  const BW = {
    cat:'', slug:'',
    json(kind){ return `./data/${this.cat}/${this.slug}/${kind}-${this.slug}.json`; },
    initCatSlug(){
      const t = document.body.innerText || '';
      const m = t.match(/\/data\/([^\/]+)\/([^\/]+)\/cues-[^\/]+\.json/i);
      if (m){ this.cat=m[1]; this.slug=m[2]; return; }
      const qs = new URLSearchParams(location.search);
      let c = qs.get('cat')||''; let s = qs.get('slug')||'';
      if (c.includes('|')) c='';
      this.cat = c || this.cat || 'music';
      this.slug = s || this.slug || 'applesong';
    },
    setCatSlug(c,s){ this.cat=c; this.slug=s; }
  };
  BW.initCatSlug();

  const loadCues  = async()=> (await fetch(BW.json('cues'),  {cache:'no-store'})).json();
  const loadVocab = async()=> (await fetch(BW.json('vocab'), {cache:'no-store'})).json();
  const loadQuiz  = async()=> (await fetch(BW.json('quiz'),  {cache:'no-store'})).json();
  const loadAI    = async()=> (await fetch(BW.json('ai'),    {cache:'no-store'})).json();

  // ② 字幕渲染（固定顯示 JA）
  function renderCuesTable(cues){
    const tbody = document.getElementById('cuesBody');
    tbody.innerHTML='';
    cues.forEach(c=>{
      const tr=document.createElement('tr');
      const td1=document.createElement('td');
      const td2=document.createElement('td');
      const td3=document.createElement('td');
      td1.textContent=c.time||'';
      td2.textContent=c.en||'';
      td3.innerHTML = c.zh? c.zh: '';
      if (c.ja) { td3.innerHTML += `<div class="ja-line">${c.ja}</div>`; }
      tr.append(td1,td2,td3); tbody.appendChild(tr);
    });
  }

  // ③ 測驗 / 單字 / AI 的極簡渲染（可替換為你原本的 render）
  function renderQuiz(data){
    const host=document.getElementById('quizBody'); host.innerHTML='';
    (data||[]).slice(0,80).forEach((q,i)=>{
      const el=document.createElement('div'); el.style.margin='10px 0';
      el.innerHTML = `<div><b>${i+1}. ${q.title||q.question||'Question'}</b></div>`+
                     (q.prompt? `<div class='badge'>${q.prompt}</div>`:'');
      host.appendChild(el);
    });
  }
  function renderVocab(list){
    // 統一格式：[{en, zh, ja, def_en, example_en}]；同時相容舊欄位 ja_word/definition/eg_en
    const host=document.getElementById('vocabBody'); host.innerHTML='';
    (list||[]).forEach(w=>{
      const row=document.createElement('div'); row.style.padding='8px 0';
      const zh = w.zh||'';
      const en = w.en||'';
      const ja = w.ja||w.ja_word||''; // 兼容舊欄位
      const def = w.def_en||w.definition||'';
      const eg  = w.example_en||w.eg_en||'';
      row.innerHTML = `
        <div style='font-size:18px;margin:2px 0'>${en}</div>
        <div>${zh}</div>
        ${ja? `<div class='ja-line'>${ja}</div>`:''}
        ${def? `<div class='badge'>${def}</div>`:''}
        ${eg?  `<div style='font-style:italic;color:#9fb3cf'>${eg}</div>`:''}
      `;
      host.appendChild(row);
    });
  }
  function renderAI(data){
    const topics = data.topics || [];
    const tasks  = data.tasks  || [];
    const sel=document.getElementById('aiTopic');
    const box=document.getElementById('aiPrompt');
    const sample=document.getElementById('aiSample');
    sel.innerHTML='';
    const src = topics.length? topics : tasks.map((t,i)=>({title:`Topic ${i+1}`, prompt:t.q, sample:t.a||''}));
    src.forEach((t,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=t.title||`Topic ${i+1}`; sel.appendChild(o); });
    function show(i){ const t=src[i]||src[0]||{}; box.value=t.prompt||''; sample.textContent=t.sample||''; }
    sel.onchange = e=> show(+e.target.value||0);
    show(0);
    document.getElementById('aiCatSlug').textContent = `cat=${BW.cat}&slug=${BW.slug}`;
  }

  // ④ 分頁切換與首次載入
  async function firstLoad(){
    const cues = await loadCues();
    document.getElementById('cuesPath').textContent = BW.json('cues');
    document.getElementById('sourceHint').textContent = `${BW.cat}/${BW.slug}`;
    renderCuesTable(cues);
  }
  firstLoad();

  const tabBtns=[...document.querySelectorAll('.tab')];
  const sections={cues:'#sec-cues',quiz:'#sec-quiz',vocab:'#sec-vocab',ai:'#sec-ai'};
  tabBtns.forEach(btn=>btn.addEventListener('click', async()=>{
    tabBtns.forEach(b=>b.classList.toggle('active', b===btn));
    for(const k in sections){ document.querySelector(sections[k]).classList.toggle('active', btn.dataset.tab===k); }

    if(btn.dataset.tab==='quiz'){
      const data = await loadQuiz();
      document.getElementById('quizPath').textContent = BW.json('quiz');
      renderQuiz(data);
    }
    if(btn.dataset.tab==='vocab'){
      const data = await loadVocab();
      document.getElementById('vocabPath').textContent = BW.json('vocab');
      renderVocab(data);
    }
    if(btn.dataset.tab==='ai'){
      const data = await loadAI();
      document.getElementById('aiPath').textContent = BW.json('ai');
      renderAI(data);
    }
  }));

  // ⑤ 外部切片：切換影片時一鍵重載
  window.bwSwitchTo = async function(cat, slug){
    BW.setCatSlug(cat, slug);
    document.getElementById('sourceHint').textContent = `${BW.cat}/${BW.slug}`;
    const cues = await loadCues();
    document.getElementById('cuesPath').textContent = BW.json('cues');
    renderCuesTable(cues);
    if (document.querySelector('#sec-quiz').classList.contains('active')){
      const q = await loadQuiz(); document.getElementById('quizPath').textContent = BW.json('quiz'); renderQuiz(q);
    }
    if (document.querySelector('#sec-vocab').classList.contains('active')){
      const v = await loadVocab(); document.getElementById('vocabPath').textContent = BW.json('vocab'); renderVocab(v);
    }
    if (document.querySelector('#sec-ai').classList.contains('active')){
      const a = await loadAI(); document.getElementById('aiPath').textContent = BW.json('ai'); renderAI(a);
    }
  }
  </script>
</body>
</html>





















