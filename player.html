<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>BookWide Player</title>
<style>
  :root { color-scheme: dark; }
  body{margin:0;background:#0b1220;color:#e6edf3;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;}
  a{color:#9ac7ff}
  .container{max-width:1280px;margin:20px auto;padding:0 16px;}
  .header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  .header .badge{border:1px solid #2a3a52;border-radius:999px;padding:2px 10px;font-size:12px;opacity:.9}
  .layout{display:grid;grid-template-columns: 2fr 1fr;gap:18px}
  .video-area{background:#0f172a;border:1px solid #1e293b;border-radius:14px;padding:14px}
  .video-wrap{position:relative;border-radius:10px;overflow:hidden;background:#000}
  video{width:100%;aspect-ratio:16/9;background:#000;display:block}
  .controls{margin-top:12px;border-top:1px dashed #223047;padding-top:12px;display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .controls button,.controls .btn{background:#132238;border:1px solid #23334c;border-radius:10px;padding:8px 12px;color:#e6edf3;cursor:pointer}
  .controls .switch{display:flex;align-items:center;gap:6px;margin-left:6px}
  .controls input[type=range]{width:240px}
  /* Right panel tabs */
  .side{background:#0f172a;border:1px solid #1e293b;border-radius:14px;padding:10px}
  .tabs{display:flex;gap:8px;margin:6px 6px 10px 6px}
  .tabs .tab{padding:6px 10px;border-radius:10px;background:#16233a;border:1px solid #223047;cursor:pointer}
  .tabs .tab.active{background:#1f2f4a}
  .pane{display:none;padding:0 6px 8px 6px}
  .pane.active{display:block}
  table.cues{width:100%;border-collapse:collapse;font-size:14px}
  table.cues th,table.cues td{border-bottom:1px solid #1c2b44;padding:8px 6px;vertical-align:top}
  .muted{opacity:.75}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <a href="index.html">← 回首頁</a>
    <span id="badgeCat" class="badge">story</span>
    <div id="title" class="muted">播放器</div>
  </div>

  <div class="layout">
    <!-- 左側：影片 -->
    <div class="video-area">
      <div class="video-wrap" id="videoWrap">
        <video id="player" controls playsinline></video>
      </div>

      <!-- 播放工具列 -->
      <div class="controls" id="controlsBar">
        <button id="btnPrev">⏮ 上一句</button>
        <button id="btnPlay">▶ 播放 / 暫停</button>
        <button id="btnNext">⏭ 下一句</button>
        <button id="btnReplay">🔁 重複本句</button>
        <label class="switch"><input type="checkbox" id="chkFollow"> 跟隨</label>
        <div class="switch">偏移
          <button id="btnShiftMinus">-0.5s</button>
          <button id="btnShiftPlus">+0.5s</button>
        </div>
        <button id="btnEasy">🧭 簡易校準</button>
        <div class="switch">速度
          <input id="speed" type="range" min="0.5" max="1.75" step="0.05" value="1.0">
          <span id="speedLabel">1.00x</span>
        </div>
      </div>
    </div>

    <!-- 右側：分頁（字幕 / 測驗 / 單字 / AI互動） -->
    <div class="side">
      <div class="tabs">
        <div id="tabBtnSub" class="tab active">字幕</div>
        <div id="tabBtnQuiz" class="tab">測驗</div>
        <div id="tabBtnVocab" class="tab">單字</div>
        <div id="tabBtnAI" class="tab">AI互動</div>
      </div>

      <div id="tabSubtitles" class="pane active">
        <div class="muted" id="cuesMeta">（字幕載入中…）</div>
        <table class="cues" id="cuesTable">
          <thead><tr><th style="width:70px">時間</th><th>英文</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="tabQuiz" class="pane">
        <div class="muted" id="quizMeta">（測驗載入中…）</div>
        <div id="quizBox"></div>
      </div>

      <div id="tabVocab" class="pane">
        <div class="muted" id="vocabMeta">（單字載入中…）</div>
        <div id="vocabBox"></div>
      </div>

      <div id="tabAI" class="pane">
        <div class="muted">（AI 互動預留區，保持原版位置與結構）</div>
      </div>
    </div>
  </div>
</div>

<script>
const params = new URLSearchParams(location.search);
const primarySlug = params.get('slug') || 'mid-autumn';
const cat = (params.get('cat') || 'story').toLowerCase();
document.getElementById('badgeCat').textContent = cat;
document.getElementById('title').textContent = `${cat} | ${primarySlug}`;

const DATA_DIR = {
  story: './data/story',
  music: './data/music',
  movie: './data/movie',
  news:  './data/news',
  pro:   './data/pro'
};
const DATA_BASE = DATA_DIR[cat] || DATA_DIR.story;
const FALLBACK_SLUG = (cat === 'music') ? 'see-you-again' : 'mid-autumn';
let slug = primarySlug;

const bust = () => `v=${Date.now()}`;
const jurl = (type, s = primarySlug) => `${DATA_BASE}/${type}-${s}.json?${bust()}`;

// Tabs
const panes = { sub: document.getElementById('tabSubtitles'), quiz: document.getElementById('tabQuiz'), vocab: document.getElementById('tabVocab'), ai: document.getElementById('tabAI') };
function activate(which){
  document.querySelectorAll('.tab').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll('.pane').forEach(el=>el.classList.remove('active'));
  document.getElementById('tabBtn'+which).classList.add('active');
  panes[which.toLowerCase()].classList.add('active');
}
document.getElementById('tabBtnSub').onclick = ()=>activate('Sub');
document.getElementById('tabBtnQuiz').onclick = ()=>activate('Quiz');
document.getElementById('tabBtnVocab').onclick = ()=>activate('Vocab');
document.getElementById('tabBtnAI').onclick = ()=>activate('AI');

// Fetch with fallback
async function fetchWithFallback(primaryUrl, fallbackUrl, kind){
  try{
    const r = await fetch(primaryUrl, {cache:'no-store'});
    if(!r.ok) throw 0;
    return { data: await r.json(), used:'primary' };
  }catch(e){
    try{
      const r2 = await fetch(fallbackUrl, {cache:'no-store'});
      if(!r2.ok) throw 0;
      slug = FALLBACK_SLUG;
      return { data: await r2.json(), used:'fallback' };
    }catch(e2){
      return { data:null, used:'error' };
    }
  }
}

// Cues
function normTime(v){ if(typeof v==='number') return v; if(typeof v==='string'){const m=v.match(/(\d+):(\d+)(?::(\d+))?/); if(m){const h=+(m[1]||0), mi=+(m[2]||0), s=+(m[3]||0); return h*3600+mi*60+s;} } return 0; }
function fmtTime(sec){ sec=Math.max(0,Math.round(sec)); const m=Math.floor(sec/60), s=sec%60; return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
function pickText(obj){ return obj.en ?? obj.text ?? obj.sentence ?? obj.english ?? ''; }

async function loadCues(){
  const meta = document.getElementById('cuesMeta');
  const tbody = document.querySelector('#cuesTable tbody');
  tbody.innerHTML = '';
  const { data, used } = await fetchWithFallback(jurl('cues'), jurl('cues', FALLBACK_SLUG), 'cues');
  if(!data){ meta.textContent='⚠️ 字幕載入失敗'; return; }
  const rows = Array.isArray(data) ? data : (data.items || data.lines || []);
  rows.forEach((row, i)=>{
    const t = normTime(row.t ?? row.time ?? row.start ?? row.begin ?? (row.i??i));
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${fmtTime(t)}</td><td>${pickText(row)}</td>`;
    tr.onclick = ()=>{ const v=document.getElementById('player'); v.currentTime=t; v.play(); };
    tbody.appendChild(tr);
  });
  meta.textContent = (used==='fallback') ? `已載入字幕（${FALLBACK_SLUG} 回退）` : `已載入字幕（${primarySlug}）`;
}

// Quiz
async function loadQuiz(){
  const meta = document.getElementById('quizMeta');
  const box = document.getElementById('quizBox');
  box.innerHTML = '';
  const { data, used } = await fetchWithFallback(jurl('quiz'), jurl('quiz', FALLBACK_SLUG), 'quiz');
  if(!data){ meta.textContent='⚠️ 測驗載入失敗'; return; }
  const qs = Array.isArray(data) ? data : (data.questions || []);
  meta.textContent = (used==='fallback') ? `已載入（${FALLBACK_SLUG} 回退），共 ${qs.length} 題` : `已載入（${primarySlug}），共 ${qs.length} 題`;
  qs.slice(0,10).forEach((q,idx)=>{
    const div=document.createElement('div'); div.style.margin='6px 0'; 
    div.innerHTML = `<div>${idx+1}. ${q.q || q.question || q.prompt || ''}</div>`;
    box.appendChild(div);
  });
}

// Vocab
async function loadVocab(){
  const meta = document.getElementById('vocabMeta');
  const box = document.getElementById('vocabBox');
  box.innerHTML = '';
  const { data, used } = await fetchWithFallback(jurl('vocab'), jurl('vocab', FALLBACK_SLUG), 'vocab');
  if(!data){ meta.textContent='⚠️ 單字載入失敗'; return; }
  const items = Array.isArray(data) ? data : (data.words || data.items || []);
  meta.textContent = (used==='fallback') ? `已載入單字（${FALLBACK_SLUG} 回退），共 ${items.length} 個` : `已載入單字（${primarySlug}），共 ${items.length} 個`;
  items.slice(0,30).forEach(w=>{
    const div=document.createElement('div'); div.className='muted';
    const en = w.en || w.word || w.vocab || '';
    const zh = w.zh || w.cn || w.tw || w.translation || '';
    div.textContent = zh ? `${en} — ${zh}` : en;
    box.appendChild(div);
  });
}

// Video (music → YouTube, else mp4)
async function loadVideo(){
  const v = document.getElementById('player');
  const wrap = document.getElementById('videoWrap');

  if (cat === 'music') {
    try{
      const res = await fetch(`${DATA_DIR.music}/music-index.json?${bust()}`, {cache:'no-store'});
      if (res.ok){
        const list = await res.json();
        const item = (Array.isArray(list)?list:[]).find(x => x.slug === primarySlug);
        if (item && item.yt){
          const iframe = document.createElement('iframe');
          iframe.src = `https://www.youtube.com/embed/${item.yt}?rel=0&modestbranding=1`;
          iframe.allow = 'autoplay; encrypted-media; picture-in-picture';
          iframe.allowFullscreen = true;
          iframe.style.cssText = 'position:absolute;inset:0;width:100%;height:100%;border:0;';
          wrap.appendChild(iframe);
          v.style.visibility = 'hidden';
          return;
        }
      }
    }catch(e){}
  }
  const path = s => (cat==='music') ? `./videos/music/${s}.mp4` : `./videos/${s}.mp4`;
  v.src = path(primarySlug);
  v.addEventListener('error',()=>{ v.src = path(FALLBACK_SLUG); }, { once:true });
}

// Controls (shell only)
document.getElementById('btnPlay').onclick = ()=>{
  const v = document.getElementById('player');
  if(v.paused) v.play(); else v.pause();
};
document.getElementById('btnReplay').onclick = ()=>{
  const v = document.getElementById('player');
  v.currentTime = Math.max(0, v.currentTime - 2);
  v.play();
};
document.getElementById('btnShiftMinus').onclick = ()=>{ const v=document.getElementById('player'); v.currentTime=Math.max(0,v.currentTime-0.5); };
document.getElementById('btnShiftPlus').onclick  = ()=>{ const v=document.getElementById('player'); v.currentTime+=0.5; };
document.getElementById('speed').oninput = (e)=>{
  const v=document.getElementById('player'); v.playbackRate=+e.target.value;
  document.getElementById('speedLabel').textContent = (+e.target.value).toFixed(2)+'x';
};

// Boot
loadVideo();
loadCues();
loadQuiz();
loadVocab();
</script>
</body>
</html>
