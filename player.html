<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BookWide ¬∑ Ëã±Ë™ûÂΩ±ÁâáÊí≠ÊîæÂô®Ôºàcat Ë∑ØÂæë‰øÆÊ≠£ 2025-11-01Ôºâ</title>

<style>
:root{ --bg:#0b1324; --panel:#0f172a; --border:#1f2a44; --ink:#e6f0ff; --muted:#9fb0c9; --accent:#3c7cff; }
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,"Noto Sans TC"}
h1{font-size:20px;margin:0}
a{color:inherit}
.btn{background:#13233f;border:1px solid #24446f;border-radius:10px;padding:8px 12px;color:#fff;cursor:pointer}
.btn.blue{background:#14335f;border-color:#2c5aa3}
.muted{color:var(--muted)}
header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:#0f172a;border-bottom:1px solid #0e203f}
.wrap{padding:16px;height:calc(100vh - 58px);}
.layout{height:100%;display:grid;grid-template-columns:1fr 1fr;gap:16px;overflow-x:hidden; overflow-y:auto}
.left,.right{min-width:0;background:var(--panel);border:1px solid var(--border);border-radius:12px}
.left{display:flex;flex-direction:column;padding:14px;position:sticky;top:0;align-self:start;z-index:10}
.right{display:flex;flex-direction:column;overflow-y:auto;scrollbar-width:thin;position:relative}
.right::-webkit-scrollbar{width:10px}
.right::-webkit-scrollbar-thumb{background:#556a9a;border-radius:6px}

.pane{flex:1;overflow:auto}
.videoWrap{position:relative;width:100%;aspect-ratio:16/9;background:#000;border-radius:10px;overflow:hidden}
.videoWrap video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000}
.controls{margin-top:12px;background:#0e2038;border:1px solid #183459;border-radius:12px;padding:12px}
.controls .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:.25rem 0}
.speed{display:flex;align-items:center;gap:10px}
input[type="range"]{width:260px;accent-color:var(--accent)}
.chip{display:inline-flex;align-items:center;gap:6px;padding:7px 10px;border:1px solid #23446c;border-radius:10px;background:#10233d}
.tabs{display:flex;gap:8px;padding:6px 10px;margin:0 0 2px;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:20;background:var(--panel)}
.tab{cursor:pointer;background:#122340;border:1px solid #1f375f;border-radius:12px;padding:10px 14px;font-weight:600}
.tab.active{background:#154274}
table{width:100%;border-collapse:collapse}
th,td{padding:10px 12px;border-bottom:1px solid #162a48;vertical-align:top}
tbody tr{background:#0f1f34}
tbody tr:nth-child(2n){background:#0d1a2b}
tbody tr:hover{background:#0f2a4e}
tr.active{background:#173a6e}
.cues-table{table-layout:fixed}
.cue-time{width:64px;min-width:64px;color:rgba(255,255,255,.7);font-family:ui-monospace,Consolas,monospace;white-space:nowrap}
.cue-en{line-height:1.6;word-break:break-word}
.cue-en .zh-line{margin-top:6px;opacity:.9}
.cue-zh{display:none !important}
@media (max-width:860px) and (orientation:portrait){
  #track{ display:flex; flex-direction:row; overflow-x:auto; overflow-y:hidden; scroll-snap-type:x mandatory; gap:0; }
  .page{ flex:0 0 100vw; max-width:100vw; height:calc(100vh - 58px); scroll-snap-align:start; overflow-y:auto; }
  .page > .left, .page > .right{ width:100%; max-width:100%; border-radius:0; border-left:0; border-right:0; }
  #btnExitFocus{ position:fixed; right:16px; bottom:16px; z-index:10020; display:none;
    padding:8px 12px; border-radius:10px; border:1px solid rgba(100,116,139,.5); background:#0f172a; color:#e6efff; }
  body.at-right #btnExitFocus{ display:inline-flex; }
}
@media print{
  /* Print only QUIZ pane */
  body{ background:#fff !important; color:#000 !important; }
  header,.tabs,.controls,#authArea,.drawer-grab,.videoWrap,.left,#pane-sub,#pane-vocab,#pane-ai{ display:none !important; }
  .wrap{ padding:0 !important; }
  .layout{ display:block !important; height:auto !important; overflow:visible !important; }
  .right{ border:none !important; background:#fff !important; display:block !important; height:auto !important; }
  #pane-quiz{ display:block !important; }
  #quizMeta{ font-size:10pt; color:#444 !important; }
  #quizList{ font-size:12.5pt; line-height:1.35; }
  #quizList > li{ break-inside:avoid; page-break-inside:avoid; padding:6px 0; margin:0 0 6px 0; border-bottom:1px dotted #ccc; }
  .q-actions{ display:none !important; }
  @page { margin:10mm 10mm 12mm 10mm; }
  html,body{ background:#fff !important; color:#000 !important; height:auto !important; overflow:visible !important; }
  header,.tabs,.controls,#authArea,.drawer-grab,.videoWrap,.left{ display:none !important; }
  .wrap{ padding:0 !important; }
  .layout{ display:block !important; height:auto !important; overflow:visible !important; }
  .right{ border:none !important; background:#fff !important; display:block !important; height:auto !important; }
  #pane-quiz,.pane{ height:auto !important; max-height:none !important; overflow:visible !important; display:block !important; }
  #quizList{ font-size:12.5pt; line-height:1.25; }
  #quizList > li{ break-inside:avoid; page-break-inside:avoid; padding:6px 0; margin:0 0 6px 0; border-bottom:1px dotted #ccc; }
  @page { margin:10mm 10mm 12mm 10mm; }
}

/* keep subtitle table header visible while right pane scrolls */
#pane-sub thead th{ position: sticky; top: 44px; background: var(--panel); z-index: 10; }
@media (max-width:860px) and (orientation:portrait){
  #pane-sub thead th{ top: 44px; }
}

/* --- print fix: show FULL quiz list with no blank first page --- */
@media print{
  #backHome{ display:none !important; }
  #quizFilters,#quizHeader,#quizMeta{ display:none !important; } /* hide toolbar/meta on paper */
  html, body, .wrap, .layout, .page, .right, .quiz-shell, #pane-quiz, #quizList{
    height:auto !important;
    max-height:none !important;
    overflow:visible !important;
  }
  .wrap{ padding:0 !important; margin:0 !important; }
  #pane-quiz{ display:block !important; }
  #quizList{ margin:0 !important; padding:0 8mm !important; font-size:12.5pt !important; line-height:1.35 !important; }
  #quizList > li{ break-inside:avoid; page-break-inside:avoid; padding:6px 0; margin:0 0 6px 0; border-bottom:1px dotted #ccc; }
  .q-actions{ display:none !important; }
  @page{ margin:10mm 10mm 12mm 10mm; }
}

.ja-line{margin-top:6px;opacity:.9}
</style>

<style id="bw-puretts-css">
/* Pure TTS: remove horn icon; show subtle left indicator */
tr.speaking::before { content: none !important; }
tr.speaking { box-shadow: inset 3px 0 0 0 #3c7cff88; }
</style>

</head>
<body>
<a id="backHome" href="/EduEnglish/index.html" style="position:fixed;left:16px;top:14px;z-index:10000;padding:6px 10px;border-radius:8px;background:#eef5ff;border:1px solid #c7ddff;color:#1b5eaa;text-decoration:none;font-weight:600;box-shadow:0 2px 6px rgba(0,0,0,.08)">‚Üê ÂõûÈ¶ñÈ†Å</a>

<header>
  <h1>Êí≠ÊîæÂô®</h1>
  <div id="authArea" style="display:flex;gap:10px;align-items:center">
    <span class="muted" id="userNameBadge"></span>
  </div>
</header>

<div class="wrap">
  <div id="track" class="layout">
    <section class="page" id="pageLeft">
      <section class="left" id="videoContainer">
        <div class="videoWrap"><video id="player" playsinline controls></video></div>
        <div class="controls">
          <div class="row">
            <button class="btn" id="btnPrev">‚èÆ ‰∏ä‰∏ÄÂè•</button>
            <button class="btn" id="btnPlay">‚ñ∂Ô∏è Êí≠Êîæ / Êö´ÂÅú</button>
            <button class="btn" id="btnNext">‚è≠ ‰∏ã‰∏ÄÂè•</button>
            <button class="btn" id="btnReplay">üîÅ ÈáçË§áÊú¨Âè•</button>
          </div>
          <div class="row">
            <label class="chip"><input id="chkFollow" type="checkbox"/> Ë∑üÈö®</label>
            <span class="chip">ÂÅèÁßª <span id="offsetVal">0.0s</span></span>
            <button class="btn" id="btnOffsetMinus">-0.5s</button>
            <button class="btn" id="btnOffsetPlus">+0.5s</button>
            <button class="btn" id="btnAutoSync">üß≠ Á∞°ÊòìÊ†°Ê∫ñ</button>
          </div>
          <div class="row speed">
            <span class="muted">ÈÄüÂ∫¶</span>
            <input id="speedRange" type="range" min="0.5" max="2" step="0.05" value="1"/>
            <span id="speedVal">1.00x</span>
          </div>

          </div>
      </section>
    </section>

    <section class="page" id="pageRight">
      <section class="right" id="studyContainer">
        <div class="tabs">
          <div class="tab active" data-tab="sub">Â≠óÂπï</div>
          <div class="tab" data-tab="quiz">Ê∏¨È©ó</div>
          <div class="tab" data-tab="vocab">ÂñÆÂ≠ó</div>
          <div class="tab" data-tab="ai">AI‰∫íÂãï</div>
        </div>

        <div class="pane" id="pane-sub">
          <div class="muted" id="cuesStatus" style="padding:10px 14px">ÔºàÂ≠óÂπïËºâÂÖ•‰∏≠‚Ä¶Ôºâ</div>
          <table class="cues-table">
            <thead><tr><th style="width:80px">ÊôÇÈñì</th><th>Ëã±Êñá</th><th class="cue-zh" style="width:40%">‰∏≠Êñá</th></tr></thead>
            <tbody id="cuesBody"></tbody>
          </table>
        </div>

        <div class="pane" id="pane-quiz" style="display:none">
          <div class="quiz-shell"><div style="display:flex;gap:8px;align-items:center;padding:8px 12px 4px"><div id="quizFilters" class="filters"><button class="btn btn-sec" data-sec="all">ÂÖ®ÈÉ®</button><button class="btn btn-sec" data-sec="Vocabulary">ÂñÆÂ≠ó</button><button class="btn btn-sec" data-sec="Grammar">ÊñáÊ≥ï</button><button class="btn btn-sec" data-sec="Reading">Èñ±ËÆÄ</button><button class="btn btn-sec" data-sec="Mixed">Á∂úÂêà</button></div><div id="quizHeader" class="muted" style="margin-left:8px"></div></div>
            <div class="muted" id="quizMeta" style="padding:8px 12px">ÔºàÊ∏¨È©óËºâÂÖ•‰∏≠‚Ä¶Ôºâ</div>
            <ol id="quizList" style="line-height:1.6;padding:0 12px"></ol>
            <div class="q-actions" style="margin:14px 12px 6px; display:flex; gap:8px; align-items:center;">
              <button class="btn" id="btnSubmitQuiz">‰∫§Âç∑</button>
              <button class="btn" id="btnShowAnswer" >È°ØÁ§∫Á≠îÊ°à</button>
              <button class="btn" id="btnPrint" >ÂàóÂç∞ÊàêÁ∏æÂñÆ</button>
              <span id="quizScore" style="margin-left:8px"></span>
            </div>
          </div>
        </div>

        <div class="pane" id="pane-vocab" style="display:none">
          <div class="muted" id="vocabStatus" style="padding:10px 14px">( ÂñÆÂ≠óËºâÂÖ•‰∏≠‚Ä¶ )</div>
          <div id="vocabBox" style="padding:0 14px 14px"></div>
        </div>

        <div class="pane" id="pane-ai" style="display:none">
          <div class="pane-ai" style="padding:10px">
            <div class="ai-row" style="margin:6px 0 10px">
              <span class="muted">ÂÖÅË®±È∫•ÂÖãÈ¢®ÂæåÂèØÈÄ≤Ë°åÂè£Ë™™Á∑¥ÁøíÔºàÂª∫Ë≠∞ Chrome / EdgeÔºâ„ÄÇÁ∂≤ÂùÄÂ∏∂ <code>?cat=story|music|movie|news|pro&slug=mid-autumn</code></span>
            </div>
            <div class="ai-row" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <select id="aiTopic" class="btn" style="min-width:200px"></select>
              <button id="btnPrevTopic" class="btn">‚óÄ ‰∏ä‰∏ÄÈ°å</button>
              <button id="btnNextTopic" class="btn">‰∏ã‰∏ÄÈ°å ‚ñ∂</button>
              <button id="btnTts" class="btn">üîà ÊúóËÆÄ</button>
              <button id="btnRec" class="btn">üéôÔ∏è ÈñãÂßãË™™</button>
              <button id="btnStop" class="btn" disabled>‚èπ ÂÅúÊ≠¢</button>
              <label style="font-size:13px;opacity:.9"><input id="aiAutoNext" type="checkbox"> ‰ΩúÁ≠îÂæåËá™Âãï‰∏ã‰∏ÄÈ°å</label>
              <span id="aiProgress" class="muted">Á¨¨ 0/0 È°å</span>
            </div>
            <div class="ai-row" style="margin-top:6px">
              <textarea id="aiPrompt" rows="3" placeholder="È°åÁõÆÊúÉÈ°ØÁ§∫Âú®ÈÄôË£°‚Ä¶" readonly style="width:100%"></textarea>
            </div>
            <div class="ai-row" style="margin:6px 0 8px">
              <span class="muted">ÊèêÁ§∫Ôºö<span id="aiHint">‚Äî</span></span>
            </div>
            <div style="margin:10px 0 6px;display:flex;gap:8px;align-items:center"><span style="opacity:.9">AI Á§∫ÁØÑÔºö</span><button id="aiDemo" class="btn">Á§∫ÁØÑÂè•</button><button id="aiDemoTts" class="btn">ÊúóËÆÄ</button></div>
            <div class="ai-row">
              <div class="ai-out" id="aiReply" style="min-height:54px;border:1px solid #223048;border-radius:10px;padding:10px">ÔºàÁ≠âÂæÖ‰Ω†ÁöÑ‰ΩúÁ≠î‚Ä¶Ôºâ</div>
            </div>
          </div>
        </div>

      </section>
    </section>
  </div>
</div>

<button id="btnExitFocus" class="btn" style="display:none">ËøîÂõûÂΩ±Áâá</button>

<script type="module">
import { supabase } from '/EduEnglish/supa.js?v=20251018';
const { data: authData } = await supabase.auth.getUser();
if (!authData?.user) {
  alert('Ë´ãÂÖàÁôªÂÖ•ÂæåÂÜçÁúãÂΩ±Áâá„ÄÇ');
  location.href = '/EduEnglish/index.html';
} else {
  const user = authData.user;
  document.getElementById('userNameBadge').textContent = user.email || '';
  const videoSlug = new URLSearchParams(location.search).get('slug') || 'mid-autumn';
  try { await supabase.from('watch_logs').insert({ user_id: user.id, email: user.email, video_slug: videoSlug }); } catch {}
  let once=false;
  document.getElementById('player')?.addEventListener('play', async ()=>{
    if(once) return; once=true;
    try { await supabase.from('watch_logs').insert({ user_id: user.id, email: user.email, video_slug: videoSlug }); } catch {}
  }, { once:true });
}
</script>

<script id="bw-puretts-controller">
(function(){
  if (!("speechSynthesis" in window)) return;
  if (window.__BW_PURE_TTS__) return; window.__BW_PURE_TTS__ = true;

  const video = document.getElementById('player');
  const cuesBody = document.getElementById('cuesBody');
  const speedRange = document.getElementById('speedRange');
  const followChk = document.getElementById('chkFollow');

  // Block any residual <audio> playback
  document.addEventListener('play', function(ev){
    const el = ev.target;
    if (el && el.tagName === 'AUDIO') {
      try { el.pause(); el.src=""; } catch {}
      ev.stopImmediatePropagation(); ev.stopPropagation(); ev.preventDefault();
    }
  }, true);
  try { document.querySelectorAll('audio').forEach(a=>{ a.pause(); a.src=""; }); } catch {}

  let voices = [];
  function loadVoices(){ try{ voices = speechSynthesis.getVoices()||[]; }catch{ voices=[]; } }
  loadVoices(); speechSynthesis.onvoiceschanged = loadVoices;

  function pickVoice(bcp){
    if (!voices.length) voices = speechSynthesis.getVoices()||[];
    const lc = (bcp||'').toLowerCase();
    let v = voices.find(v=> (v.lang||'').toLowerCase()===lc);
    if (v) return v;
    const pref = lc.slice(0,2);
    return voices.find(v=> (v.lang||'').toLowerCase().startsWith(pref)) || null;
  }
  function splitSentences(text,bcp){
    const s = String(text||'').trim().replace(/\s+/g,' ');
    if (!s) return [];
    if (/^zh/i.test(bcp)) return s.split(/(?<=[„ÄÇÔºÅÔºüÔºõ„ÄÅ])/u).map(t=>t.trim()).filter(Boolean);
    if (/^ja/i.test(bcp)) return s.split(/(?<=[„ÄÇÔºÅÔºü„ÄÅ])/u).map(t=>t.trim()).filter(Boolean);
    return s.split(/(?<=[\.\?\!;,:])\s+/).map(t=>t.trim()).filter(Boolean);
  }
  function rate(){
    const v = (video && typeof video.playbackRate==='number')? video.playbackRate : 1;
    const s = speedRange ? Number(speedRange.value||"") : NaN;
    return (s>0? s : v) || 1;
  }
  function cancel(){ try{ speechSynthesis.cancel(); }catch{} }
  function speak(text,bcp){
    const chunks = splitSentences(text,bcp);
    if(!chunks.length) return;
    const voice = pickVoice(bcp);
    chunks.forEach((piece,i)=>{
      const u = new SpeechSynthesisUtterance(piece);
      u.lang = bcp; u.rate = rate();
      if (voice) u.voice = voice;
      if (i===0) u.onstart = ()=> document.body.classList.add('tts-speaking');
      if (i===chunks.length-1) u.onend = ()=> document.body.classList.remove('tts-speaking');
      speechSynthesis.speak(u);
    });
  }
  function bcpFromTarget(t){
    if (t && t.closest && t.closest('.ja-line')) return 'ja-JP';
    if (t && t.closest && t.closest('.zh-line')) return 'zh-TW';
    return 'en-US';
  }
  function textFromRow(tr,bcp){
    const enNode = (tr.querySelector('.cue-en')||{});
    const en = (enNode.childNodes && enNode.childNodes[0] ? enNode.childNodes[0].textContent : '') || '';
    const zh = (tr.querySelector('.zh-line')||{}).textContent || '';
    const ja = (tr.querySelector('.ja-line')||{}).textContent || '';
    if (/^ja/i.test(bcp)) return (ja||zh||en).trim();
    if (/^zh/i.test(bcp)) return (zh||ja||en).trim();
    return (en||zh||ja).trim();
  }

  if (cuesBody) {
    cuesBody.addEventListener('click', (e)=>{
      const tr = e.target.closest('tr'); if (!tr) return;
      const idx = Number(tr.dataset.i ?? tr.dataset.idx ?? -1);
      if (!(idx>=0)) return;

      // Prevent other click handlers from also triggering audio
      e.stopImmediatePropagation(); e.stopPropagation(); e.preventDefault();

      // Follow (seek) behavior
      try { if (typeof window.seekTo==='function') window.seekTo(idx, true); } catch {}

      const bcp = bcpFromTarget(e.target);
      const text = textFromRow(tr, bcp);

      cancel();
      speak(text, bcp);

      document.querySelectorAll('#cuesBody tr.speaking').forEach(x=>x.classList.remove('speaking'));
      tr.classList.add('speaking');
      try { tr.scrollIntoView({block:'center', behavior:'smooth'}); } catch {}
    }, true);
  }

  // simple API for programmatic speak
  window.BW_PURE_TTS = {
    speakByIndex(i, preferBCP){
      const tr = document.querySelector(`#cuesBody tr[data-i="${i}"]`); if (!tr) return;
      const bcp = preferBCP || 'en-US';
      const text = textFromRow(tr, bcp);
      cancel(); speak(text, bcp);
      document.querySelectorAll('#cuesBody tr.speaking').forEach(x=>x.classList.remove('speaking'));
      tr.classList.add('speaking');
      try { tr.scrollIntoView({block:'center'}); } catch {}
    },
    cancel: cancel
  };
})();
</script>

</body>
</html>

</body>

</html>




















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































