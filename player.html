<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BookWide Player · Slim v2 (Story-Format Only)</title>
  <style>
    :root { --bg:#111; --fg:#f5f5f5; --muted:#9aa0a6; --card:#1a1a1a; --border:#2a2a2a; --accent:#4dabf7; }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Noto Sans,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"}
    a{color:var(--accent);text-decoration:none}
    header{display:flex;align-items:center;justify-content:space-between;padding:.75rem 1rem;border-bottom:1px solid var(--border);background:#0c0c0c;position:sticky;top:0;z-index:10}
    header .title{font-weight:700;letter-spacing:.2px}
    main{display:grid;grid-template-columns: 1.2fr .8fr; gap: 12px; padding:12px}
    @media (max-width: 960px){ main{grid-template-columns:1fr}}
    #video-pane{background:var(--card);border:1px solid var(--border);border-radius:10px;overflow:hidden}
    #video-pane video{width:100%;height:auto;background:#000;display:block}
    #right-pane{background:var(--card);border:1px solid var(--border);border-radius:10px;overflow:hidden}
    .tabs{display:flex;gap:4px;border-bottom:1px solid var(--border);padding:6px}
    .tabs button{flex:1; background:#151515; color:var(--fg); border:1px solid var(--border); border-radius:8px; padding:.5rem .6rem; cursor:pointer}
    .tabs button[aria-selected="true"]{background:#202020; border-color:#333}
    #tab-cues,#tab-quiz{padding:.6rem .8rem; max-height: calc(100vh - 190px); overflow:auto}
    /* cue / quiz basic look */
    .cue-row { padding: .35rem .5rem; border-bottom: 1px solid rgba(255,255,255,.06) }
    .cue-row:hover { background: rgba(255,255,255,.05); cursor: pointer }
    .cue-en { font-weight: 700 }
    .cue-zh { color: var(--muted); margin-top: 2px }
    .badge { display:inline-block; font-size:12px; padding:2px 6px; border-radius:10px; background:#222; color:#ddd }
    .quiz-card { border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:.75rem; margin:.5rem 0; background:#141414 }
    .quiz-q { font-weight:700; margin-bottom:.4rem }
    .quiz-opt { display:block; margin:.25rem 0 }
    .hidden { display:none !important }
  </style>
</head>
<body>
  <header>
    <div class="title">BookWide Player · Slim v2</div>
    <div class="meta"><span id="meta-cat" class="badge">cat=?</span> <span id="meta-slug" class="badge">slug=?</span></div>
  </header>

  <main id="app">
    <section id="video-pane">
      <video id="player" controls playsinline preload="metadata"></video>
    </section>

    <aside id="right-pane">
      <nav class="tabs">
        <button id="btn-cues" aria-selected="true" onclick="(function(){document.getElementById('tab-cues').classList.remove('hidden');document.getElementById('tab-quiz').classList.add('hidden');document.getElementById('btn-cues').setAttribute('aria-selected','true');document.getElementById('btn-quiz').setAttribute('aria-selected','false')})()">字幕</button>
        <button id="btn-quiz" aria-selected="false" onclick="(function(){document.getElementById('tab-quiz').classList.remove('hidden');document.getElementById('tab-cues').classList.add('hidden');document.getElementById('btn-quiz').setAttribute('aria-selected','true');document.getElementById('btn-cues').setAttribute('aria-selected','false')})()">測驗</button>
      </nav>
      <div id="tab-cues"></div>
      <div id="tab-quiz" class="hidden"></div>
    </aside>
  </main>

  <!-- ======== BW Slim v2 · Story 格式專用（僅支援 time/en/zh 陣列） ======== -->
  <script>
  (function(){
    // 固定規範：cues 必須是 [{ time:"MM:SS"|"HH:MM:SS", en:"...", zh:"..." }, ...]
    // 路徑固定：./videos/${cat}/${slug}.mp4 、 ./data/${cat}/cues-${slug}.json 、 ./data/${cat}/quiz-${slug}.json

    const $ = (sel, root=document)=>root.querySelector(sel);
    const fmtTime = s => {
      // 僅支援 "MM:SS" 或 "HH:MM:SS"。若不是此格式→丟 0（代表錯誤資料）
      if (typeof s !== 'string') return 0;
      const a = s.split(':').map(Number);
      if (a.length===2) return a[0]*60 + a[1];
      if (a.length===3) return a[0]*3600 + a[1]*60 + a[2];
      return 0;
    };

    const qs = new URLSearchParams(location.search);
    const cat = qs.get('cat') || 'story';
    const slug = qs.get('slug') || 'mid-autumn';
    const elVideo = $('#player');
    const elCues  = $('#tab-cues');
    const elQuiz  = $('#tab-quiz');

    const metaCat = $('#meta-cat'); if (metaCat) metaCat.textContent = `cat=${cat}`;
    const metaSlug = $('#meta-slug'); if (metaSlug) metaSlug.textContent = `slug=${slug}`;

    async function fetchJSON(url){
      const r = await fetch(url, {cache:'no-store'});
      if (!r.ok) throw new Error(r.status+' '+url);
      return r.json();
    }

    // 只支援 Story 格式（time/en/zh），不做任何舊新自動轉換
    function normalizeCues(raw){
      if (!Array.isArray(raw)) return [];
      return raw.map((row,i)=>({
        start: fmtTime(row.time),
        // 句尾時長估 4 秒；若下一句存在則用下一句起點當 end
        end: 0, // 先暫存，稍後二次掃描補
        en: row.en || '',
        zh: row.zh || ''
      })).map((r,i,arr)=>{
        const next = arr[i+1];
        r.end = next ? next.start : (r.start + 4);
        return r;
      }).filter(r=> (r.en || r.zh));
    }

    function renderCues(cues){
      elCues.innerHTML = '';
      if (!cues.length){ elCues.innerHTML = '<div class="badge">Captions missing or wrong format</div>'; return; }
      const v = elVideo;
      const frag = document.createDocumentFragment();
      cues.forEach(c=>{
        const row = document.createElement('div');
        row.className = 'cue-row';
        row.dataset.start = String(c.start);
        const en = document.createElement('div'); en.className='cue-en'; en.textContent = c.en;
        const zh = document.createElement('div'); zh.className='cue-zh'; zh.textContent = c.zh;
        row.appendChild(en); row.appendChild(zh);
        row.addEventListener('click', ()=>{ if(v){ v.currentTime = Math.max(0, c.start - .2); v.play(); } });
        frag.appendChild(row);
      });
      elCues.appendChild(frag);
    }

    function renderQuiz(qdata){
      if (!qdata || !Array.isArray(qdata.sections)){ elQuiz.classList.add('hidden'); return; }
      elQuiz.classList.remove('hidden');
      const out = [];
      if (qdata.title){ out.push(`<div class=\"badge\" style=\"margin:.2rem 0 .6rem\">${qdata.title}</div>`); }
      (qdata.sections||[]).forEach((sec, si)=>{
        out.push(`<div class=\"badge\" style=\"margin-top:.5rem\">${sec.title || sec.type || ('Section '+(si+1))}</div>`);
        (sec.questions||[]).forEach((q, qi)=>{
          const text = q.q || q.question || ('Q'+(qi+1));
          const opts = Array.isArray(q.options)? q.options.map((opt,oi)=>(
            `<label class=\"quiz-opt\"><input type=\"radio\" name=\"s${si}q${qi}\" value=\"${String(opt).replace(/\"/g,'&quot;')}\"> ${opt}</label>`
          )).join('') : '';
          out.push(`<div class=\"quiz-card\"><div class=\"quiz-q\">${text}</div>${opts}${q.explanation? `<div style=\"margin-top:.4rem;color:#9aa0a6;font-size:13px\">Hint：${q.explanation}</div>`:''}</div>`);
        });
      });
      elQuiz.innerHTML = out.join('');
    }

    async function boot(){
      // 僅走固定新路徑，不再相容平面舊路徑
      if (elVideo) elVideo.src = `./videos/${cat}/${slug}.mp4`;

      try{
        const rawCues = await fetchJSON(`./data/${cat}/cues-${slug}.json`);
        const cues = normalizeCues(rawCues);
        renderCues(cues);
      }catch(err){ console.warn('[Slim v2] cues load fail', err); elCues.innerHTML = '<div class=\'badge\'>cues 載入失敗或格式錯誤</div>'; }

      try{
        const quiz = await fetchJSON(`./data/${cat}/quiz-${slug}.json`);
        renderQuiz(quiz);
      }catch(err){ console.warn('[Slim v2] quiz load fail', err); elQuiz.classList.add('hidden'); }
    }

    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', boot, {once:true});
    }else{ boot(); }
  })();
  </script>
  <!-- ========================== / BW Slim v2 ========================== -->
</body>
</html>














