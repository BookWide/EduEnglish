<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BookWide Player · Slim 50/50</title>
<style>
  :root{
    --bg:#0e1621; --panel:#111b27; --text:#e6edf3; --muted:#9fb3c8; --brand:#5cc8ff;
    --accent:#2dd4bf; --warn:#f0b90b; --danger:#ef4444; --ok:#10b981; --line:#1f2a37; --badge:#203040; --tab:#14202b;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", "PingFang TC", "Microsoft JhengHei", Arial, "Apple Color Emoji", "Segoe UI Emoji"}
  a{color:var(--brand);text-decoration:none}
  .badge{display:inline-block;padding:.15rem .5rem;border-radius:.5rem;background:var(--badge);color:#cfe7ff;margin-right:.25rem}
  header{
    position:fixed;inset:0 0 auto 0;height:52px;display:flex;gap:12px;align-items:center;
    padding:0 14px;background:linear-gradient(180deg, #0d1824, #0b1420);border-bottom:1px solid var(--line);z-index:50
  }
  header .title{font-weight:700;}
  header .grow{flex:1}
  header .btn{background:#0d2332;border:1px solid #203243;padding:.35rem .7rem;border-radius:.5rem;color:#cfe7ff;cursor:pointer}
  header .btn:hover{background:#0f2a3c}
  main{
    position:fixed;top:52px;bottom:86px;left:0;right:0;display:grid;grid-template-columns:1fr 1fr;gap:0;border-top:1px solid var(--line);
  }
  #left{padding:14px 14px 6px 14px;display:flex;flex-direction:column;gap:10px;border-right:1px solid var(--line)}
  #videoWrap{background:#000;border-radius:10px;overflow:hidden;border:1px solid #222}
  video{display:block;width:100%;height:auto;background:#000}
  #right{display:flex;flex-direction:column;min-width:0}
  .tabs{display:flex;gap:4px;padding:8px;background:var(--tab);border-bottom:1px solid var(--line);position:sticky;top:0;z-index:2}
  .tab{padding:.4rem .8rem;border-radius:.5rem;background:#13202a;border:1px solid #1f3443;cursor:pointer;color:#cfe7ff}
  .tab.active{background:#173244;box-shadow:inset 0 0 0 1px #27506a}
  .pane{flex:1;min-height:0;overflow:auto;padding:8px 8px 100px}
  .line{padding:10px;border-bottom:1px dashed #1a2835;cursor:pointer}
  .line:hover{background:#0f1c28}
  .line.active{background:#12283a;border-left:3px solid var(--accent)}
  .en{font-size:18px}
  .zh{font-size:14px;color:#9db2c7}
  .pillbar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px}
  .pill{padding:.3rem .7rem;border:1px solid #28455a;border-radius:999px;background:#142430;color:#d7ecff;cursor:pointer}
  .pill.active{background:#1b3b4f;border-color:#2e5e79}
  .q{border:1px solid #223347;border-radius:8px;padding:10px;margin:10px 0;background:#0f1b27}
  .q .ti{font-weight:700;margin-bottom:6px}
  .opt{display:flex;align-items:center;gap:8px;margin:6px 0}
  .ctrls{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
  .ghost{opacity:.6}
  .vocab{display:grid;grid-template-columns:1.2fr .8fr;gap:8px;border-bottom:1px dashed #203444;padding:8px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0}
  textarea{width:100%;min-height:84px;border:1px solid #28455a;border-radius:8px;background:#0c1824;color:#dfefff;padding:10px}
  select, input[type="text"]{background:#0e2230;color:#d9f2ff;border:1px solid #28455a;border-radius:8px;padding:.35rem .6rem}
  .btn{background:#113043;border:1px solid #274b61;color:#d6f2ff;border-radius:8px;padding:.4rem .7rem;cursor:pointer}
  .btn:hover{background:#123a54}
  footer{
    position:fixed;inset:auto 0 0 0;height:86px;background:linear-gradient(180deg,#0e1621,#0b1420);border-top:1px solid var(--line);
    display:flex;align-items:center;gap:10px;padding:10px 12px;z-index:40
  }
  footer .group{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .k{background:#102232;border:1px solid #203645;color:#e6f3ff;border-radius:10px;padding:.5rem .7rem;cursor:pointer}
  .k:active{transform:translateY(1px)}
  .tgl{display:flex;align-items:center;gap:6px;border:1px solid #27465a;background:#102433;color:#cfe7ff;border-radius:10px;padding:.5rem .7rem;cursor:pointer}
  input[type="range"]{width:220px}
  .hint{color:#9fb3c8;font-size:13px}
  @media (max-width: 980px){
    main{grid-template-columns:1fr;grid-template-rows:1fr 1fr}
    #right{border-top:1px solid var(--line)}
  }
  @media print{
    header, footer, #left{display:none}
    main{position:static;display:block}
    #right{display:block}
    .pane{padding:0}
  }
</style>
</head>
<body>
<header>
  <span class="title">BookWide Player · Slim v2</span>
  <span id="badges" class="hint"></span>
  <span class="grow"></span>
  <a id="btnHome" class="btn" href="./index.html">← 回首頁</a>
  <button id="btnFav" class="btn">☆ 我的收藏</button>
</header>

<main>
  <section id="left">
    <div id="videoWrap">
      <video id="player" playsinline controls preload="metadata"></video>
    </div>
  </section>

  <section id="right">
    <div class="tabs">
      <button class="tab active" data-pane="pane-cues">字幕</button>
      <button class="tab" data-pane="pane-quiz">測驗</button>
      <button class="tab" data-pane="pane-vocab">單字</button>
      <button class="tab" data-pane="pane-ai">AI 互動</button>
    </div>
    <div class="pane" id="pane-cues"><div id="cuesList"></div></div>
    <div class="pane" id="pane-quiz" hidden>
      <div class="pillbar" id="quizTabs"></div>
      <div id="quizHost"></div>
      <div class="ctrls">
        <button class="btn" id="btnSubmit">交卷</button>
        <button class="btn" id="btnReveal">顯示答案</button>
        <button class="btn" onclick="window.print()">列印</button>
        <span id="score" class="hint"></span>
      </div>
    </div>
    <div class="pane" id="pane-vocab" hidden><div id="vocabList"></div></div>
    <div class="pane" id="pane-ai" hidden>
      <div class="row">
        <select id="aiTopic"></select>
        <button class="btn" id="aiPrev">⬅ 上一題</button>
        <button class="btn" id="aiNext">下一題 ➡</button>
        <button class="btn" id="aiSpeak">🔈 朗讀題目</button>
        <button class="btn" id="aiStart">✍ 開始說</button>
        <button class="btn" id="aiStop">■ 停止</button>
      </div>
      <div class="row"><label><input type="checkbox" id="autoNext" checked> 作答後自動下一題</label></div>
      <div>題目：</div>
      <textarea id="aiPrompt" placeholder="題目會出現在這裡…"></textarea>
      <div class="hint" id="aiHint"></div>
      <div class="row"><button class="btn" id="aiSample">AI 示範句</button><button class="btn" id="aiSpeakAns">🔈 朗讀</button></div>
      <div id="aiSampleBox" class="q"></div>
    </div>
  </section>
</main>

<footer>
  <div class="group">
    <button class="k" id="btnPrev">上一句</button>
    <button class="k" id="btnPlay">播放 / 暫停</button>
    <button class="k" id="btnNext">下一句</button>
    <button class="k" id="btnRepeat">重複本句</button>
  </div>
  <div class="group">
    <label class="tgl"><input type="checkbox" id="follow" checked> 跟隨</label>
    <button class="k" id="offNeg">偏移 -0.5s</button>
    <button class="k" id="offPos">+0.5s</button>
    <span class="hint">校準 <span id="offView">0.0</span>s</span>
  </div>
  <div class="group">
    <span class="hint">速度</span>
    <input type="range" id="rate" min="0.5" max="2" step="0.05" value="1" />
    <span id="rateView" class="hint">1.00x</span>
  </div>
  <div class="group">
    <button class="k" id="btnTTS">簡易校準</button>
    <button class="k" id="btnSpeakLine">🔈 朗讀</button>
  </div>
</footer>

<script>
(function(){
  const params = new URLSearchParams(location.search);
  const cat = (params.get('cat') || 'story').toLowerCase();
  const slug = (params.get('slug') || 'mid-autumn').toLowerCase();
  const DATA = `./data/${cat}/`;
  const VIDEO = `./videos/${cat}/${slug}.mp4`;
  const elBadges = document.getElementById('badges');
  elBadges.innerHTML = `<span class="badge">cat=${cat}</span><span class="badge">slug=${slug}</span>`;

  const video = document.getElementById('player');
  const cuesList = document.getElementById('cuesList');
  const follow = document.getElementById('follow');
  const offView = document.getElementById('offView');
  const rate = document.getElementById('rate');
  const rateView = document.getElementById('rateView');
  const btnFav = document.getElementById('btnFav');

  let cues = [];
  let curIdx = -1;
  let offset = 0;
  let repeatOne = false;

  const favKey = 'bw_favorites';
  function readFav(){ try{ return new Set(JSON.parse(localStorage.getItem(favKey)||'[]')); }catch{ return new Set(); } }
  function writeFav(s){ localStorage.setItem(favKey, JSON.stringify([...s])); }
  function syncFavBtn(){
    const set = readFav(); const key = `${cat}:${slug}`;
    btnFav.textContent = set.has(key) ? '★ 已收藏' : '☆ 我的收藏';
  }
  btnFav.onclick = ()=>{
    const set = readFav(); const key = `${cat}:${slug}`;
    if(set.has(key)) set.delete(key); else set.add(key);
    writeFav(set); syncFavBtn();
  };
  syncFavBtn();

  video.src = VIDEO;
  video.onerror = ()=>{ console.warn('[video] 無影片來源：', VIDEO); };

  fetchJSON(`${DATA}cues-${slug}.json`).then(raw=>{
    cues = normalizeCues(raw);
    renderCues(cues);
  }).catch(e=>{
    cuesList.innerHTML = badge('cues 載入失敗或格式錯誤');
    console.warn('cues load fail', e);
  });

  fetchJSON(`${DATA}quiz-${slug}.json`).then(renderQuiz).catch(()=>{
    document.getElementById('pane-quiz').innerHTML = badge('暫無測驗資料');
  });

  fetchJSON(`${DATA}vocab-${slug}.json`).then(renderVocab).catch(()=>{
    document.getElementById('pane-vocab').innerHTML = badge('暫無單字資料');
  });

  fetchJSON(`${DATA}ai-${slug}.json`).then(renderAI).catch(()=>{
    document.getElementById('pane-ai').innerHTML = '<div class="badge">暫無 AI 資料</div>';
  });

  function normalizeCues(arr){
    return arr.map(x=>({start:+x.start, end:+x.end, en:String(x.en||''), zh:String(x.zh||'')}));
  }
  function badge(t){ return `<span class="badge">${t}</span>`; }
  function renderCues(list){
    cuesList.innerHTML = '';
    list.forEach((c, i)=>{
      const row = document.createElement('div');
      row.className='line'; row.dataset.idx=i;
      row.innerHTML = `<div class="en">${escapeHTML(c.en)}</div><div class="zh">${escapeHTML(c.zh)}</div>`;
      row.onclick = ()=>{ video.currentTime = Math.max(0, c.start + offset); video.play(); };
      cuesList.appendChild(row);
    });
  }
  function markActive(i){
    if(i===curIdx) return;
    const prev = cuesList.querySelector('.line.active');
    if(prev) prev.classList.remove('active');
    const node = cuesList.querySelector(`.line[data-idx="${i}"]`);
    if(node){ node.classList.add('active'); if(follow.checked){ node.scrollIntoView({block:'center'}); } }
    curIdx = i;
  }
  function findIdx(t){
    for(let i=0;i<cues.length;i++){ const c=cues[i]; if(t>=c.start+offset && t< c.end+offset) return i; }
    return -1;
  }

  video.addEventListener('timeupdate', ()=>{
    const i = findIdx(video.currentTime);
    if(i>=0) markActive(i);
    if(repeatOne && i>=0 && (video.currentTime>cues[i].end+offset)){
      video.currentTime = Math.max(0, cues[i].start+offset);
    }
  });

  document.getElementById('btnPrev').onclick = ()=> jumpRel(-1);
  document.getElementById('btnNext').onclick = ()=> jumpRel(+1);
  document.getElementById('btnPlay').onclick = ()=> video.paused?video.play():video.pause();
  document.getElementById('btnRepeat').onclick = (e)=>{ repeatOne=!repeatOne; e.target.classList.toggle('ghost', !repeatOne); };

  document.getElementById('offNeg').onclick = ()=>{ offset-=0.5; offView.textContent=offset.toFixed(1); };
  document.getElementById('offPos').onclick = ()=>{ offset+=0.5; offView.textContent=offset.toFixed(1); };

  rate.oninput = ()=>{ video.playbackRate = +rate.value; rateView.textContent = (+rate.value).toFixed(2)+'x'; };

  document.getElementById('btnTTS').onclick = ()=>{
    const i = findIdx(video.currentTime);
    if(i>=0){
      offset += (video.currentTime - cues[i].start);
      offView.textContent = offset.toFixed(1);
    }
  };
  document.getElementById('btnSpeakLine').onclick = ()=>{
    const i = findIdx(video.currentTime); if(i<0) return;
    speak(cues[i].en);
  };

  function jumpRel(d){
    if(!cues.length) return;
    let i = findIdx(video.currentTime);
    if(i<0) i=0;
    i = Math.max(0, Math.min(cues.length-1, i+d));
    video.currentTime = Math.max(0, cues[i].start+offset);
    video.play();
  }

  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.pane').forEach(p=>p.hidden=true);
      document.getElementById(btn.dataset.pane).hidden=false;
    });
  });

  function renderQuiz(items){
    const host = document.getElementById('quizHost');
    const tabs = document.getElementById('quizTabs');
    const groups = groupBy(items, x=>x.section||'Mixed');
    const order = ['Vocabulary','Grammar','Reading','Mixed'];
    const sections = Object.keys(groups).sort((a,b)=> order.indexOf(a)-order.indexOf(b));
    tabs.innerHTML = ''; host.innerHTML='';

    sections.forEach((sec, si)=>{
      const id = 'sec_'+si;
      const pill = el('button', {class:'pill'+(si===0?' active':''), 'data-sec':id, 'text':`${sec} (${groups[sec].length})`});
      pill.onclick = ()=> switchSec(id);
      tabs.appendChild(pill);

      const wrap = el('div', {id, class:'sec', hidden: si!==0});
      groups[sec].forEach((q, idx)=> wrap.appendChild(renderQ(q, idx)));
      host.appendChild(wrap);
    });

    document.getElementById('btnSubmit').onclick = ()=>{
      let correct=0, total=0;
      host.querySelectorAll('.q').forEach(qn=>{
        total++;
        const ok = qn.dataset.ok==='1';
        if(ok) correct++;
      });
      const score = correct*5;
      document.getElementById('score').textContent = `本分區分數：${score} / ${(total*5)}（每題五分）`;
    };
    document.getElementById('btnReveal').onclick = ()=> host.querySelectorAll('[data-ans]').forEach(x=> x.textContent = '正解： '+x.dataset.ans);

    function renderQ(q, idx){
      const box = el('div',{class:'q'});
      box.appendChild(el('div',{class:'ti', 'html':`${idx+1}. ${escapeHTML(q.question)}`}));
      if((q.type||'MCQ').toUpperCase()==='MCQ'){
        const opts = q.options||[];
        opts.forEach(op=>{
          const line = el('label', {class:'opt'});
          const r = el('input',{type:'radio', name:'q'+Math.random().toString(36).slice(2)});
          line.appendChild(r);
          line.appendChild(el('span',{'text':op}));
          r.addEventListener('change', ()=>{
            const ok = String(op).trim() === String(q.answer).trim();
            box.dataset.ok = ok ? '1':'0';
          });
          box.appendChild(line);
        });
      }else{
        const ip = el('input',{type:'text', style:'width:100%'});
        const chk = el('button',{class:'btn', 'text':'檢查'});
        chk.onclick = ()=>{
          const ok = eqAns(ip.value, q.answer);
          box.dataset.ok = ok ? '1':'0';
        };
        box.appendChild(ip); box.appendChild(el('div',{style:'height:6px'})); box.appendChild(chk);
      }
      box.appendChild(el('div',{class:'hint', 'data-ans':String(q.answer)}));
      if(q.explanation) box.appendChild(el('div',{class:'hint', 'text':'說明： '+q.explanation}));
      return box;
    }
    function switchSec(id){
      tabs.querySelectorAll('.pill').forEach(p=> p.classList.toggle('active', p.dataset.sec===id));
      host.querySelectorAll('.sec').forEach(s=> s.hidden = (s.id!==id));
      document.getElementById('score').textContent='';
    }
  }

  function renderVocab(items){
    const box = document.getElementById('vocabList');
    box.innerHTML = '';
    items.forEach(v=>{
      const row = el('div',{class:'vocab'});
      row.appendChild(el('div',{'html':`<b>${escapeHTML(v.word)}</b> ${v.pos?`<span class="hint">(${escapeHTML(v.pos)})</span>`:''}`}));
      row.appendChild(el('div',{'text': v.zh || ''}));
      row.onclick = ()=> speak(v.word);
      box.appendChild(row);
    });
  }

  function renderAI(data){
    const list = (data.topics||[]);
    const sel = document.getElementById('aiTopic');
    list.forEach((t,i)=> sel.appendChild(new Option(`${i+1}. ${t.title||('Topic '+(i+1))}`, i)));
    let idx = 0;
    function show(i){
      idx=(i+list.length)%list.length;
      const t = list[idx] || {};
      setVal('aiPrompt', t.prompt || '');
      setText('aiHint', (t.hint? (t.hint+' / '):'') + (t.words? t.words.join(', '):''));
      setHTML('aiSampleBox', t.sample || '');
      sel.value = idx;
    }
    sel.onchange = ()=> show(+sel.value);
    document.getElementById('aiPrev').onclick = ()=> show(idx-1);
    document.getElementById('aiNext').onclick = ()=> show(idx+1);
    document.getElementById('aiSample').onclick = ()=> setHTML('aiSampleBox', list[idx]?.sample || '');
    document.getElementById('aiSpeak').onclick = ()=> speak(getVal('aiPrompt'));
    document.getElementById('aiSpeakAns').onclick = ()=> speak(textContentOf('aiSampleBox'));
    document.getElementById('aiStart').onclick = ()=> speak('Start speaking.');
    document.getElementById('aiStop').onclick = ()=> window.speechSynthesis?.cancel();
    show(0);
  }

  function fetchJSON(u){ return fetch(u, {cache:'no-store'}).then(r=>{ if(!r.ok) throw new Error(r.status); return r.json(); }); }
  function groupBy(arr, fn){ const m={}; arr.forEach(x=>{const k=fn(x);(m[k]||(m[k]=[])).push(x)}); return m; }
  function el(tag, props){ const n=document.createElement(tag); for(const k in props){ if(k==='text') n.textContent=props[k]; else if(k==='html') n.innerHTML=props[k]; else n.setAttribute(k, props[k]); } return n; }
  function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function eqAns(a,b){ return String(a).trim().toLowerCase()===String(b).trim().toLowerCase(); }
  function speak(t){ if(!t) return; try{ const u=new SpeechSynthesisUtterance(String(t)); u.rate=1; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch{} }
  function setVal(id,v){ const n=document.getElementById(id); if(n) n.value=v; }
  function getVal(id){ const n=document.getElementById(id); return n? n.value : ''; }
  function setText(id,t){ const n=document.getElementById(id); if(n) n.textContent=t; }
  function setHTML(id,t){ const n=document.getElementById(id); if(n) n.innerHTML=t; }
  function textContentOf(id){ const n=document.getElementById(id); return n? n.textContent : ''; }

  if(typeof window.initGate==='function'){
    try{ window.initGate({cat, slug}); }catch(e){ console.warn('initGate error', e); }
  }
})();
</script>
</body>
</html>





















































