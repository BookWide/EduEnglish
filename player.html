<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BookWide æ’­æ”¾å™¨ï¼ˆ4 åˆ†é  + æ¸¬é©—å››é¡ï¼‰</title>

<style>
:root{
  --bg:#0b1324;
  --panel:#0f172a;
  --border:#1f2a44;
  --ink:#e6f0ff;
  --muted:#9fb0c9;
  --accent:#3c7cff;
}

*,
*::before,
*::after{
  box-sizing:border-box;
}

html,body{
  margin:0;
  padding:0;
  height:100%;
  background:var(--bg);
  color:var(--ink);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",system-ui,sans-serif;
}

/* é é¦– */
header{
  position:sticky;
  top:0;
  z-index:40;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:8px 12px;
  background:#020617;
  border-bottom:1px solid var(--border);
}
header h1{
  margin:0;
  font-size:17px;
}
header .muted{
  color:var(--muted);
  font-size:13px;
}

/* å³ä¸Š email æ¨£å¼ */
.user-email{
  font-size:0.85rem;
  color:rgba(230,240,255,0.9);
  white-space:nowrap;
  max-width:260px;
  overflow:hidden;
  text-overflow:ellipsis;
  vertical-align:middle;
  margin-left:4px;
}

/* å¤–å±¤å¸ƒå±€ */
.wrap{
  display:flex;
  flex-direction:column;
  height:calc(100vh - 48px);
}

/* ä¸Šæ–¹ï¼šåˆ†é¡ + é¡Œç›®æ¨™é¡Œåˆ— */
.topbar{
  padding:6px 12px 4px;
  background:#020617;
  border-bottom:1px solid var(--border);
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  gap:8px;
  font-size:13px;
}
.topbar span.label{
  color:var(--muted);
}

/* ä¸»é«” layoutï¼šå·¦å³åˆ†æ¬„ï¼ˆæ¡Œæ©Ÿï¼‰ï¼ä¸Šä¸‹ï¼ˆæ‰‹æ©Ÿï¼‰ */
.layout{
  flex:1;
  display:flex;
  min-height:0;
}

/* å·¦å€ï¼šå½±ç‰‡ + æ§åˆ¶åˆ— */
.left{
  flex:1;
  min-width:0;
  padding:10px;
  border-right:1px solid var(--border);
  display:flex;
  flex-direction:column;
  gap:8px;
}

.videoWrap{
  position:relative;
  width:100%;
  padding-top:56.25%;
  background:#020617;
  border-radius:12px;
  overflow:hidden;
  border:1px solid var(--border);
}
.videoWrap video{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  background:#000;
}

/* æ’­æ”¾æ§åˆ¶åˆ— */
.controls{
  padding:8px 10px;
  background:#020617;
  border-radius:10px;
  border:1px solid var(--border);
  display:flex;
  flex-direction:column;
  gap:6px;
  font-size:13px;
}
.controls .row{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  align-items:center;
}
.controls .row span.muted{
  color:var(--muted);
  margin-left:4px;
}

/* å³å€ï¼šå››åˆ†é ï¼ˆå­—å¹•ï¼æ¸¬é©—ï¼å–®å­—ï¼AIï¼‰ */
.right{
  flex:1;
  min-width:0;
  display:flex;
  flex-direction:column;
  background:#020617;
}

/* åˆ†é åˆ— */
.tabs{
  display:flex;
  border-bottom:1px solid var(--border);
  background:#020617;
}
.tabs button{
  flex:1;
  background:none;
  border:0;
  padding:10px 4px;
  font-size:13px;
  color:var(--muted);
  cursor:pointer;
  border-bottom:2px solid transparent;
}
.tabs button.active{
  color:var(--ink);
  border-bottom-color:var(--accent);
}

/* å³å´å…§å®¹å¯æ²å‹•å€ */
.tab-panels{
  flex:1;
  min-height:0;
  position:relative;
  display:flex;
  flex-direction:column;
}
.tab-panel{
  position:absolute;
  inset:0;
  padding:8px 10px 12px;
  overflow-y:auto;
  display:none;
}
.tab-panel.active{
  display:block;
}

/* å­—å¹•è¡¨æ ¼ */
.cue-table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
.cue-table th,
.cue-table td{
  padding:4px 6px;
  border-bottom:1px solid #1e293b;
  vertical-align:top;
}
.cue-table th{
  position:sticky;
  top:0;
  background:#020617;
  z-index:1;
}
.cue-table td.time{
  white-space:nowrap;
  color:var(--muted);
  cursor:pointer;
}
.cue-table td.text{
  cursor:pointer;
}
.cue-table tr:hover td{
  background:#020617;
}
.cue-table tr.active td{
  background:#1f2937;
}

/* æ¸¬é©—å€ */
.quiz-header{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  align-items:center;
  margin-bottom:8px;
}
.quiz-header .pill-group{
  display:flex;
  flex-wrap:wrap;
  gap:4px;
}
.pill{
  border-radius:999px;
  padding:3px 10px;
  font-size:12px;
  border:1px solid #334155;
  color:var(--muted);
  background:#020617;
  cursor:pointer;
}
.pill.active{
  border-color:var(--accent);
  color:var(--ink);
}

/* æ¸¬é©—è©¦é¡Œåˆ—è¡¨ */
.quiz-list{
  margin:0;
  padding:0;
  list-style:none;
  font-size:13px;
}
.quiz-list li{
  padding:6px 6px 8px;
  border-bottom:1px solid #1e293b;
}
.quiz-q{
  font-weight:600;
  margin-bottom:4px;
}
.quiz-q .q-no{
  display:inline-block;
  min-width:1.5em;
}
.quiz-opts{
  margin:4px 0 0;
  padding-left:0;
  list-style:none;
}
.quiz-opts li{
  margin:2px 0;
}
.quiz-opts label{
  display:flex;
  gap:6px;
  cursor:pointer;
}
.quiz-opts input[type="radio"]{
  margin-top:2px;
}
.quiz-ans{
  margin-top:4px;
  color:#22c55e;
  font-size:12px;
  display:none;
}
.quiz-ans.show{
  display:block;
}
.quiz-footer{
  margin-top:10px;
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  align-items:center;
  font-size:12px;
  color:var(--muted);
}

/* å–®å­—å€ */
.vocab-list{
  margin:0;
  padding:0;
  list-style:none;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.vocab-item{
  padding:8px 10px;
  border-radius:10px;
  background:#020617;
  border:1px solid #1e293b;
}
.vocab-head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:4px;
  font-size:14px;
}
.vocab-head .pos{
  color:var(--muted);
  font-size:12px;
}
.vocab-phon{
  font-size:12px;
  color:var(--muted);
  margin-bottom:4px;
}
.vocab-zh{
  font-size:13px;
  margin-bottom:4px;
}
.vocab-ex{
  font-size:12px;
  color:var(--muted);
}

/* AI å€ */
.ai-prompt{
  margin-bottom:6px;
  font-size:13px;
}
.ai-prompt textarea{
  width:100%;
  min-height:60px;
  border-radius:8px;
  border:1px solid #1e293b;
  background:#020617;
  color:var(--ink);
  padding:6px 8px;
  resize:vertical;
  font-family:inherit;
  font-size:13px;
}
.ai-log{
  margin-top:8px;
  font-size:13px;
  max-height:260px;
  overflow-y:auto;
  border-top:1px solid #1e293b;
  padding-top:6px;
}
.ai-msg{
  margin-bottom:6px;
}
.ai-msg.me{
  color:#7dd3fc;
}
.ai-msg.ai{
  color:#bbf7d0;
}

/* å…±ç”¨æŒ‰éˆ• */
.btn{
  background:#13233f;
  border:1px solid #24446f;
  border-radius:10px;
  padding:7px 12px;
  color:#fff;
  cursor:pointer;
  font-size:14px;
}
.btn.blue{background:#14335f;border-color:#2c5aa3;}
.btn.sm{padding:5px 10px;font-size:13px;border-radius:999px;}
.btn.sm.blue{background:#1d4ed8;border-color:#1d4ed8;}
.btn:disabled{
  opacity:.4;
  cursor:default;
}

/* å¿«æ·é–‹é—œ */
.toggle{
  display:inline-flex;
  align-items:center;
  gap:4px;
  font-size:12px;
}
.toggle input{
  width:30px;
}

/* æ²å‹•æ¢æ¨£å¼ï¼ˆå³å´ï¼‰ */
.tab-panel::-webkit-scrollbar{
  width:8px;
}
.tab-panel::-webkit-scrollbar-track{
  background:#020617;
}
.tab-panel::-webkit-scrollbar-thumb{
  background:#334155;
  border-radius:999px;
}

/* æ‰‹æ©Ÿç‰ˆï¼šä¸Šä¸‹åˆ‡ */
@media (max-width:900px){
  .layout{
    flex-direction:column;
  }
  .left{
    border-right:0;
    border-bottom:1px solid var(--border);
  }
}

/* åˆ—å°æ¨£å¼ï¼ˆåªå°æ¸¬é©—ï¼‰ */
@media print{
  body{
    background:#fff;
    color:#000;
  }
  header,
  .wrap > .topbar,
  .left,
  .tabs,
  .tab-panel:not(#panel-quiz){
    display:none!important;
  }
  .wrap{
    height:auto;
  }
  .layout{
    display:block;
  }
  .right{
    border:0;
  }
  #panel-quiz{
    position:static;
    padding:0;
    overflow:visible;
  }
  .quiz-list li{
    page-break-inside:avoid;
  }
  .quiz-ans{
    display:block;
  }
  .quiz-footer{
    display:none;
  }
  .user-email{
    display:none!important;
  }
}

/* è®“å³å´å…§å®¹ç¨å¾®å†é•· 10pxï¼Œé¿å…é‚Šç•Œè¢«åƒ */
.tab-panel{
  padding-bottom:14px;
}
</style>

<!-- Supabase JSï¼ˆåªç”¨æ–¼ player å®ˆé–€ï¼Œä¸å½±éŸ¿å…¶å®ƒé é¢ï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = 'https://jeajrwpmrgczimmrflxo.supabase.co';
  const SUPABASE_ANON_KEY =
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do';

  const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  async function guardAndShowEmail() {
    try {
      const { data, error } = await supa.auth.getUser();
      if (error || !data || !data.user) {
        const next = encodeURIComponent(location.pathname + location.search);
        window.location.href = '/EduEnglish/index.html?denied=signin&next=' + next;
        return;
      }
      const email = data.user.email || '';
      const badge = document.getElementById('userNameBadge');
      if (badge && email) {
        badge.textContent = email;
        badge.classList.add('user-email');
      }
      console.log('[player-guard] signed in as', email);
    } catch (err) {
      console.error('[player-guard] error', err);
    }
  }

  document.addEventListener('DOMContentLoaded', guardAndShowEmail);
</script>
</head>
<body>
<header>
  <h1>æ’­æ”¾å™¨</h1>
  <div style="display:flex;align-items:center;gap:10px">
    <a class="btn" href="https://bookwide.github.io/EduEnglish/index.html">ğŸ  å›é¦–é </a>
    <span class="muted user-email" id="userNameBadge"></span>
  </div>
</header>

<div class="wrap">
  <div class="topbar">
    <span class="label">åˆ†é¡ï¼š</span>
    <span id="catLabel">story</span>
    <span class="label" style="margin-left:8px">æ¨™é¡Œï¼š</span>
    <span id="titleLabel">â€”</span>
    <span class="label" style="margin-left:8px">Slugï¼š</span>
    <span id="slugLabel">â€”</span>
  </div>

  <div id="track" class="layout">
    <!-- å·¦ï¼šå½±ç‰‡ -->
    <section class="page" id="pageLeft">
      <section class="left">
        <div class="videoWrap">
          <video id="player" playsinline controls></video>
        </div>
        <div class="controls">
          <div class="row">
            <button class="btn" id="btnPrev">â® ä¸Šä¸€å¥</button>
            <button class="btn" id="btnPlay">â–¶ï¸ / â¸</button>
            <button class="btn" id="btnNext">â­ ä¸‹ä¸€å¥</button>
            <button class="btn" id="btnReplay">ğŸ” é‡æ’­å¥å­</button>
          </div>
          <div class="row">
            <span class="muted">é€Ÿåº¦ï¼š</span>
            <input type="range" id="speedRange" min="0.5" max="1.5" step="0.05" value="1" />
            <span id="speedLabel" class="muted">1.00Ã—</span>
          </div>
          <div class="row">
            <label class="toggle">
              <input type="checkbox" id="chkFollow" checked />
              <span>è·Ÿéš¨å­—å¹•</span>
            </label>
            <label class="toggle">
              <input type="checkbox" id="chkAutoPause" />
              <span>æ¯å¥è‡ªå‹•æš«åœ</span>
            </label>
            <span class="muted" id="currentTimeLabel">00:00 / 00:00</span>
          </div>
        </div>
      </section>
    </section>

    <!-- å³ï¼šå››åˆ†é  -->
    <section class="page" id="pageRight">
      <section class="right">
        <div class="tabs">
          <button class="active" data-tab="panel-cue">å­—å¹•</button>
          <button data-tab="panel-quiz">æ¸¬é©—</button>
          <button data-tab="panel-vocab">å–®å­—</button>
          <button data-tab="panel-ai">AI äº’å‹•</button>
        </div>

        <div class="tab-panels">
          <!-- å­—å¹• TAB -->
          <div class="tab-panel active" id="panel-cue">
            <table class="cue-table">
              <thead>
                <tr>
                  <th style="width:70px">æ™‚é–“</th>
                  <th>è‹±æ–‡</th>
                  <th>ä¸­æ–‡</th>
                  <th>æ—¥æ–‡</th>
                </tr>
              </thead>
              <tbody id="cueTbody"></tbody>
            </table>
          </div>

          <!-- æ¸¬é©— TAB -->
          <div class="tab-panel" id="panel-quiz">
            <div class="quiz-header">
              <div class="pill-group">
                <button class="pill active" data-qcat="vocab">Vocabulary</button>
                <button class="pill" data-qcat="grammar">Grammar</button>
                <button class="pill" data-qcat="reading">Reading</button>
                <button class="pill" data-qcat="mixed">Mixed</button>
              </div>
              <button class="btn sm blue" id="btnShowAns">é¡¯ç¤º / éš±è—ç­”æ¡ˆ</button>
              <button class="btn sm" id="btnPrintQuiz">åˆ—å°å››é¡è©¦é¡Œ</button>
            </div>
            <ul class="quiz-list" id="quizList"></ul>
            <div class="quiz-footer">
              <span>ç›®å‰é¡åˆ¥ï¼š<span id="quizCatLabel">Vocabulary</span></span>
            </div>
          </div>

          <!-- å–®å­— TAB -->
          <div class="tab-panel" id="panel-vocab">
            <ul class="vocab-list" id="vocabList"></ul>
          </div>

          <!-- AI TAB -->
          <div class="tab-panel" id="panel-ai">
            <div class="ai-prompt">
              <div class="muted" style="margin-bottom:4px">
                è«‹ç”¨è‹±æ–‡å•å•é¡Œï¼ŒAI æœƒä¾å½±ç‰‡å…§å®¹å›è¦†ï¼ˆdemo ç‰ˆï¼Œåƒ…æœ¬æ©Ÿæ¨¡æ“¬ï¼Œä¸é€£ç¶²ï¼‰ã€‚
              </div>
              <textarea id="aiInput" placeholder="ä¾‹å¦‚ï¼šExplain the story in simple English."></textarea>
              <div style="margin-top:6px;display:flex;gap:6px;align-items:center">
                <button class="btn sm blue" id="btnAskAI">é€å‡º</button>
                <span class="muted" id="aiStatus"></span>
              </div>
            </div>
            <div class="ai-log" id="aiLog"></div>
          </div>
        </div>
      </section>
    </section>
  </div>
</div>

<script>
// ç°¡æ˜“ $ helper
const $ = (s, e=document)=>e.querySelector(s);
const $$ = (s, e=document)=>[...e.querySelectorAll(s)];

/* ==== URL åƒæ•¸è§£æ ==== */
function getQuery(){
  const p = new URLSearchParams(location.search);
  return {
    cat: p.get('cat') || 'story',
    slug: p.get('slug') || 'houyi'
  };
}

/* ==== åˆå§‹åŒ– + åŸæœ¬å®ˆé–€ç¨‹å¼ï¼ˆä¿ç•™ï¼Œä½†ç¾åœ¨ä¸»è¦å®ˆé–€æ”¹ç”± Supabase JS å®Œæˆï¼‰ ==== */
(async function init(){
  try{
    // èˆŠç‰ˆå®ˆé–€ï¼šè‹¥é é¢ä¸Šæœ‰ ensureAuth æ‰æœƒè§¸ç™¼ï¼Œå¦å‰‡ç•¥é
    if(typeof ensureAuth==='function'){
      await ensureAuth({
        redirect:'/EduEnglish/index.html',
        next:location.pathname+location.search
      });
    }
    let email='';
    if(typeof getSessionUser==='function'){
      const u=await getSessionUser();
      email=(u&&(u.email||(u.user&&u.user.email)))||'';
    }else if(typeof supaGetUser==='function'){
      const u=await supaGetUser();
      email=(u&&(u.email||(u.user&&u.user.email)))||'';
    }
    if(email){
      const badge = $('#userNameBadge');
      if(badge){
        badge.textContent = email;
        badge.classList.add('user-email');
      }
    }
  }catch(e){
    console.warn('[auth] error:',e);
  }

  // === ä»¥ä¸‹ç‚ºæ’­æ”¾å™¨çš„ä¸»ç¨‹å¼ ===

  const video       = $('#player');
  const cueTbody    = $('#cueTbody');
  const quizList    = $('#quizList');
  const vocabList   = $('#vocabList');
  const aiInput     = $('#aiInput');
  const aiLog       = $('#aiLog');
  const aiStatus    = $('#aiStatus');
  const btnAskAI    = $('#btnAskAI');
  const catLabel    = $('#catLabel');
  const titleLabel  = $('#titleLabel');
  const slugLabel   = $('#slugLabel');
  const btnPrev     = $('#btnPrev');
  const btnPlay     = $('#btnPlay');
  const btnNext     = $('#btnNext');
  const btnReplay   = $('#btnReplay');
  const speedRange  = $('#speedRange');
  const speedLabel  = $('#speedLabel');
  const chkFollow   = $('#chkFollow');
  const chkAutoPause= $('#chkAutoPause');
  const currentTimeLabel = $('#currentTimeLabel');
  const quizCatLabel= $('#quizCatLabel');
  const btnShowAns  = $('#btnShowAns');
  const btnPrintQuiz= $('#btnPrintQuiz');

  const { cat, slug } = getQuery();
  catLabel.textContent = cat;
  slugLabel.textContent = slug;

  // === è¼‰å…¥å½±ç‰‡èˆ‡ JSON ===
  const base = `./data/${cat}/${slug}`;
  const videoSrc = `./videos/${cat}/${slug}.mp4`;

  // è¨­å®šå½±ç‰‡ä¾†æº
  video.src = videoSrc;

  // è®€å– JSONï¼šå­—å¹•ï¼æ¸¬é©—ï¼å–®å­—
  async function loadJSON(path){
    const res = await fetch(path);
    if(!res.ok) throw new Error('è¼‰å…¥å¤±æ•—ï¼š'+path);
    return await res.json();
  }

  let cues  = [];
  let quiz  = [];
  let vocab = [];

  try{
    const [cueData, quizData, vocabData] = await Promise.all([
      loadJSON(`${base}/cues-${slug}.json`),
      loadJSON(`${base}/quiz-${slug}.json`),
      loadJSON(`${base}/vocab-${slug}.json`)
    ]);

    cues  = cueData.cues || cueData || [];
    quiz  = quizData.quiz || quizData || [];
    vocab = vocabData.vocab || vocabData || [];
    const metaTitle = cueData.title || quizData.title || vocabData.title || slug;
    titleLabel.textContent = metaTitle;
  }catch(err){
    console.error(err);
    titleLabel.textContent = 'è¼‰å…¥è³‡æ–™å¤±æ•—';
  }

  /* ==== å­—å¹•æ¸²æŸ“ ==== */
  let currentCueIndex = -1;

  function formatTime(sec){
    if(!Number.isFinite(sec)) return '--:--';
    const m = Math.floor(sec/60);
    const s = Math.floor(sec%60);
    return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
  }

  function renderCues(){
    cueTbody.innerHTML = '';
    cues.forEach((c,idx)=>{
      const tr = document.createElement('tr');
      tr.dataset.index = idx;
      const tdTime = document.createElement('td');
      tdTime.className = 'time';
      tdTime.textContent = `${formatTime(c.start)} â†’ ${formatTime(c.end)}`;
      const tdEn = document.createElement('td');
      tdEn.className = 'text';
      tdEn.textContent = c.en || '';
      const tdZh = document.createElement('td');
      tdZh.className = 'text';
      tdZh.textContent = c.zh || '';
      const tdJa = document.createElement('td');
      tdJa.className = 'text';
      tdJa.textContent = c.ja || '';
      tr.append(tdTime,tdEn,tdZh,tdJa);
      cueTbody.appendChild(tr);
    });
  }

  renderCues();

  function setActiveCue(idx){
    if(idx===currentCueIndex) return;
    currentCueIndex = idx;
    $$('#cueTbody tr').forEach(tr=>{
      tr.classList.toggle('active', Number(tr.dataset.index)===idx);
    });
    if(chkFollow.checked){
      const active = $('#cueTbody tr.active');
      if(active){
        const rect = active.getBoundingClientRect();
        const parentRect = active.parentElement.getBoundingClientRect();
        if(rect.top<parentRect.top || rect.bottom>parentRect.bottom){
          active.scrollIntoView({block:'center'});
        }
      }
    }
  }

  cueTbody.addEventListener('click', e=>{
    const tr = e.target.closest('tr');
    if(!tr) return;
    const idx = Number(tr.dataset.index||'-1');
    if(idx<0 || !cues[idx]) return;
    video.currentTime = cues[idx].start||0;
    video.play();
    setActiveCue(idx);
  });

  video.addEventListener('timeupdate', ()=>{
    const t = video.currentTime;
    const d = video.duration || 0;
    currentTimeLabel.textContent = `${formatTime(t)} / ${formatTime(d)}`;
    const idx = cues.findIndex(c=>t>=c.start && t<c.end);
    if(idx>=0) setActiveCue(idx);
  });

  video.addEventListener('ended', ()=>{
    if(chkAutoPause.checked){
      video.pause();
    }
  });

  btnPrev.addEventListener('click',()=>{
    if(!cues.length) return;
    const idx = currentCueIndex>0 ? currentCueIndex-1 : 0;
    const c = cues[idx];
    video.currentTime = c.start||0;
    video.play();
    setActiveCue(idx);
  });
  btnNext.addEventListener('click',()=>{
    if(!cues.length) return;
    const idx = currentCueIndex>=0 && currentCueIndex<cues.length-1 ? currentCueIndex+1 : cues.length-1;
    const c = cues[idx];
    video.currentTime = c.start||0;
    video.play();
    setActiveCue(idx);
  });
  btnReplay.addEventListener('click',()=>{
    if(currentCueIndex<0 || !cues[currentCueIndex]) return;
    const c = cues[currentCueIndex];
    video.currentTime = c.start||0;
    video.play();
  });

  btnPlay.addEventListener('click',()=>{
    if(video.paused) video.play(); else video.pause();
  });

  speedRange.addEventListener('input',()=>{
    const v = Number(speedRange.value||'1');
    video.playbackRate = v;
    speedLabel.textContent = v.toFixed(2)+'Ã—';
  });

  /* ==== æ¸¬é©—æ¸²æŸ“ ==== */
  let currentQuizCat = 'vocab'; // vocab / grammar / reading / mixed

  function renderQuiz(){
    quizList.innerHTML = '';
    const filtered = quiz.filter(q=> (q.category||'vocab')===currentQuizCat );
    filtered.forEach((q,idx)=>{
      const li = document.createElement('li');
      const qDiv = document.createElement('div');
      qDiv.className = 'quiz-q';
      const noSpan = document.createElement('span');
      noSpan.className = 'q-no';
      noSpan.textContent = (idx+1)+'.';
      qDiv.appendChild(noSpan);
      const textSpan = document.createElement('span');
      textSpan.textContent = q.question||'';
      qDiv.appendChild(textSpan);

      const optUl = document.createElement('ul');
      optUl.className = 'quiz-opts';
      (q.options||[]).forEach((opt,optIdx)=>{
        const liOpt = document.createElement('li');
        const label = document.createElement('label');
        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = `q_${currentQuizCat}_${idx}`;
        radio.value = String(optIdx);
        const spanOpt = document.createElement('span');
        spanOpt.textContent = opt;
        label.append(radio,spanOpt);
        liOpt.appendChild(label);
        optUl.appendChild(liOpt);
      });

      const ansDiv = document.createElement('div');
      ansDiv.className = 'quiz-ans';
      ansDiv.textContent = 'ç­”æ¡ˆï¼š'+(q.answerText||q.answer||'');

      li.append(qDiv,optUl,ansDiv);
      quizList.appendChild(li);
    });
  }

  renderQuiz();

  $$('.pill').forEach(btn=>{
    btn.addEventListener('click',()=>{
      $$('.pill').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      currentQuizCat = btn.dataset.qcat||'vocab';
      quizCatLabel.textContent = btn.textContent.trim();
      renderQuiz();
    });
  });

  btnShowAns.addEventListener('click',()=>{
    $$('.quiz-ans').forEach(el=>{
      el.classList.toggle('show');
    });
  });

  btnPrintQuiz.addEventListener('click',()=>{
    // ç›´æ¥èµ°ç€è¦½å™¨åˆ—å°
    window.print();
  });

  /* ==== å–®å­— ==== */
  function renderVocab(){
    vocabList.innerHTML = '';
    vocab.forEach(v=>{
      const li = document.createElement('li');
      li.className = 'vocab-item';
      const head = document.createElement('div');
      head.className = 'vocab-head';
      const wordSpan = document.createElement('span');
      wordSpan.textContent = v.word||'';
      const posSpan = document.createElement('span');
      posSpan.className = 'pos';
      posSpan.textContent = v.pos||'';
      head.append(wordSpan,posSpan);

      const phon = document.createElement('div');
      phon.className = 'vocab-phon';
      phon.textContent = v.phonetic||'';

      const zh = document.createElement('div');
      zh.className = 'vocab-zh';
      zh.textContent = v.zh||'';

      const ex = document.createElement('div');
      ex.className = 'vocab-ex';
      ex.textContent = v.example||'';

      li.append(head,phon,zh,ex);
      vocabList.appendChild(li);
    });
  }

  renderVocab();

  /* ==== AI demo ==== */
  function appendAiMsg(text, who='me'){
    const div = document.createElement('div');
    div.className = 'ai-msg '+who;
    div.textContent = text;
    aiLog.appendChild(div);
    aiLog.scrollTop = aiLog.scrollHeight;
  }

  btnAskAI.addEventListener('click',()=>{
    const text = (aiInput.value||'').trim();
    if(!text) return;
    appendAiMsg(text,'me');
    aiInput.value='';
    aiStatus.textContent = 'Thinking...';
    setTimeout(()=>{
      appendAiMsg('ï¼ˆdemoï¼‰æ ¹æ“šå½±ç‰‡å…§å®¹çš„è‹±æ–‡è§£èªª / ç·´ç¿’å›è¦†æœƒå‡ºç¾åœ¨é€™è£¡ã€‚','ai');
      aiStatus.textContent = '';
    },800);
  });

})(); // end init
</script>
</body>
</html>
