<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BookWide Player · Slim v3</title>
<style>
  :root{
    --bg:#0f1115; --panel:#131722; --muted:#8da0bc; --text:#e6eefc;
    --accent:#4ea1ff; --accent-2:#19c37d; --danger:#ff5470; --line:#253047;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font:15px/1.6 ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI",
          "PingFang TC","Noto Sans TC","Microsoft JhengHei", sans-serif;
  }

  /* ===== Top bar ===== */
  .topbar{
    position:sticky; top:0; z-index:50;
    display:flex; align-items:center; justify-content:space-between;
    gap:.75rem; padding:.6rem .9rem; background:rgba(19,23,34,.9); backdrop-filter:saturate(140%) blur(6px);
    border-bottom:1px solid var(--line);
  }
  .btn{
    display:inline-flex; align-items:center; gap:.4rem;
    padding:.45rem .7rem; border:1px solid var(--line);
    background:#0e1420; color:var(--text); border-radius:.55rem;
    text-decoration:none; cursor:pointer; user-select:none;
  }
  .btn:hover{border-color:#35507a}
  .btn.primary{background:linear-gradient(180deg,#0f1e33,#0d1a2b); border-color:#2a4772}
  .title{font-weight:700; opacity:.92}
  .title small{color:var(--muted); margin-left:.5rem}

  /* ===== Two columns ===== */
  .wrap{
    display:grid; grid-template-columns:1fr 1fr; gap:.9rem; padding:.9rem;
    height:calc(100vh - 56px); /* minus topbar height approx */
  }
  .left, .right{
    background:var(--panel); border:1px solid var(--line); border-radius:.8rem; overflow:hidden;
    display:flex; flex-direction:column; min-height:0;
  }

  /* Video area */
  #videoWrap{ position:relative; flex:1; min-height:0; display:flex; align-items:center; justify-content:center; background:#000;}
  video{ width:100%; height:100%; object-fit:contain; background:#000;}
  .video-msg{
    position:absolute; inset:auto 12px 12px 12px;
    padding:.6rem .8rem; background:rgba(0,0,0,.6); border:1px solid var(--line); border-radius:.6rem;
    color:#cfe1ff; font-size:.92rem;
  }

  /* Bottom controls – stick inside left */
  .controls{
    position:sticky; bottom:0; border-top:1px solid var(--line);
    padding:.55rem .7rem; display:flex; flex-wrap:wrap; gap:.45rem .5rem; background:rgba(14,18,28,.95);
  }
  .seg{display:flex; gap:.4rem; align-items:center; background:#0b1220; border:1px solid var(--line); padding:.35rem .45rem; border-radius:.6rem}
  .seg input[type=range]{width:160px}
  .tag{padding:.18rem .5rem; border-radius:.5rem; background:#0e1728; border:1px solid var(--line); color:var(--muted); font-size:.85rem}
  .switch{display:inline-flex; align-items:center; gap:.35rem}
  .switch input{accent-color:var(--accent)}

  /* ===== Right side tabs ===== */
  .tabs{display:flex; gap:.4rem; padding:.5rem; border-bottom:1px solid var(--line); background:#0f1624}
  .tab{padding:.45rem .8rem; border-radius:.55rem; border:1px solid var(--line); cursor:pointer; user-select:none; color:var(--muted)}
  .tab.active{color:var(--text); border-color:#3a5582; background:#0e1522}

  .pane{flex:1; min-height:0; overflow:auto; padding:.6rem}
  .cue{padding:.5rem .6rem; border-bottom:1px dashed #20304a; cursor:pointer}
  .cue .zh{color:#b7c6e6}
  .cue.active{background:#0d1a2b; border-left:3px solid var(--accent)}
  .muted{color:var(--muted)}
  .badge{display:inline-block; padding:.2rem .55rem; border:1px solid var(--line); border-radius:.55rem; color:var(--muted)}
  .list{display:flex; flex-direction:column; gap:.5rem}

  /* quiz */
  .q{border:1px solid var(--line); border-radius:.7rem; padding:.7rem; background:#0e1524}
  .q h4{margin:.1rem 0 .4rem}
  .opts{display:flex; flex-direction:column; gap:.35rem}
  .opt{
    display:flex; align-items:center; gap:.5rem; padding:.42rem .55rem;
    border:1px solid #1f2c46; border-radius:.55rem; cursor:pointer;
  }
  .opt input{accent-color:var(--accent)}
  .row{display:flex; gap:.5rem; align-items:center; flex-wrap:wrap}
  .pill{padding:.22rem .5rem; border:1px solid var(--line); border-radius:.6rem; background:#0c1424; color:#cfe1ff}
  .score{font-weight:700; color:#bde6cc}
  .danger{color:#ff98a8}
  .ok{color:#8ff0b1}

  /* vocab */
  .vitem{display:flex; justify-content:space-between; gap:.6rem; padding:.55rem .6rem; border:1px solid var(--line); border-radius:.6rem; background:#0f1728}
  .vhead{display:flex; gap:.45rem; align-items:center}
  .vword{font-weight:700}
  .tts{cursor:pointer; border:1px solid var(--line); padding:.24rem .5rem; border-radius:.5rem; background:#0b1220}

  /* AI */
  .ait{border:1px solid var(--line); border-radius:.7rem; padding:.7rem; background:#0e1524}

  /* print */
  @media print{
    .topbar, .controls{position:static}
    .wrap{display:block; height:auto}
    .left, .right{height:auto}
    #videoWrap{display:none} /* 影片不列印 */
    .pane{overflow:visible}
    .cue{page-break-inside:avoid}
    .q{page-break-inside:avoid}
  }

  /* mobile */
  @media (max-width:980px){
    .wrap{grid-template-columns:1fr} /* 直式手機：上下堆疊，但工具列仍在影片底下 */
  }
</style>
</head>
<body>
  <!-- ===== Top bar ===== -->
  <header class="topbar">
    <a class="btn" id="btnHome" href="./index.html">← 回首頁</a>
    <div class="title" id="title">BookWide Player</div>
    <button class="btn primary" id="btnFav" title="收藏">★ 收藏</button>
  </header>

  <main class="wrap">
    <!-- ===== Left : Video + Controls ===== -->
    <section class="left">
      <div id="videoWrap">
        <video id="player" preload="metadata" controls></video>
        <div id="videoMsg" class="video-msg" hidden></div>
      </div>

      <!-- Controls -->
      <div class="controls" id="ctrls">
        <div class="seg">
          <button class="btn" id="prev">上一句</button>
          <button class="btn" id="play">播放 / 暫停</button>
          <button class="btn" id="next">下一句</button>
          <button class="btn" id="repeat">重複本句</button>
          <label class="switch"><input type="checkbox" id="follow" checked> 跟隨</label>
        </div>
        <div class="seg">
          <span class="tag">偏移</span>
          <button class="btn" id="offM">-0.5s</button>
          <button class="btn" id="offP">+0.5s</button>
          <span class="badge" id="offView">0.0s</span>
        </div>
        <div class="seg">
          <span class="tag">速度</span>
          <input id="speed" type="range" min="0.5" max="2.0" step="0.05" value="1">
          <span class="badge" id="speedView">1.00x</span>
        </div>
        <button class="btn" id="calib">簡易校準</button>
      </div>
    </section>

    <!-- ===== Right : Tabs ===== -->
    <section class="right">
      <nav class="tabs" id="tabs">
        <div class="tab active" data-pane="pane-cues">字幕</div>
        <div class="tab" data-pane="pane-quiz">測驗</div>
        <div class="tab" data-pane="pane-vocab">單字</div>
        <div class="tab" data-pane="pane-ai">AI 互動</div>
      </nav>

      <div class="pane" id="pane-cues">
        <div id="cues" class="list"></div>
      </div>

      <div class="pane" id="pane-quiz" hidden>
        <div class="row" style="margin:.4rem 0 .7rem">
          <span class="pill">Vocabulary</span>
          <span class="pill">Grammar</span>
          <span class="pill">Reading</span>
          <span class="pill">Mixed</span>
          <span class="pill score" id="scoreBox">本分區分數：0 / 100</span>
        </div>
        <div id="quiz" class="list"></div>
        <div class="row" style="margin-top:.7rem">
          <button class="btn" id="btnSubmit">交卷</button>
          <button class="btn" id="btnShow">顯示答案</button>
          <button class="btn" id="btnPrint">列印成績單</button>
        </div>
      </div>

      <div class="pane" id="pane-vocab" hidden>
        <div id="vocab" class="list"></div>
      </div>

      <div class="pane" id="pane-ai" hidden>
        <div id="ai" class="list"></div>
      </div>
    </section>
  </main>

<script>
(() => {
  /* ===== URL & Paths ===== */
  const params = new URLSearchParams(location.search);
  const cat = (params.get('cat') || 'story').toLowerCase();
  const slug = (params.get('slug') || 'mid-autumn').toLowerCase();

  const P_VIDEO = `./videos/${cat}/${slug}.mp4`;
  const P_CUES  = `./data/${cat}/cues-${slug}.json`;
  const P_QUIZ  = `./data/${cat}/quiz-${slug}.json`;
  const P_VOCAB = `./data/${cat}/vocab-${slug}.json`;
  const P_AI    = `./data/${cat}/ai-${slug}.json`;

  /* ===== DOM ===== */
  const elTitle = document.getElementById('title');
  const elVideo = document.getElementById('player');
  const elMsg   = document.getElementById('videoMsg');
  const elCues  = document.getElementById('cues');
  const elQuiz  = document.getElementById('quiz');
  const elVocab = document.getElementById('vocab');
  const elAI    = document.getElementById('ai');

  /* ===== State ===== */
  let cues = [];            // [{start,end,en,zh}]
  let curIndex = -1;
  let offset = 0;
  let repeatThis = false;
  let speaking = false;

  /* ===== Utils ===== */
  const fetchJSON = async (url) => {
    const r = await fetch(`${url}?v=${Date.now()}`, {cache:'no-store'});
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  };
  const s = (t)=> String(t).padStart(2,'0');
  const hhmmss = (sec)=>{
    sec = Math.max(0, sec|0);
    const h = (sec/3600)|0, m = ((sec%3600)/60)|0, s2 = sec%60;
    return (h? h+':':'') + s(m)+':'+s(s2);
  };

  /* ===== Topbar title ===== */
  elTitle.textContent = `BookWide Player  ·  ${cat}/${slug}`;

  /* ===== Tabs ===== */
  document.querySelectorAll('.tab').forEach(t=>{
    t.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      document.querySelectorAll('.pane').forEach(x=>x.hidden=true);
      t.classList.add('active');
      document.getElementById(t.dataset.pane).hidden = false;
    });
  });

  /* ===== Video ===== */
  function showMsg(txt, danger=false){
    elMsg.textContent = txt;
    elMsg.style.borderColor = danger ? 'var(--danger)' : 'var(--line)';
    elMsg.hidden = false;
  }
  function hideMsg(){ elMsg.hidden = true; }

  function loadVideo(){
    elVideo.src = P_VIDEO;
    elVideo.playbackRate = 1;
    elVideo.addEventListener('error', ()=>{
      showMsg(`沒有找到影片來源：${P_VIDEO}`, true);
    }, {once:true});
  }

  /* ===== Cues (only story-format array) ===== */
  function normalizeCues(arr){
    // 必須是 array of {start,end,en,zh}；start/end 接受 number 或 "00:01"
    const toSec = (v)=>{
      if(typeof v === 'number') return v;
      if(typeof v === 'string'){
        const m = v.trim().split(':').map(Number);
        if(m.length===3) return m[0]*3600+m[1]*60+m[2];
        if(m.length===2) return m[0]*60+m[1];
        return Number(v)||0;
      }
      return 0;
    };
    return (arr||[]).map(x=>({
      start: toSec(x.start ?? x.time ?? 0),
      end  : toSec(x.end ?? 1e9),
      en   : String(x.en||'').trim(),
      zh   : String(x.zh||'').trim()
    })).filter(x=>x.en || x.zh).sort((a,b)=>a.start-b.start);
  }

  function renderCues(){
    elCues.innerHTML = '';
    cues.forEach((c,i)=>{
      const div = document.createElement('div');
      div.className = 'cue'; div.dataset.i = i;
      div.innerHTML = `
        <div class="en">${c.en||''}</div>
        <div class="zh muted">${c.zh||''}</div>
      `;
      div.addEventListener('click', ()=>{
        elVideo.currentTime = Math.max(0, c.start + offset + 0.01);
        elVideo.play();
      });
      elCues.appendChild(div);
    });
  }

  function timeTick(){
    const t = elVideo.currentTime - offset;
    let i = cues.findIndex(c => t >= c.start && t < c.end);
    if(i === -1){
      // 邊界處理：選擇最接近的
      for(let k=cues.length-1;k>=0;k--) if(t>=cues[k].start){ i=k; break; }
    }
    if(i !== curIndex){
      curIndex = i;
      document.querySelectorAll('.cue').forEach(x=>x.classList.remove('active'));
      if(i>=0){
        const el = document.querySelector(`.cue[data-i="${i}"]`);
        if(el){
          el.classList.add('active');
          if(document.getElementById('follow').checked){
            el.scrollIntoView({block:'center', behavior:'smooth'});
          }
          if(repeatThis){
            // 重複播放本句
            const end = cues[i].end;
            const watcher = ()=>{
              if(elVideo.currentTime - offset > end - 0.05){
                elVideo.currentTime = cues[i].start + offset + 0.02;
              }
              if(repeatThis && curIndex===i) requestAnimationFrame(watcher);
            };
            requestAnimationFrame(watcher);
          }
        }
      }
    }
  }

  /* ===== Controls ===== */
  document.getElementById('play').onclick=()=> elVideo.paused ? elVideo.play() : elVideo.pause();
  document.getElementById('prev').onclick=()=>{
    const i = Math.max(0, (curIndex>0?curIndex-1:0));
    elVideo.currentTime = cues[i]?.start + offset + .02 || 0;
  };
  document.getElementById('next').onclick=()=>{
    const i = Math.min(cues.length-1, curIndex+1);
    elVideo.currentTime = cues[i]?.start + offset + .02 || elVideo.currentTime + 3;
  };
  document.getElementById('repeat').onclick=()=>{
    repeatThis = !repeatThis;
    document.getElementById('repeat').classList.toggle('primary', repeatThis);
  };
  document.getElementById('offM').onclick=()=>{ offset -= 0.5; updateOffset(); };
  document.getElementById('offP').onclick=()=>{ offset += 0.5; updateOffset(); };
  function updateOffset(){ document.getElementById('offView').textContent = `${offset.toFixed(1)}s`; }
  updateOffset();
  document.getElementById('speed').oninput=(e)=>{
    elVideo.playbackRate = Number(e.target.value||1);
    document.getElementById('speedView').textContent = `${elVideo.playbackRate.toFixed(2)}x`;
  };
  document.getElementById('calib').onclick=()=>{
    alert('簡易校準：\n1) 在你聽到關鍵字時按「下一句」。\n2) 若字幕慢半拍，就按 +0.5s；快半拍按 -0.5s。\n3) 重複到對準為止。');
  };

  /* ===== Quiz ===== */
  let quizData = []; // 原始
  const answers = new Map(); // key->userAnswer

  function renderQuiz(){
    elQuiz.innerHTML = '';
    if(!quizData.length){
      elQuiz.innerHTML = `<span class="badge">沒有題庫資料</span>`;
      return;
    }
    const sections = ['Vocabulary','Grammar','Reading','Mixed'];
    sections.forEach(sec=>{
      const group = quizData.filter(q=> (q.section||'').toLowerCase() === sec.toLowerCase());
      if(!group.length) return;
      const h = document.createElement('h3');
      h.textContent = sec + ` (${group.length})`;
      elQuiz.appendChild(h);

      group.forEach((q,idx)=>{
        const id = `${sec}-${idx}`;
        const box = document.createElement('div'); box.className='q';
        const isMCQ = (q.type||'').toUpperCase()==='MCQ';
        box.innerHTML = `
          <h4>${q.question || q.q || ''}</h4>
          <div class="opts"></div>
          <div class="muted">${q.explanation? '提示：'+q.explanation : ''}</div>
          <div class="muted">正解：<span id="ans-${id}" class="danger" hidden>${q.answer || q.a || ''}</span></div>
        `;
        const ops = box.querySelector('.opts');
        if(isMCQ){
          (q.options||[]).forEach((op,oi)=>{
            const o = document.createElement('label'); o.className='opt';
            o.innerHTML = `<input type="radio" name="q-${id}" value="${op}"><span>${op}</span>`;
            ops.appendChild(o);
          });
          ops.addEventListener('change',e=>{
            answers.set(id, e.target.value);
          });
        }else{
          const ip = document.createElement('input');
          ip.type='text'; ip.placeholder='輸入答案…'; ip.className='opt';
          ip.addEventListener('change',()=>answers.set(id, ip.value.trim()));
          ops.appendChild(ip);
          const chk = document.createElement('button'); chk.className='btn'; chk.textContent='檢查';
          chk.onclick=()=>{
            document.getElementById(`ans-${id}`).hidden=false;
          };
          box.appendChild(chk);
        }
        elQuiz.appendChild(box);
      });
    });
  }
  function showAllAnswers(show=true){
    document.querySelectorAll('[id^="ans-"]').forEach(x=> x.hidden = !show);
  }
  function submitScore(){
    let total=0, cnt=0;
    document.querySelectorAll('[id^="ans-"]').forEach(el=>{
      const id = el.id.replace('ans-','');
      const a  = (el.textContent||'').trim();
      const ua = (answers.get(id)||'').trim();
      if(!a) return;
      cnt++;
      total += (ua && ua.toLowerCase()===a.toLowerCase()) ? 5 : 0; // 每題 5 分
    });
    document.getElementById('scoreBox').textContent = `本分區分數：${total} / ${cnt*5||100}`;
    alert(`分數：${total} / ${cnt*5||100}`);
  }
  document.getElementById('btnSubmit').onclick=submitScore;
  document.getElementById('btnShow').onclick=()=>showAllAnswers(true);
  document.getElementById('btnPrint').onclick=()=>window.print();

  /* ===== Vocab ===== */
  function tts(text, lang='en-US'){
    try{
      const u = new SpeechSynthesisUtterance(text);
      u.lang = lang;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }catch(e){}
  }
  function renderVocab(list){
    elVocab.innerHTML = '';
    if(!list?.length){ elVocab.innerHTML = `<span class="badge">沒有單字資料</span>`; return; }
    list.forEach(v=>{
      const div = document.createElement('div');
      div.className='vitem';
      div.innerHTML = `
        <div class="vhead">
          <span class="vword">${v.word||v.w||''}</span>
          <span class="muted">${v.pos? `(${v.pos})`:''}</span>
          <span class="muted">${v.zh || v.cn || ''}</span>
        </div>
        <div>
          <button class="tts" title="朗讀(英)">🔊 EN</button>
          <button class="tts" title="朗讀(中)">🔊 中</button>
        </div>
      `;
      const [btnEn, btnZh] = div.querySelectorAll('.tts');
      btnEn.onclick=()=>tts(v.word||v.w||'', 'en-US');
      btnZh.onclick=()=>tts(v.zh||v.cn||'', 'zh-TW');
      elVocab.appendChild(div);

      if(v.sample){
        const ex = document.createElement('div');
        ex.className='muted';
        ex.style.marginTop='.35rem';
        ex.textContent = '例句：' + v.sample;
        elVocab.appendChild(ex);
      }
    });
  }

  /* ===== AI ===== */
  function renderAI(data){
    elAI.innerHTML = '';
    if(!data?.topics?.length){ elAI.innerHTML = `<span class="badge">暫無 AI 資料</span>`; return; }
    data.topics.forEach(t=>{
      const div = document.createElement('div'); div.className='ait';
      div.innerHTML = `
        <div class="row">
          <span class="pill">${t.title||''}</span>
        </div>
        <div class="muted" style="margin-top:.4rem">Prompt：${t.prompt||''}</div>
        ${t.hint? `<div class="muted">Hint：${t.hint}</div>`:''}
        ${t.sample? `<div class="muted">Sample：${t.sample}</div>`:''}
      `;
      elAI.appendChild(div);
    });
  }

  /* ===== Boot ===== */
  async function boot(){
    loadVideo();
    try{
      const rawCues = await fetchJSON(P_CUES);
      cues = normalizeCues(rawCues);
      renderCues();
      hideMsg();
    }catch(e){
      showMsg('cues 載入失敗或格式錯誤', true);
    }

    // quiz / vocab / ai：失敗就沉默，不擾動
    try{ quizData = await fetchJSON(P_QUIZ); renderQuiz(); }catch{}
    try{ const v = await fetchJSON(P_VOCAB); renderVocab(v); }catch{}
    try{ const a = await fetchJSON(P_AI); renderAI(a); }catch{}

    // 守門（若頁面已掛上，這裡會呼叫）
    if(typeof window.initGate === 'function'){
      try{ await window.initGate({cat, slug}); }catch(e){}
    }
  }

  elVideo.addEventListener('timeupdate', timeTick);
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', boot, {once:true});
  }else{ boot(); }

  // 收藏 / 回首頁（可自行替換為真實行為）
  document.getElementById('btnFav').onclick = ()=> alert('已加入收藏（示意）');
})();
</script>
</body>
</html>


















































