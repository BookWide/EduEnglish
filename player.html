<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BookWide æ’­æ”¾å™¨</title>

<!-- å­—é«” -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0b1324;
  --panel:#0f172a;
  --border:#1f2a44;
  --ink:#e6f0ff;
  --muted:#9fb0c9;
  --accent:#3c7cff;
}
*{box-sizing:border-box;}
html,body{
  margin:0;
  height:100%;
  background:var(--bg);
  color:var(--ink);
  font-family:"Noto Sans TC",system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
  overflow:hidden;
}
a{color:var(--accent);text-decoration:none;}

header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 18px;
  background:var(--panel);
  border-bottom:1px solid var(--border);
}
header .left span{
  font-size:20px;
  font-weight:600;
}
header .right{
  display:flex; gap:10px; align-items:center;
}

.btn-top{
  padding:6px 14px;
  background:var(--border);
  border-radius:8px;
  cursor:pointer;
  font-size:14px;
}

#main-wrap{
  display:flex;
  height:calc(100% - 60px);
}

/* å·¦åŠï¼šå½±ç‰‡ */
#video-wrap{
  width:55%;
  border-right:1px solid var(--border);
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
  align-items:center;
  padding:10px;
}
#video{
  width:100%;
  max-height:65vh;
  background:#000;
}

/* å³åŠ å››åˆ†é  */
#tabs{
  width:45%;
  display:flex;
  flex-direction:column;
  overflow:hidden;
  background:var(--panel);
}

.tab-buttons{
  display:flex;
  border-bottom:1px solid var(--border);
}
.tab-buttons button{
  flex:1;
  padding:10px;
  border:0;
  background:var(--panel);
  color:var(--ink);
  cursor:pointer;
  font-size:15px;
}
.tab-buttons button.active{
  background:var(--border);
}

.tab-content{
  flex:1;
  overflow-y:auto;
  padding:16px;
}

/* å­—å¹• */
.sub-row{
  display:grid;
  grid-template-columns:90px 1fr;
  padding:6px 0;
  border-bottom:1px solid rgba(255,255,255,0.06);
}
.sub-row.active{
  background:rgba(255,255,255,0.06);
}

/* æ¸¬é©— */
.quiz-block{
  margin-bottom:22px;
  padding-bottom:12px;
  border-bottom:1px solid rgba(255,255,255,0.1);
}
.quiz-title{
  font-size:16px;
  margin-bottom:6px;
}
.quiz-opt{
  display:flex;
  align-items:center;
  padding:6px;
  margin:4px 0;
  cursor:pointer;
  border-radius:6px;
}
.quiz-opt.selected{
  background:#1f2a44;
}

/* åˆ†æ•¸ */
#quiz-score{
  font-size:17px;
  font-weight:700;
  margin-top:10px;
}

/* æ‰‹æ©Ÿ */
@media (max-width:900px){
  #main-wrap{ flex-direction:column; }
  #video-wrap{ width:100%; border-right:0; }
  #tabs{ width:100%; height:50%; }
}
</style>
</head>

<body>

<header>
  <div class="left"><span>æ’­æ”¾å™¨</span></div>
  <div class="right">
    <button class="btn-top" onclick="location.href='index.html'">å›é¦–é </button>
  </div>
</header>

<div id="main-wrap">

  <!-- å·¦å´å½±ç‰‡ -->
  <div id="video-wrap">
    <video id="video" controls crossorigin="anonymous">
      <source id="videoSrc" src="" type="video/mp4" />
      æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å½±ç‰‡æ’­æ”¾ã€‚
    </video>
  </div>

  <!-- å³å´å››åˆ†é  -->
  <div id="tabs">
    <div class="tab-buttons">
      <button class="tab-btn active" data-tab="tab-sub">å­—å¹•</button>
      <button class="tab-btn" data-tab="tab-quiz">æ¸¬é©—</button>
      <button class="tab-btn" data-tab="tab-vocab">å–®å­—</button>
      <button class="tab-btn" data-tab="tab-ai">AIäº’å‹•</button>
    </div>

    <div id="tab-sub" class="tab-content"></div>
    <div id="tab-quiz" class="tab-content" style="display:none;"></div>
    <div id="tab-vocab" class="tab-content" style="display:none;"></div>
    <div id="tab-ai" class="tab-content" style="display:none;"></div>
  </div>

</div>

<script>
/* =====================================================
      å·¥å…·
===================================================== */
function getParam(key){
  return new URLSearchParams(location.search).get(key);
}

const cat = getParam("cat");
const slug = getParam("slug");

/* ----------------------------------------------------
   è¼‰å…¥å½±ç‰‡
---------------------------------------------------- */
function loadVideo(){
  const url =
`https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/videos/${cat}/${slug}.mp4`;
  document.getElementById("videoSrc").src = url;
  document.getElementById("video").load();
}

/* ----------------------------------------------------
   Tab åˆ‡æ›
---------------------------------------------------- */
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");

    document.querySelectorAll(".tab-content").forEach(div=>div.style.display="none");
    document.getElementById(btn.dataset.tab).style.display="block";
  });
});

/* ----------------------------------------------------
   JSON è¼‰å…¥
---------------------------------------------------- */
async function loadJSON(url){
  try{
    const r = await fetch(url);
    if(!r.ok) return null;
    return await r.json();
  }catch(e){
    return null;
  }
}

/* åˆå§‹åŒ– */
async function initData(){
  loadVideo();
  loadSubtitles();
  loadQuiz();
  loadVocab();
  loadAI();
}

/* =====================================================
      å­—å¹•æ¸²æŸ“
===================================================== */
let subtitleData = [];
let currentIndex = -1;

async function loadSubtitles(){
  const url = `data/${cat}/cues-${slug}.json`;
  const json = await loadJSON(url);
  if(!json){
    document.getElementById("tab-sub").innerHTML="å­—å¹•è¼‰å…¥å¤±æ•—";
    return;
  }
  subtitleData = json;
  renderSub(json);
}

function renderSub(list){
  let html = "";
  list.forEach((row,i)=>{
    html += `
      <div class="sub-row" data-idx="${i}">
        <div>${row.time}</div>
        <div>
          <div>${row.en || ""}</div>
          <div>${row.zh || ""}</div>
          <div>${row.ja || ""}</div>
          <button onclick="speakSubtitle(${i})">ğŸ”Š</button>
        </div>
      </div>
    `;
  });

  document.getElementById("tab-sub").innerHTML = html;

  document.querySelectorAll(".sub-row").forEach(div=>{
    div.addEventListener("click",()=>{
      jumpToSubtitle(div.dataset.idx);
    });
  });
}

/* å­—å¹•è·³åˆ°å½±ç‰‡ */
function jumpToSubtitle(i){
  const t = subtitleData[i].time;
  const [m,s] = t.split(":").map(Number);
  video.currentTime = m*60 + s;
  video.play();
}

/* è‡ªå‹•é«˜äº®å­—å¹• */
video.addEventListener("timeupdate",()=>{
  const now = video.currentTime;
  for(let i=0;i<subtitleData.length;i++){
    const [m,s] = subtitleData[i].time.split(":").map(Number);
    if(now >= m*60 + s - 0.1){
      currentIndex = i;
    }
  }
  document.querySelectorAll(".sub-row").forEach((row,idx)=>{
    row.classList.toggle("active", idx===currentIndex);
  });
});

/* å­—å¹•æœ—è®€ */
function speakSubtitle(i){
  const r = subtitleData[i];
  const text = r.en || r.zh || r.ja || "";
  speakText(text);
}

/* =====================================================
      æœ—è®€èªè¨€åµæ¸¬
===================================================== */
function detectLang(t){
  if(/[a-zA-Z]/.test(t)) return "en-US";
  if(/[\u3040-\u30ff]/.test(t)) return "ja-JP";
  return "zh-TW";
}

function speakText(t){
  const u = new SpeechSynthesisUtterance(t);
  u.lang = detectLang(t);
  speechSynthesis.speak(u);
}

/* =====================================================
      æ¸¬é©—ï¼ˆQuiz Systemï¼‰
===================================================== */
let quizData = [];
let quizUserAns = {};
let quizScore = 0;

async function loadQuiz(){
  const url = `data/${cat}/quiz-${slug}.json`;
  const json = await loadJSON(url);
  if(!json){
    document.getElementById("tab-quiz").innerHTML="æ¸¬é©—è¼‰å…¥å¤±æ•—";
    return;
  }
  quizData = json;
  renderQuiz(json);
}

function renderQuiz(list){
  quizUserAns = {};
  quizScore = 0;

  let html = "";
  list.forEach((q, idx)=>{
    html += `
      <div class="quiz-block" id="q-${idx}">
        <div class="quiz-title">ç¬¬ ${idx+1} é¡Œ Â· é¡å‹ï¼š[${q.type}]</div>
        <div class="quiz-question">${q.question}</div>
        <button onclick="speakQuiz(${idx})">ğŸ”Š</button>

        <div class="quiz-options">
          ${renderOpt("A",q.A,idx)}
          ${renderOpt("B",q.B,idx)}
          ${renderOpt("C",q.C,idx)}
          ${renderOpt("D",q.D,idx)}
        </div>

        <div id="ans-${idx}" class="real-answer" style="display:none;">
          ç­”æ¡ˆï¼š${q.answer}<br>
          <div>${q.zh || ""}</div>
          <div>${q.ja || ""}</div>
        </div>
      </div>
    `;
  });

  html += `
    <button onclick="showAllAnswers()">é¡¯ç¤ºç­”æ¡ˆ</button>
    <button onclick="submitQuiz()">äº¤å·</button>
    <div id="quiz-score"></div>
  `;

  document.getElementById("tab-quiz").innerHTML = html;
}

function renderOpt(letter,text,idx){
  return `
    <div class="quiz-opt" onclick="chooseOpt('${idx}','${letter}')">
      <input type="radio" name="q-${idx}">
      <span>${letter}. ${text}</span>
    </div>
  `;
}

function chooseOpt(i,letter){
  quizUserAns[i] = letter;
  const block = document.getElementById(`q-${i}`);
  block.querySelectorAll(".quiz-opt").forEach(o=>o.classList.remove("selected"));
  block.querySelectorAll(".quiz-opt")[["A","B","C","D"].indexOf(letter)]
      .classList.add("selected");
}

function speakQuiz(i){
  const q = quizData[i];
  let text = q.question + " The correct answer is " + q[q.answer];
  speakText(text);
}

function showAllAnswers(){
  document.querySelectorAll(".real-answer").forEach(a=>a.style.display="block");
}

/* è©•åˆ† + Supabase */
async function submitQuiz(){
  quizScore = 0;
  quizData.forEach((q,idx)=>{
    if(quizUserAns[idx] === q.answer) quizScore++;
  });

  document.getElementById("quiz-score").innerHTML =
    `å¾—åˆ†ï¼š${quizScore} / ${quizData.length}`;

  await saveQuizScore();
  alert("å·²äº¤å·ï¼");
}

/* =====================================================
      å¯«å…¥ quiz_logsï¼ˆDashboard æœƒæ­£å¸¸é¡¯ç¤ºï¼‰
===================================================== */
async function saveQuizScore(){
  if(!BW.user) return;

  const body = {
    email: BW.user.email,
    slug: BW.slug,
    category: BW.cat,
    score: quizScore,
    total_questions: quizData.length,
    created_at: new Date().toISOString()
  };

  try{
    await fetch(
      "https://jeajrwpmrgczimmrflxo.supabase.co/rest/v1/quiz_logs",
      {
        method:"POST",
        headers:{
          "apikey": BW.anon,
          "Authorization": `Bearer ${BW.anon}`,
          "Content-Type":"application/json",
          "Prefer":"return=minimal"
        },
        body: JSON.stringify(body)
      }
    );
  }catch(e){
    console.warn("quiz_logs å¯«å…¥éŒ¯èª¤", e);
  }
}

/* =====================================================
      å–®å­—ï¼ˆVocabï¼‰
===================================================== */
async function loadVocab(){
  const url = `data/${cat}/vocab-${slug}.json`;
  const json = await loadJSON(url);
  if(!json){
    document.getElementById("tab-vocab").innerHTML="å–®å­—è¼‰å…¥å¤±æ•—";
    return;
  }
  renderVocab(json);
}

function renderVocab(list){
  let html = "";
  list.forEach(v=>{
    html += `
      <div class="vocab-item">
        <div style="font-size:16px; font-weight:600;">${v.word}</div>
        <div style="color:#9fb0c9;">${v.pos || ""}</div>

        <div>ENï¼š${v.en || ""}</div>
        <div>ä¸­ï¼š${v.zh || ""}</div>
        <div>æ—¥ï¼š${v.ja || ""}</div>

        <button onclick="speakText('${v.word}')">ğŸ”Š</button>
        <hr style="border-color:#1f2a44">
      </div>
    `;
  });
  document.getElementById("tab-vocab").innerHTML = html;
}

/* =====================================================
      AI äº’å‹•ï¼ˆAI JSONï¼‰
===================================================== */
async function loadAI(){
  const url = `data/${cat}/ai-${slug}.json`;
  const json = await loadJSON(url);
  if(!json){
    document.getElementById("tab-ai").innerHTML="AI é¡Œç›®è¼‰å…¥å¤±æ•—";
    return;
  }
  renderAI(json);
}

function renderAI(ai){
  let html = "";
  (ai.topics || []).forEach((t,i)=>{
    html += `
      <div class="ai-block">
        <div style="font-size:18px; font-weight:600;">${i+1}. ${t.title}</div>
        <div>${t.prompt}</div>
        <div style="color:#7aa2ff;">æç¤ºï¼š${t.hint || ""}</div>

        <div style="background:#1a2336; padding:10px; border-radius:8px;">
          <b>ç¤ºä¾‹ï¼š</b><br>
          ENï¼š${t.sample || ""}<br>
          ä¸­ï¼š${t.zh || ""}<br>
          æ—¥ï¼š${t.ja || ""}
        </div>

        <button onclick="speakText('${t.sample || ""}')">ğŸ”Š</button>

        <hr style="border-color:#1f2a44;">
      </div>
    `;
  });
  document.getElementById("tab-ai").innerHTML = html;
}

/* =====================================================
      watch_logsï¼ˆè§€çœ‹ç´€éŒ„ï¼‰
===================================================== */
window.BW = {
  user:null,
  cat,
  slug,
  anon:"YOUR_SUPABASE_ANON_KEY"
};

async function loadCurrentUser(){
  try{
    const token = localStorage.getItem("sb-auth-token");
    if(!token) return;

    const res = await fetch(
      "https://jeajrwpmrgczimmrflxo.supabase.co/auth/v1/user",
      {
        headers:{
          "apikey": BW.anon,
          "Authorization": `Bearer ${token}`
        }
      }
    );
    if(res.ok) BW.user = await res.json();
  }catch(e){
    console.warn("è®€å– user å¤±æ•—",e);
  }
}

let lastSent = 0;
setInterval(()=>{ sendWatchLog(); },10000);

async function sendWatchLog(){
  if(!BW.user) return;

  const sec = Math.floor(video.currentTime);
  if(sec === lastSent) return;
  lastSent = sec;

  const body = {
    email: BW.user.email,
    slug: BW.slug,
    category: BW.cat,
    duration_sec: sec,
    updated_at: new Date().toISOString()
  };

  try{
    await fetch(
      "https://jeajrwpmrgczimmrflxo.supabase.co/rest/v1/watch_logs",
      {
        method:"POST",
        headers:{
          "apikey": BW.anon,
          "Authorization": `Bearer ${BW.anon}`,
          "Content-Type":"application/json",
          "Prefer":"return=minimal"
        },
        body: JSON.stringify(body)
      }
    );
  }catch(e){
    console.warn("watch_logs å¯«å…¥éŒ¯èª¤", e);
  }
}

/* =====================================================
      å•Ÿå‹•æ‰€æœ‰åŠŸèƒ½
===================================================== */
loadCurrentUser();
initData();

</script>

</body>
</html>

















