<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BookWide Player · Slim v2</title>
<style>
  :root{
    --bg:#0b0f14;--bg2:#0f172a;--panel:#0b1220;--bd:#334155;--txt:#e2e8f0;--mut:#94a3b8;
    --pri:#2563eb;--pri2:#1d4ed8;--ok:#16a34a;--warn:#f59e0b;--err:#dc2626;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--txt);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  a{color:#93c5fd;text-decoration:none}

  /* topbar */
  .bw-topbar{position:sticky;top:0;z-index:10;display:flex;align-items:center;gap:.75rem;
    padding:.5rem .75rem;background:#0b0f14;border-bottom:1px solid var(--bd)}
  .bw-topbar .spacer{flex:1}
  .btn{color:var(--txt);background:#111827;border:1px solid var(--bd);border-radius:.5rem;padding:.35rem .6rem}
  .btn-fav[aria-pressed="true"]{color:#111;background:#fbbf24;border-color:#f59e0b}

  /* layout */
  #app.wrap{display:flex;gap:.75rem;align-items:stretch;padding:.5rem}
  #videoWrap{flex:1 1 50%;min-width:0;background:#000;border:1px solid var(--bd);border-radius:.75rem;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
  #rightPane{flex:1 1 50%;min-width:320px;max-width:100%;display:flex;flex-direction:column;gap:.5rem}
  video,iframe{width:100%;height:100%;display:block;background:#000}

  /* tabs */
  .tabs{display:flex;gap:.5rem;border-bottom:1px solid var(--bd);padding:0 .25rem}
  .tabs button{background:transparent;border:0;color:var(--mut);padding:.6rem .8rem;border-bottom:2px solid transparent;cursor:pointer}
  .tabs button.active{color:var(--txt);border-color:var(--pri)}
  .pane{display:none;border:1px solid var(--bd);border-radius:.75rem;padding:.75rem;background:var(--panel);min-height:240px;overflow:auto}
  .pane.active{display:block}

  .badge{display:inline-block;border:1px solid var(--bd);border-radius:.5rem;padding:.3rem .55rem;color:#cbd5e1;background:#0f172a}

  /* cues list */
  .cue{padding:.5rem;border-bottom:1px dashed #243244;cursor:pointer}
  .cue:hover{background:#0f172a}
  .cue .en{font-size:1rem}
  .cue .zh{color:var(--mut);margin-top:.2rem}

  /* quiz subtabs */
  .subtabs{display:flex;flex-wrap:wrap;gap:.5rem;margin:.25rem 0 .5rem}
  .subtabs button{padding:.35rem .6rem;border:1px solid var(--bd);background:#0f172a;color:var(--txt);border-radius:.5rem;font-size:.85rem}
  .subtabs button.active{background:var(--pri);border-color:var(--pri2)}
  .section-title{margin:.3rem 0;color:#93c5fd}
  .quiz-item{border:1px solid var(--bd);border-radius:.6rem;padding:.6rem;margin:.4rem 0;background:#0c1424}
  .quiz-item .ans{margin-top:.35rem;color:#22c55e;display:none}
  .quiz-item.revealed .ans{display:block}

  /* tool bar */
  #toolBar{margin-top:.5rem;border:1px solid var(--bd);background:#0c1424;border-radius:.75rem;padding:.5rem;display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
  #toolBar .group{display:flex;gap:.4rem;align-items:center}
  #toolBar .btn-sm{padding:.3rem .55rem;border:1px solid var(--bd);background:#0f172a;border-radius:.45rem;color:var(--txt)}
  #toolBar .btn-sm[aria-pressed="true"]{background:#1f2937}
  #lblOffset{color:#fbbf24}

  /* mobile */
  @media (max-width:900px){
    #app.wrap{flex-direction:column}
    #videoWrap,#rightPane{flex:1 1 auto}
  }
</style>
</head>
<body>
  <!-- Topbar -->
  <header id="bwTopbar" class="bw-topbar">
    <a href="index.html" class="btn btn-back" aria-label="回首頁">← 回首頁</a>
    <div class="spacer"></div>
    <button id="btnFav" class="btn btn-fav" aria-pressed="false" title="我的收藏">★ 收藏</button>
  </header>

  <!-- Main -->
  <main id="app" class="wrap">
    <section id="videoWrap">
      <video id="player" controls playsinline></video>
    </section>

    <aside id="rightPane">
      <div class="tabs" role="tablist">
        <button class="active" data-tab="cues" role="tab">字幕</button>
        <button data-tab="quiz" role="tab">測驗</button>
        <button data-tab="vocab" role="tab">單字</button>
        <button data-tab="ai" role="tab">AI 互動</button>
      </div>

      <section id="pane-cues" class="pane active" role="tabpanel">
        <div class="badge">載入中…</div>
      </section>

      <section id="pane-quiz" class="pane" role="tabpanel">
        <div id="quizTabs" class="subtabs"></div>
        <div id="quizList"><span class="badge">載入中…</span></div>
      </section>

      <section id="pane-vocab" class="pane" role="tabpanel">
        <div class="badge">暫無單字檔（vocab-*.json）</div>
      </section>

      <section id="pane-ai" class="pane" role="tabpanel">
        <div id="aiBox"><span class="badge">暫無 AI 資料</span></div>
      </section>
    </aside>
  </main>

  <!-- tool bar -->
  <div id="toolBar">
    <div class="group">
      <button id="btnPrev" class="btn-sm">上一句</button>
      <button id="btnPlayPause" class="btn-sm">播放 / 暫停</button>
      <button id="btnNext" class="btn-sm">下一句</button>
      <button id="btnRepeat" class="btn-sm">重複本句</button>
    </div>
    <div class="group">
      <button id="chkFollow" class="btn-sm" aria-pressed="true">跟隨</button>
      <span class="badge">偏移 <span id="lblOffset">0.0s</span></span>
      <button id="btnNudgeM05" class="btn-sm">-0.5s</button>
      <button id="btnNudgeP05" class="btn-sm">+0.5s</button>
      <button id="btnCalibDone" class="btn-sm">完成校準</button>
    </div>
    <div class="group">
      <label class="badge">速度</label>
      <input id="rngSpeed" type="range" min="0.5" step="0.05" max="1.75" value="1" style="width:160px">
    </div>
  </div>

<script>
/* =============== utilities =============== */
function qs(s,root=document){return root.querySelector(s)}
function qsa(s,root=document){return [...root.querySelectorAll(s)]}
async function fetchJSON(url){
  const r = await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error(r.statusText); return r.json();
}
function parseTS(ts){
  if (ts==null) return 0;
  if (typeof ts==='number') return ts;
  const m=/^(?:(\d+):)?(\d{1,2}):(\d{1,2})(?:\.(\d{1,3}))?$/.exec(ts.trim());
  if(!m){const n=+ts;return isNaN(n)?0:n}
  const h=+(m[1]||0),mi=+m[2],s=+m[3],ms=+(m[4]||0);
  return h*3600+mi*60+s+ms/1000;
}

/* =============== Guard & Fav =============== */
async function guard(){
  try{
    if (window.supabase && supabase.auth){
      const { data:{ session } } = await supabase.auth.getSession();
      if (!session) console.warn('[Guard] 未登入（訪客模式）');
      return;
    }
    const token = localStorage.getItem('bw_token');
    if (!token) console.warn('[Guard] 無 token（訪客模式）');
  }catch(e){ console.warn('[Guard] 例外',e); }
}
const FAV_KEY='bw_favs';
const favGet=()=>{ try{return JSON.parse(localStorage.getItem(FAV_KEY)||'[]')}catch{return[]} };
const favSet=ids=>localStorage.setItem(FAV_KEY,JSON.stringify(ids));
function favToggle(id){
  const s=new Set(favGet()); s.has(id)?s.delete(id):s.add(id); favSet([...s]); favSyncBtn(id);
}
function favSyncBtn(id){
  const on=new Set(favGet()).has(id); const b=qs('#btnFav');
  if(b){b.setAttribute('aria-pressed',on?'true':'false'); b.textContent=on?'★ 已收藏':'★ 收藏';}
}

/* =============== Video =============== */
const v=()=>qs('#player');
async function loadVideo(cat,slug){
  // ① 讀 cat-index：例如 data/music/music-index.json（有 yt 優先用）
  try{
    const idx = await fetchJSON(`./data/${cat}/${cat}-index.json?v=${Date.now()}`);
    const row = (idx.items||idx.list||idx).find?.(x=>x.slug===slug);
    if (row?.yt){
      // 換 iframe
      const wrap=qs('#videoWrap');
      wrap.innerHTML = `<iframe id="yt" src="https://www.youtube.com/embed/${row.yt}?rel=0&playsinline=1&enablejsapi=1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
      return;
    }
  }catch{}
  // ② 本地影片：先 /videos/<cat>/<slug>.mp4，再 fallback /videos/<slug>.mp4
  const el=v();
  const p1=`./videos/${cat}/${slug}.mp4`;
  const p2=`./videos/${slug}.mp4`;
  const ok = await fetch(p1,{method:'HEAD'}).then(r=>r.ok).catch(()=>false);
  el.src = ok? p1 : p2;
}

/* =============== Cues =============== */
window.__cues=[];
function renderCues(list){
  const box = qs('#pane-cues'); if(!Array.isArray(list)||!list.length){ box.innerHTML='<span class="badge">無字幕</span>'; return;}
  box.innerHTML = list.map((c,i)=>`
    <div class="cue" data-i="${i}" data-t="${c.start}">
      <div class="en">${c.en||c.text||''}</div>
      <div class="zh">${c.zh||''}</div>
    </div>`).join('');
  qsa('.cue',box).forEach(el=>el.addEventListener('click',()=>seekTo(+el.dataset.t + .01)));
}

/* =============== Tool bar =============== */
let followMode=true, offsetSec=0;
function applyOffset(t){return Math.max(0,t+offsetSec)}
function seekTo(t){const el=v(); if(!el)return; el.currentTime = applyOffset(t); if(el.paused) el.play();}
function jumpBy(step){
  const el=v(); const cues=window.__cues||[]; if(!el||!cues.length) return;
  const now = el.currentTime - offsetSec;
  let i = cues.findIndex(c=>c.start<=now && now<c.end);
  if (i<0) i=0; i=Math.min(Math.max(i+step,0),cues.length-1); seekTo(cues[i].start+.01);
}
function prevLine(){jumpBy(-1)}
function nextLine(){jumpBy(+1)}
function repeatLine(){
  const el=v(), cues=window.__cues||[]; if(!el||!cues.length) return;
  const now=el.currentTime-offsetSec;
  const c=cues.find(c=>c.start<=now && now<c.end) || cues[0];
  if(c) seekTo(c.start+.01);
}
function toggleFollow(on){followMode=(typeof on==='boolean')?on:!followMode; qs('#chkFollow')?.setAttribute('aria-pressed',followMode?'true':'false')}
function setSpeed(x){const el=v(); if(el) el.playbackRate = x}
function nudge(sec){offsetSec+=sec; qs('#lblOffset').textContent=offsetSec.toFixed(1)+'s'}

function bindToolbar(){
  qs('#btnPrev')?.addEventListener('click',prevLine);
  qs('#btnNext')?.addEventListener('click',nextLine);
  qs('#btnRepeat')?.addEventListener('click',repeatLine);
  qs('#btnPlayPause')?.addEventListener('click',()=>{const el=v(); if(!el)return; el.paused?el.play():el.pause();});
  qs('#chkFollow')?.addEventListener('click',()=>toggleFollow());
  qs('#btnNudgeM05')?.addEventListener('click',()=>nudge(-.5));
  qs('#btnNudgeP05')?.addEventListener('click',()=>nudge(+.5));
  qs('#rngSpeed')?.addEventListener('input',e=>setSpeed(+e.target.value||1));
  qs('#btnCalibDone')?.addEventListener('click',()=>console.log('[calib] offset',offsetSec));
}

/* =============== Quiz：相容 flat / nested =============== */
function normalizeQuiz(raw){
  if (Array.isArray(raw)){
    return raw.map(x=>({section:x.section||'Mixed',type:x.type||'MCQ',q:x.question||x.q,options:x.options||[],a:x.answer||x.a}));
  }
  if (raw && Array.isArray(raw.sections)){
    const list=[]; for(const s of raw.sections){ for(const q of (s.questions||[])){
      list.push({section:s.type||s.title||'Mixed',type:q.type||'MCQ',q:q.q,options:q.options||[],a:q.a});
    }} return list;
  }
  return [];
}
const groupBy=(arr,k)=>arr.reduce((m,x)=>((m[x[k]]??=[]).push(x),m),{});
function renderQuizTabs(groups){
  const el=qs('#quizTabs'); el.innerHTML='';
  const names=Object.keys(groups); if(!names.length){qs('#quizList').innerHTML='<span class="badge">無題庫</span>'; return;}
  let current=names[0];
  const btns = names.map(name=>{
    const b=document.createElement('button'); b.textContent=`${name} (${groups[name].length})`; if(name===current)b.classList.add('active');
    b.addEventListener('click',()=>{btns.forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderQuizList(groups[name],name);});
    el.appendChild(b); return b;
  });
  renderQuizList(groups[current],current);
}
function renderQuizList(items,sec){
  const box=qs('#quizList'); box.innerHTML=`<div class="section-title">• ${sec}</div>`;
  items.forEach((q,idx)=>{
    const wrap=document.createElement('div'); wrap.className='quiz-item';
    wrap.innerHTML = `
      <div class="q">${idx+1}. ${q.q}</div>
      ${q.type==='MCQ'?`
        <div class="opts">
          ${q.options.map((op,i)=>`
            <label style="display:block;margin:.25rem 0;">
              <input type="radio" name="q${sec}${idx}" value="${i}"> ${op}
            </label>`).join('')}
        </div>`:`
        <div class="sa"><input data-sa placeholder="輸入答案..." class="input" style="width:100%;padding:.4rem;border-radius:.4rem;border:1px solid var(--bd);background:#0f172a;color:var(--txt)"></div>`
      }
      <div class="ctrls" style="margin-top:.35rem;display:flex;gap:.5rem;">
        <button data-check class="btn-sm">檢查</button>
        <button data-reveal class="btn-sm">顯示答案</button>
      </div>
      <div class="ans">正解： ${q.a}</div>`;
    wrap.querySelector('[data-check]').addEventListener('click',()=>{
      let ok=false;
      if (q.type==='MCQ'){
        const picked=wrap.querySelector('input[type=radio]:checked'); if(!picked) return;
        ok = q.options[+picked.value]===q.a;
      }else{
        const v=(wrap.querySelector('[data-sa]')?.value||'').trim().toLowerCase();
        ok = v && (v===String(q.a).trim().toLowerCase());
      }
      wrap.style.borderColor = ok? 'var(--ok)':'var(--err)';
    });
    wrap.querySelector('[data-reveal]').addEventListener('click',()=>wrap.classList.add('revealed'));
    box.appendChild(wrap);
  });
}
async function loadQuiz(cat,slug){
  try{
    const raw=await fetchJSON(`./data/${cat}/quiz-${slug}.json?v=${Date.now()}`);
    const list=normalizeQuiz(raw); const groups=groupBy(list,'section'); renderQuizTabs(groups);
  }catch(e){ qs('#quizList').innerHTML='<span class="badge">quiz 載入失敗或不存在</span>'; console.warn('[quiz] load fail',e); }
}

/* =============== AI =============== */
async function loadAI(cat,slug){
  const el=qs('#aiBox');
  try{
    const data=await fetchJSON(`./data/${cat}/ai-${slug}.json?v=${Date.now()}`);
    if (!Array.isArray(data) || !data.length){ el.innerHTML='<span class="badge">暫無 AI 資料</span>'; return;}
    el.innerHTML = data.map(x=>`
      <div class="quiz-item">
        <div class="q">${x.q||x.prompt||'題目'}</div>
        ${x.a?`<div class="ans" style="display:block">參考：${x.a}</div>`:''}
      </div>`).join('');
  }catch(e){ el.innerHTML='<span class="badge">暫無 AI 資料</span>'; console.warn('[AI] load fail',e); }
}

/* =============== Tabs =============== */
function bindTabs(){
  qsa('.tabs button').forEach(btn=>{
    btn.addEventListener('click',()=>{
      qsa('.tabs button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const name=btn.dataset.tab;
      qsa('.pane').forEach(p=>p.classList.remove('active'));
      qs(`#pane-${name}`)?.classList.add('active');
    });
  });
}

/* =============== boot =============== */
async function boot(){
  const params = new URLSearchParams(location.search);
  const slug = params.get('slug') || 'mid-autumn';
  const cat  = (params.get('cat') || 'story').toLowerCase();
  const pageId=`${cat}:${slug}`;

  await guard();
  favSyncBtn(pageId);
  qs('#btnFav')?.addEventListener('click',()=>favToggle(pageId));

  bindTabs();
  bindToolbar();

  // Video
  await loadVideo(cat,slug);

  // Cues（相容 story 舊格式：[{time,en,zh}] 或帶 start/end 的）
  try{
    const raw=await fetchJSON(`./data/${cat}/cues-${slug}.json?v=${Date.now()}`);
    const list = Array.isArray(raw) ? raw.map(r=>{
      const s = r.start ?? parseTS(r.time), e = r.end ?? (s + 9999);
      return {start:+s, end:+e, en:r.en||r.text||'', zh:r.zh||''};
    }) : [];
    window.__cues = list;
    renderCues(list);

    // 自動跟隨字幕（可用 followMode 控制）
    const el=v();
    el?.addEventListener('timeupdate',()=>{
      if (!followMode) return;
      const now = el.currentTime - offsetSec;
      const i = list.findIndex(c=>c.start<=now && now<c.end);
      if (i>=0){
        // 可在此把當前句加高亮（此處留白供你擴充）
      }
    });

  }catch(e){
    qs('#pane-cues').innerHTML = '<span class="badge">cues 載入失敗或格式錯誤</span>';
    console.warn('[cues] load fail',e);
  }

  // Quiz & AI
  loadQuiz(cat,slug);
  loadAI(cat,slug);

  // 簡單 vocab 檢測
  try{
    const voc=await fetchJSON(`./data/${cat}/vocab-${slug}.json?v=${Date.now()}`);
    qs('#pane-vocab').innerHTML = Array.isArray(voc) && voc.length
      ? voc.map(x=>`<div class="cue"><div class="en">${x.word||x.en||''} <small style="color:var(--mut)">${x.pos||''}</small></div><div class="zh">${x.zh||x.cn||''}</div></div>`).join('')
      : '<span class="badge">暫無單字檔（vocab-*.json）</span>';
  }catch{ /* 無檔則保持預設提示 */ }
}

if (document.readyState==='loading'){ document.addEventListener('DOMContentLoaded',boot,{once:true}); }
else { boot(); }
</script>
</body>
</html>















































