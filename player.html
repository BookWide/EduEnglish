<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BookWide Player Â· Slim v2 Â· å¯è¦†è“‹ç‰ˆ</title>
<style>
:root{
  --bg:#0b1220; --panel:#0f172a; --ink:#e5e7eb; --muted:#94a3b8;
  --accent:#38bdf8; --ok:#34d399; --warn:#f59e0b; --danger:#ef4444;
  --tab:#111827; --line:#1e2a3e;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,Segoe UI,Roboto,Helvetica,Arial}

/* ===== å›ºå®šï¼šä¸Šæ¨™é¡Œã€ä¸‹å·¥å…·åˆ— ===== */
.header{
  position:fixed; inset:0 0 auto 0; height:52px;
  display:flex; align-items:center; gap:12px; padding:0 14px;
  background:linear-gradient(180deg,#0b1220,rgba(11,18,32,.9));
  border-bottom:1px solid #0f223e; z-index:40;
}
.header a,.header button{background:#0b1b2e;border:1px solid #133455;color:#eaf3ff;
  border-radius:10px;padding:8px 12px;text-decoration:none;cursor:pointer}
.header .meta{margin-left:auto;opacity:.75;font-size:13px}

.footer{
  position:fixed; inset:auto 0 0 0; height:76px; display:flex; align-items:center; gap:10px;
  padding:10px 12px; background:linear-gradient(0deg,#0b1220,rgba(11,18,32,.95));
  border-top:1px solid #0f223e; z-index:40;
}

/* ===== ä¸­é–“ 50:50 å…©æ¬„ï¼Œåªæœ‰å³å´æ²å‹• ===== */
.main{position:fixed; top:52px; bottom:76px; left:0; right:0; display:flex; gap:10px; padding:10px}
.left,.right{background:var(--panel); border:1px solid #13223b; border-radius:12px; padding:10px; min-width:0}
.left{flex:0 0 50%; min-width:50%; display:flex; flex-direction:column; gap:10px; overflow:hidden}
.right{flex:0 0 50%; min-width:50%; display:flex; flex-direction:column; overflow:auto}

/* ===== å½±ç‰‡å€ï¼šç›¡é‡æ”¾å¤§é¡¯ç¤º ===== */
.videoWrap{flex:1; display:flex; align-items:center; justify-content:center; background:#000; border-radius:12px; overflow:hidden}
video{width:100%; height:100%; object-fit:contain; background:#000}

/* ===== å·¥å…·åˆ—ï¼ˆåº•éƒ¨å›ºå®šï¼Œä½†å…§å®¹åœ¨å·¦å´ï¼‰ ===== */
.controls{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.btn{background:#0d1b2c; color:#e7f3ff; border:1px solid #12314d; padding:8px 10px; border-radius:10px; cursor:pointer}
.btn:hover{border-color:#1f4b74}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #22445f;background:#0b1b2e;color:#b9d8ff}
.range{display:flex; align-items:center; gap:6px}
.controls .group{display:flex; align-items:center; gap:8px}
.controls .left-rail{flex:1 1 auto}

/* ===== å³å´åˆ†é  ===== */
.tabs{display:flex; gap:6px; padding:4px; position:sticky; top:0; z-index:2; background:#0a1525; border-radius:10px}
.tab{background:var(--tab); border:1px solid #172033; padding:8px 12px; border-radius:10px; cursor:pointer}
.tab.active{background:#102039;border-color:#224;color:#cbe7ff}
.pane{padding:10px}
.hide{display:none}

/* å­—å¹•è¡¨ */
.cues{width:100%; border-collapse:collapse}
.cues th,.cues td{padding:10px;border-bottom:1px dashed var(--line);vertical-align:top}
.cues .ts{color:#9fb7d6;white-space:nowrap;width:72px}
.cues .en{font-weight:600}
.cues .zh{color:#a9b8c9}
.cues tr.active{background:#11223a}

/* æ¸¬é©— */
.q-tabs{display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px}
.q-tab{padding:6px 12px;border-radius:999px;border:1px solid #17415e;background:#0a1727;cursor:pointer}
.q-tab.active{background:#10314f;color:#cbe7ff}
.q-item{padding:12px;border:1px solid #172a44;border-radius:10px;margin:10px 0;background:#0c1526}
.q-item .title{font-weight:700;margin-bottom:6px}
.q-item .opts{display:flex;gap:10px;flex-direction:column}
.q-item .exp{color:#a7c0d8;margin-top:8px}
.scorebar{position:sticky;bottom:0;background:#0a1520;padding:8px;border-top:1px solid #1b2b46;display:flex;gap:10px;align-items:center;border-radius:0 0 10px 10px}

/* å–®å­—å¡ */
.card{border:1px solid #162a44;background:#0b1627;border-radius:10px;padding:12px;margin:10px 0}
.card h4{margin:0 0 6px 0}

/* åˆ—å°ï¼šåªå°å³å´å…§å®¹ */
@media print{
  .header,.footer,.left,.videoWrap{display:none !important}
  .main{position:static; display:block; padding:0}
  .right{min-width:100%; flex:0 0 100%; border:0; background:#fff; color:#000}
  body{background:#fff;color:#000}
  .tabs{display:none}
  .pane,.q-item{background:#fff;border:1px solid #ccc;color:#000}
}
</style>
</head>
<body>
  <!-- ä¸Šï¼šå›ºå®šæ¨™é ­ -->
  <div class="header">
    <a id="btnHome" href="./index.html">â† å›é¦–é </a>
    <div id="title" class="badge">BookWide Player Â· Slim v2</div>
    <div class="meta" id="meta"></div>
    <button id="btnFav" class="btn">â˜† æˆ‘çš„æ”¶è—</button>
  </div>

  <!-- ä¸­ï¼šä¸»é«” -->
  <div class="main">
    <!-- å·¦ï¼šå½±ç‰‡ -->
    <section class="left">
      <div class="videoWrap">
        <video id="vid" controls playsinline></video>
      </div>
    </section>

    <!-- å³ï¼šå­¸ç¿’åˆ†é  -->
    <section class="right">
      <div class="tabs">
        <div class="tab active" data-pane="pane-cues">å­—å¹•</div>
        <div class="tab" data-pane="pane-quiz">æ¸¬é©—</div>
        <div class="tab" data-pane="pane-vocab">å–®å­—</div>
        <div class="tab" data-pane="pane-ai">AI äº’å‹•</div>
      </div>

      <!-- å­—å¹• -->
      <div class="pane" id="pane-cues">
        <div class="badge" id="cuesInfo">â€”</div>
        <table class="cues" id="cuesTable">
          <thead><tr><th class="ts">æ™‚é–“</th><th>è‹±æ–‡</th><th>ä¸­æ–‡</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- æ¸¬é©— -->
      <div class="pane hide" id="pane-quiz">
        <div class="q-tabs" id="qTabs"></div>
        <div id="quizWrap"></div>
        <div class="scorebar">
          <button id="btnSubmit" class="btn">äº¤å·</button>
          <button id="btnShow" class="btn">é¡¯ç¤ºç­”æ¡ˆ</button>
          <button id="btnPrint" class="btn">åˆ—å°æˆç¸¾å–®</button>
          <span id="scoreText" class="badge">æœ¬åˆ†å€åˆ†æ•¸ï¼š0 / 100</span>
        </div>
      </div>

      <!-- å–®å­— -->
      <div class="pane hide" id="pane-vocab">
        <div class="badge" id="vocabInfo">â€”</div>
        <div id="vocabWrap"></div>
      </div>

      <!-- AI -->
      <div class="pane hide" id="pane-ai">
        <div class="ai-topic" id="aiTopics" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px"></div>
        <div>
          <label>é¡Œç›®ï¼š</label>
          <textarea id="aiPrompt" style="width:100%;min-height:120px"></textarea>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn" id="btnPrevTopic">â—€ ä¸Šä¸€é¡Œ</button>
            <button class="btn" id="btnNextTopic">ä¸‹ä¸€é¡Œ â–¶</button>
            <button class="btn" id="btnReadQ">ğŸ”ˆ æœ—è®€é¡Œç›®</button>
          </div>
          <div id="aiHint" style="margin-top:8px;color:#9fb7d6"></div>
          <div id="aiSample" style="margin-top:6px;color:#a7c0d8"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- ä¸‹ï¼šå›ºå®šå·¥å…·åˆ—ï¼ˆåŠŸèƒ½éƒ½åœ¨å·¦å´ï¼‰ -->
  <div class="footer">
    <div class="controls left-rail">
      <div class="group">
        <button class="btn" id="btnPrev">ä¸Šä¸€å¥</button>
        <button class="btn" id="btnPlay">æ’­æ”¾ / æš«åœ</button>
        <button class="btn" id="btnNext">ä¸‹ä¸€å¥</button>
        <button class="btn" id="btnRepeat">é‡è¤‡æœ¬å¥</button>
      </div>
      <div class="group">
        <label class="badge"><input type="checkbox" id="chkFollow" checked> è·Ÿéš¨</label>
        <span class="badge">åç§»</span>
        <button class="btn" id="btnShiftMinus">-0.5s</button>
        <button class="btn" id="btnShiftPlus">+0.5s</button>
      </div>
      <div class="group range">
        <span class="badge">é€Ÿåº¦</span>
        <input id="rate" type="range" min="0.5" max="2" step="0.05" value="1">
        <span id="rateLabel">1.00x</span>
        <button class="btn" id="btnCalib">ç°¡æ˜“æ ¡æº–</button>
        <button class="btn" id="btnSpeak">ğŸ”ˆ æœ—è®€</button>
      </div>
    </div>
    <span id="status" class="badge">æº–å‚™å°±ç·’</span>
  </div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const cat = qs.get('cat') || 'story';
  const slug = qs.get('slug') || 'mid-autumn';

  const $ = (s, p=document)=>p.querySelector(s);
  const $$ = (s, p=document)=>Array.from(p.querySelectorAll(s));

  const elVid = $('#vid');
  const elMeta = $('#meta');
  const elStatus = $('#status');

  elMeta.textContent = `cat=${cat} Â· slug=${slug}`;

  /* ===== å½±ç‰‡è·¯å¾‘ï¼ˆå„ªå…ˆ ./videos/<cat>/<slug>.mp4 â†’ å›é€€ ./videos/<slug>.mp4ï¼‰ ===== */
  const sources = [`./videos/${cat}/${slug}.mp4`, `./videos/${slug}.mp4`];
  elVid.src = sources[0];
  elVid.addEventListener('error',()=>{
    if(elVid.src.endsWith(sources[0])) elVid.src = sources[1];
  },{once:true});

  /* ===== åˆ†é  ===== */
  $$('.tab').forEach(t=>t.addEventListener('click',()=>{
    $$('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    $$('.pane').forEach(p=>p.classList.add('hide'));
    $('#'+t.dataset.pane).classList.remove('hide');
    if(t.dataset.pane==='pane-cues') syncActiveRow();
  }));

  /* ===== JSON è¼‰å…¥å·¥å…· ===== */
  async function fetchJSON(path){
    const res = await fetch(path+`?v=${Date.now()}`,{cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    return await res.json();
  }

  /* ===== å­—å¹•ï¼ˆåªæ”¯æ´çµ±ä¸€ story æ ¼å¼ï¼š[{start,end,en,zh}]ï¼‰ ===== */
  let cues = []; let offset = 0; let loop = false;
  const elTbody = $('#cuesTable tbody');

  function renderCues(){
    elTbody.innerHTML = cues.map((c,i)=>{
      const ts = new Date((c.start||0)*1000).toISOString().substr(14,5);
      return `<tr data-i="${i}"><td class="ts">${ts}</td><td class="en">${c.en||''}</td><td class="zh">${c.zh||''}</td></tr>`;
    }).join('');
    $$('#cuesTable tbody tr').forEach(tr=>{
      tr.addEventListener('click',()=>{
        const i = +tr.dataset.i;
        elVid.currentTime = (cues[i].start||0) + offset;
        elVid.play();
      });
    });
  }
  function syncActiveRow(){
    const t = elVid.currentTime - offset;
    const i = cues.findIndex(c=> t>=c.start && t<(c.end??(c.start+10)));
    $$('#cuesTable tbody tr').forEach((tr,idx)=>{
      tr.classList.toggle('active', idx===i);
      if(idx===i && $('#chkFollow').checked){
        tr.scrollIntoView({block:'center',behavior:'smooth'});
      }
    });
  }

  /* ===== æ¸¬é©—ï¼ˆå››åˆ†å€ï¼šVocabulary / Grammar / Reading / Mixedï¼›å„é¡Œ 5 åˆ†ï¼‰ ===== */
  let quizAll = []; const elQTabs = $('#qTabs'); const elQuizWrap = $('#quizWrap');
  const groups = ['Vocabulary','Grammar','Reading','Mixed']; let activeGroup = 'Vocabulary';

  function buildQTabs(){
    elQTabs.innerHTML = groups.map(g=>{
      const n = quizAll.filter(q=>q.section===g).length;
      const zh = g==='Vocabulary'?'å–®å­—':g==='Grammar'?'æ–‡æ³•':g==='Reading'?'é–±è®€':'ç¶œåˆ';
      return `<button class="q-tab ${g===activeGroup?'active':''}" data-g="${g}">${zh} (${n})</button>`;
    }).join('');
    $$('.q-tab',elQTabs).forEach(b=>b.addEventListener('click',()=>{ activeGroup=b.dataset.g; buildQTabs(); renderQuiz(); }));
  }
  function renderQuiz(showAns=false){
    const arr = quizAll.filter(q=>q.section===activeGroup);
    elQuizWrap.innerHTML = arr.map((q,idx)=>{
      const name = `q_${activeGroup}_${idx}`;
      const opts = (q.options||[]).map(o=>`<label><input type="radio" name="${name}" value="${o}"> ${o}</label>`).join('<br/>');
      const exp = showAns? `<div class="exp">æ­£è§£ï¼š<b>${q.answer}</b>${q.explanation? 'ã€€ï½œã€€'+q.explanation:''}</div>`:'';
      return `<div class="q-item"><div class="title">${idx+1}. ${q.question||q.q}</div><div class="opts">${opts}</div>${exp}</div>`;
    }).join('');
  }
  function submitQuiz(){
    const arr = quizAll.filter(q=>q.section===activeGroup);
    let score = 0;
    $$('.q-item').forEach((div,i)=>{
      const inputs = div.querySelectorAll('input[type=radio]');
      const checked = Array.from(inputs).find(x=>x.checked);
      if(!checked) return;
      if(arr[i].answer===checked.value) score += 5;
      if(!div.querySelector('.exp')){
        const hint=document.createElement('div');
        hint.className='exp';
        hint.innerHTML = `æ­£è§£ï¼š<b>${arr[i].answer}</b>${arr[i].explanation? 'ã€€ï½œã€€'+arr[i].explanation:''}`;
        div.appendChild(hint);
      }
    });
    $('#scoreText').textContent = `æœ¬åˆ†å€åˆ†æ•¸ï¼š${score} / 100`;
  }

  /* ===== å–®å­— ===== */
  function renderVocab(list){
    const wrap = $('#vocabWrap');
    wrap.innerHTML = (list||[]).map(v=>{
      const def = v.definition || v.def || '';
      return `<div class="card"><h4>${v.word||v.w||''}</h4><div>${v.zh||''}</div><div style="opacity:.8">${def}</div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="btn btnSpeak" data-text="${(v.word||'')}">ğŸ”ˆ æœ—è®€</button>
        </div></div>`;
    }).join('');
    $$('.btnSpeak',wrap).forEach(b=>b.addEventListener('click',()=>speak(b.dataset.text)));
  }

  /* ===== AI ===== */
  let ai = {topics:[]}, aiIndex = 0;
  function renderAI(){
    const topics = ai.topics||[];
    if(!topics.length){ $('#aiTopics').innerHTML = '<span class="badge">æš«ç„¡ AI è³‡æ–™</span>'; return; }
    $('#aiTopics').innerHTML = topics.map((t,i)=>`<button class="btn ${i===aiIndex?'badge':''}" data-i="${i}">${t.title||('Topic '+(i+1))}</button>`).join('');
    $$('#aiTopics button').forEach(b=>b.addEventListener('click',()=>{ aiIndex=+b.dataset.i; setTopic(); }));
    setTopic();
  }
  function setTopic(){
    const t = (ai.topics||[])[aiIndex]||{};
    $('#aiPrompt').value = t.prompt||'';
    $('#aiHint').textContent = t.hint? 'hintï¼š'+t.hint : '';
    $('#aiSample').textContent = t.sample? 'ç¤ºç¯„ï¼š'+t.sample : '';
    $$('#aiTopics button').forEach((b,i)=> b.classList.toggle('badge', i===aiIndex));
  }
  $('#btnPrevTopic').onclick = ()=>{ aiIndex=(aiIndex-1+ (ai.topics||[]).length)%((ai.topics||[]).length||1); setTopic(); };
  $('#btnNextTopic').onclick = ()=>{ aiIndex=(aiIndex+1)%((ai.topics||[]).length||1); setTopic(); };
  $('#btnReadQ').onclick = ()=> speak($('#aiPrompt').value||'');

  /* ===== æœ—è®€ ===== */
  function speak(text){
    if(!('speechSynthesis' in window)) return alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´æœ—è®€');
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'en-US'; u.rate = 1; speechSynthesis.cancel(); speechSynthesis.speak(u);
  }
  $('#btnSpeak').onclick = ()=>{
    const i = $$('#cuesTable tbody tr').findIndex(tr=>tr.classList.contains('active'));
    const t = cues[i]?.en || '';
    speak(t);
  };

  /* ===== æ§åˆ¶éµ ===== */
  $('#btnPrev').onclick = ()=>{
    const t = elVid.currentTime - offset;
    let i = cues.findIndex(c=>t>=c.start && t<(c.end??(c.start+10)));
    if(i<=0) i=1;
    elVid.currentTime = (cues[i-1].start||0)+offset; elVid.play();
  };
  $('#btnNext').onclick = ()=>{
    const t = elVid.currentTime - offset;
    let i = cues.findIndex(c=>t>=c.start && t<(c.end??(c.start+10)));
    if(i<0) i=0;
    if(i<cues.length-1) elVid.currentTime = (cues[i+1].start||0)+offset;
    elVid.play();
  };
  $('#btnPlay').onclick = ()=> elVid.paused ? elVid.play() : elVid.pause();
  $('#btnRepeat').onclick = ()=>{ loop = !loop; $('#btnRepeat').classList.toggle('badge',loop); if(loop) elVid.play(); };
  $('#btnShiftMinus').onclick = ()=>{ offset -= .5; $('#status').textContent=`åç§» ${offset.toFixed(1)}s`; };
  $('#btnShiftPlus').onclick = ()=>{ offset += .5; $('#status').textContent=`åç§» ${offset.toFixed(1)}s`; };
  $('#rate').oninput = e=>{ const r = +e.target.value || 1; elVid.playbackRate = r; $('#rateLabel').textContent=`${r.toFixed(2)}x`; };
  $('#btnCalib').onclick = ()=>{ offset = 0; $('#status').textContent='æ ¡æº– 0.0s'; };

  elVid.addEventListener('timeupdate',()=>{
    if(!cues.length) return;
    const t = elVid.currentTime - offset;
    const i = cues.findIndex(c=> t>=c.start && t<(c.end??(c.start+10)));
    $$('#cuesTable tbody tr').forEach((tr,idx)=>{
      tr.classList.toggle('active', idx===i);
      if(idx===i && $('#chkFollow').checked){
        tr.scrollIntoView({block:'center',behavior:'smooth'});
      }
    });
    // loop æœ¬å¥
    if(loop && i>=0){
      const start = cues[i].start||0;
      const end = (cues[i].end!=null)? cues[i].end : (cues[i+1]?.start ?? (start+3));
      if(t >= end - 0.02) elVid.currentTime = start + offset + 0.0001;
    }
  });

  /* ===== è¼‰å…¥è³‡æ–™ï¼ˆåªèµ°ä¸€æ¢è·¯å¾‘ï¼‰ ===== */
  async function boot(){
    try{
      // å­—å¹•
      const rawCues = await fetchJSON(`./data/${cat}/cues-${slug}.json`);
      cues = rawCues.map(x=>({start:+x.start||0,end:(x.end!=null?+x.end:undefined),en:x.en||'',zh:x.zh||''}));
      renderCues();
      $('#cuesInfo').textContent = `å·²è¼‰å…¥å­—å¹•ï¼ˆ${cat}/${slug}ï¼‰`;
    }catch(err){
      $('#cuesInfo').textContent = 'cues è¼‰å…¥å¤±æ•—æˆ–æ ¼å¼éŒ¯èª¤';
    }

    try{
      // æ¸¬é©—
      const rawQuiz = await fetchJSON(`./data/${cat}/quiz-${slug}.json`);
      quizAll = Array.isArray(rawQuiz) ? rawQuiz.map(q=>({
        section: q.section || 'Mixed',
        question: q.question || q.q || '',
        options: q.options || q.choices || [],
        answer: q.answer ?? q.ans ?? '',
        explanation: q.explanation || ''
      })) : [];
      buildQTabs(); renderQuiz();
      $('#btnSubmit').onclick = submitQuiz;
      $('#btnShow').onclick = ()=> renderQuiz(true);
      $('#btnPrint').onclick = ()=> window.print();
    }catch(err){ /* å¿½ç•¥ */ }

    try{
      // å–®å­—
      const rawV = await fetchJSON(`./data/${cat}/vocab-${slug}.json`);
      renderVocab(rawV);
      $('#vocabInfo').textContent = `å·²è¼‰å…¥å–®å­—ï¼ˆ${rawV.length}ï¼‰`;
    }catch(err){
      $('#vocabInfo').textContent = 'æ²’æœ‰å–®å­—è³‡æ–™';
    }

    try{
      // AI
      ai = await fetchJSON(`./data/${cat}/ai-${slug}.json`);
      renderAI();
    }catch(err){
      $('#aiTopics').innerHTML = '<span class="badge">æš«ç„¡ AI è³‡æ–™</span>';
    }
  }

  // å•Ÿå‹•
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', boot, {once:true});
  }else{ boot(); }
})();
</script>
</body>
</html>
























































