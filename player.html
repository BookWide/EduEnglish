<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BookWide Player · Slim v2</title>
<style>
  :root { --bg:#0f1216; --panel:#141922; --muted:#8aa0b5; --fg:#e9f0f7; --accent:#3aa0ff; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{display:flex;gap:14px;height:100%;padding:14px}
  /* 左邊影片 */
  #videoWrap{flex:1;min-width:0;background:#000;border-radius:10px;position:relative;display:flex;align-items:center;justify-content:center}
  #video{width:100%;height:100%;object-fit:contain;background:#000;border-radius:10px}
  .yt-embed{position:absolute;inset:0;border:0;width:100%;height:100%;border-radius:10px}
  /* 右邊四分頁 */
  .side{width:480px;min-width:380px;background:var(--panel);border-radius:10px;display:flex;flex-direction:column;overflow:hidden}
  .tabs{display:flex}
  .tabs button{flex:1;padding:12px 8px;background:#10151d;border:0;color:var(--fg);cursor:pointer}
  .tabs button.active{background:#17202b;color:#fff;font-weight:700}
  .pane{flex:1;overflow:auto;padding:10px}
  .row{padding:10px;border-bottom:1px solid rgba(255,255,255,.06)}
  .row:hover{background:#111820}
  .en{font-weight:700}
  .zh{color:var(--muted)}
  /* 控制列 */
  .controls{position:absolute;left:14px;right:14px;bottom:14px;background:rgba(20,25,34,.92);border:1px solid rgba(255,255,255,.06);backdrop-filter:blur(4px);border-radius:10px;padding:8px;display:flex;align-items:center;gap:8px}
  .controls button,.controls .chip{border:1px solid rgba(255,255,255,.15);background:#10151d;color:#fff;border-radius:8px;padding:8px 10px;cursor:pointer}
  .controls .chip{user-select:none}
  .controls input[type="range"]{accent-color:var(--accent)}
  .badge{display:inline-block;border:1px solid rgba(255,255,255,.15);padding:6px 9px;border-radius:8px;background:#0f141c;color:#9fb2c7}
  .hidden{display:none}
</style>
</head>
<body>
  <div class="wrap">
    <div id="videoWrap">
      <video id="video" controls playsinline></video>
      <!-- 控制列 -->
      <div class="controls" id="ctrl">
        <button id="btnPrev">上一句</button>
        <button id="btnPlayPause">播放/暫停</button>
        <button id="btnNext">下一句</button>
        <button id="btnRepeat">重複本句</button>
        <label class="chip"><input id="chkFollow" type="checkbox" /> 跟隨</label>
        <button id="btnMinus">-0.5s</button>
        <button id="btnPlus">+0.5s</button>
        <label class="chip">速度
          <input id="rate" type="range" min="0.5" max="1.75" step="0.05" value="1" />
        </label>
        <label class="chip">校準
          <input id="cal" type="range" min="-2" max="2" step="0.05" value="0" />
        </label>
        <span id="stat" class="badge">載入中…</span>
      </div>
    </div>

    <aside class="side">
      <div class="tabs">
        <button data-tab="cues" class="active">字幕</button>
        <button data-tab="quiz">測驗</button>
        <button data-tab="vocab">單字</button>
        <button data-tab="ai">AI 互動</button>
      </div>
      <div id="pane-cues"   class="pane"></div>
      <div id="pane-quiz"   class="pane hidden"></div>
      <div id="pane-vocab"  class="pane hidden"></div>
      <div id="pane-ai"     class="pane hidden"></div>
    </aside>
  </div>

<script>
(() => {
  // ---------- 參數 ----------
  const params = new URLSearchParams(location.search);
  const cat  = (params.get('cat')  || 'story').toLowerCase();     // story / music / movie / news / pro
  const slug = (params.get('slug') || 'mid-autumn').toLowerCase();

  const DATA_BASE  = `./data/${cat}`;
  const VIDEO_BASE = `./videos/${cat}`;
  const $ = sel => document.querySelector(sel);

  const elVideo     = $('#video');
  const elVideoWrap = $('#videoWrap');
  const elCues      = $('#pane-cues');
  const elQuiz      = $('#pane-quiz');
  const elVocab     = $('#pane-vocab');
  const elAI        = $('#pane-ai');
  const elStat      = $('#stat');

  const btnPrev  = $('#btnPrev');
  const btnNext  = $('#btnNext');
  const btnPP    = $('#btnPlayPause');
  const btnRpt   = $('#btnRepeat');
  const btnMinus = $('#btnMinus');
  const btnPlus  = $('#btnPlus');
  const chkFollow= $('#chkFollow');
  const slRate   = $('#rate');
  const slCal    = $('#cal');

  // ---------- 狀態 ----------
  let cues = [];      // 統一 [{t:秒, en, zh}]
  let idx  = -1;      // 目前句索引
  let offset = 0;     // 校準偏移(秒)
  let repeatTimer = null;

  // ---------- 工具 ----------
  const toSec = (s) => {
    if (typeof s === 'number') return s;
    const m = String(s).trim().match(/^(\d{1,2}):(\d{2})(?:\.(\d{1,3}))?$/);
    if (!m) return parseFloat(s) || 0;
    const [,mm,ss,ms] = m;
    return (+mm)*60 + (+ss) + (ms ? +('0.'+ms) : 0);
  };
  const fetchJSON = async (primary, fallback) => {
    try { const r = await fetch(primary, {cache:'no-store'}); if (r.ok) return r.json(); } catch(e){}
    if (!fallback) throw new Error('no source');
    const r2 = await fetch(fallback, {cache:'no-store'}); if (!r2.ok) throw new Error('fallback fail');
    return r2.json();
  };
  const setStat = (text) => { elStat.textContent = text; };

  // ---------- 視訊載入：index(yt) → 本地(cat/slug) → 本地根(slug) ----------
  async function loadVideo(){
    let used = 'none';
    try{
      // 試讀 <cat>-index.json
      const idxJson = await fetch(`${DATA_BASE}/${cat}-index.json`, {cache:'no-store'}).then(r => r.ok ? r.json() : null).catch(()=>null);
      const row = idxJson?.find?.(x => (x.slug||'').toLowerCase() === slug);
      if (row?.yt){
        const id = row.yt.replace('https://youtu.be/','').replace('https://www.youtube.com/watch?v=','').split('&')[0];
        const iframe = document.createElement('iframe');
        iframe.className = 'yt-embed';
        iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
        iframe.allowFullscreen = true;
        iframe.src = `https://www.youtube.com/embed/${id}?rel=0&modestbranding=1`;
        elVideo.classList.add('hidden');
        elVideoWrap.appendChild(iframe);
        used = 'yt';
        setStat(`YouTube 來源 · ${id}`);
        return;
      }
    }catch(e){ /* 忽略 index 失敗 */ }

    // 改用本地影片
    elVideo.classList.remove('hidden');
    const trySrc = async (src) => {
      return new Promise(resolve=>{
        const onCanPlay = ()=>{ elVideo.removeEventListener('error', onError); resolve(src); };
        const onError   = ()=>{ elVideo.removeEventListener('canplay', onCanPlay); resolve(null); };
        elVideo.addEventListener('canplay', onCanPlay, {once:true});
        elVideo.addEventListener('error', onError,     {once:true});
        elVideo.src = src;
        // 某些瀏覽器需要 load()
        elVideo.load?.();
      });
    };
    let src = await trySrc(`${VIDEO_BASE}/${slug}.mp4`);
    if (!src) src = await trySrc(`./videos/${slug}.mp4`);
    if (!src){ setStat(`[${cat}] 無影片來源：${slug}`); used='none'; }
    else { setStat(`本地影片 · ${src.split('/').slice(-1)[0]}`); used='file'; }
  }

  // ---------- 字幕載入與相容 ----------
  function normalizeCues(raw){
    // 允許三型：{time,en,zh} / {start,end,en,zh} / {t,en,zh}
    return raw.map((r,i)=>{
      let t = (r.t!=null)? r.t : (r.time!=null? toSec(r.time) : (r.start!=null? toSec(r.start) : i));
      return { t, en: r.en||'', zh: r.zh||'' };
    }).sort((a,b)=>a.t-b.t);
  }
  function renderCues(list){
    elCues.innerHTML = '';
    const frag = document.createDocumentFragment();
    list.forEach((c,i)=>{
      const row = document.createElement('div'); row.className='row'; row.dataset.i=i;
      row.innerHTML = `<div class="en">${c.en||''}</div><div class="zh">${c.zh||''}</div>`;
      row.addEventListener('click', ()=>{ seekTo(i); });
      frag.appendChild(row);
    });
    elCues.appendChild(frag);
  }
  function highlightByTime(tNow){
    if (!cues.length) return;
    const t = tNow + offset;
    let j = idx;
    // 前後小範圍尋找
    if (j<0 || j>=cues.length || Math.abs((cues[j]?.t ?? 0)-t) > 2){
      j = cues.findIndex(x => x.t - t >= -0.01); // 第一個不早於目前時間的點
      if (j===-1) j = cues.length-1;
    }
    if (j!==idx){
      idx = j;
      [...elCues.children].forEach((n,k)=>{
        n.style.background = (k===idx)? '#1c2835' : '';
      });
      if (chkFollow.checked){
        elCues.children[idx]?.scrollIntoView({block:'center',behavior:'smooth'});
      }
    }
  }
  function seekTo(i){
    if (i<0 || i>=cues.length) return;
    elVideo.currentTime = Math.max(0, cues[i].t - 0.05 - offset);
    elVideo.play?.();
  }

  // ---------- 測驗 / 單字 / AI ----------
  function renderQuiz(quiz){
    if (!quiz?.length && !quiz?.questions){ elQuiz.innerHTML = `<span class="badge">暫無測驗資料</span>`; return; }
    const rows = (quiz.questions || quiz).map((q, i)=>{
      const options = (q.options||[]).map(op=>`<label><input type="radio" name="q${i}"> ${op}</label>`).join('<br>');
      return `<div class="row"><div class="en">${q.q||q.question||q.title||`Q${i+1}`}</div><div class="zh">${options}</div></div>`;
    });
    elQuiz.innerHTML = rows.join('');
  }
  function renderVocab(v){
    if (!v?.length){ elVocab.innerHTML = `<span class="badge">暫無單字資料</span>`; return; }
    elVocab.innerHTML = v.map(w=>`<div class="row"><div class="en">${w.word||w.en||''}</div><div class="zh">${w.zh||w.cn||w.def||''}</div></div>`).join('');
  }
  function renderAI(ai){
    if (!ai?.length){ elAI.innerHTML = `<span class="badge">暫無 AI 資料</span>`; return; }
    elAI.innerHTML = ai.map(a=>`<div class="row"><div class="en">${a.en||a.q||''}</div><div class="zh">${a.zh||a.a||''}</div></div>`).join('');
  }

  // ---------- 事件 / 控制 ----------
  elVideo.addEventListener('timeupdate', ()=> highlightByTime(elVideo.currentTime));
  btnPrev.addEventListener('click', ()=> seekTo(Math.max(0, idx-1)));
  btnNext.addEventListener('click', ()=> seekTo(Math.min(cues.length-1, idx+1)));
  btnPP  .addEventListener('click', ()=> elVideo.paused? elVideo.play(): elVideo.pause());
  btnRpt .addEventListener('click', ()=>{
    clearInterval(repeatTimer);
    if (idx<0) return;
    const t0 = cues[idx].t - 0.05 - offset;
    const t1 = (cues[idx+1]?.t ?? t0+3) - offset;
    repeatTimer = setInterval(()=>{
      if (elVideo.currentTime > t1) elVideo.currentTime = Math.max(0,t0);
    }, 80);
  });
  btnMinus.addEventListener('click', ()=>{ offset -= 0.5; slCal.value = offset.toFixed(2); });
  btnPlus .addEventListener('click', ()=>{ offset += 0.5; slCal.value = offset.toFixed(2); });
  slRate .addEventListener('input', ()=> elVideo.playbackRate = +slRate.value);
  slCal  .addEventListener('input', ()=> offset = +slCal.value);

  // 分頁切換
  document.querySelectorAll('.tabs button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      ['cues','quiz','vocab','ai'].forEach(k=>{
        const show = (k === btn.dataset.tab);
        document.getElementById(`pane-${k}`).classList.toggle('hidden', !show);
      });
    });
  });

  // ---------- 開機 ----------
  async function boot(){
    setStat('載入影片中…'); await loadVideo();

    setStat('載入字幕…');
    try{
      const raw = await fetchJSON(
        `${DATA_BASE}/cues-${slug}.json?v=${Date.now()}`,
        `./data/story/cues-${slug}.json?v=${Date.now()}`
      );
      cues = normalizeCues(raw);
      renderCues(cues);
      setStat(`字幕 ${cues.length} 句`);
    }catch(e){
      elCues.innerHTML = `<div class="badge">cues 載入失敗或格式錯誤</div>`;
      setStat('字幕載入失敗');
    }

    setStat('載入測驗/單字/AI…');
    // 測驗
    try{
      const quiz = await fetchJSON(
        `${DATA_BASE}/quiz-${slug}.json?v=${Date.now()}`,
        `./data/story/quiz-${slug}.json?v=${Date.now()}`
      );
      renderQuiz(quiz);
    }catch(e){ renderQuiz(null); }

    // 單字
    try{
      const vocab = await fetchJSON(
        `${DATA_BASE}/vocab-${slug}.json?v=${Date.now()}`,
        `./data/story/vocab-${slug}.json?v=${Date.now()}`
      );
      renderVocab(vocab);
    }catch(e){ renderVocab(null); }

    // AI
    try{
      const ai = await fetchJSON(
        `${DATA_BASE}/ai-${slug}.json?v=${Date.now()}`,
        `./data/story/ai-${slug}.json?v=${Date.now()}`
      );
      renderAI(ai);
    }catch(e){ renderAI(null); }

    setStat('完成');
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', boot, {once:true});
  }else boot();
})();
</script>
</body>
</html>































