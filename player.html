<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide 播放器｜字幕＋測驗＋單字＋AI 互動</title>

  <!-- 字型與基本樣式（盡量維持你原本風格） -->
  <style>
    :root{
      --bg:#020617;
      --panel:#020617;
      --panel-soft:#020617;
      --border:#1e293b;
      --ink:#e5e7eb;
      --muted:#94a3b8;
      --accent:#38bdf8;
      --accent-soft:rgba(56,189,248,.12);
      --danger:#f97373;
      --radius-lg:20px;
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0;
      padding:0;
      height:100%;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Noto Sans TC","Microsoft JhengHei",sans-serif;
      background:var(--bg);
      color:var(--ink);
      overflow:hidden; /* 由內部區塊自己捲動 */
    }
    a{color:var(--accent);text-decoration:none;}

    /* 外框 */
    .wrap{
      height:100%;
      display:flex;
      flex-direction:column;
    }
    header{
      height:48px;
      padding:10px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--border);
      background:rgba(15,23,42,.95);
      backdrop-filter:blur(14px);
    }
    header .logo{
      font-weight:650;
      letter-spacing:.03em;
    }
    header .logo span:nth-child(1){color:#38bdf8;}
    header .logo span:nth-child(2){color:#f97316;}
    header .right{
      font-size:13px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:10px;
    }

    /* 主要左右版面 */
    .main{
      flex:1;
      display:flex;
      min-height:0;
    }
    .left{
      flex:0 0 56%;
      border-right:1px solid var(--border);
      padding:12px 18px 14px;
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .right{
      flex:0 0 44%;
      padding:10px 18px 14px;
      display:flex;
      flex-direction:column;
      min-width:0;
    }

    /* 影片區 */
    .badge{
      display:inline-flex;
      align-items:center;
      padding:3px 10px;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid var(--border);
      font-size:12px;
      color:var(--muted);
      margin-bottom:8px;
    }
    .video-shell{
      position:relative;
      border-radius:18px;
      overflow:hidden;
      background:#020617;
      border:1px solid #020617;
      box-shadow:0 18px 40px rgba(0,0,0,.6);
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:0;
    }
    video{
      width:100%;
      height:100%;
      background:black;
    }

    /* 下方播放器控制列（大致維持原本概念） */
    .player-bar{
      margin-top:10px;
      padding:8px 12px;
      border-radius:16px;
      background:rgba(15,23,42,.85);
      border:1px solid var(--border);
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .pb-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:5px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(15,23,42,.9);
      color:var(--ink);
      font-size:13px;
      cursor:pointer;
      gap:4px;
      white-space:nowrap;
    }
    .btn.primary{
      border-color:var(--accent);
      background:var(--accent-soft);
      color:#f9fafb;
    }
    .btn.small{padding:3px 9px;font-size:12px;}
    .btn[disabled]{opacity:.45;cursor:not-allowed;}

    .chip{
      padding:3px 10px;
      border-radius:999px;
      background:#0b1120;
      border:1px solid #020617;
      font-size:12px;
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:4px;
    }

    .slider{
      flex:1;
      display:flex;
      align-items:center;
      gap:6px;
      min-width:180px;
    }
    .slider input[type="range"]{
      flex:1;
    }
    .slider-label{
      font-size:12px;
      color:var(--muted);
    }

    /* 右側分頁區 */
    .tabs{
      display:flex;
      gap:8px;
      padding:4px 0 10px;
      border-bottom:1px solid #020617;
    }
    .tab-btn{
      border-radius:999px;
      padding:5px 18px;
      border:1px solid transparent;
      font-size:13px;
      cursor:pointer;
      background:#020617;
      color:var(--muted);
    }
    .tab-btn.active{
      background:var(--accent-soft);
      border-color:var(--accent);
      color:#e5f3ff;
    }

    .pane-wrap{
      flex:1;
      min-height:0;
      overflow-y:auto;
      padding-top:6px;
      font-size:14px;
    }

    .subtitle-item{
      padding:6px 6px 4px;
      border-radius:10px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      cursor:pointer;
    }
    .subtitle-item:hover{
      background:#020617;
    }
    .subtitle-time{
      font-size:12px;
      color:var(--muted);
      flex:0 0 40px;
    }
    .subtitle-text{
      line-height:1.5;
    }

    /* 測驗區 */
    .quiz-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:8px;
      font-size:13px;
      color:var(--muted);
    }
    .pill-group{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .pill{
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#020617;
      color:var(--muted);
      font-size:12px;
      cursor:pointer;
    }
    .pill.active{
      border-color:var(--accent);
      background:var(--accent-soft);
      color:#e5f3ff;
    }
    .quiz-list{
      list-style:none;
      padding:0;
      margin:0;
    }
    .quiz-item{
      padding:8px 0 10px;
      border-bottom:1px dashed #1e293b;
    }
    .quiz-q{
      margin-bottom:6px;
    }
    .quiz-opt{
      display:flex;
      align-items:center;
      gap:6px;
      margin:2px 0;
      cursor:pointer;
    }
    .quiz-opt label{
      cursor:pointer;
    }
    .quiz-ans{
      margin-top:4px;
      padding:6px 8px;
      border-radius:8px;
      background:#020617;
      font-size:13px;
      color:var(--muted);
      display:none;
    }
    .quiz-ans strong{color:#facc15;}
    .quiz-footer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:10px;
      padding-top:8px;
      border-top:1px solid #020617;
      font-size:13px;
      color:var(--muted);
    }

    /* 單字區 */
    .vocab-item{
      padding:6px 0;
      border-bottom:1px dashed #1e293b;
    }
    .vocab-word{
      font-weight:600;
      margin-bottom:2px;
    }
    .vocab-meta{
      font-size:12px;
      color:var(--muted);
    }

    /* AI 互動區 */
    .ai-topic{
      padding:8px 10px;
      border-radius:14px;
      background:#020617;
      border:1px solid #020617;
      margin-bottom:8px;
      cursor:pointer;
    }
    .ai-title{
      font-weight:600;
      margin-bottom:3px;
    }
    .ai-hint{
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
    }
    .ai-sample{
      font-size:13px;
      color:#e5e7eb;
    }

    .muted{color:var(--muted);}
    .badge-sm{
      display:inline-flex;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:11px;
      color:var(--muted);
      background:#020617;
      margin-left:4px;
    }

    @media (max-width:900px){
      .main{
        flex-direction:column;
      }
      .left,.right{
        flex:0 0 auto;
        width:100%;
        border-right:none;
        border-bottom:1px solid var(--border);
      }
      body{overflow:auto;}
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo"><span>Book</span><span>Wide</span> Player</div>
    <div class="right">
      <span id="userEmail">未登入</span>
      <span id="slugBadge" class="badge-sm"></span>
    </div>
  </header>

  <div class="main">
    <!-- 左：影片＋控制列 -->
    <section class="left">
      <div class="badge" id="catSlugBadge">story · slug</div>
      <div class="video-shell">
        <video id="video" controls crossorigin="anonymous"></video>
      </div>

      <div class="player-bar">
        <div class="pb-row">
          <div>
            <button class="btn primary small" id="btnPlayPause">播放 / 暫停</button>
            <button class="btn small" id="btnPrevLine">上一句</button>
            <button class="btn small" id="btnNextLine">下一句</button>
            <span class="chip" id="timeChip">時間 00:00 / 00:00</span>
          </div>
          <div class="slider">
            <span class="slider-label">速度</span>
            <input id="speedRange" type="range" min="0.5" max="1.5" step="0.1" value="1" />
            <span class="slider-label" id="speedLabel">1.0x</span>
          </div>
        </div>

        <div class="pb-row">
          <label class="chip">
            <input id="chkFollow" type="checkbox" checked style="margin-right:4px" />
            跟隨字幕播放
          </label>
          <span class="muted" style="font-size:12px">點右側「時間」可跳到指定句子；字幕語速可用上方速度調整。</span>
        </div>
      </div>
    </section>

    <!-- 右：四分頁 -->
    <section class="right">
      <div class="tabs">
        <button class="tab-btn active" data-pane="subtitles">字幕</button>
        <button class="tab-btn" data-pane="quiz">測驗</button>
        <button class="tab-btn" data-pane="vocab">單字</button>
        <button class="tab-btn" data-pane="ai">AI互動</button>
      </div>

      <div class="pane-wrap" id="pane-subtitles">
        <div class="muted" style="font-size:13px;margin-bottom:4px">
          點「時間」跳到該句；點英文 / 中文 / 日文可聽發音（目前先做英文朗讀）。
        </div>
        <div id="subtitleList"></div>
      </div>

      <div class="pane-wrap" id="pane-quiz" style="display:none">
        <div class="quiz-head">
          <div>題目：<span id="quizInfo">載入中…</span></div>
          <div class="pill-group">
            <button class="pill active" data-qcat="all">全部</button>
            <button class="pill" data-qcat="單字">單字</button>
            <button class="pill" data-qcat="文法">文法</button>
            <button class="pill" data-qcat="閱讀">閱讀</button>
            <button class="pill" data-qcat="綜合">綜合</button>
          </div>
        </div>
        <ul class="quiz-list" id="quizList"></ul>
        <div class="quiz-footer">
          <div>
            <button class="btn primary small" id="btnSubmitQuiz">交卷</button>
            <button class="btn small" id="btnShowAns">顯示答案</button>
            <button class="btn small" id="btnHideAns">隱藏答案</button>
          </div>
          <div>得分：<span id="quizScore">0 / 0</span></div>
        </div>
      </div>

      <div class="pane-wrap" id="pane-vocab" style="display:none">
        <div id="vocabList"></div>
      </div>

      <div class="pane-wrap" id="pane-ai" style="display:none">
        <div class="muted" style="font-size:13px;margin-bottom:4px">
          選擇一個主題，按「送給 GPT」即可開始 AI 對話練習。
        </div>
        <div id="aiList"></div>
      </div>
    </section>
  </div>
</div>

<!-- Supabase 與主要邏輯 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ====== 基本設定：Supabase、路徑、全域變數 ======
  const SUPABASE_URL = 'https://jeajrwpmrgczimmrflxo.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do';
  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const url = new URL(location.href);
  const currentCat  = url.searchParams.get('cat')  || 'story';
  const currentSlug = url.searchParams.get('slug') || 'slug';

  document.getElementById('catSlugBadge').textContent = `${currentCat} · ${currentSlug}`;
  document.getElementById('slugBadge').textContent = currentSlug;

  // JSON 路徑：data/<cat>/<slug>/xxx-<slug>.json
  function jsonPath(kind){
    return `data/${currentCat}/${currentSlug}/${kind}-${currentSlug}.json`;
  }

  // ====== 影片載入 ======
  const videoEl = document.getElementById('video');
  videoEl.src = `https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/videos/${currentCat}/${currentSlug}.mp4`;

  // 播放控制
  const btnPlayPause = document.getElementById('btnPlayPause');
  btnPlayPause.onclick = ()=>{
    if(videoEl.paused) videoEl.play();
    else videoEl.pause();
  };
  videoEl.onplay  = ()=>{btnPlayPause.textContent='暫停';};
  videoEl.onpause = ()=>{btnPlayPause.textContent='播放';};

  document.getElementById('speedRange').addEventListener('input', ev=>{
    const v = parseFloat(ev.target.value);
    videoEl.playbackRate = v;
    document.getElementById('speedLabel').textContent = v.toFixed(1)+'x';
  });

  // ====== 分頁切換 ======
  const tabBtns = document.querySelectorAll('.tab-btn');
  tabBtns.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      tabBtns.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const pane = btn.dataset.pane;
      document.querySelectorAll('.pane-wrap').forEach(p=>{
        p.style.display = (p.id === 'pane-'+pane)?'block':'none';
      });
    });
  });

  // ====== 取得使用者 Email（供 quiz_logs 寫入） ======
  let currentUser = null;
  async function loadUser(){
    try{
      const { data, error } = await supabaseClient.auth.getUser();
      if(error) return;
      if(data && data.user){
        currentUser = data.user;
        document.getElementById('userEmail').textContent = data.user.email || '已登入';
      }
    }catch(e){
      console.error(e);
    }
  }
  loadUser();

  // ====== 字幕 cues ======
  let cues = [];
  let currentCueIndex = 0;
  const subtitleListEl = document.getElementById('subtitleList');
  const chkFollow = document.getElementById('chkFollow');
  const timeChip = document.getElementById('timeChip');

  function mmss(sec){
    const m = Math.floor(sec/60);
    const s = Math.floor(sec%60);
    return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
  }

  async function loadCues(){
    try{
      const res = await fetch(jsonPath('cues'));
      const data = await res.json();
      cues = data || [];
      renderSubtitles();
    }catch(e){
      console.error('load cues fail',e);
      subtitleListEl.innerHTML = '<div class="muted">找不到字幕 JSON。</div>';
    }
  }
  function renderSubtitles(){
    subtitleListEl.innerHTML = '';
    cues.forEach((c,idx)=>{
      const div = document.createElement('div');
      div.className = 'subtitle-item';
      div.dataset.idx = idx;
      div.innerHTML = `
        <div class="subtitle-time">${c.time||''}</div>
        <div class="subtitle-text">
          <div>${c.en||''}</div>
          <div class="muted" style="font-size:13px">${c.zh||''}</div>
          <div class="muted" style="font-size:12px">${c.ja||''}</div>
        </div>
      `;
      div.addEventListener('click', ()=>{
        if(c.time){
          // "mm:ss"
          const [m,s] = c.time.split(':').map(x=>parseInt(x,10)||0);
          const t = m*60+s;
          videoEl.currentTime = t;
          videoEl.play();
        }
      });
      subtitleListEl.appendChild(div);
    });
  }

  videoEl.addEventListener('timeupdate', ()=>{
    const ct = videoEl.currentTime || 0;
    const dur = videoEl.duration || 0;
    timeChip.textContent = `時間 ${mmss(ct)} / ${mmss(dur)}`;
    if(!chkFollow.checked || !cues.length) return;
    // 找目前句子
    let idx = currentCueIndex;
    const t = mmss(ct);
    // 找第一個 time >= t，然後往前一個
    for(let i=0;i<cues.length;i++){
      if(cues[i].time === t){ idx = i; break; }
    }
    if(idx !== currentCueIndex){
      currentCueIndex = idx;
      // 可在此做 highlight（省略，只跟隨播放）
    }
  });

  document.getElementById('btnPrevLine').onclick = ()=>{
    if(!cues.length) return;
    currentCueIndex = Math.max(0,currentCueIndex-1);
    const c = cues[currentCueIndex];
    if(c.time){
      const [m,s] = c.time.split(':').map(x=>parseInt(x,10)||0);
      videoEl.currentTime = m*60+s;
    }
  };
  document.getElementById('btnNextLine').onclick = ()=>{
    if(!cues.length) return;
    currentCueIndex = Math.min(cues.length-1,currentCueIndex+1);
    const c = cues[currentCueIndex];
    if(c.time){
      const [m,s] = c.time.split(':').map(x=>parseInt(x,10)||0);
      videoEl.currentTime = m*60+s;
    }
  };

  // ====== 測驗 quiz ======
  let quizAll = [];        // 全部題目
  let currentQuizCategory = 'all'; // all / 單字 / 文法 / 閱讀 / 綜合

  const quizListEl = document.getElementById('quizList');
  const quizInfoEl = document.getElementById('quizInfo');
  const quizScoreEl = document.getElementById('quizScore');

  async function loadQuiz(){
    try{
      const res = await fetch(jsonPath('quiz'));
      quizAll = await res.json();
      quizInfoEl.textContent = `全部，共 ${quizAll.length} 題。`;
      renderQuizByCategory('all');
    }catch(e){
      console.error('quiz load fail',e);
      quizInfoEl.textContent = '讀取失敗。';
    }
  }

  function renderQuizByCategory(cat){
    currentQuizCategory = cat;
    const btns = document.querySelectorAll('.pill');
    btns.forEach(b=>{
      if(b.dataset.qcat === cat) b.classList.add('active');
      else if(cat==='all' && b.dataset.qcat==='all') b.classList.add('active');
      else if(cat!=='all' && b.dataset.qcat===cat) b.classList.add('active');
      else b.classList.remove('active');
    });

    let list = quizAll;
    if(cat!=='all'){
      list = quizAll.filter(q=>q.section === cat);
    }
    quizListEl.innerHTML = '';
    list.forEach((q,idx)=>{
      const li = document.createElement('li');
      li.className = 'quiz-item';
      li.innerHTML = `
        <div class="quiz-q">${idx+1}. [${q.section||'題目'}] ${q.question||''}</div>
        <div>
          ${q.options.map((opt,i)=>{
            const code = String.fromCharCode(65+i);
            const id = `q${idx}_${code}`;
            return `
              <div class="quiz-opt">
                <input type="radio" name="q${idx}" id="${id}" value="${code}">
                <label for="${id}">${opt}</label>
              </div>
            `;
          }).join('')}
        </div>
        <div class="quiz-ans ans" data-ans="${q.answer||''}">
          答案：<strong>${q.answer||''}</strong>
          ${q.answer_en?`； ${q.answer_en}`:''}
          ${q.answer_zh?`； ${q.answer_zh}`:''}
          ${q.answer_ja?`； ${q.answer_ja}`:''}
          ${q.explanation_zh?`<br><span class="muted">${q.explanation_zh}</span>`:''}
        </div>
      `;
      quizListEl.appendChild(li);
    });

    quizScoreEl.textContent = `0 / ${list.length}`;
  }

  // 類別切換
  document.querySelectorAll('.pill').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const cat = btn.dataset.qcat;
      if(cat === 'all') renderQuizByCategory('all');
      else renderQuizByCategory(cat);
    });
  });

  // 交卷：計分 + 寫入 quiz_logs（只在 all 時）
  document.getElementById('btnSubmitQuiz').onclick = async () => {
    const lis = quizListEl.querySelectorAll('.quiz-item');
    let correct = 0;
    lis.forEach(li=>{
      const ansBlock = li.querySelector('.quiz-ans');
      const right = ansBlock.dataset.ans;
      const chosen = li.querySelector('input[type=radio]:checked')?.value || '';
      if(chosen === right) correct++;
      ansBlock.style.display = 'block';
    });
    const total = lis.length || 0;
    quizScoreEl.textContent = `${correct} / ${total}`;

    // 只有在「全部(all)」題庫下才寫入 quiz_logs
    if(currentQuizCategory === 'all'){
      try{
        if(currentUser && currentUser.email){
          await supabaseClient.from('quiz_logs').insert({
            email: currentUser.email,
            slug: currentSlug,
            score: correct,
            created_at: new Date().toISOString()
          });
          console.log('quiz_logs inserted');
        }
      }catch(e){
        console.error('insert quiz_logs fail',e);
      }
    }
  };

  document.getElementById('btnShowAns').onclick = ()=>{
    quizListEl.querySelectorAll('.quiz-ans').forEach(el=>el.style.display='block');
  };
  document.getElementById('btnHideAns').onclick = ()=>{
    quizListEl.querySelectorAll('.quiz-ans').forEach(el=>el.style.display='none');
  };

  // ====== 單字 vocab ======
  async function loadVocab(){
    const el = document.getElementById('vocabList');
    try{
      const res = await fetch(jsonPath('vocab'));
      const list = await res.json();
      el.innerHTML = '';
      list.forEach(item=>{
        const div = document.createElement('div');
        div.className='vocab-item';
        div.innerHTML = `
          <div class="vocab-word">${item.word||''} <span class="vocab-meta">${item.pos||''}</span></div>
          <div class="vocab-meta">${item.zh||''}</div>
          <div class="vocab-meta">${item.en||''}</div>
        `;
        el.appendChild(div);
      });
    }catch(e){
      console.error('vocab load fail',e);
      el.innerHTML = '<div class="muted">找不到 vocab JSON。</div>';
    }
  }

  // ====== AI 互動題庫 ======
  async function loadAi(){
    const el = document.getElementById('aiList');
    try{
      const res = await fetch(jsonPath('ai'));
      const data = await res.json();
      const topics = data.topics || [];
      el.innerHTML = '';
      topics.forEach(t=>{
        const div = document.createElement('div');
        div.className='ai-topic';
        div.innerHTML = `
          <div class="ai-title">${t.title||''}</div>
          <div class="ai-hint">${t.hint||''}</div>
          <div class="ai-sample">${t.sample||''}</div>
        `;
        el.appendChild(div);
      });
    }catch(e){
      console.error('ai load fail',e);
      el.innerHTML = '<div class="muted">找不到 ai JSON。</div>';
    }
  }

  // ====== 初始化載入 ======
  loadCues();
  loadQuiz();
  loadVocab();
  loadAi();
</script>
</body>
</html>
