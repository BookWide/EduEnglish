<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BookWide Â· è‹±èªå½±ç‰‡æ’­æ”¾å™¨ï¼ˆç²¾ç°¡ç‰ˆï¼‰</title>

<!-- ========= Base Theme ========= -->
<style>
:root{
  --bg:#0b1324; --panel:#0f172a; --border:#1f2a44; --ink:#e6f0ff; --muted:#9fb0c9; --accent:#3c7cff;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,"Noto Sans TC"}
h1{font-size:20px;margin:0}
a{color:inherit}
.btn{background:#13233f;border:1px solid #24446f;border-radius:10px;padding:8px 12px;color:#fff;cursor:pointer}
.btn.blue{background:#14335f;border-color:#2c5aa3}
.muted{color:var(--muted)}
header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:#0f172a;border-bottom:1px solid #0e203f}

.wrap{padding:16px;height:calc(100vh - 58px);}
.layout{height:100%;display:flex;gap:16px;overflow:hidden}
.left,.right{flex:1;min-width:0;background:var(--panel);border:1px solid var(--border);border-radius:12px}
.left{display:flex;flex-direction:column;padding:14px}
.right{display:flex;flex-direction:column}
.pane{flex:1;overflow:auto}

/* video */
.videoWrap{position:relative;width:100%;aspect-ratio:16/9;background:#000;border-radius:10px;overflow:hidden}
.videoWrap video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000}

/* controls */
.controls{margin-top:12px;background:#0e2038;border:1px solid #183459;border-radius:12px;padding:12px}
.controls .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:.25rem 0}
.speed{display:flex;align-items:center;gap:10px}
input[type="range"]{width:260px;accent-color:var(--accent)}
.chip{display:inline-flex;align-items:center;gap:6px;padding:7px 10px;border:1px solid #23446c;border-radius:10px;background:#10233d}

/* tabs */
.tabs{display:flex;gap:8px;padding:6px 10px;margin:0 0 2px;border-bottom:1px solid var(--border)}
.tab{cursor:pointer;background:#122340;border:1px solid #1f375f;border-radius:10px;padding:8px 12px}
.tab.active{background:#154274}

/* cues table (English line + Chinese stacked) */
table{width:100%;border-collapse:collapse}
th,td{padding:10px 12px;border-bottom:1px solid #162a48;vertical-align:top}
tbody tr{background:#0f1f34}
tbody tr:nth-child(2n){background:#0d1a2b}
tbody tr:hover{background:#0f2a4e}
tr.active{background:#173a6e}
.cues-table{table-layout:fixed}
.cue-time{
  width:64px;min-width:64px;color:rgba(255,255,255,.7);
  font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
  white-space:nowrap;
}
.cue-en{line-height:1.6;word-break:break-word}
.cue-en .zh-line{margin-top:6px;opacity:.9}
.cue-zh{display:none !important}

/* vocab */
.voc{border:1px solid #213a64;background:#0f223b;border-radius:12px;padding:12px;margin:10px 14px}
.voc-h{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px}
.voc-word{font-size:20px;font-weight:800}
.voc-pos{opacity:.85}
.voc-zh{color:#cfe2ff;margin-top:2px}
.voc-en{color:#9fb0c9}
.voc-actions{display:flex;gap:8px;margin-top:8px}

/* quiz */
.q-tabs{display:flex;gap:8px;flex-wrap:wrap}
.q-tabs .qtab{background:#122340;border:1px solid #1f375f;border-radius:10px;padding:6px 12px;color:#e6efff;cursor:pointer}
.q-tabs .qtab.on{background:#154274}

/* print: show quiz only, clean layout */
@media print{
  html,body{ background:#fff !important; color:#000 !important; height:auto !important; overflow:visible !important; }
  header,.tabs,.controls,#authArea,.drawer-grab,.videoWrap,.left{ display:none !important; }
  .wrap{ padding:0 !important; }
  .layout{ display:block !important; height:auto !important; overflow:visible !important; }
  .right{ border:none !important; background:#fff !important; display:block !important; height:auto !important; }
  #pane-quiz,.pane{ height:auto !important; max-height:none !important; overflow:visible !important; display:block !important; }
  #quizList{ font-size:12.5pt; line-height:1.25; }
  #quizList > li{ break-inside:avoid; page-break-inside:avoid; padding:6px 0; margin:0 0 6px 0; border-bottom:1px dotted #ccc; }
  @page { margin:10mm 10mm 12mm 10mm; }
  #printHeader{ display:flex !important; }
  #phScore{ font-size:22px; font-weight:900; }
}

/* print header (hidden in screen) */
#printHeader{display:none; align-items:center; justify-content:space-between; padding:12px 8px 16px; margin:0 8px 8px; border-bottom:1px solid #ddd; color:#111; background:#fff;}
#phLeft{display:flex;align-items:center;gap:10px}
#phLogo{width:26px;height:26px}
#phTitle{font-weight:800}
#phMeta{font-size:12px;color:#444;margin-top:2px}
#phRight{text-align:right}
#phScore{font-size:24px;font-weight:900}
#phFeedback{font-size:12px;color:#444}

/* mobile twoâ€‘page pager */
@media (max-width:860px) and (orientation:portrait){
  #track{ display:flex; flex-direction:row; overflow-x:auto; overflow-y:hidden;
          scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch; gap:0; }
  .page{ flex:0 0 100vw; max-width:100vw; height:calc(100vh - 58px); scroll-snap-align:start; overflow-y:auto; }
  .page > .left, .page > .right{ width:100%; max-width:100%; border-radius:0; border-left:0; border-right:0; }
  #btnExitFocus{ position:fixed; right:16px; bottom:16px; z-index:10020; display:none;
    padding:8px 12px; border-radius:10px; border:1px solid rgba(100,116,139,.5); background:#0f172a; color:#e6efff; }
  body.at-right #btnExitFocus{ display:inline-flex; }
}
</style>
</head>

<body>
<a id="backHome" href="index.html"
   style="position:fixed;left:16px;top:14px;z-index:10000;padding:6px 10px;border-radius:8px;
          background:#eef5ff;border:1px solid #c7ddff;color:#1b5eaa;text-decoration:none;
          font-weight:600;box-shadow:0 2px 6px rgba(0,0,0,.08)">â† å›é¦–é </a>

<header>
  <h1>è‹±èªå½±ç‰‡æ’­æ”¾å™¨</h1>
  <div id="authArea" style="display:flex;gap:10px;align-items:center">
    <button class="btn" id="btnLogin" style="display:none">ç™»å…¥</button>
    <button class="btn" id="btnLogout" style="display:none">ç™»å‡º</button>
    <span class="muted" id="userNameBadge"></span>
  </div>
</header>

<div class="wrap">
  <div id="track" class="layout">
    <section class="page" id="pageLeft">
      <section class="left" id="videoContainer">
        <div class="videoWrap" id="videoWrap">
          <video id="player" playsinline controls></video>
        </div>
        <div class="controls" id="controlsDrawer">
          <div class="row">
            <button class="btn" id="btnPrev">â® ä¸Šä¸€å¥</button>
            <button class="btn" id="btnPlay">â–¶ï¸ æ’­æ”¾ / æš«åœ</button>
            <button class="btn" id="btnNext">â­ ä¸‹ä¸€å¥</button>
            <button class="btn" id="btnReplay">ğŸ” é‡è¤‡æœ¬å¥</button>
          </div>
          <div class="row">
            <label class="chip"><input id="chkFollow" type="checkbox"/> è·Ÿéš¨</label>
            <span class="chip">åç§» <span id="offsetVal">0.0s</span></span>
            <button class="btn" id="btnOffsetMinus">-0.5s</button>
            <button class="btn" id="btnOffsetPlus">+0.5s</button>
            <button class="btn" id="btnAutoSync">ğŸ§­ ç°¡æ˜“æ ¡æº–</button>
          </div>
          <div class="row speed">
            <span class="muted">é€Ÿåº¦</span>
            <input id="speedRange" type="range" min="0.5" max="2" step="0.05" value="1"/>
            <span id="speedVal">1.00x</span>
          </div>
        </div>
      </section>
    </section>

    <section class="page" id="pageRight">
      <section class="right" id="studyContainer">
        <div class="tabs">
          <div class="tab active" data-tab="sub" id="tabSub">å­—å¹•</div>
          <div class="tab" data-tab="quiz">æ¸¬é©—</div>
          <div class="tab" data-tab="vocab">å–®å­—</div>
          <div class="tab" data-tab="ai">AIäº’å‹•</div>
        </div>

        <!-- print header -->
        <div id="printHeader" aria-hidden="true">
          <div id="phLeft">
            <svg id="phLogo" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <circle cx="12" cy="12" r="10" stroke="#111" stroke-width="2"/>
              <path d="M7 13h10M7 9h10M7 17h6" stroke="#111" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <div>
              <div id="phTitle">BookWide Â· è‹±èªå½±ç‰‡æ¸¬é©—æˆç¸¾å–®</div>
              <div id="phMeta">å½±ç‰‡ï¼š<span id="phSlug">-</span>ã€€åˆ†å€ï¼š<span id="phSection">-</span>ã€€åˆ—å°ï¼š<span id="phTime">-</span></div>
            </div>
          </div>
          <div id="phRight">
            <div id="phScore">0 / 100</div>
            <div id="phFeedback">ï¼ˆ0%ï¼‰</div>
          </div>
        </div>

        <div class="pane" id="pane-sub">
          <div class="muted" id="cuesStatus" style="padding:10px 14px">ï¼ˆå­—å¹•è¼‰å…¥ä¸­â€¦ï¼‰</div>
          <table class="cues-table">
            <thead><tr><th style="width:80px">æ™‚é–“</th><th>è‹±æ–‡</th><th class="cue-zh" style="width:40%">ä¸­æ–‡</th></tr></thead>
            <tbody id="cuesBody"></tbody>
          </table>
        </div>

        <div class="pane" id="pane-quiz" style="display:none">
          <div class="quiz-shell">
            <div class="q-tabs" id="quizTabs" style="margin:6px 0 10px 0;">
              <button class="qtab on" data-sec="Vocabulary">å–®å­—</button>
              <button class="qtab" data-sec="Grammar">æ–‡æ³•</button>
              <button class="qtab" data-sec="Reading">é–±è®€</button>
              <button class="qtab" data-sec="Mixed">ç¶œåˆ</button>
              <span class="muted" id="quizMeta" style="margin-left:12px">ï¼ˆæ¸¬é©—è¼‰å…¥ä¸­â€¦ï¼‰</span>
            </div>
            <ol id="quizList" style="line-height:1.6"></ol>
            <div class="q-actions" style="margin:14px 0 6px; display:flex; gap:8px; align-items:center;">
              <button class="btn" id="btnSubmitQuiz">äº¤å·</button>
              <button class="btn" id="btnShowAnswer" style="display:none">é¡¯ç¤ºç­”æ¡ˆ</button>
              <button class="btn" id="btnPrint" style="display:none">åˆ—å°æˆç¸¾å–®</button>
              <span id="quizScore" style="margin-left:8px"></span>
            </div>
            <div id="quizResult" style="display:none;margin-top:10px"></div>
          </div>
        </div>

        <div class="pane" id="pane-vocab" style="display:none">
          <div class="muted" id="vocabStatus" style="padding:10px 14px">( å–®å­—è¼‰å…¥ä¸­â€¦ )</div>
          <div id="vocabBox" style="padding:0 14px 14px"></div>
        </div>

        <div class="pane" id="pane-ai" style="display:none">
          <div class="pane-ai" style="padding:10px">
            <div class="ai-row" style="margin:6px 0 10px">
              <span class="muted">å…è¨±éº¥å…‹é¢¨å¾Œå¯é€²è¡Œå£èªªç·´ç¿’ï¼ˆå»ºè­° Chrome / Edgeï¼‰ã€‚ç¶²å€å¸¶ <code>?slug=mid-autumn / houyi / lantern</code></span>
            </div>
            <div class="ai-row" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <select id="aiTopic" class="btn" style="min-width:200px"></select>
              <button id="btnPrevTopic" class="btn">â—€ ä¸Šä¸€é¡Œ</button>
              <button id="btnNextTopic" class="btn">ä¸‹ä¸€é¡Œ â–¶</button>
              <button id="btnTts" class="btn">ğŸ”ˆ æœ—è®€</button>
              <button id="btnRec" class="btn">ğŸ™ï¸ é–‹å§‹èªª</button>
              <button id="btnStop" class="btn" disabled>â¹ åœæ­¢</button>
              <label style="font-size:13px;opacity:.9"><input id="aiAutoNext" type="checkbox"> ä½œç­”å¾Œè‡ªå‹•ä¸‹ä¸€é¡Œ</label>
              <span id="aiStatus" class="muted"></span>
            </div>
            <div class="ai-row" style="margin-top:6px">
              <textarea id="aiPrompt" rows="3" placeholder="é¡Œç›®æœƒé¡¯ç¤ºåœ¨é€™è£¡â€¦" readonly style="width:100%"></textarea>
            </div>
            <div class="ai-row" style="margin:6px 0 8px">
              <span class="muted">æç¤ºï¼š<span id="aiHint">â€”</span></span>
            </div>
            <div class="ai-row">
              <div class="ai-out" id="aiReply" style="min-height:54px;border:1px solid #223048;border-radius:10px;padding:10px">ï¼ˆç­‰å¾…ä½ çš„ä½œç­”â€¦ï¼‰</div>
            </div>
          </div>
        </div>

      </section>
    </section>
  </div>
</div>

<button id="btnExitFocus" class="btn" style="display:none">è¿”å›å½±ç‰‡</button>

<!-- ========= App Scripts ========= -->
<script>
/* ---------- helpers ---------- */
const $=(s,e=document)=>e.querySelector(s);
const $$=(s,e=document)=>[...e.querySelectorAll(s)];
const toSec=t=>{ if(typeof t==='number')return t; const p=String(t).split(':').map(Number);
  if(p.length===3)return p[0]*3600+p[1]*60+p[2]; if(p.length===2)return p[0]*60+p[1]; return Number(t)||0; };
const fmt=sec=>{ sec=Math.max(0,sec|0); const m=(sec/60)|0,s=sec%60; return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;}
const esc=s=>String(s??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');

/* ---------- params ---------- */
const params=new URLSearchParams(location.search);
const primarySlug=params.get('slug')||'mid-autumn';
let slug=primarySlug;

/* ---------- fetch with fallback ---------- */
async function fetchWithFallback(p,f,kind){
  try{const r=await fetch(p,{cache:'no-store'}); if(!r.ok)throw 0; return {data:await r.json(),used:'primary'};}
  catch{ try{const r2=await fetch(f,{cache:'no-store'}); if(!r2.ok)throw 0; slug='mid-autumn'; return {data:await r2.json(),used:'fallback'};}
  catch(e2){ console.error(`[fatal] ${kind} è®€å–å¤±æ•—`,e2); return {data:null,used:'error'};}}
}

/* ---------- DOM refs ---------- */
const video=$('#player'); const cuesBody=$('#cuesBody'); const cuesStatus=$('#cuesStatus');
const btnPrev=$('#btnPrev'),btnPlay=$('#btnPlay'),btnNext=$('#btnNext'),btnReplay=$('#btnReplay');
const btnOffsetMinus=$('#btnOffsetMinus'),btnOffsetPlus=$('#btnOffsetPlus'),offsetVal=$('#offsetVal');
const chkFollow=$('#chkFollow'); const speedRange=$('#speedRange'),speedVal=$('#speedVal');
const btnPrint=$('#btnPrint'); const paneSub=$('#pane-sub'),paneQuiz=$('#pane-quiz'),paneVocab=$('#pane-vocab');

let cues=[]; let offset=0; let loopSentence=false;
function setOffset(v){offset=Number(v)||0; offsetVal.textContent=`${offset.toFixed(1)}s`; localStorage.setItem(`offset:${slug}`,String(offset));}
window.player={ setOffset, clearRepeat:()=>{ loopSentence=false; btnReplay?.classList.remove('blue'); } };

/* ---------- video & cues ---------- */
async function loadVideo(){
  const src=s=>`./videos/${s}.mp4`;
  video.src=src(primarySlug);
  video.addEventListener('error',()=>{ video.src=src('mid-autumn'); },{once:true});
}
async function loadCues(){
  cuesStatus.textContent='ï¼ˆå­—å¹•è¼‰å…¥ä¸­â€¦ï¼‰';
  const {data,used}=await fetchWithFallback(`./data/cues-${primarySlug}.json?v=${Date.now()}`,`./data/cues-mid-autumn.json?v=${Date.now()}`,'cues');
  if(!data){ cuesStatus.textContent='âš ï¸ å­—å¹•è®€å–å¤±æ•—'; return; }
  cues=data.map(x=>({t:toSec(x.time),en:x.en||'',zh:x.zh||''}));
  cuesBody.innerHTML=cues.map((c,i)=>`<tr data-i="${i}"><td class="cue-time">${c.t?fmt(c.t):''}</td><td class="cue-en">${esc(c.en)}${c.zh?`<div class="zh-line">${esc(c.zh)}</div>`:''}</td><td class="cue-zh">${esc(c.zh)}</td></tr>`).join('');
  $$('#cuesBody tr').forEach(tr=>tr.addEventListener('click',()=>{const i=+tr.dataset.i; seekTo(i,true);}));
  cuesStatus.textContent=used==='fallback' ? 'å·²è¼‰å…¥å­—å¹•ï¼ˆmid-autumn å›é€€ï¼‰' : `å·²è¼‰å…¥å­—å¹•ï¼ˆ${primarySlug}ï¼‰`;
}
function currentIndex(){ const t=video.currentTime+offset; let i=0; while(i+1<cues.length&&cues[i+1].t<=t+0.0001)i++; return i; }
function highlightRow(idx){ const trs=$$('#cuesBody tr'); trs.forEach(tr=>tr.classList.remove('active')); const tr=trs[idx]; if(!tr)return; tr.classList.add('active'); if(chkFollow.checked) tr.scrollIntoView({block:'center',behavior:'smooth'}); }
function seekTo(idx,play=true){ if(!cues[idx])return; video.currentTime=Math.max(0,cues[idx].t-offset+0.0001); highlightRow(idx); if(play) video.play(); }
function sentenceRange(i){ if(!cues[i])return[0,0]; const s=cues[i].t,e=(i+1<cues.length?cues[i+1].t:s+3); return[s,e]; }

/* ---------- quiz ---------- */
async function loadQuiz(){
  const listEl=$('#quizList',paneQuiz), metaEl=$('#quizMeta',paneQuiz);
  const {data,used}=await fetchWithFallback(`./data/quiz-${primarySlug}.json?v=${Date.now()}`,`./data/quiz-mid-autumn.json?v=${Date.now()}`,'quiz');
  if(!data){ metaEl.textContent='âš ï¸ é¡Œåº«è®€å–å¤±æ•—'; return; }

  let questions=[];
  if(Array.isArray(data)){
    questions=data.map(q=>({section:(q.section||'Mixed'),type:(String(q.type||'MCQ').toUpperCase()==='SA')?'SA':'MCQ',
      question:q.question||q.q||'',options:q.options||q.choices||[],answer:q.answer??q.ans??''}));
  }else if(data.sections){
    const push=(sec,arr=[])=>arr?.forEach(q=>questions.push({section:sec,type:(String(q.type||'MCQ').toUpperCase()==='SA')?'SA':'MCQ',
      question:q.question||'',options:q.options||[],answer:q.answer??''}));
    push('Vocabulary',data.sections.vocab); push('Grammar',data.sections.grammar);
    push('Reading',data.sections.reading); push('Mixed',data.sections.mixed);
  }
  metaEl.textContent=used==='fallback'?`å·²è¼‰å…¥ï¼ˆmid-autumn å›é€€ï¼‰ï¼Œå…± ${questions.length} é¡Œ`:`å·²è¼‰å…¥ï¼ˆ${primarySlug}ï¼‰ï¼Œå…± ${questions.length} é¡Œ`;

  function renderSection(sec){
    const arr=questions.filter(q=>q.section===sec);
    if(!arr.length){ listEl.innerHTML='<li style="color:#9fb3ff">ï¼ˆæ­¤åˆ†å€ç„¡é¡Œç›®ï¼‰</li>'; return; }
    listEl.innerHTML=arr.map((q,i)=>{
      const idx=i+1;
      if(q.type==='MCQ'){
        const opts=q.options.map(opt=>`<label style="display:block;margin:4px 0"><input type="radio" name="q${sec}-${idx}" value="${String(opt)}"> ${String(opt)}</label>`).join('');
        return `<li data-type="MCQ" data-ans="${String(q.answer)}"><div style="font-weight:700;margin:4px 0">${idx}. ${esc(q.question)}</div><div>${opts}</div><div class="msg" style="margin-top:4px"></div><div class="exp" style="margin-top:4px;color:#9fb3ff"></div></li>`;
      }else{
        return `<li data-type="SA" data-ans="${String(q.answer)}"><div style="font-weight:700;margin:4px 0">${idx}. ${esc(q.question)}</div><input type="text" placeholder="è¼¸å…¥ç­”æ¡ˆâ€¦" style="padding:6px 8px;border:1px solid #334155;border-radius:6px;background:#0f223b;color:#dbe7ff"><button class="btn btn-check" style="margin-left:6px">æª¢æŸ¥</button><div class="msg" style="margin-top:4px"></div><div class="exp" style="margin-top:4px;color:#9fb3ff"></div></li>`;
      }
    }).join('');
    listEl.addEventListener('click',e=>{
      if(!e.target.classList.contains('btn-check'))return;
      const li=e.target.closest('li'); const ipt=li.querySelector('input');
      const ok=(ipt.value||'').trim().toLowerCase()===String(li.dataset.ans||'').trim().toLowerCase();
      const msg=li.querySelector('.msg'); const exp=li.querySelector('.exp');
      msg.textContent=ok?'âœ… æ­£ç¢º':'âŒ éŒ¯èª¤'; msg.style.color=ok?'#5bd3c7':'#ff6b6b'; exp.textContent=ok?'':`æ­£è§£ï¼š${li.dataset.ans}`;
    },{once:true});
  }
  $('#quizTabs').querySelectorAll('.qtab').forEach(b=>{ b.addEventListener('click',()=>{ $('#quizTabs').querySelectorAll('.qtab').forEach(x=>x.classList.remove('on')); b.classList.add('on'); renderSection(b.dataset.sec); }); });
  renderSection('Vocabulary');

  $('#btnSubmitQuiz').onclick=()=>{
    const items=[...$('#quizList').querySelectorAll('li')]; if(!items.length)return;
    let got=0,total=items.length;
    items.forEach(li=>{
      const ans=String(li.dataset.ans||'').trim();
      if(li.dataset.type==='MCQ'){
        const sel=li.querySelector('input[type="radio"]:checked'); const user=sel?sel.value:''; const ok=user===ans;
        if(ok)got++; const msg=li.querySelector('.msg'),exp=li.querySelector('.exp');
        msg.textContent=ok?'âœ… æ­£ç¢º':'âŒ éŒ¯èª¤'; msg.style.color=ok?'#5bd3c7':'#ff6b6b'; if(!ok)exp.textContent=`æ­£è§£ï¼š${ans}`;
      }else{
        const ipt=li.querySelector('input'); const ok=(ipt.value||'').trim().toLowerCase()===ans.toLowerCase(); if(ok)got++;
        const msg=li.querySelector('.msg'),exp=li.querySelector('.exp');
        msg.textContent=ok?'âœ… æ­£ç¢º':'âŒ éŒ¯èª¤'; msg.style.color=ok?'#5bd3c7':'#ff6b6b'; if(!ok)exp.textContent=`æ­£è§£ï¼š${ans}`;
      }
    });
    const score=got*5, full=total*5;
    $('#quizScore').textContent=`æœ¬åˆ†å€åˆ†æ•¸ï¼š${score} / ${full}`;
    $('#quizResult').style.display='block';
    $('#btnShowAnswer').style.display='inline-block';
    btnPrint.style.display='inline-block';
    updatePrintHeader(score, full);
  };
  $('#btnShowAnswer').onclick=()=>{ $('#quizList').querySelectorAll('li').forEach(li=>{ const exp=li.querySelector('.exp'); if(exp&&!exp.textContent) exp.textContent=`æ­£è§£ï¼š${li.dataset.ans}`; }); };

  function updatePrintHeader(score, full){
    const pct = full ? Math.round((score/full)*100) : 0;
    const words = pct>=90 ? 'å¤ªå¼·äº†ï¼' : pct>=75 ? 'å¾ˆæ£’ï¼Œç¹¼çºŒåŠ æ²¹ï¼' : pct>=60 ? 'é‚„å¯ä»¥ï¼Œå†ç·´ç·´æœƒæ›´å¥½ã€‚' : 'å…ˆåˆ¥ç°å¿ƒï¼é‡ä½œéŒ¯é¡Œã€èƒŒé—œéµå­—å†è©¦ä¸€æ¬¡æœƒæ›´å¥½ã€‚';
    $('#phSlug').textContent = slug;
    $('#phSection').textContent = $('#quizTabs .qtab.on')?.textContent?.trim() || 'Vocabulary';
    $('#phTime').textContent = new Date().toLocaleString('zh-TW', { hour12:false });
    $('#phScore').textContent = `${score} / ${full}`;
    $('#phFeedback').textContent = `ï¼ˆ${pct}%ï¼‰${words}`;
  }
  btnPrint.onclick=()=>{
    let s=0,f=0; const m=($('#quizScore').textContent||'').match(/(\d+)\s*\/\s*(\d+)/);
    if(m){ s=+m[1]; f=+m[2]; } updatePrintHeader(s,f||100); window.print();
  };
  window.addEventListener('beforeprint',()=>{
    let s=0,f=100; const m=($('#quizScore').textContent||'').match(/(\d+)\s*\/\s*(\d+)/);
    if(m){ s=+m[1]; f=+m[2]; } updatePrintHeader(s,f);
  });
}

/* ---------- vocab ---------- */
async function loadVocab(){
  const vStatus=$('#vocabStatus'), vBox=$('#vocabBox');
  const {data,used}=await fetchWithFallback(`./data/vocab-${primarySlug}.json?v=${Date.now()}`,`./data/vocab-mid-autumn.json?v=${Date.now()}`,'vocab');
  if(!data||!data.length){ vStatus.textContent='âš ï¸ æŸ¥ç„¡å–®å­—è³‡æ–™'; vBox.innerHTML=''; return; }
  vStatus.textContent=used==='fallback'?'å·²è¼‰å…¥å–®å­—ï¼ˆmid-autumn å›é€€ï¼‰':`å·²è¼‰å…¥å–®å­—ï¼ˆ${primarySlug}ï¼‰`;
  const go=t=>{ const p=toSec(t); video.currentTime=Math.max(0,p); video.play(); };
  vBox.innerHTML=data.map(v=>`<div class="voc"><div class="voc-h"><div class="voc-word">${esc(v.word||'')}</div><div class="voc-pos">${esc(v.pos||'')}</div></div>${v.zh?`<div class="voc-zh">${esc(v.zh)}</div>`:''}${v.en?`<div class="voc-en">${esc(v.en)}</div>`:''}<div class="voc-actions">${v.time?`<button class="btn" data-act="jump" data-time="${esc(v.time)}">è·³åˆ°ç‰‡æ®µ</button>`:''}<button class="btn" data-act="speak" data-text="${esc(v.word||v.en||'')}">ğŸ”Š æœ—è®€</button></div></div>`).join('');
  vBox.addEventListener('click',e=>{
    const act=e.target?.dataset?.act; if(!act)return;
    if(act==='jump')go(e.target.dataset.time||0);
    if(act==='speak'){ try{ const u=new SpeechSynthesisUtterance(e.target.dataset.text||''); u.lang='en-US'; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch{} }
  });
}

/* ---------- controls ---------- */
speedRange.addEventListener('input',()=>{ const r=Number(speedRange.value)||1; video.playbackRate=r; speedVal.textContent=`${r.toFixed(2)}x`; });
btnPlay.addEventListener('click',()=>{ if(video.paused) video.play(); else video.pause(); });
btnPrev.addEventListener('click',()=>seekTo(Math.max(0,currentIndex()-1),true));
btnNext.addEventListener('click',()=>seekTo(Math.min(cues.length-1,currentIndex()+1),true));
(function(){ const btn=btnReplay; const on=()=>{btn.dataset.active='1';btn.classList.add('blue')}; const off=()=>{btn.dataset.active='0';btn.classList.remove('blue');loopSentence=false}; off(); btn.addEventListener('click',function(e){ const isOn=btn.dataset.active==='1'; if(isOn){ e.stopImmediatePropagation(); window.player.clearRepeat(); off(); return; } loopSentence=true; on(); seekTo(currentIndex(),true); },true); })();
btnOffsetMinus.addEventListener('click',()=>setOffset(offset-0.5));
btnOffsetPlus .addEventListener('click',()=>setOffset(offset+0.5));

video.addEventListener('timeupdate',()=>{ if(!cues.length)return; const i=currentIndex(); highlightRow(i); if(loopSentence){ const [s,e]=sentenceRange(i); const t=video.currentTime+offset; if(t>=e-0.02){ video.currentTime=Math.max(0,s-offset+0.0001); video.play(); } } });

function showTab(name){
  paneSub.style.display=name==='sub'?'':'none';
  paneQuiz.style.display=name==='quiz'?'':'none';
  paneVocab.style.display=name==='vocab'?'':'none';
  $('#pane-ai').style.display = name==='ai' ? '' : 'none';
  $$('.tabs .tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===name));
  // mobile: jump to right page when entering study tabs
  if(['sub','quiz','vocab','ai'].includes(name)){ document.body.classList.add('at-right'); $('#track').scrollTo({left:$('#track').clientWidth,behavior:'smooth'}); }
}
$$('.tabs .tab').forEach(t=>t.addEventListener('click',()=>showTab(t.dataset.tab)));

/* ---------- init ---------- */
(async function init(){
  const saved=localStorage.getItem(`offset:${slug}`); if(saved!=null) setOffset(parseFloat(saved)); else setOffset(0);
  const r=Number(speedRange.value)||1; video.playbackRate=r; speedVal.textContent=`${r.toFixed(2)}x`;

  await loadVideo(); await loadCues(); await loadQuiz(); await loadVocab();
  showTab('sub');
})();

/* ---------- mobile two-page pager helpers ---------- */
(function(){
  const track = document.getElementById('track');
  if(!track) return;
  track.addEventListener('scroll', ()=>{
    const idx = track.scrollLeft >= track.clientWidth * 0.5 ? 1 : 0;
    document.body.classList.toggle('at-right', idx===1);
  }, {passive:true});
  const backBtn = document.getElementById('btnExitFocus');
  if(backBtn){ backBtn.addEventListener('click', ()=>{ document.body.classList.remove('at-right'); track.scrollTo({left:0,behavior:'smooth'}); }); }
})();
</script>

<!-- ========= Supabase Gate + Watch Logs ========= -->
<script type="module">
import { supabase } from './supa.js?v=20251018';

/* ç™»å…¥å®ˆé–€ */
const { data: authData, error: authErr } = await supabase.auth.getUser();
if (authErr || !authData?.user) {
  alert('è«‹å…ˆç™»å…¥å¾Œå†çœ‹å½±ç‰‡ã€‚');
  location.href = 'index.html';
} else {
  const user = authData.user;
  document.getElementById('userNameBadge').textContent = user.email || '';
  const videoSlug = new URLSearchParams(location.search).get('slug') || 'mid-autumn';

  // é€²é å³è¨˜éŒ„ä¸€æ¬¡ï¼ˆå¯è¦–éœ€æ±‚ä¿ç•™ï¼‰
  try {
    await supabase.from('watch_logs').insert({ user_id: user.id, email: user.email, video_slug: videoSlug });
    console.log('âœ… å·²ç´€éŒ„è§€çœ‹(é€²é )', videoSlug);
  } catch (e) { console.warn('watch_logs é€²é å¯«å…¥å¤±æ•—ï¼š', e?.message || e); }

  // ç¬¬ä¸€æ¬¡æ’­æ”¾å†è¨˜ä¸€æ¬¡ï¼ˆå»é‡ï¼‰
  let hasLogged = false;
  const logOnce = async () => {
    if (hasLogged) return;
    hasLogged = true;
    try {
      await supabase.from('watch_logs').insert({ user_id: user.id, email: user.email, video_slug: videoSlug });
      console.log('âœ… å·²ç´€éŒ„è§€çœ‹(æ’­æ”¾)', videoSlug);
    } catch (e) { console.warn('watch_logs æ’­æ”¾å¯«å…¥å¤±æ•—ï¼š', e?.message || e); }
  };
  document.getElementById('player')?.addEventListener('play', logOnce, { once: true });
}
</script>
</body>
</html>
