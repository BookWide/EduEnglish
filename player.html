<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BookWide æ’­æ”¾å™¨ï¼ˆ4 åˆ†é  + æ¸¬é©—å››é¡ï¼‰</title>

<style>
:root{
  --bg:#0b1324;
  --panel:#0f172a;
  --border:#1f2a44;
  --ink:#e6f0ff;
  --muted:#9fb0c9;
  --accent:#3c7cff;
  --accent-soft:#1d4ed8;
  --danger:#f97373;
  --radius:16px;
  --shadow-card:0 16px 40px rgba(15,23,42,.8);
}
*{box-sizing:border-box;}
html,body{
  margin:0;
  height:100%;
  background:var(--bg);
  color:var(--ink);
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Noto Sans TC",sans-serif;
  overflow:hidden; /* æ¡Œæ©Ÿï¼šæ•´é ä¸è¦æ²ï¼Œç”±å³å´é¢æ¿è‡ªå·±æ²å‹• */
}
a{color:var(--accent);text-decoration:none;}
a:hover{text-decoration:underline;}
button{font-family:inherit;}

.app{
  display:flex;
  flex-direction:column;
  height:100%;
}

/* Header */
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 16px;
  border-bottom:1px solid rgba(148,163,184,.35);
  background:radial-gradient(circle at top left,#1e293b 0,#020617 55%);
}
header-left{
  display:flex;
  align-items:center;
}
.logo-badge{
  width:30px;
  height:30px;
  border-radius:999px;
  background:radial-gradient(circle at 30% 20%,#38bdf8,#4f46e5);
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  font-size:17px;
  margin-right:8px;
  box-shadow:0 0 0 1px rgba(148,163,184,.2),0 10px 25px rgba(37,99,235,.8);
}
.title-main{
  font-size:15px;
  font-weight:600;
}
.title-sub{
  font-size:12px;
  color:var(--muted);
}
header-right{
  display:flex;
  align-items:center;
  gap:10px;
}
.badge{
  font-size:11px;
  padding:3px 8px;
  border-radius:999px;
  background:rgba(15,118,110,.18);
  color:#a5f3fc;
  border:1px solid rgba(45,212,191,.6);
}
.btn-home{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:5px 10px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.5);
  background:rgba(15,23,42,.8);
  color:var(--ink);
  font-size:12px;
  cursor:pointer;
}
.btn-home span.icon{
  width:18px;height:18px;
  border-radius:6px;
  background:rgba(30,64,175,.9);
  display:flex;align-items:center;justify-content:center;
  font-size:12px;
}
.btn-home:hover{
  border-color:rgba(248,250,252,.5);
  background:rgba(15,23,42,.95);
}
.user-pill{
  font-size:12px;
  padding:4px 8px;
  border-radius:999px;
  background:rgba(15,23,42,.9);
  border:1px solid rgba(148,163,184,.5);
}

/* Layout: video + right panel */
.main{
  flex:1;
  display:grid;
  grid-template-columns:minmax(0,1.4fr) minmax(0,1.6fr);
  gap:14px;
  padding:10px 14px 14px;
}
@media (max-width:960px){
  html,body{overflow:auto;}
  .app{height:auto;min-height:100vh;}
  .main{
    grid-template-columns:1fr;
    grid-auto-rows:auto;
  }
}

/* Video column */
.video-card{
  background:radial-gradient(circle at top,#1e293b,#020617 60%);
  border-radius:var(--radius);
  border:1px solid rgba(148,163,184,.3);
  box-shadow:var(--shadow-card);
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.video-wrap{
  position:relative;
  background:#020617;
  border-radius:12px;
  overflow:hidden;
  border:1px solid rgba(30,64,175,.7);
}
#video{
  width:100%;
  display:block;
  background:#020617;
}
.video-overlay{
  position:absolute;
  inset:auto 10px 10px 10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  pointer-events:none;
}
.video-overlay-left{
  display:flex;
  align-items:center;
  gap:6px;
  pointer-events:auto;
}
.video-tag{
  font-size:11px;
  padding:2px 7px;
  border-radius:999px;
  background:rgba(15,23,42,.78);
  border:1px solid rgba(148,163,184,.6);
}
.video-overlay-right{
  display:flex;
  align-items:center;
  gap:6px;
  pointer-events:auto;
}
.chip{
  font-size:11px;
  padding:2px 6px;
  border-radius:999px;
  background:rgba(15,23,42,.9);
  border:1px solid rgba(148,163,184,.6);
  display:inline-flex;
  align-items:center;
  gap:4px;
}
.chip strong{font-weight:600;}
.chip button{
  background:none;border:none;color:#e5e7eb;
  font-size:12px;cursor:pointer;padding:0;margin:0;
}

/* Custom controls row under video */
.controls-row{
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  gap:6px;
  font-size:12px;
}
.ctrl-group{
  display:inline-flex;
  align-items:center;
  gap:4px;
  padding:4px 8px;
  border-radius:999px;
  background:rgba(15,23,42,.8);
  border:1px solid rgba(148,163,184,.4);
}
.ctrl-label{color:var(--muted);font-size:11px;}
.ctrl-number{
  font-variant-numeric:tabular-nums;
}
.ctrl-btn{
  width:22px;height:22px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.6);
  background:rgba(15,23,42,.95);
  color:var(--ink);
  font-size:13px;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;
}
.ctrl-btn:hover{background:#1e293b;}
.ctrl-switch{
  display:inline-flex;
  align-items:center;
  gap:4px;
  padding:3px 7px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.5);
  background:rgba(15,23,42,.9);
  cursor:pointer;
}
.ctrl-switch input{display:none;}
.ctrl-switch span.indicator{
  width:14px;height:14px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.7);
  background:#020617;
}
.ctrl-switch.on span.indicator{
  background:#22c55e;
  border-color:#22c55e;
}
.ctrl-switch span.label{font-size:11px;color:var(--muted);}

/* Right column: tabs */
.right-card{
  background:rgba(15,23,42,.98);
  border-radius:var(--radius);
  border:1px solid rgba(148,163,184,.4);
  box-shadow:var(--shadow-card);
  display:flex;
  flex-direction:column;
  min-height:0;
}
.tabs{
  display:flex;
  align-items:center;
  padding:8px 10px 0;
  gap:8px;
  flex-wrap:wrap;
}
.tab-btn{
  padding:5px 10px;
  border-radius:999px;
  border:1px solid transparent;
  font-size:12px;
  background:transparent;
  color:var(--muted);
  cursor:pointer;
}
.tab-btn.active{
  background:rgba(37,99,235,.2);
  border-color:rgba(129,140,248,.85);
  color:#e5e7eb;
}
.tab-btn span.icon{
  margin-right:4px;
}
.tab-extra{
  margin-left:auto;
  display:flex;
  align-items:center;
  gap:6px;
  font-size:11px;
  color:var(--muted);
}
.tab-extra .dot{
  width:6px;height:6px;border-radius:999px;background:#22c55e;
}

/* Tab content */
.tab-panels{
  flex:1;
  min-height:0;
  padding:6px 10px 10px;
}
.tab-panel{
  display:none;
  height:100%;
}
.tab-panel.active{display:flex;}
.panel-inner{
  background:rgba(15,23,42,.96);
  border-radius:12px;
  border:1px solid rgba(30,64,175,.7);
  padding:8px 10px 10px;
  display:flex;
  flex-direction:column;
  min-height:0;
}

/* å­—å¹•è¡¨æ ¼ */
.sub-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:6px;
  font-size:12px;
}
.sub-header-left{color:var(--muted);}
.sub-header-right{
  font-size:11px;
  color:var(--muted);
  display:flex;
  align-items:center;
  gap:6px;
}
.sub-header-right code{
  background:rgba(15,23,42,.8);
  border-radius:999px;
  padding:2px 8px;
  border:1px solid rgba(148,163,184,.6);
}

/* scroll container */
.scroll-area{
  flex:1;
  min-height:0;
  overflow:auto;
  border-radius:10px;
  border:1px solid rgba(30,64,175,.6);
  background:radial-gradient(circle at 0 0,#020617,#020617 55%);
}
.scroll-area table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
.scroll-area thead th{
  position:sticky;
  top:0;
  z-index:1;
  background:rgba(15,23,42,.98);
  padding:6px 8px;
  text-align:left;
  border-bottom:1px solid rgba(30,64,175,.8);
  font-weight:500;
}
.scroll-area tbody td{
  padding:5px 8px;
  border-bottom:1px solid rgba(30,64,175,.35);
}
.scroll-area tbody tr:nth-child(2n){
  background:rgba(15,23,42,.96);
}
.scroll-area tbody tr.highlight{
  background:rgba(30,64,175,.75) !important;
}
.scroll-area tbody tr:hover{
  background:rgba(30,64,175,.55);
}
.cue-time{
  width:54px;
  font-variant-numeric:tabular-nums;
  cursor:pointer;
  white-space:nowrap;
}
.cue-en{
  cursor:pointer;
}
.en-line{display:block;}
.zh-line,.ja-line{color:var(--muted);font-size:12px;}

/* Quiz tab */
.quiz-filters{
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  gap:6px;
  margin-bottom:6px;
  font-size:12px;
}
.quiz-filters select{
  background:rgba(15,23,42,.9);
  color:var(--ink);
  border-radius:999px;
  border:1px solid rgba(148,163,184,.7);
  padding:3px 8px;
  font-size:12px;
}
.quiz-filters button{
  border-radius:999px;
  border:1px solid rgba(148,163,184,.7);
  background:rgba(30,64,175,.85);
  color:#e5e7eb;
  padding:3px 9px;
  font-size:12px;
  cursor:pointer;
}
.quiz-filters button.secondary{
  background:rgba(15,23,42,.9);
}

/* å–®å­— tab */
.vocab-cards{
  display:flex;
  flex-direction:column;
  gap:6px;
  padding:6px;
}
.vocab-card{
  border-radius:10px;
  border:1px solid rgba(30,64,175,.8);
  padding:6px 8px;
  background:rgba(15,23,42,.98);
  font-size:13px;
}
.vocab-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:2px;
}
.vocab-word{font-weight:600;}
.vocab-pos{
  font-size:11px;
  color:var(--muted);
}
.vocab-time{
  font-size:11px;
  color:var(--muted);
}
.vocab-zh{color:var(--muted);font-size:12px;}
.vocab-en-example{margin-top:3px;font-size:12px;}
.vocab-zh-example{font-size:12px;color:var(--muted);}
.vocab-tags{
  margin-top:4px;
  display:flex;
  gap:4px;
  font-size:11px;
  color:var(--muted);
}

/* AI äº’å‹• tab */
.chat-empty{
  font-size:13px;
  color:var(--muted);
  padding:10px;
}
.ai-list{
  display:flex;
  flex-direction:column;
}
.ai-item{
  border-bottom:1px solid rgba(30,64,175,.55);
  padding:7px 8px;
  cursor:pointer;
}
.ai-item:last-child{border-bottom:none;}
.ai-title{font-size:13px;font-weight:500;}
.ai-desc{
  font-size:12px;
  color:var(--muted);
}
.ai-samples{
  margin-top:3px;
  font-size:11px;
  color:var(--muted);
}
.ai-samples span{
  border-radius:999px;
  border:1px solid rgba(148,163,184,.6);
  padding:1px 6px;
  margin-right:4px;
}

/* footer */
footer{
  padding:6px 12px 10px;
  font-size:11px;
  color:rgba(148,163,184,.8);
  text-align:right;
  border-top:1px solid rgba(30,64,175,.65);
  background:radial-gradient(circle at top,#020617,#020617 80%);
}
footer span.brand{color:#93c5fd;font-weight:500;}
footer a{color:#9ca3af;}

@media (max-width:960px){
  .video-card,.right-card{box-shadow:none;}
}
</style>
</head>
<body>
<div class="app">
<header>
  <div class="header-left">
    <span class="logo-badge">B</span>
    <div>
      <div class="title-main">BookWide æ’­æ”¾å™¨</div>
      <div class="title-sub">è‹± / ä¸­ / æ—¥å­—å¹•ï¼‹æ¸¬é©—ï¼‹å–®å­—ï¼‹AI äº’å‹•</div>
    </div>
  </div>
  <div class="header-right">
    <span class="badge">å­¸ç¿’æ¨¡å¼</span>
    <button class="btn-home" type="button" id="btnHome">
      <span class="icon">âŒ‚</span><span>å›é¦–é </span>
    </button>
    <span class="user-pill" id="userEmailPill">å°šæœªç™»å…¥</span>
  </div>
</header>

<main class="main">
  <!-- å·¦ï¼šå½±ç‰‡ -->
  <section class="video-card">
    <div class="video-wrap">
      <video id="video" controls playsinline></video>
      <div class="video-overlay">
        <div class="video-overlay-left">
          <span class="video-tag" id="tagCat">åˆ†é¡ï¼šâ€”</span>
          <span class="video-tag" id="tagSlug">slugï¼šâ€”</span>
        </div>
        <div class="video-overlay-right">
          <span class="chip"><strong>é€²åº¦</strong><span id="chipProgress">0%</span></span>
          <span class="chip"><strong>å®ˆé–€</strong><span id="chipGate">æª¢æŸ¥ä¸­â€¦</span></span>
        </div>
      </div>
    </div>

    <div class="controls-row">
      <div class="ctrl-group">
        <span class="ctrl-label">é€Ÿåº¦</span>
        <button class="ctrl-btn" id="btnSpeedDown">-</button>
        <span class="ctrl-number" id="speedLabel">1.0x</span>
        <button class="ctrl-btn" id="btnSpeedUp">+</button>
      </div>
      <div class="ctrl-group">
        <span class="ctrl-label">å­—å¹•å°é½Š</span>
        <button class="ctrl-btn" id="btnOffsetBack">-</button>
        <span class="ctrl-number" id="offsetLabel">0.0s</span>
        <button class="ctrl-btn" id="btnOffsetForward">+</button>
      </div>
      <label class="ctrl-switch" id="switchFollow">
        <span class="indicator"></span>
        <span class="label">è·Ÿéš¨å­—å¹•</span>
      </label>
      <label class="ctrl-switch" id="switchLoop">
        <span class="indicator"></span>
        <span class="label">A-B å¾ªç’°</span>
      </label>
    </div>
  </section>

  <!-- å³ï¼šå››åˆ†é  -->
  <section class="right-card">
    <div class="tabs">
      <button class="tab-btn active" data-tab="sub">
        <span class="icon">ğŸ“</span>å­—å¹•
      </button>
      <button class="tab-btn" data-tab="quiz">
        <span class="icon">ğŸ¯</span>æ¸¬é©—
      </button>
      <button class="tab-btn" data-tab="vocab">
        <span class="icon">ğŸ“š</span>å–®å­—
      </button>
      <button class="tab-btn" data-tab="ai">
        <span class="icon">ğŸ¤–</span>AIäº’å‹•
      </button>
      <div class="tab-extra">
        <span class="dot"></span>
        <span id="infoTitle">è¼‰å…¥ä¸­â€¦</span>
      </div>
    </div>

    <div class="tab-panels">
      <!-- å­—å¹• -->
      <div class="tab-panel active" id="panel-sub">
        <div class="panel-inner">
          <div class="sub-header">
            <div class="sub-header-left">
              <span id="cuesStatus">å°šæœªè¼‰å…¥å­—å¹•</span>
            </div>
            <div class="sub-header-right">
              <span>è‹± / ä¸­ / æ—¥</span>
            </div>
          </div>
          <div class="scroll-area">
            <table>
              <thead>
                <tr>
                  <th style="width:60px;">æ™‚é–“</th>
                  <th>è‹±æ–‡ / ä¸­æ–‡ / æ—¥æ–‡</th>
                </tr>
              </thead>
              <tbody id="cuesBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- æ¸¬é©— -->
      <div class="tab-panel" id="panel-quiz">
        <div class="panel-inner">
          <div class="quiz-filters">
            <span>é¡Œå‹ï¼š</span>
            <select id="quizTypeFilter">
              <option value="">å…¨éƒ¨</option>
              <option value="listening">è½åŠ›</option>
              <option value="vocab">å–®å­—</option>
              <option value="grammar">æ–‡æ³•</option>
              <option value="speaking">å£èªª</option>
            </select>
            <button id="btnStartQuiz" type="button">é–‹å§‹æ¸¬é©—</button>
            <button id="btnResetQuiz" type="button" class="secondary">é‡è¨­</button>
            <span id="quizStatus"></span>
          </div>
          <div class="scroll-area" id="quizArea">
            <table>
              <thead>
                <tr>
                  <th style="width:50px;">#</th>
                  <th>é¡Œç›®</th>
                  <th style="width:120px;">ä½œç­”</th>
                </tr>
              </thead>
              <tbody id="quizBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- å–®å­— -->
      <div class="tab-panel" id="panel-vocab">
        <div class="panel-inner">
          <div class="sub-header">
            <div class="sub-header-left">é‡é»å­—å½™</div>
            <div class="sub-header-right">
              <span id="vocabStatus">å°šæœªè¼‰å…¥</span>
            </div>
          </div>
          <div class="scroll-area">
            <div class="vocab-cards" id="vocabList"></div>
          </div>
        </div>
      </div>

      <!-- AI äº’å‹• -->
      <div class="tab-panel" id="panel-ai">
        <div class="panel-inner">
          <div class="sub-header">
            <div class="sub-header-left">AI äº’å‹•æƒ…å¢ƒ</div>
            <div class="sub-header-right">
              <span id="aiStatus">å°šæœªè¼‰å…¥</span>
            </div>
          </div>
          <div class="scroll-area">
            <div class="ai-list" id="aiList"></div>
          </div>
        </div>
      </div>

    </div>
  </section>
</main>

<footer>
  <span class="brand">BookWide</span> Â© 2025 ï½œ å½±ç‰‡å…§å®¹ç‰ˆæ¬Šæ­¸åŸä½œè€…æ‰€æœ‰ï¼Œæœ¬å¹³å°åƒ…åšè‹±æ–‡å­¸ç¿’ç”¨é€”ã€‚
</footer>
</div>

<script>
const BASE='';
function esc(s){return String(s).replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]||c));}
function qs(sel){return document.querySelector(sel);}
const urlParams=new URLSearchParams(location.search);
const cat=urlParams.get('cat')||'story';
const slug=urlParams.get('slug')||'demo';
const vnow=Date.now();

const videoEl=qs('#video');
const cuesStatus=qs('#cuesStatus');
const cuesBody=qs('#cuesBody');
const vocabList=qs('#vocabList');
const vocabStatus=qs('#vocabStatus');
const aiList=qs('#aiList');
const aiStatus=qs('#aiStatus');
const quizBody=qs('#quizBody');
const quizStatus=qs('#quizStatus');
const quizArea=qs('#quizArea');
const infoTitle=qs('#infoTitle');
const userEmailPill=qs('#userEmailPill');
const tagCat=qs('#tagCat');
const tagSlug=qs('#tagSlug');
const chipProgress=qs('#chipProgress');
const chipGate=qs('#chipGate');

let cues=[];
let vocab=[];
let aiScripts=[];
let quizData=[];
let offsetSec=0;
let followEnabled=true;
let loopEnabled=false;
let loopRange=null;
let lastHighlightIndex=-1;
let lastQuizScore=null;
let currentUser=null;
let playStartTime=null;
let playedSecAccum=0;

tagCat.textContent='åˆ†é¡ï¼š'+cat;
tagSlug.textContent='slugï¼š'+slug;

const storedUser=localStorage.getItem('bw_user_email');
if(storedUser){
  currentUser={email:storedUser};
  userEmailPill.textContent=storedUser;
}else{
  userEmailPill.textContent='æœªç™»å…¥ï¼ˆåƒ…ç¤ºç¯„ç”¨ï¼‰';
}

const supabaseUrl=document.querySelector('meta[name="supabase-url"]')?.content||'https://jeajrwpmrgczimmrflxo.supabase.co';
const supabaseAnonKey=document.querySelector('meta[name="supabase-anon-key"]')?.content||'';
const VIDEO_BUCKET='videos';
const ASSET_BUCKET='assets';

const videoUrl=`${supabaseUrl}/storage/v1/object/public/${VIDEO_BUCKET}/${cat}/${slug}.mp4`;
const coverUrl=`${supabaseUrl}/storage/v1/object/public/${ASSET_BUCKET}/${cat}/${slug}.jpg`;
videoEl.src=videoUrl;

videoEl.addEventListener('play',()=>{
  playStartTime=Date.now();
});
videoEl.addEventListener('pause',()=>{
  accumulatePlayed();
});
videoEl.addEventListener('ended',()=>{
  accumulatePlayed();
});
function accumulatePlayed(){
  if(!playStartTime) return;
  const delta=(Date.now()-playStartTime)/1000;
  playedSecAccum+=delta;
  playStartTime=null;
}
window.addEventListener('beforeunload',()=>{
  accumulatePlayed();
});

function fmt(sec){
  const s=Math.max(0,Math.floor(sec));
  const m=Math.floor(s/60);
  const r=s%60;
  return (m<10?'0'+m:m)+':'+(r<10?'0'+r:r);
}
function toSec(time){
  if(!time) return 0;
  const m=/^(\\d+):(\\d+)(?::(\\d+))?/.exec(time);
  if(!m) return 0;
  const h=0;
  const mm=parseInt(m[1],10);
  const ss=parseInt(m[2],10);
  return h*3600+mm*60+ss;
}

/* â˜…â˜…â˜… é€™è£¡æ˜¯æœ‰æ”¹éçš„ï¼šè®€å– source_urlï¼Œä¸¦é¡¯ç¤º YouTube é€£çµ â˜…â˜…â˜… */
async function loadCues(){
  cuesStatus.textContent='ï¼ˆå­—å¹•è¼‰å…¥ä¸­â€¦ï¼‰';
  const url=`${BASE}/data/${cat}/${slug}/cues-${slug}.json?v=${vnow}`;
  try{
    const r=await fetch(url,{cache:'no-store'});
    if(!r.ok) throw 0;
    const data=await r.json();

    let sourceUrl='';
    let rows=[];
    if(Array.isArray(data)){
      rows=data;
      if(data.length && data[0].source_url) sourceUrl=data[0].source_url;
    }else{
      rows=data.cues||[];
      if(data.source_url) sourceUrl=data.source_url;
    }

    cues=rows.map(x=>({t:toSec(x.time),en:x.en||'',zh:x.zh||'',ja:x.ja||''}));
    cuesBody.innerHTML=cues.map((c,i)=>`
      <tr data-i="${i}" style="position:relative">
        <td class="cue-time">${c.t?fmt(c.t):''}</td>
        <td class="cue-en">
          <span class="en-line">${esc(c.en)}</span>
          ${c.zh?`<div class="zh-line">${esc(c.zh)}</div>`:''}
          ${c.ja?`<div class="ja-line">${esc(c.ja)}</div>`:''}
        </td>
      </tr>`).join('');

    if(sourceUrl){
      const safeSrc=esc(sourceUrl);
      const safeUrl=esc(url);
      cuesStatus.innerHTML=`å·²è¼‰å…¥ï¼š${safeUrl}ã€€ï½œ å½±ç‰‡ä¾†æºï¼š<a href="${safeSrc}" target="_blank" rel="noopener">YouTube åŸå§‹å½±ç‰‡</a>`;
    }else{
      cuesStatus.textContent=`å·²è¼‰å…¥ï¼š${url}`;
    }
  }catch(e){
    console.warn(e);
    cuesStatus.textContent='âš ï¸ å­—å¹•è®€å–å¤±æ•—ï¼š'+url;
  }

  cuesBody.addEventListener('click',e=>{
    const tr=e.target.closest('tr'); if(!tr)return;
    const i=+tr.dataset.i;

    if(e.target.closest('.cue-time')){
      seekTo(i,true);
      return;
    }

    let lang='en-US',text='';
    if(e.target.closest('.zh-line')){ lang='zh-TW'; text=cues[i].zh||cues[i].en; }
    else if(e.target.closest('.ja-line')){ lang='ja-JP'; text=cues[i].ja||cues[i].en; }
    else{ lang='en-US'; text=cues[i].en; }
    speakBrowser(lang,text);
  });
}

async function loadVocab(){
  vocabStatus.textContent='ï¼ˆè¼‰å…¥ä¸­â€¦ï¼‰';
  const url=`${BASE}/data/${cat}/${slug}/vocab-${slug}.json?v=${vnow}`;
  try{
    const r=await fetch(url,{cache:'no-store'});
    if(!r.ok) throw 0;
    vocab=await r.json();
    vocabList.innerHTML=vocab.map(v=>`
      <article class="vocab-card">
        <header class="vocab-header">
          <div>
            <div class="vocab-word">${esc(v.word)}</div>
            <div class="vocab-pos">${esc(v.pos||'')}</div>
          </div>
          <div class="vocab-time">${v.time?esc(v.time):''}</div>
        </header>
        <div class="vocab-zh">${esc(v.zh||'')}</div>
        <div class="vocab-en-example">${esc(v.en_example||'')}</div>
        <div class="vocab-zh-example">${esc(v.zh_example||'')}</div>
      </article>
    `).join('');
    vocabStatus.textContent=`å·²è¼‰å…¥ ${vocab.length} ç­†å­—å½™`;
  }catch(e){
    console.warn(e);
    vocabStatus.textContent='âš ï¸ è¼‰å…¥å¤±æ•—';
  }
}

async function loadAi(){
  aiStatus.textContent='ï¼ˆè¼‰å…¥ä¸­â€¦ï¼‰';
  const url=`${BASE}/data/${cat}/${slug}/ai-${slug}.json?v=${vnow}`;
  try{
    const r=await fetch(url,{cache:'no-store'});
    if(!r.ok) throw 0;
    aiScripts=await r.json();
    aiList.innerHTML=aiScripts.map((item,i)=>`
      <div class="ai-item" data-i="${i}">
        <div class="ai-title">${esc(item.title||'')}</div>
        <div class="ai-desc">${esc(item.desc||'')}</div>
        <div class="ai-samples">
          ${(item.sample_questions||[]).map(q=>`<span>${esc(q)}</span>`).join('')}
        </div>
      </div>
    `).join('');
    aiStatus.textContent=`å·²è¼‰å…¥ ${aiScripts.length} çµ„æƒ…å¢ƒ`;
  }catch(e){
    console.warn(e);
    aiStatus.textContent='âš ï¸ è¼‰å…¥å¤±æ•—';
  }
}

async function loadQuiz(){
  quizStatus.textContent='ï¼ˆè¼‰å…¥ä¸­â€¦ï¼‰';
  const url=`${BASE}/data/${cat}/${slug}/quiz-${slug}.json?v=${vnow}`;
  try{
    const r=await fetch(url,{cache:'no-store'});
    if(!r.ok) throw 0;
    quizData=await r.json();
    renderQuizTable();
    quizStatus.textContent=`å…± ${quizData.length} é¡Œ`;
  }catch(e){
    console.warn(e);
    quizStatus.textContent='âš ï¸ è¼‰å…¥å¤±æ•—';
  }
}

function renderQuizTable(){
  const typeFilter=qs('#quizTypeFilter').value;
  const rows=quizData
    .map((q,i)=>({...q,index:i+1}))
    .filter(q=>!typeFilter||q.type===typeFilter);
  quizBody.innerHTML=rows.map(q=>`
    <tr data-i="${q.index-1}">
      <td>${q.index}</td>
      <td>
        <div>${esc(q.question_en||'')}</div>
        <div style="font-size:12px;color:var(--muted);">${esc(q.question_zh||'')}</div>
        <div style="margin-top:2px;font-size:12px;">
          ${(q.options||[]).map((opt,j)=>`<span style="margin-right:10px;">(${String.fromCharCode(65+j)}) ${esc(opt)}</span>`).join('')}
        </div>
      </td>
      <td>
        <select data-role="answer">
          <option value="">â€”</option>
          ${(q.options||[]).map((opt,j)=>`<option value="${String.fromCharCode(65+j)}">${String.fromCharCode(65+j)}</option>`).join('')}
        </select>
      </td>
    </tr>
  `).join('');
}

function speakBrowser(lang,text){
  if(!window.speechSynthesis) return;
  const u=new SpeechSynthesisUtterance(text);
  u.lang=lang;
  u.rate=1;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

function seekTo(i,play){
  const cue=cues[i];
  if(!cue) return;
  videoEl.currentTime=Math.max(0,(cue.t||0)+offsetSec);
  if(play) videoEl.play();
}

const tabButtons=document.querySelectorAll('.tab-btn');
tabButtons.forEach(btn=>{
  btn.addEventListener('click',()=>{
    const tab=btn.dataset.tab;
    tabButtons.forEach(b=>b.classList.toggle('active',b===btn));
    document.querySelectorAll('.tab-panel').forEach(p=>{
      p.classList.toggle('active',p.id===`panel-${tab}`);
    });
  });
});

const btnHome=qs('#btnHome');
btnHome.addEventListener('click',()=>{
  location.href='index.html';
});

videoEl.addEventListener('timeupdate',()=>{
  const t=videoEl.currentTime-offsetSec;
  highlightCueByTime(t);
});
function highlightCueByTime(t){
  if(!cues.length) return;
  let idx=-1;
  for(let i=0;i<cues.length;i++){
    if(cues[i].t<=t+0.01) idx=i; else break;
  }
  if(idx===lastHighlightIndex) return;
  lastHighlightIndex=idx;
  const trs=cuesBody.querySelectorAll('tr');
  trs.forEach(tr=>tr.classList.remove('highlight'));
  if(idx>=0 && idx<trs.length){
    const tr=trs[idx];
    tr.classList.add('highlight');
    if(followEnabled){
      const parent=tr.closest('.scroll-area');
      if(parent){
        const top=tr.offsetTop-parent.offsetTop;
        parent.scrollTop=top-parent.clientHeight/3;
      }
    }
  }
}

const speedLabel=qs('#speedLabel');
qs('#btnSpeedUp').addEventListener('click',()=>changeSpeed(0.1));
qs('#btnSpeedDown').addEventListener('click',()=>changeSpeed(-0.1));
function changeSpeed(delta){
  let s=videoEl.playbackRate+delta;
  s=Math.min(2,Math.max(0.5,Math.round(s*10)/10));
  videoEl.playbackRate=s;
  speedLabel.textContent=s.toFixed(1)+'x';
}

const offsetLabel=qs('#offsetLabel');
qs('#btnOffsetForward').addEventListener('click',()=>changeOffset(0.1));
qs('#btnOffsetBack').addEventListener('click',()=>changeOffset(-0.1));
function changeOffset(delta){
  offsetSec=Math.max(-3,Math.min(3,offsetSec+delta));
  offsetLabel.textContent=offsetSec.toFixed(1)+'s';
}

const switchFollow=qs('#switchFollow');
switchFollow.addEventListener('click',()=>{
  followEnabled=!followEnabled;
  switchFollow.classList.toggle('on',followEnabled);
});
switchFollow.classList.add('on');

const switchLoop=qs('#switchLoop');
switchLoop.addEventListener('click',()=>{
  loopEnabled=!loopEnabled;
  switchLoop.classList.toggle('on',loopEnabled);
});
videoEl.addEventListener('timeupdate',()=>{
  if(loopEnabled && loopRange){
    if(videoEl.currentTime>loopRange[1]+0.05){
      videoEl.currentTime=loopRange[0];
    }
  }
});

const quizTypeFilter=qs('#quizTypeFilter');
quizTypeFilter.addEventListener('change',renderQuizTable);
qs('#btnStartQuiz').addEventListener('click',()=>{
  const selects=quizBody.querySelectorAll('select[data-role="answer"]');
  if(!selects.length){
    alert('å°šæœªè¼‰å…¥æ¸¬é©—é¡Œç›®ã€‚');
    return;
  }
  const answers=[];
  selects.forEach((sel,idx)=>{
    const q=quizData[idx];
    if(!q) return;
    const userAns=sel.value;
    const correct=q.answer;
    answers.push({idx,correct,userAns});
  });
  let correctCount=0;
  answers.forEach(a=>{
    if(!quizData[a.idx]) return;
    const tr=quizBody.querySelector(`tr[data-i="${a.idx}"]`);
    if(!tr) return;
    tr.style.background='';
    if(!a.userAns) return;
    if(a.userAns===a.correct){
      correctCount++;
      tr.style.background='rgba(22,163,74,.45)';
    }else{
      tr.style.background='rgba(220,38,38,.35)';
    }
  });
  const total=answers.filter(a=>a.userAns).length||answers.length||1;
  const score=Math.round(correctCount/total*100);
  quizStatus.textContent=`æœ¬æ¬¡å¾—åˆ† ${score} åˆ†ï¼ˆç­”å° ${correctCount} / ${total} é¡Œï¼‰`;
  lastQuizScore=score;
});
qs('#btnResetQuiz').addEventListener('click',()=>{
  quizBody.querySelectorAll('select[data-role="answer"]').forEach(sel=>sel.value='');
  quizBody.querySelectorAll('tr').forEach(tr=>tr.style.background='');
  quizStatus.textContent='';
  lastQuizScore=null;
});

document.addEventListener('DOMContentLoaded',()=>{
  infoTitle.textContent=`${cat} / ${slug}`;
  loadCues();
  loadVocab();
  loadAi();
  loadQuiz();
});
</script>
</body>
</html>
