<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BookWide Player · Slim v2 · 可覆蓋版</title>
<style>
:root{
  --bg:#0b1220; --panel:#0f172a; --ink:#e5e7eb; --muted:#94a3b8;
  --accent:#38bdf8; --ok:#34d399; --warn:#f59e0b; --danger:#ef4444;
  --tab:#111827; --line:#1e2a3e;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,Segoe UI,Roboto,Helvetica,Arial}

/* ===== 固定：上標題、下工具列 ===== */
.header{
  position:fixed; inset:0 0 auto 0; height:52px;
  display:flex; align-items:center; gap:12px; padding:0 14px;
  background:linear-gradient(180deg,#0b1220,rgba(11,18,32,.9));
  border-bottom:1px solid #0f223e; z-index:40;
}
.header a,.header button{background:#0b1b2e;border:1px solid #133455;color:#eaf3ff;
  border-radius:10px;padding:8px 12px;text-decoration:none;cursor:pointer}
.header .meta{margin-left:auto;opacity:.75;font-size:13px}

.footer{
  position:fixed; inset:auto 0 0 0; height:76px; display:flex; align-items:center; gap:10px;
  padding:10px 12px; background:linear-gradient(0deg,#0b1220,rgba(11,18,32,.95));
  border-top:1px solid #0f223e; z-index:40;
}

/* ===== 中間 50:50 兩欄，只有右側捲動 ===== */
.main{position:fixed; top:52px; bottom:76px; left:0; right:0; display:flex; gap:10px; padding:10px}
.left,.right{background:var(--panel); border:1px solid #13223b; border-radius:12px; padding:10px; min-width:0}
.left{flex:0 0 50%; min-width:50%; display:flex; flex-direction:column; gap:10px; overflow:hidden}
.right{flex:0 0 50%; min-width:50%; display:flex; flex-direction:column; overflow:auto}

/* ===== 影片區：盡量放大顯示 ===== */
.videoWrap{flex:1; display:flex; align-items:center; justify-content:center; background:#000; border-radius:12px; overflow:hidden}
video{width:100%; height:100%; object-fit:contain; background:#000}

/* ===== 工具列（底部固定，但內容在左側） ===== */
.controls{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.btn{background:#0d1b2c; color:#e7f3ff; border:1px solid #12314d; padding:8px 10px; border-radius:10px; cursor:pointer}
.btn:hover{border-color:#1f4b74}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #22445f;background:#0b1b2e;color:#b9d8ff}
.range{display:flex; align-items:center; gap:6px}
.controls .group{display:flex; align-items:center; gap:8px}
.controls .left-rail{flex:1 1 auto}

/* ===== 右側分頁 ===== */
.tabs{display:flex; gap:6px; padding:4px; position:sticky; top:0; z-index:2; background:#0a1525; border-radius:10px}
.tab{background:var(--tab); border:1px solid #172033; padding:8px 12px; border-radius:10px; cursor:pointer}
.tab.active{background:#102039;border-color:#224;color:#cbe7ff}
.pane{padding:10px}
.hide{display:none}

/* 字幕表 */
.cues{width:100%; border-collapse:collapse}
.cues th,.cues td{padding:10px;border-bottom:1px dashed var(--line);vertical-align:top}
.cues .ts{color:#9fb7d6;white-space:nowrap;width:72px}
.cues .en{font-weight:600}
.cues .zh{color:#a9b8c9}
.cues tr.active{background:#11223a}

/* 測驗 */
.q-tabs{display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px}
.q-tab{padding:6px 12px;border-radius:999px;border:1px solid #17415e;background:#0a1727;cursor:pointer}
.q-tab.active{background:#10314f;color:#cbe7ff}
.q-item{padding:12px;border:1px solid #172a44;border-radius:10px;margin:10px 0;background:#0c1526}
.q-item .title{font-weight:700;margin-bottom:6px}
.q-item .opts{display:flex;gap:10px;flex-direction:column}
.q-item .exp{color:#a7c0d8;margin-top:8px}
.scorebar{position:sticky;bottom:0;background:#0a1520;padding:8px;border-top:1px solid #1b2b46;display:flex;gap:10px;align-items:center;border-radius:0 0 10px 10px}

/* 單字卡 */
.card{border:1px solid #162a44;background:#0b1627;border-radius:10px;padding:12px;margin:10px 0}
.card h4{margin:0 0 6px 0}

/* 列印：只印右側內容 */
@media print{
  .header,.footer,.left,.videoWrap{display:none !important}
  .main{position:static; display:block; padding:0}
  .right{min-width:100%; flex:0 0 100%; border:0; background:#fff; color:#000}
  body{background:#fff;color:#000}
  .tabs{display:none}
  .pane,.q-item{background:#fff;border:1px solid #ccc;color:#000}
}
</style>
</head>
<body>
  <!-- 上：固定標頭 -->
  <div class="header">
    <a id="btnHome" href="./index.html">← 回首頁</a>
    <div id="title" class="badge">BookWide Player · Slim v2</div>
    <div class="meta" id="meta"></div>
    <button id="btnFav" class="btn">☆ 我的收藏</button>
  </div>

  <!-- 中：主體 -->
  <div class="main">
    <!-- 左：影片 -->
    <section class="left">
      <div class="videoWrap">
        <video id="vid" controls playsinline></video>
      </div>
    </section>

    <!-- 右：學習分頁 -->
    <section class="right">
      <div class="tabs">
        <div class="tab active" data-pane="pane-cues">字幕</div>
        <div class="tab" data-pane="pane-quiz">測驗</div>
        <div class="tab" data-pane="pane-vocab">單字</div>
        <div class="tab" data-pane="pane-ai">AI 互動</div>
      </div>

      <!-- 字幕 -->
      <div class="pane" id="pane-cues">
        <div class="badge" id="cuesInfo">—</div>
        <table class="cues" id="cuesTable">
          <thead><tr><th class="ts">時間</th><th>英文</th><th>中文</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- 測驗 -->
      <div class="pane hide" id="pane-quiz">
        <div class="q-tabs" id="qTabs"></div>
        <div id="quizWrap"></div>
        <div class="scorebar">
          <button id="btnSubmit" class="btn">交卷</button>
          <button id="btnShow" class="btn">顯示答案</button>
          <button id="btnPrint" class="btn">列印成績單</button>
          <span id="scoreText" class="badge">本分區分數：0 / 100</span>
        </div>
      </div>

      <!-- 單字 -->
      <div class="pane hide" id="pane-vocab">
        <div class="badge" id="vocabInfo">—</div>
        <div id="vocabWrap"></div>
      </div>

      <!-- AI -->
      <div class="pane hide" id="pane-ai">
        <div class="ai-topic" id="aiTopics" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px"></div>
        <div>
          <label>題目：</label>
          <textarea id="aiPrompt" style="width:100%;min-height:120px"></textarea>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn" id="btnPrevTopic">◀ 上一題</button>
            <button class="btn" id="btnNextTopic">下一題 ▶</button>
            <button class="btn" id="btnReadQ">🔈 朗讀題目</button>
          </div>
          <div id="aiHint" style="margin-top:8px;color:#9fb7d6"></div>
          <div id="aiSample" style="margin-top:6px;color:#a7c0d8"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- 下：固定工具列（功能都在左側） -->
  <div class="footer">
    <div class="controls left-rail">
      <div class="group">
        <button class="btn" id="btnPrev">上一句</button>
        <button class="btn" id="btnPlay">播放 / 暫停</button>
        <button class="btn" id="btnNext">下一句</button>
        <button class="btn" id="btnRepeat">重複本句</button>
      </div>
      <div class="group">
        <label class="badge"><input type="checkbox" id="chkFollow" checked> 跟隨</label>
        <span class="badge">偏移</span>
        <button class="btn" id="btnShiftMinus">-0.5s</button>
        <button class="btn" id="btnShiftPlus">+0.5s</button>
      </div>
      <div class="group range">
        <span class="badge">速度</span>
        <input id="rate" type="range" min="0.5" max="2" step="0.05" value="1">
        <span id="rateLabel">1.00x</span>
        <button class="btn" id="btnCalib">簡易校準</button>
        <button class="btn" id="btnSpeak">🔈 朗讀</button>
      </div>
    </div>
    <span id="status" class="badge">準備就緒</span>
  </div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const cat = qs.get('cat') || 'story';
  const slug = qs.get('slug') || 'mid-autumn';

  const $ = (s, p=document)=>p.querySelector(s);
  const $$ = (s, p=document)=>Array.from(p.querySelectorAll(s));

  const elVid = $('#vid');
  const elMeta = $('#meta');
  const elStatus = $('#status');

  elMeta.textContent = `cat=${cat} · slug=${slug}`;

  /* ===== 影片路徑（優先 ./videos/<cat>/<slug>.mp4 → 回退 ./videos/<slug>.mp4） ===== */
  const sources = [`./videos/${cat}/${slug}.mp4`, `./videos/${slug}.mp4`];
  elVid.src = sources[0];
  elVid.addEventListener('error',()=>{
    if(elVid.src.endsWith(sources[0])) elVid.src = sources[1];
  },{once:true});

  /* ===== 分頁 ===== */
  $$('.tab').forEach(t=>t.addEventListener('click',()=>{
    $$('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    $$('.pane').forEach(p=>p.classList.add('hide'));
    $('#'+t.dataset.pane).classList.remove('hide');
    if(t.dataset.pane==='pane-cues') syncActiveRow();
  }));

  /* ===== JSON 載入工具 ===== */
  async function fetchJSON(path){
    const res = await fetch(path+`?v=${Date.now()}`,{cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    return await res.json();
  }

  /* ===== 字幕（只支援統一 story 格式：[{start,end,en,zh}]） ===== */
  let cues = []; let offset = 0; let loop = false;
  const elTbody = $('#cuesTable tbody');

  function renderCues(){
    elTbody.innerHTML = cues.map((c,i)=>{
      const ts = new Date((c.start||0)*1000).toISOString().substr(14,5);
      return `<tr data-i="${i}"><td class="ts">${ts}</td><td class="en">${c.en||''}</td><td class="zh">${c.zh||''}</td></tr>`;
    }).join('');
    $$('#cuesTable tbody tr').forEach(tr=>{
      tr.addEventListener('click',()=>{
        const i = +tr.dataset.i;
        elVid.currentTime = (cues[i].start||0) + offset;
        elVid.play();
      });
    });
  }
  function syncActiveRow(){
    const t = elVid.currentTime - offset;
    const i = cues.findIndex(c=> t>=c.start && t<(c.end??(c.start+10)));
    $$('#cuesTable tbody tr').forEach((tr,idx)=>{
      tr.classList.toggle('active', idx===i);
      if(idx===i && $('#chkFollow').checked){
        tr.scrollIntoView({block:'center',behavior:'smooth'});
      }
    });
  }

  /* ===== 測驗（四分區：Vocabulary / Grammar / Reading / Mixed；各題 5 分） ===== */
  let quizAll = []; const elQTabs = $('#qTabs'); const elQuizWrap = $('#quizWrap');
  const groups = ['Vocabulary','Grammar','Reading','Mixed']; let activeGroup = 'Vocabulary';

  function buildQTabs(){
    elQTabs.innerHTML = groups.map(g=>{
      const n = quizAll.filter(q=>q.section===g).length;
      const zh = g==='Vocabulary'?'單字':g==='Grammar'?'文法':g==='Reading'?'閱讀':'綜合';
      return `<button class="q-tab ${g===activeGroup?'active':''}" data-g="${g}">${zh} (${n})</button>`;
    }).join('');
    $$('.q-tab',elQTabs).forEach(b=>b.addEventListener('click',()=>{ activeGroup=b.dataset.g; buildQTabs(); renderQuiz(); }));
  }
  function renderQuiz(showAns=false){
    const arr = quizAll.filter(q=>q.section===activeGroup);
    elQuizWrap.innerHTML = arr.map((q,idx)=>{
      const name = `q_${activeGroup}_${idx}`;
      const opts = (q.options||[]).map(o=>`<label><input type="radio" name="${name}" value="${o}"> ${o}</label>`).join('<br/>');
      const exp = showAns? `<div class="exp">正解：<b>${q.answer}</b>${q.explanation? '　｜　'+q.explanation:''}</div>`:'';
      return `<div class="q-item"><div class="title">${idx+1}. ${q.question||q.q}</div><div class="opts">${opts}</div>${exp}</div>`;
    }).join('');
  }
  function submitQuiz(){
    const arr = quizAll.filter(q=>q.section===activeGroup);
    let score = 0;
    $$('.q-item').forEach((div,i)=>{
      const inputs = div.querySelectorAll('input[type=radio]');
      const checked = Array.from(inputs).find(x=>x.checked);
      if(!checked) return;
      if(arr[i].answer===checked.value) score += 5;
      if(!div.querySelector('.exp')){
        const hint=document.createElement('div');
        hint.className='exp';
        hint.innerHTML = `正解：<b>${arr[i].answer}</b>${arr[i].explanation? '　｜　'+arr[i].explanation:''}`;
        div.appendChild(hint);
      }
    });
    $('#scoreText').textContent = `本分區分數：${score} / 100`;
  }

  /* ===== 單字 ===== */
  function renderVocab(list){
    const wrap = $('#vocabWrap');
    wrap.innerHTML = (list||[]).map(v=>{
      const def = v.definition || v.def || '';
      return `<div class="card"><h4>${v.word||v.w||''}</h4><div>${v.zh||''}</div><div style="opacity:.8">${def}</div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="btn btnSpeak" data-text="${(v.word||'')}">🔈 朗讀</button>
        </div></div>`;
    }).join('');
    $$('.btnSpeak',wrap).forEach(b=>b.addEventListener('click',()=>speak(b.dataset.text)));
  }

  /* ===== AI ===== */
  let ai = {topics:[]}, aiIndex = 0;
  function renderAI(){
    const topics = ai.topics||[];
    if(!topics.length){ $('#aiTopics').innerHTML = '<span class="badge">暫無 AI 資料</span>'; return; }
    $('#aiTopics').innerHTML = topics.map((t,i)=>`<button class="btn ${i===aiIndex?'badge':''}" data-i="${i}">${t.title||('Topic '+(i+1))}</button>`).join('');
    $$('#aiTopics button').forEach(b=>b.addEventListener('click',()=>{ aiIndex=+b.dataset.i; setTopic(); }));
    setTopic();
  }
  function setTopic(){
    const t = (ai.topics||[])[aiIndex]||{};
    $('#aiPrompt').value = t.prompt||'';
    $('#aiHint').textContent = t.hint? 'hint：'+t.hint : '';
    $('#aiSample').textContent = t.sample? '示範：'+t.sample : '';
    $$('#aiTopics button').forEach((b,i)=> b.classList.toggle('badge', i===aiIndex));
  }
  $('#btnPrevTopic').onclick = ()=>{ aiIndex=(aiIndex-1+ (ai.topics||[]).length)%((ai.topics||[]).length||1); setTopic(); };
  $('#btnNextTopic').onclick = ()=>{ aiIndex=(aiIndex+1)%((ai.topics||[]).length||1); setTopic(); };
  $('#btnReadQ').onclick = ()=> speak($('#aiPrompt').value||'');

  /* ===== 朗讀 ===== */
  function speak(text){
    if(!('speechSynthesis' in window)) return alert('此瀏覽器不支援朗讀');
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'en-US'; u.rate = 1; speechSynthesis.cancel(); speechSynthesis.speak(u);
  }
  $('#btnSpeak').onclick = ()=>{
    const i = $$('#cuesTable tbody tr').findIndex(tr=>tr.classList.contains('active'));
    const t = cues[i]?.en || '';
    speak(t);
  };

  /* ===== 控制鍵 ===== */
  $('#btnPrev').onclick = ()=>{
    const t = elVid.currentTime - offset;
    let i = cues.findIndex(c=>t>=c.start && t<(c.end??(c.start+10)));
    if(i<=0) i=1;
    elVid.currentTime = (cues[i-1].start||0)+offset; elVid.play();
  };
  $('#btnNext').onclick = ()=>{
    const t = elVid.currentTime - offset;
    let i = cues.findIndex(c=>t>=c.start && t<(c.end??(c.start+10)));
    if(i<0) i=0;
    if(i<cues.length-1) elVid.currentTime = (cues[i+1].start||0)+offset;
    elVid.play();
  };
  $('#btnPlay').onclick = ()=> elVid.paused ? elVid.play() : elVid.pause();
  $('#btnRepeat').onclick = ()=>{ loop = !loop; $('#btnRepeat').classList.toggle('badge',loop); if(loop) elVid.play(); };
  $('#btnShiftMinus').onclick = ()=>{ offset -= .5; $('#status').textContent=`偏移 ${offset.toFixed(1)}s`; };
  $('#btnShiftPlus').onclick = ()=>{ offset += .5; $('#status').textContent=`偏移 ${offset.toFixed(1)}s`; };
  $('#rate').oninput = e=>{ const r = +e.target.value || 1; elVid.playbackRate = r; $('#rateLabel').textContent=`${r.toFixed(2)}x`; };
  $('#btnCalib').onclick = ()=>{ offset = 0; $('#status').textContent='校準 0.0s'; };

  elVid.addEventListener('timeupdate',()=>{
    if(!cues.length) return;
    const t = elVid.currentTime - offset;
    const i = cues.findIndex(c=> t>=c.start && t<(c.end??(c.start+10)));
    $$('#cuesTable tbody tr').forEach((tr,idx)=>{
      tr.classList.toggle('active', idx===i);
      if(idx===i && $('#chkFollow').checked){
        tr.scrollIntoView({block:'center',behavior:'smooth'});
      }
    });
    // loop 本句
    if(loop && i>=0){
      const start = cues[i].start||0;
      const end = (cues[i].end!=null)? cues[i].end : (cues[i+1]?.start ?? (start+3));
      if(t >= end - 0.02) elVid.currentTime = start + offset + 0.0001;
    }
  });

  /* ===== 載入資料（只走一條路徑） ===== */
  async function boot(){
    try{
      // 字幕
      const rawCues = await fetchJSON(`./data/${cat}/cues-${slug}.json`);
      cues = rawCues.map(x=>({start:+x.start||0,end:(x.end!=null?+x.end:undefined),en:x.en||'',zh:x.zh||''}));
      renderCues();
      $('#cuesInfo').textContent = `已載入字幕（${cat}/${slug}）`;
    }catch(err){
      $('#cuesInfo').textContent = 'cues 載入失敗或格式錯誤';
    }

    try{
      // 測驗
      const rawQuiz = await fetchJSON(`./data/${cat}/quiz-${slug}.json`);
      quizAll = Array.isArray(rawQuiz) ? rawQuiz.map(q=>({
        section: q.section || 'Mixed',
        question: q.question || q.q || '',
        options: q.options || q.choices || [],
        answer: q.answer ?? q.ans ?? '',
        explanation: q.explanation || ''
      })) : [];
      buildQTabs(); renderQuiz();
      $('#btnSubmit').onclick = submitQuiz;
      $('#btnShow').onclick = ()=> renderQuiz(true);
      $('#btnPrint').onclick = ()=> window.print();
    }catch(err){ /* 忽略 */ }

    try{
      // 單字
      const rawV = await fetchJSON(`./data/${cat}/vocab-${slug}.json`);
      renderVocab(rawV);
      $('#vocabInfo').textContent = `已載入單字（${rawV.length}）`;
    }catch(err){
      $('#vocabInfo').textContent = '沒有單字資料';
    }

    try{
      // AI
      ai = await fetchJSON(`./data/${cat}/ai-${slug}.json`);
      renderAI();
    }catch(err){
      $('#aiTopics').innerHTML = '<span class="badge">暫無 AI 資料</span>';
    }
  }

  // 啟動
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', boot, {once:true});
  }else{ boot(); }
})();
</script>
</body>
</html>
























































