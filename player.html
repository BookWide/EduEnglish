<!--  --><!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BookWide æ’­æ”¾å™¨ï¼ˆ4 åˆ†é  + æ¸¬é©—å››é¡ï¼‰</title>

<style>
:root{
  --bg:#0b1324;
  --panel:#0f172a;
  --border:#1f2a44;
  --ink:#e6f0ff;
  --muted:#9fb0c9;
  --accent:#3c7cff;
}
*{box-sizing:border-box;}
html,body{
  margin:0;
  height:100%;
  background:var(--bg);
  color:var(--ink);
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Noto Sans TC",sans-serif;
  overflow:hidden; /* æ¡Œæ©Ÿï¼šæ•´é ä¸è¦æ²ï¼Œç”±å³å´é¢æ¿è‡ªå·±æ²å‹• */
}
a{color:var(--accent);text-decoration:none;}

header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 18px;
  background:#0f172a;
  border-bottom:1px solid #0e203f;
}
header h1{margin:0;font-size:20px;}

.wrap{
  padding:14px;
  height:calc(100vh - 50px);
}
.layout{
  height:100%;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:14px;
  overflow:hidden;
}
.layout > *{min-height:0;} /* è®“å·¦å³å…©æ¬„å¯ä»¥å…§éƒ¨æ²å‹• */

.left,.right{
  min-width:0;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:12px;
}

/* å·¦å´å½±ç‰‡å€ */
.left{
  display:flex;
  flex-direction:column;
  padding:12px;
  position:sticky;
  top:0;
  align-self:flex-start;
}

.videoWrap{
  position:relative;
  width:100%;
  aspect-ratio:16/9;
  background:#000;
  border-radius:10px;
  overflow:hidden;
}
.videoWrap video{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  background:#000;
}

.controls{
  margin-top:10px;
  background:#0e2038;
  border:1px solid #183459;
  border-radius:12px;
  padding:10px;
}
.controls .row{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
  margin:4px 0;
}

.btn{
  background:#13233f;
  border:1px solid #24446f;
  border-radius:10px;
  padding:7px 12px;
  color:#fff;
  cursor:pointer;
  font-size:14px;
}
.btn.blue{background:#14335f;border-color:#2c5aa3;}
.btn.sm{padding:5px 10px;font-size:13px;border-radius:999px;}
.btn.sm.blue{background:#14335f;border-color:#2c5aa3;}
.muted{color:var(--muted);font-size:13px;}
.chip{
  display:inline-flex;
  align-items:center;
  gap:4px;
  padding:4px 8px;
  border-radius:999px;
  background:#111f38;
  border:1px solid #1c314f;
  font-size:13px;
}

/* å³å´å››åˆ†é æ•´é«”ï¼šå¯å…§éƒ¨æ²å‹• */
.right{
  display:flex;
  flex-direction:column;
  overflow:hidden;
  min-height:0;
}
.rightScroll{
  flex:1 1 auto;
  min-height:0;
  overflow-y:auto;
  position:relative;
  scrollbar-width:thin;
}
.rightScroll::-webkit-scrollbar{width:10px;}
.rightScroll::-webkit-scrollbar-thumb{
  background:#556a9a;
  border-radius:6px;
}

/* é ‚ç«¯é¸é …å¡ */
.tabs{
  display:flex;
  gap:8px;
  padding:6px 10px;
  margin:0;
  border-bottom:1px solid var(--border);
  position:sticky;
  top:0;
  z-index:20;
  background:var(--panel);
}
.tab{
  cursor:pointer;
  background:#122340;
  border:1px solid #1f375f;
  border-radius:12px;
  padding:8px 14px;
  font-weight:600;
  font-size:14px;
}
.tab.active{background:#154274;}

.pane{
  padding:0 0 12px;
  min-height:0;
}

/* å­—å¹• */
table{width:100%;border-collapse:collapse;}
th,td{
  padding:8px 10px;
  border-bottom:1px solid #162a48;
  vertical-align:top;
}
tbody tr{background:#0f1f34;}
tbody tr:nth-child(2n){background:#0d1a2b;}
tbody tr:hover{background:#0f2a4e;}
tr.active{background:#173a6e;}
.pro-group td,
.jp-group td{
  background:#0b1728;
  font-weight:600;
  color:var(--muted);
}
.pro-lesson,
.jp-lesson{
  cursor:pointer;
}
.pro-lesson.current,
.jp-lesson.current{
  background:#1d4ed8 !important;
}
.pro-lesson.current td,
.jp-lesson.current td{
  color:#fff;
}


.cues-table{table-layout:fixed;}
.cue-time{
  width:64px;
  min-width:64px;
  color:rgba(255,255,255,.75);
  font-family:ui-monospace,Consolas,monospace;
  white-space:nowrap;
}
.cue-en{line-height:1.6;word-break:break-word;position:relative;}
.zh-line,.ja-line{margin-top:4px;opacity:.96;}

/* å»æ‰å–‡å­ï¼Œåªç•™å·¦å´é«˜äº® */
tr.speaking::before{content:none!important;}
tr.speaking{
  box-shadow:inset 3px 0 0 0 rgba(60,124,255,.55)!important;
  background:rgba(60,124,255,.10)!important;
}

/* å­—å¹•è¡¨é ­ sticky */
#pane-sub thead th{
  position:sticky;
  top:44px;
  background:var(--panel);
  z-index:10;
}

/* æ¸¬é©—ï¼šå››é¡æŒ‰éˆ•åˆ— */
.quiz-cats{
  padding:8px 12px;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  border-bottom:1px solid #162a48;
}

/* AI å€å¡Š */
#pane-ai textarea{
  width:100%;
  resize:vertical;
  font-family:inherit;
  border-radius:8px;
  border:1px solid #223048;
  background:#050b18;
  color:var(--ink);
  padding:8px;
}
#aiReply{
  border:1px solid #223048;
  border-radius:10px;
  padding:10px;
  min-height:54px;
}

/* æ‰‹æ©Ÿï¼šå·¦å³å…©é  */
@media (max-width:860px) and (orientation:portrait){
  html,body{
    overflow:auto;              /* æ‰‹æ©Ÿï¼šæ¢å¾©æ•´é æ²å‹• */
    height:100%;
  }
  .wrap{
    height:auto;
  }
  .layout{
    height:auto;
  }
  .rightScroll{
    max-height:none;
    overflow-y:visible;         /* æ‰‹æ©Ÿç‰ˆå³å´ä¸å†ç¨ç«‹å·è»¸ï¼Œæ”¹æˆæ•´é æ²å‹• */
  }

  #track{
    display:flex;
    overflow-x:auto;
    overflow-y:hidden;
    scroll-snap-type:x mandatory;
  }
  .page{
    flex:0 0 100vw;
    max-width:100vw;
    height:calc(100vh - 50px);
    scroll-snap-align:start;
    overflow-y:auto;
  }
  .left,.right{
    width:100%;
    max-width:100%;
    border-radius:0;
    border-left:0;
    border-right:0;
  }
  #btnExitFocus{
    position:fixed;
    right:16px;
    bottom:16px;
    z-index:10020;
    padding:10px 14px;
    border:1px solid rgba(100,116,139,.5);
    background:#0f172a;
    color:#e6efff;
    border-radius:12px;
    display:none;
  }
  body.at-right #btnExitFocus{display:inline-flex;}
}

/* åˆ—å° */
@media print{
  header,.controls,.tabs,#btnExitFocus{display:none!important;}
  body{background:#fff;color:#000;}
  .left{display:none!important;}
  .right{border:none;}
}


/* æ¡Œæ©Ÿï¼šå³å´å…§å®¹å¯ç¨ç«‹æ²å‹•ï¼Œåº•éƒ¨å¤§ç´„èˆ‡å·¦å´é½Š */
@media (min-width: 861px){
  .rightScroll{
    max-height: calc(100vh - 90px); /*  */
    overflow-y: auto;
  }
}

/* === V12 print override based on V7 (2025-11-14) === */
@media print{
  /* 1) åªä¿ç•™å³å´å…§å®¹ï¼Œéš±è—æ¨™é ­èˆ‡å·¦å´å½±ç‰‡å€ */
  header,.controls,.tabs,#btnExitFocus{display:none!important;}
  html,body{
    height:auto!important;
    overflow:visible!important;
    background:#fff!important;
    color:#000!important;
  }
  .wrap,
  .layout{
    height:auto!important;
    min-height:0!important;
    display:block!important;
    overflow:visible!important;
  }
  #track{
    display:block!important;
    height:auto!important;
    overflow:visible!important;
  }
  #pageLeft,
  .left{
    display:none!important;
  }
  #pageRight{
    display:block!important;
    width:100%!important;
    height:auto!important;
    overflow:visible!important;
  }
  #pageRight .right{
    display:block!important;
    height:auto!important;
    max-width:100%!important;
    max-height:none!important;
    border:none!important;
    overflow:visible!important;
  }
  #pageRight .rightScroll{
    display:block!important;
    height:auto!important;
    max-height:none!important;
    overflow:visible!important;
    padding-bottom:0!important;
  }
}

.vocab-img-wrap img{
  width:120px;
  height:auto;
  border-radius:10px;
  display:block;
}

</style>

<!-- Supabase JSï¼ˆåªç”¨æ–¼ player å®ˆé–€ï¼Œä¸å½±éŸ¿å…¶å®ƒé é¢ï¼‰ -->
<!-- Supabase JSï¼ˆåªç”¨æ–¼ player å®ˆé–€ï¼Œä¸å½±éŸ¿å…¶å®ƒé é¢ï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // é€™è£¡åªå‘¼å«ä½ å…±ç”¨çš„ BW.startIdleLogoutï¼Œæ™‚é–“æ”¹æˆ 60 åˆ†é˜
  if (window.BW && typeof BW.startIdleLogout === 'function') {
    BW.startIdleLogout(60, '/login.html?timeout=1');
  }
</script>
<script>
  const SUPABASE_URL = 'https://jeajrwpmrgczimmrflxo.supabase.co';

  const SUPABASE_ANON_KEY =
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do';

  // æ ¹è·¯å¾‘ï¼šgithub.io åº•ä¸‹ç”¨ /EduEnglishï¼Œè‡ªè¨‚ç¶²åŸŸ (bookwide.net) ç”¨ç©ºå­—ä¸²
  const ROOT_BASE = (
    location.pathname.startsWith('/EduEnglish') ||
    location.hostname.includes('github.io')
  ) ? '/EduEnglish' : '';

  // åƒ…ä¾› player.html ä½¿ç”¨çš„ Supabase Client
  const playerSupa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  async function bwPlayerGetUser() {
    try {
      const { data, error } = await playerSupa.auth.getUser();
      if (error || !data || !data.user) return null;
      return data.user;
    } catch (err) {
      console.error('[player-auth] getUser error', err);
      return null;
    }
  }

  // æä¾›çµ¦èˆŠç¨‹å¼ä½¿ç”¨çš„å®ˆé–€ / å– user å‡½å¼
  async function ensureAuth(options = {}) {
    const redirect = options.redirect || (ROOT_BASE + '/index.html');
    const next =
      options.next || (location.pathname + location.search);

    const user = await bwPlayerGetUser();
    if (user) return user;

    const url =
      redirect +
      '?denied=signin&next=' +
      encodeURIComponent(next);
    window.location.href = url;
    return null;
  }

  async function getSessionUser() {
    return await bwPlayerGetUser();
  }

  async function supaGetUser() {
    return await bwPlayerGetUser();
  }
  BW.startIdleLogout(30, '/login.html?timeout=1');
</script>
</head>
<body>
<header>
  <h1>æ’­æ”¾å™¨</h1>
  <div style="display:flex;align-items:center;gap:10px">
    <button class="btn" id="btnEnIndex" type="button">EN æ–‡æ³•ç´¢å¼•</button>
    <button class="btn" id="btnJpIndex" type="button">JP æ–‡æ³•ç´¢å¼•</button>
    <a class="btn" id="homeLink" href="#">ğŸ  å›é¦–é </a>
    <span class="muted" id="userNameBadge"></span>
  </div>
</header>

<div class="wrap">
  <div id="track" class="layout">
    <!-- å·¦ï¼šå½±ç‰‡ -->
    <section class="page" id="pageLeft">
      <section class="left">
        <div class="videoWrap">
          <video id="player" playsinline controls></video>
        </div>
        <div class="controls">
          <div class="row">
            <button class="btn" id="btnPrev">â® ä¸Šä¸€å¥</button>
            <button class="btn" id="btnPlay">â–¶ï¸ æ’­æ”¾ / æš«åœ</button>
            <button class="btn" id="btnNext">â­ ä¸‹ä¸€å¥</button>
            <button class="btn" id="btnReplay">ğŸ” é‡è¤‡æœ¬å¥</button>
          </div>
          <div class="row">
            <label class="chip"><input id="chkFollow" type="checkbox" /> è·Ÿéš¨</label>
            <span class="chip">åç§» <span id="offsetVal">0.0s</span></span>
            <button class="btn" id="btnOffsetMinus">-0.5s</button>
            <button class="btn" id="btnOffsetPlus">+0.5s</button>
            <button class="btn" id="btnAutoSync">ğŸ§­ ç°¡æ˜“æ ¡æº–</button>
          </div>
          <div class="row" style="gap:10px">
            <span class="muted">é€Ÿåº¦</span>
            <input id="speedRange" type="range" min="0.5" max="2" step="0.05" value="1" />
            <span id="speedVal">1.00x</span>
          </div>
        </div>
      </section>
    </section>

    <!-- å³ï¼šå››åˆ†é ï¼ˆå¤–å±¤ right + å…§å±¤ rightScroll æœ‰æ²è»¸ï¼‰ -->
    <section class="page" id="pageRight">
      <section class="right">
        <div class="rightScroll" id="rightScroll">
          <div class="tabs">
            <div class="tab active" data-tab="sub">å­—å¹•</div>
            <div class="tab" data-tab="quiz">æ¸¬é©—</div>
            <div class="tab" data-tab="vocab">å–®å­—</div>
            <div class="tab" data-tab="ai">AIäº’å‹•</div>
          </div>

          <!-- å­—å¹• -->
          <div class="pane" id="pane-sub">
            <div class="muted" id="cuesStatus" style="padding:8px 12px">ï¼ˆå­—å¹•è¼‰å…¥ä¸­â€¦ï¼‰</div>
            <table class="cues-table">
              <thead>
              <tr><th style="width:80px">æ™‚é–“</th><th>è‹±æ–‡ / ä¸­æ–‡ / æ—¥æ–‡</th></tr>
              </thead>
              <tbody id="cuesBody"></tbody>
            </table>
          </div>

          <!-- æ¸¬é©—ï¼šå››é¡ + åˆ—å° -->
          <div class="pane" id="pane-quiz" style="display:none">
            <div id="quizCats" class="quiz-cats">
              <button class="btn sm blue" data-cat="all">å…¨éƒ¨</button>
              <button class="btn sm" data-cat="vocab">å–®å­—</button>
              <button class="btn sm" data-cat="grammar">æ–‡æ³•</button>
              <button class="btn sm" data-cat="reading">é–±è®€</button>
              <button class="btn sm" data-cat="mix">ç¶œåˆ</button>
            </div>
            <div class="muted" id="quizMeta" style="padding:6px 12px">ï¼ˆæ¸¬é©—è¼‰å…¥ä¸­â€¦ï¼‰</div>
            <ol id="quizList" style="line-height:1.6;padding:0 28px"></ol>
            <div class="q-actions" style="margin:12px 12px 4px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
              <button class="btn" id="btnSubmitQuiz">äº¤å·</button>
              <button class="btn" id="btnShowAnswer">é¡¯ç¤ºç­”æ¡ˆ</button>
              <button class="btn" id="btnPrint">åˆ—å°ç›®å‰é </button>
              <button class="btn" id="btnPrintAll">å®Œæ•´åˆ—å° 4 é¡</button>
              <span id="quizScore" style="margin-left:8px"></span>
            </div>
          </div>

          <!-- å–®å­— -->
          <div class="pane" id="pane-vocab" style="display:none">
            <div class="muted" id="vocabStatus" style="padding:8px 12px">( å–®å­—è¼‰å…¥ä¸­â€¦ )</div>
            <div id="vocabBox" style="padding:0 12px 12px;"></div>
          </div>

          <!-- AI äº’å‹• -->
          <div class="pane" id="pane-ai" style="display:none">
            <div style="padding:8px 12px">
              <div class="muted" style="margin-bottom:6px">
                ç¶²å€æ ¼å¼ï¼š<code>?cat=story|music|movie|news|pro|jp&slug=houyi</code>
              </div>
              <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:6px">
                <select id="aiTopic" class="btn" style="min-width:180px"></select>
                <button id="btnPrevTopic" class="btn sm">â—€ ä¸Šä¸€é¡Œ</button>
                <button id="btnNextTopic" class="btn sm">ä¸‹ä¸€é¡Œ â–¶</button>
                <button id="btnTts" class="btn sm">é¡Œç›®æœ—è®€</button>
                <button id="btnRec" class="btn sm">ğŸ™ï¸ é–‹å§‹èªª</button>
                <button id="btnStop" class="btn sm" disabled>â›” åœæ­¢</button>
                <label class="muted"><input id="aiAutoNext" type="checkbox" /> ä½œç­”å¾Œè‡ªå‹•ä¸‹ä¸€é¡Œ</label>
                <span id="aiProgress" class="muted">ç¬¬ 0/0 é¡Œ</span>
              </div>
              <textarea id="aiPrompt" rows="3" readonly placeholder="é¡Œç›®æœƒé¡¯ç¤ºåœ¨é€™è£¡â€¦"></textarea>
              <textarea id="aiAnswer" rows="3" placeholder="è«‹ç”¨è‹±æ–‡ä½œç­”ï¼Œæˆ–æŒ‰ã€Œé–‹å§‹èªªã€ç”¨èªªçš„ã€‚"></textarea>
              <div style="margin:8px 0 4px">
                <span class="muted">æç¤ºï¼š</span><span id="aiHint" class="muted">â€”</span>
              </div>
              <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:6px 0">
                <span class="muted">AI ç¤ºç¯„ï¼š</span>
                <button id="aiDemoEn" class="btn sm">è‹±</button>
                <button id="aiDemoZh" class="btn sm">ä¸­</button>
                <button id="aiDemoJa" class="btn sm">æ—¥</button>
                <button id="aiDemoTts" class="btn sm">æœ—è®€ç›®å‰</button>
              </div>
              <div id="aiReply">(ç­‰å¾…ä½ çš„ä½œç­”â€¦)</div>
            </div>
          </div>
        </div>
      </section>
    </section>
  </div>
</div>

<button id="btnExitFocus" class="btn">è¿”å›å½±ç‰‡</button>

<script>
const $=(s,e=document)=>e.querySelector(s);
const $$=(s,e=document)=>[...e.querySelectorAll(s)];
const toSec=t=>{
  if(typeof t==='number')return t;
  const p=String(t).split(':').map(Number);
  if(p.length===3)return p[0]*3600+p[1]*60+p[2];
  if(p.length===2)return p[0]*60+p[1];
  return Number(t)||0;
};
const fmt=sec=>{
  sec=Math.max(0,sec|0);
  const m=(sec/60)|0,s=sec%60;
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
};
const esc=s=>String(s??'')
  .replaceAll('&','&amp;').replaceAll('<','&lt;')
  .replaceAll('>','&gt;').replaceAll('"','&quot;');

const params=new URLSearchParams(location.search);
const paramBase=params.get('base');
// BASEï¼šè‹¥ç¶²å€å¸¶ ?base= å‰‡å„ªå…ˆï¼Œå…¶æ¬¡ä¾ ROOT_BASEï¼ˆ/EduEnglish æˆ–ç©ºå­—ä¸²ï¼‰
const BASE = (paramBase!=null ? paramBase : ROOT_BASE);
const cat =(params.get('cat')||'story').toLowerCase();
let slug=params.get('slug')||'houyi';
if(slug==='huyi') slug='houyi';
const vnow=Date.now();

// è¨­å®šå›é¦–é é€£çµ
const homeLink = document.getElementById('homeLink');
if(homeLink){
  homeLink.href = (ROOT_BASE || '') + '/index.html';
}

const btnEnIndex = document.getElementById('btnEnIndex');
const btnJpIndex = document.getElementById('btnJpIndex');

// åªåœ¨æ–‡æ³•é¡åˆ¥ï¼ˆpro / jpï¼‰é¡¯ç¤º EN / JP å…©é¡†æŒ‰éˆ•
if(btnEnIndex){
  if(cat==='pro' || cat==='jp'){
    btnEnIndex.style.display='inline-flex';
  }else{
    btnEnIndex.style.display='none';
  }
}
if(btnJpIndex){
  if(cat==='pro' || cat==='jp'){
    btnJpIndex.style.display='inline-flex';
  }else{
    btnJpIndex.style.display='none';
  }
}

// EN æ–‡æ³•ç´¢å¼•ï¼šåˆ‡å›è‹±æ–‡ Grammarï¼ˆcat=proï¼‰
if(btnEnIndex){
  btnEnIndex.addEventListener('click',()=>{
    const baseParam=paramBase?`&base=${encodeURIComponent(paramBase)}`:'';
    location.href=`player.html?cat=pro&slug=${encodeURIComponent(slug)}${baseParam}`;
  });
}

// JP æ–‡æ³•ç´¢å¼•ï¼šåˆ‡æ›åˆ°æ—¥æ–‡ Grammarï¼ˆcat=jpï¼‰
if(btnJpIndex){
  btnJpIndex.addEventListener('click',()=>{
    const baseParam=paramBase?`&base=${encodeURIComponent(paramBase)}`:'';
    location.href=`player.html?cat=jp&slug=${encodeURIComponent(slug)}${baseParam}`;
  });
}


/* å½±ç‰‡ & æ§åˆ¶ */
const video=$('#player');
const cuesBody=$('#cuesBody');
const cuesStatus=$('#cuesStatus');
const btnPrev=$('#btnPrev'),btnPlay=$('#btnPlay'),
      btnNext=$('#btnNext'),btnReplay=$('#btnReplay');
const btnOffsetMinus=$('#btnOffsetMinus'),btnOffsetPlus=$('#btnOffsetPlus'),
      offsetVal=$('#offsetVal');
const chkFollow=$('#chkFollow');
const speedRange=$('#speedRange'),speedVal=$('#speedVal');

const paneSub=$('#pane-sub'),paneQuiz=$('#pane-quiz'),
      paneVocab=$('#pane-vocab'),paneAI=$('#pane-ai');

let cues=[],offset=0,loopSentence=false;// PRO èª²ç¨‹ï¼šslug å°æ‡‰ groupId / Level çš„å¿«å–ï¼ˆæœªä¾†å®ˆé–€ç”¨ï¼‰
const proSlugToGroupId = {};
function levelOfGroupId(groupId){
  if(!groupId) return 1;
  if(groupId.startsWith('L1')) return 1; // L1A / L1B
  if(groupId.startsWith('L2')) return 2; // L2A / L2B
  return 3; // å…¶é¤˜ L3-* è¦–ç‚º Level 3
}
// TODO: æœªä¾†è‹¥è¦ä¾è¨‚é–±ç­‰ç´šå®ˆé–€ï¼Œå¯åœ¨é€™è£¡åŠ å…¥ userMaxLevel åˆ¤æ–·ã€‚
let quizData=[],currentQuizCat='all';

function setOffset(v){
  offset=Number(v)||0;
  offsetVal.textContent=`${offset.toFixed(1)}s`;
  localStorage.setItem(`offset:${slug}`,String(offset));
}
window.player={setOffset,clearRepeat:()=>{loopSentence=false;btnReplay?.classList.remove('blue');}};

async function loadVideo(){
  const SUPA_PUBLIC_BASE = 'https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public';
  const SUPA_VIDEOS_BASE = SUPA_PUBLIC_BASE + '/videos';

  const sources = [];
  const seen = new Set();

  function add(url){
    if (!url || seen.has(url)) return;
    seen.add(url);
    sources.push(url);
  }

  // åŸºæœ¬ slug
  const slugMain = slug;
  const slugNoPro = slug.replace(/^pro-/, '');   // ä¾‹å¦‚ï¼špro-l1a-06-... â†’ l1a-06-...
  const slugCandidates = [slugMain];

  if (cat === 'pro' && slugNoPro !== slugMain) {
    slugCandidates.push(slugNoPro);
  }

  // ä¾åºæŠŠæ‰€æœ‰å¯èƒ½è·¯å¾‘åŠ å…¥ sources
  slugCandidates.forEach(s => {
    // Supabaseï¼šæœ‰åˆ†é¡ã€ç„¡åˆ†é¡å…©ç¨®éƒ½è©¦
    add(`${SUPA_VIDEOS_BASE}/${cat}/${s}.mp4`);
    add(`${SUPA_VIDEOS_BASE}/${s}.mp4`);

    // æœ¬ç«™ï¼šæœ‰åˆ†é¡ã€ç„¡åˆ†é¡
    add(`${BASE}/videos/${cat}/${s}.mp4`);
    add(`${BASE}/videos/${s}.mp4`);
  });

  // åªæœ‰é PRO é¡åˆ¥æ‰ç”¨ houyi ç•¶æœ€å¾Œå‚™æ´
  if (cat !== 'pro') {
    add(`${BASE}/videos/story/houyi.mp4`);
  }

  let i = 0;
  function setSrc(k){
    if (!sources[k]) return;
    video.src = sources[k];
    console.log('[Player] try video source', (k+1) + '/' + sources.length, sources[k]);
  }

  if (!sources.length) {
    console.warn('[Player] æ²’æœ‰ä»»ä½•å½±ç‰‡ä¾†æºå¯è©¦');
    return;
  }

  setSrc(0);

  video.addEventListener('error', () => {
    if (i < sources.length - 1) {
      i++;
      setSrc(i);
    } else {
      console.warn('[Player] æ‰€æœ‰å½±ç‰‡ä¾†æºéƒ½å¤±æ•—äº†');
    }
  }, { passive: true });
}


/* ==== å­—å¹• ==== */
async function loadCues(){
  // PRO æ¨¡å¼ï¼šå­—å¹•åˆ†é æ”¹ç‚ºé¡¯ç¤º PRO èª²ç¨‹ç« ç¯€æ¸…å–®ï¼ˆç”± index-pro.json æä¾›ï¼‰
  if(cat==='pro'){
    return loadProOutline();
  }

  // JP æ¨¡å¼ï¼šå­—å¹•åˆ†é æ”¹ç‚ºé¡¯ç¤ºæ—¥æ–‡æ–‡æ³•ç´¢å¼•ï¼ˆç”± index-jp.json æä¾›ï¼‰
  if(cat==='jp'){
    return loadJpOutline();
  }

  cuesStatus.textContent='ï¼ˆå­—å¹•è¼‰å…¥ä¸­â€¦ï¼‰';
  const url=`${BASE}/data/${cat}/${slug}/cues-${slug}.json?v=${vnow}`;
  try{
    const r=await fetch(url,{cache:'no-store'});
    if(!r.ok) throw 0;
    const data=await r.json();
    cues=(Array.isArray(data)?data:(data.cues||[]))
      .map(x=>({t:toSec(x.time),en:x.en||'',zh:x.zh||'',ja:x.ja||'',source_url:x.source_url||''}));
    cuesBody.innerHTML=cues.map((c,i)=>`
      <tr data-i="${i}" style="position:relative">
        <td class="cue-time">${c.t?fmt(c.t):''}</td>
        <td class="cue-en">
          <span class="en-line">${esc(c.en)}</span>
          ${c.zh?`<div class="zh-line">${esc(c.zh)}</div>`:''}
          ${c.ja?`<div class="ja-line">${esc(c.ja)}</div>`:''}
        </td>
      </tr>`).join('');

    // è®€å‡ºä¾†æºç¶²å€ï¼ˆè‹¥æœ‰ï¼‰
    let srcUrl='';
    if(Array.isArray(data) && data.length && data[0].source_url){
      srcUrl=data[0].source_url;
    }else if(!Array.isArray(data) && data && data.source_url){
      srcUrl=data.source_url;
    }

    if(srcUrl){
      const safe=esc(srcUrl);
      cuesStatus.innerHTML=`ï¼ˆjson å·²è¼‰å…¥ï¼‰ï½œ å½±ç‰‡ä¾†æºï¼š<a href="${safe}" target="_blank" rel="noopener">YouTube åŸå§‹å½±ç‰‡</a>`;
    }else{
      cuesStatus.textContent='ï¼ˆjson å·²è¼‰å…¥ï¼‰';
    }
  }catch(e){
    console.warn(e);
    cuesStatus.textContent='âš ï¸ å­—å¹•è®€å–å¤±æ•—ï¼š'+url;
  }

  cuesBody.addEventListener('click',e=>{
    const tr=e.target.closest('tr'); if(!tr)return;
    const i=+tr.dataset.i;

    // é»æ™‚é–“å€å¡Šï¼šè·Ÿéš¨ + å½±ç‰‡è·³è½‰
    if(e.target.closest('.cue-time')){
      seekTo(i,true);
      return;
    }

    // é»æ–‡å­—ï¼šåªç”¨ç€è¦½å™¨ TTS
    let lang='en-US',text='';
    if(e.target.closest('.ja-line')){lang='ja-JP';text=e.target.closest('.ja-line').textContent.trim();}
    else if(e.target.closest('.zh-line')){lang='zh-TW';text=e.target.closest('.zh-line').textContent.trim();}
    else{lang='en-US';text=(tr.querySelector('.en-line')?.textContent||'').trim();}
    if(!text) return;
    speakText(text,lang);
    highlightRow(i,true);
  },true);
}

/* ==== æ¸¬é©—ï¼ˆå››é¡ + åˆ—å°ï¼‰ ==== */
async function loadQuiz(){
  const meta=$('#quizMeta');
  const url=`${BASE}/data/${cat}/${slug}/quiz-${slug}.json?v=${vnow}`;
  try{
    const r=await fetch(url,{cache:'no-store'});
    if(!r.ok) throw 0;
    const raw=await r.json();
    const arr=Array.isArray(raw)?raw:(raw.questions||raw.data||[]);
    const cats=['vocab','grammar','reading','mix'];

    quizData=arr.map((q,idx)=>{
      const fromData=q.category||q.cat;
      let catKey=fromData||cats[Math.min(3,Math.floor(idx/(arr.length/4||1)))];
      return {...q,_cat:catKey};
    });

    meta.textContent=`å·²è¼‰å…¥ï¼š${url}`;
    renderQuiz('all');
    setupQuizButtons();
  }catch(e){
    console.warn(e);
    meta.textContent='âŒ é¡Œåº«è®€å–å¤±æ•—ï¼š'+url;
  }
}

function renderQuiz(cat){
  if(!quizData.length) return;
  currentQuizCat = cat;
  const labelMap = {all:'å…¨éƒ¨',vocab:'å–®å­—',grammar:'æ–‡æ³•',reading:'é–±è®€',mix:'ç¶œåˆ'};
  const list = (cat === 'all') ? quizData : quizData.filter(q => q._cat === cat);
  const ol = $('#quizList');

  ol.innerHTML = list.map((q, idx) => {
    const question = q.question || q.q || q.question_en || '';
    const options  = q.options || q.choices || [];
    const answerRaw = String(q.answer ?? '').trim();
    const ansEn  = (q.answer_en  || '').trim();
    const ansZh  = (q.answer_zh  || '').trim();
    const ansJa  = (q.answer_ja  || '').trim();
    const explainZh = q.explanation_zh || q.explain_zh || q.explanation || '';
    const letters = ['A','B','C','D','E','F'];

    // ä¾ç…§ answer + options æ¨å°æ­£ç¢ºé¸é …ï¼ˆå­—æ¯ + æ–‡å­—ï¼‰
    const norm = (s) => String(s || '').trim().toLowerCase();
    const hasOptions = Array.isArray(options) && options.length > 0;
    let correctLetter = '';
    let correctText   = '';

    if (answerRaw){
      // 1) ç›´æ¥æ˜¯ A~F
      if (/^[A-F]$/i.test(answerRaw)){
        correctLetter = answerRaw.toUpperCase();
        const idx = letters.indexOf(correctLetter);
        if (idx >= 0 && options[idx]){
          const opt = options[idx];
          correctText = (typeof opt === 'string') ? opt : (opt.text || '');
        }
      } else {
        // 2) æ•¸å­— 1~6 â†’ A~F
        const num = parseInt(answerRaw, 10);
        if (!Number.isNaN(num) && num >= 1 && num <= letters.length){
          const idx = num - 1;
          correctLetter = letters[idx];
          const opt = options[idx];
          if (opt) correctText = (typeof opt === 'string') ? opt : (opt.text || '');
        } else if (hasOptions){
          // 3) æ–‡å­— â†’ å¾ options æ¯”å°é–‹é ­æˆ–å®Œæ•´å­—ä¸²
          const target = norm(answerRaw);
          const optIndex = options.findIndex(opt => {
            const text = (typeof opt === 'string') ? opt : (opt.text || '');
            const t = norm(text);
            if (!t) return false;
            return t === target || t.startsWith(target) || t.includes(' ' + target + ' ') || t.endsWith(' ' + target);
          });
          if (optIndex >= 0){
            correctLetter = letters[optIndex] || String.fromCharCode(65 + optIndex);
            const opt = options[optIndex];
            correctText = (typeof opt === 'string') ? opt : (opt.text || '');
          }
        }
      }
    }

    // ç­”æ¡ˆä¸‰èªé¡¯ç¤ºï¼šå„ªå…ˆä½¿ç”¨ answer_en/zh/jaï¼Œè‹¥éƒ½æ²’æœ‰å‰‡é€€å›æ­£ç¢ºé¸é …æ–‡å­—
    const ansParts = [];
    if (ansEn) ansParts.push(esc(ansEn));
    if (ansZh) ansParts.push(esc(ansZh));
    if (ansJa) ansParts.push(esc(ansJa));
    if (!ansParts.length && correctText){
      ansParts.push(esc(correctText));
    }
    const ansDetail = ansParts.length ? 'ï¼ˆ' + ansParts.join(' / ') + 'ï¼‰' : '';

    const ttsBtns = [];
    if (ansEn){
      ttsBtns.push(`<button type="button" class="btn-xs" data-tts="${esc(ansEn)}" data-lang="en-US" style="margin-left:4px;padding:1px 6px;border-radius:999px;border:1px solid #475569;background:#0f172a;color:#e5e7eb;font-size:11px;">ENğŸ”Š</button>`);
    }
    if (ansZh){
      ttsBtns.push(`<button type="button" class="btn-xs" data-tts="${esc(ansZh)}" data-lang="zh-TW" style="margin-left:4px;padding:1px 6px;border-radius:999px;border:1px solid #475569;background:#0f172a;color:#e5e7eb;font-size:11px;">ä¸­ğŸ”Š</button>`);
    }
    if (ansJa){
      ttsBtns.push(`<button type="button" class="btn-xs" data-tts="${esc(ansJa)}" data-lang="ja-JP" style="margin-left:4px;padding:1px 6px;border-radius:999px;border:1px solid #475569;background:#0f172a;color:#e5e7eb;font-size:11px;">æ—¥ğŸ”Š</button>`);
    }
    const ttsHtml = ttsBtns.length ? `<span>${ttsBtns.join('')}</span>` : '';

    return `<li style="margin-bottom:16px;padding:12px 12px 10px;border-radius:12px;border:1px solid #1f2937;background:#020617;">
      <div style="font-size:13px;color:#9ca3af;margin-bottom:6px;">ç¬¬ ${idx+1} é¡Œ Â· ${labelMap[q._cat] || 'é¡Œç›®'} Â· [${esc(q.type || 'å–®å­—')}]</div>
      <div style="margin-bottom:8px;font-weight:600;">${esc(question)}</div>
      <div>
        ${options.map((opt,i)=>{
          const letter = letters[i] || String.fromCharCode(65+i);
          const optText = (typeof opt==='string') ? opt : opt.text || '';
          return `<label style="display:flex;align-items:flex-start;gap:6px;margin:3px 0;cursor:pointer;">
            <input type="radio" name="q${idx}" value="${letter}" style="margin-top:4px;">
            <span><span style="font-weight:600;">${letter}.</span> ${esc(optText)}</span>
          </label>`;
        }).join('')}
      </div>
      <div class="ans muted" data-ans="${esc(answerRaw)}" data-ans-letter="${esc(correctLetter)}" style="display:none;margin-top:8px;font-size:13px;color:#e5e7eb;border-top:1px dashed #334155;padding-top:6px;">
        <div>
          ç­”æ¡ˆï¼š${hasOptions ? esc(correctLetter || '?') : ''}${ansDetail ? (hasOptions ? ' ' + ansDetail : ansDetail) : '' }${ttsHtml}
        </div>
        ${explainZh ? `<div style="margin-top:4px;color:#c4d4f7;line-height:1.5;">${esc(explainZh)}</div>` : ''}
      </div>
    </li>`;
  }).join('');

  $('#quizMeta').textContent = `ç›®å‰é¡¯ç¤ºï¼š${labelMap[cat] || 'å…¨éƒ¨'}ï¼Œå…± ${list.length} é¡Œã€‚`;
}

function setupQuizButtons(){
  if (setupQuizButtons._done) return;
  setupQuizButtons._done = true;

  const catsRow = $('#quizCats');

  if (catsRow){
    catsRow.addEventListener('click', e => {
      const btn = e.target.closest('[data-cat]');
      if (!btn) return;
      const cat = btn.dataset.cat;
      $$('#quizCats .btn').forEach(b => b.classList.toggle('blue', b === btn));
      renderQuiz(cat);
    });
  }

  // ç­”æ¡ˆæœ—è®€ï¼ˆEN / ä¸­ / æ—¥ï¼‰
  const quizList = $('#quizList');
  if (quizList){
    quizList.addEventListener('click', e => {
      const btn = e.target.closest('[data-tts]');
      if (!btn) return;
      const text = btn.dataset.tts || '';
      const lang = btn.dataset.lang || 'en-US';
      if (text && typeof speakText === 'function'){
        speakText(text, lang);
      }
    });
  }

  $('#btnShowAnswer').onclick = () => {
    $$('#quizList .ans').forEach(a => a.style.display = 'block');
  };

  $('#btnSubmitQuiz').onclick = async () => {
    const lis = $$('#quizList > li');
    let s = 0, t = 0;
    lis.forEach(li => {
      const ansEl = li.querySelector('.ans');
      if (!ansEl) return;
      const letter = (ansEl.dataset.ansLetter || '').trim();
      const chosen = ([...li.querySelectorAll('input[type=radio]')]
        .find(r => r.checked)?.value || '').trim();
      if (!letter || !chosen) return;
      t++;
      if (letter.toLowerCase() === chosen.toLowerCase()) s++;
    });
    $('#quizScore').textContent = `å¾—åˆ†ï¼š${s} / ${t}`;

    // å¯«å…¥ quiz_logsï¼ˆä¾›å­¸ç¿’æ§åˆ¶å°çµ±è¨ˆï¼‰
    if (t > 0 && typeof playerSupa !== 'undefined' && typeof bwPlayerGetUser === 'function'){
      try{
        const user = await bwPlayerGetUser();
        if (user && user.email){
          await playerSupa
            .from('quiz_logs')
            .insert({
              email: user.email,
              slug,
              category: 'all',
              score: s
            });
        }
      }catch(err){
        console.error('[quiz_logs] save error', err);
      }
    }
  };

  $('#btnPrint').onclick = () => {
    if (typeof showTab === 'function') showTab('quiz');
    setTimeout(() => window.print(), 50);
  };

  $('#btnPrintAll').onclick = () => {
    const prev = currentQuizCat;
    renderQuiz('all');
    window.print();
    const targetBtn = $(`#quizCats [data-cat="${prev}"]`);
    $$('#quizCats .btn').forEach(b => b.classList.toggle('blue', b === targetBtn));
    renderQuiz(prev);
  };
}

/* ==== å–®å­— ==== */
async function loadVocab(){
  const vStatus = $('#vocabStatus'), vBox = $('#vocabBox');
  const url = `${BASE}/data/${cat}/${slug}/vocab-${slug}.json?v=${vnow}`;

  try{
    const r = await fetch(url,{cache:'no-store'});
    if(!r.ok) throw 0;
    const list = await r.json();

    if(!list?.length){
      vStatus.textContent = 'âš ï¸ æŸ¥ç„¡å–®å­—è³‡æ–™';
      vBox.innerHTML = '';
      return;
    }

    vStatus.textContent = `å·²è¼‰å…¥ï¼š${url}`;

    vBox.innerHTML = list.map(v=>{
      const zh   = v.zh || '';
      const en   = v.en || '';
      const ja   = v.ja || v.ja_def || '';
      const enEx = v.en_example || '';
      const zhEx = v.zh_example || '';
      const jaEx = v.ja_example || '';
      const img  = v.img || '';

      const hasExample = enEx || zhEx || jaEx;
      const imgHtml = img ? `
        <div class="vocab-img-wrap" style="margin:6px 0 10px;">
          <img src="${esc(img)}" alt="${esc(v.word||'')}" class="vocab-img" style="max-width:100%;border-radius:10px;display:block;">
        </div>` : '';

      return `
      <div style="border:1px solid #223048;border-radius:10px;padding:10px 12px;margin:10px 0">
        <div style="display:flex;justify-content:space-between;align-items:baseline;gap:8px;margin-bottom:4px;">
          <div style="font-weight:800;font-size:18px;">${esc(v.word||'')}</div>
          ${v.pos ? `<div style="font-size:12px;color:#9fb0c9;">${esc(v.pos)}</div>` : ''}
        </div>

        ${en ? `
        <div style="margin:2px 0;">
          <span style="font-size:13px;color:#9fb0c9;">ã€è‹±ã€‘</span>
          <span>${esc(en)}</span>
          <button class="btn sm" data-act="speak" data-lang="en-US" data-text="${esc(en)}" style="margin-left:6px;">ğŸ”Š</button>
        </div>` : ''}

        ${zh ? `
        <div style="margin:2px 0;">
          <span style="font-size:13px;color:#9fb0c9;">ã€ä¸­ã€‘</span>
          <span>${esc(zh)}</span>
          <button class="btn sm" data-act="speak" data-lang="zh-TW" data-text="${esc(zh)}" style="margin-left:6px;">ğŸ”Š</button>
        </div>` : ''}

        ${ja ? `
        <div style="margin:2px 0;">
          <span style="font-size:13px;color:#9fb0c9;">ã€æ—¥ã€‘</span>
          <span>${esc(ja)}</span>
          <button class="btn sm" data-act="speak" data-lang="ja-JP" data-text="${esc(ja)}" style="margin-left:6px;">ğŸ”Š</button>
        </div>` : ''}

        ${hasExample ? `
        <div style="margin-top:6px;padding-top:6px;border-top:1px dashed #223048;font-size:13px;">
          <div style="font-size:12px;color:#9fb0c9;margin-bottom:2px;">ä¾‹å¥ Example</div>

          ${enEx ? `
          <div style="margin:2px 0;">
            <span style="color:#9fb0c9;">ENï¼š</span>
            <span>${esc(enEx)}</span>
            <button class="btn sm" data-act="speak" data-lang="en-US" data-text="${esc(enEx)}" style="margin-left:6px;">ğŸ”Š</button>
          </div>` : ''}

          ${zhEx ? `
          <div style="margin:2px 0;">
            <span style="color:#9fb0c9;">ä¸­ï¼š</span>
            <span>${esc(zhEx)}</span>
            <button class="btn sm" data-act="speak" data-lang="zh-TW" data-text="${esc(zhEx)}" style="margin-left:6px;">ğŸ”Š</button>
          </div>` : ''}

          ${jaEx ? `
          <div style="margin:2px 0;">
            <span style="color:#9fb0c9;">æ—¥ï¼š</span>
            <span>${esc(jaEx)}</span>
            <button class="btn sm" data-act="speak" data-lang="ja-JP" data-text="${esc(jaEx)}" style="margin-left:6px;">ğŸ”Š</button>
          </div>` : ''}
        </div>` : ''}

        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
          ${v.time ? `<button class="btn sm" data-act="jump" data-time="${esc(v.time)}">è·³åˆ°ç‰‡æ®µ</button>` : ''}
        </div>
      </div>`;
    }).join('');

    vBox.addEventListener('click',e=>{
      const act = e.target?.dataset?.act;
      if(!act) return;

      if(act === 'jump'){
        const p = toSec(e.target.dataset.time || 0);
        video.currentTime = Math.max(0,p);
        video.play();
      }

      if(act === 'speak'){
        speakText(e.target.dataset.text || '', e.target.dataset.lang || 'en-US');
      }
    });
  }catch(e){
    console.warn(e);
    vStatus.textContent = 'âš ï¸ è®€å–å¤±æ•—ï¼š' + url;
  }
}


/* ==== AIï¼ˆä¸‰èªç¤ºç¯„ + å°æ‡‰æœ—è®€ï¼‰ ==== */
async function loadAI(){
  const url=`${BASE}/data/${cat}/${slug}/ai-${slug}.json?v=${vnow}`;
  try{
    const r=await fetch(url,{cache:'no-store'});
    if(!r.ok) throw 0;
    const data=await r.json();
    const topics=Array.isArray(data)?data:(data.topics||[]);
    const sel=$('#aiTopic');
    sel.innerHTML=topics.map((t,i)=>`
      <option value="${i}">${esc(t.title||t.q||('é¡Œç›®'+(i+1)))}</option>`).join('');
    const prompt=$('#aiPrompt'),hint=$('#aiHint'),reply=$('#aiReply');
    const total=topics.length;let idx=0;
    let currentLang='en';

    function getSamples(t){
      const jaObj=(t.ja && typeof t.ja==='object')?t.ja:null;
      const zhObj=(t.zh && typeof t.zh==='object')?t.zh:null;
      const enObj=(t.en && typeof t.en==='object')?t.en:null;

      const sampleEn=t.sample_en || t.sampleEn ||
        (enObj && (enObj.sample || enObj.reply)) ||
        (typeof t.en==='string'?t.en:'') ||
        t.sample || t.demo || '';

      const sampleZh=t.sample_zh || t.sampleZh ||
        (zhObj && (zhObj.sample || zhObj.reply)) ||
        (typeof t.zh==='string'?t.zh:'') ||
        t.cn || '';

      const sampleJa=t.sample_ja || t.sampleJa ||
        (jaObj && (jaObj.sample || jaObj.reply)) ||
        (typeof t.ja==='string'?t.ja:'') || '';

      return {sampleEn,sampleZh,sampleJa};
    }

    function setReplyByLang(t,lang){
      const {sampleEn,sampleZh,sampleJa}=getSamples(t);
      let text='';
      if(lang==='zh') text=sampleZh||sampleEn||sampleJa;
      else if(lang==='ja') text=sampleJa||sampleEn||sampleZh;
      else text=sampleEn||sampleZh||sampleJa;
      reply.textContent=text||'(å°šç„¡ç¤ºç¯„å¥)';
    }

    function render(){
      const t=topics[idx]||{};
      prompt.value=t.prompt||t.q||'';
      hint.textContent=t.hint||'';
      setReplyByLang(t,currentLang);
      $('#aiProgress').textContent=`ç¬¬ ${idx+1}/${total} é¡Œ`;
      sel.value=String(idx);
    }
    if(total) render();

    sel.onchange=()=>{idx=+sel.value|0;render();};
    $('#btnPrevTopic').onclick=()=>{idx=(idx-1+total)%total;render();};
    $('#btnNextTopic').onclick=()=>{idx=(idx+1)%total;render();};
    $('#btnTts').onclick=()=>speakText(prompt.value,'en-US');

    $('#aiDemoEn').onclick=()=>{currentLang='en';render();};
    $('#aiDemoZh').onclick=()=>{currentLang='zh';render();};
    $('#aiDemoJa').onclick=()=>{currentLang='ja';render();};

    $('#aiDemoTts').onclick=()=>{
      const t=topics[idx]||{};
      const {sampleEn,sampleZh,sampleJa}=getSamples(t);
      let text='',langCode='en-US';
      if(currentLang==='zh'){text=sampleZh||sampleEn||sampleJa;langCode='zh-TW';}
      else if(currentLang==='ja'){text=sampleJa||sampleEn||sampleZh;langCode='ja-JP';}
      else {text=sampleEn||sampleZh||sampleJa;langCode='en-US';}
      if(text) speakText(text,langCode);
    };

  }catch(e){console.warn(e);}
}


/* ==== AI èªéŸ³ä½œç­”ï¼ˆç€è¦½å™¨èªéŸ³è¾¨è­˜ï¼‰ ==== */
(function(){
  const btnRec = $('#btnRec');
  const btnStop = $('#btnStop');
  const ansEl = $('#aiAnswer');
  if(!btnRec || !btnStop || !ansEl) return;

  let recognition = null;

  function getSR(){
    return window.SpeechRecognition || window.webkitSpeechRecognition || null;
  }

  btnRec.addEventListener('click', () => {
    const SR = getSR();
    if(!SR){
      alert('æ­¤ç€è¦½å™¨æš«ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼Œè«‹ç›´æ¥åœ¨ä¸‹æ–¹è¼¸å…¥ç­”æ¡ˆã€‚');
      return;
    }
    if(recognition) recognition.stop();
    recognition = new SR();
    recognition.lang = 'en-US';
    recognition.interimResults = true;
    recognition.continuous = true;

    ansEl.value = '';
    btnRec.disabled = true;
    btnStop.disabled = false;

    recognition.onresult = (e) => {
      let text = '';
      for(let i = 0; i < e.results.length; i++){
        text += e.results[i][0].transcript + (e.results[i].isFinal ? ' ' : ' ');
      }
      ansEl.value = text.trim();
    };
    const reset = () => {
      btnRec.disabled = false;
      btnStop.disabled = true;
    };
    recognition.onerror = reset;
    recognition.onend = reset;

    recognition.start();
  });

  btnStop.addEventListener('click', () => {
    if(recognition){
      recognition.stop();
    }
  });
})();
/* ==== å››å€‹ tab åˆ‡æ› + æ‰‹æ©Ÿå³é  focus ==== */
function showTab(name){
  paneSub.style.display=(name==='sub')?'':'none';
  paneQuiz.style.display=(name==='quiz')?'':'none';
  paneVocab.style.display=(name==='vocab')?'':'none';
  paneAI.style.display =(name==='ai')?'':'none';
  $$('.tabs .tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===name));

  if(name!=='sub' && window.matchMedia('(max-width:860px) and (orientation:portrait)').matches){
    const track=$('#track');
    track.scrollTo({left:track.clientWidth,behavior:'smooth'});
    document.body.classList.add('at-right');
  }
}
$$('.tabs .tab').forEach(t=>t.addEventListener('click',()=>showTab(t.dataset.tab)));

(function(){
  const track=$('#track'),btnExit=$('#btnExitFocus');
  function toLeft(){
    if(!track)return;
    track.scrollTo({left:0,behavior:'smooth'});
    document.body.classList.remove('at-right');
  }
  btnExit?.addEventListener('click',toLeft);
  track?.addEventListener('scroll',()=>{
    if(!track)return;
    const atRight=track.scrollLeft>(track.clientWidth/2);
    document.body.classList.toggle('at-right',atRight);
  },{passive:true});
})();

/* ==== æ’­æ”¾æ§åˆ¶ + è·Ÿéš¨å¥å­ ==== */
speedRange.addEventListener('input',()=>{
  const r=Number(speedRange.value)||1;
  video.playbackRate=r;
  speedVal.textContent=`${r.toFixed(2)}x`;
});
btnPlay.addEventListener('click',()=>{
  if(video.paused) video.play();
  else video.pause();
});

function currentIndex(){
  const t=video.currentTime+offset;
  let i=0;while(i+1<cues.length && cues[i+1].t<=t+0.0001)i++;
  return i;
}
function highlightRow(idx){
  const trs=$$('#cuesBody tr');
  trs.forEach(tr=>tr.classList.remove('active','speaking'));
  const tr=trs[idx];if(!tr) return;
  tr.classList.add('active','speaking');
  const container=$('#rightScroll');
  if(container){
    const rect=tr.getBoundingClientRect();
    const crect=container.getBoundingClientRect();
    if(rect.top<crect.top || rect.bottom>crect.bottom){
      const targetTop=tr.offsetTop-container.clientHeight/2+tr.offsetHeight/2;
      container.scrollTo({top:Math.max(0,targetTop),behavior:'smooth'});
    }
  }
}
function sentenceRange(i){
  if(!cues[i])return[0,0];
  const s=cues[i].t,e=(i+1<cues.length?cues[i+1].t:s+3);
  return[s,e];
}
function seekTo(idx,play=true){
  if(!cues[idx])return;
  video.currentTime=Math.max(0,cues[idx].t-offset+0.0001);
  highlightRow(idx);
  if(play) video.play();
}

btnPrev.addEventListener('click',()=>seekTo(Math.max(0,currentIndex()-1),true));
btnNext.addEventListener('click',()=>seekTo(Math.min(cues.length-1,currentIndex()+1),true));

(function(){
  const btn=btnReplay;
  const on =()=>{btn.dataset.active='1';btn.classList.add('blue');};
  const off=()=>{btn.dataset.active='0';btn.classList.remove('blue');loopSentence=false;};
  off();
  btn.addEventListener('click',function(e){
    const isOn=btn.dataset.active==='1';
    if(isOn){e.stopImmediatePropagation();window.player.clearRepeat();off();return;}
    loopSentence=true;on();seekTo(currentIndex(),true);
  },true);
})();

btnOffsetMinus.addEventListener('click',()=>setOffset(offset-0.5));
btnOffsetPlus .addEventListener('click',()=>setOffset(offset+0.5));
$('#btnAutoSync').addEventListener('click',()=>{
  alert('å…ˆè®“å½±ç‰‡èˆ‡å­—å¹•å°åˆ°ä¸€å€‹å¥å­ï¼Œå†ç”¨åç§» +/-0.5 å¾®èª¿å³å¯ã€‚\nï¼ˆç›®å‰åªæœ‰ç°¡æ˜“æ‰‹å‹•æ ¡æº–ï¼‰');
});

video.addEventListener('timeupdate',()=>{
  if(!cues.length)return;
  const i=currentIndex();highlightRow(i);
  if(loopSentence){
    const [s,e]=sentenceRange(i);
    const t=video.currentTime+offset;
    if(t>=e-0.02){
      video.currentTime=Math.max(0,s-offset+0.0001);
      video.play();
    }
  }
});

/* ==== TTS (iOS-friendly) ==== */
const TTS_CLOUD_ENDPOINT = window.BOOKWIDE_TTS_ENDPOINT || ""; 
// ä¾‹ï¼šwindow.BOOKWIDE_TTS_ENDPOINT = "https://bookwide.net/api/tts"ï¼ˆä½ å¯ç”¨ Cloudflare Worker / Supabase Edge Functionï¼‰

const __ttsAudio = new Audio();
__ttsAudio.preload = "auto";

function isIOS(){
  const ua = navigator.userAgent || "";
  return /iP(hone|ad|od)/.test(ua) || (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);
}

async function cloudTTS(text, lang){
  if (!TTS_CLOUD_ENDPOINT) return false;
  try{
    const r = await fetch(TTS_CLOUD_ENDPOINT, {
      method: "POST",
      headers: {"content-type":"application/json"},
      body: JSON.stringify({
        text,
        lang,                 // "ja-JP" / "zh-TW" / "en-US"
        format: "mp3",
        cache: true
      })
    });
    if(!r.ok) return false;
    const j = await r.json();
    if(j && j.url){
      __ttsAudio.src = j.url;
      __ttsAudio.currentTime = 0;
      await __ttsAudio.play();
      return true;
    }
    if(j && j.audio_base64){
      const bin = atob(j.audio_base64);
      const bytes = new Uint8Array(bin.length);
      for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
      const blob = new Blob([bytes], {type:"audio/mpeg"});
      __ttsAudio.src = URL.createObjectURL(blob);
      __ttsAudio.currentTime = 0;
      await __ttsAudio.play();
      return true;
    }
  }catch(e){ /* ignore */ }
  return false;
}

function pickVoice(lang){
  // iOS/Chrome çš„ voice åç¨±ä¸ä¸€è‡´ï¼Œé€™è£¡åªåšã€Œç›¡é‡æŒ‘åˆ°ã€çš„ç­–ç•¥
  try{
    const vs = speechSynthesis.getVoices();
    const target = (lang||"").toLowerCase();
    if(!vs || !vs.length) return null;

    // å…ˆæ‰¾å®Œå…¨åŒ¹é…
    let v = vs.find(x => (x.lang||"").toLowerCase() === target);
    if(v) return v;

    // å†æ‰¾åŒèªç³»ï¼ˆja / zh / enï¼‰
    const key = target.split("-")[0];
    v = vs.find(x => (x.lang||"").toLowerCase().startsWith(key));
    return v || null;
  }catch(e){ return null; }
}

async function speakText(text, lang){
  if(!text) return;

  // âœ… iPhone æ—¥æ–‡å¸¸è¦‹å•é¡Œï¼šWeb Speech å¯èƒ½æ²’æœ‰ ja voice æˆ–å¿µèµ·ä¾†åƒè‹±æ–‡
  // è§£æ³•ï¼šiOS + æ—¥æ–‡ â†’ å„ªå…ˆèµ°é›²ç«¯ MP3ï¼ˆè‹¥ä½ æœ‰è¨­ TTS_CLOUD_ENDPOINTï¼‰
  const target = (lang||"").toLowerCase();
  const preferCloud = isIOS() && target.startsWith("ja");
  if(preferCloud){
    const ok = await cloudTTS(text, lang || "ja-JP");
    if(ok) return;
  }

  // ä¸€èˆ¬æƒ…æ³ï¼šå…ˆç”¨ browser TTSï¼ˆå¿«ã€å…éŒ¢ï¼‰
  try{
    if (!("speechSynthesis" in window)) throw new Error("no speechSynthesis");
    speechSynthesis.cancel();

    const u = new SpeechSynthesisUtterance(text);
    u.lang = lang || "en-US";
    u.rate = 1;
    u.pitch = 1;

    const v = pickVoice(u.lang);
    if(v) u.voice = v;

    // è‹¥æ˜¯ iOS ä½†æ²’æœ‰å°æ‡‰ voiceï¼Œä¹Ÿå˜—è©¦èµ°é›²ç«¯ï¼ˆæœ€å¾Œå‚™æ´ï¼‰
    if(isIOS() && !v && (target.startsWith("ja") || target.startsWith("zh"))){
      const ok = await cloudTTS(text, lang || "ja-JP");
      if(ok) return;
    }

    speechSynthesis.speak(u);
  }catch(e){
    // æœ€å¾Œå‚™æ´ï¼šé›²ç«¯ï¼ˆè‹¥æœ‰ï¼‰
    await cloudTTS(text, lang || "en-US");
  }
}


/* ==== åˆå§‹åŒ– + å®ˆé–€ç¨‹åºï¼ˆç™»å…¥ + è¨‚é–± + previewï¼‰ ==== */
(async function init(){
  const params = new URLSearchParams(location.search);
  const isPreview = params.get('preview') === '1';

  let user = null;

  // 1ï¸âƒ£ å…ˆç”¨ player.html å°ˆç”¨çš„ bwPlayerGetUser() å–å¾—ç™»å…¥ä½¿ç”¨è€…
  try {
    if (typeof bwPlayerGetUser === 'function') {
      user = await bwPlayerGetUser();
    }
  } catch (e) {
    console.error('[BW-player] bwPlayerGetUser error', e);
  }

  // 2ï¸âƒ£ è‹¥æœªç™»å…¥ï¼šé preview ä¸€å¾‹å°å›é¦–é 
  if (!user) {
    if (!isPreview) {
      const next = location.pathname + location.search;
      const url = new URL((ROOT_BASE || '') + '/index.html', location.origin);
      url.searchParams.set('denied', 'signin');
      url.searchParams.set('next', next);
      location.href = url.toString();
      return;
    }
  } else {
    // é¡¯ç¤ºç™»å…¥è€… Email
    const email = user.email || (user.user && user.user.email) || '';
    if (email) {
      const badge = $('#userNameBadge');
      if (badge) badge.textContent = email;
    }
  }

  // 3ï¸âƒ£ å·²ç™»å…¥ä¸”é previewï¼šæª¢æŸ¥ profiles.expires_atï¼ˆä½¿ç”¨ playerSupaï¼‰
  let validUntil = null;
  if (!isPreview && user) {
    try {
      if (typeof playerSupa !== 'undefined') {
        const todayISO = new Date();
        todayISO.setHours(0, 0, 0, 0);

        const { data, error } = await playerSupa
          .from('orders')
          .select('expire_at, items, buyer_id, user_id, status')
          .eq('status', 'paid')
          .or(`buyer_id.eq.${user.id},user_id.eq.${user.id}`)
          // JP é¡åˆ¥è¦–ç‚ºèˆ‡ Grammar / PRO ç›¸åŒè¨‚é–±ä¸»é¡Œï¼Œå› æ­¤å¯¦éš›ç”¨ pro ä¾†æŸ¥è¨‚å–®
          .contains('items', [cat === 'jp' ? 'pro' : cat])
          .order('expire_at', { ascending: false })
          .limit(1)
          .maybeSingle();

        if (!error && data && data.expire_at) {
          validUntil = new Date(data.expire_at);
        }
        console.log('[BW-player] order expire_at raw =', data && data.expire_at, 'parsed =', validUntil);
      } else {
        console.warn('[BW-player] playerSupa not defined for subscription check');
      }
    } catch (e) {
      console.error('[BW-player] check subscription error', e);
    }

    // ===== PREVIEW æ”¾è¡Œï¼ˆåªå…è¨± movie / goingbackhomeï¼‰=====
if (
  cat === 'movie' &&
  slug === 'goingbackhome' &&
  new URLSearchParams(location.search).get('preview') === '1'
) {
  // è©¦çœ‹ï¼Œç›´æ¥æ”¾è¡Œï¼Œä¸åšä»»ä½•è¨‚é–±æª¢æŸ¥
} else {

  const today = new Date();
  today.setHours(0, 0, 0, 0);

  // æ²’è¨‚é–±ï¼ˆæ²’æœ‰ä»»ä½•æœ‰æ•ˆè¨‚å–®ï¼‰â†’ å°å› pricing
  if (!(validUntil instanceof Date) || isNaN(validUntil.getTime())) {
    const next = location.pathname + location.search;
    const url = new URL((ROOT_BASE || '') + '/pricing.html', location.origin);
    url.searchParams.set('denied', 'noactive');
    url.searchParams.set('next', next);
    location.href = url.toString();
    return;
  }

  // è¨‚é–±å·²éæœŸ â†’ å°å› pricing
  if (validUntil.getTime() < today.getTime()) {
    const next = location.pathname + location.search;
    const url = new URL((ROOT_BASE || '') + '/pricing.html', location.origin);
    url.searchParams.set('denied', 'expired');
    url.searchParams.set('next', next);
    location.href = url.toString();
    return;
  }

}


  // 4ï¸âƒ£ å®ˆé–€é€šéå¾Œï¼Œåˆå§‹åŒ–æ’­æ”¾å™¨ + è¼‰å…¥è³‡æ–™
  try {
    const saved = localStorage.getItem(`offset:${slug}`);
    if (saved != null) setOffset(parseFloat(saved)); else setOffset(0);

    const r = Number(speedRange.value) || 1;
    video.playbackRate = r;
    speedVal.textContent = `${r.toFixed(2)}x`;

    await loadVideo();
    await loadCues();
    await loadQuiz();
    await loadVocab();
    await loadAI();

    showTab('sub');
  } catch (e) {
    console.warn('[BW-player] init error:', e);
  }
})();
  BW.startIdleLogout(30, '/login.html?timeout=1');
</script>

  <!-- æ’­æ”¾é€²åº¦å¯«å…¥ watch_logsï¼ˆä¾›å­¸ç¿’æ§åˆ¶å°ä½¿ç”¨ï¼‰ --> <!-- V20251124-fixed by ChatGPT -->
<script>
(function(){
  // éœ€è¦å‰é¢å·²ç¶“å»ºç«‹å¥½çš„ playerSupa / slug / <video id="player">
  if (typeof playerSupa === 'undefined') return;
  if (typeof slug === 'undefined') return;
  const videoEl = document.getElementById('player');
  if (!videoEl) return;

  const urlParams = new URLSearchParams(location.search);
  const needResume = urlParams.get('resume') === '1';

  let userEmail = null;
  let userId = null;
  let currentLogId = null;
  let resumePct = 0;
  let lastSaveTs = 0;
  const SAVE_GAP_MS = 5000; // è‡³å¤šç´„ 5 ç§’å¯«ä¸€æ¬¡ DB

  async function initWatchLog(){
    try{
      // å–å¾—ç™»å…¥ä½¿ç”¨è€…
      const { data: userData, error: userErr } = await playerSupa.auth.getUser();
      if (userErr || !userData || !userData.user) return;

      const user = userData.user;
      userEmail = user.email || '';
      userId = user.id;

      // æ‰¾é€™å€‹äºº + é€™æ”¯å½±ç‰‡ï¼Œæœ€å¾Œä¸€ç­†è§€çœ‹ç´€éŒ„
      const { data: rows, error: logErr } = await playerSupa
        .from('watch_logs')
        .select('id, progress_pct, updated_at')
        .eq('email', userEmail)
        .eq('video_slug', slug)
        .order('updated_at', { ascending: false })
        .limit(1);

      if (!logErr && rows && rows.length){
        currentLogId = rows[0].id || null;
        resumePct = rows[0].progress_pct || 0;
      }

      // å¦‚æœç¶²å€æœ‰ ?resume=1ï¼Œè€Œä¸”æœ‰èˆŠé€²åº¦ï¼Œå°±å¹«ä»–è·³åˆ°å¤§ç´„çš„ä½ç½®
      if (needResume && resumePct > 0){
        const seekByPct = function(){
          if (!videoEl.duration || !isFinite(videoEl.duration)) return;
          const pct = Math.max(0, Math.min(99, resumePct));
          const t = videoEl.duration * pct / 100;
          if (t > 3){
            try { videoEl.currentTime = t; } catch(e){}
          }
          videoEl.removeEventListener('loadedmetadata', seekByPct);
        };
        videoEl.addEventListener('loadedmetadata', seekByPct);
      }

      // çœ‹ç‰‡éç¨‹ä¸­å®šæœŸå¯«é€²åº¦
      videoEl.addEventListener('timeupdate', handleTimeUpdate);
      // æ’­å®Œä¸€å¾‹å¯« 100%
      videoEl.addEventListener('ended', function(){ saveProgress(100); });

    }catch(e){
      console.error('watch_logs init error', e);
    }
  }

  async function saveProgress(pct){
    if (!userEmail) return;

    pct = Math.round(Math.max(0, Math.min(100, pct)));
    const payload = {
      progress_pct: pct,
      updated_at: new Date().toISOString()
    };

    const dur = videoEl && videoEl.duration && isFinite(videoEl.duration)
      ? Math.round(videoEl.duration)
      : null;
    if (dur != null) payload.duration_sec = dur;

    try{
      if (currentLogId){
        // å·²æœ‰ä¸€ç­†ç´€éŒ„ â†’ update é‚£ä¸€ç­†
        const { error } = await playerSupa
          .from('watch_logs')
          .update(payload)
          .eq('id', currentLogId);
        if (error) console.error('watch_logs update error', error);
      }else{
        // ç¬¬ä¸€æ¬¡çœ‹ç‰‡ â†’ insert æ–°çš„ä¸€ç­†
        const insertPayload = Object.assign({
          email: userEmail,
          user_id: userId,
          video_slug: slug
        }, payload);

        const { data, error } = await playerSupa
          .from('watch_logs')
          .insert(insertPayload)
          .select('id')
          .single();

        if (!error && data && data.id){
          currentLogId = data.id;
        }else if (error){
          console.error('watch_logs insert error', error);
        }
      }
    }catch(e){
      console.error('watch_logs saveProgress exception', e);
    }
  }

  function handleTimeUpdate(){
    if (!videoEl || !videoEl.duration || !isFinite(videoEl.duration)) return;

    const now = Date.now();
    if (now - lastSaveTs < SAVE_GAP_MS) return; // é–“éš”å¤ªçŸ­å°±å…ˆç•¥é
    lastSaveTs = now;

    const cur = videoEl.currentTime || 0;
    const pct = (cur / videoEl.duration) * 100;
    saveProgress(pct);
  }

  // ç¨å¾®å»¶é²ä¸€ä¸‹ï¼Œè®“å‰é¢çš„å®ˆé–€ / å…¶å®ƒç¨‹å¼å…ˆè·‘å®Œ
  if (document.readyState === 'complete' || document.readyState === 'interactive'){
    setTimeout(initWatchLog, 600);
  }else{
    document.addEventListener('DOMContentLoaded', function(){
      setTimeout(initWatchLog, 600);
    });
  }
})();
  BW.startIdleLogout(30, '/login.html?timeout=1');

// PRO æ¨¡å¼ï¼šè®€å– index-pro.jsonï¼Œä¸¦åœ¨ã€Œå­—å¹•ã€åˆ†é é¡¯ç¤ºå®Œæ•´èª²ç¨‹ç« ç¯€æ¸…å–®

// JP æ¨¡å¼ï¼šè®€å– index-jp.jsonï¼Œä¸¦åœ¨ã€Œå­—å¹•ã€åˆ†é é¡¯ç¤ºæ—¥æ–‡æ–‡æ³•æ¸…å–®
async 
async function loadJpOutline(){
  try{
    const url = `${BASE}/data/jp/index-jp.json?v=${vnow}`;
    const r = await fetch(url, {cache:'no-store'});
    if(!r.ok) throw 0;
    const raw = await r.json();

    // å…è¨±å…©ç¨®æ ¼å¼ï¼š
    // 1) å¹³é¢é™£åˆ—ï¼š[ { jlpt_level, slug, title, no }, ... ]
    // 2) ç¾¤çµ„æ ¼å¼ï¼š[ { level/groupId, title/groupTitle, items:[...] }, ... ]
    let lessons = [];
    if (Array.isArray(raw)) {
      lessons = raw;
    } else if (Array.isArray(raw.items)) {
      lessons = raw.items;
    } else if (Array.isArray(raw.lessons)) {
      lessons = raw.lessons;
    } else if (Array.isArray(raw.groups)) {
      raw.groups.forEach(g => {
        (g.items || []).forEach(it => lessons.push(Object.assign({ jlpt_level: g.level || g.groupId || '' }, it)));
      });
    }

    const rows = [];
    let currentLevel = null;

    lessons.forEach((item, idx) => {
      const level = item.jlpt_level || item.level || '';
      const slugVal = item.slug || item.jp_slug || '';
      if (!slugVal) return;

      // æ¯ç•¶ level æ”¹è®Šæ™‚æ’å…¥ä¸€è¡Œç¾¤çµ„æ¨™é¡Œ
      if (level && level !== currentLevel) {
        currentLevel = level;
        rows.push({
          type: 'group',
          label: `ã€${level}ã€‘`,
          slug: null
        });
      }

      rows.push({
        type: 'lesson',
        label: (item.no ? `${item.no} ` : '') + (item.title || ''),
        slug: slugVal,
        level
      });
    });

    if (!rows.length) {
      cuesStatus.textContent = 'ï¼ˆæ—¥æ–‡æ–‡æ³•ç´¢å¼•æ²’æœ‰è³‡æ–™ï¼‰';
      cuesBody.innerHTML = '';
      return;
    }

    cuesBody.innerHTML = rows.map(row => {
      if (row.type === 'group') {
        return `
      <tr class="jp-group">
        <td></td>
        <td><strong>${esc(row.label)}</strong></td>
      </tr>`;
      } else {
        const isCurrent = (row.slug === slug);
        return `
      <tr class="jp-lesson${isCurrent ? ' current' : ''}" data-slug="${row.slug}">
        <td></td>
        <td>${esc(row.label)}</td>
      </tr>`;
      }
    }).join('');

    cuesStatus.textContent = 'ï¼ˆé»é¸æ–‡æ³•å¯åˆ‡æ›ç« ç¯€ï¼‰';

    cuesBody.addEventListener('click', e => {
      const tr = e.target.closest('.jp-lesson');
      if (!tr) return;
      const targetSlug = tr.getAttribute('data-slug');
      if (!targetSlug || targetSlug === slug) return;
      const baseParam = paramBase ? `&base=${encodeURIComponent(paramBase)}` : '';
      location.href = `player.html?cat=jp&slug=${encodeURIComponent(targetSlug)}${baseParam}`;
    });

  } catch (e) {
    console.error('loadJpOutline failed', e);
    cuesStatus.textContent = 'ï¼ˆæ—¥æ–‡æ–‡æ³•ç´¢å¼•è¼‰å…¥å¤±æ•—ï¼‰';
  }
}
async function loadProOutline(){
  try{
    const url=`${BASE}/data/pro/index-pro.json?v=${vnow}`;
    const r=await fetch(url,{cache:'no-store'});
    if(!r.ok) throw 0;
    const groups=await r.json();

    const rows=[];
    // å±•å¹³æˆä¸€å€‹ rows é™£åˆ—ï¼ŒåŒæ™‚å»º proSlugToGroupId æ˜ å°„
    groups.forEach(g=>{
      const gid=g.groupId||'';
      rows.push({type:'group',label:`ã€${gid}ã€‘${g.groupTitle||''}`,slug:null});

      (g.items||[]).forEach(item=>{
        const slug=item.slug;
        if(slug){
          proSlugToGroupId[slug]=gid;
          rows.push({
            type:'lesson',
            label:`${item.no||''}. ${item.title||''}`,
            slug:slug,
            groupId:gid
          });
        }
      });
    });

    // æ¸²æŸ“æˆè¡¨æ ¼ï¼šæ™‚é–“æ¬„ç•™ç™½ï¼Œæ–‡å­—æ¬„é¡¯ç¤ºç« ç¯€åï¼›ç›®å‰ç« ç¯€åŠ åº•è‰²
    cuesBody.innerHTML=rows.map(row=>{
      if(row.type==='group'){
        return `
      <tr class="pro-group">
        <td></td>
        <td><strong>${esc(row.label)}</strong></td>
      </tr>`;
      }else{
        const isCurrent=(row.slug===slug);
        return `
      <tr class="pro-lesson${isCurrent?' current':''}" data-slug="${row.slug}">
        <td></td>
        <td>${esc(row.label)}</td>
      </tr>`;
      }
    }).join('');

    cuesStatus.textContent='ï¼ˆé»é¸èª²ç¨‹å¯åˆ‡æ›ç« ç¯€ï¼‰';

    // é»æ“Šäº‹ä»¶ï¼šåˆ‡æ›è‡³æŒ‡å®šç« ç¯€
    cuesBody.addEventListener('click',e=>{
      const tr=e.target.closest('.pro-lesson');
      if(!tr) return;
      const targetSlug=tr.getAttribute('data-slug');
      if(!targetSlug || targetSlug===slug) return;
      const baseParam=paramBase?`&base=${encodeURIComponent(paramBase)}`:'';
      location.href=`player.html?cat=pro&slug=${encodeURIComponent(targetSlug)}${baseParam}`;
    });

  }catch(e){
    console.error('loadProOutline failed',e);
    cuesStatus.textContent='ï¼ˆPRO èª²ç¨‹æ¸…å–®è¼‰å…¥å¤±æ•—ï¼‰';
  }
}
</script>

</body>
</html>

















<!-- ================= BookWide TRIAL FINAL PATCH v20251227 ================= -->
<script>
/* FINAL POLICY:
 * - MUST login
 * - ONLY movie/goingbackhome can preview
 * - preview ends -> redirect to pricing with next
 */

(async function BW_TRIAL_FINAL(){
  try{
    const params = new URLSearchParams(location.search);
    const isPreview = params.get('preview') === '1';
    const cat = params.get('cat');
    const slug = params.get('slug');

    const PREVIEW_ALLOW =
      isPreview &&
      cat === 'movie' &&
      slug === 'goingbackhome';

    let user = null;
    try{
      if (typeof bwPlayerGetUser === 'function'){
        user = await bwPlayerGetUser();
      }
    }catch(e){}

    // must login
    if (!user){
      const next = location.pathname + location.search;
      const url = new URL((window.ROOT_BASE||'') + '/index.html', location.origin);
      url.searchParams.set('denied','signin');
      url.searchParams.set('next', next);
      location.href = url.toString();
      return;
    }

    // subscription gate (skip only when PREVIEW_ALLOW)
    if (!PREVIEW_ALLOW && typeof window.__bw_subscription_checked === 'undefined'){
      window.__bw_subscription_checked = true;
      // let original logic run (do nothing here)
    }

    // mark trial
    if (PREVIEW_ALLOW){
      const badge = document.getElementById('userNameBadge');
      if (badge) badge.textContent = (user.email||'user') + ' Â· è©¦çœ‹ä¸­';
    }

    // trial end redirect
    const TRIAL_LIMIT_SECONDS = 180;
    function goPricing(){
      const u = new URL(location.href);
      u.searchParams.delete('preview');
      const next = u.pathname + '?' + u.searchParams.toString();
      const p = new URL((window.ROOT_BASE||'') + '/pricing.html', location.origin);
      p.searchParams.set('denied','trial_end');
      p.searchParams.set('next', next);
      location.href = p.toString();
    }

    const v = document.querySelector('video');
    if (PREVIEW_ALLOW && v){
      let fired=false;
      v.addEventListener('timeupdate',()=>{
        if (fired) return;
        if (v.currentTime >= TRIAL_LIMIT_SECONDS){
          fired=true;
          try{v.pause();}catch(e){}
          goPricing();
        }
      });
    }

  }catch(e){
    console.warn('[BW_TRIAL_FINAL]', e);
  }
})();
</script>
<!-- ================= /BookWide TRIAL FINAL PATCH ================= -->
































