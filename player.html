<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BookWide Player · Slim v2 · fixed</title>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--ink:#e5e7eb;--muted:#94a3b8;--accent:#38bdf8;--danger:#f87171;--ok:#34d399;--tab:#111827}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,Segoe UI,Roboto,Helvetica,Arial}
.header{position:fixed;inset:0 0 auto 0;height:52px;background:linear-gradient(180deg,#0b1220,rgba(11,18,32,.9));border-bottom:1px solid #0f223e;display:flex;align-items:center;gap:12px;padding:0 16px;z-index:50}
.header .meta{margin-left:auto;opacity:.7;font-size:13px}
.header a,.header button{color:var(--ink);background:#0b1b2e;border:1px solid #133455;border-radius:10px;padding:8px 12px}
.header a{text-decoration:none}
.header button{cursor:pointer}
.main{position:fixed;top:52px;bottom:72px;left:0;right:0;display:flex;gap:10px;padding:10px}
.left,.right{background:var(--panel);border-radius:12px;padding:10px}
.left{flex:0 0 50%;min-width:50%;display:flex;flex-direction:column;gap:10px;overflow:hidden}
.right{flex:0 0 50%;min-width:50%;display:flex;flex-direction:column;overflow:auto}
.videoWrap{flex:1;display:flex;align-items:center;justify-content:center;background:#000;border-radius:12px;overflow:hidden}
video{width:100%;height:100%;max-height:70vh;object-fit:contain;background:#000}
.footer{position:fixed;inset:auto 0 0 0;height:72px;background:linear-gradient(0deg,#0b1220,rgba(11,18,32,.95));border-top:1px solid #0f223e;display:flex;align-items:center;gap:10px;padding:10px 12px;z-index:50}
.btn{background:#0d1b2c;color:var(--ink);border:1px solid #12314d;padding:8px 10px;border-radius:10px;cursor:pointer}
.btn:hover{border-color:#1f4b74}
.switch{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
label{color:var(--muted)}
.range{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.badge{display:inline-block;border:1px solid #1f4b74;background:#0b1b2e;border-radius:999px;padding:4px 8px;color:#9cc5ff}
.tabs{display:flex;gap:6px;padding:4px;background:#0a1525;border-radius:10px;position:sticky;top:0;z-index:2}
.tab{background:var(--tab);border:1px solid #172033;padding:8px 12px;border-radius:10px;cursor:pointer}
.tab.active{background:#102039;border-color:#224;color:#cbe7ff}
.pane{padding:10px}
.hide{display:none}
.cues{width:100%;border-collapse:collapse}
.cues th,.cues td{padding:10px;border-bottom:1px dashed #1e2a3e;vertical-align:top}
.cues tr.active{background:#11223a}
.cues .ts{color:#9fb7d6;white-space:nowrap;width:72px}
.cues .en{font-weight:600}
.cues .zh{color:#a9b8c9}
.q-tabs{display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap}
.q-tab{padding:6px 12px;border-radius:999px;border:1px solid #17415e;background:#0a1727;cursor:pointer}
.q-tab.active{background:#10314f;color:#cbe7ff}
.q-item{padding:12px;border:1px solid #172a44;border-radius:10px;margin:10px 0;background:#0c1526}
.q-item .title{font-weight:700;margin-bottom:6px}
.q-item .opts{display:flex;gap:10px;flex-direction:column}
.q-item .exp{color:#a7c0d8;margin-top:8px}
.scorebar{position:sticky;bottom:0;background:#0a1520;padding:8px;border-top:1px solid #1b2b46;display:flex;gap:10px;align-items:center;border-radius:0 0 10px 10px}
.card{border:1px solid #162a44;background:#0b1627;border-radius:10px;padding:12px;margin:10px 0}
.card h4{margin:0 0 6px 0}
.ai-topic{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
.ai-topic button{border-radius:999px}
@media print{.header,.footer,.videoWrap{display:none}.main{position:static;display:block}.left{display:none}.right{min-width:100%;flex:0 0 100%}body{background:#fff;color:#000}.right,.pane,.q-item{background:#fff;border:1px solid #ccc;color:#000}}
</style>
</head>
<body>
  <div class="header">
    <a id="btnHome" href="./index.html">← 回首頁</a>
    <div id="title" class="badge">BookWide Player · Slim v2 · fixed</div>
    <div class="meta" id="meta"></div>
    <button id="btnFav" class="btn">☆ 我的收藏</button>
  </div>

  <div class="main">
    <section class="left">
      <div class="videoWrap">
        <video id="vid" controls playsinline></video>
      </div>
      <div class="switch">
        <label><input type="checkbox" id="chkFollow" checked> 跟隨</label>
        <div class="range">
          <button class="btn" id="btnPrev">上一句</button>
          <button class="btn" id="btnPlay">播放 / 暫停</button>
          <button class="btn" id="btnNext">下一句</button>
          <button class="btn" id="btnRepeat">重複本句</button>
          <span class="badge">偏移</span>
          <button class="btn" id="btnShiftMinus">-0.5s</button>
          <button class="btn" id="btnShiftPlus">+0.5s</button>
          <span class="badge">速度</span>
          <input id="rate" type="range" min="0.5" max="2" step="0.05" value="1">
          <span id="rateLabel">1.00x</span>
          <button class="btn" id="btnCalib">簡易校準</button>
          <button class="btn" id="btnSpeak">🔈 朗讀</button>
        </div>
      </div>
    </section>

    <section class="right">
      <div class="tabs">
        <div class="tab active" data-pane="pane-cues">字幕</div>
        <div class="tab" data-pane="pane-quiz">測驗</div>
        <div class="tab" data-pane="pane-vocab">單字</div>
        <div class="tab" data-pane="pane-ai">AI 互動</div>
      </div>
      <div class="pane" id="pane-cues">
        <div class="badge" id="cuesInfo">已載入字幕</div>
        <table class="cues" id="cuesTable">
          <thead><tr><th class="ts">時間</th><th>英文</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="pane hide" id="pane-quiz">
        <div class="q-tabs" id="qTabs"></div>
        <div id="quizWrap"></div>
        <div class="scorebar">
          <button id="btnSubmit" class="btn">交卷</button>
          <button id="btnShow" class="btn">顯示答案</button>
          <button id="btnPrint" class="btn">列印成績單</button>
          <span id="scoreText" class="badge">本分區分數：0 / 100</span>
        </div>
      </div>

      <div class="pane hide" id="pane-vocab">
        <div class="badge" id="vocabInfo">已載入單字</div>
        <div id="vocabWrap"></div>
      </div>

      <div class="pane hide" id="pane-ai">
        <div class="ai-topic" id="aiTopics"></div>
        <div>
          <label>題目：</label>
          <textarea id="aiPrompt" style="width:100%;min-height:120px"></textarea>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button class="btn" id="btnPrevTopic">◀ 上一題</button>
            <button class="btn" id="btnNextTopic">下一題 ▶</button>
            <button class="btn" id="btnReadQ">🔈 朗讀題目</button>
          </div>
          <div id="aiHint" style="margin-top:8px;color:#9fb7d6"></div>
          <div id="aiSample" style="margin-top:6px;color:#a7c0d8"></div>
        </div>
      </div>
    </section>
  </div>

  <div class="footer">
    <div id="status" class="badge">準備就緒</div>
  </div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const cat = qs.get('cat') || 'story';
  const slug = qs.get('slug') || 'mid-autumn';
  const $ = (s, p=document)=>p.querySelector(s);
  const $$ = (s, p=document)=>Array.from(p.querySelectorAll(s));
  const elVid = $('#vid');
  const elMeta = $('#meta');
  const elStatus = $('#status');

  if (window.initGate) try{ initGate(); }catch(e){ console.warn('[Gate] skipped', e) }

  elMeta.textContent = `cat=${cat} · slug=${slug}`;

  const trySrc = [`./videos/${cat}/${slug}.mp4`, `./videos/${slug}.mp4`];
  elVid.src = trySrc[0];
  elVid.addEventListener('error',()=>{
    if(elVid.src.endsWith(trySrc[0])) elVid.src = trySrc[1];
  });

  $$('.tab').forEach(t=>t.addEventListener('click',()=>{
    $$('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    $$('.pane').forEach(p=>p.classList.add('hide'));
    $('#'+t.dataset.pane).classList.remove('hide');
    if(t.dataset.pane==='pane-cues') syncActiveRow();
  }));

  async function fetchJSON(path){
    const res = await fetch(path + `?v=${Date.now()}`);
    if(!res.ok) throw new Error('HTTP '+res.status);
    return await res.json();
  }

  let cues = []; let offset = 0;
  const elCuesTbody = $('#cuesTable tbody');

  function renderCues(){
    elCuesTbody.innerHTML = cues.map((c,i)=>{
      const ts = new Date((c.start||0)*1000).toISOString().substr(14,5);
      const zh = c.zh? `<div class="zh">${c.zh}</div>`:'';
      return `<tr data-i="${i}"><td class="ts">${ts}</td><td class="en">${c.en||''}${zh}</td></tr>`;
    }).join('');
    $$('#cuesTable tbody tr').forEach(tr=>{
      tr.addEventListener('click',()=>{
        const i = +tr.dataset.i;
        elVid.currentTime = (cues[i].start||0) + offset;
        elVid.play();
      });
    });
  }
  function syncActiveRow(){
    const t = elVid.currentTime - offset;
    const i = cues.findIndex(c=> t>=c.start && t<(c.end??(c.start+10)));
    $$('#cuesTable tbody tr').forEach((tr,idx)=>{
      tr.classList.toggle('active', idx===i);
      if(idx===i && $('#chkFollow').checked){
        tr.scrollIntoView({block:'center',behavior:'smooth'});
      }
    });
  }

  /* QUIZ */
  let quizAll = []; const elQTabs = $('#qTabs'); const elQuizWrap = $('#quizWrap');
  const groups = ['Vocabulary','Grammar','Reading','Mixed']; let activeGroup = 'Vocabulary';
  function buildQTabs(){
    elQTabs.innerHTML = groups.map(g=>`<button class="q-tab ${g===activeGroup?'active':''}" data-g="${g}">${g} (${quizAll.filter(q=>q.section===g).length})</button>`).join('');
    $$('.q-tab',elQTabs).forEach(b=>b.addEventListener('click',()=>{ activeGroup=b.dataset.g; buildQTabs(); renderQuiz(); }));
  }
  function renderQuiz(showAns=false){
    const arr = quizAll.filter(q=>q.section===activeGroup);
    elQuizWrap.innerHTML = arr.map((q,idx)=>{
      const name = `q_${activeGroup}_${idx}`;
      const opts = (q.options||[]).map(o=>`<label><input type="radio" name="${name}" value="${o}"> ${o}</label>`).join('<br/>');
      const exp = showAns? `<div class="exp">正解：<b>${q.answer}</b>${q.explanation? '　｜　'+q.explanation:''}</div>`:'';
      return `<div class="q-item"><div class="title">${idx+1}. ${q.question||q.q}</div><div class="opts">${opts}</div>${exp}</div>`;
    }).join('');
  }
  function submitQuiz(){
    const arr = quizAll.filter(q=>q.section===activeGroup);
    let score = 0;
    $$('.q-item').forEach((div,i)=>{
      const inputs = div.querySelectorAll('input[type=radio]');
      const checked = Array.from(inputs).find(x=>x.checked);
      if(!checked) return;
      if(arr[i].answer===checked.value) score += 5;
      if(!div.querySelector('.exp')){
        const hint=document.createElement('div');
        hint.className='exp';
        hint.innerHTML = `正解：<b>${arr[i].answer}</b>${arr[i].explanation? '　｜　'+arr[i].explanation:''}`;
        div.appendChild(hint);
      }
    });
    $('#scoreText').textContent = `本分區分數：${score} / 100`;
  }

  /* VOCAB */
  function renderVocab(list){
    const wrap = $('#vocabWrap');
    wrap.innerHTML = (list||[]).map(v=>{
      const def = v.definition || v.def || '';
      return `<div class="card"><h4>${v.word||v.w||''}</h4><div>${v.zh||''}</div><div style="opacity:.8">${def}</div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="btn btnSpeak" data-text="${(v.word||'')}">🔈 朗讀</button>
        </div></div>`;
    }).join('');
    $$('.btnSpeak',wrap).forEach(b=>b.addEventListener('click',()=>speak(b.dataset.text)));
  }

  /* AI */
  let ai = {topics:[]}, aiIndex = 0;
  function renderAI(){
    const topics = ai.topics||[];
    if(!topics.length){ $('#aiTopics').innerHTML = '<span class="badge">暫無 AI 資料</span>'; return; }
    $('#aiTopics').innerHTML = topics.map((t,i)=>`<button class="btn ${i===aiIndex?'badge':''}" data-i="${i}">${t.title||('Topic '+(i+1))}</button>`).join('');
    $$('#aiTopics button').forEach(b=>b.addEventListener('click',()=>{ aiIndex=+b.dataset.i; setTopic(); }));
    setTopic();
  }
  function setTopic(){
    const t = (ai.topics||[])[aiIndex]||{};
    $('#aiPrompt').value = t.prompt||'';
    $('#aiHint').textContent = t.hint? 'hint：'+t.hint : '';
    $('#aiSample').textContent = t.sample? '示範：'+t.sample : '';
    // keep topic buttons highlight without infinite recursion
    $$('#aiTopics button').forEach((b,i)=> b.classList.toggle('badge', i===aiIndex));
  }
  $('#btnPrevTopic').onclick = ()=>{ aiIndex=(aiIndex-1+ (ai.topics||[]).length)%((ai.topics||[]).length||1); setTopic(); };
  $('#btnNextTopic').onclick = ()=>{ aiIndex=(aiIndex+1)%((ai.topics||[]).length||1); setTopic(); };
  $('#btnReadQ').onclick = ()=> speak($('#aiPrompt').value||'');

  /* TTS */
  function speak(text){
    if(!('speechSynthesis' in window)) return alert('此瀏覽器不支援朗讀');
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'en-US'; u.rate = 1; speechSynthesis.cancel(); speechSynthesis.speak(u);
  }
  $('#btnSpeak').onclick = ()=>{
    const i = $$('#cuesTable tbody tr').findIndex(tr=>tr.classList.contains('active'));
    const t = cues[i]?.en || '';
    speak(t);
  };

  /* controls */
  $('#btnPrev').onclick = ()=>{
    const t = elVid.currentTime - offset;
    let i = cues.findIndex(c=>t>=c.start && t<(c.end??(c.start+10)));
    if(i<=0) i=1;
    elVid.currentTime = (cues[i-1].start||0)+offset; elVid.play();
  };
  $('#btnNext').onclick = ()=>{
    const t = elVid.currentTime - offset;
    let i = cues.findIndex(c=>t>=c.start && t<(c.end??(c.start+10)));
    if(i<0) i=0;
    if(i<cues.length-1) elVid.currentTime = (cues[i+1].start||0)+offset;
    elVid.play();
  };
  $('#btnPlay').onclick = ()=> elVid.paused ? elVid.play() : elVid.pause();
  $('#btnRepeat').onclick = ()=>{
    const t = elVid.currentTime - offset;
    let i = cues.findIndex(c=>t>=c.start && t<(c.end??(c.start+10)));
    if(i<0) i=0;
    elVid.currentTime = (cues[i].start||0)+offset; elVid.play();
  };
  $('#btnShiftMinus').onclick = ()=>{ offset -= .5; toast('偏移 '+offset.toFixed(1)+'s'); };
  $('#btnShiftPlus').onclick = ()=>{ offset += .5; toast('偏移 '+offset.toFixed(1)+'s'); };
  $('#rate').oninput = e=>{ elVid.playbackRate = +e.target.value; $('#rateLabel').textContent = (+e.target.value).toFixed(2)+'x'; };
  $('#btnCalib').onclick = ()=>{ offset = 0; toast('校準 0.0s'); };

  function toast(t){ elStatus.textContent = t; setTimeout(()=>elStatus.textContent='準備就緒', 1500); }

  $('#btnSubmit').onclick = submitQuiz;
  $('#btnShow').onclick = ()=> renderQuiz(true);
  $('#btnPrint').onclick = ()=> window.print();

  elVid.addEventListener('timeupdate', syncActiveRow);

  async function boot(){
    try{
      const raw = await fetchJSON(`./data/${cat}/cues-${slug}.json`);
      cues = Array.isArray(raw)? raw : (raw.cues||[]);
      renderCues();
      $('#cuesInfo').textContent = `已載入字幕（${slug} 回退）`;
    }catch(e){
      console.warn('[cues] load fail', e);
      $('#cuesInfo').textContent = '字幕載入失敗或格式錯誤';
    }
    try{
      quizAll = await fetchJSON(`./data/${cat}/quiz-${slug}.json`);
      buildQTabs(); renderQuiz(false);
    }catch(e){ console.warn('[quiz] load fail', e); $('#quizWrap').innerHTML='<span class="badge">暫無題庫</span>'; }
    try{
      const v = await fetchJSON(`./data/${cat}/vocab-${slug}.json`);
      renderVocab(v);
    }catch(e){ $('#vocabWrap').innerHTML='<span class="badge">暫無單字</span>'; }
    try{
      ai = await fetchJSON(`./data/${cat}/ai-${slug}.json`);
      renderAI();
    }catch(e){ $('#aiTopics').innerHTML='<span class="badge">暫無 AI 資料</span>'; }
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot, {once:true}); else boot();
})();
</script>
</body>
</html>























































