<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BookWide Â· è‹±èªå½±ç‰‡æ’­æ”¾å™¨ï¼ˆcat è·¯å¾‘ä¿®æ­£ 2025-11-01ï¼‰</title>

<style>
:root{ --bg:#0b1324; --panel:#0f172a; --border:#1f2a44; --ink:#e6f0ff; --muted:#9fb0c9; --accent:#3c7cff; }
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,"Noto Sans TC"}
h1{font-size:20px;margin:0}
a{color:inherit}
.btn{background:#13233f;border:1px solid #24446f;border-radius:10px;padding:8px 12px;color:#fff;cursor:pointer}
.btn.blue{background:#14335f;border-color:#2c5aa3}
.muted{color:var(--muted)}
header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:#0f172a;border-bottom:1px solid #0e203f}
.wrap{padding:16px;height:calc(100vh - 58px);}
.layout{height:100%;display:grid;grid-template-columns:1fr 1fr;gap:16px;overflow-x:hidden; overflow-y:auto}
.left,.right{min-width:0;background:var(--panel);border:1px solid var(--border);border-radius:12px}
.left{display:flex;flex-direction:column;padding:14px;position:sticky;top:0;align-self:start;z-index:10}
.right{display:flex;flex-direction:column;overflow-y:auto;scrollbar-width:thin;position:relative}
.right::-webkit-scrollbar{width:10px}
.right::-webkit-scrollbar-thumb{background:#556a9a;border-radius:6px}

.pane{flex:1;overflow:auto}
.videoWrap{position:relative;width:100%;aspect-ratio:16/9;background:#000;border-radius:10px;overflow:hidden}
.videoWrap video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000}
.controls{margin-top:12px;background:#0e2038;border:1px solid #183459;border-radius:12px;padding:12px}
.controls .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:.25rem 0}
.speed{display:flex;align-items:center;gap:10px}
input[type="range"]{width:260px;accent-color:var(--accent)}
.chip{display:inline-flex;align-items:center;gap:6px;padding:7px 10px;border:1px solid #23446c;border-radius:10px;background:#10233d}
.tabs{display:flex;gap:8px;padding:6px 10px;margin:0 0 2px;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:20;background:var(--panel)}
.tab{cursor:pointer;background:#122340;border:1px solid #1f375f;border-radius:12px;padding:10px 14px;font-weight:600}
.tab.active{background:#154274}
table{width:100%;border-collapse:collapse}
th,td{padding:10px 12px;border-bottom:1px solid #162a48;vertical-align:top}
tbody tr{background:#0f1f34}
tbody tr:nth-child(2n){background:#0d1a2b}
tbody tr:hover{background:#0f2a4e}
tr.active{background:#173a6e}
.cues-table{table-layout:fixed}
.cue-time{width:64px;min-width:64px;color:rgba(255,255,255,.7);font-family:ui-monospace,Consolas,monospace;white-space:nowrap}
.cue-en{line-height:1.6;word-break:break-word}
.cue-en .zh-line{margin-top:6px;opacity:.9}
.cue-zh{display:none !important}
@media (max-width:860px) and (orientation:portrait){
  #track{ display:flex; flex-direction:row; overflow-x:auto; overflow-y:hidden; scroll-snap-type:x mandatory; gap:0; }
  .page{ flex:0 0 100vw; max-width:100vw; height:calc(100vh - 58px); scroll-snap-align:start; overflow-y:auto; }
  .page > .left, .page > .right{ width:100%; max-width:100%; border-radius:0; border-left:0; border-right:0; }
  #btnExitFocus{ position:fixed; right:16px; bottom:16px; z-index:10020; display:none;
    padding:8px 12px; border-radius:10px; border:1px solid rgba(100,116,139,.5); background:#0f172a; color:#e6efff; }
  body.at-right #btnExitFocus{ display:inline-flex; }
}
@media print{
  /* Print only QUIZ pane */
  body{ background:#fff !important; color:#000 !important; }
  header,.tabs,.controls,#authArea,.drawer-grab,.videoWrap,.left,#pane-sub,#pane-vocab,#pane-ai{ display:none !important; }
  .wrap{ padding:0 !important; }
  .layout{ display:block !important; height:auto !important; overflow:visible !important; }
  .right{ border:none !important; background:#fff !important; display:block !important; height:auto !important; }
  #pane-quiz{ display:block !important; }
  #quizMeta{ font-size:10pt; color:#444 !important; }
  #quizList{ font-size:12.5pt; line-height:1.35; }
  #quizList > li{ break-inside:avoid; page-break-inside:avoid; padding:6px 0; margin:0 0 6px 0; border-bottom:1px dotted #ccc; }
  .q-actions{ display:none !important; }
  @page { margin:10mm 10mm 12mm 10mm; }
  html,body{ background:#fff !important; color:#000 !important; height:auto !important; overflow:visible !important; }
  header,.tabs,.controls,#authArea,.drawer-grab,.videoWrap,.left{ display:none !important; }
  .wrap{ padding:0 !important; }
  .layout{ display:block !important; height:auto !important; overflow:visible !important; }
  .right{ border:none !important; background:#fff !important; display:block !important; height:auto !important; }
  #pane-quiz,.pane{ height:auto !important; max-height:none !important; overflow:visible !important; display:block !important; }
  #quizList{ font-size:12.5pt; line-height:1.25; }
  #quizList > li{ break-inside:avoid; page-break-inside:avoid; padding:6px 0; margin:0 0 6px 0; border-bottom:1px dotted #ccc; }
  @page { margin:10mm 10mm 12mm 10mm; }
}

/* keep subtitle table header visible while right pane scrolls */
#pane-sub thead th{ position: sticky; top: 44px; background: var(--panel); z-index: 10; }
@media (max-width:860px) and (orientation:portrait){
  #pane-sub thead th{ top: 44px; }
}


/* --- print fix: show FULL quiz list with no blank first page --- */
@media print{
  #backHome{ display:none !important; }
  #quizFilters,#quizHeader,#quizMeta{ display:none !important; } /* hide toolbar/meta on paper */
  html, body, .wrap, .layout, .page, .right, .quiz-shell, #pane-quiz, #quizList{
    height:auto !important;
    max-height:none !important;
    overflow:visible !important;
  }
  .wrap{ padding:0 !important; margin:0 !important; }
  #pane-quiz{ display:block !important; }
  #quizList{ margin:0 !important; padding:0 8mm !important; font-size:12.5pt !important; line-height:1.35 !important; }
  #quizList > li{ break-inside:avoid; page-break-inside:avoid; padding:6px 0; margin:0 0 6px 0; border-bottom:1px dotted #ccc; }
  .q-actions{ display:none !important; }
  @page{ margin:10mm 10mm 12mm 10mm; }
}

.ja-line{margin-top:6px;opacity:.9}
</style>
</head>
<body>
<a id="backHome" href="/EduEnglish/index.html" style="position:fixed;left:16px;top:14px;z-index:10000;padding:6px 10px;border-radius:8px;background:#eef5ff;border:1px solid #c7ddff;color:#1b5eaa;text-decoration:none;font-weight:600;box-shadow:0 2px 6px rgba(0,0,0,.08)">â† å›é¦–é </a>

<header>
  <h1>æ’­æ”¾å™¨</h1>
  <div id="authArea" style="display:flex;gap:10px;align-items:center">
    <span class="muted" id="userNameBadge"></span>
  </div>
</header>

<div class="wrap">
  <div id="track" class="layout">
    <section class="page" id="pageLeft">
      <section class="left" id="videoContainer">
        <div class="videoWrap"><video id="player" playsinline controls></video></div>
        <div class="controls">
          <div class="row">
            <button class="btn" id="btnPrev">â® ä¸Šä¸€å¥</button>
            <button class="btn" id="btnPlay">â–¶ï¸ æ’­æ”¾ / æš«åœ</button>
            <button class="btn" id="btnNext">â­ ä¸‹ä¸€å¥</button>
            <button class="btn" id="btnReplay">ğŸ” é‡è¤‡æœ¬å¥</button>
          </div>
          <div class="row">
            <label class="chip"><input id="chkFollow" type="checkbox"/> è·Ÿéš¨</label>
            <span class="chip">åç§» <span id="offsetVal">0.0s</span></span>
            <button class="btn" id="btnOffsetMinus">-0.5s</button>
            <button class="btn" id="btnOffsetPlus">+0.5s</button>
            <button class="btn" id="btnAutoSync">ğŸ§­ ç°¡æ˜“æ ¡æº–</button>
          </div>
          <div class="row speed">
            <span class="muted">é€Ÿåº¦</span>
            <input id="speedRange" type="range" min="0.5" max="2" step="0.05" value="1"/>
            <span id="speedVal">1.00x</span>
          </div>
        </div>
      </section>
    </section>

    <section class="page" id="pageRight">
      <section class="right" id="studyContainer">
        <div class="tabs">
          <div class="tab active" data-tab="sub">å­—å¹•</div>
          <div class="tab" data-tab="quiz">æ¸¬é©—</div>
          <div class="tab" data-tab="vocab">å–®å­—</div>
          <div class="tab" data-tab="ai">AIäº’å‹•</div>
        </div>

        <div class="pane" id="pane-sub">
          <div class="muted" id="cuesStatus" style="padding:10px 14px">ï¼ˆå­—å¹•è¼‰å…¥ä¸­â€¦ï¼‰</div>
          <table class="cues-table">
            <thead><tr><th style="width:80px">æ™‚é–“</th><th>è‹±æ–‡</th><th class="cue-zh" style="width:40%">ä¸­æ–‡</th></tr></thead>
            <tbody id="cuesBody"></tbody>
          </table>
        </div>

        <div class="pane" id="pane-quiz" style="display:none">
          <div class="quiz-shell"><div style="display:flex;gap:8px;align-items:center;padding:8px 12px 4px"><div id="quizFilters" class="filters"><button class="btn btn-sec" data-sec="all">å…¨éƒ¨</button><button class="btn btn-sec" data-sec="Vocabulary">å–®å­—</button><button class="btn btn-sec" data-sec="Grammar">æ–‡æ³•</button><button class="btn btn-sec" data-sec="Reading">é–±è®€</button><button class="btn btn-sec" data-sec="Mixed">ç¶œåˆ</button></div><div id="quizHeader" class="muted" style="margin-left:8px"></div></div>
            <div class="muted" id="quizMeta" style="padding:8px 12px">ï¼ˆæ¸¬é©—è¼‰å…¥ä¸­â€¦ï¼‰</div>
            <ol id="quizList" style="line-height:1.6;padding:0 12px"></ol>
            <div class="q-actions" style="margin:14px 12px 6px; display:flex; gap:8px; align-items:center;">
              <button class="btn" id="btnSubmitQuiz">äº¤å·</button>
              <button class="btn" id="btnShowAnswer" >é¡¯ç¤ºç­”æ¡ˆ</button>
              <button class="btn" id="btnPrint" >åˆ—å°æˆç¸¾å–®</button>
              <span id="quizScore" style="margin-left:8px"></span>
            </div>
          </div>
        </div>

        <div class="pane" id="pane-vocab" style="display:none">
          <div class="muted" id="vocabStatus" style="padding:10px 14px">( å–®å­—è¼‰å…¥ä¸­â€¦ )</div>
          <div id="vocabBox" style="padding:0 14px 14px"></div>
        </div>

        <div class="pane" id="pane-ai" style="display:none">
          <div class="pane-ai" style="padding:10px">
            <div class="ai-row" style="margin:6px 0 10px">
              <span class="muted">å…è¨±éº¥å…‹é¢¨å¾Œå¯é€²è¡Œå£èªªç·´ç¿’ï¼ˆå»ºè­° Chrome / Edgeï¼‰ã€‚ç¶²å€å¸¶ <code>?cat=story|music|movie|news|pro&slug=mid-autumn</code></span>
            </div>
            <div class="ai-row" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <select id="aiTopic" class="btn" style="min-width:200px"></select>
              <button id="btnPrevTopic" class="btn">â—€ ä¸Šä¸€é¡Œ</button>
              <button id="btnNextTopic" class="btn">ä¸‹ä¸€é¡Œ â–¶</button>
              <button id="btnTts" class="btn">ğŸ”ˆ æœ—è®€</button>
              <button id="btnRec" class="btn">ğŸ™ï¸ é–‹å§‹èªª</button>
              <button id="btnStop" class="btn" disabled>â¹ åœæ­¢</button>
              <label style="font-size:13px;opacity:.9"><input id="aiAutoNext" type="checkbox"> ä½œç­”å¾Œè‡ªå‹•ä¸‹ä¸€é¡Œ</label>
              <span id="aiProgress" class="muted">ç¬¬ 0/0 é¡Œ</span>
            </div>
            <div class="ai-row" style="margin-top:6px">
              <textarea id="aiPrompt" rows="3" placeholder="é¡Œç›®æœƒé¡¯ç¤ºåœ¨é€™è£¡â€¦" readonly style="width:100%"></textarea>
            </div>
            <div class="ai-row" style="margin:6px 0 8px">
              <span class="muted">æç¤ºï¼š<span id="aiHint">â€”</span></span>
            </div>
            <div style="margin:10px 0 6px;display:flex;gap:8px;align-items:center"><span style="opacity:.9">AI ç¤ºç¯„ï¼š</span><button id="aiDemo" class="btn">ç¤ºç¯„å¥</button><button id="aiDemoTts" class="btn">æœ—è®€</button></div>
            <div class="ai-row">
              <div class="ai-out" id="aiReply" style="min-height:54px;border:1px solid #223048;border-radius:10px;padding:10px">ï¼ˆç­‰å¾…ä½ çš„ä½œç­”â€¦ï¼‰</div>
            </div>
          </div>
        </div>

      </section>
    </section>
  </div>
</div>

<button id="btnExitFocus" class="btn" style="display:none">è¿”å›å½±ç‰‡</button>

<script>
const $=(s,e=document)=>e.querySelector(s);
const $$=(s,e=document)=>[...e.querySelectorAll(s)];
const toSec=t=>{ if(typeof t==='number')return t; const p=String(t).split(':').map(Number);
  if(p.length===3)return p[0]*3600+p[1]*60+p[2]; if(p.length===2)return p[0]*60+p[1]; return Number(t)||0; };
const fmt=sec=>{ sec=Math.max(0,sec|0); const m=(sec/60)|0,s=sec%60; return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;}
const esc=s=>String(s??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');

const BASE='/EduEnglish';
const params=new URLSearchParams(location.search);
const cat=(params.get('cat')||'story').toLowerCase();
const primarySlug=params.get('slug')||'mid-autumn';
let slug=primarySlug;
// --- Supabase public Storage bases ---
const SUPA_PUBLIC_BASE = 'https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public';
const SUPA_VIDEOS_BASE = SUPA_PUBLIC_BASE + '/videos';
const SUPA_ASSETS_BASE = SUPA_PUBLIC_BASE + '/assets';


const video=$('#player'); const cuesBody=$('#cuesBody'); const cuesStatus=$('#cuesStatus');
const btnPrev=$('#btnPrev'),btnPlay=$('#btnPlay'),btnNext=$('#btnNext'),btnReplay=$('#btnReplay');
const btnOffsetMinus=$('#btnOffsetMinus'),btnOffsetPlus=$('#btnOffsetPlus'),offsetVal=$('#offsetVal');
const chkFollow=$('#chkFollow'); const speedRange=$('#speedRange'),speedVal=$('#speedVal');
const btnPrint=$('#btnPrint'); const paneSub=$('#pane-sub'),paneQuiz=$('#pane-quiz'),paneVocab=$('#pane-vocab');

let cues=[]; let offset=0; let loopSentence=false;
function setOffset(v){offset=Number(v)||0; offsetVal.textContent=`${offset.toFixed(1)}s`; localStorage.setItem(`offset:${slug}`,String(offset));}
window.player={ setOffset, clearRepeat:()=>{ loopSentence=false; btnReplay?.classList.remove('blue'); } };

/* ---------- smart fetcher: try cat folder -> legacy root -> story fallback ---------- */
async function fetchJSONMulti(paths, kind){
  for(const p of paths){
    try{ const r=await fetch(p,{cache:'no-store'}); if(r.ok){ return {data:await r.json(), used:p}; } }catch{}
  }
  console.error(`[fatal] ${kind} è®€å–å¤±æ•—`, paths);
  return {data:null, used:'error'};
}

/* ---------- video ---------- */
async function loadVideo(){
  const trySources=[
    // 1) Supabase Storage (preferred)
    `${SUPA_VIDEOS_BASE}/${cat}/${primarySlug}.mp4`,
    // 2) GitHub fallbacks
    `${BASE}/videos/${cat}/${primarySlug}.mp4`,
    `${BASE}/videos/${primarySlug}.mp4`,
    `${BASE}/videos/story/mid-autumn.mp4`
  ];
  let i=0;
  function setSrc(idx){ video.src=trySources[idx]; }
  setSrc(0);
  video.addEventListener('error',()=>{ if(i<trySources.length-1){ i++; setSrc(i); } },{passive:true});
}


/* ---------- cues ---------- */
async function loadCues(){
  cuesStatus.textContent='ï¼ˆå­—å¹•è¼‰å…¥ä¸­â€¦ï¼‰';
  const url = `${BASE}/data/${cat}/${primarySlug}/cues-${primarySlug}.json?v=${Date.now()}`;
  let data=null;
  try{
    const r=await fetch(url,{cache:'no-store'});
    if(r.ok){ data=await r.json(); }
  }catch{}
  if(!data){ cuesStatus.textContent='âš ï¸ å­—å¹•è®€å–å¤±æ•—'; return; }

  cues=data.map(x=>({t:toSec(x.time),en:x.en||'',zh:x.zh||'',ja:x.ja||''}));
  cuesBody.innerHTML=cues.map((c,i)=>`<tr data-i="${i}">
      <td class="cue-time">${c.t?fmt(c.t):''}</td>
      <td class="cue-en">
        ${esc(c.en)}
        ${c.zh?`<div class="zh-line">${esc(c.zh)}</div>`:''}
        ${c.ja?`<div class="ja-line">${esc(c.ja)}</div>`:''}
      </td>
      <td class="cue-zh">${esc(c.zh)}</td>
    </tr>`).join('');
  $$('#cuesBody tr').forEach(tr=>tr.addEventListener('click',()=>{const i=+tr.dataset.i; seekTo(i,true);}));
  cuesStatus.textContent = `å·²è¼‰å…¥ï¼š${url}`;
}

/* ---------- quiz ---------- */
async function loadQuiz(){
  const qStatus = document.getElementById('quizMeta');
  if(qStatus) qStatus.textContent='ï¼ˆæ¸¬é©—è¼‰å…¥ä¸­â€¦ï¼‰';
  const url = `${BASE}/data/${cat}/${primarySlug}/quiz-${primarySlug}.json?v=${Date.now()}`;
  let data=null;
  try{
    const r=await fetch(url,{cache:'no-store'});
    if(r.ok){ data=await r.json(); }
  }catch{}
  if(!data){ if(qStatus) qStatus.textContent='âŒ é¡Œåº«è®€å–å¤±æ•—'; return; }
  if(qStatus) qStatus.textContent=`å·²è¼‰å…¥ï¼š${url}`;
  renderQuiz(data);
}

/* ---------- vocab ---------- */
async function loadVocab(){
  const vStatus=$('#vocabStatus'), vBox=$('#vocabBox');
  const url = `${BASE}/data/${cat}/${primarySlug}/vocab-${primarySlug}.json?v=${Date.now()}`;
  let data=null;
  try{
    const r=await fetch(url,{cache:'no-store'});
    if(r.ok){ data=await r.json(); }
  }catch{}
  if(!data||!data.length){ vStatus.textContent='âš ï¸ æŸ¥ç„¡å–®å­—è³‡æ–™'; vBox.innerHTML=''; return; }
  vStatus.textContent=`å·²è¼‰å…¥ï¼š${url}`;

  const go=t=>{ const p=toSec(t); player.currentTime=Math.max(0,p); player.play(); };
  vBox.innerHTML=data.map(v=>{
    const ja   = v.ja ? `<div class="voc-ja">ã€æ—¥ã€‘${esc(v.ja)}</div>` : '';
    const jaDef= v.ja_def ? `<div class="voc-jadef muted">${esc(v.ja_def)}</div>` : '';
    const jaEx = v.ja_example ? `<div class="voc-jaex muted" style="margin-top:4px">ä¾‹ï¼š${esc(v.ja_example)}</div>` : '';
    return `<div class="voc" style="border:1px solid #223048;border-radius:10px;padding:10px;margin:10px 0">
      <div class="voc-h" style="display:flex;gap:8px;align-items:center">
        <div class="voc-word" style="font-weight:800;font-size:18px">${esc(v.word||'')}</div>
        <div class="voc-pos" style="opacity:.85">${esc(v.pos||'')}</div>
      </div>
      ${v.zh?`<div class="voc-zh">ã€ä¸­ã€‘${esc(v.zh)}</div>`:''}
      ${v.en?`<div class="voc-en">ã€è‹±ã€‘${esc(v.en)}</div>`:''}
      ${ja}${jaDef}${jaEx}
      <div class="voc-actions" style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
        ${v.time?`<button class="btn" data-act="jump" data-time="${esc(v.time)}">è·³åˆ°ç‰‡æ®µ</button>`:''}
        <button class="btn" data-act="speak" data-lang="en" data-text="${esc(v.word||v.en||'')}">ğŸ”Š è‹±æ–‡æœ—è®€</button>
        ${v.ja?`<button class="btn" data-act="speak" data-lang="ja" data-text="${esc(v.ja)}">ğŸ”Š æ—¥æ–‡æœ—è®€</button>`:''}
      </div>
    </div>`;
  }).join('');

  vBox.addEventListener('click',e=>{
    const act=e.target?.dataset?.act; if(!act)return;
    if(act==='jump'){ go(e.target.dataset.time||0); return; }
    if(act==='speak'){
      try{
        const lang = (e.target.dataset.lang||'en').toLowerCase()==='ja' ? 'ja-JP' : 'en-US';
        const u=new SpeechSynthesisUtterance(e.target.dataset.text||''); u.lang=lang;
        speechSynthesis.cancel(); speechSynthesis.speak(u);
      }catch{}
    }
  });
}

/* ---------- renderQuiz (simple MCQ/TF/Cloze) ---------- */
function renderQuiz(list){
  const ol = document.getElementById('quizList');
  const header = document.getElementById('quizHeader');
  const filters = $$('#quizFilters .btn');
  if(!Array.isArray(list)){ ol.innerHTML='<li>ç„¡æ•ˆçš„é¡Œåº«æ ¼å¼</li>'; return; }

  // Basic normalize
  const items = list.map((q,idx)=>{
    const type = (q.type||'MCQ').toUpperCase();
    return {
      idx, section: q.section||'General', type,
      question: q.question||q.q||'',
      options: q.options||[],
      answer: q.answer,
      explanation: q.explanation||'',
      ja: q.ja||null
    };
  });

  function render(itemsToShow){
    header.textContent = `å…± ${itemsToShow.length} é¡Œ`;
    ol.innerHTML = itemsToShow.map(it=>{
      const name = `q_${it.idx}`;
      let body = '';
      if(it.type==='TRUEFALSE'){
        const opts = ['True','False'];
        body = opts.map((op,i)=>`<label style="margin-right:10px"><input type="radio" name="${name}" value="${op}"> ${op}</label>`).join('');
      }else if(it.type==='CLOZE'){
        body = `<input type="text" name="${name}" style="width:280px" placeholder="è¼¸å…¥ç­”æ¡ˆ">`;
      }else{
        body = (it.options||[]).map((op,i)=>`<div><label><input type="radio" name="${name}" value="${esc(op)}"> ${esc(op)}</label></div>`).join('');
      }
      const jaBlock = it.ja ? [
        it.ja.question ? `<div class="muted" style="margin-top:4px">ã€æ—¥ã€‘${esc(it.ja.question)}</div>` : '',
        (it.ja.options && it.ja.options.length) ? `<div class="muted" style="margin-top:2px">${it.ja.options.map(o=>`ãƒ»${esc(o)}`).join('<br>')}</div>` : '',
        it.ja.explanation ? `<div class="muted" style="margin-top:4px">è§£èªªï¼ˆæ—¥ï¼‰ï¼š${esc(it.ja.explanation)}</div>` : ''
      ].join('') : '';
      return `<li data-i="${it.idx}" style="padding:8px 0">
        <div style="font-weight:700">${esc(it.question)}</div>
        ${jaBlock}
        <div style="margin-top:6px">${body}</div>
        <div class="ans muted" data-ans="${esc(String(it.answer??''))}" style="display:none;margin-top:6px">ç­”æ¡ˆï¼š${esc(String(it.answer??''))}${it.explanation?`ï¼Œ${esc(it.explanation)}`:''}</div>
      </li>`;
    }).join('');
  }

  // initial render + filters
  render(items);
  filters.forEach(btn=>btn.addEventListener('click',()=>{
    const sec = btn.dataset.sec;
    const subset = (sec==='all') ? items : items.filter(x=>x.section===sec);
    render(subset);
  }));

  // actions
  document.getElementById('btnShowAnswer')?.addEventListener('click',()=>{
    $$('#quizList .ans').forEach(el=>el.style.display='block');
  });
  document.getElementById('btnSubmitQuiz')?.addEventListener('click',()=>{
    let score=0,total=0;
    $$('#quizList > li').forEach(li=>{
      const ans = li.querySelector('.ans')?.dataset?.ans ?? '';
      const radios = li.querySelectorAll('input[type="radio"]');
      const text = li.querySelector('input[type="text"]');
      let user='';
      if(radios.length){
        const chosen = [...radios].find(r=>r.checked);
        if(chosen) user = chosen.value;
      }else if(text){
        user = text.value.trim();
      }
      if(String(ans).toLowerCase() === String(user).toLowerCase()) score++;
      total++;
    });
    document.getElementById('quizScore').textContent = `å¾—åˆ†ï¼š${score} / ${total}`;
  });
  document.getElementById('btnPrint')?.addEventListener('click',()=>window.print());
}
/* ---------- controls ---------- */
const videoEl = document.getElementById('player');
speedRange.addEventListener('input',()=>{ const r=Number(speedRange.value)||1; videoEl.playbackRate=r; speedVal.textContent=`${r.toFixed(2)}x`; });
btnPlay.addEventListener('click',()=>{ if(videoEl.paused) videoEl.play(); else videoEl.pause(); });
function currentIndex(){ const t=videoEl.currentTime+offset; let i=0; while(i+1<cues.length&&cues[i+1].t<=t+0.0001)i++; return i; }

function highlightRow(idx){
  const trs = $$('#cuesBody tr');
  trs.forEach(tr => tr.classList.remove('active'));
  const tr = trs[idx]; if (!tr) return;
  tr.classList.add('active');
  if (chkFollow.checked){
    const container = document.getElementById('pane-sub');
    if (container){
      const targetTop = tr.offsetTop - container.clientHeight/2 + tr.offsetHeight/2;
      container.scrollTo({ top: Math.max(0, targetTop), behavior: 'smooth' });
    }
  }
}

function seekTo(idx,play=true){ if(!cues[idx])return; videoEl.currentTime=Math.max(0,cues[idx].t-offset+0.0001); highlightRow(idx); if(play) videoEl.play(); }
function sentenceRange(i){ if(!cues[i])return[0,0]; const s=cues[i].t,e=(i+1<cues.length?cues[i+1].t:s+3); return[s,e]; }
btnPrev.addEventListener('click',()=>seekTo(Math.max(0,currentIndex()-1),true));
btnNext.addEventListener('click',()=>seekTo(Math.min(cues.length-1,currentIndex()+1),true));
(function(){ const btn=btnReplay; const on=()=>{btn.dataset.active='1';btn.classList.add('blue')}; const off=()=>{btn.dataset.active='0';btn.classList.remove('blue');loopSentence=false}; off(); btn.addEventListener('click',function(e){ const isOn=btn.dataset.active==='1'; if(isOn){ e.stopImmediatePropagation(); window.player.clearRepeat(); off(); return; } loopSentence=true; on(); seekTo(currentIndex(),true); },true); })();
btnOffsetMinus.addEventListener('click',()=>setOffset(offset-0.5));
btnOffsetPlus .addEventListener('click',()=>setOffset(offset+0.5));
videoEl.addEventListener('timeupdate',()=>{ if(!cues.length)return; const i=currentIndex(); highlightRow(i); if(loopSentence){ const [s,e]=sentenceRange(i); const t=videoEl.currentTime+offset; if(t>=e-0.02){ videoEl.currentTime=Math.max(0,s-offset+0.0001); videoEl.play(); } } });

function showTab(name){
  paneSub.style.display=name==='sub'?'':'none';
  paneQuiz.style.display=name==='quiz'?'':'none';
  paneVocab.style.display=name==='vocab'?'':'none';
  $('#pane-ai').style.display = name==='ai' ? '' : 'none';
  $$('.tabs .tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===name));
  if(['sub','quiz','vocab','ai'].includes(name)){ document.body.classList.add('at-right'); $('#track').scrollTo({left:$('#track').clientWidth,behavior:'smooth'}); }
}
$$('.tabs .tab').forEach(t=>t.addEventListener('click',()=>showTab(t.dataset.tab)));

/* ---------- tiny AI demo cosmetics ---------- */
(function(){
  const prog = document.getElementById('aiProgress');
  const replyEl = document.getElementById('aiReply');
  function refresh(i=0,total=0){ if(prog) prog.textContent=`ç¬¬ ${total?i+1:0}/${total} é¡Œ`; }
  document.getElementById('aiDemo')?.addEventListener('click',()=>{
    const text = 'The Mid-Autumn Festival is celebrated on the 15th day of the eighth lunar month.';
    replyEl.textContent = text;
    refresh(0,10);
  });
  document.getElementById('aiDemoTts')?.addEventListener('click',()=>{
    try{ const u=new SpeechSynthesisUtterance(replyEl.textContent||''); u.lang='en-US'; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch{}
  });
  refresh();
})();





/* ---------- AI pane loader (EN/JA/ZH switchable) ---------- */
async function loadAI(){
  const pane = document.getElementById('pane-ai');
  if(!pane) return;

  const BASE = '/EduEnglish';
  const sel = document.getElementById('aiTopic');
  const promptBox = document.getElementById('aiPrompt');
  const hintEl = document.getElementById('aiHint');
  const replyEl = document.getElementById('aiReply');
  const prog = document.getElementById('aiProgress');
  const autoNext = document.getElementById('aiAutoNext');
  const btnPrev = document.getElementById('btnPrevTopic');
  const btnNext = document.getElementById('btnNextTopic');
  const btnTts  = document.getElementById('btnTts');
  const btnDemo = document.getElementById('aiDemo');
  const btnDemoTts = document.getElementById('aiDemoTts');
  const btnRec  = document.getElementById('btnRec');
  const btnStop = document.getElementById('btnStop');

  // Language bar (EN / JA / ZH)
  let langBar = document.getElementById('aiLangBar');
  if(!langBar){
    langBar = document.createElement('div');
    langBar.id = 'aiLangBar';
    langBar.style.display = 'inline-flex';
    langBar.style.gap = '8px';
    langBar.style.marginLeft = '8px';
    const makeBtn = (id, label)=>{
      const b=document.createElement('button'); b.id=id; b.textContent=label;
      b.className='px-2 py-1 rounded border';
      b.style.background = 'rgba(255,255,255,0.06)';
      b.style.borderColor = 'rgba(255,255,255,0.2)';
      b.style.cursor='pointer';
      return b;
    };
    const bEN=makeBtn('aiLangEn','EN');
    const bJA=makeBtn('aiLangJa','JA');
    const bZH=makeBtn('aiLangZh','ZH');
    langBar.appendChild(bEN); langBar.appendChild(bJA); langBar.appendChild(bZH);
    (sel?.parentElement||pane).insertBefore(langBar, (sel?.nextSibling)||null);
  }

  function tts(text, lang){ try{ const u=new SpeechSynthesisUtterance(text||''); u.lang=lang||'en-US'; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch{} }

  const url = `${BASE}/data/${cat}/${primarySlug}/ai-${primarySlug}.json?v=${Date.now()}`;
  let data = null;
  try { const r = await fetch(url,{cache:'no-store'}); if(r.ok){ data = await r.json(); } } catch(e){}

  // normalize to flat list
  let items = [];
  if (Array.isArray(data)) {
    items = data;
  } else if (data && (data.items || data.questions)) {
    items = data.items || data.questions || [];
  } else if (data && data.sections) {
    items = Object.values(data.sections).flat().filter(Boolean);
  } else if (data && Array.isArray(data.topics)) {
    items = data.topics.map(t=>({ title: t.title, prompt: t.prompt||t.question, hint: t.hint, sample: t.sample||t.answer, ja: t.ja, zh: t.zh }));
  }

  // common shape; preserve nested ja/zh
  items = (items||[]).map(x=>({
    title: x.title || x.topic || x.section || x.name || 'Topic',
    prompt: x.prompt || x.question || x.q || '',
    hint: x.hint || x.keywords || '',
    sample: x.sample || x.answer || x.demo || '',
    ja: (typeof x.ja==='object') ? x.ja : null,
    zh: (typeof x.zh==='object') ? x.zh : null
  })).filter(x=>x.prompt || (x.ja && (x.ja.prompt||x.ja.sample)) || (x.zh && (x.zh.prompt||x.zh.sample)));

  if(!items.length){
    prog.textContent = 'ç¬¬ 0/0 é¡Œ';
    sel.innerHTML = `<option value="">No AI dataset</option>`;
    btnPrev.disabled = btnNext.disabled = true;
    return;
  }

  // language state
  let lang = 'en'; // 'en' | 'ja' | 'zh'
  const langEnBtn = document.getElementById('aiLangEn');
  const langJaBtn = document.getElementById('aiLangJa');
  const langZhBtn = document.getElementById('aiLangZh');
  function paintLang(){
    const on = (b)=>{ if(b) b.style.opacity='1'; };
    const off= (b)=>{ if(b) b.style.opacity='0.6'; };
    off(langEnBtn); off(langJaBtn); off(langZhBtn);
    if(lang==='en') on(langEnBtn);
    if(lang==='ja') on(langJaBtn);
    if(lang==='zh') on(langZhBtn);
  }
  langEnBtn?.addEventListener('click',()=>{ lang='en'; paintLang(); show(); });
  langJaBtn?.addEventListener('click',()=>{ lang='ja'; paintLang(); show(); });
  langZhBtn?.addEventListener('click',()=>{ lang='zh'; paintLang(); show(); });
  paintLang();

  // Populate dropdown
  sel.innerHTML = items.map((it,i)=>`<option value="${i}">${(it.title||'Topic')}${items.length>1?` #${i+1}`:''}</option>`).join('');
  let idx = 0;

  function textFor(it, field){
    if(lang==='ja' && it.ja && it.ja[field]) return it.ja[field];
    if(lang==='zh' && it.zh && it.zh[field]) return it.zh[field];
    if(field==='prompt') return it.prompt || '';
    if(field==='hint') return it.hint || '';
    if(field==='sample') return it.sample || '';
    return '';
  }

  function show(){
    const total = items.length;
    const it = items[idx];
    sel.value = String(idx);
    promptBox.value = textFor(it,'prompt');
    const hint = textFor(it,'hint');
    hintEl.textContent = hint || 'â€”';
    const sample = textFor(it,'sample');
    replyEl.textContent = sample || 'ï¼ˆç­‰å¾…ä½ çš„ä½œç­”â€¦ï¼‰';
    prog.textContent = `ç¬¬ ${idx+1}/${total} é¡Œ`;
    btnPrev.disabled = btnNext.disabled = (total<=1);
  }

  sel.addEventListener('change',()=>{
    const v = Number(sel.value);
    if(!Number.isNaN(v)) { idx = Math.max(0, Math.min(items.length-1, v)); show(); }
  });
  btnPrev.addEventListener('click',()=>{ idx = (idx - 1 + items.length) % items.length; show(); });
  btnNext.addEventListener('click',()=>{ idx = (idx + 1) % items.length; show(); });

  const ttsLocale = (lang==='ja') ? 'ja-JP' : (lang==='zh' ? 'zh-TW' : 'en-US');
  btnTts.addEventListener('click',()=>tts(promptBox.value||'', (lang==='ja')?'ja-JP':(lang==='zh'?'zh-TW':'en-US')));
  btnDemo?.addEventListener('click',()=>{
    const it = items[idx] || {};
    replyEl.textContent = textFor(it,'sample') || replyEl.textContent || '';
  });
  btnDemoTts?.addEventListener('click',()=>tts(replyEl.textContent||'', (lang==='ja')?'ja-JP':(lang==='zh'?'zh-TW':'en-US')));

  // speech recognition with language
  let rec=null;
  try{
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(SR){
      rec = new SR();
      rec.interimResults = false;
      rec.continuous = false;
      const setRecLang = ()=>{ rec.lang = (lang==='ja') ? 'ja-JP' : (lang==='zh' ? 'zh-TW' : 'en-US'); };
      setRecLang();
      rec.onresult = (ev)=>{
        const text = Array.from(ev.results).map(r=>r[0].transcript).join(' ');
        replyEl.textContent = text;
        if(autoNext.checked){ btnNext.click(); }
      };
      rec.onend = ()=>{ btnRec.disabled=false; btnStop.disabled=true; };
      btnRec.addEventListener('click',()=>{ try{ setRecLang(); btnRec.disabled=true; btnStop.disabled=false; rec.start(); }catch{} });
      btnStop.addEventListener('click',()=>{ try{ rec.stop(); }catch{} });
    }else{
      btnRec.disabled = btnStop.disabled = true;
    }
  }catch(e){
    btnRec.disabled = btnStop.disabled = true;
  }

  show();
}




/* ---------- init ---------- */
(async function init(){
  const saved=localStorage.getItem(`offset:${slug}`); if(saved!=null) setOffset(parseFloat(saved)); else setOffset(0);
  const r=Number(speedRange.value)||1; videoEl.playbackRate=r; speedVal.textContent=`${r.toFixed(2)}x`;
  await loadVideo(); await loadCues(); await loadQuiz(); await loadVocab(); await loadAI();
  showTab('sub');
})();
</script>

<script type="module">
import { supabase } from '/EduEnglish/supa.js?v=20251018';
const { data: authData } = await supabase.auth.getUser();
if (!authData?.user) {
  alert('è«‹å…ˆç™»å…¥å¾Œå†çœ‹å½±ç‰‡ã€‚');
  location.href = '/EduEnglish/index.html';
} else {
  const user = authData.user;
  document.getElementById('userNameBadge').textContent = user.email || '';
  const videoSlug = new URLSearchParams(location.search).get('slug') || 'mid-autumn';
  try { await supabase.from('watch_logs').insert({ user_id: user.id, email: user.email, video_slug: videoSlug }); } catch {}
  let once=false;
  document.getElementById('player')?.addEventListener('play', async ()=>{
    if(once) return; once=true;
    try { await supabase.from('watch_logs').insert({ user_id: user.id, email: user.email, video_slug: videoSlug }); } catch {}
  }, { once:true });
}
</script>
</body>
</html>














































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































