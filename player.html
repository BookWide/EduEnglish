<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BookWide Player Â· Slim v2</title>
<style>
:root{
  --bg:#0f172a; --panel:#111827; --muted:#334155; --text:#e5e7eb; --accent:#38bdf8;
  --tab:#1f2937; --badge:#0ea5e9; --good:#22c55e; --bad:#ef4444;
  --h:56px;     /* é ‚éƒ¨å›ºå®šé«˜åº¦ */
  --f:64px;     /* åº•éƒ¨å·¥å…·åˆ—é«˜åº¦ */
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto}
a{color:inherit}

/* é ‚æ¬„å›ºå®š */
.header{
  position:fixed; inset:0 0 auto 0; height:var(--h);
  background:#0b1220; border-bottom:1px solid #1f2937;
  display:flex; align-items:center; gap:12px; padding:0 16px; z-index:30;
}
.header .title{font-weight:700}
.header .chip{padding:4px 10px; background:#0b2a3b; border:1px solid #1f3750; border-radius:10px; font-size:12px}

/* ä¸»å€åŸŸ 50:50 */
.main{
  position:fixed; inset:var(--h) 0 var(--f) 0; display:flex; gap:8px; padding:8px;
}
.left,.right{flex:1; min-width:0; background:var(--panel); border:1px solid #1f2937; border-radius:10px; overflow:hidden}
.left{display:flex; align-items:center; justify-content:center; position:relative}

/* å½±ç‰‡å¡«æ»¿å®¹å™¨ï¼ˆç¶­æŒæ¯”ä¾‹ï¼‰ */
#player{width:100%; height:100%; object-fit:contain; background:black}

/* å³å´åˆ†é  */
.tabs{display:flex; background:#0d1424; border-bottom:1px solid #1f2937}
.tab{padding:12px 16px; cursor:pointer; user-select:none}
.tab.active{background:#12203a;color:#fff;border-bottom:2px solid var(--accent)}
.panes{position:absolute; inset:48px 0 0 0; overflow:auto; padding:10px}
.pane{display:none}
.pane.active{display:block}

/* å­—å¹•åˆ—è¡¨ */
.cue{padding:10px 12px; border-bottom:1px dashed #1f2937; cursor:pointer}
.cue:hover{background:#0f2336}
.cue.active{background:#143250; border-left:3px solid var(--accent)}
.cue .zh{opacity:.8; margin-top:6px; font-size:14px}

/* åº•éƒ¨å·¥å…·åˆ—ï¼ˆå›ºå®šï¼‰ */
.footer{
  position:fixed; inset:auto 0 0 0; height:var(--f);
  background:#0b1220; border-top:1px solid #1f2937;
  display:flex; align-items:center; gap:8px; padding:8px 12px; z-index:20;
}
.btn{background:#101826;border:1px solid #23324a;color:#e5e7eb;padding:8px 10px;border-radius:8px;cursor:pointer}
.btn:disabled{opacity:.5;cursor:not-allowed}
.switch{display:flex;align-items:center;gap:6px}
.range{width:220px}

/* æ¸¬é©—å€ â€“ é¡åˆ¥ pill */
.qnav{display:flex;gap:8px;margin:6px 0 12px 0;flex-wrap:wrap}
.qpill{background:#0d1a2b;border:1px solid #22324a;padding:6px 10px;border-radius:999px;cursor:pointer}
.qpill.active{background:#12365a;border-color:#1d9ad6}

/* é¡Œç›® */
.q{padding:12px 10px;border-bottom:1px dashed #243145}
.q .q-title{margin:4px 0 10px 0}
.q .opt{display:flex;gap:8px;align-items:center;margin:8px 0}
.q input[type=radio]{transform:scale(1.1)}
.q .exp{margin-top:6px;color:#9ca3af}
.scorebar{margin-top:10px}

/* å–®å­— */
.vocab-item{padding:10px;border-bottom:1px dashed #243145}
.vocab-word{font-weight:700}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#0e2a3b;border:1px solid #1e3a5a;margin-left:6px;font-size:12px}

/* AI */
.ai-topic{padding:10px;border-bottom:1px dashed #243145}

/* åˆ—å°ï¼šå±•é–‹å³å´ï¼ˆå°æ¸¬é©—/å­—å¹•/å–®å­—/AIï¼‰ï¼Œéš±è—å½±ç‰‡èˆ‡å·¥å…·åˆ— */
@media print{
  .header{position:static}
  .main{position:static; display:block; padding:0}
  .left{display:none}
  .right{position:static; height:auto}
  .panes{position:static; overflow:visible}
  .footer{display:none}
}
</style>
</head>
<body>

<!-- é ‚éƒ¨å›ºå®š -->
<div class="header">
  <div class="title">BookWide Player Â· Slim v2</div>
  <div id="chipCat" class="chip">cat=</div>
  <div id="chipSlug" class="chip">slug=</div>
</div>

<!-- ä¸»å…§å®¹ï¼šå·¦å½±ç‰‡ / å³åˆ†é  -->
<div class="main">
  <section class="left">
    <video id="player" controls playsinline></video>
  </section>

  <section class="right" id="right">
    <div class="tabs">
      <div class="tab active" data-pane="subs">å­—å¹•</div>
      <div class="tab" data-pane="quiz">æ¸¬é©—</div>
      <div class="tab" data-pane="vocab">å–®å­—</div>
      <div class="tab" data-pane="ai">AI äº’å‹•</div>
    </div>
    <div class="panes">
      <div id="pane-subs" class="pane active">
        <div id="cues"></div>
      </div>
      <div id="pane-quiz" class="pane">
        <div class="qnav" id="qnav"></div>
        <div id="quizWrap"></div>
        <div class="scorebar">
          <button class="btn" id="btnSubmit">äº¤å·</button>
          <button class="btn" id="btnReveal">é¡¯ç¤ºç­”æ¡ˆ</button>
          <button class="btn" id="btnPrint" onclick="window.print()">åˆ—å°æˆç¸¾å–®</button>
          <span id="scoreText"></span>
        </div>
      </div>
      <div id="pane-vocab" class="pane">
        <div id="vocabWrap"></div>
      </div>
      <div id="pane-ai" class="pane">
        <div id="aiWrap"><span class="badge">æš«ç„¡ AI è³‡æ–™</span></div>
      </div>
    </div>
  </section>
</div>

<!-- åº•éƒ¨å·¥å…·åˆ—ï¼ˆå›ºå®šï¼‰ -->
<div class="footer">
  <button id="btnPrev" class="btn">ä¸Šä¸€å¥</button>
  <button id="btnPlay" class="btn">æ’­æ”¾ / æš«åœ</button>
  <button id="btnNext" class="btn">ä¸‹ä¸€å¥</button>
  <button id="btnRepeat" class="btn">é‡è¤‡æœ¬å¥</button>

  <label class="switch"><input id="chkFollow" type="checkbox" checked> è·Ÿéš¨</label>

  <button id="btnOffM" class="btn">åç§» -0.5s</button>
  <button id="btnOffP" class="btn">+0.5s</button>

  <label class="switch">é€Ÿåº¦
    <input id="rate" class="range" type="range" min="0.5" max="1.75" step="0.05" value="1">
  </label>

  <button id="btnAlign" class="btn">ç°¡æ˜“æ ¡æº–</button>
  <button id="btnSpeak" class="btn">ğŸ”ˆ æœ—è®€</button>
</div>

<script>
/* ------------------- å·¥å…· ------------------- */
const $ = sel => document.querySelector(sel);
const elVideo = $('#player');
const elCues  = $('#cues');

const url = new URL(location.href);
const cat  = (url.searchParams.get('cat')  || 'story').toLowerCase();
const slug = (url.searchParams.get('slug') || 'mid-autumn').toLowerCase();
$('#chipCat').textContent  = 'cat=' + cat;
$('#chipSlug').textContent = 'slug=' + slug;

const DATA = `./data/${cat}`;
const VIDEO = `./videos/${cat}/${slug}.mp4`;
const PATHS = {
  cues:  `${DATA}/cues-${slug}.json`,
  quiz:  `${DATA}/quiz-${slug}.json`,
  vocab: `${DATA}/vocab-${slug}.json`,
  ai:    `${DATA}/ai-${slug}.json`
};
const sleep = ms => new Promise(r=>setTimeout(r,ms));
async function fetchJSON(p){ const r=await fetch(p,{cache:'no-store'}); if(!r.ok) throw new Error(p); return r.json(); }

/* ------------------- è¼‰å…¥å½±ç‰‡ ------------------- */
function loadVideo(){
  elVideo.src = VIDEO;
  elVideo.playbackRate = +$('#rate').value;
  elVideo.addEventListener('ratechange',()=>$('#rate').value=elVideo.playbackRate);
}

/* ------------------- å­—å¹• ------------------- */
let cues = [];       // [{start,end,en,zh}]
let activeIdx = -1;
let offset = 0;

function renderCues(){
  elCues.innerHTML = cues.map((c,i)=>`
    <div class="cue" data-i="${i}">
      <div class="en">${c.en||''}</div>
      <div class="zh">${c.zh||''}</div>
    </div>`).join('');
  elCues.querySelectorAll('.cue').forEach(div=>{
    div.addEventListener('click',()=>{
      const i = +div.dataset.i;
      elVideo.currentTime = (cues[i].start + offset);
      elVideo.play();
    });
  });
}
function tick(){
  const t = elVideo.currentTime - offset;
  const i = cues.findIndex(c => t>=c.start && t<c.end);
  if(i!==-1 && i!==activeIdx){
    activeIdx = i;
    if($('#chkFollow').checked){
      const item = elCues.children[i];
      if(item){
        [...elCues.children].forEach(n=>n.classList.remove('active'));
        item.classList.add('active');
        item.scrollIntoView({block:'center',behavior:'smooth'});
      }
    }
  }
  requestAnimationFrame(tick);
}

/* æ§åˆ¶éˆ• */
$('#btnPrev').onclick = ()=> {
  if(!cues.length) return;
  const t = elVideo.currentTime - offset;
  let i = cues.findIndex(c => t>c.start) - 1;
  if(i<0) i = 0;
  elVideo.currentTime = (cues[i].start + offset);
};
$('#btnNext').onclick = ()=> {
  if(!cues.length) return;
  const t = elVideo.currentTime - offset;
  let i = cues.findIndex(c => t<c.end);
  if(i<0) i = cues.length-1;
  elVideo.currentTime = (cues[i].start + offset);
};
$('#btnPlay').onclick = ()=> elVideo.paused ? elVideo.play() : elVideo.pause();
$('#btnRepeat').onclick = ()=> {
  if(activeIdx<0) return;
  elVideo.currentTime = cues[activeIdx].start + offset;
  elVideo.play();
};
$('#btnOffM').onclick = ()=> { offset -= 0.5; toastOffset(); };
$('#btnOffP').onclick = ()=> { offset += 0.5; toastOffset(); };
$('#rate').oninput = e => elVideo.playbackRate = +e.target.value;
$('#btnAlign').onclick = ()=> { if(activeIdx>=0) elVideo.currentTime = cues[activeIdx].start + offset; };
function toastOffset(){ console.log('[offset]', offset.toFixed(2)); }

/* æœ—è®€è‹±å¥ï¼ˆWeb Speechï¼‰ */
$('#btnSpeak').onclick = ()=>{
  if(activeIdx<0) return;
  const s = (cues[activeIdx].en || '').replace(/\s+/g,' ').trim();
  if(!('speechSynthesis' in window) || !s) return;
  const u = new SpeechSynthesisUtterance(s);
  u.lang='en-US'; u.rate=1.0; u.pitch=1.0;
  speechSynthesis.cancel(); speechSynthesis.speak(u);
};

/* ------------------- æ¸¬é©— ------------------- */
let quiz = [];      // [{section,type,question,options?,answer,explanation?}]
let sectionOrder = ['Vocabulary','Grammar','Reading','Mixed'];
let answers = new Map(); // key -> selected value
function renderQuiz(){
  if(!quiz.length){ $('#quizWrap').innerHTML='<span class="badge">æš«ç„¡é¡Œåº«</span>'; return; }

  const bySec = Object.fromEntries(sectionOrder.map(s=>[s,[]]));
  quiz.forEach(q => (bySec[q.section]||bySec['Mixed']).push(q));

  // é¡åˆ¥ pill
  $('#qnav').innerHTML = sectionOrder.map((s,i)=>`
    <div class="qpill ${i===0?'active':''}" data-sec="${s}">${s} (${bySec[s].length})</div>`).join('');
  $('#qnav').querySelectorAll('.qpill').forEach(p=>{
    p.onclick = ()=>{
      $('#qnav').querySelectorAll('.qpill').forEach(x=>x.classList.remove('active'));
      p.classList.add('active');
      showSection(p.dataset.sec);
    };
  });
  showSection(sectionOrder[0]);

  $('#btnSubmit').onclick = submitQuiz;
  $('#btnReveal').onclick = revealQuiz;

  function showSection(sec){
    const list = bySec[sec];
    $('#quizWrap').innerHTML = list.map((q,idx)=>{
      const key = `${sec}-${idx}`;
      if(q.type==='MCQ'){
        const opts = q.options.map((o,j)=>`
          <label class="opt"><input type="radio" name="${key}" value="${o}"> ${o}</label>`).join('');
        return `<div class="q" data-key="${key}" data-ans="${q.answer}">
          <div class="q-title">${q.question}</div>${opts}
          <div class="exp" hidden>æ­£è§£ï¼š${q.answer}${q.explanation?`ï¼Œ${q.explanation}`:''}</div>
        </div>`;
      }else{ // SA
        return `<div class="q" data-key="${key}" data-ans="${q.answer}">
          <div class="q-title">${q.question}</div>
          <div class="opt">
            <input type="text" style="width:60%" placeholder="è¼¸å…¥ç­”æ¡ˆâ€¦">
            <button class="btn btnCheck">æª¢æŸ¥</button>
          </div>
          <div class="exp" hidden>æ­£è§£ï¼š${q.answer}${q.explanation?`ï¼Œ${q.explanation}`:''}</div>
        </div>`;
      }
    }).join('');

    // ç¶äº‹ä»¶
    $('#quizWrap').querySelectorAll('.q').forEach(qel=>{
      const key=qel.dataset.key, ans=qel.dataset.ans;
      const radios=qel.querySelectorAll('input[type=radio]');
      radios.forEach(r=>r.onchange=()=>answers.set(key,r.value));
      const btn=qel.querySelector('.btnCheck');
      if(btn){ btn.onclick=()=>{
        const v=qel.querySelector('input[type=text]').value.trim();
        answers.set(key,v);
        qel.querySelector('.exp').hidden=false;
      } }
    });
  }

  function submitQuiz(){
    let total=0, got=0;
    $('#quizWrap').querySelectorAll('.q').forEach(q=>{
      total++;
      const key=q.dataset.key, ans=q.dataset.ans;
      const val=answers.get(key);
      const ok = String(val||'').toLowerCase().trim() === String(ans||'').toLowerCase().trim();
      if(ok) got++;
      q.querySelector('.exp').hidden=false;
      q.style.outline = ok ? '2px solid var(--good)' : '2px solid var(--bad)';
    });
    const score = Math.round((got/total)*100);
    $('#scoreText').textContent = `æœ¬åˆ†å€åˆ†æ•¸ï¼š${score} / 100`;
  }
  function revealQuiz(){
    $('#quizWrap').querySelectorAll('.q .exp').forEach(e=>e.hidden=false);
  }
}

/* ------------------- å–®å­— ------------------- */
function renderVocab(list){
  if(!list?.length){ $('#vocabWrap').innerHTML='<span class="badge">æš«ç„¡å–®å­—</span>'; return; }
  $('#vocabWrap').innerHTML = list.map(v=>{
    const badge = v.pos ? `<span class="badge">${v.pos}</span>`:'';
    return `<div class="vocab-item">
      <div class="vocab-word">${v.word}${badge}</div>
      ${v.def?`<div class="zh">${v.def}</div>`:''}
      ${v.example?`<div class="exp">ä¾‹ï¼š${v.example}</div>`:''}
    </div>`;
  }).join('');
}

/* ------------------- AI äº’å‹• ------------------- */
function renderAI(data){
  if(!data?.topics?.length){ return; }
  $('#aiWrap').innerHTML = `
    <div style="margin:6px 0;">
      <select id="aiSel" class="btn">${data.topics.map((t,i)=>`<option value="${i}">${t.title||('Topic '+(i+1))}</option>`).join('')}</select>
      <button id="aiPrev" class="btn">â¬… ä¸Šä¸€é¡Œ</button>
      <button id="aiNext" class="btn">ä¸‹ä¸€é¡Œ â¡</button>
      <label class="switch"><input id="aiAuto" type="checkbox" checked> ä½œç­”å¾Œè‡ªå‹•ä¸‹ä¸€é¡Œ</label>
      <button id="aiSpeakQ" class="btn">ğŸ”ˆ æœ—è®€é¡Œç›®</button>
    </div>
    <div>é¡Œç›®ï¼š</div>
    <textarea id="aiQ" style="width:100%;height:90px"></textarea>
    <div class="exp" id="aiHint"></div>
    <div style="margin-top:8px">AI ç¤ºç¯„ï¼š</div>
    <div id="aiSample" class="q"></div>
  `;
  let idx=0;
  const apply=()=>{
    const t = data.topics[idx];
    $('#aiSel').value = idx;
    $('#aiQ').value = t.prompt||'';
    $('#aiHint').textContent = (t.hint||'');
    $('#aiSample').textContent = (t.sample||'');
  };
  $('#aiSel').onchange = e=>{ idx=+e.target.value; apply(); };
  $('#aiPrev').onclick = ()=>{ idx=(idx-1+data.topics.length)%data.topics.length; apply(); };
  $('#aiNext').onclick = ()=>{ idx=(idx+1)%data.topics.length; apply(); };
  $('#aiSpeakQ').onclick = ()=>{
    const s=$('#aiQ').value.trim(); if(!s||!('speechSynthesis' in window)) return;
    const u=new SpeechSynthesisUtterance(s); u.lang='en-US'; speechSynthesis.cancel(); speechSynthesis.speak(u);
  };
  apply();
}

/* ------------------- åˆ†é åˆ‡æ› ------------------- */
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.pane').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    document.querySelector('#pane-'+t.dataset.pane).classList.add('active');
  };
});

/* ------------------- å•Ÿå‹• ------------------- */
async function boot(){
  // å¯é¸æ“‡æ›å›ä½ çš„å®ˆé–€è…³æœ¬
  if(typeof window.initGate==='function'){ try{ await window.initGate(); }catch(e){ console.warn('gate skip',e);} }

  // å½±ç‰‡
  loadVideo();

  // å­—å¹•
  try{
    const raw = await fetchJSON(PATHS.cues);
    if(Array.isArray(raw)){ cues = raw; renderCues(); requestAnimationFrame(tick); }
    else throw new Error('bad cues format');
  }catch(e){
    elCues.innerHTML = `<span class="badge">cues è¼‰å…¥å¤±æ•—æˆ–æ ¼å¼éŒ¯èª¤</span>`;
    console.warn('[cues] load fail', e);
  }

  // æ¸¬é©—
  try{
    quiz = await fetchJSON(PATHS.quiz);
    renderQuiz();
  }catch(e){
    $('#pane-quiz').innerHTML = `<span class="badge">æš«ç„¡é¡Œåº«</span>`;
  }

  // å–®å­—
  try{
    const v = await fetchJSON(PATHS.vocab);
    renderVocab(v);
  }catch(e){ /* ç„¡å–®å­—å¯å¿½ç•¥ */ }

  // AI
  try{
    const ai = await fetchJSON(PATHS.ai);
    renderAI(ai);
  }catch(e){ /* ç„¡ AI å¯å¿½ç•¥ */ }
}

if(document.readyState==='loading'){
  document.addEventListener('DOMContentLoaded', boot, {once:true});
}else boot();
</script>
</body>
</html>




















































