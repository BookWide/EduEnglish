<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BookWide · 英語影片播放器（clean 2025-11-01）</title>
<style>
:root{ --bg:#0b1324; --panel:#0f172a; --border:#1f2a44; --ink:#e6f0ff; --muted:#9fb0c9; --accent:#3c7cff; }
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,"Noto Sans TC"}
h1{font-size:20px;margin:0}
a{color:inherit}
.btn{background:#13233f;border:1px solid #24446f;border-radius:10px;padding:8px 12px;color:#fff;cursor:pointer}
.btn.blue{background:#14335f;border-color:#2c5aa3}
.btn[disabled]{opacity:.55;cursor:not-allowed}
.muted{color:var(--muted)}
header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:#0f172a;border-bottom:1px solid #0e203f}
.wrap{padding:16px;height:calc(100vh - 58px);}
.layout{height:100%;display:grid;grid-template-columns:1fr 1fr;gap:16px;overflow:hidden}
.left,.right{min-width:0;background:var(--panel);border:1px solid var(--border);border-radius:12px}
.left{display:flex;flex-direction:column;padding:14px}
.right{display:flex;flex-direction:column;overflow:auto;scrollbar-width:thin}
.right::-webkit-scrollbar{width:10px}
.right::-webkit-scrollbar-thumb{background:#556a9a;border-radius:6px}
.pane{flex:1;overflow:auto;-webkit-overflow-scrolling:touch}
.videoWrap{position:relative;width:100%;aspect-ratio:16/9;background:#000;border-radius:10px;overflow:hidden}
.videoWrap video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000}
.controls{margin-top:12px;background:#0e2038;border:1px solid #183459;border-radius:12px;padding:12px}
.controls .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:.25rem 0}
.speed{display:flex;align-items:center;gap:10px}
input[type="range"]{width:260px;accent-color:var(--accent)}
.chip{display:inline-flex;align-items:center;gap:6px;padding:7px 10px;border:1px solid #23446c;border-radius:10px;background:#10233d}
.tabs{display:flex;gap:8px;padding:6px 10px;margin:0 0 2px;border-bottom:1px solid var(--border)}
.tab{cursor:pointer;background:#122340;border:1px solid #1f375f;border-radius:12px;padding:10px 14px;font-weight:600}
.tab.active{background:#154274}
table{width:100%;border-collapse:collapse}
th,td{padding:10px 12px;border-bottom:1px solid #162a48;vertical-align:top}
tbody tr{background:#0f1f34}
tbody tr:nth-child(2n){background:#0d1a2b}
tbody tr:hover{background:#0f2a4e}
tr.active{background:#173a6e}
.cues-table{table-layout:fixed}
.cue-time{width:64px;min-width:64px;color:rgba(255,255,255,.7);font-family:ui-monospace,Consolas,monospace;white-space:nowrap}
.cue-en{line-height:1.6;word-break:break-word}
.cue-en .zh-line{margin-top:6px;opacity:.9}
.cue-zh{display:none !important}

/* 小寬度裝置：左右兩頁水平分頁（不限定轉向） */
@media (max-width:960px){
  #track{ display:flex; gap:0; overflow-x:auto; overflow-y:hidden; scroll-snap-type:x mandatory; scroll-behavior:smooth; overscroll-behavior-x:contain; overscroll-behavior-y:none; touch-action:pan-x; -webkit-overflow-scrolling:touch; }
  .page{ flex:0 0 100vw; max-width:100vw; height:calc(100vh - 58px); scroll-snap-align:start; overflow-y:auto; overscroll-behavior-y:contain; -webkit-overflow-scrolling:touch; }
  .page > .left, .page > .right{ width:100%; max-width:100%; border-radius:0; border-left:0; border-right:0; }
  #btnExitFocus{ position:fixed; right:16px; bottom:16px; z-index:10020; display:none;
    padding:8px 12px; border-radius:10px; border:1px solid rgba(100,116,139,.5); background:#0f172a; color:#e6efff; }
  body.at-right #btnExitFocus{ display:inline-flex; }
}

/* 列印優化 */
@media print{
  html,body{ background:#fff !important; color:#000 !important; height:auto !important; overflow:visible !important; }
  header,.tabs,.controls,#authArea,.videoWrap,.left{ display:none !important; }
  .wrap{ padding:0 !important; }
  .layout{ display:block !important; height:auto !important; overflow:visible !important; }
  .right{ border:none !important; background:#fff !important; display:block !important; height:auto !important; }
  #pane-quiz,.pane{ height:auto !important; max-height:none !important; overflow:visible !important; display:block !important; }
  #quizList{ font-size:12.5pt; line-height:1.25; }
  #quizList > li{ break-inside:avoid; page-break-inside:avoid; padding:6px 0; margin:0 0 6px 0; border-bottom:1px dotted #ccc; }
  @page { margin:10mm 10mm 12mm 10mm; }
}

/* 輕量訊息條 */
.notice{padding:8px 12px;margin:8px 12px;border:1px solid #2b3f67;border-radius:8px;background:#0f223b}
.notice.err{border-color:#9b2c2c;background:#2a0e12;color:#ffd1d1}

/* -------------------- 可視化右側滾動條（A+B） -------------------- */
.right::-webkit-scrollbar {
  width: 12px;
  background: #0d172a;
}
.right::-webkit-scrollbar-thumb {
  background: linear-gradient(#739cff,#4169e1);
  border-radius: 8px;
  border: 2px solid #0d172a;
}
.right::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(#8cb3ff,#5883f1);
}

/* 可切換方案 B：固定浮動藍色滑桿 */
.scrollbar-wrap {
  position: relative;
  height: 100%;
  overflow: auto;
  overscroll-behavior-y: contain;
  -webkit-overflow-scrolling: touch;
}
.scrollbar-track {
  position: absolute;
  right: 0;
  top: 0;
  width: 12px;
  height: 100%;
  background: rgba(255,255,255,0.05);
  border-left: 1px solid rgba(255,255,255,0.1);
}
.scrollbar-thumb {
  position: absolute;
  right: 2px;
  width: 8px;
  border-radius: 4px;
  background: #3c7cff;
  opacity: 0.8;
  cursor: grab;
}


.scrollbar-content {
  height: 100%;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

</style>
</head>
<body>
<a id="backHome" href="/EduEnglish/index.html" style="position:fixed;left:16px;top:14px;z-index:10000;padding:6px 10px;border-radius:8px;background:#eef5ff;border:1px solid #c7ddff;color:#1b5eaa;text-decoration:none;font-weight:600;box-shadow:0 2px 6px rgba(0,0,0,.08)">← 回首頁</a>

<header>
  <h1>播放器</h1>
  <div id="authArea" style="display:flex;gap:10px;align-items:center">
    <span class="muted" id="userNameBadge"></span>
  </div>
</header>

<div class="wrap">
  <div id="track" class="layout">
    <section class="page" id="pageLeft">
      <section class="left" id="videoContainer">
        <div class="videoWrap"><video id="player" playsinline controls></video></div>
        <div class="controls">
          <div class="row">
            <button class="btn" id="btnPrev">⏮ 上一句</button>
            <button class="btn" id="btnPlay">▶️ 播放 / 暫停</button>
            <button class="btn" id="btnNext">⏭ 下一句</button>
            <button class="btn" id="btnReplay">🔁 重複本句</button>
          </div>
          <div class="row">
            <label class="chip"><input id="chkFollow" type="checkbox"/> 跟隨</label>
            <span class="chip">偏移 <span id="offsetVal">0.0s</span></span>
            <button class="btn" id="btnOffsetMinus">-0.5s</button>
            <button class="btn" id="btnOffsetPlus">+0.5s</button>
            <button class="btn" id="btnAutoSync">🧭 簡易校準</button>
          </div>
          <div class="row speed">
            <span class="muted">速度</span>
            <input id="speedRange" type="range" min="0.5" max="2" step="0.05" value="1"/>
            <span id="speedVal">1.00x</span>
          </div>
        </div>
      </section>
    </section>

    <section class="page" id="pageRight">
      <section class="right" id="studyContainer"><div class="scrollbar-wrap"><div class="scrollbar-content">
        <div class="tabs">
          <div class="tab active" data-tab="sub">字幕</div>
          <div class="tab" data-tab="quiz">測驗</div>
          <div class="tab" data-tab="vocab">單字</div>
          <div class="tab" data-tab="ai">AI互動</div>
        </div>

        <div class="pane" id="pane-sub">
          <div class="muted" id="cuesStatus" style="padding:10px 14px">（字幕載入中…）</div>
          <div id="cuesError" class="notice err" style="display:none"></div>
          <table class="cues-table">
            <thead><tr><th style="width:80px">時間</th><th>英文</th><th class="cue-zh" style="width:40%">中文</th></tr></thead>
            <tbody id="cuesBody"></tbody>
          </table>
        </div>

        <div class="pane" id="pane-quiz" style="display:none">
          <div class="quiz-shell">
            <div style="display:flex;gap:8px;align-items:center;padding:8px 12px 4px">
              <div id="quizFilters" class="filters">
                <button class="btn btn-sec" data-sec="all">單字</button>
                <button class="btn btn-sec" data-sec="Grammar">文法</button>
                <button class="btn btn-sec" data-sec="Reading">閱讀</button>
                <button class="btn btn-sec" data-sec="Mixed">綜合</button>
              </div>
              <div id="quizHeader" class="muted" style="margin-left:8px"></div>
            </div>
            <div class="muted" id="quizMeta" style="padding:8px 12px">（測驗載入中…）</div>
            <ol id="quizList" style="line-height:1.6;padding:0 12px"></ol>
            <div class="q-actions" style="margin:14px 12px 6px; display:flex; gap:8px; align-items:center;">
              <button class="btn" id="btnSubmitQuiz">交卷</button>
              <button class="btn" id="btnShowAnswer" >顯示答案</button>
              <button class="btn" id="btnPrint" >列印成績單</button>
              <span id="quizScore" style="margin-left:8px"></span>
            </div>
          </div>
        </div>

        <div class="pane" id="pane-vocab" style="display:none">
          <div class="muted" id="vocabStatus" style="padding:10px 14px">( 單字載入中… )</div>
          <div id="vocabBox" style="padding:0 14px 14px"></div>
        </div>

        <div class="pane" id="pane-ai" style="display:none">
          <div class="pane-ai" style="padding:10px">
            <div class="ai-row" style="margin:6px 0 10px">
              <span class="muted">允許麥克風後可進行口說練習（建議 Chrome / Edge）。網址帶 <code>?cat=story|music|movie|news|pro&slug=mid-autumn</code></span>
            </div>
            <div class="ai-row" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <select id="aiTopic" class="btn" style="min-width:200px"></select>
              <button id="btnPrevTopic" class="btn">◀ 上一題</button>
              <button id="btnNextTopic" class="btn">下一題 ▶</button>
              <button id="btnTts" class="btn">🔈 朗讀</button>
              <button id="btnRec" class="btn">🎙️ 開始說</button>
              <button id="btnStop" class="btn" disabled>⏹ 停止</button>
              <label style="font-size:13px;opacity:.9"><input id="aiAutoNext" type="checkbox"> 作答後自動下一題</label>
              <span id="aiProgress" class="muted">第 0/0 題</span>
            </div>
            <div class="ai-row" style="margin-top:6px">
              <textarea id="aiPrompt" rows="3" placeholder="題目會顯示在這裡…" readonly style="width:100%"></textarea>
            </div>
            <div class="ai-row" style="margin:6px 0 8px">
              <span class="muted">提示：<span id="aiHint">—</span></span>
            </div>
            <div style="margin:10px 0 6px;display:flex;gap:8px;align-items:center"><span style="opacity:.9">AI 示範：</span><button id="aiDemo" class="btn">示範句</button><button id="aiDemoTts" class="btn">朗讀</button></div>
            <div class="ai-row">
              <div class="ai-out" id="aiReply" style="min-height:54px;border:1px solid #223048;border-radius:10px;padding:10px">（等待你的作答…）</div>
            </div>
          </div>
        </div>

      </div></div></section>
    </section>
  </div>
</div>

<button id="btnExitFocus" class="btn" style="display:none">返回影片</button>

<script>
/* -------------------- 基本工具 -------------------- */
const $=(s,e=document)=>e.querySelector(s);
const $$=(s,e=document)=>[...e.querySelectorAll(s)];
const toSec=t=>{ if(typeof t==='number')return t; const p=String(t).split(':').map(Number);
  if(p.length===3)return p[0]*3600+p[1]*60+p[2]; if(p.length===2)return p[0]*60+p[1]; return Number(t)||0; };
const fmt=sec=>{ sec=Math.max(0,sec|0); const m=(sec/60)|0,s=sec%60; return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;}
const esc=s=>String(s??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');

const BASE='/EduEnglish';
const params=new URLSearchParams(location.search);
const cat=(params.get('cat')||'story').toLowerCase();
const primarySlug=params.get('slug')||'mid-autumn';
let slug=primarySlug;

/* -------------------- 元素快取 -------------------- */
const videoEl=$('#player');
const cuesBody=$('#cuesBody'), cuesStatus=$('#cuesStatus'), cuesError=$('#cuesError');
const btnPrev=$('#btnPrev'),btnPlay=$('#btnPlay'),btnNext=$('#btnNext'),btnReplay=$('#btnReplay');
const btnOffsetMinus=$('#btnOffsetMinus'),btnOffsetPlus=$('#btnOffsetPlus'),offsetVal=$('#offsetVal');
const chkFollow=$('#chkFollow'); const speedRange=$('#speedRange'),speedVal=$('#speedVal');
const btnPrint=$('#btnPrint'); const paneSub=$('#pane-sub'),paneQuiz=$('#pane-quiz'),paneVocab=$('#pane-vocab');

let cues=[]; let offset=0; let loopSentence=false;

/* -------------------- 通用取檔 -------------------- */
async function fetchData(kind){
  const list={
    video:[
      `${BASE}/videos/${cat}/${primarySlug}.mp4`,
      `${BASE}/videos/${primarySlug}.mp4`,
      `${BASE}/videos/story/mid-autumn.mp4`
    ],
    cues:[
      `${BASE}/data/${cat}/cues-${primarySlug}.json?v=${Date.now()}`,
      `${BASE}/data/cues-${primarySlug}.json?v=${Date.now()}`,
      `${BASE}/data/story/cues-mid-autumn.json?v=${Date.now()}`
    ],
    quiz:[
      `${BASE}/data/${cat}/quiz-${primarySlug}.json?v=${Date.now()}`,
      `${BASE}/data/quiz-${primarySlug}.json?v=${Date.now()}`,
      `${BASE}/data/story/quiz-mid-autumn.json?v=${Date.now()}`
    ],
    vocab:[
      `${BASE}/data/${cat}/vocab-${primarySlug}.json?v=${Date.now()}`,
      `${BASE}/data/vocab-${primarySlug}.json?v=${Date.now()}`,
      `${BASE}/data/story/vocab-mid-autumn.json?v=${Date.now()}`
    ],
    ai:[
      `${BASE}/data/${cat}/ai-${primarySlug}.json?v=${Date.now()}`,
      `${BASE}/data/ai-${primarySlug}.json?v=${Date.now()}`,
      `${BASE}/data/story/ai-mid-autumn.json?v=${Date.now()}`
    ]
  }[kind]||[];

  for(const p of list){
    try{
      const r = await fetch(p,{cache:'no-store'});
      if(kind==='video'){
        if(r.ok){ return {ok:true, used:p}; }
      }else if(r.ok){
        return {ok:true, data: await r.json(), used:p};
      }
    }catch(e){ /* ignore */ }
  }
  return {ok:false, data:null, used:'error'};
}

/* -------------------- 偏移設定 -------------------- */
function setOffset(v){ offset=Number(v)||0; offsetVal.textContent=`${offset.toFixed(1)}s`; localStorage.setItem(`offset:${slug}`,String(offset)); }
window.player={ setOffset, clearRepeat:()=>{ loopSentence=false; btnReplay?.classList.remove('blue'); } };

/* -------------------- 載入影片 -------------------- */
async function loadVideo(){
  const {ok,used}=await fetchData('video');
  if(!ok){ videoEl.removeAttribute('src'); return; }
  videoEl.src=used;
  // 若第一來源失敗再換下一個（保留舊行為）
  const trySources=[...new Set([used,`${BASE}/videos/${primarySlug}.mp4`,`${BASE}/videos/story/mid-autumn.mp4`])];
  let i=0;
  videoEl.addEventListener('error',()=>{ if(i<trySources.length-1){ i++; videoEl.src=trySources[i]; } },{passive:true});
}

/* -------------------- 字幕 -------------------- */
async function loadCues(){
  cuesStatus.textContent='（字幕載入中…）'; cuesError.style.display='none';
  const {ok,data,used}=await fetchData('cues');
  if(!ok||!data){ cuesStatus.textContent=''; cuesError.style.display='block'; cuesError.textContent='⚠️ 無法讀取字幕資料，請確認 data 路徑與檔名。'; return; }
  if(String(used).includes('mid-autumn')) slug='mid-autumn';
  cues=data.map(x=>({t:toSec(x.time),en:x.en||'',zh:x.zh||''}));
  cuesBody.innerHTML=cues.map((c,i)=>`<tr data-i="${i}"><td class="cue-time">${c.t?fmt(c.t):''}</td><td class="cue-en">${esc(c.en)}${c.zh?`<div class="zh-line">${esc(c.zh)}</div>`:''}</td><td class="cue-zh">${esc(c.zh)}</td></tr>`).join('');
  $$('#cuesBody tr').forEach(tr=>tr.addEventListener('click',()=>{const i=+tr.dataset.i; seekTo(i,true);}));
  cuesStatus.textContent = `已載入：${String(used).replace(location.origin,'')}`;
}
function currentIndex(){ const t=videoEl.currentTime+offset; let i=0; while(i+1<cues.length&&cues[i+1].t<=t+0.0001)i++; return i; }
function highlightRow(idx){
  const trs = $$('#cuesBody tr'); trs.forEach(tr => tr.classList.remove('active'));
  const tr = trs[idx]; if (!tr) return;
  tr.classList.add('active');
  if (chkFollow.checked){
    const container = paneSub;
    if (container){
      const targetTop = tr.offsetTop - container.clientHeight/2 + tr.offsetHeight/2;
      container.scrollTo({ top: Math.max(0, targetTop), behavior: 'smooth' });
    }
  }
}
function seekTo(idx,play=true){ if(!cues[idx])return; videoEl.currentTime=Math.max(0,cues[idx].t-offset+0.0001); highlightRow(idx); if(play) videoEl.play(); }
function sentenceRange(i){ if(!cues[i])return[0,0]; const s=cues[i].t,e=(i+1<cues.length?cues[i+1].t:s+3); return[s,e]; }

/* -------------------- 測驗 -------------------- */
async function loadQuiz(){
  const listEl=$('#quizList',paneQuiz), metaEl=$('#quizMeta',paneQuiz);
  const headerEl = $('#quizHeader'); const filtersEl = $('#quizFilters');
  const btnSubmit = $('#btnSubmitQuiz'); const btnShowAnswer = $('#btnShowAnswer'); const btnPrint = $('#btnPrint');
  const {ok,data,used}=await fetchData('quiz');
  if(!ok||!data){ metaEl.textContent='⚠️ 題庫讀取失敗'; listEl.innerHTML=''; headerEl.textContent=''; return; }

  let questions=[];
  const pushQ=(sec,arr=[])=>arr?.forEach(q=>questions.push({
      section: sec || (q.section||'Mixed'),
      type: (String(q.type||'MCQ').toUpperCase()==='SA')?'SA':'MCQ',
      question: q.question||q.q||'',
      options: q.options||q.choices||[],
      answer: q.answer??q.ans??''
  }));
  if (Array.isArray(data)){ data.forEach(q=>pushQ(q.section||'Mixed',[q])); }
  else if (data.items){ data.items.forEach(q=>pushQ(q.section||'Mixed',[q])); }
  else if (data.questions){ data.questions.forEach(q=>pushQ(q.section||'Mixed',[q])); }
  else if (data.sections){
    pushQ('Vocabulary', data.sections.vocab);
    pushQ('Grammar', data.sections.grammar);
    pushQ('Reading', data.sections.reading);
    pushQ('Mixed', data.sections.mixed);
  }

  headerEl.textContent = `已載入（ ${slug} ），共 ${questions.length} 題`;
  metaEl.textContent = '來源：' + String(used).replace(location.origin,'');

  let currentSec = 'all';
  function render(){
    const items = questions.filter(q=> currentSec==='all' ? ['Vocabulary','Grammar','Reading','Mixed','單字','文法','閱讀','綜合'].includes(q.section||'Mixed') : (q.section===currentSec));
    listEl.innerHTML = items.map((q,i)=>{
      const idx=i+1;
      if(q.type==='MCQ'){
        const opts=q.options.map(opt=>`<label style="display:block;margin:4px 0"><input type="radio" name="q${idx}" value="${String(opt)}"> ${String(opt)}</label>`).join('');
        return `<li data-type="MCQ" data-ans="${String(q.answer)}" data-sec="${q.section||'Mixed'}"><div style="font-weight:700;margin:4px 0">${idx}. ${esc(q.question)}</div><div>${opts}</div><div class="msg" style="margin-top:4px"></div><div class="exp" style="margin-top:4px;color:#9fb3ff"></div></li>`;
      }else{
        return `<li data-type="SA" data-ans="${String(q.answer)}" data-sec="${q.section||'Mixed'}"><div style="font-weight:700;margin:4px 0">${idx}. ${esc(q.question)}</div><input type="text" placeholder="輸入答案…" style="padding:6px 8px;border:1px solid #334155;border-radius:6px;background:#0f223b;color:#dbe7ff"><button class="btn btn-check" style="margin-left:6px">檢查</button><div class="msg" style="margin-top:4px"></div><div class="exp" style="margin-top:4px;color:#9fb3ff"></div></li>`;
      }
    }).join('');
  }
  render();

  filtersEl.addEventListener('click', e=>{
    const sec = e.target?.dataset?.sec; if(!sec) return;
    const map = { '單字':'Vocabulary', '文法':'Grammar', '閱讀':'Reading', '綜合':'Mixed', 'all':'all' };
    currentSec = map[sec] || sec;
    render(); $('#quizScore').textContent='本分區分數：0 / 100';
  });

  btnSubmit.onclick=()=>{
    const items=[...$('#quizList').querySelectorAll('li')]; if(!items.length) return;
    let got=0,total=items.length;
    items.forEach(li=>{
      const ans=String(li.dataset.ans||'').trim();
      if(li.dataset.type==='MCQ'){
        const sel=li.querySelector('input[type="radio"]:checked'); 
        const user=sel?String(sel.value).trim():''; 
        const ok=user===ans;
        if(ok)got++;
        const msg=li.querySelector('.msg'),exp=li.querySelector('.exp');
        msg.textContent=ok?'✅ 正確':'❌ 錯誤'; msg.style.color=ok?'#5bd3c7':'#ff6b6b'; if(!ok)exp.textContent=`正解：${ans}`;
      }else{
        const ipt=li.querySelector('input'); 
        const ok=(ipt.value||'').trim().toLowerCase()===ans.toLowerCase(); 
        if(ok)got++;
        const msg=li.querySelector('.msg'),exp=li.querySelector('.exp');
        msg.textContent=ok?'✅ 正確':'❌ 錯誤'; msg.style.color=ok?'#5bd3c7':'#ff6b6b'; if(!ok)exp.textContent=`正解：${ans}`;
      }
    });
    const score=got*5, full=total*5;
    $('#quizScore').textContent=`本分區分數：${score} / ${full}`;
  };

  btnShowAnswer.onclick=()=>{
    const items=[...$('#quizList').querySelectorAll('li')];
    items.forEach(li=>{ li.querySelector('.exp').textContent=`正解：${String(li.dataset.ans||'')}`; });
  };
  btnPrint.onclick=()=>window.print();

  $('#quizList').addEventListener('click',e=>{
    if(!e.target.classList.contains('btn-check'))return;
    const li=e.target.closest('li'); const ipt=li.querySelector('input');
    const ok=(ipt.value||'').trim().toLowerCase()===String(li.dataset.ans||'').trim().toLowerCase();
    const msg=li.querySelector('.msg'); const exp=li.querySelector('.exp');
    msg.textContent=ok?'✅ 正確':'❌ 錯誤'; msg.style.color=ok?'#5bd3c7':'#ff6b6b'; exp.textContent=ok?'':`正解：${li.dataset.ans}`;
  });

  $('#quizScore').textContent='本分區分數：0 / 100';
}

/* -------------------- 單字 -------------------- */
async function loadVocab(){
  const vStatus=$('#vocabStatus'), vBox=$('#vocabBox');
  const {ok,data,used}=await fetchData('vocab');
  if(!ok||!data||!data.length){ vStatus.textContent='⚠️ 查無單字資料'; vBox.innerHTML=''; return; }
  vStatus.textContent=`已載入：${String(used).replace(location.origin,'')}`;
  const go=t=>{ const p=toSec(t); videoEl.currentTime=Math.max(0,p); videoEl.play(); };
  vBox.innerHTML=data.map(v=>`<div class="voc"><div class="voc-h"><div class="voc-word">${esc(v.word||'')}</div><div class="voc-pos">${esc(v.pos||'')}</div></div>${v.zh?`<div class="voc-zh">${esc(v.zh)}</div>`:''}${v.en?`<div class="voc-en">${esc(v.en)}</div>`:''}<div class="voc-actions">${v.time?`<button class="btn" data-act="jump" data-time="${esc(v.time)}">跳到片段</button>`:''}<button class="btn" data-act="speak" data-text="${esc(v.word||v.en||'')}">🔊 朗讀</button></div></div>`).join('');
  vBox.addEventListener('click',e=>{
    const act=e.target?.dataset?.act; if(!act)return;
    if(act==='jump')go(e.target.dataset.time||0);
    if(act==='speak'){ try{ const u=new SpeechSynthesisUtterance(e.target.dataset.text||''); u.lang='en-US'; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch{} }
  });
}

/* -------------------- 控制列 -------------------- */
speedRange.addEventListener('input',()=>{ const r=Number(speedRange.value)||1; videoEl.playbackRate=r; speedVal.textContent=`${r.toFixed(2)}x`; });
btnPlay.addEventListener('click',()=>{ if(videoEl.paused) videoEl.play(); else videoEl.pause(); });
btnPrev.addEventListener('click',()=>seekTo(Math.max(0,currentIndex()-1),true));
btnNext.addEventListener('click',()=>seekTo(Math.min(cues.length-1,currentIndex()+1),true));
// 重複本句
(function(){ const btn=btnReplay; const on=()=>{btn.dataset.active='1';btn.classList.add('blue')}; const off=()=>{btn.dataset.active='0';btn.classList.remove('blue');loopSentence=false}; off(); btn.addEventListener('click',function(e){ const isOn=btn.dataset.active==='1'; if(isOn){ e.stopImmediatePropagation(); window.player.clearRepeat(); off(); return; } loopSentence=true; on(); seekTo(currentIndex(),true); },true); })();
// 偏移
btnOffsetMinus.addEventListener('click',()=>setOffset(offset-0.5));
btnOffsetPlus .addEventListener('click',()=>setOffset(offset+0.5));
// 跟隨高亮與循環
videoEl.addEventListener('timeupdate',()=>{ if(!cues.length)return; const i=currentIndex(); highlightRow(i); if(loopSentence){ const [s,e]=sentenceRange(i); const t=videoEl.currentTime+offset; if(t>=e-0.02){ videoEl.currentTime=Math.max(0,s-offset+0.0001); videoEl.play(); } } });


/* -------------------- 小寬螢幕橫捲輔助：把滑鼠滾輪轉為水平捲動 -------------------- */
(function enableWheelToHorizontal(){
  const track = document.getElementById('track');
  if(!track) return;
  function isSmall(){ return window.innerWidth <= 960; }
  track.addEventListener('wheel', (e)=>{
    if(!isSmall()) return;
    if(Math.abs(e.deltaY) > Math.abs(e.deltaX)){
      track.scrollLeft += e.deltaY;
      e.preventDefault();
    }
  }, {passive:false});
})();

/* 小螢幕滑動修正：避免內層垂直滾動干擾橫捲 */
(function fixTouchConflict(){
  const track = document.getElementById('track');
  if(!track) return;
  function isSmall(){ return window.innerWidth <= 960; }
  let startX=0, startY=0, lastX=0;
  track.addEventListener('touchstart', e=>{
    if(!isSmall()) return;
    const t=e.touches[0]; startX=t.clientX; startY=t.clientY; lastX=t.clientX;
  },{passive:true});
  track.addEventListener('touchmove', e=>{
    if(!isSmall()) return;
    const t=e.touches[0];
    const dx = t.clientX - lastX;
    const ax = Math.abs(t.clientX - startX);
    const ay = Math.abs(t.clientY - startY);
    if(ax > ay){ // 橫向優先
      e.preventDefault();
      track.scrollLeft -= dx;
    }
    lastX = t.clientX;
  },{passive:false});
})();

/* -------------------- 返回影片按鈕：從右頁回到左頁 -------------------- */
(function bindExitFocus(){
  const btn = document.getElementById('btnExitFocus');
  if(!btn) return;
  const leftPage = document.getElementById('pageLeft');
  btn.addEventListener('click', ()=>{
    document.body.classList.remove('at-right');
    leftPage?.scrollIntoView({behavior:'smooth',inline:'start',block:'nearest'});
  });
})();

/* -------------------- 分頁切換（改用 scrollIntoView，避免 snap 偏移） -------------------- */
function showTab(name){
  paneSub.style.display=name==='sub'?'':'none';
  paneQuiz.style.display=name==='quiz'?'':'none';
  paneVocab.style.display=name==='vocab'?'':'none';
  $('#pane-ai').style.display = name==='ai' ? '' : 'none';
  $$('.tabs .tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===name));

  // 將焦點頁面捲到右側（pageRight）— 使用 scrollIntoView 以正確對齊 snap
  const rightPage = document.getElementById('pageRight');
  if(rightPage){ document.body.classList.add('at-right'); rightPage.scrollIntoView({behavior:'smooth',inline:'start',block:'nearest'}); }
}
$$('.tabs .tab').forEach(t=>t.addEventListener('click',()=>showTab(t.dataset.tab)));

/* -------------------- AI 面板 -------------------- */
(function tinyAIDemo(){
  const prog = document.getElementById('aiProgress');
  const replyEl = document.getElementById('aiReply');
  function refresh(i=0,total=0){ if(prog) prog.textContent=`第 ${total?i+1:0}/${total} 題`; }
  document.getElementById('aiDemo')?.addEventListener('click',()=>{
    const text = 'The Mid-Autumn Festival is celebrated on the 15th day of the eighth lunar month.';
    replyEl.textContent = text; refresh(0,10);
  });
  document.getElementById('aiDemoTts')?.addEventListener('click',()=>{
    try{ const u=new SpeechSynthesisUtterance(replyEl.textContent||''); u.lang='en-US'; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch{}
  });
  refresh();
})();

async function loadAI(){
  const sel = document.getElementById('aiTopic');
  const promptBox = document.getElementById('aiPrompt');
  const hintEl = document.getElementById('aiHint');
  const replyEl = document.getElementById('aiReply');
  const prog = document.getElementById('aiProgress');
  const autoNext = document.getElementById('aiAutoNext');
  const btnPrev = document.getElementById('btnPrevTopic');
  const btnNext = document.getElementById('btnNextTopic');
  const btnTts  = document.getElementById('btnTts');
  const btnDemo = document.getElementById('aiDemo');
  const btnDemoTts = document.getElementById('aiDemoTts');
  const btnRec  = document.getElementById('btnRec');
  const btnStop = document.getElementById('btnStop');

  function tts(text){ try{ const u=new SpeechSynthesisUtterance(text||''); u.lang='en-US'; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch{} }

  const {ok,data}=await fetchData('ai');
  let items=[];
  if(ok){
    if (Array.isArray(data)) items = data;
    else if (data && (data.items || data.questions)) items = data.items || data.questions || [];
    else if (data && data.sections) items = Object.values(data.sections).flat().filter(Boolean);
    else if (data && Array.isArray(data.topics)) items = data.topics.map(t=>({topic:t.title||'Topic',question:t.prompt||t.question||'',hint:t.hint||'',sample:t.sample||'',answer:t.answer||''}));
  }
  items = (items||[]).map(x=>({
    topic: x.topic || x.section || x.title || 'Default',
    question: x.question || x.q || x.prompt || '',
    hint: x.hint || x.keywords || '',
    sample: x.sample || x.example || x.demo || '',
    answer: x.answer || x.ans || ''
  })).filter(x=>x.question);

  const groups={}; for(const it of items){ (groups[it.topic]??=[]).push(it); }
  const topics=Object.keys(groups);
  if(!topics.length){
    prog.textContent='第 0/0 題'; sel.innerHTML='<option value="">No AI dataset</option>';
    btnPrev.disabled=btnNext.disabled=true;
  }else{
    sel.innerHTML=topics.map((t,i)=>`<option value="${encodeURIComponent(t)}"${i===0?' selected':''}>${t}</option>`).join('');
  }
  let topic=topics[0]||''; let idx=0;
  function cur(){ return groups[topic]||[]; }
  function show(){
    const list=cur(); const total=list.length;
    if(!total){ promptBox.value=''; hintEl.textContent='—'; prog.textContent='第 0/0 題'; return; }
    const it=list[idx]; promptBox.value=it.question||''; hintEl.textContent=it.hint||'—';
    replyEl.textContent=it.sample||''; prog.textContent=`第 ${idx+1}/${total} 題`;
  }
  sel.addEventListener('change',()=>{ topic=decodeURIComponent(sel.value||topics[0]||''); idx=0; show(); });
  btnPrev.addEventListener('click',()=>{ const total=cur().length; if(!total)return; idx=(idx-1+total)%total; show(); });
  btnNext.addEventListener('click',()=>{ const total=cur().length; if(!total)return; idx=(idx+1)%total; show(); });
  btnTts.addEventListener('click',()=>tts(promptBox.value||''));
  btnDemo?.addEventListener('click',()=>{ const it=(cur()[idx]||{}); replyEl.textContent=it.sample||it.answer||replyEl.textContent||''; });
  btnDemoTts?.addEventListener('click',()=>tts(replyEl.textContent||''));

  // 錄音可用性處理
  try{
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(SR){
      const rec = new SR();
      rec.lang='en-US'; rec.interimResults=false; rec.continuous=false;
      rec.onresult=(ev)=>{
        const text=Array.from(ev.results).map(r=>r[0].transcript).join(' ');
        replyEl.textContent=text; if(autoNext.checked){ btnNext.click(); }
      };
      rec.onend = ()=>{ btnRec.disabled=false; btnStop.disabled=true; };
      btnRec.addEventListener('click',()=>{ try{ btnRec.disabled=true; btnStop.disabled=false; rec.start(); }catch(e){} });
      btnStop.addEventListener('click',()=>{ try{ rec.stop(); }catch(e){} });
    }else{
      btnRec.disabled = btnStop.disabled = true;
      btnRec.title = '此瀏覽器不支援語音辨識或未授權麥克風';
    }
  }catch(e){
    btnRec.disabled = btnStop.disabled = true;
    btnRec.title = '啟用語音辨識失敗，請檢查瀏覽器權限設定';
  }

  show();
}

/* -------------------- 初始化 -------------------- */
(async function init(){
  const saved=localStorage.getItem(`offset:${slug}`); if(saved!=null) setOffset(parseFloat(saved)); else setOffset(0);
  const r=Number(speedRange.value)||1; videoEl.playbackRate=r; speedVal.textContent=`${r.toFixed(2)}x`;
  await loadVideo(); await loadCues(); await loadQuiz(); await loadVocab(); await loadAI();
  showTab('sub');
})();

</script>

<script type="module">
/* -------------------- Supabase：登入檢查 + 觀看紀錄（避免重複插入） -------------------- */
import { supabase } from '/EduEnglish/supa.js?v=20251018';

const { data: authData } = await supabase.auth.getUser();
if (!authData?.user) {
  alert('請先登入後再看影片。');
  location.href = '/EduEnglish/index.html';
} else {
  const user = authData.user;
  document.getElementById('userNameBadge').textContent = user.email || '';
  const videoSlug = new URLSearchParams(location.search).get('slug') || 'mid-autumn';

  // 僅在「開始播放」第一次時插入一次紀錄，避免重複
  let once=false;
  document.getElementById('player')?.addEventListener('play', async ()=>{
    if(once) return; once=true;
    try { await supabase.from('watch_logs').insert({ user_id: user.id, email: user.email, video_slug: videoSlug }); } catch {}
  }, { once:true });
}

</script>

<script>
/* -------------------- 固定藍色滑桿控制邏輯 -------------------- */
(function(){
  const wrap=document.querySelector('.scrollbar-wrap');
  const content=wrap?.querySelector('.scrollbar-content');
  if(!wrap||!content)return;
  const thumb=document.createElement('div');
  const track=document.createElement('div');
  track.className='scrollbar-track';
  thumb.className='scrollbar-thumb';
  track.appendChild(thumb);
  wrap.appendChild(track);
  function updateThumb(){
    const ratio=wrap.clientHeight/content.scrollHeight;
    const h=Math.max(ratio*track.clientHeight,30);
    const top=(content.scrollTop/content.scrollHeight)*track.clientHeight;
    thumb.style.height=h+'px';
    thumb.style.top=top+'px';
  }
  content.addEventListener('scroll',updateThumb);
  let dragging=false,startY=0,startTop=0;
  thumb.addEventListener('mousedown',e=>{
    dragging=true;startY=e.clientY;startTop=parseInt(thumb.style.top||0);
    document.body.style.userSelect='none';
  });
  window.addEventListener('mousemove',e=>{
    if(!dragging)return;
    const dy=e.clientY-startY;
    const max=track.clientHeight-thumb.offsetHeight;
    const newTop=Math.min(Math.max(startTop+dy,0),max);
    thumb.style.top=newTop+'px';
    content.scrollTop=(newTop/max)*(content.scrollHeight-wrap.clientHeight);
  });
  window.addEventListener('mouseup',()=>{dragging=false;document.body.style.userSelect='';});
  new ResizeObserver(updateThumb).observe(content);
})();
</script>

</body>
</html>



