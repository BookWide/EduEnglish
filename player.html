<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<title>Player (music wired)</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  body{background:#0b1220;color:#e6edf3;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;}
  .wrap{max-width:1100px;margin:24px auto;padding:12px;}
  .panel{display:grid;grid-template-columns:2fr 1fr;gap:16px;}
  .videoBox{position:relative;background:#000;border-radius:12px;overflow:hidden}
  video{width:100%;aspect-ratio:16/9;background:#000;display:block}
  h1{font-size:16px;margin:6px 0 12px 0;opacity:.85}
  .card{background:#0f172a;border:1px solid #1e293b;padding:12px;border-radius:10px;min-height:240px}
</style>
</head>
<body>
<div class="wrap">
  <a href="index.html" style="text-decoration:none;color:#9ac7ff">← 回首頁</a>
  <h1 id="title">播放器</h1>
  <div class="panel">
    <div class="videoBox">
      <video id="player" controls></video>
    </div>
    <div class="card">
      <div id="status">載入中…</div>
      <ul id="debug" style="font-size:12px;line-height:1.5;opacity:.8"></ul>
    </div>
  </div>
</div>
<script>
const log=(...a)=>{ const ul=document.getElementById('debug'); const li=document.createElement('li'); li.textContent=a.map(x=>typeof x==='string'?x:JSON.stringify(x)).join(' '); ul.appendChild(li); };
const params=new URLSearchParams(location.search);
const primarySlug=params.get('slug')||'mid-autumn';
const cat=params.get('cat')||'story';
let slug=primarySlug;
document.getElementById('title').textContent=`${cat} | ${primarySlug}`;
const DATA_BASE=(cat==='music')?'./data/music':'./data';
const FALLBACK_SLUG=(cat==='music')?'see-you-again':'mid-autumn';
const jurl=(type,s=primarySlug)=>`${DATA_BASE}/${type}-${s}.json?v=${Date.now()}`;
async function fetchWithFallback(p,f,kind){
  try{const r=await fetch(p,{cache:'no-store'}); if(!r.ok) throw 0; log(`[${kind}] primary`,p); return {data:await r.json(),used:'primary'};}
  catch(e){try{const r2=await fetch(f,{cache:'no-store'}); if(!r2.ok) throw 0; slug=FALLBACK_SLUG; log(`[${kind}] fallback`,f); return {data:await r2.json(),used:'fallback'};}
  catch(e2){log(`[${kind}] error`,p,f); return {data:null,used:'error'};}}}
async function loadVideo(){
  if(cat==='music'){
    try{const idxRes=await fetch(`${DATA_BASE}/music-index.json?v=${Date.now()}`,{cache:'no-store'});
      if(idxRes.ok){const idx=await idxRes.json(); const item=(Array.isArray(idx)?idx:[]).find(x=>x.slug===primarySlug);
        if(item&&item.yt){const wrap=document.querySelector('.videoBox'); const iframe=document.createElement('iframe');
          iframe.src=`https://www.youtube.com/embed/${item.yt}?rel=0&modestbranding=1`; iframe.allow='autoplay; encrypted-media; picture-in-picture';
          iframe.allowFullscreen=true; iframe.style.cssText='position:absolute;inset:0;width:100%;height:100%;border:0;';
          wrap.appendChild(iframe); document.getElementById('status').textContent='YouTube 播放中'; return;}}}catch(e){}
  }
  const path=s=>(cat==='music')?`./videos/music/${s}.mp4`:`./videos/${s}.mp4`;
  const v=document.getElementById('player'); v.src=path(primarySlug); v.addEventListener('error',()=>{ v.src=path(FALLBACK_SLUG); },{once:true});
  document.getElementById('status').textContent='本地影片播放';
}
async function preload(){ await fetchWithFallback(jurl('cues'),jurl('cues',FALLBACK_SLUG),'cues'); await fetchWithFallback(jurl('quiz'),jurl('quiz',FALLBACK_SLUG),'quiz'); await fetchWithFallback(jurl('vocab'),jurl('vocab',FALLBACK_SLUG),'vocab');}
loadVideo(); preload();
</script>
</body>
</html>
