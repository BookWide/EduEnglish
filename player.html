<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BookWide æ’­æ”¾å™¨ï¼ˆ4 åˆ†é  + æ¸¬é©—å››é¡ï¼‰</title>

<style>
:root{
  --bg:#0b1324;
  --panel:#0f172a;
  --border:#1f2a44;
  --ink:#e6f0ff;
  --muted:#9fb0c9;
  --accent:#3c7cff;
}
*{box-sizing:border-box;}
html,body{
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  background:radial-gradient(circle at top,#111827 0,#020617 55%);
  color:var(--ink);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
}
body{
  display:flex;
  flex-direction:column;
}
body,button,input,select,textarea{
  font-size:14px;
}
a{color:var(--accent);text-decoration:none;}
a:hover{text-decoration:underline;}
header{
  padding:10px 16px;
  border-bottom:1px solid rgba(148,163,184,.35);
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:linear-gradient(to right,#020617,#020617 30%,#020617 60%,#020617);
  backdrop-filter:blur(18px);
  position:sticky;
  top:0;
  z-index:50;
}
header h1{
  margin:0;
  font-size:15px;
  letter-spacing:.04em;
  color:#e2e8f0;
}
header .muted{
  font-size:12px;
  color:#9ca3af;
}
.wrap{
  flex:1;
  display:flex;
  flex-direction:column;
  padding:10px 12px 18px;
  max-width:1200px;
  margin:0 auto;
  width:100%;
  gap:10px;
}
#track{
  display:flex;
  gap:10px;
  align-items:stretch;
  min-height:0;
}
.left,.right{
  background:radial-gradient(circle at top,#020617 0,#020617 35%,#020617 100%);
  border-radius:16px;
  border:1px solid rgba(148,163,184,.35);
  box-shadow:0 18px 40px rgba(15,23,42,.65);
  padding:10px;
  position:relative;
}
.left{
  flex:1 1 52%;
  min-width:0;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.right{
  flex:1 1 48%;
  min-width:0;
  display:flex;
  flex-direction:column;
}
.video-wrap{
  position:relative;
  border-radius:12px;
  overflow:hidden;
  background:#020617;
  border:1px solid #1f2937;
}
video{
  width:100%;
  display:block;
  background:#020617;
}
.badge{
  position:absolute;
  left:8px;
  top:8px;
  padding:4px 8px;
  border-radius:999px;
  font-size:11px;
  background:rgba(15,23,42,.65);
  color:#e5e7eb;
  border:1px solid rgba(148,163,184,.5);
  display:inline-flex;
  align-items:center;
  gap:4px;
}
.badge span.key{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:16px;
  height:16px;
  border-radius:4px;
  background:rgba(15,23,42,.9);
  font-size:11px;
  color:#e5e7eb;
}
.info{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:8px;
}
.info-main{
  flex:1;
  min-width:0;
}
.title{
  font-size:16px;
  font-weight:600;
  margin:0 0 4px;
  color:#e5e7eb;
}
.meta{
  font-size:12px;
  color:#9ca3af;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.meta span{
  display:inline-flex;
  align-items:center;
  gap:4px;
}
.meta-label{
  font-size:11px;
  color:#94a3b8;
}
.tag{
  padding:2px 6px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.5);
  font-size:11px;
  color:#e5e7eb;
  background:rgba(15,23,42,.7);
}
.info-side{
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap:4px;
}
.level-pill{
  padding:4px 8px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.5);
  font-size:11px;
  color:#e5e7eb;
  background:radial-gradient(circle at top,#1e293b,#020617);
}
.level-pill span{
  font-weight:600;
}
.level-stars{
  font-size:13px;
}
.controls{
  margin-top:4px;
  padding:8px 10px;
  border-radius:12px;
  background:radial-gradient(circle at top left,#020617,#020617 45%,#020617 100%);
  border:1px solid rgba(148,163,184,.35);
  display:flex;
  flex-direction:column;
  gap:6px;
}
.controls .row{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  align-items:center;
}
.btn{
  border-radius:999px;
  border:1px solid rgba(148,163,184,.7);
  background:radial-gradient(circle at top,#1d4ed8,#1e293b);
  color:#e5e7eb;
  padding:5px 10px;
  font-size:13px;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:4px;
  white-space:nowrap;
}
.btn.secondary{
  background:rgba(15,23,42,.9);
}
.btn.subtle{
  background:transparent;
  border-color:rgba(148,163,184,.4);
  color:#cbd5f5;
}
.btn.small{
  padding:3px 8px;
  font-size:11px;
}
.btn.disabled,
.btn:disabled{
  opacity:.5;
  cursor:not-allowed;
}
.btn:hover:not(:disabled){
  border-color:#60a5fa;
  box-shadow:0 0 0 1px rgba(96,165,250,.5);
}
.chip{
  padding:3px 8px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.4);
  font-size:11px;
  color:#cbd5f5;
  display:inline-flex;
  align-items:center;
  gap:4px;
  background:rgba(15,23,42,.9);
}
.chip input[type="checkbox"]{
  width:13px;height:13px;
}
.range-wrap{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:11px;
  color:#9ca3af;
}
.range-wrap input[type="range"]{
  flex:1;
}
.time-display{
  font-family:ui-monospace,Menlo,Consolas,monospace;
  font-size:12px;
  color:#e5e7eb;
}
.tabs{
  display:flex;
  border-bottom:1px solid rgba(148,163,184,.4);
}
.tab{
  flex:1;
  padding:8px;
  text-align:center;
  font-size:13px;
  cursor:pointer;
  border-bottom:2px solid transparent;
  color:#9ca3af;
}
.tab.active{
  color:#e5e7eb;
  border-bottom-color:#3b82f6;
  background:radial-gradient(circle at top,#020617,#020617 60%,#020617 100%);
}
.tab span.badge-small{
  margin-left:6px;
  padding:1px 6px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.4);
  font-size:11px;
}
.tab-panels{
  flex:1;
  display:flex;
  flex-direction:column;
  min-height:0;
}
.panel{
  display:none;
  flex-direction:column;
  flex:1;
  min-height:0;
  padding:10px 10px 10px;
}
.panel.active{
  display:flex;
}
.rightScroll{
  flex:1;
  min-height:0;
  overflow:auto;
  padding-right:4px;
}
table{
  border-collapse:collapse;
  width:100%;
}
th,td{
  border-bottom:1px solid #1f2937;
  padding:6px 6px;
  text-align:left;
  font-size:13px;
}
thead th{
  position:sticky;
  top:0;
  background:#020617;
  z-index:5;
}
tbody tr:hover{
  background:rgba(15,23,42,.85);
}
tbody tr.active{
  background:rgba(37,99,235,.25);
}
th.time-col,
td.time-col{
  width:64px;
  min-width:64px;
  color:rgba(255,255,255,.75);
  font-family:ui-monospace,Consolas,monospace;
  white-space:nowrap;
}
.cue-en{line-height:1.6;word-break:break-word;position:relative;}
.zh-line,.ja-line{margin-top:4px;opacity:.96;}

/* å»æ‰å–‡å­ï¼Œåªç•™å·¦å´é«˜äº® */
tr.speaking::before{content:none!important;}
tr.speaking{
  box-shadow:inset 3px 0 0 0 rgba(60,124,255,.55)!important;
  background:rgba(60,124,255,.10)!important;
}

.quiz-cats{
  padding:8px 12px;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  border-bottom:1px solid #162a48;
}

/* AI å€å¡Š */
#pane-ai textarea{
  width:100%;
  resize:vertical;
  font-family:inherit;
  border-radius:8px;
  border:1px solid #223048;
  background:#050b18;
  color:#e5e7eb;
  padding:8px 10px;
}
#aiHistory{
  font-size:13px;
  color:#e5e7eb;
}
.ai-msg{
  padding:8px 10px;
  border-radius:8px;
  margin-bottom:6px;
}
.ai-msg.user{
  background:rgba(37,99,235,.15);
}
.ai-msg.bot{
  background:rgba(15,23,42,.9);
  border:1px solid #1f2937;
}
.ai-msg .role{
  font-size:11px;
  color:#9ca3af;
  margin-bottom:4px;
}
.ai-msg .body{
  white-space:pre-wrap;
}

/* æ‰‹æ©Ÿç‰ˆ */
@media(max-width:900px){
  .wrap{
    padding:8px 8px 16px;
  }
  #track{
    flex-direction:column;
  }
  .left,.right{
    width:100%;
    max-width:100%;
    border-radius:0;
    border-left:0;
    border-right:0;
  }
  #btnExitFocus{
    position:fixed;
    right:16px;
    bottom:16px;
    z-index:10020;
    padding:10px 14px;
    border:1px solid rgba(100,116,139,.5);
    background:#0f172a;
    color:#e6efff;
    border-radius:12px;
    display:none;
  }
  body.at-right #btnExitFocus{display:inline-flex;}
}

/* åˆ—å° */
@media print{
  header,.controls,.tabs,#btnExitFocus{display:none!important;}
  body{background:#fff;color:#000;}
  .left{display:none!important;}
  .right{border:none;}
}

/* PRO ç›®éŒ„æŠ½å±œå…§ */
#proCatalogPanel .group-title{
  margin:10px 0 2px;
  font-size:13px;
  font-weight:600;
  color:#e5e7eb;
}
#proCatalogPanel .item{
  padding:4px 6px;
  border-radius:6px;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:6px;
  font-size:13px;
}
#proCatalogPanel .item:hover{
  background:rgba(148,163,184,.12);
}
#proCatalogPanel .item.current{
  background:rgba(59,130,246,.18);
}
#proCatalogPanel .item .no{
  width:28px;
  text-align:right;
  color:#9ca3af;
  font-size:12px;
}
#proCatalogPanel .item .title{
  flex:1;
  min-width:0;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  font-size:13px;
}

/* vocab åœ–ç‰‡ */
.vocab-img-wrap{
  margin-top:4px;
}
.vocab-img-wrap img{
  width:120px;
  height:auto;
  border-radius:10px;
  display:block;
}

</style>

<!-- Supabase JSï¼ˆåªç”¨æ–¼ player å®ˆé–€ï¼Œä¸å½±éŸ¿å…¶å®ƒé é¢ï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  const SUPABASE_URL = 'https://jeajrwpmrgczimmrflxo.supabase.co';
  const SUPABASE_ANON_KEY =
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do';

  // æ ¹è·¯å¾‘ï¼šgithub.io åº•ä¸‹ç”¨ /EduEnglishï¼Œè‡ªè¨‚ç¶²åŸŸ (bookwide.net) ç”¨ç©ºå­—ä¸²
  const ROOT_BASE = (
    location.pathname.startsWith('/EduEnglish') ||
    location.hostname.includes('github.io')
  ) ? '/EduEnglish' : '';

  // Idle auto logout helperï¼ˆåˆ†é˜ç‚ºå–®ä½ï¼Œé è¨­å°å›ç™»å…¥é ï¼‰
  window.BW = window.BW || {};
  if (!window.BW.startIdleLogout) {
    window.BW.startIdleLogout = function(minutes, redirectUrl) {
      try {
        var m = parseInt(minutes, 10);
        if (!isFinite(m) || m <= 0) m = 60;
        var timeout = m * 60 * 1000;
        var last = Date.now();
        var timerId = null;

        function reset() {
          last = Date.now();
        }
        function check() {
          var diff = Date.now() - last;
          if (diff >= timeout) {
            if (timerId) {
              clearInterval(timerId);
              timerId = null;
            }
            var target = redirectUrl || '/login.html?timeout=1';
            window.location.href = target;
          }
        }

        ['click','keydown','mousemove','scroll','touchstart','touchmove'].forEach(function(ev){
          window.addEventListener(ev, reset, { passive: true });
        });
        timerId = setInterval(check, 30000);
      } catch (e) {
        console.warn('[BW-player] startIdleLogout error', e);
      }
    };
  }

  // åƒ…ä¾› player.html ä½¿ç”¨çš„ Supabase Client
  const playerSupa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  async function bwPlayerGetUser() {
    try {
      const { data, error } = await playerSupa.auth.getUser();
      if (error || !data || !data.user) return null;
      return data.user;
    } catch (err) {
      console.error('[player-auth] getUser error', err);
      return null;
    }
  }

  // å–å¾—ç™»å…¥è€… Emailï¼ˆè‹¥éœ€è¦ï¼‰
  async function getSessionUser() {
    return await bwPlayerGetUser();
  }

  async function supaGetUser() {
    return await bwPlayerGetUser();
  }
  BW.startIdleLogout(60, '/login.html?timeout=1');
</script>
</head>
<body>
<header>
  <h1>æ’­æ”¾å™¨</h1>
  <div style="display:flex;align-items:center;gap:10px">
    <a class="btn" id="homeLink" href="#">ğŸ  å›é¦–é </a>
    <span class="muted" id="userNameBadge"></span>
  </div>
</header>

<div class="wrap">
  <div id="track" class="layout">
    <!-- å·¦ï¼šå½±ç‰‡ -->
    <section class="page" id="pageLeft">
      <section class="left">
        <div class="video-wrap">
          <video id="video" controls playsinline></video>
          <div class="badge">
            <span class="key">B</span>
            <span id="badgeCat">æ•…äº‹ Story</span>
          </div>
        </div>

        <div class="info">
          <div class="info-main">
            <h2 class="title" id="title">Loading...</h2>
            <div class="meta">
              <span><span class="meta-label">é•·åº¦</span><span id="metaDuration">--:--</span></span>
              <span><span class="meta-label">åˆ†é¡</span><span id="metaCat">-</span></span>
              <span><span class="meta-label">Slug</span><span id="metaSlug">-</span></span>
            </div>
          </div>
          <div class="info-side">
            <div class="level-pill">
              é›£åº¦ <span id="metaLevel">-</span>
              <span class="level-stars" id="metaStars"></span>
            </div>
            <div class="tag" id="metaTag">BookWide ç·šä¸Šèª²ç¨‹</div>
          </div>
        </div>

        <!-- PRO èª²ç¨‹å°è¦½ï¼ˆåƒ… cat=pro æ™‚é¡¯ç¤ºï¼‰ -->
        <div id="proLessonNav" style="display:none;margin:4px 0 2px;padding:6px 10px;border-radius:10px;background:#0b11201a;border:1px solid #1f2937;">
          <div id="proLessonBreadcrumb" style="margin-bottom:4px;font-size:13px;color:#e5e7eb;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
            PRO æ–‡æ³•èª²ç¨‹
          </div>
          <div style="display:flex;align-items:center;gap:6px;">
            <button id="proPrevBtn" class="btn" style="padding:4px 10px;font-size:12px;">â¬… ä¸Šä¸€è¬›</button>
            <button id="proNextBtn" class="btn" style="padding:4px 10px;font-size:12px;">ä¸‹ä¸€è¬› â¡</button>
            <button id="proCatalogBtn" class="btn" style="padding:4px 10px;font-size:12px;">ğŸ“š ç›®éŒ„</button>
            <span id="proLessonPos" style="margin-left:auto;color:#9ca3af;font-size:12px;"></span>
          </div>
        </div>

        <div class="controls">
          <div class="row">
            <button class="btn" id="btnPrev">â® ä¸Šä¸€å¥</button>
            <button class="btn" id="btnPlay">â–¶ï¸ æ’­æ”¾ / æš«åœ</button>
            <button class="btn" id="btnNext">â­ ä¸‹ä¸€å¥</button>
            <button class="btn" id="btnReplay">ğŸ” é‡è¤‡æœ¬å¥</button>
          </div>
          <div class="row">
            <label class="chip"><input id="chkFollow" type="checkbox" /> è·Ÿéš¨</label>
            <span class="chip">åç§» <span id="offsetVal">0.0s</span></span>
            <button class="btn" id="btnOffsetMinus">-0.5s</button>
            <button class="btn" id="btnOffsetPlus">+0.5s</button>
            <button class="btn" id="btnAutoSync">ğŸ§­ ç°¡æ˜“æ ¡æº–</button>
          </div>
          <div class="row" style="gap:10px">
            <div class="range-wrap">
              <span>é€Ÿåº¦</span>
              <input type="range" id="speedRange" min="0.5" max="1.5" step="0.05" value="1" />
              <span id="speedVal">1.00x</span>
            </div>
            <div class="time-display">
              <span id="currentTime">00:00</span> / <span id="totalTime">00:00</span>
            </div>
          </div>
        </div>
      </section>
    </section>

    <!-- å³ï¼šå››åˆ†é  -->
    <section class="page" id="pageRight">
      <section class="right">
        <div class="tabs">
          <div class="tab active" data-tab="sub">
            å­—å¹•
          </div>
          <div class="tab" data-tab="quiz">
            æ¸¬é©—
            <span class="badge-small">4 é¡</span>
          </div>
          <div class="tab" data-tab="vocab">
            å–®å­—
          </div>
          <div class="tab" data-tab="ai">
            AI å°è©±
          </div>
        </div>

        <div class="tab-panels">
          <!-- å­—å¹• -->
          <div class="panel active" id="pane-sub">
            <div class="rightScroll" id="subScroll">
              <table>
                <thead>
                  <tr>
                    <th class="time-col">Time</th>
                    <th>å…§å®¹ï¼ˆè‹± / ä¸­ / æ—¥ï¼‰</th>
                  </tr>
                </thead>
                <tbody id="subBody"></tbody>
              </table>
            </div>
          </div>

          <!-- æ¸¬é©— -->
          <div class="panel" id="pane-quiz">
            <div class="quiz-cats">
              <button class="btn small" data-quiz-cat="all">å…¨éƒ¨</button>
              <button class="btn small" data-quiz-cat="choose">é¸æ“‡é¡Œ</button>
              <button class="btn small" data-quiz-cat="fill">å¡«ç©ºé¡Œ</button>
              <button class="btn small" data-quiz-cat="order">æ’åºé¡Œ</button>
              <button class="btn small" data-quiz-cat="translate">ç¿»è­¯é¡Œ</button>
              <span class="chip">ç›®å‰åˆ†æ•¸ï¼š<span id="quizScore">0</span> åˆ†</span>
            </div>
            <div class="rightScroll" id="quizScroll">
              <div id="quizList"></div>
            </div>
          </div>

          <!-- å–®å­— -->
          <div class="panel" id="pane-vocab">
            <div class="rightScroll" id="vocabScroll">
              <table>
                <thead>
                  <tr>
                    <th class="time-col">Time</th>
                    <th>å–®å­— / ç‰‡èª</th>
                  </tr>
                </thead>
                <tbody id="vocabBody"></tbody>
              </table>
            </div>
          </div>

          <!-- AI å°è©± -->
          <div class="panel" id="pane-ai">
            <div style="padding:8px 10px 4px;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                <span class="chip">AI ç·´ç¿’æ¨¡å¼</span>
                <span class="muted" id="aiProgress" class="muted">ç¬¬ 0/0 é¡Œ</span>
              </div>
              <textarea id="aiPrompt" rows="3" readonly placeholder="é¡Œç›®æœƒé¡¯ç¤ºåœ¨é€™è£¡â€¦"></textarea>
            </div>
            <div class="rightScroll" id="aiHistory"></div>
          </div>
        </div>
      </section>
    </section>
  </div>
</div>

<!-- PRO èª²ç¨‹ç›®éŒ„ï¼ˆå³å´æŠ½å±œï¼Œåƒ… cat=pro æ™‚é¡¯ç¤ºï¼‰ -->
<div id="proCatalogPanel" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(15,23,42,.75);">
  <div style="position:absolute;right:0;top:0;bottom:0;width:320px;background:#020617;border-left:1px solid #1f2937;box-shadow:-10px 0 30px rgba(15,23,42,.9);display:flex;flex-direction:column;">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #1f2937;">
      <div style="font-weight:600;font-size:14px;">PRO æ–‡æ³•èª²ç¨‹ç›®éŒ„</div>
      <button id="proCatalogClose" style="border:none;background:transparent;color:#9ca3af;font-size:20px;cursor:pointer;line-height:1;">Ã—</button>
    </div>
    <div id="proCatalogList" style="font-size:13px;"></div>
  </div>
</div>

<button id="btnExitFocus">â¬… å›åˆ°å½±ç‰‡</button>

<script>
// ===== å·¥å…·å‡½å¼ =====
function qs(sel, el){return (el||document).querySelector(sel);}
function qsa(sel, el){return Array.prototype.slice.call((el||document).querySelectorAll(sel));}

function formatTime(sec){
  if(isNaN(sec)||sec<0)sec=0;
  sec=Math.floor(sec);
  var m=Math.floor(sec/60);
  var s=sec%60;
  return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
}

// ===== è®€å– URL åƒæ•¸ï¼šcat, slug =====
const params = new URLSearchParams(location.search);
const cat = params.get('cat') || 'story';
const slug = params.get('slug') || '';
const isPreview = params.get('preview') === '1';

document.title = 'BookWide æ’­æ”¾å™¨ï½œ' + (slug || 'æœªæŒ‡å®š');

// ===== UI ç¶å®š =====
const video = qs('#video');
const subBody = qs('#subBody');
const quizList = qs('#quizList');
const vocabBody = qs('#vocabBody');

const titleEl = qs('#title');
const metaDuration = qs('#metaDuration');
const metaCat = qs('#metaCat');
const metaSlug = qs('#metaSlug');
const metaLevel = qs('#metaLevel');
const metaStars = qs('#metaStars');
const metaTag = qs('#metaTag');
const badgeCat = qs('#badgeCat');

const btnPlay = qs('#btnPlay');
const btnPrev = qs('#btnPrev');
const btnNext = qs('#btnNext');
const btnReplay = qs('#btnReplay');
const chkFollow = qs('#chkFollow');
const offsetVal = qs('#offsetVal');
const btnOffsetMinus = qs('#btnOffsetMinus');
const btnOffsetPlus = qs('#btnOffsetPlus');
const btnAutoSync = qs('#btnAutoSync');
const speedRange = qs('#speedRange');
const speedVal = qs('#speedVal');
const currentTimeEl = qs('#currentTime');
const totalTimeEl = qs('#totalTime');

const tabs = qsa('.tab');
const panels = qsa('.panel');

const aiPrompt = qs('#aiPrompt');
const aiHistory = qs('#aiHistory');
const aiProgress = qs('#aiProgress');

const userNameBadge = qs('#userNameBadge');
const homeLink = qs('#homeLink');

let offset = 0;
let cues = [];
let quizData = [];
let vocabData = [];
let aiData = [];

let currentCueIndex = -1;

function setOffset(val){
  offset = val || 0;
  offsetVal.textContent = offset.toFixed(1) + 's';
}

// ===== Tab åˆ‡æ› =====
tabs.forEach(function(tab){
  tab.addEventListener('click', function(){
    var name = tab.getAttribute('data-tab');
    showTab(name);
  });
});

function showTab(name){
  tabs.forEach(function(t){
    t.classList.toggle('active', t.getAttribute('data-tab') === name);
  });
  panels.forEach(function(p){
    p.classList.toggle('active', p.id === 'pane-' + name);
  });
  if(name === 'ai'){
    document.body.classList.add('at-right');
  }else{
    document.body.classList.remove('at-right');
  }
}

qs('#btnExitFocus').addEventListener('click', function(){
  document.body.classList.remove('at-right');
});

// ===== è®€å–å½±ç‰‡ / JSON è·¯å¾‘ =====
function buildBasePath(){
  // çµ±ä¸€ï¼švideos/{cat}/{slug}.mp4, data/{cat}/cues-{slug}.json ç­‰
  return {
    video:`https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/videos/${cat}/${slug}.mp4`,
    cues:`data/${cat}/cues-${slug}.json`,
    quiz:`data/${cat}/quiz-${slug}.json`,
    vocab:`data/${cat}/vocab-${slug}.json`,
    ai:`data/${cat}/ai-${slug}.json`,
  };
}

async function loadVideo(){
  const p = buildBasePath();
  video.src = p.video;
}

// ===== è®€å–ä¸‰èªå­—å¹• cues-*.json =====
async function loadCues(){
  const p = buildBasePath();
  const res = await fetch(p.cues);
  if(!res.ok)throw new Error('cues not found');
  const data = await res.json();
  cues = data || [];

  subBody.innerHTML = '';
  cues.forEach(function(c,i){
    const tr = document.createElement('tr');
    tr.dataset.index = i;
    const tdTime = document.createElement('td');
    tdTime.className = 'time-col';
    tdTime.textContent = c.time || '';
    const tdTxt = document.createElement('td');

    const enDiv = document.createElement('div');
    enDiv.className = 'cue-en';
    enDiv.textContent = c.en || '';
    tdTxt.appendChild(enDiv);

    if(c.zh){
      const zhDiv = document.createElement('div');
      zhDiv.className = 'zh-line';
      zhDiv.textContent = c.zh;
      tdTxt.appendChild(zhDiv);
    }
    if(c.ja){
      const jaDiv = document.createElement('div');
      jaDiv.className = 'ja-line';
      jaDiv.textContent = c.ja;
      tdTxt.appendChild(jaDiv);
    }

    tr.appendChild(tdTime);
    tr.appendChild(tdTxt);
    subBody.appendChild(tr);
  });
}

// ===== è®€å–æ¸¬é©— quiz-*.json =====
async function loadQuiz(){
  const p = buildBasePath();
  try{
    const res = await fetch(p.quiz);
    if(!res.ok){
      quizList.innerHTML = '<p class="muted">å°šç„¡æ¸¬é©—è³‡æ–™ã€‚</p>';
      return;
    }
    quizData = await res.json() || [];
    renderQuiz('all');
  }catch(e){
    console.error(e);
    quizList.innerHTML = '<p class="muted">è®€å–æ¸¬é©—æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚</p>';
  }
}

function renderQuiz(catKey){
  quizList.innerHTML = '';
  if(!Array.isArray(quizData) || !quizData.length){
    quizList.innerHTML = '<p class="muted">å°šç„¡æ¸¬é©—è³‡æ–™ã€‚</p>';
    return;
  }
  const filtered = (catKey === 'all')
    ? quizData
    : quizData.filter(function(q){return q.type === catKey;});

  filtered.forEach(function(q,idx){
    const card = document.createElement('div');
    card.style.border='1px solid #1f2937';
    card.style.borderRadius='10px';
    card.style.padding='8px 10px';
    card.style.margin='6px 0';
    card.style.background='#020617';

    const head = document.createElement('div');
    head.style.display='flex';
    head.style.justifyContent='space-between';
    head.style.alignItems='center';
    head.style.marginBottom='4px';

    const title = document.createElement('div');
    title.textContent = 'Q' + (idx+1) + 'ï½œ' + (q.title || '');
    title.style.fontSize='13px';
    title.style.fontWeight='600';

    const badge = document.createElement('span');
    badge.className='chip';
    badge.textContent = q.type || 'æœªçŸ¥';

    head.appendChild(title);
    head.appendChild(badge);
    card.appendChild(head);

    const body = document.createElement('div');
    body.textContent = q.question || '';
    body.style.fontSize='13px';
    body.style.marginBottom='4px';
    card.appendChild(body);

    if(Array.isArray(q.options)){
      const ul = document.createElement('ul');
      ul.style.margin='0 0 4px 18px';
      ul.style.padding='0';
      q.options.forEach(function(opt){
        const li = document.createElement('li');
        li.textContent = opt;
        li.style.fontSize='13px';
        ul.appendChild(li);
      });
      card.appendChild(ul);
    }

    if(q.answer){
      const ans = document.createElement('div');
      ans.className='muted';
      ans.style.fontSize='12px';
      ans.textContent = 'ç­”æ¡ˆï¼š' + q.answer;
      card.appendChild(ans);
    }

    quizList.appendChild(card);
  });
}

qsa('[data-quiz-cat]').forEach(function(btn){
  btn.addEventListener('click', function(){
    const key = btn.getAttribute('data-quiz-cat');
    qsa('[data-quiz-cat]').forEach(function(b){b.classList.remove('active');});
    btn.classList.add('active');
    renderQuiz(key);
  });
});

// ===== è®€å–å–®å­— vocab-*.json =====
async function loadVocab(){
  const p = buildBasePath();
  try{
    const res = await fetch(p.vocab);
    if(!res.ok){
      vocabBody.innerHTML = '<tr><td colspan="2" class="muted">å°šç„¡å–®å­—è³‡æ–™ã€‚</td></tr>';
      return;
    }
    vocabData = await res.json() || [];
    renderVocab();
  }catch(e){
    console.error(e);
    vocabBody.innerHTML = '<tr><td colspan="2" class="muted">è®€å–å–®å­—æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚</td></tr>';
  }
}

function renderVocab(){
  vocabBody.innerHTML = '';
  if(!Array.isArray(vocabData) || !vocabData.length){
    vocabBody.innerHTML = '<tr><td colspan="2" class="muted">å°šç„¡å–®å­—è³‡æ–™ã€‚</td></tr>';
    return;
  }
  vocabData.forEach(function(v){
    const tr = document.createElement('tr');
    const tdTime = document.createElement('td');
    tdTime.className='time-col';
    tdTime.textContent=v.time || '';
    const tdWord = document.createElement('td');

    const main = document.createElement('div');
    main.textContent = (v.word || '') + (v.pos ? 'ï¼ˆ' + v.pos + 'ï¼‰' : '');
    main.style.fontWeight='600';
    main.style.marginBottom='2px';
    tdWord.appendChild(main);

    if(v.en){
      const en = document.createElement('div');
      en.textContent = 'EN: ' + v.en;
      en.style.fontSize='12px';
      en.style.opacity=0.96;
      tdWord.appendChild(en);
    }
    if(v.zh){
      const zh = document.createElement('div');
      zh.textContent = 'ä¸­: ' + v.zh;
      zh.style.fontSize='12px';
      zh.style.opacity=0.96;
      tdWord.appendChild(zh);
    }
    if(v.ja){
      const ja = document.createElement('div');
      ja.textContent = 'æ—¥: ' + v.ja;
      ja.style.fontSize='12px';
      ja.style.opacity=0.96;
      tdWord.appendChild(ja);
    }

    // åœ–ç‰‡ï¼ˆè‹¥æœ‰ï¼‰
    if(v.img){
      const wrap = document.createElement('div');
      wrap.className='vocab-img-wrap';
      const img = document.createElement('img');
      img.src = v.img;
      img.alt = v.word || '';
      wrap.appendChild(img);
      tdWord.appendChild(wrap);
    }

    tr.appendChild(tdTime);
    tr.appendChild(tdWord);
    vocabBody.appendChild(tr);
  });
}

// ===== è®€å– AI é¡Œç›® ai-*.json =====
async function loadAI(){
  const p = buildBasePath();
  try{
    const res = await fetch(p.ai);
    if(!res.ok){
      aiPrompt.value = 'å°šç„¡ AI é¡Œç›®è³‡æ–™ã€‚';
      aiProgress.textContent='ç¬¬ 0/0 é¡Œ';
      return;
    }
    aiData = await res.json() || [];
    if(!aiData.length){
      aiPrompt.value = 'å°šç„¡ AI é¡Œç›®è³‡æ–™ã€‚';
      aiProgress.textContent='ç¬¬ 0/0 é¡Œ';
      return;
    }
    currentAIIndex = 0;
    showCurrentAI();
  }catch(e){
    console.error(e);
    aiPrompt.value = 'è®€å– AI é¡Œç›®æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚';
  }
}

let currentAIIndex = 0;

function showCurrentAI(){
  if(!aiData.length){
    aiPrompt.value='';
    aiProgress.textContent='ç¬¬ 0/0 é¡Œ';
    return;
  }
  const item = aiData[currentAIIndex];
  aiPrompt.value = item.prompt || '';
  aiProgress.textContent = 'ç¬¬ ' + (currentAIIndex+1) + '/' + aiData.length + ' é¡Œ';
}

// ===== å½±ç‰‡æ§åˆ¶ =====
btnPlay.addEventListener('click',function(){
  if(video.paused)video.play();
  else video.pause();
});

btnPrev.addEventListener('click',function(){
  if(!cues.length)return;
  if(currentCueIndex<=0)currentCueIndex=0;
  else currentCueIndex--;
  jumpToCue(currentCueIndex);
});
btnNext.addEventListener('click',function(){
  if(!cues.length)return;
  if(currentCueIndex>=cues.length-1)currentCueIndex=cues.length-1;
  else currentCueIndex++;
  jumpToCue(currentCueIndex);
});
btnReplay.addEventListener('click',function(){
  if(currentCueIndex<0)return;
  jumpToCue(currentCueIndex,true);
});

btnOffsetMinus.addEventListener('click',function(){
  setOffset(offset-0.5);
  localStorage.setItem(`offset:${slug}`,String(offset));
});
btnOffsetPlus.addEventListener('click',function(){
  setOffset(offset+0.5);
  localStorage.setItem(`offset:${slug}`,String(offset));
});

btnAutoSync.addEventListener('click',function(){
  // ç°¡æ˜“ï¼šå°‡ç›®å‰ video.currentTime å°åˆ°æœ€è¿‘çš„ä¸€å€‹ cue.start
  if(!cues.length)return;
  const t = video.currentTime;
  let bestIndex=0;
  let bestDiff=Infinity;
  cues.forEach(function(c,i){
    const s = c.clip_start_sec || 0;
    const d = Math.abs(s - t);
    if(d<bestDiff){
      bestDiff=d;
      bestIndex=i;
    }
  });
  currentCueIndex=bestIndex;
  jumpToCue(bestIndex);
});

speedRange.addEventListener('input',function(){
  const r = Number(speedRange.value)||1;
  video.playbackRate=r;
  speedVal.textContent = r.toFixed(2)+'x';
});

video.addEventListener('timeupdate',function(){
  currentTimeEl.textContent = formatTime(video.currentTime);
  if(isNaN(video.duration))return;
  totalTimeEl.textContent = formatTime(video.duration);

  if(!cues.length)return;
  const t = video.currentTime;
  let idx = -1;
  for(let i=0;i<cues.length;i++){
    const s = cues[i].clip_start_sec || 0;
    const e = cues[i].clip_end_sec || (s+5);
    if(t>=s-offset && t<e-offset){
      idx=i;break;
    }
  }
  if(idx!==currentCueIndex){
    currentCueIndex=idx;
    highlightCue(idx);
  }
});

video.addEventListener('loadedmetadata',function(){
  if(isNaN(video.duration))return;
  totalTimeEl.textContent = formatTime(video.duration);
});

function jumpToCue(index, repeat){
  if(index<0 || index>=cues.length)return;
  const c = cues[index];
  const s = c.clip_start_sec || 0;
  const e = c.clip_end_sec || (s+3);
  video.currentTime = Math.max(0,s-offset+0.01);
  if(repeat){
    video.play();
    const handler = function(){
      const t = video.currentTime;
      if(t>=e-offset){
        video.pause();
        video.removeEventListener('timeupdate',handler);
      }
    };
    video.addEventListener('timeupdate',handler);
  }else{
    video.play();
  }
}

function highlightCue(index){
  qsa('#subBody tr').forEach(function(tr){
    tr.classList.remove('active','speaking');
  });
  if(index<0)return;
  const row = qs('#subBody tr[data-index="'+index+'"]');
  if(row){
    row.classList.add('active','speaking');
    row.scrollIntoView({block:'center',behavior:'smooth'});
  }
}

// é»æ“Šå­—å¹•è·³è½‰
subBody.addEventListener('click',function(e){
  let tr = e.target.closest('tr');
  if(!tr)return;
  const idx = Number(tr.dataset.index||-1);
  if(idx>=0){
    currentCueIndex=idx;
    jumpToCue(idx);
  }
});

// ===== ç°¡å–® AI å°è©±ï¼ˆç›®å‰åªé¡¯ç¤ºé¡Œç›®ï¼‰ =====
// ä¹‹å¾Œå¦‚éœ€å’Œå¾Œç«¯ AI API ä¸²æ¥ï¼Œå¯åœ¨æ­¤è£œä¸Š fetch å‘¼å«

/* ==== Browser TTS ==== */
function speakText(text,lang){
  if(!text || !('speechSynthesis' in window))return;
  try{speechSynthesis.cancel();}catch{}
  const u=new SpeechSynthesisUtterance(String(text));
  u.lang=lang||'en-US';u.rate=1.0;u.pitch=1.0;u.volume=1.0;
  speechSynthesis.speak(u);
}

/* ==== åˆå§‹åŒ– + å®ˆé–€ç¨‹åºï¼ˆç™»å…¥ + è¨‚é–± + previewï¼‰ ==== */
(async function init(){
  const params = new URLSearchParams(location.search);
  const isPreview = params.get('preview') === '1';

  let user = null;

  // 1ï¸âƒ£ å…ˆç”¨ player.html å°ˆç”¨çš„ bwPlayerGetUser() å–å¾—ç™»å…¥ä½¿ç”¨è€…
  try {
    if (typeof bwPlayerGetUser === 'function') {
      user = await bwPlayerGetUser();
    }
  } catch (e) {
    console.error('[BW-player] bwPlayerGetUser error', e);
  }

  // 2ï¸âƒ£ è‹¥æœªç™»å…¥ï¼šé preview ä¸€å¾‹å°å›é¦–é 
  if (!user) {
    if (!isPreview) {
      const next = location.pathname + location.search;
      const url = new URL((ROOT_BASE || '') + '/index.html', location.origin);
      url.searchParams.set('denied', 'signin');
      url.searchParams.set('next', next);
      location.href = url.toString();
      return;
    }
  } else {
    // é¡¯ç¤ºç™»å…¥è€… Email
    try {
      const email = user.email || '';
      if (userNameBadge) {
        userNameBadge.textContent = email ? ('ğŸ‘¤ ' + email) : '';
      }
    } catch (e) {
      console.warn('[BW-player] show email error', e);
    }
  }

  // 3ï¸âƒ£ å·²ç™»å…¥ä¸”é previewï¼šæª¢æŸ¥ profiles.expires_atï¼ˆä½¿ç”¨ playerSupaï¼‰
  let validUntil = null;
  if (!isPreview && user) {
    try {
      if (typeof playerSupa !== 'undefined') {
        const todayISO = new Date();
        todayISO.setHours(0, 0, 0, 0);

        const { data, error } = await playerSupa
          .from('orders')
          .select('expire_at, items, buyer_id, user_id, status')
          .eq('status', 'paid')
          .or(`buyer_id.eq.${user.id},user_id.eq.${user.id}`)
          .contains('items', [cat])
          .order('expire_at', { ascending: false })
          .limit(1)
          .maybeSingle();

        if (!error && data && data.expire_at) {
          validUntil = new Date(data.expire_at);
        }
        console.log('[BW-player] order expire_at raw =', data && data.expire_at, 'parsed =', validUntil);
      } else {
        console.warn('[BW-player] playerSupa not defined for subscription check');
      }
    } catch (e) {
      console.error('[BW-player] check subscription error', e);
    }

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // æ²’è¨‚é–±ï¼ˆæ²’æœ‰ä»»ä½•æœ‰æ•ˆè¨‚å–®ï¼‰ä¹Ÿè¦–ç‚ºä¸é€šéï¼Œå°å› pricing
    if (!(validUntil instanceof Date) || isNaN(validUntil.getTime())) {
      const next = location.pathname + location.search;
      const url = new URL((ROOT_BASE || '') + '/pricing.html', location.origin);
      url.searchParams.set('denied', 'noactive');
      url.searchParams.set('next', next);
      location.href = url.toString();
      return;
    }

    // è¨‚é–±å·²éæœŸ
    if (validUntil.getTime() < today.getTime()) {
      const next = location.pathname + location.search;
      const url = new URL((ROOT_BASE || '') + '/pricing.html', location.origin);
      url.searchParams.set('denied', 'expired');
      url.searchParams.set('next', next);
      location.href = url.toString();
      return;
    }
  }

  // 4ï¸âƒ£ å®ˆé–€é€šéå¾Œï¼Œåˆå§‹åŒ–æ’­æ”¾å™¨ + è¼‰å…¥è³‡æ–™
  try {
    const saved = localStorage.getItem(`offset:${slug}`);
    if (saved != null) setOffset(parseFloat(saved)); else setOffset(0);

    const r = Number(speedRange.value) || 1;
    video.playbackRate = r;
    speedVal.textContent = `${r.toFixed(2)}x`;

    await loadVideo();
    await loadCues();
    await loadQuiz();
    await loadVocab();
    await loadAI();

    showTab('sub');
  } catch (e) {
    console.warn('[BW-player] init error:', e);
  }
})();
</script>

  <!-- æ’­æ”¾é€²åº¦å¯«å…¥ watch_logsï¼ˆä¾›å­¸ç¿’æ§åˆ¶å°ä½¿ç”¨ï¼‰ --> <!-- V20251124-fixed by ChatGPT -->
<script>
(function(){
  try{
    const params = new URLSearchParams(location.search || window.location.search || '');
    const cat = params.get('cat');
    const slug = params.get('slug');
    if (cat !== 'pro' || !slug) return;

    const navBox = document.getElementById('proLessonNav');
    const breadcrumb = document.getElementById('proLessonBreadcrumb');
    const posSpan = document.getElementById('proLessonPos');
    if (!navBox || !breadcrumb) return;

    // è®€å– PRO èª²ç¨‹ç´¢å¼•
    fetch('data/pro/index-pro.json')
      .then(function(res){ return res.json(); })
      .then(function(groups){
        if (!Array.isArray(groups) || !groups.length) return;

        // æ”¤å¹³æˆä¸€ç¶­é™£åˆ—ï¼Œæ–¹ä¾¿ä¸Šä¸€è¬› / ä¸‹ä¸€è¬›æ“ä½œ
        var flat = [];
        groups.forEach(function(g, gi){
          (g.items || []).forEach(function(it, ii){
            flat.push({
              groupIndex: gi,
              itemIndex: ii,
              groupId: g.groupId,
              groupTitle: g.groupTitle,
              no: it.no,
              slug: it.slug,
              title: it.title
            });
          });
        });
        if (!flat.length) return;

        var curIndex = flat.findIndex(function(it){ return it.slug === slug; });
        if (curIndex === -1) return;

        var cur = flat[curIndex];
        var cleanTitle = String(cur.title || '').replace(/^\d+\.?\s*/, '');
        breadcrumb.textContent = (cur.groupTitle || '') + 'ï½œç¬¬ ' + cur.no + ' è¬›ï¼š' + cleanTitle;

        navBox.style.display = '';

        posSpan.textContent = 'ç¬¬ ' + (curIndex+1) + ' / ' + flat.length + ' è¬›';

        function gotoIndex(idx){
          if (idx < 0 || idx >= flat.length) return;
          var item = flat[idx];
          var url = new URL(location.href);
          url.searchParams.set('cat', 'pro');
          url.searchParams.set('slug', item.slug);
          url.searchParams.delete('preview');
          location.href = url.toString();
        }

        var prevBtn = document.getElementById('proPrevBtn');
        var nextBtn = document.getElementById('proNextBtn');

        if (prevBtn){
          if (curIndex === 0){
            prevBtn.disabled = true;
            prevBtn.classList.add('disabled');
          }else{
            prevBtn.addEventListener('click', function(){
              gotoIndex(curIndex - 1);
            });
          }
        }
        if (nextBtn){
          if (curIndex === flat.length-1){
            nextBtn.disabled = true;
            nextBtn.classList.add('disabled');
          }else{
            nextBtn.addEventListener('click', function(){
              gotoIndex(curIndex + 1);
            });
          }
        }

        var catalogBtn = document.getElementById('proCatalogBtn');
        var catalogPanel = document.getElementById('proCatalogPanel');
        var catalogClose = document.getElementById('proCatalogClose');
        var catalogList = document.getElementById('proCatalogList');

        if (catalogBtn && catalogPanel && catalogClose && catalogList){
          catalogBtn.addEventListener('click', function(){
            renderCatalog();
            catalogPanel.style.display = '';
          });
          catalogClose.addEventListener('click', function(){
            catalogPanel.style.display = 'none';
          });
          catalogPanel.addEventListener('click', function(e){
            if (e.target === catalogPanel){
              catalogPanel.style.display = 'none';
            }
          });
        }

        function renderCatalog(){
          catalogList.innerHTML = '';
          groups.forEach(function(g){
            var gt = document.createElement('div');
            gt.className = 'group-title';
            gt.textContent = g.groupTitle || g.groupId || '';
            catalogList.appendChild(gt);

            (g.items || []).forEach(function(it){
              var row = document.createElement('div');
              row.className = 'item';
              if (it.slug === slug) row.classList.add('current');

              var noSpan = document.createElement('span');
              noSpan.className = 'no';
              noSpan.textContent = it.no || '';
              row.appendChild(noSpan);

              var textSpan = document.createElement('span');
              textSpan.className = 'title';
              textSpan.textContent = (it.title || '').replace(/^\d+\.?\s*/, '');
              row.appendChild(textSpan);

              row.addEventListener('click', function(){
                var url = new URL(location.href);
                url.searchParams.set('cat', 'pro');
                url.searchParams.set('slug', it.slug);
                url.searchParams.delete('preview');
                location.href = url.toString();
              });

              catalogList.appendChild(row);
            });
          });
        }
      })
      .catch(function(err){
        console.error('[BW-player] load index-pro.json error', err);
      });
  }catch(err){
    console.error('watch_logs init error', err);
  }
})();

// ---- watch_logs å¯«å…¥ï¼šè¨˜éŒ„è§€çœ‹é€²åº¦ ----
(function(){
  const SUPABASE_URL = 'https://jeajrwpmrgczimmrflxo.supabase.co';
  const SUPABASE_ANON_KEY =
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do';

  const watchSupa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let currentLogId = null;
  let userId = null;

  async function initWatchLog(){
    try{
      const { data: { user }, error: userError } = await watchSupa.auth.getUser();
      if (userError || !user) {
        console.log('[watch_logs] no user, skip');
        return;
      }
      userId = user.id;

      const cat = new URLSearchParams(location.search).get('cat') || 'story';
      const slug = new URLSearchParams(location.search).get('slug') || '';

      if (!slug) {
        console.log('[watch_logs] no slug, skip');
        return;
      }

      const { data, error } = await watchSupa
        .from('watch_logs')
        .select('id, last_second, duration_sec')
        .eq('user_id', userId)
        .eq('category', cat)
        .eq('slug', slug)
        .order('updated_at', { ascending: false })
        .limit(1)
        .maybeSingle();

      if (error) {
        console.error('[watch_logs] select error', error);
      } else if (data) {
        currentLogId = data.id;
        console.log('[watch_logs] resume log id =', currentLogId, 'last_second =', data.last_second);
      } else {
        console.log('[watch_logs] no existing log');
      }

      video.addEventListener('timeupdate', function(){
        if (!userId) return;
        const curSec = Math.floor(video.currentTime || 0);
        const total = Math.floor(video.duration || 0);
        saveProgress(cat, slug, curSec, total);
      });
    }catch(e){
      console.error('watch_logs init error', e);
    }
  }

  let saveTimer = null;
  function saveProgress(cat, slug, currentSec, totalSec){
    try{
      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(async function(){
        try{
          const payload = {
            category: cat,
            slug: slug,
            user_id: userId,
            last_second: currentSec,
            duration_sec: totalSec
          };

          if (currentLogId){
            const { error } = await watchSupa
              .from('watch_logs')
              .update(payload)
              .eq('id', currentLogId);
            if (error) console.error('watch_logs update error', error);
          } else {
            const { data, error } = await watchSupa
              .from('watch_logs')
              .insert(payload)
              .select('id')
              .maybeSingle();
            if (error) {
              console.error('watch_logs insert error', error);
            } else if (data && data.id) {
              currentLogId = data.id;
            }
          }
        }catch(error){
          console.error('watch_logs saveProgress exception', error);
        }
      }, 2000);
    }catch(e){
      console.error('watch_logs saveProgress outer exception', e);
    }
  }

  // ç¨å¾®å»¶é²ä¸€ä¸‹ï¼Œè®“å‰é¢çš„å®ˆé–€ / å…¶å®ƒç¨‹å¼å…ˆè·‘å®Œ
  if (document.readyState === 'complete' || document.readyState === 'interactive'){
    setTimeout(initWatchLog, 600);
  }else{
    document.addEventListener('DOMContentLoaded', function(){
      setTimeout(initWatchLog, 600);
    });
  }
})();
</script>

</body>
</html>

