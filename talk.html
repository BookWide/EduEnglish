<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Talkï¼ˆæ¯é€±å£èªªï¼‰ï½œBookWide</title>
<style>
:root{
  --bg:#f4f6fb; --card:#fff; --ink:#0b1220; --muted:#5b667a; --line:#e6eaf0;
  --shadow:0 10px 28px rgba(10,20,40,.10);
  --r:18px;
  --brand:#0b66ff; --brand2:#084fc6;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
  background:var(--bg); color:var(--ink);
}
a{color:inherit; text-decoration:none}
.wrap{max-width:1120px; margin:0 auto; padding:14px 14px 28px}
.topbar{
  position:sticky; top:0; z-index:20;
  padding:10px 0 12px;
  background:linear-gradient(to bottom, rgba(244,246,251,.96), rgba(244,246,251,.86), rgba(244,246,251,0));
  backdrop-filter: blur(6px);
}
.toprow{display:flex; align-items:center; gap:12px; justify-content:space-between}
.leftgrp{display:flex; align-items:center; gap:12px}
.btnCircle{
  width:42px;height:42px;border-radius:999px;border:1px solid var(--line); background:#fff;
  display:grid;place-items:center; box-shadow:var(--shadow); cursor:pointer;
}
.hTitle{display:flex; flex-direction:column; line-height:1.1}
.hTitle b{font-size:22px}
.hTitle span{font-size:13px; color:var(--muted); margin-top:2px}
.rightgrp{display:flex; align-items:center; gap:10px}
.pillSel, .pillBtn{
  border:1px solid var(--line); background:#fff; border-radius:999px;
  padding:8px 12px; font-size:14px; box-shadow:var(--shadow);
}
.pillBtn{cursor:pointer}
.pillSel{appearance:none; padding-right:34px; background-image:linear-gradient(45deg, transparent 50%, #64748b 50%),linear-gradient(135deg, #64748b 50%, transparent 50%);
  background-position: calc(100% - 16px) 55%, calc(100% - 11px) 55%;
  background-size:5px 5px,5px 5px; background-repeat:no-repeat;
}
.card{
  background:var(--card); border:1px solid var(--line); border-radius:var(--r);
  box-shadow:var(--shadow);
}
.hero{
  display:flex; gap:14px; align-items:flex-start;
  padding:14px;
}
.avatarBox{width:82px; height:82px; border-radius:999px; border:1px solid var(--line); overflow:hidden; position:relative; background:#eef2ff}
.avatarBox .dot{position:absolute; left:8px; top:8px; width:12px; height:12px; border-radius:999px; background:#22c55e; border:2px solid #fff; z-index:2}
#teacherVideo{width:100%; height:100%; object-fit:cover; display:block; background:#eef2ff}
.bubble{
  flex:1;
  border:1px solid var(--line); border-radius:16px; padding:12px 14px;
  background:linear-gradient(180deg,#fff, #fbfcff);
}
.bubble .en{font-size:22px; font-weight:800; margin:0 0 4px}
.bubble .zh{margin:0; color:var(--muted); font-size:14px}
.bubble .meta{margin-top:10px; color:var(--muted); font-size:13px}
.actions{
  display:flex; gap:10px; align-items:center; padding:14px;
}
.bigMic{
  width:56px; height:56px; border-radius:999px; border:none;
  background:linear-gradient(180deg,var(--brand),var(--brand2));
  color:#fff; box-shadow:var(--shadow); cursor:pointer;
  display:grid; place-items:center;
}
.smallBtn{
  border:1px solid var(--line); background:#fff; border-radius:999px;
  padding:10px 14px; cursor:pointer; box-shadow:var(--shadow);
  font-size:14px;
}
.smallBtn.primary{background:#fff}
.smallBtn:active{transform:translateY(1px)}
.main{
  padding:0 14px 14px;
}
.panelTitle{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding:12px 4px 6px;
}
.panelTitle b{font-size:18px}
.rightTags{display:flex; gap:10px; align-items:center}
.tag{border:1px solid var(--line); background:#fff; border-radius:999px; padding:8px 12px; font-size:14px; box-shadow:var(--shadow)}
.replyBox{
  background:#fff; border:1px solid var(--line); border-radius:var(--r);
  padding:14px; box-shadow:var(--shadow);
}
.replyEn{font-size:26px; font-weight:900; margin:0 0 6px}
.replyHint{margin:0 0 10px; color:var(--muted); font-size:13px; line-height:1.5}
.chips{display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 14px}
.chip{
  border:1px solid var(--line); background:#fff; border-radius:999px; padding:8px 14px; cursor:pointer;
}
textarea{
  width:100%; min-height:86px; resize:vertical; border-radius:16px;
  border:1px solid var(--line); padding:12px 14px; font-size:16px; outline:none;
}
.replyActions{
  display:flex; gap:12px; align-items:center; margin-top:12px;
}
.sendBtn{
  border:none; cursor:pointer; border-radius:999px; padding:14px 18px;
  background:linear-gradient(180deg,var(--brand),var(--brand2)); color:#fff;
  font-weight:800; box-shadow:var(--shadow);
  display:flex; align-items:center; gap:10px;
}
.secondaryBtn{
  border:1px solid var(--line); background:#fff; border-radius:999px;
  padding:14px 18px; cursor:pointer; box-shadow:var(--shadow); font-weight:700;
}
.footerPad{height:18px}
@media (max-width:720px){
  .wrap{padding:10px 10px 20px}
  .bubble .en{font-size:18px}
  .replyEn{font-size:22px}
  .avatarBox{width:74px;height:74px}
}
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="toprow">
        <div class="leftgrp">
          <button class="btnCircle" id="btnBack" title="å›ä¸Šä¸€é ">â†</button>
          <div class="hTitle">
            <b>Talk</b>
            <span>æ¯é€±å£èªª Â· Browser Speech</span>
          </div>
        </div>
        <div class="rightgrp">
          <select id="weekSel" class="pillSel" title="é€±åˆ¥ / å ´æ™¯"></select>
          <select id="teacherSel" class="pillSel" title="é¸è€å¸«">
            <option value="teacher.mp4">é è¨­ teacher.mp4</option>
            <option value="Diana.mp4">Diana</option>
            <option value="Emma.mp4">Emma</option>
            <option value="Sophia.mp4">Sophia</option>
          </select>
          <button class="pillBtn" id="btnReplay" title="é‡æ’­">é‡æ’­</button>
        </div>
      </div>
    </div>

    <div class="card hero">
      <div class="avatarBox" title="AI è€å¸«">
        <div class="dot"></div>
        <video id="teacherVideo" playsinline muted preload="auto"></video>
      </div>
      <div class="bubble">
        <p class="en" id="aiEn">â€¦</p>
        <p class="zh" id="aiZh">â€¦</p>
        <div class="meta" id="metaLine">æœ¬é€±ï¼šâ€”ã€€é€²åº¦ â€”</div>
      </div>
    </div>

    <div class="actions">
      <button class="bigMic" id="btnMic" title="èªéŸ³è¼¸å…¥">ğŸ¤</button>
      <button class="smallBtn" id="btnType">è¼¸å…¥</button>
      <button class="smallBtn" id="btnSkip">è·³é</button>
      <button class="smallBtn" id="btnHint">æç¤º</button>
      <button class="smallBtn" id="btnSave">æ”¶è—</button>
      <button class="smallBtn" id="btnCloze">å¡«ç©ºå¼•å°</button>
    </div>

    <div class="main">
      <div class="panelTitle">
        <b>ä½ çš„å›è¦†</b>
        <div class="rightTags">
          <span class="tag" id="modeTag">A1</span>
          <button class="tag" id="btnHide">éš±è—</button>
        </div>
      </div>

      <div class="replyBox" id="replyBox">
        <p class="replyEn" id="qText">â€¦</p>
        <p class="replyHint" id="qHint">å°è©±æ¨¡å¼ï¼šAI å…ˆèªªä¸€å¥ï¼Œç­‰ä½ å›è¦†ï¼ˆèªéŸ³æˆ–è¼¸å…¥ï¼‰æ‰æœƒé€²ä¸‹ä¸€å¥ã€‚</p>

        <div class="chips" id="chips"></div>

        <textarea id="userInput" placeholder="å¡«å…¥ç©ºæ ¼..."></textarea>

        <div class="replyActions">
          <button class="sendBtn" id="btnSend"><span>âœ…</span><span>é€å‡ºå¡«å¥½å¥</span></button>
          <button class="secondaryBtn" id="btnReset">é‡ä¾†</button>
        </div>
      </div>

      <div class="footerPad"></div>
    </div>
  </div>

<script>
/* =========================
   Talk Clean A (teacher picker + supabase teacher.mp4)
   - è€å¸«å½±ç‰‡ï¼šé è¨­è®€ Supabase talk/teacher/teacher.mp4
   - å­¸å“¡å¯åœ¨å³ä¸Šé¸ Diana/Emma/Sophia/teacher.mp4
   - å½±ç‰‡åœ¨ TTS é–‹å§‹æ™‚æ’­æ”¾ï¼ŒTTS çµæŸå°±åœåœ¨ç¬¬ä¸€æ ¼ï¼ˆé¿å…ä¸€ç›´æ–é ­æ“ºå‹•ï¼‰
   ========================= */

const SUPABASE_TALK_BASE = "https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/talk";
const TEACHER_BASE = SUPABASE_TALK_BASE + "/teacher";
const INDEX_URL = SUPABASE_TALK_BASE + "/index.json";

const $ = (id)=>document.getElementById(id);
const teacherVideo = $("teacherVideo");
const teacherSel = $("teacherSel");
const weekSel = $("weekSel");

let talkIndex = null;        // index.json
let currentKey = "";         // selected week/scene key
let currentTalk = null;      // scene json
let iLine = 0;               // line index
let lastAiText = "";         // last AI english
let speaking = false;

/* ---------- teacher video ---------- */
function teacherUrl(file){
  const f = (file || "teacher.mp4").trim();
  // cache busting: ä½ è¦†è“‹åŒæª”åä¹Ÿèƒ½ç«‹åˆ»çœ‹åˆ°æ›´æ–°
  return `${TEACHER_BASE}/${encodeURIComponent(f)}?v=${Date.now()}`;
}
function freezeTeacher(){
  try{
    teacherVideo.pause();
    teacherVideo.currentTime = 0;
  }catch(_){}
}
async function playTeacher(){
  try{
    teacherVideo.loop = true;
    // iOS: play å¿…é ˆåœ¨ user gesture å¾Œæ‰ç©©ï¼Œé€™è£¡å¤±æ•—å°±å¿½ç•¥
    await teacherVideo.play();
  }catch(_){}
}
function setTeacher(file){
  const url = teacherUrl(file);
  teacherVideo.src = url;
  teacherVideo.load();
  freezeTeacher();
}

/* ---------- speech (TTS) ---------- */
function speak(text){
  return new Promise((resolve)=>{
    if(!text) return resolve();
    if(!("speechSynthesis" in window)) return resolve();

    // stop any ongoing
    try{ window.speechSynthesis.cancel(); }catch(_){}

    const ut = new SpeechSynthesisUtterance(text);
    ut.lang = "en-US";
    ut.rate = 1.0;
    ut.pitch = 1.0;

    ut.onstart = async ()=>{
      speaking = true;
      await playTeacher();
    };
    ut.onend = ()=>{
      speaking = false;
      freezeTeacher();
      resolve();
    };
    ut.onerror = ()=>{
      speaking = false;
      freezeTeacher();
      resolve();
    };
    window.speechSynthesis.speak(ut);
  });
}

/* ---------- recognition (optional) ---------- */
let rec = null;
function initRec(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR) return null;
  const r = new SR();
  r.lang = "en-US";
  r.interimResults = false;
  r.maxAlternatives = 1;
  return r;
}
rec = initRec();

/* ---------- data loading ---------- */
async function fetchJson(url){
  const r = await fetch(url, { cache: "no-store" });
  if(!r.ok) throw new Error("fetch failed " + r.status);
  return await r.json();
}
function normSceneUrl(u){
  if(!u) return "";
  if(/^https?:\/\//i.test(u)) return u;
  // relative in index -> put under talk bucket
  return SUPABASE_TALK_BASE + "/" + u.replace(/^\/+/,"");
}
function sceneFromQuery(){
  const u = new URL(location.href);
  const scene = u.searchParams.get("scene") || "";
  return scene;
}
function teacherFromQuery(){
  const u = new URL(location.href);
  return u.searchParams.get("teacher") || "";
}
function setQuery(params){
  const u = new URL(location.href);
  Object.entries(params).forEach(([k,v])=>{
    if(v===null || v===undefined || v==="") u.searchParams.delete(k);
    else u.searchParams.set(k, v);
  });
  history.replaceState({}, "", u.toString());
}

/* ---------- UI update ---------- */
function setAiBubble(en, zh){
  $("aiEn").textContent = en || "â€¦";
  $("aiZh").textContent = zh || "â€¦";
}
function setReply(en){
  $("qText").textContent = en || "â€¦";
}
function setMeta(){
  const total = (currentTalk?.lines?.length || 0);
  const idx = Math.min(iLine+1, total);
  const title = currentTalk?.title || currentTalk?.scene || currentKey || "â€”";
  $("metaLine").textContent = `æœ¬é€±ï¼š${title} Â· é€²åº¦ ${idx}/${total || "â€”"}`;
}
function renderChips(list){
  const box = $("chips");
  box.innerHTML = "";
  (list||[]).slice(0,8).forEach(w=>{
    const b = document.createElement("button");
    b.className="chip";
    b.type="button";
    b.textContent = w;
    b.onclick = ()=>{
      const t = $("userInput");
      t.value = (t.value || "").trim();
      if(t.value && !t.value.endsWith(" ")) t.value += " ";
      t.value += w;
      t.focus();
    };
    box.appendChild(b);
  });
}
function simpleHintsFrom(en){
  if(!en) return [];
  const words = en.replace(/[^a-zA-Z\s']/g," ").split(/\s+/).filter(Boolean);
  const uniq = [];
  for(const w of words){
    const lw = w.toLowerCase();
    if(lw.length<=2) continue;
    if(!uniq.includes(lw)) uniq.push(lw);
    if(uniq.length>=3) break;
  }
  return uniq;
}

/* ---------- talk flow ---------- */
async function loadIndex(){
  talkIndex = await fetchJson(INDEX_URL);
  // index æ”¯æ´ï¼šarray æˆ– object
  const items = Array.isArray(talkIndex) ? talkIndex : (talkIndex.items || talkIndex.scenes || []);
  // populate selector
  weekSel.innerHTML = "";
  items.forEach((it, n)=>{
    const key = it.key || it.id || it.scene || ("scene"+(n+1));
    const label = it.label || it.title || it.scene || key;
    const opt = document.createElement("option");
    opt.value = key;
    opt.textContent = label;
    weekSel.appendChild(opt);
  });
  // decide default
  const qScene = sceneFromQuery();
  const found = items.find(it => (it.key||it.id||it.scene) === qScene);
  const firstKey = (items[0] && (items[0].key||items[0].id||items[0].scene)) || "";
  currentKey = qScene || firstKey;
  weekSel.value = currentKey;
  await loadSceneByKey(currentKey);
}
function findSceneItemByKey(key){
  const items = Array.isArray(talkIndex) ? talkIndex : (talkIndex.items || talkIndex.scenes || []);
  return items.find(it => (it.key||it.id||it.scene) === key) || null;
}
async function loadSceneByKey(key){
  const it = findSceneItemByKey(key);
  if(!it){
    currentTalk = { title:key, lines:[] };
    iLine = 0;
    setAiBubble("æ‰¾ä¸åˆ°å ´æ™¯", "");
    setReply("");
    setMeta();
    return;
  }
  currentKey = key;
  const sceneUrl = normSceneUrl(it.url || it.file || it.json || it.path || "");
  currentTalk = await fetchJson(sceneUrl + (sceneUrl.includes("?") ? "&" : "?") + "v=" + Date.now());
  iLine = 0;
  setQuery({ scene: currentKey });
  await showLine(iLine, true);
}
async function showLine(idx, autoSpeak){
  const lines = currentTalk?.lines || currentTalk?.dialogue || [];
  if(!lines.length){
    setAiBubble("ï¼ˆæ­¤å ´æ™¯æ²’æœ‰è³‡æ–™ï¼‰", "");
    setReply("");
    renderChips([]);
    setMeta();
    return;
  }
  iLine = Math.max(0, Math.min(idx, lines.length-1));
  const L = lines[iLine];
  const ai = L.ai || L.q || L.en || L.english || L.text || "";
  const zh = L.zh || L.tw || L.cn || L.chinese || "";
  const suggest = L.suggest || L.a || L.answer || L.reply || "";
  lastAiText = ai;

  setAiBubble(ai, zh);
  setReply(suggest || "â€¦");
  $("userInput").value = "";
  renderChips(L.chips || L.words || simpleHintsFrom(suggest || ai));
  setMeta();

  if(autoSpeak) await speak(ai);
}
async function nextLine(){
  const lines = currentTalk?.lines || currentTalk?.dialogue || [];
  if(iLine < lines.length-1){
    await showLine(iLine+1, true);
  }else{
    // finished
    await speak("Great. You're done.");
  }
}

/* ---------- buttons ---------- */
$("btnBack").onclick = ()=>{ history.back(); };

$("btnReplay").onclick = async ()=>{
  await speak(lastAiText || $("aiEn").textContent || "");
};

weekSel.onchange = async ()=>{
  await loadSceneByKey(weekSel.value);
};

teacherSel.onchange = ()=>{
  setTeacher(teacherSel.value);
  setQuery({ teacher: teacherSel.value.replace(/\.mp4$/i,"") });
};

$("btnType").onclick = ()=>{
  $("userInput").focus();
};

$("btnSkip").onclick = async ()=>{
  await nextLine();
};

$("btnHint").onclick = ()=>{
  // æŠŠå»ºè­°å¥ç›´æ¥å¡é€²è¼¸å…¥æ¡†
  const t = $("qText").textContent || "";
  $("userInput").value = t.replace(/^â€¦$/,"").trim();
  $("userInput").focus();
};

$("btnCloze").onclick = ()=>{
  // ç”Ÿæˆç°¡å–®å¡«ç©ºï¼šæŠŠå»ºè­°å¥æœ€é•·å–®å­—æŒ–æ‰
  const s = ($("qText").textContent||"").trim();
  if(!s || s==="â€¦") return;
  const ws = s.split(/\s+/);
  let bestI = -1, bestL = 0;
  ws.forEach((w, i)=>{
    const clean = w.replace(/[^a-zA-Z']/g,"");
    if(clean.length > bestL){
      bestL = clean.length; bestI = i;
    }
  });
  if(bestI>=0){
    ws[bestI] = "_____";
    $("userInput").value = ws.join(" ");
    $("userInput").focus();
  }
};

$("btnSend").onclick = async ()=>{
  // é€™è£¡å…ˆä¸åšåˆ¤æ–·å°éŒ¯ï¼šé€å‡ºå°±é€²ä¸‹ä¸€å¥ï¼ˆç©©å®šç‰ˆï¼‰
  await nextLine();
};

$("btnReset").onclick = async ()=>{
  await showLine(0, true);
};

$("btnHide").onclick = ()=>{
  const box = $("replyBox");
  const hidden = box.style.display === "none";
  box.style.display = hidden ? "" : "none";
  $("btnHide").textContent = hidden ? "éš±è—" : "é¡¯ç¤º";
};

$("btnMic").onclick = ()=>{
  if(!rec){
    alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜");
    return;
  }
  try{
    rec.onresult = async (e)=>{
      const text = (e.results && e.results[0] && e.results[0][0] && e.results[0][0].transcript) ? e.results[0][0].transcript : "";
      $("userInput").value = text;
      await nextLine();
    };
    rec.onerror = ()=>{};
    rec.start();
  }catch(_){}
};

/* ---------- init ---------- */
(function init(){
  // teacher from query
  const t = teacherFromQuery();
  if(t){
    const file = (t.endsWith(".mp4") ? t : (t + ".mp4"));
    // if not in options, add
    if(!Array.from(teacherSel.options).some(o => o.value===file)){
      const opt = document.createElement("option");
      opt.value = file; opt.textContent = file.replace(/\.mp4$/i,"");
      teacherSel.insertBefore(opt, teacherSel.firstChild);
    }
    teacherSel.value = file;
    setTeacher(file);
  }else{
    setTeacher("teacher.mp4");
  }

  // start: keep teacher frozen until first speak
  freezeTeacher();

  // load data
  loadIndex().catch(err=>{
    console.error(err);
    setAiBubble("è¼‰å…¥å¤±æ•—", "è«‹ç¢ºèª talk/index.json æ˜¯å¦å­˜åœ¨");
    setReply("");
    $("metaLine").textContent = "â€”";
  });
})();
</script>
</body>
</html>
