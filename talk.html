<!doctype html>
<html lang="zh-Hant">
<head>
<!-- ===== BookWide Guard (Talk: subscription required) ===== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(async function() {
  try {
    const SUPABASE_URL = 'https://jeajrwpmrgczimmrflxo.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });
    // expose for other modules (Talk placement / learning console)
    window.BW = window.BW || {};
    window.BW.supabase = supabase;


    // --- require login ---
    const { data: sess } = await supabase.auth.getSession();
    const session = sess && sess.session;
    window.BW.session = session || null;
    window.BW.user = (session && session.user) ? session.user : null;
    if (!session || !session.user) {
      const red = encodeURIComponent(location.pathname + location.search + location.hash);
      location.replace('/account/login.html?redirect=' + red);
      return;
    }

    const uid = session.user.id;

    // --- read profile (RLS: profiles_select_own) ---
    const { data: prof, error } = await supabase
      .from('profiles')
      .select('id, expires_at, is_paused')
      .eq('id', uid)
      .maybeSingle();

    if (error) {
      // è®€ä¸åˆ° profileï¼šä¿å®ˆå°å›è¨‚é–±é 
      location.replace('/account/subscription.html?err=profile');
      return;
    }

    const paused = !!(prof && prof.is_paused);
    const exp = prof && prof.expires_at ? String(prof.expires_at) : '';
    const today = new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Taipei' }); // YYYY-MM-DD

    const ok = (!paused) && exp && (exp >= today);

    // expose (optional)
    window.BW_SUB_OK = ok;
    window.BW_SUB_EXPIRES_AT = exp || null;

    if (!ok) {
      // æœªè¨‚é–± / å·²åˆ°æœŸ / æš«åœ
      location.replace('/account/subscription.html');
      return;
    }
  } catch (e) {
    // guard æœ¬èº«å‡ºéŒ¯ï¼šä¿å®ˆå°å›è¨‚é–±é ï¼ˆé¿å…ç„¡é™è¿´åœˆï¼‰
    location.replace('/account/subscription.html?err=guard');
  }
})();
</script>
<!-- ===== /BookWide Guard ===== -->

<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Talkï¼ˆæ¯é€±å£èªªï¼‰ï½œBookWide</title>
<style>
:root{
  --bg:#f4f6fb; --card:#fff; --ink:#0b1220; --muted:#5b667a; --line:#e6eaf0;
  --shadow:0 10px 28px rgba(10,20,40,.10); --r:18px; --r2:24px;
  --brand:#0b66ff; --brand2:#084fc6; --soft:#f6f8fb;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
  background:var(--bg); color:var(--ink);
  overscroll-behavior: none;
  padding-bottom:18px;
}
a{color:inherit}
.wrap{max-width:980px; margin:0 auto; padding:14px 14px 24px}
.card{background:var(--card); border:1px solid var(--line); border-radius:var(--r2); box-shadow:var(--shadow)}
.topbar{padding:14px; display:flex; gap:10px; align-items:center; justify-content:space-between}
.leftTop{display:flex; align-items:center; gap:12px}
.btnIcon{
  width:44px; height:44px; border-radius:999px; border:1px solid var(--line);
  background:#fff; display:grid; place-items:center; box-shadow:0 6px 18px rgba(10,20,40,.08);
}
.brandTitle{font-weight:800; font-size:22px; line-height:1}
.sub{font-size:12px; color:var(--muted); margin-top:4px}
.rightTop{display:flex; gap:10px; align-items:center}
.smallBtn{
  border:1px solid var(--line); background:#fff; border-radius:999px; padding:10px 12px;
  font-weight:700; color:var(--brand2); box-shadow:0 6px 18px rgba(10,20,40,.08);
}
.smallBtn:active{transform:translateY(1px)}
.pill{
  border:1px solid var(--line); background:#fff; border-radius:999px; padding:10px 12px;
  display:flex; align-items:center; gap:8px; font-weight:800;
}
.pill select{border:none;background:transparent;font:inherit;color:inherit;outline:none;padding:0 2px;}
.pill .meta{margin-right:6px;opacity:.75;font-size:12px;}
.pill .meta{font-size:12px; color:var(--muted); font-weight:700}
.grid{display:grid; grid-template-columns:1fr; gap:14px; padding:14px}
.hero{padding:14px}
.heroRow{display:flex; gap:14px; align-items:center}
.avatar{
  width:92px; height:92px; border-radius:999px;
  border:1px solid var(--line);
  background: radial-gradient(circle at 30% 30%, #ffffff 0%, #eef3ff 40%, #e8eefb 100%);
  box-shadow:inset 0 0 0 10px rgba(255,255,255,.6);
  position:relative; flex:0 0 auto;
}
  .avatar{ position:relative; overflow:hidden; }
  .teacherMedia{ width:100%; height:100%; object-fit:cover; border-radius:999px; display:block; }

.dot{position:absolute; left:12px; top:14px; width:12px; height:12px; border-radius:999px; background:#22c55e; box-shadow:0 0 0 4px rgba(34,197,94,.15)}
.heroText{min-width:0}
.sceneTitle{font-weight:900; font-size:16px}
.sceneSub{color:var(--muted); font-size:12px; margin-top:4px}
.big{
  padding:16px; border-radius:var(--r2); border:1px solid var(--line);
  background:var(--soft);
}
.big .en{font-size:34px; font-weight:900; letter-spacing:.2px}
.big .zh{margin-top:10px; font-size:15px; color:var(--muted)}
.controls{
  display:grid; grid-template-columns:86px 1fr 1fr; gap:12px; align-items:center;
}
.mic{
  width:86px; height:86px; border-radius:999px; border:none;
  background:linear-gradient(180deg,var(--brand) 0%, var(--brand2) 100%);
  color:#fff; font-size:28px; font-weight:900;
  box-shadow:0 16px 40px rgba(11,102,255,.35);
}
.ctrlBtn{
  height:52px; border-radius:999px; border:1px solid var(--line);
  background:#fff; font-weight:900; font-size:18px; color:var(--brand2);
  display:flex; align-items:center; justify-content:center; gap:10px;
  box-shadow:0 10px 24px rgba(10,20,40,.08);
}
.ctrlBtn small{font-size:14px; color:var(--muted); font-weight:800}
.row2{display:flex; gap:10px; flex-wrap:wrap}
.chip{
  border:1px solid var(--line); border-radius:999px; background:#fff;
  padding:10px 12px; font-weight:900; color:var(--ink);
}
.chip.on{background:#0b1220; color:#fff; border-color:#0b1220}
.fillCard{padding:14px}
.fillHead{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px}
.fillHead .h{font-weight:900; font-size:18px}
.badges{display:flex; gap:10px; align-items:center}
.badge{
  border:1px solid var(--line); border-radius:999px; padding:8px 12px; background:#fff;
  font-weight:900; color:var(--muted);
}
.badge.lev{color:#0b1220}
.fillEn{font-size:34px; font-weight:950; line-height:1.05}
.fillHint{margin-top:10px; color:var(--muted); font-weight:700}
.fillRow{display:flex; gap:10px; margin-top:14px; align-items:center}
.primary{
  height:54px; border-radius:999px; border:none;
  background:linear-gradient(180deg,var(--brand) 0%, var(--brand2) 100%);
  color:#fff; font-weight:950; padding:0 18px; font-size:18px;
  box-shadow:0 16px 40px rgba(11,102,255,.28);
}
.ghost{
  height:54px; border-radius:999px; border:1px solid var(--line); background:#fff;
  font-weight:950; padding:0 18px; font-size:18px; color:var(--brand2);
}
.inp{
  width:100%; height:54px; border-radius:16px; border:1px solid var(--line);
  padding:0 14px; font-size:18px; font-weight:800; outline:none;
  background:#fff;
}
.toast{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:18px; background:#0b1220; color:#fff; padding:10px 12px;
  border-radius:999px; font-weight:800; font-size:13px;
  box-shadow:0 18px 45px rgba(0,0,0,.25);
  max-width:min(92vw,520px); display:none;
}
.modalMask{position:fixed; inset:0; background:rgba(0,0,0,.34); display:none; align-items:flex-start; justify-content:center; padding:18px}
.modal{
  width:min(720px, 94vw);
  background:#fff; border:1px solid var(--line);
  border-radius:24px; box-shadow:0 24px 80px rgba(0,0,0,.25);
  overflow:hidden;
}
.modalTop{padding:14px 14px 10px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--line)}
.modalTop .t{font-weight:950}
.modalBody{padding:12px; max-height:70vh; overflow:auto}
.group{border:1px solid var(--line); border-radius:18px; overflow:hidden; margin-bottom:12px}
.group .gHead{padding:10px 12px; background:#f7f9ff; font-weight:950; display:flex; justify-content:space-between; align-items:center}
.group .gHead .lock{font-size:12px; color:var(--muted); font-weight:900}
.item{padding:12px; border-top:1px solid var(--line); display:flex; gap:10px; align-items:center; justify-content:space-between}
.item .name{font-weight:900}
.item .sub{margin:0; font-size:12px}
.item button{white-space:nowrap}
@media (max-width:520px){
  .wrap{padding:10px 10px 18px}
  .topbar{padding:12px}
  .brandTitle{font-size:20px}
  .big .en{font-size:30px}
  .fillEn{font-size:30px}
  .controls{grid-template-columns:78px 1fr 1fr}
  .mic{width:78px; height:78px; font-size:26px}
  .ctrlBtn{height:50px; font-size:17px}
}

/* ===== Mobile compact (v3) ===== */
@media (max-width: 520px){
  .brandTitle{font-size:14px}
  .sub{font-size:10px}
  .pill .meta{font-size:10px}
  .sceneTitle{font-size:13px}
  .sceneSub{font-size:10px}
  .big .en{font-size:20px}
  .big .zh{font-size:12px}
  .micBtn{min-height:64px}
  .micBtn .label{font-size:14px}
  .ctrlBtn{min-height:44px}
  .ctrlBtn span{font-size:14px}
  .ctrlBtn small{font-size:11px}
  .fillCard{padding:12px}
  .fillHead .h{font-size:14px}
  .fillEn{font-size:20px}
  .fillHint{font-size:11px}
  .fillSend,.fillReroll{min-height:44px; font-size:14px; padding:0 14px}
  .fillInput{min-height:44px; font-size:14px}
  .chip{font-size:11px; padding:8px 10px}
}
.fileTag{display:inline-block; margin-left:10px; font-size:12px; color:var(--muted); max-width:240px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
.bottomPanel{
  position:sticky; bottom:10px; left:auto; transform:none;
  width:100%;
  margin-top:12px;
  border:1px solid var(--line);
  border-radius:var(--r2);
  background:var(--card);
  box-shadow:0 10px 28px rgba(10,20,40,.10);
  padding:12px 14px;
  z-index:5;
}
.bpRow{display:flex; gap:10px; align-items:flex-start;}
.bpTitle{flex:0 0 auto; font-weight:800; font-size:13px; padding:4px 10px; border-radius:999px; background:var(--soft); color:var(--brand2);}
.bpBody{flex:1 1 auto; font-size:13px; color:var(--ink); line-height:1.35; min-height:22px;}
.bpLinks{margin-top:8px; display:flex; gap:10px; flex-wrap:wrap;}
.bpLink{font-size:12px; color:var(--brand2); text-decoration:none; padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:#fff;}
.bpLink:hover{background:var(--soft);}
@media (max-width:520px){
  .fileTag{max-width:120px}
  .bottomPanel{bottom:8px; padding:10px 12px; border-radius:16px;}
}

/* ===== V8.5 Mobile Topbar Tighten (2026-01-10) ===== */
@media (max-width:520px){
  .wrap{padding:6px 10px 14px !important;}
  .topbar{padding:8px 10px !important; gap:8px !important;}
  .backBtn,.back{width:40px !important; height:40px !important; border-radius:14px !important;}
  .brandTitle{font-size:13px !important;}
  .sub{font-size:9px !important; margin-top:2px !important;}
  .pill{padding:6px 8px !important; gap:6px !important;}
  .pill .meta{font-size:9px !important;}
  .pill .w{font-size:12px !important;}
  .replayBtn,.btnReplay{width:44px !important; height:44px !important; font-size:12px !important;}
  .hero{padding:10px !important;}
  .avatar{width:72px !important; height:72px !important;}
  .sceneTitle{font-size:14px !important;}
  .sceneSub{font-size:10px !important;}
  .big{padding:12px !important;}
  .big .zh{margin-top:4px !important; font-size:10px !important;}
}


/* ====== v7-ultra-compact-2 (2026-01-10) ======
   - æ›´æ¿€é€²ç¸®å°è¡Œè·/é–“è·ï¼ˆæ‰‹æ©Ÿä¸€é å®¹ç´æ›´å¤šï¼‰
   - ç¸®å°å¤§å¥å­ã€å¡«ç©ºã€é€å‡º/é‡ä¾†æŒ‰éˆ•ã€å¡ç‰‡ padding/margin
*/
:root{
  --card-pad:10px;
}

/* overall */
.wrap{padding:8px 10px 12px !important;}
.card{padding:var(--card-pad) !important; margin:8px 0 !important;}
.hr{margin:8px 0 !important;}

/* topbar */
.topbar{padding:6px 10px !important; gap:8px !important;}
.iconBtn{width:36px !important; height:36px !important;}
.brand .t{font-size:18px !important; line-height:1.05 !important;}
.brand .s{font-size:12px !important; margin-top:1px !important; line-height:1.05 !important;}
.smallBtn{padding:6px 10px !important; border-radius:999px !important; font-size:12px !important;}

/* status/hero cards */
.hero{padding:10px !important;}
.heroGrid{gap:10px !important;}
.avatarWrap{width:74px !important; height:74px !important;}
.heroTitle{font-size:18px !important; margin-bottom:2px !important; line-height:1.1 !important;}
.heroSub{font-size:12px !important; line-height:1.15 !important;}
.progress{font-size:12px !important; line-height:1.15 !important;}

/* big sentence (AI line) */
.big .en{font-size:24px !important; line-height:1.05 !important;}
.big .zh{margin-top:4px !important; font-size:12px !important; line-height:1.15 !important;}

/* controls block */
.controls{margin-top:8px !important;}
.ctrlRow{gap:10px !important;}
.micBtn{width:64px !important; height:64px !important;}
.ctrlBtn{height:40px !important; padding:0 14px !important; font-size:14px !important;}
.ctrlBtn .ico{font-size:16px !important; margin-right:8px !important;}
.ctrlRow2{gap:10px !important; margin-top:8px !important;}
.pillBtn{padding:8px 14px !important; font-size:14px !important;}

/* reply / fill card */
.replyCard{padding:10px !important;}
.replyHead{margin-bottom:6px !important;}
.replyTitle{font-size:16px !important; line-height:1.05 !important;}
.replyDesc{font-size:11px !important; line-height:1.15 !important; margin-top:4px !important;}
.fillEn{font-size:24px !important; line-height:1.05 !important;}
.fillHint{margin-top:4px !important; font-size:11px !important; line-height:1.15 !important;}
.input{margin-top:8px !important; padding:10px 12px !important; font-size:14px !important; border-radius:16px !important;}

/* action buttons (é€å‡º/é‡ä¾†) */
.fillActions{gap:10px !important; margin-top:10px !important;}
.fillSend{
  min-height:36px !important;
  padding:0 14px !important;
  font-size:14px !important;
  border-radius:18px !important;
  box-shadow:0 10px 22px rgba(37,99,235,.22) !important;
}
.fillReroll{
  min-height:36px !important;
  padding:0 14px !important;
  font-size:14px !important;
  border-radius:18px !important;
}
.fillSend .check{width:22px !important; height:22px !important; margin-right:8px !important; font-size:13px !important;}

/* bottom sheet/panel */
.bottomPanel{margin-top:10px !important;}
.sheetTabs{gap:10px !important;}
.sheetTab{padding:8px 12px !important; font-size:14px !important;}
.sheet{margin-top:8px !important;}
.sheetBody{padding:10px !important;}
.taskItem{padding:10px !important; margin-bottom:8px !important;}
.taskItem .k{font-size:14px !important; margin-bottom:4px !important;}
.taskItem .v{font-size:12px !important; line-height:1.2 !important;}

</style>

<style id="v8-redo-patch">
/* === V8 REDO PATCH === */
/* Reduce dialogue text ~50% */
.big .en { font-size: 17px !important; }
.big .zh { font-size: 12px !important; }
.fillEn { font-size: 17px !important; }
.fillHint, .bpBody, .sceneSub { font-size: 11px !important; }
.sceneTitle { font-size: 13px !important; }

/* Integrate bottom task panel into page flow (no floating) */
.bottomPanel{
  position: static !important;
  margin-top: 12px !important;
  box-shadow: none !important;
}
@media (max-width:520px){
  .big .en { font-size: 16px !important; }
  .fillEn { font-size: 16px !important; }
}

/* ===== V8.5 Mobile Topbar Tighten (2026-01-10) ===== */
@media (max-width:520px){
  .wrap{padding:6px 10px 14px !important;}
  .topbar{padding:8px 10px !important; gap:8px !important;}
  .backBtn,.back{width:40px !important; height:40px !important; border-radius:14px !important;}
  .brandTitle{font-size:13px !important;}
  .sub{font-size:9px !important; margin-top:2px !important;}
  .pill{padding:6px 8px !important; gap:6px !important;}
  .pill .meta{font-size:9px !important;}
  .pill .w{font-size:12px !important;}
  .replayBtn,.btnReplay{width:44px !important; height:44px !important; font-size:12px !important;}
  .hero{padding:10px !important;}
  .avatar{width:72px !important; height:72px !important;}
  .sceneTitle{font-size:14px !important;}
  .sceneSub{font-size:10px !important;}
  .big{padding:12px !important;}
  .big .zh{margin-top:4px !important; font-size:10px !important;}
}


/* ====== v7-ultra-compact-2 (2026-01-10) ======
   - æ›´æ¿€é€²ç¸®å°è¡Œè·/é–“è·ï¼ˆæ‰‹æ©Ÿä¸€é å®¹ç´æ›´å¤šï¼‰
   - ç¸®å°å¤§å¥å­ã€å¡«ç©ºã€é€å‡º/é‡ä¾†æŒ‰éˆ•ã€å¡ç‰‡ padding/margin
*/
:root{
  --card-pad:10px;
}

/* overall */
.wrap{padding:8px 10px 12px !important;}
.card{padding:var(--card-pad) !important; margin:8px 0 !important;}
.hr{margin:8px 0 !important;}

/* topbar */
.topbar{padding:6px 10px !important; gap:8px !important;}
.iconBtn{width:36px !important; height:36px !important;}
.brand .t{font-size:18px !important; line-height:1.05 !important;}
.brand .s{font-size:12px !important; margin-top:1px !important; line-height:1.05 !important;}
.smallBtn{padding:6px 10px !important; border-radius:999px !important; font-size:12px !important;}

/* status/hero cards */
.hero{padding:10px !important;}
.heroGrid{gap:10px !important;}
.avatarWrap{width:74px !important; height:74px !important;}
.heroTitle{font-size:18px !important; margin-bottom:2px !important; line-height:1.1 !important;}
.heroSub{font-size:12px !important; line-height:1.15 !important;}
.progress{font-size:12px !important; line-height:1.15 !important;}

/* big sentence (AI line) */
.big .en{font-size:24px !important; line-height:1.05 !important;}
.big .zh{margin-top:4px !important; font-size:12px !important; line-height:1.15 !important;}

/* controls block */
.controls{margin-top:8px !important;}
.ctrlRow{gap:10px !important;}
.micBtn{width:64px !important; height:64px !important;}
.ctrlBtn{height:40px !important; padding:0 14px !important; font-size:14px !important;}
.ctrlBtn .ico{font-size:16px !important; margin-right:8px !important;}
.ctrlRow2{gap:10px !important; margin-top:8px !important;}
.pillBtn{padding:8px 14px !important; font-size:14px !important;}

/* reply / fill card */
.replyCard{padding:10px !important;}
.replyHead{margin-bottom:6px !important;}
.replyTitle{font-size:16px !important; line-height:1.05 !important;}
.replyDesc{font-size:11px !important; line-height:1.15 !important; margin-top:4px !important;}
.fillEn{font-size:24px !important; line-height:1.05 !important;}
.fillHint{margin-top:4px !important; font-size:11px !important; line-height:1.15 !important;}
.input{margin-top:8px !important; padding:10px 12px !important; font-size:14px !important; border-radius:16px !important;}

/* action buttons (é€å‡º/é‡ä¾†) */
.fillActions{gap:10px !important; margin-top:10px !important;}
.fillSend{
  min-height:36px !important;
  padding:0 14px !important;
  font-size:14px !important;
  border-radius:18px !important;
  box-shadow:0 10px 22px rgba(37,99,235,.22) !important;
}
.fillReroll{
  min-height:36px !important;
  padding:0 14px !important;
  font-size:14px !important;
  border-radius:18px !important;
}
.fillSend .check{width:22px !important; height:22px !important; margin-right:8px !important; font-size:13px !important;}

/* bottom sheet/panel */
.bottomPanel{margin-top:10px !important;}
.sheetTabs{gap:10px !important;}
.sheetTab{padding:8px 12px !important; font-size:14px !important;}
.sheet{margin-top:8px !important;}
.sheetBody{padding:10px !important;}
.taskItem{padding:10px !important; margin-bottom:8px !important;}
.taskItem .k{font-size:14px !important; margin-bottom:4px !important;}
.taskItem .v{font-size:12px !important; line-height:1.2 !important;}

</style>


<style id="v8-controls-compact-v2">
/* === V8 Controls Compact V2 (real merge + clear active) === */
.controlsWrap{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;          /* small screens wrap gracefully */
  margin-top: 6px;
  margin-bottom: 6px;
}

/* make the two inner rows behave like one bar */
.controls, .row2{
  display:flex !important;
  align-items:center;
  gap:10px !important;
  margin:0 !important;
  padding:0 !important;
  box-shadow:none !important;
  background:transparent !important;
}

/* shrink mic + buttons by sizing, NOT transform (keeps layout + tap target sane) */
.mic{
  width:52px !important;
  height:52px !important;
  border-radius:50% !important;
  font-size:20px !important;
  box-shadow: 0 10px 24px rgba(15,23,42,.14) !important;
}
.ctrlBtn{
  height:40px !important;
  padding:0 14px !important;
  font-size:12px !important;
  border-radius:999px !important;
}
.ctrlBtn span{ font-size:12px !important; }

/* chips */
.chip{
  height:34px !important;
  padding:0 12px !important;
  font-size:12px !important;
  border-radius:999px !important;
}

/* clearer pressed/active feedback */
.ctrlBtn:active, .chip:active, .mic:active{
  transform: translateY(1px) scale(0.98);
  filter: saturate(1.15) contrast(1.05);
  box-shadow: inset 0 0 0 3px rgba(37,99,235,.18), 0 8px 18px rgba(15,23,42,.12) !important;
}
.ctrlBtn:focus-visible, .chip:focus-visible, .mic:focus-visible{
  outline: none;
  box-shadow: 0 0 0 3px rgba(37,99,235,.22), 0 10px 24px rgba(15,23,42,.14) !important;
}

/* tighten vertical space around this bar */
.big{ margin-bottom: 10px !important; }

/* ===== V8.5 Mobile Topbar Tighten (2026-01-10) ===== */
@media (max-width:520px){
  .wrap{padding:6px 10px 14px !important;}
  .topbar{padding:8px 10px !important; gap:8px !important;}
  .backBtn,.back{width:40px !important; height:40px !important; border-radius:14px !important;}
  .brandTitle{font-size:13px !important;}
  .sub{font-size:9px !important; margin-top:2px !important;}
  .pill{padding:6px 8px !important; gap:6px !important;}
  .pill .meta{font-size:9px !important;}
  .pill .w{font-size:12px !important;}
  .replayBtn,.btnReplay{width:44px !important; height:44px !important; font-size:12px !important;}
  .hero{padding:10px !important;}
  .avatar{width:72px !important; height:72px !important;}
  .sceneTitle{font-size:14px !important;}
  .sceneSub{font-size:10px !important;}
  .big{padding:12px !important;}
  .big .zh{margin-top:4px !important; font-size:10px !important;}
}


/* ====== v7-ultra-compact-2 (2026-01-10) ======
   - æ›´æ¿€é€²ç¸®å°è¡Œè·/é–“è·ï¼ˆæ‰‹æ©Ÿä¸€é å®¹ç´æ›´å¤šï¼‰
   - ç¸®å°å¤§å¥å­ã€å¡«ç©ºã€é€å‡º/é‡ä¾†æŒ‰éˆ•ã€å¡ç‰‡ padding/margin
*/
:root{
  --card-pad:10px;
}

/* overall */
.wrap{padding:8px 10px 12px !important;}
.card{padding:var(--card-pad) !important; margin:8px 0 !important;}
.hr{margin:8px 0 !important;}

/* topbar */
.topbar{padding:6px 10px !important; gap:8px !important;}
.iconBtn{width:36px !important; height:36px !important;}
.brand .t{font-size:18px !important; line-height:1.05 !important;}
.brand .s{font-size:12px !important; margin-top:1px !important; line-height:1.05 !important;}
.smallBtn{padding:6px 10px !important; border-radius:999px !important; font-size:12px !important;}

/* status/hero cards */
.hero{padding:10px !important;}
.heroGrid{gap:10px !important;}
.avatarWrap{width:74px !important; height:74px !important;}
.heroTitle{font-size:18px !important; margin-bottom:2px !important; line-height:1.1 !important;}
.heroSub{font-size:12px !important; line-height:1.15 !important;}
.progress{font-size:12px !important; line-height:1.15 !important;}

/* big sentence (AI line) */
.big .en{font-size:24px !important; line-height:1.05 !important;}
.big .zh{margin-top:4px !important; font-size:12px !important; line-height:1.15 !important;}

/* controls block */
.controls{margin-top:8px !important;}
.ctrlRow{gap:10px !important;}
.micBtn{width:64px !important; height:64px !important;}
.ctrlBtn{height:40px !important; padding:0 14px !important; font-size:14px !important;}
.ctrlBtn .ico{font-size:16px !important; margin-right:8px !important;}
.ctrlRow2{gap:10px !important; margin-top:8px !important;}
.pillBtn{padding:8px 14px !important; font-size:14px !important;}

/* reply / fill card */
.replyCard{padding:10px !important;}
.replyHead{margin-bottom:6px !important;}
.replyTitle{font-size:16px !important; line-height:1.05 !important;}
.replyDesc{font-size:11px !important; line-height:1.15 !important; margin-top:4px !important;}
.fillEn{font-size:24px !important; line-height:1.05 !important;}
.fillHint{margin-top:4px !important; font-size:11px !important; line-height:1.15 !important;}
.input{margin-top:8px !important; padding:10px 12px !important; font-size:14px !important; border-radius:16px !important;}

/* action buttons (é€å‡º/é‡ä¾†) */
.fillActions{gap:10px !important; margin-top:10px !important;}
.fillSend{
  min-height:36px !important;
  padding:0 14px !important;
  font-size:14px !important;
  border-radius:18px !important;
  box-shadow:0 10px 22px rgba(37,99,235,.22) !important;
}
.fillReroll{
  min-height:36px !important;
  padding:0 14px !important;
  font-size:14px !important;
  border-radius:18px !important;
}
.fillSend .check{width:22px !important; height:22px !important; margin-right:8px !important; font-size:13px !important;}

/* bottom sheet/panel */
.bottomPanel{margin-top:10px !important;}
.sheetTabs{gap:10px !important;}
.sheetTab{padding:8px 12px !important; font-size:14px !important;}
.sheet{margin-top:8px !important;}
.sheetBody{padding:10px !important;}
.taskItem{padding:10px !important; margin-bottom:8px !important;}
.taskItem .k{font-size:14px !important; margin-bottom:4px !important;}
.taskItem .v{font-size:12px !important; line-height:1.2 !important;}

</style>


<style id="v8-topbar-small">
/* === V8 Top Bar Small (mobile-first) === */
@media (max-width: 520px){
  /* header container */
  .topbar, .header, .navBar{
    padding: 8px 10px !important;
    border-radius: 16px !important;
  }
  /* shrink the whole top row height */
  .topbar * { line-height: 1.1 !important; }
  .title, .brandTitle, .pageTitle{
    font-size: 16px !important;
    font-weight: 800 !important;
  }
  .subtitle, .brandSub, .pageSub{
    font-size: 11px !important;
    margin-top: 2px !important;
  }

  /* back button + right buttons */
  .backBtn, .btnBack{
    width: 38px !important;
    height: 38px !important;
    border-radius: 14px !important;
  }
  .topRight button, .topbar .ctrlBtn, .topbar .chip, .topbar .btn{
    height: 34px !important;
    padding: 0 10px !important;
    font-size: 12px !important;
    border-radius: 14px !important;
  }

  /* week selector / dropdown */
  select, .weekSel, .sceneSel{
    height: 34px !important;
    padding: 0 10px !important;
    font-size: 12px !important;
    border-radius: 14px !important;
  }

  /* reduce spacing under header */
  .wrap, .container{
    padding-top: 8px !important;
  }
}

/* ===== V8.5 Mobile Topbar Tighten (2026-01-10) ===== */
@media (max-width:520px){
  .wrap{padding:6px 10px 14px !important;}
  .topbar{padding:8px 10px !important; gap:8px !important;}
  .backBtn,.back{width:40px !important; height:40px !important; border-radius:14px !important;}
  .brandTitle{font-size:13px !important;}
  .sub{font-size:9px !important; margin-top:2px !important;}
  .pill{padding:6px 8px !important; gap:6px !important;}
  .pill .meta{font-size:9px !important;}
  .pill .w{font-size:12px !important;}
  .replayBtn,.btnReplay{width:44px !important; height:44px !important; font-size:12px !important;}
  .hero{padding:10px !important;}
  .avatar{width:72px !important; height:72px !important;}
  .sceneTitle{font-size:14px !important;}
  .sceneSub{font-size:10px !important;}
  .big{padding:12px !important;}
  .big .zh{margin-top:4px !important; font-size:10px !important;}
}


/* ====== v7-ultra-compact-2 (2026-01-10) ======
   - æ›´æ¿€é€²ç¸®å°è¡Œè·/é–“è·ï¼ˆæ‰‹æ©Ÿä¸€é å®¹ç´æ›´å¤šï¼‰
   - ç¸®å°å¤§å¥å­ã€å¡«ç©ºã€é€å‡º/é‡ä¾†æŒ‰éˆ•ã€å¡ç‰‡ padding/margin
*/
:root{
  --card-pad:10px;
}

/* overall */
.wrap{padding:8px 10px 12px !important;}
.card{padding:var(--card-pad) !important; margin:8px 0 !important;}
.hr{margin:8px 0 !important;}

/* topbar */
.topbar{padding:6px 10px !important; gap:8px !important;}
.iconBtn{width:36px !important; height:36px !important;}
.brand .t{font-size:18px !important; line-height:1.05 !important;}
.brand .s{font-size:12px !important; margin-top:1px !important; line-height:1.05 !important;}
.smallBtn{padding:6px 10px !important; border-radius:999px !important; font-size:12px !important;}

/* status/hero cards */
.hero{padding:10px !important;}
.heroGrid{gap:10px !important;}
.avatarWrap{width:74px !important; height:74px !important;}
.heroTitle{font-size:18px !important; margin-bottom:2px !important; line-height:1.1 !important;}
.heroSub{font-size:12px !important; line-height:1.15 !important;}
.progress{font-size:12px !important; line-height:1.15 !important;}

/* big sentence (AI line) */
.big .en{font-size:24px !important; line-height:1.05 !important;}
.big .zh{margin-top:4px !important; font-size:12px !important; line-height:1.15 !important;}

/* controls block */
.controls{margin-top:8px !important;}
.ctrlRow{gap:10px !important;}
.micBtn{width:64px !important; height:64px !important;}
.ctrlBtn{height:40px !important; padding:0 14px !important; font-size:14px !important;}
.ctrlBtn .ico{font-size:16px !important; margin-right:8px !important;}
.ctrlRow2{gap:10px !important; margin-top:8px !important;}
.pillBtn{padding:8px 14px !important; font-size:14px !important;}

/* reply / fill card */
.replyCard{padding:10px !important;}
.replyHead{margin-bottom:6px !important;}
.replyTitle{font-size:16px !important; line-height:1.05 !important;}
.replyDesc{font-size:11px !important; line-height:1.15 !important; margin-top:4px !important;}
.fillEn{font-size:24px !important; line-height:1.05 !important;}
.fillHint{margin-top:4px !important; font-size:11px !important; line-height:1.15 !important;}
.input{margin-top:8px !important; padding:10px 12px !important; font-size:14px !important; border-radius:16px !important;}

/* action buttons (é€å‡º/é‡ä¾†) */
.fillActions{gap:10px !important; margin-top:10px !important;}
.fillSend{
  min-height:36px !important;
  padding:0 14px !important;
  font-size:14px !important;
  border-radius:18px !important;
  box-shadow:0 10px 22px rgba(37,99,235,.22) !important;
}
.fillReroll{
  min-height:36px !important;
  padding:0 14px !important;
  font-size:14px !important;
  border-radius:18px !important;
}
.fillSend .check{width:22px !important; height:22px !important; margin-right:8px !important; font-size:13px !important;}

/* bottom sheet/panel */
.bottomPanel{margin-top:10px !important;}
.sheetTabs{gap:10px !important;}
.sheetTab{padding:8px 12px !important; font-size:14px !important;}
.sheet{margin-top:8px !important;}
.sheetBody{padding:10px !important;}
.taskItem{padding:10px !important; margin-bottom:8px !important;}
.taskItem .k{font-size:14px !important; margin-bottom:4px !important;}
.taskItem .v{font-size:12px !important; line-height:1.2 !important;}

</style>


<style id="v8-tight-space-v4">
/* === V8 Tight Space V4 === */

/* shrink dialogue + response text by ~50% while keeping overall layout */
.dialogue, .aiLine, .bigLine, .utterance, .promptLine{
  font-size: 50% !important;
}

/* also shrink secondary helper text */
.small, .muted, .help, .desc, .subline{
  font-size: 50% !important;
}

/* tighten big empty padding/margins inside the response panel */
.panel, .card, .section{
  padding: 12px !important;
}
.responseBox, .replyBox, .answerBox{
  margin-top: 6px !important;
  padding-top: 6px !important;
}

/* reduce input area height */
textarea, input[type="text"], .replyInput{
  min-height: 40px !important;
  padding: 10px 12px !important;
  font-size: 14px !important;  /* keep input readable */
}

/* compact bottom buttons row ("é€å‡ºå¡«å¥½å¥" / "é‡ä¾†") */
.bottomActions, .submitRow, .btnRow{
  gap: 10px !important;
  margin-top: 10px !important;
}
.bottomActions button, .submitRow button, .btnRow button{
  height: 38px !important;
  padding: 0 14px !important;
  font-size: 13px !important;
}

/* reduce whitespace around the whole block */
.block, .taskBlock, .replyBlock{
  margin-top: 10px !important;
}

/* mobile tighter */
@media (max-width: 520px){
  .panel, .card, .section{ padding: 10px !important; }
  .bottomActions button, .submitRow button, .btnRow button{
    height: 36px !important;
    padding: 0 12px !important;
    font-size: 12px !important;
  }
}

/* ===== V8.5 Mobile Topbar Tighten (2026-01-10) ===== */
@media (max-width:520px){
  .wrap{padding:6px 10px 14px !important;}
  .topbar{padding:8px 10px !important; gap:8px !important;}
  .backBtn,.back{width:40px !important; height:40px !important; border-radius:14px !important;}
  .brandTitle{font-size:13px !important;}
  .sub{font-size:9px !important; margin-top:2px !important;}
  .pill{padding:6px 8px !important; gap:6px !important;}
  .pill .meta{font-size:9px !important;}
  .pill .w{font-size:12px !important;}
  .replayBtn,.btnReplay{width:44px !important; height:44px !important; font-size:12px !important;}
  .hero{padding:10px !important;}
  .avatar{width:72px !important; height:72px !important;}
  .sceneTitle{font-size:14px !important;}
  .sceneSub{font-size:10px !important;}
  .big{padding:12px !important;}
  .big .zh{margin-top:4px !important; font-size:10px !important;}
}


/* ====== v7-ultra-compact-2 (2026-01-10) ======
   - æ›´æ¿€é€²ç¸®å°è¡Œè·/é–“è·ï¼ˆæ‰‹æ©Ÿä¸€é å®¹ç´æ›´å¤šï¼‰
   - ç¸®å°å¤§å¥å­ã€å¡«ç©ºã€é€å‡º/é‡ä¾†æŒ‰éˆ•ã€å¡ç‰‡ padding/margin
*/
:root{
  --card-pad:10px;
}

/* overall */
.wrap{padding:8px 10px 12px !important;}
.card{padding:var(--card-pad) !important; margin:8px 0 !important;}
.hr{margin:8px 0 !important;}

/* topbar */
.topbar{padding:6px 10px !important; gap:8px !important;}
.iconBtn{width:36px !important; height:36px !important;}
.brand .t{font-size:18px !important; line-height:1.05 !important;}
.brand .s{font-size:12px !important; margin-top:1px !important; line-height:1.05 !important;}
.smallBtn{padding:6px 10px !important; border-radius:999px !important; font-size:12px !important;}

/* status/hero cards */
.hero{padding:10px !important;}
.heroGrid{gap:10px !important;}
.avatarWrap{width:74px !important; height:74px !important;}
.heroTitle{font-size:18px !important; margin-bottom:2px !important; line-height:1.1 !important;}
.heroSub{font-size:12px !important; line-height:1.15 !important;}
.progress{font-size:12px !important; line-height:1.15 !important;}

/* big sentence (AI line) */
.big .en{font-size:24px !important; line-height:1.05 !important;}
.big .zh{margin-top:4px !important; font-size:12px !important; line-height:1.15 !important;}

/* controls block */
.controls{margin-top:8px !important;}
.ctrlRow{gap:10px !important;}
.micBtn{width:64px !important; height:64px !important;}
.ctrlBtn{height:40px !important; padding:0 14px !important; font-size:14px !important;}
.ctrlBtn .ico{font-size:16px !important; margin-right:8px !important;}
.ctrlRow2{gap:10px !important; margin-top:8px !important;}
.pillBtn{padding:8px 14px !important; font-size:14px !important;}

/* reply / fill card */
.replyCard{padding:10px !important;}
.replyHead{margin-bottom:6px !important;}
.replyTitle{font-size:16px !important; line-height:1.05 !important;}
.replyDesc{font-size:11px !important; line-height:1.15 !important; margin-top:4px !important;}
.fillEn{font-size:24px !important; line-height:1.05 !important;}
.fillHint{margin-top:4px !important; font-size:11px !important; line-height:1.15 !important;}
.input{margin-top:8px !important; padding:10px 12px !important; font-size:14px !important; border-radius:16px !important;}

/* action buttons (é€å‡º/é‡ä¾†) */
.fillActions{gap:10px !important; margin-top:10px !important;}
.fillSend{
  min-height:36px !important;
  padding:0 14px !important;
  font-size:14px !important;
  border-radius:18px !important;
  box-shadow:0 10px 22px rgba(37,99,235,.22) !important;
}
.fillReroll{
  min-height:36px !important;
  padding:0 14px !important;
  font-size:14px !important;
  border-radius:18px !important;
}
.fillSend .check{width:22px !important; height:22px !important; margin-right:8px !important; font-size:13px !important;}

/* bottom sheet/panel */
.bottomPanel{margin-top:10px !important;}
.sheetTabs{gap:10px !important;}
.sheetTab{padding:8px 12px !important; font-size:14px !important;}
.sheet{margin-top:8px !important;}
.sheetBody{padding:10px !important;}
.taskItem{padding:10px !important; margin-bottom:8px !important;}
.taskItem .k{font-size:14px !important; margin-bottom:4px !important;}
.taskItem .v{font-size:12px !important; line-height:1.2 !important;}

</style>


<style id="ultra-tight-override">
/* === ULTRA TIGHT OVERRIDE === */
body, .card, .panel, .section, .content,
h1, h2, h3, h4, p, div, span, label {
  line-height: 1.1 !important;
}

p, h1, h2, h3, h4 {
  margin-top: 4px !important;
  margin-bottom: 4px !important;
}

.section, .card, .panel {
  padding-top: 6px !important;
  padding-bottom: 6px !important;
  margin-top: 6px !important;
  margin-bottom: 6px !important;
}

.big-sentence, .main-sentence {
  font-size: 0.85em !important;
  line-height: 1.05 !important;
}
</style>


<style id="rebuild-inline-compact">
/* === REBUILD: inline AI with avatar + compact === */
.heroRow{align-items:flex-start}
.heroText{display:flex; flex-direction:column; gap:4px}
/* Inline bubble */
.aiInline{
  background:#f6f8fb;
  border:1px solid var(--line);
  border-radius:14px;
  padding:8px 10px;
}
.aiInline .en{font-size:18px !important; line-height:1.1 !important; font-weight:900}
.aiInline .zh{font-size:12px !important; line-height:1.15 !important; margin-top:4px !important; color:var(--muted)}
/* Hide duplicated title near AI line */
.sceneTitle{display:none !important}
/* Compact overall text */
body{line-height:1.1}
.big{display:none !important} /* old AI block hidden */
/* Buttons compact */
.ctrlBtn{height:40px !important; font-size:14px !important}
.mic{width:56px !important; height:56px !important; font-size:22px !important}
/* Fill card compact */
.fillEn{font-size:18px !important; line-height:1.1 !important}
.fillHint{font-size:11px !important}
</style>


<style id="hide-right-label">
/* Hide right-top file label only */
.fileTag { display: none !important; }
</style>

</head>
<body>
<div class="wrap">
  <div class="card topbar" role="banner">
    <div class="leftTop">
      <button class="btnIcon" id="btnBack" aria-label="è¿”å›">â†</button>
      <div>
        <div class="brandTitle">Talk</div>
        <div class="sub" id="subTitle">æ¯é€±å£èªª Â· Browser Speech</div>
      </div>
    </div>
    <div class="rightTop">
      <button class="pill" id="btnPick" title="é¸æ“‡æœ¬é€±æƒ…å¢ƒ">
        <span id="weekLabel">W1</span>
        <span class="meta" id="scenePickLabel">é¸æ“‡æƒ…å¢ƒ</span>
        <span aria-hidden="true">â–¾</span>
      </button>

        <label class="pill" title="é¸æ“‡è€å¸«">
          <span class="meta">Teacher</span>
          <select id="selTeacher" aria-label="Teacher">
                        <option value="Diana.mp4">Diana</option>
            <option value="Emma.mp4">Emma</option>
            <option value="Sophia.mp4">Sophia</option>
          </select>
        </label>
      <button class="smallBtn" id="btnPlacement">ç¨‹åº¦æ¸¬é©—</button>
      <button class="smallBtn" id="btnReplay">é‡æ’­</button>
      <span class="fileTag" id="fileTag"></span>
    </div>
  </div>

  <div class="card grid">
    <div class="hero card">
      <div class="heroRow">
        <div class="avatar" aria-label="AI è€å¸«é ­åƒ">
          <video id="teacherVideo" class="teacherMedia" autoplay muted playsinline webkit-playsinline></video>
          <span class="dot" id="dotLive"></span>
        </div>
        <div class="heroText">
<div class="aiInline">
  <div class="en" id="lineEnInline">Loadingâ€¦</div>
  <div class="zh" id="lineZhInline">ï¼ˆè¼‰å…¥ä¸­â€¦ï¼‰</div>
</div>

          <div class="sceneTitle" id="sceneTitle">è¼‰å…¥ä¸­â€¦</div>
          <div class="sceneSub" id="sceneSub">æœ¬é€±ï¼š3 å€‹ç·´ç¿’ï¼ˆCore / Variation / Challengeï¼‰</div>
        </div>
      </div>
    </div>

    <div class="big">
      <div class="en" id="lineEn">Loadingâ€¦</div>
      <div class="zh" id="lineZh">ï¼ˆè¼‰å…¥ä¸­â€¦ï¼‰</div>
    </div>

    <div class="controlsWrap"><div class="controls">
      <button class="mic" id="btnMic" aria-label="é–‹å§‹èªéŸ³è¾¨è­˜">ğŸ¤</button>
      <button class="ctrlBtn" id="btnType"><span aria-hidden="true">âŒ¨ï¸</span><span>è¼¸å…¥</span></button>
      <button class="ctrlBtn" id="btnSkip"><span>è·³é</span></button>
    </div><div class="row2">
      <button class="chip" id="btnHint">æç¤º</button>
      <button class="chip" id="btnSave">æ”¶è—</button>
      <button class="chip" id="btnFill">å¡«ç©ºå¼•å°</button>
    </div></div>

    <div class="card fillCard" id="fillCard">
      <div class="fillHead">
        <div class="h" id="fillTitle">ä½ çš„å›è¦†</div>
        <div class="badges">
          <span class="badge lev" id="levBadge">A1</span>
          <button class="badge" id="btnHideFill" type="button">éš±è—</button>
        </div>
      </div>
      <div class="fillEn" id="fillEn">Can I get a ____ , please?</div>
      <div class="fillHint" id="fillHint">å…ˆç”¨ã€Œå¡«ç©ºã€å®Œæˆä¸€å¥ï¼Œå†æ”¹æˆä½ è‡ªå·±çš„èªªæ³•ã€‚</div>
      <div class="fillRow">
        <input class="inp" id="fillInput" placeholder="å¡«å…¥ç©ºæ ¼â€¦"/>
      </div>
      <div class="fillRow" style="margin-top:10px">
        <button class="primary" id="btnSendFill">âœ… é€å‡ºå¡«å¥½å¥</button>
        <button class="ghost" id="btnFillReset">é‡ä¾†</button>
      </div>
    </div>
  </div>
<div class="bottomPanel" id="bottomPanel" aria-label="ä»»å‹™èˆ‡åƒè€ƒ">
  <div class="bpRow">
    <div class="bpTitle">ä»»å‹™</div>
</div>

<div class="toast" id="toast"></div>

<!-- picker modal -->
<div class="modalMask" id="mask" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="é¸æ“‡æƒ…å¢ƒ">
    <div class="modalTop">
      <div class="t">é¸æ“‡æƒ…å¢ƒï¼ˆä¾é€±æ¨å‡ºï¼‰</div>
      <button class="btnIcon" id="btnClose" aria-label="é—œé–‰">âœ•</button>
    </div>
    <div class="modalBody" id="modalBody"></div>
  </div>
</div>

<script>
/* =============================
   Talk weekly learner console
   - Reads ./talk/index.json
   - Groups by w01..w08
   - Unlock week by time since first use (localStorage)
   - Loads ./talk/<id>.json
   ============================= */
(function(){
  const $ = (id)=>document.getElementById(id);
  const toastEl = $("toast");
  const mask = $("mask");
  const modalBody = $("modalBody");
  // ===== Teacher video speak-sync (stop loop, play only while TTS speaking) =====
  const __teacherVideo = document.getElementById("teacherVideo");
  
  // ===== Teacher (Supabase Storage) =====
  const TEACHER_BASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/talk/teacher/";
  function normalizeTeacherFile(v){
    const s = String(v||"").trim();
    if(!s) return "teacher.mp4";
    if(!s.toLowerCase().endsWith(".mp4")) return s + ".mp4";
    return s;
  }
  function getTeacherFromURL(){
    const u = new URL(location.href);
    return (u.searchParams.get("teacher") || u.searchParams.get("t") || "");
  }
  function setTeacher(file){
    const f = normalizeTeacherFile(file);
    try{ localStorage.setItem("bw_teacher_file", f); }catch(_ ){}
    const el = document.getElementById("selTeacher");
    if(el) el.value = f;
    if(__teacherVideo){
      __teacherVideo.src = TEACHER_BASE_URL + encodeURIComponent(f) + "?v=" + Date.now();
      __teacherVideo.load();
    }
  }
let __tvWatch = null;

  function __tvStop(){
    try{
      if(!__teacherVideo) return;
      try{ __teacherVideo.pause(); }catch(_){}
      try{ __teacherVideo.currentTime = 0; }catch(_){}
    }catch(_){}
  }
  function __tvStart(){
    try{
      if(!__teacherVideo) return;
      __teacherVideo.loop = false;
      __teacherVideo.muted = true;
      __teacherVideo.playsInline = true;
      if(__teacherVideo.readyState >= 2){
        try{ __teacherVideo.currentTime = 0; }catch(_){}
      }
      const p = __teacherVideo.play();
      if(p && typeof p.catch === "function") p.catch(()=>{});
    }catch(_){}
  }
  try{
    if(__teacherVideo){
      __teacherVideo.loop = false;
      __teacherVideo.addEventListener("ended", __tvStop, {passive:true});
    }
  }catch(e){}


  const INDEX_URL = new URL("/EduEnglish/talk/index.json", location.origin).toString();
  const FALLBACK_INDEX_URLS = [
    new URL("./index.json", location.href).toString(),              // if talk.html inside /talk/
    new URL("../talk/index.json", location.href).toString(),        // if talk.html inside /checklist/
  ];

  const LS_START = "BW_TALK_LEARNER_START_TS";
  const LS_SAVED = "BW_TALK_SAVED_LINES";
    const fileTag = $("fileTag");
  const missionText = $("missionText");
  const lnkRole = $("lnkRole");
  const lnkDialog = $("lnkDialog");
  const lnkMeta = $("lnkMeta");
  let currentSceneJson = null;
const LS_LAST_SCENE = "BW_TALK_LAST_SCENE";

  const DAY = 24*60*60*1000;
  const MAX_WEEKS = 54; // MVP
  const ITEMS_PER_WEEK = 3;

  // UI refs
  const weekLabel = $("weekLabel");
  const scenePickLabel = $("scenePickLabel");
  const sceneTitle = $("sceneTitle");
  const sceneSub = $("sceneSub");
  const levBadge = $("levBadge");

  const lineEn = $("lineEn");
  const lineZh = $("lineZh");

  const btnPick = $("btnPick");
  const btnClose = $("btnClose");
  const btnReplay = $("btnReplay");
  const btnMic = $("btnMic");
  const btnType = $("btnType");
  const btnSkip = $("btnSkip");

  const btnHint = $("btnHint");
  const btnSave = $("btnSave");
  const btnFill = $("btnFill");
  const fillCard = $("fillCard");
  const fillTitle = $("fillTitle");
  const btnHideFill = $("btnHideFill");
  const fillEn = $("fillEn");
  const fillHint = $("fillHint");
  const fillInput = $("fillInput");
  const btnSendFill = $("btnSendFill");
  const btnFillReset = $("btnFillReset");
  const btnBack = $("btnBack");

  // State
  let indexData = null;               // {scenes:[]}
  let byWeek = new Map();             // weekNo -> scenes[]
  let unlockedWeek = 1;               // computed
  let talkMode = "dialogue";          // "dialogue" or "shadow"
  let activeWeek = (function(){
        const qs = new URLSearchParams(location.search);
        const q = Number(qs.get('week'));
        if (Number.isFinite(q) && q>=1) return Math.floor(q);

        const v = Number(localStorage.getItem('bw_talk_active_week'));
        if (Number.isFinite(v) && v>=1) return Math.floor(v);

        const w = Number(window.BW_TALK_ACTIVE_WEEK);
        if (Number.isFinite(w) && w>=1) return Math.floor(w);

        return 1;
      })();;
  let activeSceneId = null;
  let activeSceneTitle = "";
  let activeScene = null;             // loaded json
  let turns = [];                     // normalized turns
  let turnIdx = 0;
  let lastTts = null;
  let lastTtsAt = 0;
// -------- utils --------
      function persistWeek(){
        try{ localStorage.setItem('bw_talk_active_week', String(activeWeek)); }catch(e){}
      }
      function persistLevel(level){
        try{ localStorage.setItem('bw_talk_level', String(level||'')); }catch(e){}
      }

  function showToast(msg){
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toastEl.style.display="none", 1800);
  }
  function openModal(){
    mask.style.display = "flex";
    mask.setAttribute("aria-hidden","false");
  }
  function closeModal(){
    mask.style.display = "none";
    mask.setAttribute("aria-hidden","true");
  }
  function getWeekFromId(id){
    const m = String(id||"").match(/^w(\d{2})\./i);
    return m ? parseInt(m[1],10) : null;
  }
  function safeText(v){ return (v==null) ? "" : String(v); }

  async function fetchJsonAny(urls){
    let lastErr = null;
    for(const u of urls){
      try{
        const res = await fetch(u, {cache:"no-cache"});
        if(!res.ok) throw new Error("HTTP "+res.status);
        return await res.json();
      }catch(e){ lastErr = e; }
    }
    throw lastErr || new Error("fetch failed");
  }

  function getUserId(){
    // from guard (preferred), else fallback stored value
    try{
      return (window.BW_USER_ID || localStorage.getItem("BW_USER_ID") || "").toString();
    }catch(e){ return ""; }
  }

  // anchor per user (so different learners unlock by their own start)
  const LS_ANCHOR_BASE = "BW_TALK_ANCHOR_TS_";
  const LS_EXPIRES_BASE = "BW_TALK_EXPIRES_AT_";

  // èª²ç¨‹é€±æœŸè¨­å®š
  const WEEK_DAYS = 7;        // æ¯é€± = 7 å¤©ï¼ˆå›ºå®šï¼‰
  const ADVANCE_WEEKS = 0.5;  // æå‰ unlockï¼ˆ0.5 = æå‰åŠé€±ï¼‰

  function ensureAnchorTs(){
    const uid = getUserId() || "anon";
    const k = LS_ANCHOR_BASE + uid;
    let ts = 0;
    try{ ts = Number(localStorage.getItem(k)||"0"); }catch(e){ ts = 0; }

    // If subscription expires_at exists, we can detect first-time after subscribe:
    // store a copy of expires_at; if user renews later, we keep anchor (do not reset).
    const expNow = (()=>{ try{ return (window.BW_SUB_EXPIRES_AT || localStorage.getItem("BW_SUB_EXPIRES_AT") || "").toString(); }catch(e){ return ""; }})();
    try{
      const expKey = LS_EXPIRES_BASE + uid;
      const expOld = localStorage.getItem(expKey) || "";
      if(expNow && !expOld) localStorage.setItem(expKey, expNow);
    }catch(_e){}

    if(!ts){
      ts = Date.now();
      try{ localStorage.setItem(k, String(ts)); }catch(e){}
    }
    return ts;
  }

  function computeUnlockedWeek(){
    const ts = ensureAnchorTs();
    const diff = Date.now() - ts;
    const weekMs = WEEK_DAYS * DAY;
    const passed = diff / weekMs; // 0.0, 1.0, 2.0...
    const w = Math.floor(passed + ADVANCE_WEEKS) + 1;
    return Math.max(1, Math.min(MAX_WEEKS, w));
  }

  // ---- turns normalize (defensive) ----
  function normalizeTurns(raw){
    const arr = Array.isArray(raw)
      ? raw
      : (raw && (raw.turns || raw.dialogue) ? (raw.turns || raw.dialogue) : []);
    return (arr||[]).map(t=>{
      if(!t) return null;
      const hasAI = !!(t.en || t.zh || t.english || t.text);
      const hasUser = !t.en && (t.hint_en || t.hint_zh);
      const en = (t.en ?? (hasUser ? t.hint_en : "") ?? t.english ?? t.text ?? '').toString().trim();
      const zh = (t.zh ?? (hasUser ? t.hint_zh : "") ?? t.tw ?? t.cn ?? t.chinese ?? '').toString().trim();
      const role = ((t.role ?? t.speaker ?? '').toString().trim()) || (hasUser ? "USER" : "AI");
      const level = (t.level ?? t.cefr ?? '').toString().trim() || 'A1';
      const hint = (t.hint ?? '').toString().trim();
      const fill = (t.fill ?? t.blank ?? '').toString();
      const answer = (t.answer ?? '').toString().trim();
      return { en, zh, role, level, hint, fill, answer };
    }).filter(x=>x && x.en);
  }

  function getOverrides(){
    return { weekOverride: null, sceneOverride: null };
  }

  function currentTurn(){
    return turns[Math.max(0, Math.min(turnIdx, turns.length-1))] || {en:"",zh:"",level:"A1",hint:"",fill:"",answer:""};
  }

  function updateUI(){
    // Dialogue mode: show AI line, and the input expects USER reply (next turn)
    if(talkMode === "dialogue"){
      // find current AI turn (at or after turnIdx)
      let aiIdx = turnIdx;
      while(aiIdx < turns.length && turns[aiIdx]?.role === "USER") aiIdx++;
      if(aiIdx >= turns.length) aiIdx = Math.max(0, turns.length-1);
      const ai = turns[aiIdx] || {en:"â€”",zh:"",level:"A1",role:"AI"};
      const user = (turns[aiIdx+1] && turns[aiIdx+1].role==="USER") ? turns[aiIdx+1] : null;

      lineEn.textContent = ai.en || "â€”";
      const li = document.getElementById("lineEnInline"); if(li) li.textContent = ai.en || "â€”";
      lineZh.textContent = ai.zh ? ai.zh : " ";
      const lz = document.getElementById("lineZhInline"); if(lz) lz.textContent = ai.zh ? ai.zh : " ";
      levBadge.textContent = ai.level || "A1";

      // Input card becomes "your reply" (do NOT reveal the expected answer by default)
      fillTitle.textContent = "ä½ çš„å›è¦†";
      const expected = (user?.en || "").trim();
      // build cloze + options for low difficulty guidance
      const cl = makeCloze(expected);
      // default show cloze; user can pressã€Œæç¤ºã€to reveal full expected answer temporarily
      fillEn.textContent = expected ? (cl.cloze || "è«‹è¼¸å…¥ä½ çš„å›è¦†â€¦") : "è«‹è¼¸å…¥ä½ çš„å›è¦†â€¦";
      renderFillOptions(cl);
      fillHint.textContent = "å°è©±æ¨¡å¼ï¼šAI å…ˆèªªä¸€å¥ï¼Œç­‰ä½ å›è¦†ï¼ˆèªéŸ³æˆ–è¼¸å…¥ï¼‰æ‰æœƒé€²ä¸‹ä¸€å¥ã€‚æŒ‰ã€Œæç¤ºã€å¯é¡¯ç¤ºå®Œæ•´å»ºè­°å¥ã€‚";
      // do not auto-clear while typing
      // top labels
      weekLabel.textContent = "W" + String(activeWeek);
      scenePickLabel.textContent = activeSceneTitle ? activeSceneTitle : "é¸æ“‡æƒ…å¢ƒ";
      sceneTitle.textContent = activeSceneTitle ? activeSceneTitle : "è¼‰å…¥ä¸­â€¦";
      const progMax = Math.max(1, Math.ceil(turns.length/2));
      const progNow = Math.min(progMax, Math.floor(aiIdx/2)+1);
      sceneSub.textContent = `æœ¬é€±ï¼š${ITEMS_PER_WEEK} å€‹ç·´ç¿’ï¼ˆCore / Variation / Challengeï¼‰ Â· é€²åº¦ ${progNow}/${progMax}`;
      return;
    }

    // Shadow mode (è·Ÿè®€/å¡«ç©º)
    const t = currentTurn();
    lineEn.textContent = t.en || "â€”";
    const li2 = document.getElementById("lineEnInline"); if(li2) li2.textContent = t.en || "â€”";
    lineZh.textContent = t.zh ? t.zh : " ";
    const lz2 = document.getElementById("lineZhInline"); if(lz2) lz2.textContent = t.zh ? t.zh : " ";
    levBadge.textContent = t.level || "A1";

    const fillText = t.fill && t.fill.trim() ? t.fill : guessFillFromSentence(t.en);
    fillTitle.textContent = "å¡«ç©ºæç¤º";
    fillEn.textContent = fillText || "Can I get a ____ , please?";
    fillHint.textContent = t.hint && t.hint.trim()
      ? t.hint
      : "å…ˆç”¨ã€Œå¡«ç©ºã€å®Œæˆä¸€å¥ï¼Œå†æ”¹æˆä½ è‡ªå·±çš„èªªæ³•ã€‚";
    if(!fillInput.value) fillInput.value = "";

    weekLabel.textContent = "W" + String(activeWeek);
    scenePickLabel.textContent = activeSceneTitle ? activeSceneTitle : "é¸æ“‡æƒ…å¢ƒ";
    sceneTitle.textContent = activeSceneTitle ? activeSceneTitle : "è¼‰å…¥ä¸­â€¦";
    sceneSub.textContent = `æœ¬é€±ï¼š${ITEMS_PER_WEEK} å€‹ç·´ç¿’ï¼ˆCore / Variation / Challengeï¼‰ Â· é€²åº¦ ${turnIdx+1}/${Math.max(1,turns.length)}`;
  }


  
  // ---- dialogue guidance: cloze + options (A2-ish by default) ----
  function makeCloze(expectedEn){
    const s = (expectedEn||"").trim();
    if(!s) return {cloze:"", answer:"", options:[]};
    // pick a target word: prefer numbers, then last content word
    const tokens = s.replace(/[?!.]/g,"").split(/\s+/).filter(Boolean);
    let target = "";
    // number?
    for(const tk of tokens){
      if(/\d/.test(tk)){ target = tk; break; }
    }
    if(!target){
      for(let i=tokens.length-1;i>=0;i--){
        const tk = tokens[i].replace(/[^A-Za-z0-9'-]/g,"");
        if(tk.length>=4 && !/^(this|that|with|have|your|what|where|when|could|would|please)$/i.test(tk)){
          target = tokens[i];
          break;
        }
      }
    }
    if(!target) target = tokens[Math.max(0, tokens.length-1)];

    // build cloze
    const esc = target.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const cloze = s.replace(new RegExp('\\b'+esc+'\\b'), '____');

    // distractor pool (small + stable)
    const pool = ["gate","terminal","passport","boarding","information","coffee","small","large","help","today","tomorrow","please","thanks","baggage","counter","check-in"];
    const lower = target.toLowerCase();
    const opts = [target];
    for(const w of pool){
      if(opts.length>=3) break;
      if(w.toLowerCase()===lower) continue;
      // keep similar type: if target is number, add numbers
      if(/\d/.test(target)){
        if(/\d/.test(w)) opts.push(w);
      }else{
        if(!/\d/.test(w)) opts.push(w);
      }
    }
    // fallback for number
    if(/\d/.test(target) && opts.length<3){
      const n = parseInt(target.replace(/\D/g,""),10) || 12;
      while(opts.length<3){
        const cand = String(n + (opts.length===1?1:2));
        if(!opts.includes(cand)) opts.push(cand);
      }
    }
    return {cloze, answer: target, options: opts};
  }

  function ensureFillOpts(){
    let el = document.getElementById("fillOpts");
    if(!el){
      el = document.createElement("div");
      el.id = "fillOpts";
      el.className = "fillOpts";
      el.style.display = "flex";
      el.style.flexWrap = "wrap";
      el.style.gap = "10px";
      el.style.marginTop = "10px";
      // insert right after fillHint
      fillHint.insertAdjacentElement("afterend", el);
    }
    return el;
  }

  function renderFillOptions(cl){
    const el = ensureFillOpts();
    el.innerHTML = "";
    if(!cl || !cl.options || cl.options.length===0) return;
    cl.options.forEach((opt)=>{
      const b = document.createElement("button");
      b.type = "button";
      b.className = "optBtn";
      b.textContent = opt;
      b.style.border = "1px solid var(--line)";
      b.style.background = "#fff";
      b.style.borderRadius = "999px";
      b.style.padding = "10px 14px";
      b.style.cursor = "pointer";
      b.addEventListener("click", ()=>{
        const expected = (currentExpectedEn()||"").trim();
        if(!expected){ fillInput.value = opt; return; }
        const cl2 = makeCloze(expected);
        const completed = (cl2.cloze||"").includes("____")
          ? cl2.cloze.replace("____", opt)
          : expected;
        fillInput.value = completed;
        fillInput.focus();
      });
      el.appendChild(b);
    });
  }

  function currentExpectedEn(){
    if(talkMode!=="dialogue") return "";
    // expected is the first USER turn right after current AI turn
    const aiIdx = turnIdx;
    const user = (turns[aiIdx+1] && turns[aiIdx+1].role==="USER") ? turns[aiIdx+1] : expectedAfter(aiIdx);
    return (user && user.en) ? user.en : "";
  }

function guessFillFromSentence(en){
    if(!en) return "";
    // Simple heuristic: blank the longest noun-ish token or last content word
    const s = String(en).trim();
    if(s.includes("____")) return s;
    const words = s.replace(/[â€œâ€"]/g,"").split(/\s+/).filter(Boolean);
    if(words.length<4) return s.replace(/\b(\w+)\b/, "____");
    // blank one token near the end
    const k = Math.max(1, words.length-2);
    const target = words[k].replace(/[.,!?;:]+$/,"");
    return s.replace(target, "____");
  }

  async function speak(text){
    try{
      if(!("speechSynthesis" in window)) return;
      window.speechSynthesis.cancel();
      const now = Date.now();
      if (text && text === lastTts && (now - lastTtsAt) < 800) return; // é˜²æ­¢é‡è¤‡ç™¼è²
      lastTtsAt = now;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "en-US";
      u.rate = 1.0;
      lastTts = text;
      __tvStart();
      window.speechSynthesis.speak(u);
      u.onend = ()=>{ __tvStop(); };
      u.onerror = ()=>{ __tvStop(); };
    }catch(e){}
  }

  function stopSpeak(){
    try{ window.speechSynthesis.cancel(); }catch(e){}
    __tvStop();
  }

  function isAI(t){ return !!t && (t.role||'AI') !== 'USER'; }
  function nextAIIndex(from){
    for(let i=from+1;i<turns.length;i++){
      if(isAI(turns[i])) return i;
    }
    return -1;
  }
  function expectedAfter(aiIndex){
    for(let i=aiIndex+1;i<turns.length;i++){
      const t = turns[i];
      if(!t) continue;
      if(isAI(t)) break;
      return t; // first user-like turn after AI
    }
    return null;
  }

  function nextTurn(){
    const ni = nextAIIndex(turnIdx);
    if(ni >= 0){
      turnIdx = ni;
      updateUI();
      speak(currentTurn().en); // only speak AI turns
    }else{
      showToast("æœ¬æƒ…å¢ƒå®Œæˆ âœ…");
    }
  }

  function saveLine(){
    const t = currentTurn();
    if(!t.en) return;
    let arr = [];
    try{ arr = JSON.parse(localStorage.getItem(LS_SAVED)||"[]"); }catch(e){}
    arr.unshift({en:t.en, zh:t.zh, at:new Date().toISOString(), scene:activeSceneId});
    arr = arr.slice(0,200);
    localStorage.setItem(LS_SAVED, JSON.stringify(arr));
    showToast("å·²æ”¶è—");
  }

  async function loadSceneById(id, title){
    activeSceneId = id;
    activeSceneTitle = title || id;

    const url = new URL("/talk/" + encodeURIComponent(id) + ".json", location.origin).toString();
    const fallback = [
      url,
      new URL("./" + encodeURIComponent(id) + ".json", location.href).toString(), // if talk.html in /talk/
      new URL("../talk/" + encodeURIComponent(id) + ".json", location.href).toString(), // if talk.html in /checklist/
    ];
    try{
      activeScene = await fetchJsonAny(fallback);
      currentSceneJson = activeScene;
      if(fileTag) fileTag.textContent = (activeSceneId ? (activeSceneId + ".json") : "");
      // ä»»å‹™æ–‡å­—ï¼šå„ªå…ˆ title_zh/title_enï¼Œå…¶æ¬¡ç”¨ scene / id
      const tz = safeText(activeScene?.title_zh || activeScene?.titleZh || "");
      const te = safeText(activeScene?.title_en || activeScene?.titleEn || "");
      const sc = safeText(activeScene?.scene || "");
      const lv = safeText(activeScene?.level || "");
      const head = (tz || te) ? (tz || te) : (sc ? sc : activeSceneTitle);
      const sub = (tz && te) ? te : (te || tz ? "" : "");
      const extra = [lv?(" Â· "+lv):"", sc?(" Â· "+sc):""].join("");
      if(missionText) missionText.innerHTML = "<b>"+escapeHtml(head)+"</b>" + (sub?(" <span class=\"sub\">"+escapeHtml(sub)+"</span>"):"") + (extra?(" <span class=\"sub\">"+escapeHtml(extra.trim())+"</span>"):"");

    }catch(e){
      showToast("æ‰¾ä¸åˆ°å ´æ™¯ JSONï¼š" + id);
      turns = [{en:"Scene JSON not found.", zh:"æ‰¾ä¸åˆ°å ´æ™¯ JSONï¼ˆè«‹ç¢ºèªæª”æ¡ˆæ”¾åœ¨ /talk/ï¼‰", level:"A1"}];
      turnIdx = 0;
      updateUI();
      return;
    }

    turns = normalizeTurns(activeScene);
    if(!turns.length){
      turns = [{en:"(No turns found in JSON)", zh:"JSON æ²’æœ‰ turns/dialogue/lines/items é™£åˆ—", level: String(activeScene?.meta?.level || "A1")}];
    }
    turnIdx = 0;
    fillInput.value = "";
    updateUI();
    // autoplay first line
    speak(currentTurn().en);
  }

  function buildWeekMap(){
    byWeek = new Map();
    const scenes = (indexData && Array.isArray(indexData.scenes)) ? indexData.scenes : [];
    for(const s of scenes){
      const id = s.id || s.scene_id || s.key;
      if(!id) continue;
      const wk = getWeekFromId(id);
      if(!wk) continue;
      if(!byWeek.has(wk)) byWeek.set(wk, []);
      byWeek.get(wk).push({id, title: s.title || id, level: s.level || s.lev || ""});
    }
    // stable sort
    for(const [wk, arr] of byWeek){
      arr.sort((a,b)=>String(a.id).localeCompare(String(b.id)));
    }
  }

  function renderPicker(){
    modalBody.innerHTML = "";
    for(let wk=1; wk<=MAX_WEEKS; wk++){
      const list = byWeek.get(wk) || [];
      if(!list.length) continue;

      const locked = wk > unlockedWeek;
      const g = document.createElement("div");
      g.className = "group";
      const head = document.createElement("div");
      head.className = "gHead";
      head.innerHTML = `<div>Week ${wk}</div><div class="lock">${locked ? "ğŸ”’ å°šæœªè§£é–" : "âœ… å¯ç·´ç¿’"}</div>`;
      g.appendChild(head);

      for(const it of list){
        const row = document.createElement("div");
        row.className = "item";
        const left = document.createElement("div");
        left.innerHTML = `<div class="name">${escapeHtml(it.title)}</div><p class="sub">${escapeHtml(it.id)}${it.level?(" Â· "+escapeHtml(it.level)):""}</p>`;
        const btn = document.createElement("button");
        btn.className = locked ? "ghost" : "primary";
        btn.style.height = "42px";
        btn.style.fontSize = "15px";
        btn.textContent = locked ? "å°šæœª" : "é–‹å§‹";
        btn.disabled = locked;
        btn.addEventListener("click", ()=>{
          activeWeek = wk; persistWeek();
          localStorage.setItem(LS_LAST_SCENE, it.id);
          closeModal();
          loadSceneById(it.id, it.title);
        });
        row.appendChild(left);
        row.appendChild(btn);
        g.appendChild(row);
      }
      modalBody.appendChild(g);
    }
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"]/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]));
  }

  // bottom tiny links (reference)
  function showModalHtml(title, inner){
    modalBody.innerHTML = '<div style="font-weight:900; margin-bottom:10px">'+escapeHtml(title)+'</div>' + inner;
    openModal();
  }
  function escapeHtml(s){
    return String(s??"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }
  function buildDialogueHtml(){
    const d = (currentSceneJson && Array.isArray(currentSceneJson.dialogue)) ? currentSceneJson.dialogue : [];
    if(!d.length) return '<div class="sub">ï¼ˆæ­¤æƒ…å¢ƒæ²’æœ‰ dialogueï¼‰</div>';
    return d.map((x,i)=>{
      const who = escapeHtml(x.speaker||x.role||"");
      const en = escapeHtml(x.en||"");
      const zh = escapeHtml(x.zh||"");
      return '<div style="padding:10px 0;border-bottom:1px solid var(--line)"><div style="font-weight:800">'+(i+1)+'. '+who+'</div><div>'+en+'</div><div class="sub" style="margin-top:4px">'+zh+'</div></div>';
    }).join("");
  }
  function buildRoleHtml(){
    const r = (currentSceneJson && currentSceneJson.role) ? currentSceneJson.role : {};
    const aiName = escapeHtml(r.ai_name || "AI");
    const aiRole = escapeHtml(r.ai_role || "");
    const scene = escapeHtml(currentSceneJson?.scene || "");
    const lvl = escapeHtml(currentSceneJson?.level || "");
    return [
      '<div style="display:grid; gap:8px">',
      '<div><b>AIï¼š</b>'+aiName+(aiRole?(' Â· '+aiRole):'')+'</div>',
      scene ? ('<div><b>æƒ…å¢ƒï¼š</b>'+scene+'</div>') : '',
      lvl ? ('<div><b>ç­‰ç´šï¼š</b>'+lvl+'</div>') : '',
      '</div>'
    ].join("");
  }
  function buildMetaHtml(){
    const id = escapeHtml(currentSceneJson?.id || activeSceneId || "");
    const track = escapeHtml(currentSceneJson?.track || "");
    const week = escapeHtml(currentSceneJson?.week ?? "");
    const modes = Array.isArray(currentSceneJson?.training_modes) ? currentSceneJson.training_modes.join(", ") : "";
    return [
      '<div style="display:grid; gap:8px">',
      id?('<div><b>IDï¼š</b>'+id+'</div>'):'',
      week?('<div><b>Weekï¼š</b>'+week+'</div>'):'',
      track?('<div><b>Trackï¼š</b>'+track+'</div>'):'',
      modes?('<div><b>Modesï¼š</b>'+escapeHtml(modes)+'</div>'):'',
      '<div class="sub">ï¼ˆæç¤ºï¼šå³ä¸Šæœƒé¡¯ç¤ºç›®å‰è¼‰å…¥çš„ JSON æª”åï¼‰</div>',
      '</div>'
    ].join("");
  }
  if(lnkRole) lnkRole.addEventListener("click",(e)=>{ e.preventDefault(); showModalHtml("ä¸»è§’", buildRoleHtml()); });
  if(lnkDialog) lnkDialog.addEventListener("click",(e)=>{ e.preventDefault(); showModalHtml("ç¯„ä¾‹å°è©±", buildDialogueHtml()); });
  if(lnkMeta) lnkMeta.addEventListener("click",(e)=>{ e.preventDefault(); showModalHtml("è³‡è¨Š", buildMetaHtml()); });

async function init(){

  // ===== Teacher picker init =====
  const selTeacher = document.getElementById("selTeacher");
  if(selTeacher){
    selTeacher.addEventListener("change", ()=> setTeacher(selTeacher.value));
  }
  let savedT = "";
  try{ savedT = localStorage.getItem("bw_teacher_file") || ""; }catch(_){}
  const urlT = getTeacherFromURL();
  setTeacher(urlT || savedT || (selTeacher ? selTeacher.value : "teacher.mp4"));
    getOverrides();
    unlockedWeek = computeUnlockedWeek();

    // ç”¨ localStorage è¨˜ä½ä¸Šæ¬¡çš„é€±ï¼›æ²’æœ‰å°±ç”¨ç›®å‰å·²è§£é–é€±
    let savedWeek = 0;
    try { savedWeek = Number(localStorage.getItem("talk_active_week") || "0"); } catch(e){}
    activeWeek = (savedWeek>=1 && savedWeek<=MAX_WEEKS) ? savedWeek : unlockedWeek;; persistWeek();
    // æ¨¡å¼ï¼šå°è©±(dialogue) / è·Ÿè®€(shadow)
    try{ talkMode = localStorage.getItem("talk_mode") || "dialogue"; }catch(_e){ talkMode = "dialogue"; }

    try{ localStorage.setItem("talk_active_week", String(activeWeek)); }catch(_e){}
    // load index.json
    try{
      indexData = await fetchJsonAny([INDEX_URL, ...FALLBACK_INDEX_URLS]);
    }catch(e){
      indexData = { scenes: [] };
      showToast("è®€ä¸åˆ° talk/index.json");
    }

    buildWeekMap();
    renderPicker();

    // pick scene
    const params = new URLSearchParams(location.search);
    const legacyScene = (params.get("scene")||"").trim(); // e.g. airport / coffee_shop / w02.variation.airport
    const forcedScene = null;
    let forcedByParam = false;

    let firstId = null, firstTitle = null;

    // scenes list from index.json
    const allScenes = Array.isArray(indexData?.scenes) ? indexData.scenes : [];

    function baseNameNoExt(p){
      if(!p) return "";
      const s = String(p).split("?")[0].split("#")[0];
      const file = s.split("/").pop() || s;
      return file.replace(/\.json$/i,"");
    }
    function resolveScene(param){
      if(!param) return null;
      const q = String(param).trim();

      // 1) exact id match
      let hit = allScenes.find(s => (s?.id||"") === q);
      if(hit) return hit;

      // 2) match file base name (w02.variation.airport) or last token (airport)
      const qBase = q.replace(/\.json$/i,"");
      const qTail = qBase.split(".").pop();

      const candidates = [];
      for(const s of allScenes){
        const id = String(s?.id||"");
        const fileBase = baseNameNoExt(s?.file||s?.url||""); // support either field
        const idTail = id.split(".").pop();
        if(!id) continue;

        if(fileBase && fileBase === qBase) candidates.push(s);
        else if(fileBase && fileBase.endsWith("." + qBase)) candidates.push(s);
        else if(id === qBase) candidates.push(s);
        else if(id.endsWith("." + qBase)) candidates.push(s);
        else if(qTail && (idTail === qTail || fileBase.endsWith("." + qTail) || id.endsWith("." + qTail))) candidates.push(s);
      }
      if(candidates.length === 0) return null;

      // prefer same week as activeWeek
      const aw = Number(activeWeek||0);
      let best = null;
      let bestScore = -1;
      for(const s of candidates){
        const w = Number(s?.week||0);
        const tr = String(s?.track||"");
        const score =
          (w === aw ? 1000 : 0) +
          (w ? (100 - Math.abs(w - aw)) : 0) +
          (tr==="core" ? 3 : tr==="variation" ? 2 : tr==="challenge" ? 1 : 0);
        if(score > bestScore){ bestScore = score; best = s; }
      }
      return best || candidates[0];
    }

    if(legacyScene){
      const mapped = resolveScene(legacyScene);
      if(!mapped){
        // å¦‚æœä½ æŒ‡å®šäº† ?scene=xxx ä½†æ‰¾ä¸åˆ°ï¼Œå°±ä¸è¦å·å·è·³åˆ°åˆ¥çš„å ´æ™¯ï¼ˆé¿å…èª¤åˆ¤ JSON éŒ¯ï¼‰
        turns = [{en:`Scene not found: ${legacyScene}`, zh:`æ‰¾ä¸åˆ°å ´æ™¯ï¼š${legacyScene}ã€‚è«‹ç¢ºèª talk/index.json çš„ id æ˜¯å¦å­˜åœ¨ã€‚`}];
        renderTurns();
        showToast(`æ‰¾ä¸åˆ°å ´æ™¯ï¼š${legacyScene}`);
        return;
      }
      if(mapped){
        forcedByParam = true;

        firstId = mapped.id;
        firstTitle = mapped.title || mapped.id;
        // force week to match the resolved scene (so top bar shows correct W#)
        if(mapped.week){
          activeWeek = Number(mapped.week)||activeWeek; persistWeek();
          try{ localStorage.setItem("talk_active_week", String(activeWeek)); }catch(_e){}
          try{ localStorage.setItem(LS_LAST_SCENE, mapped.id); }catch(_e){}
        }
      }else{
        // å¦‚æœæ‰¾ä¸åˆ°å°±ä¸è¦ç¡¬è·³åˆ°ç¬¬ä¸€å€‹ï¼ˆé¿å…é¡¯ç¤ºéŒ¯æƒ…å¢ƒï¼‰
        turns = [{en:"Scene not found: "+legacyScene, zh:"æ‰¾ä¸åˆ°æ­¤æƒ…å¢ƒï¼ˆè«‹ç¢ºèª URL åƒæ•¸æˆ– index.json æ˜¯å¦åŒ…å«ï¼‰", level:"A1"}];
        updateUI();
        return;
      }
    }else if(forcedScene){
      const mapped = resolveScene(forcedScene);
      if(mapped){
        firstId = mapped.id;
        firstTitle = mapped.title || mapped.id;
        // force week to match the resolved scene (so top bar shows correct W#)
        if(mapped.week){
          activeWeek = Number(mapped.week)||activeWeek; persistWeek();
          try{ localStorage.setItem("talk_active_week", String(activeWeek)); }catch(_e){}
        }
      }else{
        firstId = forcedScene;
        firstTitle = forcedScene;
      }
    }else{
      // default: pick first in current active week; else first in index
      let pick = allScenes.find(s => Number(s?.week||0) === Number(activeWeek||0));
      if(!pick) pick = allScenes[0] || null;
      if(pick){
        firstId = pick.id; firstTitle = pick.title || pick.id;
      }
    }

    // --- resolved ---
if(!firstId){
      turns = [{en:"No scenes in index.json", zh:"è«‹å…ˆæŠŠ w01..w08 çš„ JSON èˆ‡ talk/index.json æ”¾åœ¨ /talk/ ç›®éŒ„", level:"A1"}];
      updateUI();
      return;
    }
    await loadSceneById(firstId, firstTitle);
  }

  // -------- events --------
  btnPick.addEventListener("click", openModal);
  btnClose.addEventListener("click", closeModal);
  mask.addEventListener("click", (e)=>{ if(e.target===mask) closeModal(); });

  
      // ===== Placement (3-min survey) =====
      const btnPlacement = $("btnPlacement");
      const placementMask = $("placementMask");
      const placementBody = $("placementBody");
      const btnPlacementClose = $("btnPlacementClose");
      const btnPlacementReset = $("btnPlacementReset");
      const btnPlacementSubmit = $("btnPlacementSubmit");

      let placementData = null;

      function openPlacement(){
        placementMask.style.display = "flex";
        if (!placementData) loadPlacement();
      }
      function closePlacement(){
        placementMask.style.display = "none";
      }
      async function loadPlacement(){
        placementBody.innerHTML = `<div class="muted" style="padding:12px 0;">è¼‰å…¥ä¸­â€¦</div>`;
        const urls = [
          "./talk/placement.json",
          "./placement.json",
          "./data/placement.json"
        ];
        let lastErr = null;
        for (const u of urls){
          try{
            const res = await fetch(u + "?ts=" + Date.now(), {cache:"no-store"});
            if(!res.ok) throw new Error("HTTP " + res.status);
            placementData = await res.json();
            renderPlacement();
            return;
          }catch(e){ lastErr = e; }
        }
        placementBody.innerHTML = `<div class="muted" style="padding:12px 0;">è¼‰å…¥å¤±æ•—ï¼šè«‹ç¢ºèª <code>talk/placement.json</code> æ˜¯å¦å­˜åœ¨ã€‚</div>`;
        console.error("placement load failed", lastErr);
      }

      function renderPlacement(){
        const secs = (placementData && placementData.sections) ? placementData.sections : [];
        let html = "";
        secs.forEach((sec, si)=>{
          html += `<div style="margin:14px 0 6px; font-weight:800;">${sec.title || ("Section " + (si+1))}</div>`;
          (sec.questions||[]).forEach((q, qi)=>{
            const qid = `q_${si}_${qi}`;
            html += `<div style="border:1px solid #e5e7eb; border-radius:14px; padding:12px; margin:10px 0; background:#fff;">
              <div style="font-weight:700; margin-bottom:8px;">${q.prompt || ""}</div>
              <div style="display:flex; flex-direction:column; gap:8px;">`;
            (q.options||[]).forEach((op, oi)=>{
              const id = `${qid}_${oi}`;
              html += `<label style="display:flex; gap:10px; align-items:flex-start; cursor:pointer;">
                <input type="radio" name="${qid}" id="${id}" value="${op.level || ""}" data-weight="${op.weight || 1}" style="margin-top:3px;">
                <div><div style="font-weight:650;">${op.text || ""}</div></div>
              </label>`;
            });
            html += `</div></div>`;
          });
        });

        html += `<div class="muted" style="margin-top:10px;">å®Œæˆå¾Œæœƒè‡ªå‹•æ¨è–¦ç­‰ç´šï¼Œä¸¦æŠŠä½ å¸¶åˆ°å°æ‡‰é€±æ¬¡ï¼ˆå¯å†æ‰‹å‹•æ›é€±ï¼‰ã€‚</div>`;
        placementBody.innerHTML = html;
      }

      function resetPlacement(){
        placementBody.querySelectorAll('input[type="radio"]').forEach(i=> i.checked=false);
      }

      
function computePlacement(){
        // returns {level, scores, total, max, confidence, answers}
        const levels = ["A1","A2","B1","B2","C1","C2"];
        const scores = Object.fromEntries(levels.map(l=>[l,0]));
        const answers = {};
        let max = 0;

        for(const q of (placementData.questions||[])){
          const name = 'q_'+q.id;
          const checked = placementBody.querySelector(`input[name="${name}"]:checked`);
          if(!checked) continue;
          const optId = checked.value;
          answers[q.id] = optId;

          const opt = (q.options||[]).find(o=>String(o.id)===String(optId));
          if(!opt) continue;

          // support opt.weights {A1:1,...} OR opt.scores {A1:1,...}
          const w = opt.weights || opt.scores || {};
          for(const l of levels){
            const v = Number(w[l]||0);
            if(Number.isFinite(v)) scores[l] += v;
            max = Math.max(max, scores[l]); // rough; for confidence we use totals below
          }
        }

        // choose best level by score, tie-break by lower (easier) level
        const best = levels.slice().sort((a,b)=>{
          const da = scores[a], db = scores[b];
          if(db!==da) return db-da;
          return levels.indexOf(a)-levels.indexOf(b);
        })[0] || "A1";

        const total = levels.reduce((s,l)=>s+scores[l],0);
        const sorted = levels.slice().sort((a,b)=>scores[b]-scores[a]);
        const top = scores[sorted[0]]||0;
        const second = scores[sorted[1]]||0;
        const confidence = (top<=0) ? 0 : Math.max(0, Math.min(1, (top-second)/(top)));

        return { level: best, scores, total, max: top, confidence, answers };
      }

      function applyPlacement(result){
        try{
          localStorage.setItem('bw_placement_result', JSON.stringify({
            ...result,
            ts: new Date().toISOString(),
            version: placementData.version || placementData.schema || 'v1'
          }));
        }catch(_){}

        // map level -> starting week (9 weeks per level)
        const order = ["A1","A2","B1","B2","C1","C2"];
        const idx = Math.max(0, order.indexOf(result.level));
        const startWeek = idx*9 + 1;

        try{
          localStorage.setItem('bw_talk_active_week', String(startWeek));
        }catch(_){}

        // Optional: write to Supabase (non-blocking, no hard dependency)
        (async ()=>{
          try{
            const supa = window.BW && window.BW.supabase;
            const user = window.BW && window.BW.user;
            if(!supa || !user) return;

            const payload = {
              user_id: user.id,
              email: user.email || null,
              level: result.level,
              score_total: result.total,
              score_top: result.max,
              confidence: result.confidence,
              answers: result.answers,
              created_at: new Date().toISOString()
            };
            // table name can be changed later; if not exists, it will just fail silently
            await supa.from('bw_placement_results').insert(payload);
          }catch(_){}
        })();

        // show comment + jump to recommended week
        const comment = (function(){
          const pct = Math.round((result.confidence||0)*100);
          const msg = (pct>=60) ? "ä¿¡å¿ƒåº¦é«˜" : (pct>=35 ? "ä¿¡å¿ƒåº¦ä¸­ç­‰" : "ä¿¡å¿ƒåº¦åä½ï¼ˆå»ºè­°å†æ¸¬ä¸€æ¬¡ï¼‰");
          return `ä½ çš„ç¨‹åº¦ä¼°è¨ˆï¼š${result.level}ï¼ˆ${msg}ï¼‰\nå»ºè­°å¾ç¬¬ ${startWeek} é€±é–‹å§‹ã€‚`;
        })();

        try{
          placementResult.innerHTML = `
            <div style="font-size:18px;font-weight:800;margin-bottom:6px;">âœ… æ¸¬é©—å®Œæˆï¼š${result.level}</div>
            <div style="color:#475569;line-height:1.6;white-space:pre-line;">${comment}</div>
            <div style="margin-top:10px;color:#64748b;font-size:13px;">ï¼ˆå·²å­˜å…¥æœ¬æ©Ÿï¼›è‹¥å·²ç™»å…¥ï¼Œä¹Ÿæœƒå˜—è©¦å¯«å…¥è³‡æ–™åº«ä¾›å­¸ç¿’æ§åˆ¶å°ä½¿ç”¨ï¼‰</div>
          `;
        }catch(_){}

        // update URL so Talk ç«‹å³å¥—ç”¨æ¨è–¦é€±
        try{
          const u = new URL(location.href);
          u.searchParams.set('week', String(startWeek));
          // keep other params (scene/teacher)
          location.href = u.toString();
        }catch(_){
          location.reload();
        }
      }

      // ---------- Placement UI ----------
// ---------- Placement UI (safe init) ----------
function initPlacementUI(){
  const btn = $("btnPlacement");
  if(!btn) return;

  const closeBtn = $("btnPlacementClose");
  const mask = $("placementMask");

  const open = ()=>{ if(mask) mask.style.display = "flex"; };
  const close = ()=>{ if(mask) mask.style.display = "none"; };

  btn.addEventListener("click", open);
  if(closeBtn) closeBtn.addEventListener("click", close);
  if(mask){
    mask.addEventListener("click", (e)=>{ if(e.target === mask) close(); });
  }
}
if(document.readyState === "loading"){
  document.addEventListener("DOMContentLoaded", initPlacementUI);
}else{
  initPlacementUI();
});
        btnPlacementReset.addEventListener("click", resetPlacement);
        if(btnPlacementSubmit) btnPlacementSubmit.addEventListener("click", ()=>{ const r=computePlacement(); applyPlacement(r); });
      }

btnReplay.addEventListener("click", ()=>{
    const t = currentTurn();
    if(t.en) speak(t.en);
    else if(lastTts) speak(lastTts);
  });

  btnSkip.addEventListener("click", ()=>nextTurn());

  btnHint.addEventListener("click", ()=>{
    if(talkMode === "dialogue"){
      const expected = (currentExpectedEn() || "").trim();
      if(!expected){ showToast("æœ¬å¥æ²’æœ‰å»ºè­°å›è¦†"); return; }
      // temporarily reveal the full expected sentence
      fillEn.textContent = expected;
      showToast("å·²é¡¯ç¤ºæç¤ºï¼ˆå®Œæ•´å¥ï¼‰");
      // auto revert to cloze after 3 seconds
      clearTimeout(window.__bwHintTimer);
      window.__bwHintTimer = setTimeout(()=>{
        const cl = makeCloze(expected);
        fillEn.textContent = cl.cloze || expected;
        renderFillOptions(cl);
      }, 3000);
      return;
    }
    const t = currentTurn();
    showToast(t.hint && t.hint.trim() ? t.hint : "æç¤ºï¼šå…ˆè·Ÿè‘—å”¸ä¸€éï¼Œå†æ”¹æˆä½ è‡ªå·±çš„èªªæ³•ã€‚");
  });

  btnSave.addEventListener("click", saveLine);

  btnFill.addEventListener("click", ()=>{
    fillCard.scrollIntoView({behavior:"smooth", block:"start"});
    fillInput.focus();
  });

  btnHideFill.addEventListener("click", ()=>{
    const hidden = fillCard.style.display === "none";
    fillCard.style.display = hidden ? "" : "none";
  });

  btnFillReset.addEventListener("click", ()=>{
    fillInput.value = "";
    fillInput.focus();
  });

  btnSendFill.addEventListener("click", async ()=>{
    if(talkMode === "dialogue"){
      const said = (fillInput.value || "").trim();
      if(!said){ showToast("è«‹å…ˆè¼¸å…¥ä½ çš„å›è¦†"); return; }
      // speak user's reply (optional)
      try{ await speak(said); }catch(e){}
      // clear input but keep the guidance panel
      fillInput.value = "";
      showToast("å·²é€å‡º âœ…");
      // advance to NEXT AI line (skip USER expected line)
      nextTurn();
      return;
    }
    // non-dialogue (fill practice)
    const said = (fillInput.value || "").trim();
    if(!said){ showToast("è«‹å…ˆå¡«ç©º"); return; }
    await speak(said);
    showToast("åšå¾—å¥½ âœ…");
  });


  btnType.addEventListener("click", ()=>{
    if(talkMode === "dialogue"){
      // default show suggested reply (next USER turn)
      let aiIdx = turnIdx;
      while(aiIdx < turns.length && turns[aiIdx]?.role === "USER") aiIdx++;
      const user = (turns[aiIdx+1] && turns[aiIdx+1].role==="USER") ? turns[aiIdx+1] : null;
      const ans = prompt("è¼¸å…¥ä½ çš„å›è¦†ï¼ˆæœƒç”¨ TTS æœ—è®€ï¼‰", user?.en || "");
      if(ans && ans.trim()){
        fillInput.value = ans.trim();
      }
      return;
    }
    const t = currentTurn();
    const ans = prompt("è¼¸å…¥ä½ çš„å¥å­ï¼ˆæœƒç”¨ TTS æœ—è®€ï¼‰", t.en || "");
    if(ans && ans.trim()){
      speak(ans.trim());
    }
  });


  btnBack.addEventListener("click", ()=>{
    history.length>1 ? history.back() : (location.href = "./");
  });

  // Speech recognition
  let rec = null;
  function startRec(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){
      showToast("æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜");
      return;
    }
    if(rec){ try{rec.stop()}catch(e){} }
    rec = new SR();
    rec.lang = "en-US";
    rec.interimResults = false;
    rec.maxAlternatives = 1;
    $("dotLive").style.background = "#ef4444";
    rec.onresult = (ev)=>{
      const said = (ev.results && ev.results[0] && ev.results[0][0] && ev.results[0][0].transcript) ? ev.results[0][0].transcript : "";
      $("dotLive").style.background = "#22c55e";
      if(!said.trim()){
        showToast("æ²’æœ‰è½æ¸…æ¥šï¼Œè«‹å†èªªä¸€æ¬¡");
        return;
      }
      // put into input and submit (dialogue mode)
      fillInput.value = said.trim();
      showToast("ä½ èªªï¼š " + said.trim());
      // auto send -> advance to next AI
      setTimeout(()=>{ try{ btnSendFill.click(); }catch(e){} }, 350);
    };
    rec.onerror = ()=>{
      $("dotLive").style.background = "#22c55e";
      showToast("èªéŸ³è¾¨è­˜å¤±æ•—");
    };
    rec.onend = ()=>{
      $("dotLive").style.background = "#22c55e";
    };
    try{ rec.start(); }catch(e){ showToast("èªéŸ³è¾¨è­˜ç„¡æ³•å•Ÿå‹•"); }
  }
  btnMic.addEventListener("click", startRec);

  // Avoid iOS rubber band scroll / keep stable
  document.addEventListener("touchmove", (e)=>{
    // allow scrolling only inside modal body
    const inModal = e.target && (e.target.closest && e.target.closest("#modalBody"));
    if(mask.style.display==="flex" && inModal) return;
    // otherwise prevent overscroll
  }, {passive:true});

  init();
})();</script>

<!-- ===== Placement Modal (3-min level survey) ===== -->
<div id="placementMask" class="mask" style="display:none;">
  <div class="modal">
    <div class="modalHead">
      <div class="modalTitle">3 åˆ†é˜ç¨‹åº¦æ¸¬é©—</div>
      <button class="modalClose" id="btnPlacementClose">âœ•</button>
    </div>
    <div class="modalBody" id="placementBody" style="max-height:60vh; overflow:auto;">
      <div class="muted" style="padding:12px 0;">è¼‰å…¥ä¸­â€¦</div>
    </div>
    <div class="modalFoot" style="display:flex; gap:10px; justify-content:flex-end;">
      <button class="btn" id="btnPlacementReset">é‡å¡«</button>
      <button class="btnPrimary" id="btnPlacementSubmit">å®Œæˆä¸¦å¥—ç”¨</button>
    </div>
  </div>
</div>

</body>
</html>
