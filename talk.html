<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Talk｜BookWide</title>

<!-- ===== Supabase SDK ===== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ===== BookWide Supabase Guard (FINAL / PROD) ===== */
const SUPABASE_URL = 'https://jeajrwpmrgczimmrflxo.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do';
window.SUPABASE_URL = SUPABASE_URL;
window.SUPABASE_ANON_KEY = SUPABASE_ANON_KEY;

(async ()=>{
  try{
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const { data } = await supabase.auth.getSession();
    if(!data.session){ location.replace('/account/login.html'); return; }

    const uid = data.session.user.id;
    const { data: prof } = await supabase
      .from('profiles')
      .select('expires_at,is_paused')
      .eq('id', uid)
      .maybeSingle();

    const today = new Date().toISOString().slice(0,10);
    if(!prof || prof.is_paused || !prof.expires_at || prof.expires_at < today){
      location.replace('/account/subscription.html'); return;
    }
  }catch(e){
    location.replace('/account/subscription.html');
  }
})();
</script>

<style>
:root{
  --bg:#f4f6fb;--card:#fff;--ink:#0b1220;--muted:#5b667a;
  --brand:#0b66ff;--line:#e6eaf0;--r:18px
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,"Noto Sans TC";background:var(--bg);color:var(--ink)}
.wrap{max-width:900px;margin:0 auto;padding:12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);padding:12px;margin-bottom:12px}
.top{display:flex;justify-content:space-between;align-items:center}
.hero{display:flex;gap:12px;align-items:flex-start}
video{width:96px;height:96px;border-radius:999px;object-fit:cover;border:1px solid var(--line)}
.ai .en{font-size:22px;font-weight:900}
.ai .zh{font-size:13px;color:var(--muted)}
.controls{display:flex;gap:8px;margin-bottom:12px}
.controls button{flex:1;height:44px;border-radius:999px;border:1px solid var(--line);background:#fff;font-weight:800}
.reply .fill{font-size:20px;font-weight:900;margin-bottom:6px}
.reply input{width:100%;height:44px;border-radius:12px;border:1px solid var(--line);padding:0 12px;font-size:16px}
.actions{display:flex;gap:8px;margin-top:8px}
.actions button{flex:1;height:44px;border-radius:999px;border:none;background:var(--brand);color:#fff;font-weight:900}
@media(max-width:520px){
  video{width:72px;height:72px}
  .ai .en{font-size:18px}
}
</style>
</head>

<body>
<div class="wrap">

  <div class="card top">
    <strong>Talk</strong>
    <select id="selTeacher">
      <option value="Diana.mp4">Diana</option>
      <option value="Emma.mp4">Emma</option>
      <option value="Sophia.mp4">Sophia</option>
    </select>
  </div>

  <div class="card hero">
    <video id="teacherVideo" muted playsinline></video>
    <div class="ai">
      <div class="en" id="aiEn">Loading…</div>
      <div class="zh" id="aiZh"></div>
    </div>
  </div>

  <div class="controls">
    <button id="btnReplay">重播</button>
    <button id="btnFill">填空</button>
    <button id="btnNext">下一句</button>
  </div>

  <div class="card reply">
    <div class="fill" id="fillText">請回覆</div>
    <input id="userInput" placeholder="輸入你的回覆…"/>
    <div class="actions">
      <button id="btnSend">送出</button>
    </div>
  </div>

</div>

<script>
/* ===== Talk Core FINAL ===== */
const TEACHER_BASE = 'https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/talk/teacher/';
const state = { turns:[], idx:0 };

const $ = id=>document.getElementById(id);

async function init(){
  const idxRes = await fetch('/EduEnglish/talk/index.json',{cache:'no-cache'});
  const idx = await idxRes.json();
  const scene = idx.scenes[0];

  const sceneRes = await fetch('/EduEnglish/talk/'+scene.id+'.json',{cache:'no-cache'});
  const data = await sceneRes.json();
  state.turns = data.turns || data.dialogue || [];

  setTeacher($('selTeacher').value);
  render();
}

function setTeacher(file){
  const v = $('teacherVideo');
  v.src = TEACHER_BASE + encodeURIComponent(file);
  v.load();
}

$('selTeacher').onchange = e=>setTeacher(e.target.value);

function render(){
  const t = state.turns[state.idx] || {};
  $('aiEn').textContent = t.en || '—';
  $('aiZh').textContent = t.zh || '';
  $('fillText').textContent = t.fill || '請回覆';
}

$('btnNext').onclick = ()=>{
  state.idx = Math.min(state.idx+1, state.turns.length-1);
  render();
};

$('btnSend').onclick = ()=>{
  $('userInput').value='';
  state.idx = Math.min(state.idx+1, state.turns.length-1);
  render();
};

$('btnReplay').onclick = ()=>{
  const v = $('teacherVideo');
  v.currentTime = 0;
  v.play().catch(()=>{});
};

init();
</script>
</body>
</html>
