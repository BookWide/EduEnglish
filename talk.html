<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Talk｜影像 + 說話（前端MVP）</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9ca3af;
      --line:#243044; --brand:#2563eb; --ok:#10b981; --bad:#ef4444;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#070c16);color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;}
    header{position:sticky;top:0;z-index:5;background:rgba(9,14,26,.85);backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(255,255,255,.06);}
    .bar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 16px;}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.3px}
    .pill{font-size:12px;padding:4px 10px;border:1px solid rgba(255,255,255,.12);border-radius:999px;color:var(--muted)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px;}
    .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:16px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:rgba(17,24,39,.72);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);
      box-shadow:0 18px 55px rgba(0,0,0,.35);overflow:hidden}
    .card h2{margin:0;padding:14px 16px;font-size:16px;border-bottom:1px solid rgba(255,255,255,.08)}
    .card .body{padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    select,input,button,textarea{
      font:inherit;color:var(--ink);background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px 12px;outline:none;
    }
    select:focus,input:focus,textarea:focus{border-color:rgba(37,99,235,.6);box-shadow:0 0 0 3px rgba(37,99,235,.25)}
    button{cursor:pointer;background:rgba(37,99,235,.9);border-color:rgba(37,99,235,.9);font-weight:700}
    button.secondary{background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.12)}
    button.danger{background:rgba(239,68,68,.9);border-color:rgba(239,68,68,.9)}
    button:disabled{opacity:.55;cursor:not-allowed}
    .status{display:flex;gap:10px;flex-wrap:wrap}
    .tag{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);color:var(--muted);background:rgba(255,255,255,.04);font-size:12px}
    .dot{width:9px;height:9px;border-radius:999px;background:#64748b}
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--bad)}
    video{width:100%;aspect-ratio:16/9;background:#000;border-bottom:1px solid rgba(255,255,255,.08)}
    .hint{color:var(--muted);font-size:13px;line-height:1.55}
    .box{padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04)}
    .bigBtn{width:100%;padding:16px 14px;border-radius:16px;font-size:16px}
    .bigBtn.hold{background:rgba(16,185,129,.95);border-color:rgba(16,185,129,.95)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
    .log{white-space:pre-wrap;word-break:break-word;font-size:14px;line-height:1.55}
  </style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand">BookWide <span class="pill">Talk</span> <span class="pill">影像 + 說話 MVP</span></div>
    <div class="row">
      <a class="pill" href="/index.html" style="text-decoration:none;color:var(--muted)">回首頁</a>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <section class="card">
      <h2>影像（相機）</h2>
      <video id="cam" playsinline autoplay muted></video>
      <div class="body">
        <div class="row">
          <button id="btnCam" class="secondary">開啟相機</button>
          <button id="btnStopCam" class="secondary" disabled>關閉相機</button>
        </div>
        <div style="height:10px"></div>
        <div class="status">
          <span class="tag"><span id="dotCam" class="dot"></span> 相機：<b id="stCam">未開</b></span>
          <span class="tag"><span id="dotMic" class="dot"></span> 麥克風：<b id="stMic">未啟用</b></span>
          <span class="tag"><span id="dotRec" class="dot"></span> 語音辨識：<b id="stRec">未開始</b></span>
        </div>
        <div style="height:10px"></div>

        <div class="box hint">
          這版只先做到「影像 + 說話轉文字」。<br/>
          ✅ 在 <span class="mono">HTTPS</span> 網站（bookwide.net）才能正常開相機/麥克風。<br/>
          ✅ 第一次會跳權限視窗：請按「允許」。<br/>
          iPhone：語音辨識通常可用；桌機 Chrome/Edge 最穩。
        </div>
      </div>
    </section>

    <section class="card">
      <h2>說話（按住說話 → 轉文字）</h2>
      <div class="body">
        <div class="row">
          <label class="hint">情境：</label>
          <select id="scene">
            <option value="nails">塗指甲 nails</option>
            <option value="makeup">化妝 makeup</option>
            <option value="cooking" selected>做菜 cooking</option>
            <option value="coffee">喝咖啡 coffee</option>
            <option value="shopping">逛街 shopping</option>
            <option value="gym">健身 gym</option>
          </select>
          <label class="hint">語言：</label>
          <select id="lang">
            <option value="en-US" selected>英文 (en-US)</option>
            <option value="zh-TW">中文 (zh-TW)</option>
            <option value="ja-JP">日文 (ja-JP)</option>
          </select>
        </div>

        <div style="height:12px"></div>

        <button id="btnHold" class="bigBtn hold" disabled>按住說話（需要先允許麥克風）</button>

        <div style="height:12px"></div>

        <div class="box">
          <div class="hint" style="margin-bottom:6px">即時辨識（interim）</div>
          <div id="interim" class="log"></div>
        </div>

        <div style="height:12px"></div>

        <div class="box">
          <div class="hint" style="margin-bottom:6px">最後結果（final）</div>
          <div id="final" class="log"></div>
        </div>

        <div style="height:12px"></div>

        <div class="row">
          <button id="btnClear" class="danger">清空</button>
          <button id="btnCopy" class="secondary">複製 final</button>
        </div>

        <div style="height:12px"></div>
        <div class="box hint" id="tipBox">
          提示：先把相機開起來，再按住說話。<br/>
          你做菜/塗指甲都沒關係，這版先以「你說什麼」為主（影像先顯示，不做AI判斷）。
        </div>
      </div>
    </section>
  </div>
</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // UI
  const stCam = $('stCam'), stMic = $('stMic'), stRec = $('stRec');
  const dotCam = $('dotCam'), dotMic = $('dotMic'), dotRec = $('dotRec');
  const btnCam = $('btnCam'), btnStopCam = $('btnStopCam');
  const btnHold = $('btnHold');
  const interimBox = $('interim'), finalBox = $('final');
  const sceneSel = $('scene'), langSel = $('lang');

  // Camera
  let camStream = null;

  function setDot(dot, ok) {
    dot.classList.remove('ok','bad');
    dot.classList.add(ok ? 'ok' : 'bad');
  }
  function setText(el, txt){ el.textContent = txt; }

  async function startCam() {
    try {
      camStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: true });
      $('cam').srcObject = camStream;
      setText(stCam,'已開'); setDot(dotCam,true);
      setText(stMic,'已啟用'); setDot(dotMic,true);
      btnStopCam.disabled = false;
      btnHold.disabled = false;
      // NOTE: audio permission granted by getUserMedia, helps speech recognition
    } catch (e) {
      console.error(e);
      setText(stCam,'失敗'); setDot(dotCam,false);
      setText(stMic,'未啟用'); setDot(dotMic,false);
      alert('相機/麥克風權限未允許或裝置不可用。\n請確認：1) 用 HTTPS 2) 右上鎖頭允許相機/麥克風 3) 沒被其他程式占用');
    }
  }

  function stopCam() {
    if (camStream) {
      camStream.getTracks().forEach(t => t.stop());
      camStream = null;
    }
    $('cam').srcObject = null;
    setText(stCam,'未開'); dotCam.className = 'dot';
    setText(stMic,'未啟用'); dotMic.className = 'dot';
    btnStopCam.disabled = true;
    btnHold.disabled = true;
  }

  btnCam.addEventListener('click', startCam);
  btnStopCam.addEventListener('click', stopCam);

  // Speech Recognition (Chrome/Edge: webkitSpeechRecognition)
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  let rec = null;
  let recognizing = false;
  let finalText = '';

  function initRec() {
    if (!SR) {
      btnHold.disabled = true;
      setText(stRec,'不支援'); setDot(dotRec,false);
      $('tipBox').innerHTML = '你的瀏覽器不支援 Web Speech API（語音辨識）。<br/>建議改用：桌機 Chrome/Edge，或 iPhone Safari。';
      return;
    }
    rec = new SR();
    rec.continuous = true;      // keep listening while holding
    rec.interimResults = true;  // show interim
    rec.maxAlternatives = 1;

    rec.onstart = () => {
      recognizing = true;
      setText(stRec,'聆聽中'); setDot(dotRec,true);
    };
    rec.onerror = (e) => {
      console.error('rec.onerror', e);
      setText(stRec,'錯誤'); setDot(dotRec,false);
      // common: "not-allowed" / "service-not-allowed" / "network"
      if (e && e.error) {
        finalBox.textContent = finalBox.textContent + "\n[error] " + e.error;
      }
    };
    rec.onend = () => {
      recognizing = false;
      setText(stRec,'已停止'); dotRec.className = 'dot';
      interimBox.textContent = '';
    };
    rec.onresult = (event) => {
      let interim = '';
      for (let i = event.resultIndex; i < event.results.length; i++) {
        const r = event.results[i];
        const t = (r[0] && r[0].transcript) ? r[0].transcript : '';
        if (r.isFinal) {
          finalText += t.trim() + '\n';
        } else {
          interim += t;
        }
      }
      interimBox.textContent = interim.trim();
      finalBox.textContent = finalText.trim();
    };
  }

  function recStart() {
    if (!rec) return;
    if (recognizing) return;
    rec.lang = langSel.value || 'en-US';
    // small hint for user: scene affects only the prompt we show (no AI yet)
    finalBox.textContent = finalText.trim();
    interimBox.textContent = '';
    try { rec.start(); } catch (e) { console.warn(e); }
  }
  function recStop() {
    if (!rec) return;
    if (!recognizing) return;
    try { rec.stop(); } catch (e) { console.warn(e); }
  }

  // Press & hold behavior (mouse + touch)
  function bindHold(btn){
    const down = (e)=>{ e.preventDefault(); recStart(); btn.classList.add('hold'); };
    const up = (e)=>{ e.preventDefault(); recStop(); btn.classList.add('hold'); setTimeout(()=>btn.classList.remove('hold'), 120); };

    btn.addEventListener('mousedown', down);
    btn.addEventListener('mouseup', up);
    btn.addEventListener('mouseleave', up);

    btn.addEventListener('touchstart', down, {passive:false});
    btn.addEventListener('touchend', up, {passive:false});
    btn.addEventListener('touchcancel', up, {passive:false});
  }

  bindHold(btnHold);

  // misc
  $('btnClear').addEventListener('click', () => {
    finalText = '';
    interimBox.textContent = '';
    finalBox.textContent = '';
  });
  $('btnCopy').addEventListener('click', async () => {
    try{
      await navigator.clipboard.writeText(finalBox.textContent || '');
      alert('已複製 final');
    }catch(e){
      alert('複製失敗（可能不允許剪貼簿）。你可以手動選取複製。');
    }
  });

  // Update tip based on scene
  function updateTip(){
    const map = {
      nails: '你正在塗指甲。先說一句： "I am doing my nails."',
      makeup: '你正在化妝。先說一句： "I am putting on makeup."',
      cooking: '你正在做菜。先說一句： "I am cooking dinner."',
      coffee: '你正在喝咖啡。先說一句： "I am having a coffee."',
      shopping: '你正在逛街。先說一句： "I am shopping right now."',
      gym: '你正在健身。先說一句： "I am working out at the gym."'
    };
    const key = sceneSel.value;
    $('tipBox').innerHTML = '提示：先把相機開起來，再按住說話。<br/>' + (map[key] || '');
  }
  sceneSel.addEventListener('change', updateTip);
  updateTip();

  // init
  initRec();
})();
</script>
</body>
</html>
