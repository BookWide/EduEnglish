<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Talkï¼ˆæ¯é€±å£èªªï¼‰ï½œBookWide</title>
<style>
:root{
  --bg:#f4f6fb; --card:#fff; --ink:#0b1220; --muted:#5b667a; --line:#e6eaf0;
  --shadow:0 10px 28px rgba(10,20,40,.10); --r:18px; --r2:24px;
  --brand:#0b66ff; --brand2:#084fc6; --soft:#f6f8fb;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
  background:var(--bg); color:var(--ink);
  overscroll-behavior: none;
}
a{color:inherit}
.wrap{max-width:980px; margin:0 auto; padding:14px 14px 24px}
.card{background:var(--card); border:1px solid var(--line); border-radius:var(--r2); box-shadow:var(--shadow)}
.topbar{padding:14px; display:flex; gap:10px; align-items:center; justify-content:space-between}
.leftTop{display:flex; align-items:center; gap:12px}
.btnIcon{
  width:44px; height:44px; border-radius:999px; border:1px solid var(--line);
  background:#fff; display:grid; place-items:center; box-shadow:0 6px 18px rgba(10,20,40,.08);
}
.brandTitle{font-weight:800; font-size:22px; line-height:1}
.sub{font-size:12px; color:var(--muted); margin-top:4px}
.rightTop{display:flex; gap:10px; align-items:center}
.smallBtn{
  border:1px solid var(--line); background:#fff; border-radius:999px; padding:10px 12px;
  font-weight:700; color:var(--brand2); box-shadow:0 6px 18px rgba(10,20,40,.08);
}
.smallBtn:active{transform:translateY(1px)}
.pill{
  border:1px solid var(--line); background:#fff; border-radius:999px; padding:10px 12px;
  display:flex; align-items:center; gap:8px; font-weight:800;
}
.pill .meta{font-size:12px; color:var(--muted); font-weight:700}
.grid{display:grid; grid-template-columns:1fr; gap:14px; padding:14px}
.hero{padding:14px}
.heroRow{display:flex; gap:14px; align-items:center}
.avatar{
  width:92px; height:92px; border-radius:999px;
  border:1px solid var(--line);
  background: radial-gradient(circle at 30% 30%, #ffffff 0%, #eef3ff 40%, #e8eefb 100%);
  box-shadow:inset 0 0 0 10px rgba(255,255,255,.6);
  position:relative; flex:0 0 auto;
}
  .avatar{ position:relative; overflow:hidden; }
  .teacherMedia{ width:100%; height:100%; object-fit:cover; border-radius:999px; display:block; }

.dot{position:absolute; left:12px; top:14px; width:12px; height:12px; border-radius:999px; background:#22c55e; box-shadow:0 0 0 4px rgba(34,197,94,.15)}
.heroText{min-width:0}
.sceneTitle{font-weight:900; font-size:16px}
.sceneSub{color:var(--muted); font-size:12px; margin-top:4px}
.big{
  padding:16px; border-radius:var(--r2); border:1px solid var(--line);
  background:var(--soft);
}
.big .en{font-size:34px; font-weight:900; letter-spacing:.2px}
.big .zh{margin-top:10px; font-size:15px; color:var(--muted)}
.controls{
  display:grid; grid-template-columns:86px 1fr 1fr; gap:12px; align-items:center;
}
.mic{
  width:86px; height:86px; border-radius:999px; border:none;
  background:linear-gradient(180deg,var(--brand) 0%, var(--brand2) 100%);
  color:#fff; font-size:28px; font-weight:900;
  box-shadow:0 16px 40px rgba(11,102,255,.35);
}
.ctrlBtn{
  height:52px; border-radius:999px; border:1px solid var(--line);
  background:#fff; font-weight:900; font-size:18px; color:var(--brand2);
  display:flex; align-items:center; justify-content:center; gap:10px;
  box-shadow:0 10px 24px rgba(10,20,40,.08);
}
.ctrlBtn small{font-size:14px; color:var(--muted); font-weight:800}
.row2{display:flex; gap:10px; flex-wrap:wrap}
.chip{
  border:1px solid var(--line); border-radius:999px; background:#fff;
  padding:10px 12px; font-weight:900; color:var(--ink);
}
.chip.on{background:#0b1220; color:#fff; border-color:#0b1220}
.fillCard{padding:14px}
.fillHead{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px}
.fillHead .h{font-weight:900; font-size:18px}
.badges{display:flex; gap:10px; align-items:center}
.badge{
  border:1px solid var(--line); border-radius:999px; padding:8px 12px; background:#fff;
  font-weight:900; color:var(--muted);
}
.badge.lev{color:#0b1220}
.fillEn{font-size:34px; font-weight:950; line-height:1.05}
.fillHint{margin-top:10px; color:var(--muted); font-weight:700}
.fillRow{display:flex; gap:10px; margin-top:14px; align-items:center}
.primary{
  height:54px; border-radius:999px; border:none;
  background:linear-gradient(180deg,var(--brand) 0%, var(--brand2) 100%);
  color:#fff; font-weight:950; padding:0 18px; font-size:18px;
  box-shadow:0 16px 40px rgba(11,102,255,.28);
}
.ghost{
  height:54px; border-radius:999px; border:1px solid var(--line); background:#fff;
  font-weight:950; padding:0 18px; font-size:18px; color:var(--brand2);
}
.inp{
  width:100%; height:54px; border-radius:16px; border:1px solid var(--line);
  padding:0 14px; font-size:18px; font-weight:800; outline:none;
  background:#fff;
}
.toast{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:18px; background:#0b1220; color:#fff; padding:10px 12px;
  border-radius:999px; font-weight:800; font-size:13px;
  box-shadow:0 18px 45px rgba(0,0,0,.25);
  max-width:min(92vw,520px); display:none;
}
.modalMask{position:fixed; inset:0; background:rgba(0,0,0,.34); display:none; align-items:flex-start; justify-content:center; padding:18px}
.modal{
  width:min(720px, 94vw);
  background:#fff; border:1px solid var(--line);
  border-radius:24px; box-shadow:0 24px 80px rgba(0,0,0,.25);
  overflow:hidden;
}
.modalTop{padding:14px 14px 10px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--line)}
.modalTop .t{font-weight:950}
.modalBody{padding:12px; max-height:70vh; overflow:auto}
.group{border:1px solid var(--line); border-radius:18px; overflow:hidden; margin-bottom:12px}
.group .gHead{padding:10px 12px; background:#f7f9ff; font-weight:950; display:flex; justify-content:space-between; align-items:center}
.group .gHead .lock{font-size:12px; color:var(--muted); font-weight:900}
.item{padding:12px; border-top:1px solid var(--line); display:flex; gap:10px; align-items:center; justify-content:space-between}
.item .name{font-weight:900}
.item .sub{margin:0; font-size:12px}
.item button{white-space:nowrap}
@media (max-width:520px){
  .wrap{padding:10px 10px 18px}
  .topbar{padding:12px}
  .brandTitle{font-size:20px}
  .big .en{font-size:30px}
  .fillEn{font-size:30px}
  .controls{grid-template-columns:78px 1fr 1fr}
  .mic{width:78px; height:78px; font-size:26px}
  .ctrlBtn{height:50px; font-size:17px}
}

/* ===== Mobile compact (v3) ===== */
@media (max-width: 520px){
  .brandTitle{font-size:14px}
  .sub{font-size:10px}
  .pill .meta{font-size:10px}
  .sceneTitle{font-size:13px}
  .sceneSub{font-size:10px}
  .big .en{font-size:20px}
  .big .zh{font-size:12px}
  .micBtn{min-height:64px}
  .micBtn .label{font-size:14px}
  .ctrlBtn{min-height:44px}
  .ctrlBtn span{font-size:14px}
  .ctrlBtn small{font-size:11px}
  .fillCard{padding:12px}
  .fillHead .h{font-size:14px}
  .fillEn{font-size:20px}
  .fillHint{font-size:11px}
  .fillSend,.fillReroll{min-height:44px; font-size:14px; padding:0 14px}
  .fillInput{min-height:44px; font-size:14px}
  .chip{font-size:11px; padding:8px 10px}
}
</style>
</head>
<body>
<div class="wrap">
  <div class="card topbar" role="banner">
    <div class="leftTop">
      <button class="btnIcon" id="btnBack" aria-label="è¿”å›">â†</button>
      <div>
        <div class="brandTitle">Talk</div>
        <div class="sub" id="subTitle">æ¯é€±å£èªª Â· Browser Speech</div>
      </div>
    </div>
    <div class="rightTop">
      <button class="pill" id="btnPick" title="é¸æ“‡æœ¬é€±æƒ…å¢ƒ">
        <span id="weekLabel">W1</span>
        <span class="meta" id="scenePickLabel">é¸æ“‡æƒ…å¢ƒ</span>
        <span aria-hidden="true">â–¾</span>
      </button>
      <button class="smallBtn" id="btnReplay">é‡æ’­</button>
    </div>
  </div>

  <div class="card grid">
    <div class="hero card">
      <div class="heroRow">
        <div class="avatar" aria-label="AI è€å¸«é ­åƒ">
          <video id="teacherVideo" class="teacherMedia" src="https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/assets/avatars/talk.mp4" autoplay muted loop playsinline webkit-playsinline></video>
          <span class="dot" id="dotLive"></span>
        </div>
        <div class="heroText">
          <div class="sceneTitle" id="sceneTitle">è¼‰å…¥ä¸­â€¦</div>
          <div class="sceneSub" id="sceneSub">æœ¬é€±ï¼š3 å€‹ç·´ç¿’ï¼ˆCore / Variation / Challengeï¼‰</div>
        </div>
      </div>
    </div>

    <div class="big">
      <div class="en" id="lineEn">Loadingâ€¦</div>
      <div class="zh" id="lineZh">ï¼ˆè¼‰å…¥ä¸­â€¦ï¼‰</div>
    </div>

    <div class="controls">
      <button class="mic" id="btnMic" aria-label="é–‹å§‹èªéŸ³è¾¨è­˜">ğŸ¤</button>
      <button class="ctrlBtn" id="btnType"><span aria-hidden="true">âŒ¨ï¸</span><span>è¼¸å…¥</span></button>
      <button class="ctrlBtn" id="btnSkip"><span>è·³é</span></button>
    </div>

    <div class="row2">
      <button class="chip" id="btnHint">æç¤º</button>
      <button class="chip" id="btnSave">æ”¶è—</button>
      <button class="chip" id="btnFill">å¡«ç©ºå¼•å°</button>
    </div>

    <div class="card fillCard" id="fillCard">
      <div class="fillHead">
        <div class="h">å¡«ç©ºæç¤º</div>
        <div class="badges">
          <span class="badge lev" id="levBadge">A1</span>
          <button class="badge" id="btnHideFill" type="button">éš±è—</button>
        </div>
      </div>
      <div class="fillEn" id="fillEn">Can I get a ____ , please?</div>
      <div class="fillHint" id="fillHint">å…ˆç”¨ã€Œå¡«ç©ºã€å®Œæˆä¸€å¥ï¼Œå†æ”¹æˆä½ è‡ªå·±çš„èªªæ³•ã€‚</div>
      <div class="fillRow">
        <input class="inp" id="fillInput" placeholder="å¡«å…¥ç©ºæ ¼â€¦"/>
      </div>
      <div class="fillRow" style="margin-top:10px">
        <button class="primary" id="btnSendFill">âœ… é€å‡ºå¡«å¥½å¥</button>
        <button class="ghost" id="btnFillReset">é‡ä¾†</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- picker modal -->
<div class="modalMask" id="mask" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="é¸æ“‡æƒ…å¢ƒ">
    <div class="modalTop">
      <div class="t">é¸æ“‡æƒ…å¢ƒï¼ˆä¾é€±æ¨å‡ºï¼‰</div>
      <button class="btnIcon" id="btnClose" aria-label="é—œé–‰">âœ•</button>
    </div>
    <div class="modalBody" id="modalBody"></div>
  </div>
</div>

<script>
/* =============================
   Talk weekly learner console
   - Reads ./talk/index.json
   - Groups by w01..w08
   - Unlock week by time since first use (localStorage)
   - Loads ./talk/<id>.json
   ============================= */
(function(){
  const $ = (id)=>document.getElementById(id);
  const toastEl = $("toast");
  const mask = $("mask");
  const modalBody = $("modalBody");

  const INDEX_URL = new URL("/talk/talk-roadmap-8weeks.json", location.origin).toString();
  const FALLBACK_INDEX_URLS = [
    new URL("./index.json", location.href).toString(),              // if talk.html inside /talk/
    new URL("../talk/index.json", location.href).toString(),        // if talk.html inside /checklist/
  ];

  const LS_START = "BW_TALK_LEARNER_START_TS";  const LS_SAVED = "BW_TALK_SAVED_LINES";

  const DAY = 24*60*60*1000;
  const MAX_WEEKS = 8; // MVP
  const ITEMS_PER_WEEK = 3;

  // UI refs
  const weekLabel = $("weekLabel");
  const scenePickLabel = $("scenePickLabel");
  const sceneTitle = $("sceneTitle");
  const sceneSub = $("sceneSub");
  const levBadge = $("levBadge");

  const lineEn = $("lineEn");
  const lineZh = $("lineZh");

  const btnPick = $("btnPick");
  const btnClose = $("btnClose");
  const btnReplay = $("btnReplay");
  const btnMic = $("btnMic");
  const btnType = $("btnType");
  const btnSkip = $("btnSkip");

  const btnHint = $("btnHint");
  const btnSave = $("btnSave");
  const btnFill = $("btnFill");
  const fillCard = $("fillCard");
  const btnHideFill = $("btnHideFill");
  const fillEn = $("fillEn");
  const fillHint = $("fillHint");
  const fillInput = $("fillInput");
  const btnSendFill = $("btnSendFill");
  const btnFillReset = $("btnFillReset");
  const btnBack = $("btnBack");

  // State
  let indexData = null;               // {scenes:[]}
  let byWeek = new Map();             // weekNo -> scenes[]
  let unlockedWeek = 1;               // computed
  let activeWeek = 1;
  let activeSceneId = null;
  let activeSceneTitle = "";
  let activeScene = null;             // loaded json
  let turns = [];                     // normalized turns
  let turnIdx = 0;
  let lastTts = null;

  // -------- utils --------
  function showToast(msg){
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toastEl.style.display="none", 1800);
  }
  function openModal(){
    mask.style.display = "flex";
    mask.setAttribute("aria-hidden","false");
  }
  function closeModal(){
    mask.style.display = "none";
    mask.setAttribute("aria-hidden","true");
  }
  function getWeekFromId(id){
    const m = String(id||"").match(/^w(\d{2})\./i);
    return m ? parseInt(m[1],10) : null;
  }
  function safeText(v){ return (v==null) ? "" : String(v); }

  async function fetchJsonAny(urls){
    let lastErr = null;
    for(const u of urls){
      try{
        const res = await fetch(u, {cache:"no-cache"});
        if(!res.ok) throw new Error("HTTP "+res.status);
        return await res.json();
      }catch(e){ lastErr = e; }
    }
    throw lastErr || new Error("fetch failed");
  }

  function ensureStartTs(){
    let ts = Number(localStorage.getItem(LS_START)||"0");
    if(!ts){
      ts = Date.now();
      localStorage.setItem(LS_START, String(ts));
    }
    return ts;
  }

  function computeUnlockedWeek(){
    const ts = ensureStartTs();
    const diff = Date.now() - ts;
    const w = Math.floor(diff / (7*DAY)) + 1;
    return Math.max(1, Math.min(MAX_WEEKS, w));
  }

  // ---- turns normalize (defensive) ----
  function normalizeTurns(raw){
    const arr = Array.isArray(raw) ? raw : (raw && raw.turns ? raw.turns : []);
    return (arr||[]).map(t=>{
      if(!t) return null;
      const en = (t.en ?? t.english ?? t.text ?? '').toString().trim();
      const zh = (t.zh ?? t.tw ?? t.cn ?? t.chinese ?? '').toString().trim();
      const role = (t.role ?? t.speaker ?? '').toString().trim() || 'AI';
      const level = (t.level ?? t.cefr ?? '').toString().trim() || 'A1';
      const hint = (t.hint ?? '').toString().trim();
      const fill = (t.fill ?? t.blank ?? '').toString();
      const answer = (t.answer ?? '').toString().trim();
      return { en, zh, role, level, hint, fill, answer };
    }).filter(x=>x && x.en);
  }

  function getOverrides(){
    return { weekOverride: null, sceneOverride: null };
  }

  function currentTurn(){
    return turns[Math.max(0, Math.min(turnIdx, turns.length-1))] || {en:"",zh:"",level:"A1",hint:"",fill:"",answer:""};
  }

  function updateUI(){
    const t = currentTurn();
    lineEn.textContent = t.en || "â€”";
    lineZh.textContent = t.zh ? t.zh : " ";
    levBadge.textContent = t.level || "A1";

    // Fill guide
    const fillText = t.fill && t.fill.trim() ? t.fill : guessFillFromSentence(t.en);
    fillEn.textContent = fillText || "Can I get a ____ , please?";
    fillHint.textContent = t.hint && t.hint.trim()
      ? t.hint
      : "å…ˆç”¨ã€Œå¡«ç©ºã€å®Œæˆä¸€å¥ï¼Œå†æ”¹æˆä½ è‡ªå·±çš„èªªæ³•ã€‚";
    if(!fillInput.value) fillInput.value = "";

    // top labels
    weekLabel.textContent = "W" + String(activeWeek);
    scenePickLabel.textContent = activeSceneTitle ? activeSceneTitle : "é¸æ“‡æƒ…å¢ƒ";
    sceneTitle.textContent = activeSceneTitle ? activeSceneTitle : "è¼‰å…¥ä¸­â€¦";
    sceneSub.textContent = `æœ¬é€±ï¼š${ITEMS_PER_WEEK} å€‹ç·´ç¿’ï¼ˆCore / Variation / Challengeï¼‰ Â· é€²åº¦ ${turnIdx+1}/${Math.max(1,turns.length)}`;
  }

  function guessFillFromSentence(en){
    if(!en) return "";
    // Simple heuristic: blank the longest noun-ish token or last content word
    const s = String(en).trim();
    if(s.includes("____")) return s;
    const words = s.replace(/[â€œâ€"]/g,"").split(/\s+/).filter(Boolean);
    if(words.length<4) return s.replace(/\b(\w+)\b/, "____");
    // blank one token near the end
    const k = Math.max(1, words.length-2);
    const target = words[k].replace(/[.,!?;:]+$/,"");
    return s.replace(target, "____");
  }

  async function speak(text){
    try{
      if(!("speechSynthesis" in window)) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "en-US";
      u.rate = 1.0;
      lastTts = text;
      window.speechSynthesis.speak(u);
    }catch(e){}
  }

  function stopSpeak(){
    try{ window.speechSynthesis.cancel(); }catch(e){}
  }

  function nextTurn(){
    if(turnIdx < turns.length-1){
      turnIdx++;
      updateUI();
      speak(currentTurn().en);
    }else{
      showToast("æœ¬æƒ…å¢ƒå®Œæˆ âœ…");
    }
  }

  function saveLine(){
    const t = currentTurn();
    if(!t.en) return;
    let arr = [];
    try{ arr = JSON.parse(localStorage.getItem(LS_SAVED)||"[]"); }catch(e){}
    arr.unshift({en:t.en, zh:t.zh, at:new Date().toISOString(), scene:activeSceneId});
    arr = arr.slice(0,200);
    localStorage.setItem(LS_SAVED, JSON.stringify(arr));
    showToast("å·²æ”¶è—");
  }

  async function loadSceneById(id, title){
    activeSceneId = id;
    activeSceneTitle = title || id;

    const url = new URL("./talk/" + encodeURIComponent(id) + ".json", location.href).toString();
    const fallback = [
      url,
      new URL("./" + encodeURIComponent(id) + ".json", location.href).toString(), // if talk.html in /talk/
      new URL("../talk/" + encodeURIComponent(id) + ".json", location.href).toString(), // if talk.html in /checklist/
    ];
    try{
      activeScene = await fetchJsonAny(fallback);
    }catch(e){
      showToast("æ‰¾ä¸åˆ°å ´æ™¯ JSONï¼š" + id);
      turns = [{en:"Scene JSON not found.", zh:"æ‰¾ä¸åˆ°å ´æ™¯ JSONï¼ˆè«‹ç¢ºèªæª”æ¡ˆæ”¾åœ¨ /talk/ï¼‰", level:"A1"}];
      turnIdx = 0;
      updateUI();
      return;
    }

    turns = normalizeTurns(activeScene);
    if(!turns.length){
      turns = [{en:"(No turns found in JSON)", zh:"JSON æ²’æœ‰ turns/dialogue/lines/items é™£åˆ—", level: String(activeScene?.meta?.level || "A1")}];
    }
    turnIdx = 0;
    fillInput.value = "";
    updateUI();
    // autoplay first line
    speak(currentTurn().en);
  }

  function buildWeekMap(){
    byWeek = new Map();
    const scenes = (indexData && Array.isArray(indexData.scenes)) ? indexData.scenes : [];
    for(const s of scenes){
      const id = s.id || s.scene_id || s.key;
      if(!id) continue;
      const wk = getWeekFromId(id);
      if(!wk) continue;
      if(!byWeek.has(wk)) byWeek.set(wk, []);
      byWeek.get(wk).push({id, title: s.title || id, level: s.level || s.lev || ""});
    }
    // stable sort
    for(const [wk, arr] of byWeek){
      arr.sort((a,b)=>String(a.id).localeCompare(String(b.id)));
    }
  }

  function renderPicker(){
    modalBody.innerHTML = "";
    for(let wk=1; wk<=MAX_WEEKS; wk++){
      const list = byWeek.get(wk) || [];
      if(!list.length) continue;

      const locked = wk > unlockedWeek;
      const g = document.createElement("div");
      g.className = "group";
      const head = document.createElement("div");
      head.className = "gHead";
      head.innerHTML = `<div>Week ${wk}</div><div class="lock">${locked ? "ğŸ”’ å°šæœªè§£é–" : "âœ… å¯ç·´ç¿’"}</div>`;
      g.appendChild(head);

      for(const it of list){
        const row = document.createElement("div");
        row.className = "item";
        const left = document.createElement("div");
        left.innerHTML = `<div class="name">${escapeHtml(it.title)}</div><p class="sub">${escapeHtml(it.id)}${it.level?(" Â· "+escapeHtml(it.level)):""}</p>`;
        const btn = document.createElement("button");
        btn.className = locked ? "ghost" : "primary";
        btn.style.height = "42px";
        btn.style.fontSize = "15px";
        btn.textContent = locked ? "å°šæœª" : "é–‹å§‹";
        btn.disabled = locked;
        btn.addEventListener("click", ()=>{
          activeWeek = wk;
          localStorage.setItem(LS_LAST_SCENE, it.id);
          closeModal();
          loadSceneById(it.id, it.title);
        });
        row.appendChild(left);
        row.appendChild(btn);
        g.appendChild(row);
      }
      modalBody.appendChild(g);
    }
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"]/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]));
  }

  async function init(){
    getOverrides();
    unlockedWeek = computeUnlockedWeek();
    activeWeek = getActiveWeek(weekMap);
  try{ localStorage.setItem("talk_active_week", String(activeWeek)); }catch(_e){}

    // load index.json
    try{
      indexData = await fetchJsonAny([INDEX_URL, ...FALLBACK_INDEX_URLS]);
    }catch(e){
      indexData = { scenes: [] };
      showToast("è®€ä¸åˆ° talk/index.json");
    }

    buildWeekMap();
    renderPicker();

    // pick scene
    const params = new URLSearchParams(location.search);
    const legacyScene = params.get("scene"); // e.g. coffee_shop
    const forcedScene = null;

    let firstId = null, firstTitle = null;

    if(legacyScene){
      // å…¼å®¹èˆŠåƒæ•¸ï¼š?scene=airport  ->  å°æ‡‰åˆ° index.json å…§å« airport çš„ id (ä¾‹å¦‚ w02.variation.airport)
      let mapped = null;
      for(const list of byWeek.values()){
        const hit = list.find(x => x.id === legacyScene || x.id.endsWith(`.${legacyScene}`) || x.id.includes(legacyScene));
        if(hit){ mapped = hit; break; }
      }
      firstId = mapped ? mapped.id : legacyScene;
      firstTitle = mapped ? mapped.title : legacyScene;
    }else if(forcedScene){
      firstId = forcedScene;
      // try resolve title
      for(const wkList of byWeek.values()){
        const hit = wkList.find(x=>x.id===forcedScene);
        if(hit){ firstTitle = hit.title; break; }
      }
      firstTitle = firstTitle || forcedScene;
    }else{
      const list = byWeek.get(activeWeek) || [];
      if(list.length){
        firstId = list[0].id; firstTitle = list[0].title;
      }else{
        // fallback: if no wxx scenes, pick first in index
        const scenes = indexData?.scenes || [];
        if(scenes[0]){
          firstId = scenes[0].id; firstTitle = scenes[0].title || scenes[0].id;
        }
      }
    }

    if(!firstId){
      turns = [{en:"No scenes in index.json", zh:"è«‹å…ˆæŠŠ w01..w08 çš„ JSON èˆ‡ talk/index.json æ”¾åœ¨ /talk/ ç›®éŒ„", level:"A1"}];
      updateUI();
      return;
    }
    await loadSceneById(firstId, firstTitle);
  }

  // -------- events --------
  btnPick.addEventListener("click", openModal);
  btnClose.addEventListener("click", closeModal);
  mask.addEventListener("click", (e)=>{ if(e.target===mask) closeModal(); });

  btnReplay.addEventListener("click", ()=>{
    const t = currentTurn();
    if(t.en) speak(t.en);
    else if(lastTts) speak(lastTts);
  });

  btnSkip.addEventListener("click", ()=>nextTurn());

  btnHint.addEventListener("click", ()=>{
    const t = currentTurn();
    showToast(t.hint && t.hint.trim() ? t.hint : "æç¤ºï¼šå…ˆè·Ÿè‘—å”¸ä¸€éï¼Œå†æ”¹æˆä½ è‡ªå·±çš„èªªæ³•ã€‚");
  });

  btnSave.addEventListener("click", saveLine);

  btnFill.addEventListener("click", ()=>{
    fillCard.scrollIntoView({behavior:"smooth", block:"start"});
    fillInput.focus();
  });

  btnHideFill.addEventListener("click", ()=>{
    const hidden = fillCard.style.display === "none";
    fillCard.style.display = hidden ? "" : "none";
  });

  btnFillReset.addEventListener("click", ()=>{
    fillInput.value = "";
    fillInput.focus();
  });

  btnSendFill.addEventListener("click", async ()=>{
    const t = currentTurn();
    const blank = fillEn.textContent;
    const word = fillInput.value.trim();
    if(!word){ showToast("è«‹å…ˆå¡«å…¥ç©ºæ ¼"); return; }
    const sentence = blank.replace("____", word);
    await speak(sentence);
    showToast("é€å‡ºå®Œæˆ âœ…");
    // after sending, go next
    setTimeout(()=>nextTurn(), 900);
  });

  btnType.addEventListener("click", ()=>{
    const t = currentTurn();
    const ans = prompt("è¼¸å…¥ä½ çš„å¥å­ï¼ˆæœƒç”¨ TTS æœ—è®€ï¼‰", t.en || "");
    if(ans && ans.trim()){
      speak(ans.trim());
    }
  });

  btnBack.addEventListener("click", ()=>{
    history.length>1 ? history.back() : (location.href = "./");
  });

  // Speech recognition
  let rec = null;
  function startRec(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){
      showToast("æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜");
      return;
    }
    if(rec){ try{rec.stop()}catch(e){} }
    rec = new SR();
    rec.lang = "en-US";
    rec.interimResults = false;
    rec.maxAlternatives = 1;
    $("dotLive").style.background = "#ef4444";
    rec.onresult = (ev)=>{
      const said = ev.results?.[0]?.[0]?.transcript || "";
      $("dotLive").style.background = "#22c55e";
      showToast("ä½ èªªï¼š " + said);
      // simple progress rule: if user said something, move on
      setTimeout(()=>nextTurn(), 750);
    };
    rec.onerror = ()=>{
      $("dotLive").style.background = "#22c55e";
      showToast("èªéŸ³è¾¨è­˜å¤±æ•—");
    };
    rec.onend = ()=>{
      $("dotLive").style.background = "#22c55e";
    };
    try{ rec.start(); }catch(e){ showToast("èªéŸ³è¾¨è­˜ç„¡æ³•å•Ÿå‹•"); }
  }
  btnMic.addEventListener("click", startRec);

  // Avoid iOS rubber band scroll / keep stable
  document.addEventListener("touchmove", (e)=>{
    // allow scrolling only inside modal body
    const inModal = e.target && (e.target.closest && e.target.closest("#modalBody"));
    if(mask.style.display==="flex" && inModal) return;
    // otherwise prevent overscroll
  }, {passive:true});

  init();
})();</script>
</body>
</html>
