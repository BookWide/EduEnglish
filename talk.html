<!doctype html>
<html lang="zh-Hant">
<head>
<!-- ===== BookWide Guard (Talk: subscription required) ===== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>


<!-- ===== /BookWide Guard ===== -->

<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Talkï¼ˆæ¯é€±å£èªªï¼‰ï½œBookWide</title>
<style>
:root{
  --bg:#f4f6fb; --card:#fff; --ink:#0b1220; --muted:#5b667a; --line:#e6eaf0;
  --shadow:0 10px 28px rgba(10,20,40,.10); --r:18px; --r2:24px;
  --brand:#0b66ff; --brand2:#084fc6; --soft:#f6f8fb;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
  background:var(--bg); color:var(--ink);
  overscroll-behavior: none;
  padding-bottom:18px;
}
a{color:inherit}
.wrap{max-width:980px; margin:0 auto; padding:14px 14px 24px}
.card{background:var(--card); border:1px solid var(--line); border-radius:var(--r2); box-shadow:var(--shadow)}
.topbar{padding:14px; display:flex; gap:10px; align-items:center; justify-content:space-between}
.leftTop{display:flex; align-items:center; gap:12px}
.btnIcon{
  width:44px; height:44px; border-radius:999px; border:1px solid var(--line);
  background:#fff; display:grid; place-items:center; box-shadow:0 6px 18px rgba(10,20,40,.08);
}
.brandTitle{font-weight:800; font-size:22px; line-height:1}
.sub{font-size:12px; color:var(--muted); margin-top:4px}
.rightTop{display:flex; gap:10px; align-items:center}
.smallBtn{
  border:1px solid var(--line); background:#fff; border-radius:999px; padding:10px 12px;
  font-weight:700; color:var(--brand2); box-shadow:0 6px 18px rgba(10,20,40,.08);
}
.smallBtn:active{transform:translateY(1px)}
.pill{
  border:1px solid var(--line); background:#fff; border-radius:999px; padding:10px 12px;
  display:flex; align-items:center; gap:8px; font-weight:800;
}
.pill select{border:none;background:transparent;font:inherit;color:inherit;outline:none;padding:0 2px;}
.pill .meta{margin-right:6px;opacity:.75;font-size:12px;}
.pill .meta{font-size:12px; color:var(--muted); font-weight:700}
.grid{display:grid; grid-template-columns:1fr; gap:14px; padding:14px}
.hero{padding:14px}
.heroRow{display:flex; gap:14px; align-items:center}
.avatar{
  width:92px; height:92px; border-radius:999px;
  border:1px solid var(--line);
  background: radial-gradient(circle at 30% 30%, #ffffff 0%, #eef3ff 40%, #e8eefb 100%);
  box-shadow:inset 0 0 0 10px rgba(255,255,255,.6);
  position:relative; flex:0 0 auto;
}
  .avatar{ position:relative; overflow:hidden; }
  .teacherMedia{ width:100%; height:100%; object-fit:cover; border-radius:999px; display:block; }

.dot{position:absolute; left:12px; top:14px; width:12px; height:12px; border-radius:999px; background:#22c55e; box-shadow:0 0 0 4px rgba(34,197,94,.15)}
.heroText{min-width:0}
.sceneTitle{font-weight:900; font-size:16px}
.sceneSub{color:var(--muted); font-size:12px; margin-top:4px}
.big{
  padding:16px; border-radius:var(--r2); border:1px solid var(--line);
  background:var(--soft);
}
.big .en{font-size:34px; font-weight:900; letter-spacing:.2px}
.big .zh{margin-top:10px; font-size:15px; color:var(--muted)}
.controls{
  display:grid; grid-template-columns:86px 1fr 1fr; gap:12px; align-items:center;
}
.mic{
  width:86px; height:86px; border-radius:999px; border:none;
  background:linear-gradient(180deg,var(--brand) 0%, var(--brand2) 100%);
  color:#fff; font-size:28px; font-weight:900;
  box-shadow:0 16px 40px rgba(11,102,255,.35);
}
.ctrlBtn{
  height:52px; border-radius:999px; border:1px solid var(--line);
  background:#fff; font-weight:900; font-size:18px; color:var(--brand2);
  display:flex; align-items:center; justify-content:center; gap:10px;
  box-shadow:0 10px 24px rgba(10,20,40,.08);
}
.ctrlBtn small{font-size:14px; color:var(--muted); font-weight:800}
.row2{display:flex; gap:10px; flex-wrap:wrap}
.chip{
  border:1px solid var(--line); border-radius:999px; background:#fff;
  padding:10px 12px; font-weight:900; color:var(--ink);
}
.chip.on{background:#0b1220; color:#fff; border-color:#0b1220}
.fillCard{padding:14px}
.fillHead{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px}
.fillHead .h{font-weight:900; font-size:18px}
.badges{display:flex; gap:10px; align-items:center}
.badge{
  border:1px solid var(--line); border-radius:999px; padding:8px 12px; background:#fff;
  font-weight:900; color:var(--muted);
}
.badge.lev{color:#0b1220}
.fillEn{font-size:34px; font-weight:950; line-height:1.05}
.fillHint{margin-top:10px; color:var(--muted); font-weight:700}
.fillRow{display:flex; gap:10px; margin-top:14px; align-items:center}
.primary{
  height:54px; border-radius:999px; border:none;
  background:linear-gradient(180deg,var(--brand) 0%, var(--brand2) 100%);
  color:#fff; font-weight:950; padding:0 18px; font-size:18px;
  box-shadow:0 16px 40px rgba(11,102,255,.28);
}
.ghost{
  height:54px; border-radius:999px; border:1px solid var(--line); background:#fff;
  font-weight:950; padding:0 18px; font-size:18px; color:var(--brand2);
}
.inp{
  width:100%; height:54px; border-radius:16px; border:1px solid var(--line);
  padding:0 14px; font-size:18px; font-weight:800; outline:none;
  background:#fff;
}
.toast{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:18px; background:#0b1220; color:#fff; padding:10px 12px;
  border-radius:999px; font-weight:800; font-size:13px;
  box-shadow:0 18px 45px rgba(0,0,0,.25);
  max-width:min(92vw,520px); display:none;
}
.modalMask{position:fixed; inset:0; background:rgba(0,0,0,.34); display:none; align-items:flex-start; justify-content:center; padding:18px}
.modal{
  width:min(720px, 94vw);
  background:#fff; border:1px solid var(--line);
  border-radius:24px; box-shadow:0 24px 80px rgba(0,0,0,.25);
  overflow:hidden;
}
.modalTop{padding:14px 14px 10px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--line)}
.modalTop .t{font-weight:950}
.modalBody{padding:12px; max-height:70vh; overflow:auto}
.group{border:1px solid var(--line); border-radius:18px; overflow:hidden; margin-bottom:12px}
.group .gHead{padding:10px 12px; background:#f7f9ff; font-weight:950; display:flex; justify-content:space-between; align-items:center}
.group .gHead .lock{font-size:12px; color:var(--muted); font-weight:900}
.item{padding:12px; border-top:1px solid var(--line); display:flex; gap:10px; align-items:center; justify-content:space-between}
.item .name{font-weight:900}
.item .sub{margin:0; font-size:12px}
.item button{white-space:nowrap}
@media (max-width:520px){
  .wrap{padding:10px 10px 18px}
  .topbar{padding:12px}
  .brandTitle{font-size:20px}
  .big .en{font-size:30px}
  .fillEn{font-size:30px}
  .controls{grid-template-columns:78px 1fr 1fr}
  .mic{width:78px; height:78px; font-size:26px}
  .ctrlBtn{height:50px; font-size:17px}
}

/* ===== Mobile compact (v3) ===== */
@media (max-width: 520px){
  .brandTitle{font-size:14px}
  .sub{font-size:10px}
  .pill .meta{font-size:10px}
  .sceneTitle{font-size:13px}
  .sceneSub{font-size:10px}
  .big .en{font-size:20px}
  .big .zh{font-size:12px}
  .micBtn{min-height:64px}
  .micBtn .label{font-size:14px}
  .ctrlBtn{min-height:44px}
  .ctrlBtn span{font-size:14px}
  .ctrlBtn small{font-size:11px}
  .fillCard{padding:12px}
  .fillHead .h{font-size:14px}
  .fillEn{font-size:20px}
  .fillHint{font-size:11px}
  .fillSend,.fillReroll{min-height:44px; font-size:14px; padding:0 14px}
  .fillInput{min-height:44px; font-size:14px}
  .chip{font-size:11px; padding:8px 10px}
}
.fileTag{display:inline-block; margin-left:10px; font-size:12px; color:var(--muted); max-width:240px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
.bottomPanel{
  position:sticky; bottom:10px; left:auto; transform:none;
  width:100%;
  margin-top:12px;
  border:1px solid var(--line);
  border-radius:var(--r2);
  background:var(--card);
  box-shadow:0 10px 28px rgba(10,20,40,.10);
  padding:12px 14px;
  z-index:5;
}
.bpRow{display:flex; gap:10px; align-items:flex-start;}
.bpTitle{flex:0 0 auto; font-weight:800; font-size:13px; padding:4px 10px; border-radius:999px; background:var(--soft); color:var(--brand2);}
.bpBody{flex:1 1 auto; font-size:13px; color:var(--ink); line-height:1.35; min-height:22px;}
.bpLinks{margin-top:8px; display:flex; gap:10px; flex-wrap:wrap;}
.bpLink{font-size:12px; color:var(--brand2); text-decoration:none; padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:#fff;}
.bpLink:hover{background:var(--soft);}
@media (max-width:520px){
  .fileTag{max-width:120px}
  .bottomPanel{bottom:8px; padding:10px 12px; border-radius:16px;}
}

/* ===== V8.5 Mobile Topbar Tighten (2026-01-10) ===== */
@media (max-width:520px){
  .wrap{padding:6px 10px 14px !important;}
  .topbar{padding:8px 10px !important; gap:8px !important;}
  .backBtn,.back{width:40px !important; height:40px !important; border-radius:14px !important;}
  .brandTitle{font-size:13px !important;}
  .sub{font-size:9px !important; margin-top:2px !important;}
  .pill{padding:6px 8px !important; gap:6px !important;}
  .pill .meta{font-size:9px !important;}
  .pill .w{font-size:12px !important;}
  .replayBtn,.btnReplay{width:44px !important; height:44px !important; font-size:12px !important;}
  .hero{padding:10px !important;}
  .avatar{width:72px !important; height:72px !important;}
  .sceneTitle{font-size:14px !important;}
  .sceneSub{font-size:10px !important;}
  .big{padding:12px !important;}
  .big .zh{margin-top:4px !important; font-size:10px !important;}
}


/* ====== v7-ultra-compact-2 (2026-01-10) ======
   - æ›´æ¿€é€²ç¸®å°è¡Œè·/é–“è·ï¼ˆæ‰‹æ©Ÿä¸€é å®¹ç´æ›´å¤šï¼‰
   - ç¸®å°å¤§å¥å­ã€å¡«ç©ºã€é€å‡º/é‡ä¾†æŒ‰éˆ•ã€å¡ç‰‡ padding/margin
*/
:root{
  --card-pad:10px;
}

/* overall */
.wrap{padding:8px 10px 12px !important;}
.card{padding:var(--card-pad) !important; margin:8px 0 !important;}
.hr{margin:8px 0 !important;}

/* topbar */
.topbar{padding:6px 10px !important; gap:8px !important;}
.iconBtn{width:36px !important; height:36px !important;}
.brand .t{font-size:18px !important; line-height:1.05 !important;}
.brand .s{font-size:12px !important; margin-top:1px !important; line-height:1.05 !important;}
.smallBtn{padding:6px 10px !important; border-radius:999px !important; font-size:12px !important;}

/* status/hero cards */
.hero{padding:10px !important;}
.heroGrid{gap:10px !important;}
.avatarWrap{width:74px !important; height:74px !important;}
.heroTitle{font-size:18px !important; margin-bottom:2px !important; line-height:1.1 !important;}
.heroSub{font-size:12px !important; line-height:1.15 !important;}
.progress{font-size:12px !important; line-height:1.15 !important;}

/* big sentence (AI line) */
.big .en{font-size:24px !important; line-height:1.05 !important;}
.big .zh{margin-top:4px !important; font-size:12px !important; line-height:1.15 !important;}

/* controls block */
.controls{margin-top:8px !important;}
.ctrlRow{gap:10px !important;}
.micBtn{width:64px !important; height:64px !important;}
.ctrlBtn{height:40px !important; padding:0 14px !important; font-size:14px !important;}
.ctrlBtn .ico{font-size:16px !important; margin-right:8px !important;}
.ctrlRow2{gap:10px !important; margin-top:8px !important;}
.pillBtn{padding:8px 14px !important; font-size:14px !important;}

/* reply / fill card */
.replyCard{padding:10px !important;}
.replyHead{margin-bottom:6px !important;}
.replyTitle{font-size:16px !important; line-height:1.05 !important;}
.replyDesc{font-size:11px !important; line-height:1.15 !important; margin-top:4px !important;}
.fillEn{font-size:24px !important; line-height:1.05 !important;}
.fillHint{margin-top:4px !important; font-size:11px !important; line-height:1.15 !important;}
.input{margin-top:8px !important; padding:10px 12px !important; font-size:14px !important; border-radius:16px !important;}

/* action buttons (é€å‡º/é‡ä¾†) */
.fillActions{gap:10px !important; margin-top:10px !important;}
.fillSend{
  min-height:36px !important;
  padding:0 14px !important;
  font-size:14px !important;
  border-radius:18px !important;
  box-shadow:0 10px 22px rgba(37,99,235,.22) !important;
}
.fillReroll{
  min-height:36px !important;
  padding:0 14px !important;
  font-size:14px !important;
  border-radius:18px !important;
}
.fillSend .check{width:22px !important; height:22px !important; margin-right:8px !important; font-size:13px !important;}

/* bottom sheet/panel */
.bottomPanel{margin-top:10px !important;}
.sheetTabs{gap:10px !important;}
.sheetTab{padding:8px 12px !important; font-size:14px !important;}
.sheet{margin-top:8px !important;}
.sheetBody{padding:10px !important;}
.taskItem{padding:10px !important; margin-bottom:8px !important;}
.taskItem .k{font-size:14px !important; margin-bottom:4px !important;}
.taskItem .v{font-size:12px !important; line-height:1.2 !important;}

</style>

<style id="v8-redo-patch">
/* === V8 REDO PATCH === */
/* Reduce dialogue text ~50% */
.big .en { font-size: 17px !important; }
.big .zh { font-size: 12px !important; }
.fillEn { font-size: 17px !important; }
.fillHint, .bpBody, .sceneSub { font-size: 11px !important; }
.sceneTitle { font-size: 13px !important; }

/* Integrate bottom task panel into page flow (no floating) */
.bottomPanel{
  position: static !important;
  margin-top: 12px !important;
  box-shadow: none !important;
}
@media (max-width:520px){
  .big .en { font-size: 16px !important; }
  .fillEn { font-size: 16px !important; }
}

/* ===== V8.5 Mobile Topbar Tighten (2026-01-10) ===== */
@media (max-width:520px){
  .wrap{padding:6px 10px 14px !important;}
  .topbar{padding:8px 10px !important; gap:8px !important;}
  .backBtn,.back{width:40px !important; height:40px !important; border-radius:14px !important;}
  .brandTitle{font-size:13px !important;}
  .sub{font-size:9px !important; margin-top:2px !important;}
  .pill{padding:6px 8px !important; gap:6px !important;}
  .pill .meta{font-size:9px !important;}
  .pill .w{font-size:12px !important;}
  .replayBtn,.btnReplay{width:44px !important; height:44px !important; font-size:12px !important;}
  .hero{padding:10px !important;}
  .avatar{width:72px !important; height:72px !important;}
  .sceneTitle{font-size:14px !important;}
  .sceneSub{font-size:10px !important;}
  .big{padding:12px !important;}
  .big .zh{margin-top:4px !important; font-size:10px !important;}
}


/* ====== v7-ultra-compact-2 (2026-01-10) ======
   - æ›´æ¿€é€²ç¸®å°è¡Œè·/é–“è·ï¼ˆæ‰‹æ©Ÿä¸€é å®¹ç´æ›´å¤šï¼‰
   - ç¸®å°å¤§å¥å­ã€å¡«ç©ºã€é€å‡º/é‡ä¾†æŒ‰éˆ•ã€å¡ç‰‡ padding/margin
*/
:root{
  --card-pad:10px;
}

/* overall */
.wrap{padding:8px 10px 12px !important;}
.card{padding:var(--card-pad) !important; margin:8px 0 !important;}
.hr{margin:8px 0 !important;}

/* topbar */
.topbar{padding:6px 10px !important; gap:8px !important;}
.iconBtn{width:36px !important; height:36px !important;}
.brand .t{font-size:18px !important; line-height:1.05 !important;}
.brand .s{font-size:12px !important; margin-top:1px !important; line-height:1.05 !important;}
.smallBtn{padding:6px 10px !important; border-radius:999px !important; font-size:12px !important;}

/* status/hero cards */
.hero{padding:10px !important;}
.heroGrid{gap:10px !important;}
.avatarWrap{width:74px !important; height:74px !important;}
.heroTitle{font-size:18px !important; margin-bottom:2px !important; line-height:1.1 !important;}
.heroSub{font-size:12px !important; line-height:1.15 !important;}
.progress{font-size:12px !important; line-height:1.15 !important;}

/* big sentence (AI line) */
.big .en{font-size:24px !important; line-height:1.05 !important;}
.big .zh{margin-top:4px !important; font-size:12px !important; line-height:1.15 !important;}

/* controls block */
.controls{margin-top:8px !important;}
.ctrlRow{gap:10px !important;}
.micBtn{width:64px !important; height:64px !important;}
.ctrlBtn{height:40px !important; padding:0 14px !important; font-size:14px !important;}
.ctrlBtn .ico{font-size:16px !important; margin-right:8px !important;}
.ctrlRow2{gap:10px !important; margin-top:8px !important;}
.pillBtn{padding:8px 14px !important; font-size:14px !important;}

/* reply / fill card */
.replyCard{padding:10px !important;}
.replyHead{margin-bottom:6px !important;}
.replyTitle{font-size:16px !important; line-height:1.05 !important;}
.replyDesc{font-size:11px !important; line-height:1.15 !important; margin-top:4px !important;}
.fillEn{font-size:24px !important; line-height:1.05 !important;}
.fillHint{margin-top:4px !important; font-size:11px !important; line-height:1.15 !important;}
.input{margin-top:8px !important; padding:10px 12px !important; font-size:14px !important; border-radius:16px !important;}

/* action buttons (é€å‡º/é‡ä¾†) */
.fillActions{gap:10px !important; margin-top:10px !important;}
.fillSend{
  min-height:36px !important;
  padding:0 14px !important;
  font-size:14px !important;
  border-radius:18px !important;
  box-shadow:0 10px 22px rgba(37,99,235,.22) !important;
}
.fillReroll{
  min-height:36px !important;
  padding:0 14px !important;
  font-size:14px !important;
  border-radius:18px !important;
}
.fillSend .check{width:22px !important; height:22px !important; margin-right:8px !important; font-size:13px !important;}

/* bottom sheet/panel */
.bottomPanel{margin-top:10px !important;}
.sheetTabs{gap:10px !important;}
.sheetTab{padding:8px 12px !important; font-size:14px !important;}
.sheet{margin-top:8px !important;}
.sheetBody{padding:10px !important;}
.taskItem{padding:10px !important; margin-bottom:8px !important;}
.taskItem .k{font-size:14px !important; margin-bottom:4px !important;}
.taskItem .v{font-size:12px !important; line-height:1.2 !important;}

</style>


<style id="v8-controls-compact-v2">
/* === V8 Controls Compact V2 (real merge + clear active) === */
.controlsWrap{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;          /* small screens wrap gracefully */
  margin-top: 6px;
  margin-bottom: 6px;
}

/* make the two inner rows behave like one bar */
.controls, .row2{
  display:flex !important;
  align-items:center;
  gap:10px !important;
  margin:0 !important;
  padding:0 !important;
  box-shadow:none !important;
  background:transparent !important;
}

/* shrink mic + buttons by sizing, NOT transform (keeps layout + tap target sane) */
.mic{
  width:52px !important;
  height:52px !important;
  border-radius:50% !important;
  font-size:20px !important;
  box-shadow: 0 10px 24px rgba(15,23,42,.14) !important;
}
.ctrlBtn{
  height:40px !important;
  padding:0 14px !important;
  font-size:12px !important;
  border-radius:999px !important;
}
.ctrlBtn span{ font-size:12px !important; }

/* chips */
.chip{
  height:34px !important;
  padding:0 12px !important;
  font-size:12px !important;
  border-radius:999px !important;
}

/* clearer pressed/active feedback */
.ctrlBtn:active, .chip:active, .mic:active{
  transform: translateY(1px) scale(0.98);
  filter: saturate(1.15) contrast(1.05);
  box-shadow: inset 0 0 0 3px rgba(37,99,235,.18), 0 8px 18px rgba(15,23,42,.12) !important;
}
.ctrlBtn:focus-visible, .chip:focus-visible, .mic:focus-visible{
  outline: none;
  box-shadow: 0 0 0 3px rgba(37,99,235,.22), 0 10px 24px rgba(15,23,42,.14) !important;
}

/* tighten vertical space around this bar */
.big{ margin-bottom: 10px !important; }

/* ===== V8.5 Mobile Topbar Tighten (2026-01-10) ===== */
@media (max-width:520px){
  .wrap{padding:6px 10px 14px !important;}
  .topbar{padding:8px 10px !important; gap:8px !important;}
  .backBtn,.back{width:40px !important; height:40px !important; border-radius:14px !important;}
  .brandTitle{font-size:13px !important;}
  .sub{font-size:9px !important; margin-top:2px !important;}
  .pill{padding:6px 8px !important; gap:6px !important;}
  .pill .meta{font-size:9px !important;}
  .pill .w{font-size:12px !important;}
  .replayBtn,.btnReplay{width:44px !important; height:44px !important; font-size:12px !important;}
  .hero{padding:10px !important;}
  .avatar{width:72px !important; height:72px !important;}
  .sceneTitle{font-size:14px !important;}
  .sceneSub{font-size:10px !important;}
  .big{padding:12px !important;}
  .big .zh{margin-top:4px !important; font-size:10px !important;}
}


/* ====== v7-ultra-compact-2 (2026-01-10) ======
   - æ›´æ¿€é€²ç¸®å°è¡Œè·/é–“è·ï¼ˆæ‰‹æ©Ÿä¸€é å®¹ç´æ›´å¤šï¼‰
   - ç¸®å°å¤§å¥å­ã€å¡«ç©ºã€é€å‡º/é‡ä¾†æŒ‰éˆ•ã€å¡ç‰‡ padding/margin
*/
:root{
  --card-pad:10px;
}

/* overall */
.wrap{padding:8px 10px 12px !important;}
.card{padding:var(--card-pad) !important; margin:8px 0 !important;}
.hr{margin:8px 0 !important;}

/* topbar */
.topbar{padding:6px 10px !important; gap:8px !important;}
.iconBtn{width:36px !important; height:36px !important;}
.brand .t{font-size:18px !important; line-height:1.05 !important;}
.brand .s{font-size:12px !important; margin-top:1px !important; line-height:1.05 !important;}
.smallBtn{padding:6px 10px !important; border-radius:999px !important; font-size:12px !important;}

/* status/hero cards */
.hero{padding:10px !important;}
.heroGrid{gap:10px !important;}
.avatarWrap{width:74px !important; height:74px !important;}
.heroTitle{font-size:18px !important; margin-bottom:2px !important; line-height:1.1 !important;}
.heroSub{font-size:12px !important; line-height:1.15 !important;}
.progress{font-size:12px !important; line-height:1.15 !important;}

/* big sentence (AI line) */
.big .en{font-size:24px !important; line-height:1.05 !important;}
.big .zh{margin-top:4px !important; font-size:12px !important; line-height:1.15 !important;}

/* controls block */
.controls{margin-top:8px !important;}
.ctrlRow{gap:10px !important;}
.micBtn{width:64px !important; height:64px !important;}
.ctrlBtn{height:40px !important; padding:0 14px !important; font-size:14px !important;}
.ctrlBtn .ico{font-size:16px !important; margin-right:8px !important;}
.ctrlRow2{gap:10px !important; margin-top:8px !important;}
.pillBtn{padding:8px 14px !important; font-size:14px !important;}

/* reply / fill card */
.replyCard{padding:10px !important;}
.replyHead{margin-bottom:6px !important;}
.replyTitle{font-size:16px !important; line-height:1.05 !important;}
.replyDesc{font-size:11px !important; line-height:1.15 !important; margin-top:4px !important;}
.fillEn{font-size:24px !important; line-height:1.05 !important;}
.fillHint{margin-top:4px !important; font-size:11px !important; line-height:1.15 !important;}
.input{margin-top:8px !important; padding:10px 12px !important; font-size:14px !important; border-radius:16px !important;}

/* action buttons (é€å‡º/é‡ä¾†) */
.fillActions{gap:10px !important; margin-top:10px !important;}
.fillSend{
  min-height:36px !important;
  padding:0 14px !important;
  font-size:14px !important;
  border-radius:18px !important;
  box-shadow:0 10px 22px rgba(37,99,235,.22) !important;
}
.fillReroll{
  min-height:36px !important;
  padding:0 14px !important;
  font-size:14px !important;
  border-radius:18px !important;
}
.fillSend .check{width:22px !important; height:22px !important; margin-right:8px !important; font-size:13px !important;}

/* bottom sheet/panel */
.bottomPanel{margin-top:10px !important;}
.sheetTabs{gap:10px !important;}
.sheetTab{padding:8px 12px !important; font-size:14px !important;}
.sheet{margin-top:8px !important;}
.sheetBody{padding:10px !important;}
.taskItem{padding:10px !important; margin-bottom:8px !important;}
.taskItem .k{font-size:14px !important; margin-bottom:4px !important;}
.taskItem .v{font-size:12px !important; line-height:1.2 !important;}

</style>


<style id="v8-topbar-small">
/* === V8 Top Bar Small (mobile-first) === */
@media (max-width: 520px){
  /* header container */
  .topbar, .header, .navBar{
    padding: 8px 10px !important;
    border-radius: 16px !important;
  }
  /* shrink the whole top row height */
  .topbar * { line-height: 1.1 !important; }
  .title, .brandTitle, .pageTitle{
    font-size: 16px !important;
    font-weight: 800 !important;
  }
  .subtitle, .brandSub, .pageSub{
    font-size: 11px !important;
    margin-top: 2px !important;
  }

  /* back button + right buttons */
  .backBtn, .btnBack{
    width: 38px !important;
    height: 38px !important;
    border-radius: 14px !important;
  }
  .topRight button, .topbar .ctrlBtn, .topbar .chip, .topbar .btn{
    height: 34px !important;
    padding: 0 10px !important;
    font-size: 12px !important;
    border-radius: 14px !important;
  }

  /* week selector / dropdown */
  select, .weekSel, .sceneSel{
    height: 34px !important;
    padding: 0 10px !important;
    font-size: 12px !important;
    border-radius: 14px !important;
  }

  /* reduce spacing under header */
  .wrap, .container{
    padding-top: 8px !important;
  }
}

/* ===== V8.5 Mobile Topbar Tighten (2026-01-10) ===== */
@media (max-width:520px){
  .wrap{padding:6px 10px 14px !important;}
  .topbar{padding:8px 10px !important; gap:8px !important;}
  .backBtn,.back{width:40px !important; height:40px !important; border-radius:14px !important;}
  .brandTitle{font-size:13px !important;}
  .sub{font-size:9px !important; margin-top:2px !important;}
  .pill{padding:6px 8px !important; gap:6px !important;}
  .pill .meta{font-size:9px !important;}
  .pill .w{font-size:12px !important;}
  .replayBtn,.btnReplay{width:44px !important; height:44px !important; font-size:12px !important;}
  .hero{padding:10px !important;}
  .avatar{width:72px !important; height:72px !important;}
  .sceneTitle{font-size:14px !important;}
  .sceneSub{font-size:10px !important;}
  .big{padding:12px !important;}
  .big .zh{margin-top:4px !important; font-size:10px !important;}
}


/* ====== v7-ultra-compact-2 (2026-01-10) ======
   - æ›´æ¿€é€²ç¸®å°è¡Œè·/é–“è·ï¼ˆæ‰‹æ©Ÿä¸€é å®¹ç´æ›´å¤šï¼‰
   - ç¸®å°å¤§å¥å­ã€å¡«ç©ºã€é€å‡º/é‡ä¾†æŒ‰éˆ•ã€å¡ç‰‡ padding/margin
*/
:root{
  --card-pad:10px;
}

/* overall */
.wrap{padding:8px 10px 12px !important;}
.card{padding:var(--card-pad) !important; margin:8px 0 !important;}
.hr{margin:8px 0 !important;}

/* topbar */
.topbar{padding:6px 10px !important; gap:8px !important;}
.iconBtn{width:36px !important; height:36px !important;}
.brand .t{font-size:18px !important; line-height:1.05 !important;}
.brand .s{font-size:12px !important; margin-top:1px !important; line-height:1.05 !important;}
.smallBtn{padding:6px 10px !important; border-radius:999px !important; font-size:12px !important;}

/* status/hero cards */
.hero{padding:10px !important;}
.heroGrid{gap:10px !important;}
.avatarWrap{width:74px !important; height:74px !important;}
.heroTitle{font-size:18px !important; margin-bottom:2px !important; line-height:1.1 !important;}
.heroSub{font-size:12px !important; line-height:1.15 !important;}
.progress{font-size:12px !important; line-height:1.15 !important;}

/* big sentence (AI line) */
.big .en{font-size:24px !important; line-height:1.05 !important;}
.big .zh{margin-top:4px !important; font-size:12px !important; line-height:1.15 !important;}

/* controls block */
.controls{margin-top:8px !important;}
.ctrlRow{gap:10px !important;}
.micBtn{width:64px !important; height:64px !important;}
.ctrlBtn{height:40px !important; padding:0 14px !important; font-size:14px !important;}
.ctrlBtn .ico{font-size:16px !important; margin-right:8px !important;}
.ctrlRow2{gap:10px !important; margin-top:8px !important;}
.pillBtn{padding:8px 14px !important; font-size:14px !important;}

/* reply / fill card */
.replyCard{padding:10px !important;}
.replyHead{margin-bottom:6px !important;}
.replyTitle{font-size:16px !important; line-height:1.05 !important;}
.replyDesc{font-size:11px !important; line-height:1.15 !important; margin-top:4px !important;}
.fillEn{font-size:24px !important; line-height:1.05 !important;}
.fillHint{margin-top:4px !important; font-size:11px !important; line-height:1.15 !important;}
.input{margin-top:8px !important; padding:10px 12px !important; font-size:14px !important; border-radius:16px !important;}

/* action buttons (é€å‡º/é‡ä¾†) */
.fillActions{gap:10px !important; margin-top:10px !important;}
.fillSend{
  min-height:36px !important;
  padding:0 14px !important;
  font-size:14px !important;
  border-radius:18px !important;
  box-shadow:0 10px 22px rgba(37,99,235,.22) !important;
}
.fillReroll{
  min-height:36px !important;
  padding:0 14px !important;
  font-size:14px !important;
  border-radius:18px !important;
}
.fillSend .check{width:22px !important; height:22px !important; margin-right:8px !important; font-size:13px !important;}

/* bottom sheet/panel */
.bottomPanel{margin-top:10px !important;}
.sheetTabs{gap:10px !important;}
.sheetTab{padding:8px 12px !important; font-size:14px !important;}
.sheet{margin-top:8px !important;}
.sheetBody{padding:10px !important;}
.taskItem{padding:10px !important; margin-bottom:8px !important;}
.taskItem .k{font-size:14px !important; margin-bottom:4px !important;}
.taskItem .v{font-size:12px !important; line-height:1.2 !important;}

</style>


<style id="v8-tight-space-v4">
/* === V8 Tight Space V4 === */

/* shrink dialogue + response text by ~50% while keeping overall layout */
.dialogue, .aiLine, .bigLine, .utterance, .promptLine{
  font-size: 50% !important;
}

/* also shrink secondary helper text */
.small, .muted, .help, .desc, .subline{
  font-size: 50% !important;
}

/* tighten big empty padding/margins inside the response panel */
.panel, .card, .section{
  padding: 12px !important;
}
.responseBox, .replyBox, .answerBox{
  margin-top: 6px !important;
  padding-top: 6px !important;
}

/* reduce input area height */
textarea, input[type="text"], .replyInput{
  min-height: 40px !important;
  padding: 10px 12px !important;
  font-size: 14px !important;  /* keep input readable */
}

/* compact bottom buttons row ("é€å‡ºå¡«å¥½å¥" / "é‡ä¾†") */
.bottomActions, .submitRow, .btnRow{
  gap: 10px !important;
  margin-top: 10px !important;
}
.bottomActions button, .submitRow button, .btnRow button{
  height: 38px !important;
  padding: 0 14px !important;
  font-size: 13px !important;
}

/* reduce whitespace around the whole block */
.block, .taskBlock, .replyBlock{
  margin-top: 10px !important;
}

/* mobile tighter */
@media (max-width: 520px){
  .panel, .card, .section{ padding: 10px !important; }
  .bottomActions button, .submitRow button, .btnRow button{
    height: 36px !important;
    padding: 0 12px !important;
    font-size: 12px !important;
  }
}

/* ===== V8.5 Mobile Topbar Tighten (2026-01-10) ===== */
@media (max-width:520px){
  .wrap{padding:6px 10px 14px !important;}
  .topbar{padding:8px 10px !important; gap:8px !important;}
  .backBtn,.back{width:40px !important; height:40px !important; border-radius:14px !important;}
  .brandTitle{font-size:13px !important;}
  .sub{font-size:9px !important; margin-top:2px !important;}
  .pill{padding:6px 8px !important; gap:6px !important;}
  .pill .meta{font-size:9px !important;}
  .pill .w{font-size:12px !important;}
  .replayBtn,.btnReplay{width:44px !important; height:44px !important; font-size:12px !important;}
  .hero{padding:10px !important;}
  .avatar{width:72px !important; height:72px !important;}
  .sceneTitle{font-size:14px !important;}
  .sceneSub{font-size:10px !important;}
  .big{padding:12px !important;}
  .big .zh{margin-top:4px !important; font-size:10px !important;}
}


/* ====== v7-ultra-compact-2 (2026-01-10) ======
   - æ›´æ¿€é€²ç¸®å°è¡Œè·/é–“è·ï¼ˆæ‰‹æ©Ÿä¸€é å®¹ç´æ›´å¤šï¼‰
   - ç¸®å°å¤§å¥å­ã€å¡«ç©ºã€é€å‡º/é‡ä¾†æŒ‰éˆ•ã€å¡ç‰‡ padding/margin
*/
:root{
  --card-pad:10px;
}

/* overall */
.wrap{padding:8px 10px 12px !important;}
.card{padding:var(--card-pad) !important; margin:8px 0 !important;}
.hr{margin:8px 0 !important;}

/* topbar */
.topbar{padding:6px 10px !important; gap:8px !important;}
.iconBtn{width:36px !important; height:36px !important;}
.brand .t{font-size:18px !important; line-height:1.05 !important;}
.brand .s{font-size:12px !important; margin-top:1px !important; line-height:1.05 !important;}
.smallBtn{padding:6px 10px !important; border-radius:999px !important; font-size:12px !important;}

/* status/hero cards */
.hero{padding:10px !important;}
.heroGrid{gap:10px !important;}
.avatarWrap{width:74px !important; height:74px !important;}
.heroTitle{font-size:18px !important; margin-bottom:2px !important; line-height:1.1 !important;}
.heroSub{font-size:12px !important; line-height:1.15 !important;}
.progress{font-size:12px !important; line-height:1.15 !important;}

/* big sentence (AI line) */
.big .en{font-size:24px !important; line-height:1.05 !important;}
.big .zh{margin-top:4px !important; font-size:12px !important; line-height:1.15 !important;}

/* controls block */
.controls{margin-top:8px !important;}
.ctrlRow{gap:10px !important;}
.micBtn{width:64px !important; height:64px !important;}
.ctrlBtn{height:40px !important; padding:0 14px !important; font-size:14px !important;}
.ctrlBtn .ico{font-size:16px !important; margin-right:8px !important;}
.ctrlRow2{gap:10px !important; margin-top:8px !important;}
.pillBtn{padding:8px 14px !important; font-size:14px !important;}

/* reply / fill card */
.replyCard{padding:10px !important;}
.replyHead{margin-bottom:6px !important;}
.replyTitle{font-size:16px !important; line-height:1.05 !important;}
.replyDesc{font-size:11px !important; line-height:1.15 !important; margin-top:4px !important;}
.fillEn{font-size:24px !important; line-height:1.05 !important;}
.fillHint{margin-top:4px !important; font-size:11px !important; line-height:1.15 !important;}
.input{margin-top:8px !important; padding:10px 12px !important; font-size:14px !important; border-radius:16px !important;}

/* action buttons (é€å‡º/é‡ä¾†) */
.fillActions{gap:10px !important; margin-top:10px !important;}
.fillSend{
  min-height:36px !important;
  padding:0 14px !important;
  font-size:14px !important;
  border-radius:18px !important;
  box-shadow:0 10px 22px rgba(37,99,235,.22) !important;
}
.fillReroll{
  min-height:36px !important;
  padding:0 14px !important;
  font-size:14px !important;
  border-radius:18px !important;
}
.fillSend .check{width:22px !important; height:22px !important; margin-right:8px !important; font-size:13px !important;}

/* bottom sheet/panel */
.bottomPanel{margin-top:10px !important;}
.sheetTabs{gap:10px !important;}
.sheetTab{padding:8px 12px !important; font-size:14px !important;}
.sheet{margin-top:8px !important;}
.sheetBody{padding:10px !important;}
.taskItem{padding:10px !important; margin-bottom:8px !important;}
.taskItem .k{font-size:14px !important; margin-bottom:4px !important;}
.taskItem .v{font-size:12px !important; line-height:1.2 !important;}

</style>


<style id="ultra-tight-override">
/* === ULTRA TIGHT OVERRIDE === */
body, .card, .panel, .section, .content,
h1, h2, h3, h4, p, div, span, label {
  line-height: 1.1 !important;
}

p, h1, h2, h3, h4 {
  margin-top: 4px !important;
  margin-bottom: 4px !important;
}

.section, .card, .panel {
  padding-top: 6px !important;
  padding-bottom: 6px !important;
  margin-top: 6px !important;
  margin-bottom: 6px !important;
}

.big-sentence, .main-sentence {
  font-size: 0.85em !important;
  line-height: 1.05 !important;
}
</style>


<style id="rebuild-inline-compact">
/* === REBUILD: inline AI with avatar + compact === */
.heroRow{align-items:flex-start}
.heroText{display:flex; flex-direction:column; gap:4px}
/* Inline bubble */
.aiInline{
  background:#f6f8fb;
  border:1px solid var(--line);
  border-radius:14px;
  padding:8px 10px;
}
.aiInline .en{font-size:18px !important; line-height:1.1 !important; font-weight:900}
.aiInline .zh{font-size:12px !important; line-height:1.15 !important; margin-top:4px !important; color:var(--muted)}
/* Hide duplicated title near AI line */
.sceneTitle{display:none !important}
/* Compact overall text */
body{line-height:1.1}
.big{display:none !important} /* old AI block hidden */
/* Buttons compact */
.ctrlBtn{height:40px !important; font-size:14px !important}
.mic{width:56px !important; height:56px !important; font-size:22px !important}
/* Fill card compact */
.fillEn{font-size:18px !important; line-height:1.1 !important}
.fillHint{font-size:11px !important}
</style>


<style id="hide-right-label">
/* Hide right-top file label only */
.fileTag { display: none !important; }
</style>

</head>
<body>
<div class="wrap">
  <div class="card topbar" role="banner">
    <div class="leftTop">
      <button class="btnIcon" id="btnBack" aria-label="è¿”å›">â†</button>
      <div>
        <div class="brandTitle">Talk</div>
        <div class="sub" id="subTitle">æ¯é€±å£èªª Â· Browser Speech</div>
      </div>
    </div>
    <div class="rightTop">
      <button class="pill" id="btnPick" title="é¸æ“‡æœ¬é€±æƒ…å¢ƒ">
        <span id="weekLabel">W1</span>
        <span class="meta" id="scenePickLabel">é¸æ“‡æƒ…å¢ƒ</span>
        <span aria-hidden="true">â–¾</span>
      </button>

        <label class="pill" title="é¸æ“‡è€å¸«">
          <span class="meta">Teacher</span>
          <select id="selTeacher" aria-label="Teacher">
                        <option value="Diana.mp4">Diana</option>
            <option value="Emma.mp4">Emma</option>
            <option value="Sophia.mp4">Sophia</option>
          </select>
        </label>
      <button class="smallBtn" id="btnReplay">é‡æ’­</button>
      <span class="fileTag" id="fileTag"></span>
    </div>
  </div>

  <div class="card grid">
    <div class="hero card">
      <div class="heroRow">
        <div class="avatar" aria-label="AI è€å¸«é ­åƒ">
          <video id="teacherVideo" class="teacherMedia" autoplay muted playsinline webkit-playsinline></video>
          <span class="dot" id="dotLive"></span>
        </div>
        <div class="heroText">
<div class="aiInline">
  <div class="en" id="lineEnInline">Loadingâ€¦</div>
  <div class="zh" id="lineZhInline">ï¼ˆè¼‰å…¥ä¸­â€¦ï¼‰</div>
</div>

          <div class="sceneTitle" id="sceneTitle">è¼‰å…¥ä¸­â€¦</div>
          <div class="sceneSub" id="sceneSub">æœ¬é€±ï¼š3 å€‹ç·´ç¿’ï¼ˆCore / Variation / Challengeï¼‰</div>
        </div>
      </div>
    </div>

    <div class="big">
      <div class="en" id="lineEn">Loadingâ€¦</div>
      <div class="zh" id="lineZh">ï¼ˆè¼‰å…¥ä¸­â€¦ï¼‰</div>
    </div>

    <div class="controlsWrap"><div class="controls">
      <button class="mic" id="btnMic" aria-label="é–‹å§‹èªéŸ³è¾¨è­˜">ğŸ¤</button>
      <button class="ctrlBtn" id="btnType"><span aria-hidden="true">âŒ¨ï¸</span><span>è¼¸å…¥</span></button>
      <button class="ctrlBtn" id="btnSkip"><span>è·³é</span></button>
    </div><div class="row2">
      <button class="chip" id="btnHint">æç¤º</button>
      <button class="chip" id="btnSave">æ”¶è—</button>
      <button class="chip" id="btnFill">å¡«ç©ºå¼•å°</button>
    </div></div>

    <div class="card fillCard" id="fillCard">
      <div class="fillHead">
        <div class="h" id="fillTitle">ä½ çš„å›è¦†</div>
        <div class="badges">
          <span class="badge lev" id="levBadge">A1</span>
          <button class="badge" id="btnHideFill" type="button">éš±è—</button>
        </div>
      </div>
      <div class="fillEn" id="fillEn">Can I get a ____ , please?</div>
      <div class="fillHint" id="fillHint">å…ˆç”¨ã€Œå¡«ç©ºã€å®Œæˆä¸€å¥ï¼Œå†æ”¹æˆä½ è‡ªå·±çš„èªªæ³•ã€‚</div>
      <div class="fillRow">
        <input class="inp" id="fillInput" placeholder="å¡«å…¥ç©ºæ ¼â€¦"/>
      </div>
      <div class="fillRow" style="margin-top:10px">
        <button class="primary" id="btnSendFill">âœ… é€å‡ºå¡«å¥½å¥</button>
        <button class="ghost" id="btnFillReset">é‡ä¾†</button>
      </div>
    </div>
  </div>
<div class="bottomPanel" id="bottomPanel" aria-label="ä»»å‹™èˆ‡åƒè€ƒ">
  <div class="bpRow">
    <div class="bpTitle">ä»»å‹™</div>
</div>

<div class="toast" id="toast"></div>

<!-- picker modal -->
<div class="modalMask" id="mask" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="é¸æ“‡æƒ…å¢ƒ">
    <div class="modalTop">
      <div class="t">é¸æ“‡æƒ…å¢ƒï¼ˆä¾é€±æ¨å‡ºï¼‰</div>
      <button class="btnIcon" id="btnClose" aria-label="é—œé–‰">âœ•</button>
    </div>
    <div class="modalBody" id="modalBody"></div>
  </div>
</div>







<!-- ===== Learning Report Modal (LOCKED) ===== -->
<div id="bwReportMask" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:9999">
  <div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
              width:min(92vw,420px);background:#fff;border-radius:22px;padding:18px 18px 16px;">
    <div style="text-align:center;font-size:20px;font-weight:700;margin-top:4px">
      <span style="font-size:28px">â­ â­ â­</span><br/>å¾ˆæ£’!
    </div>
    <div style="text-align:center;color:#666;margin:6px 0 10px">è²·ä¸€æ¯å’–å•¡</div>
    <div style="display:flex;gap:10px;justify-content:space-between;margin:10px 0">
      <div style="flex:1;text-align:center"><b id="rActive">50%</b><div style="color:#777;font-size:12px">ä¸»å‹•ç·´ç¿’</div></div>
      <div style="flex:1;text-align:center"><b id="rPron">53%</b><div style="color:#777;font-size:12px">ç™¼éŸ³</div></div>
      <div style="flex:1;text-align:center"><b id="rWords">116</b><div style="color:#777;font-size:12px">å–®å­—æ•¸</div></div>
    </div>
    <div style="text-align:center;margin:6px 0 14px">
      <div style="font-size:12px;color:#777">å®Œæ•´åº¦</div>
      <div style="font-size:28px;font-weight:700" id="rComplete">65</div>
    </div>
    <div style="display:flex;gap:10px">
      <button onclick="closeReport()" style="flex:1;border-radius:14px;border:1px solid #e5e7eb;padding:10px;background:#fff">é—œé–‰</button>
      <button onclick="closeReport()" style="flex:1;border-radius:14px;border:none;padding:10px;background:#2563eb;color:#fff">ç¹¼çºŒ</button>
    </div>
  </div>
</div>

<!-- ===== End Learning Report ===== -->





<!-- ===== BW TALK SCORE â†’ DASHBOARD BRIDGE (LOCKED) ===== -->

<!-- ===== /BW TALK SCORE â†’ DASHBOARD BRIDGE ===== -->


<script>
/* =========================================================
   BookWide Talk â€” SLIM Rebuild (single script, mobile-friendly)
   - Keep DOM/layout as-is
   - Fix: no duplicate declarations, no fallback-to-week1 illusions
   - Core features:
     A) Cloze generator + btnFill cycles L1->L2->L3
     B) Score on btnSendFill, store to localStorage + optional bridge
     C) Auto difficulty by lesson.mode (core/variation/challenge)
   ========================================================= */

(() => {
  'use strict';

  /* ---------- Config ---------- */
  const SUPABASE_URL = 'https://jeajrwpmrgczimmrflxo.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do';
  const ADMIN_EMAILS = new Set(['pmktools@gmail.com']); // admin always pass

  // Try these bases for index.json & scene json
  const BASES = [
    './EduEnglish/talk/',
    '/EduEnglish/talk/',
    './talk/',
    '/talk/',
    './'
  ];

  /* ---------- DOM helpers ---------- */
  const $ = (sel) => document.querySelector(sel);
  const el = {
    weekLabel: $('#weekLabel'),
    sceneTitle: $('#sceneTitle'),
    sceneSub: $('#sceneSub'),
    lineEn: $('#lineEn'),
    lineZh: $('#lineZh'),
    levBadge: $('#levBadge'),

    btnFill: $('#btnFill'),
    btnHint: $('#btnHint'),
    btnFillReset: $('#btnFillReset'),
    btnSendFill: $('#btnSendFill'),
    btnHideFill: $('#btnHideFill'),

    fillEn: $('#fillEn'),
    fillHint: $('#fillHint'),
    fillInput: $('#fillInput'),

    toast: $('#toast'),
    selTeacher: $('#selTeacher'),
    btnReplay: $('#btnReplay'),
  };

  function toast(msg, ms=1600){
    if(!el.toast) return;
    el.toast.textContent = msg;
    el.toast.classList.add('show');
    setTimeout(()=>el.toast && el.toast.classList.remove('show'), ms);
  }

  /* ---------- URL params ---------- */
  const params = new URLSearchParams(location.search);
  const paramWeek = params.get('week'); // optional
  const paramScene = params.get('scene'); // may be scene id or short scene name
  const safeInt = (v) => {
    const n = Number(String(v||'').trim());
    return Number.isFinite(n) ? Math.max(1, Math.floor(n)) : null;
  };

  /* ---------- Fetch helpers ---------- */
  async function fetchJson(url){
    const r = await fetch(url, { cache: 'no-store' });
    if(!r.ok) throw new Error(`${r.status} ${url}`);
    return await r.json();
  }
  async function fetchFirst(urls){
    let lastErr;
    for(const u of urls){
      try { return await fetchJson(u); }
      catch(e){ lastErr = e; }
    }
    throw lastErr || new Error('fetchFirst failed');
  }

  async function loadIndex(){
    const urls = BASES.map(b => b + 'index.json');
    return await fetchFirst(urls);
  }

  async function loadLesson(sceneId){
    const file = sceneId.endsWith('.json') ? sceneId : `${sceneId}.json`;
    const urls = BASES.map(b => b + file);
    return await fetchFirst(urls);
  }

  /* ---------- Guard (fail-closed only when Supabase works) ---------- */
  async function guardSubscription(){
    // If supabase-js not loaded, don't block (avoid bricking)
    if(!window.supabase || !window.supabase.createClient) return { ok: true, reason: 'no-supabase-js' };
    if(!SUPABASE_ANON_KEY || false) {
      return { ok: true, reason: 'no-anon-key' };
    }
    try{
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const { data: sdata } = await supabase.auth.getSession();
      const session = sdata?.session;
      if(!session?.user){
        // not logged in -> redirect
        location.href = '/account/login.html?next=' + encodeURIComponent(location.pathname + location.search);
        return { ok: false, reason: 'no-session' };
      }

      const user = session.user;
      const uid = user.id;
      const email = (user.email || '').toLowerCase();

      if(ADMIN_EMAILS.has(email)) return { ok: true, reason: 'admin' };

      const todayStr = new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Taipei' });

      // profiles: best effort
      const { data: prof } = await supabase
        .from('profiles')
        .select('id, expires_at, is_paused')
        .eq('id', uid)
        .maybeSingle();

      const paused = !!(prof && prof.is_paused);
      const pexp = prof?.expires_at ? String(prof.expires_at).slice(0,10) : '';

      // orders fallback
      let oexp = '';
      let hasPaid = false;
      try{
        const r1 = await supabase
          .from('orders')
          .select('status,expires_at,created_at')
          .eq('user_id', uid)
          .order('created_at', { ascending:false })
          .limit(1);

        const row1 = (!r1.error && r1.data && r1.data[0]) ? r1.data[0] : null;

        if(row1){
          hasPaid = String(row1.status||'').toLowerCase() === 'paid';
          oexp = row1.expires_at ? String(row1.expires_at).slice(0,10) : '';
        } else if(email){
          const r2 = await supabase
            .from('orders')
            .select('status,expires_at,created_at')
            .eq('email', email)
            .order('created_at', { ascending:false })
            .limit(1);
          const row2 = (!r2.error && r2.data && r2.data[0]) ? r2.data[0] : null;
          if(row2){
            hasPaid = String(row2.status||'').toLowerCase() === 'paid';
            oexp = row2.expires_at ? String(row2.expires_at).slice(0,10) : '';
          }
        }
      }catch(_){ /* ignore */ }

      const okPaid = hasPaid && !pexp && !oexp; // paid but missing expires -> allow
      const ok = (!paused) && (okPaid || (pexp && pexp >= todayStr) || (oexp && oexp >= todayStr));

      if(!ok){
        location.href = '/pricing.html';
        return { ok: false, reason: 'no-subscription' };
      }
      return { ok: true, reason: 'ok' };
    }catch(e){
      // fail-open to avoid locking everyone if RLS or net issues
      console.warn('[guard] fail-open:', e);
      return { ok: true, reason: 'guard-error' };
    }
  }

  /* ---------- Voices ---------- */
  const VOICES = {
    DIANA: { voice: 'en-US-AnaNeural', lang: 'en-US' },
    EMMA:  { voice: 'en-US-AriaNeural', lang: 'en-US' },
    SOPHIA:{ voice: 'en-AU-NatashaNeural', lang: 'en-AU' }
  };

  function speak(text){
    if(!text) return;
    try{
      const utter = new SpeechSynthesisUtterance(text);
      const pick = (el.selTeacher && el.selTeacher.value) ? el.selTeacher.value.toUpperCase() : 'SOPHIA';
      const v = VOICES[pick] || VOICES.SOPHIA;
      utter.lang = v.lang;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    }catch(e){
      console.warn('speak failed', e);
    }
  }

  /* ---------- Cloze engine ---------- */
  const STOP = new Set([
    "a","an","the","and","or","but","so","because","if","when","while","though","although",
    "to","of","in","on","at","for","from","with","by","about","as","into","over","under","between","through",
    "is","am","are","was","were","be","been","being","do","does","did","have","has","had",
    "will","would","can","could","may","might","shall","should","must",
    "i","you","he","she","it","we","they","me","him","her","us","them","my","your","his","her","its","our","their",
    "this","that","these","those","here","there","please","thanks","thank",
    "not","no","yes","okay","ok","well","just","very","really","maybe"
  ]);

  function normKeywords(arr){
    if(!Array.isArray(arr)) return [];
    return arr.map(x=>String(x||'').trim().toLowerCase()).filter(Boolean);
  }

  function tokenize(s){
    const re = /([A-Za-z][A-Za-z'-]*|\d+|[^\w\s]+|\s+)/g;
    const out = [];
    let m;
    while((m=re.exec(s))!==null) out.push({t:m[0], i:out.length});
    return out;
  }

  function pickCandidates(tokens, kws){
    const cand=[];
    for(let i=0;i<tokens.length;i++){
      const raw=tokens[i].t;
      if(!/^[A-Za-z][A-Za-z'-]*$/.test(raw)) continue;
      const w=raw.toLowerCase().replace(/^[^a-z]+|[^a-z]+$/g,'');
      if(!w || STOP.has(w) || w.length<4) continue;
      let score=0;
      if(kws.includes(w)) score+=100;
      if (/(ing|ed|tion|sion|ment|able|ible|ness|ship|ive|ize|ise|ally)$/.test(w)) score+=8;
      if (/(check|change|fix|refund|resched|confirm|cancel|book|order|pay|charge|upgrade|downgrade|replace|return|deliver|report|recommend|explain|describe|help|need|want|prefer|request|suggest)/.test(w)) score+=12;
      score += Math.min(10, w.length-3);
      cand.push({idx:i, word:raw, norm:w, score});
    }
    cand.sort((a,b)=>(b.score-a.score)||(a.idx-b.idx));
    return cand;
  }

  function applyBlanks(tokens, picks){
    const pickSet=new Set(picks.map(p=>p.idx));
    const answers=[];
    let n=1;
    const out=tokens.map((tok, ti)=>{
      if(!pickSet.has(ti)) return tok.t;
      const ans=tok.t;
      answers.push({no:n++, answer: ans});
      const len=Math.max(4, Math.min(10, ans.replace(/[^A-Za-z]/g,'').length));
      return "_".repeat(len);
    });
    return { cloze: out.join(''), answers };
  }

  function makeCloze(sentence, level, keywords){
    const s=String(sentence||'').trim();
    const kws=normKeywords(keywords);
    if(!s) return { cloze:'', answers:[], meta:{level, reason:'empty'} };

    // Level 3: task prompt style (no blanks)
    if(level===3){
      const prompt = keywords?.length ? `Try to use: ${keywords.join(', ')}` : `Try to respond politely in 1â€“2 sentences.`;
      return { cloze: prompt, answers:[], meta:{level, prompt:true} };
    }

    const tokens=tokenize(s);
    const cand=pickCandidates(tokens, kws);
    const wordCount=tokens.filter(t=>/^[A-Za-z][A-Za-z'-]*$/.test(t.t)).length;

    const maxBlanks = (level===2) ? (wordCount>=10 ? 4 : 3) : (wordCount>=12 ? 3 : 2);

    const picks=[];
    for(const c of cand){
      if(picks.length>=maxBlanks) break;
      if(picks.some(p=>Math.abs(p.idx-c.idx)<=2)) continue;
      picks.push(c);
    }
    if(!picks.length && cand.length) picks.push(cand[0]);
    const {cloze, answers}=applyBlanks(tokens, picks);
    return { cloze, answers, meta:{level, blanks:answers.length} };
  }

  function getStudentSentence(lesson){
    const turns = lesson?.turns;
    if(Array.isArray(turns)){
      for(let i=turns.length-1;i>=0;i--){
        if(turns[i]?.role==='student' && turns[i]?.en) return String(turns[i].en);
      }
    }
    // fallback to task.hint or any teacher line
    if(lesson?.task?.hint) return String(lesson.task.hint);
    if(Array.isArray(turns)){
      for(let i=turns.length-1;i>=0;i--){
        if(turns[i]?.en) return String(turns[i].en);
      }
    }
    return '';
  }

  /* ---------- Scoring ---------- */
  function normalizeAnswer(s){
    return String(s||'')
      .toLowerCase()
      .replace(/[^a-z0-9\s'-]/g,' ')
      .replace(/\s+/g,' ')
      .trim();
  }

  function scoreFill(userInput, answers){
    if(!answers?.length) return { got:0, total:0, pct:0 };
    const expect = answers.map(a=>normalizeAnswer(a.answer));
    const u = normalizeAnswer(userInput);
    // accept either: user types full sentence OR only missing words
    const tokens = u.split(' ').filter(Boolean);

    // try match missing-words-only: compare tokens with expect
    let got1=0;
    for(let i=0;i<expect.length;i++){
      if(tokens[i] && tokens[i] === expect[i]) got1++;
    }
    // try match full-sentence: ensure each expected word appears somewhere (order-agnostic)
    const set = new Set(tokens);
    let got2=0;
    for(const e of expect){ if(set.has(e)) got2++; }

    const got = Math.max(got1, got2);
    const total = expect.length;
    const pct = total ? Math.round(got*100/total) : 0;
    return { got, total, pct };
  }

  function saveScore(sceneId, pct){
    try{
      const key='BW_TALK_SCORES_V1';
      const db = JSON.parse(localStorage.getItem(key)||'{}');
      db[sceneId] = { pct, ts: Date.now() };
      localStorage.setItem(key, JSON.stringify(db));
      // Optional bridge hook (if your dashboard listens to this)
      window.dispatchEvent(new CustomEvent('BW_TALK_SCORE', { detail:{ sceneId, pct }}));
    }catch(e){}
  }

  /* ---------- App state ---------- */
  let indexData = null;
  let sceneId = null;
  let lesson = null;
  let level = 1;              // current cloze level for btnFill cycling
  let lastSentence = '';
  let lastAnswers = [];

  function modeToLevel(mode){
    const m = String(mode||'').toLowerCase();
    if(m==='variation') return 2;
    if(m==='challenge') return 3;
    return 1; // core/default
  }

  function setHeaderFromLesson(lesson){
    const wk = lesson?.week ? `W${String(lesson.week).padStart(2,'0')}` : 'W??';
    if(el.weekLabel) el.weekLabel.textContent = wk;
    if(el.sceneTitle) el.sceneTitle.textContent = lesson?.title || 'Talk';
    if(el.sceneSub) el.sceneSub.textContent = lesson?.id || '';
    if(el.levBadge) el.levBadge.textContent = (lesson?.level || 'A1');
  }

  function setTeacherLineFromLesson(lesson){
    const firstTeacher = Array.isArray(lesson?.turns) ? lesson.turns.find(t=>t?.role==='teacher') : null;
    if(el.lineEn) el.lineEn.textContent = firstTeacher?.en || '';
    if(el.lineZh) el.lineZh.textContent = firstTeacher?.zh || '';
  }

  function renderCloze(forceLevel=null){
    if(!lesson) return;
    const auto = modeToLevel(lesson.mode);
    if(forceLevel==null){
      // initial render uses auto
      level = auto;
    } else {
      level = forceLevel;
    }

    lastSentence = getStudentSentence(lesson);
    const res = makeCloze(lastSentence, level, lesson?.task?.keywords || []);

    lastAnswers = res.answers || [];

    if(el.fillEn) el.fillEn.textContent = res.cloze || '';
    if(el.fillInput) el.fillInput.value = '';
    if(el.fillHint){
      if(level===3){
        el.fillHint.textContent = 'Challengeï¼šçœ‹æç¤ºï¼Œè‡ªè¡Œèªªå‡ºå®Œæ•´å¥ï¼ˆå¯ç”¨ã€Œæç¤ºã€çœ‹å»ºè­°å¥ï¼‰ã€‚';
      } else {
        el.fillHint.textContent = `åŠå¡«ç©º L${level}ï¼šåœ¨ä¸‹æ–¹è¼¸å…¥ç©ºæ ¼å…§å®¹ï¼ˆå¯åªè¼¸å…¥ç¼ºå­—ï¼Œç©ºæ ¼ç”¨ç©ºç™½åˆ†éš”ï¼‰ã€‚`;
      }
    }
  }

  function showHintFull(){
    if(!lesson) return;
    if(level===3){
      const hint = lesson?.task?.hint || 'Try to respond politely in 1â€“2 sentences.';
      toast('æç¤ºï¼šå·²é¡¯ç¤ºä»»å‹™æç¤º');
      if(el.fillEn) el.fillEn.textContent = hint;
      return;
    }
    const full = lastSentence || getStudentSentence(lesson);
    if(el.fillEn) el.fillEn.textContent = full;
    toast('æç¤ºï¼šé¡¯ç¤ºå®Œæ•´å¥');
  }

  function cycleLevel(){
    // L1 -> L2 -> L3 -> L1
    const next = (level===1) ? 2 : (level===2 ? 3 : 1);
    renderCloze(next);
    toast(`å¡«ç©ºå¼•å°ï¼šL${next}`);
  }

  /* ---------- Scene resolution ---------- */
  function sceneFromIndexByWeekAndShortScene(indexData, weekN, shortScene){
    // If paramScene is "coffee_shop" style, pick the week's core by scene match
    if(!indexData?.scenes) return null;
    const wk = String(weekN).padStart(2,'0');
    const prefix = `w${wk}.`;
    const list = indexData.scenes.filter(s => String(s.id||'').startsWith(prefix));
    // try exact contains .<shortScene>
    const hit = list.find(s => String(s.id).includes(`.${shortScene}`));
    return hit?.id || list[0]?.id || null;
  }

  async function initScene(){
    // Determine sceneId:
    // 1) if scene param looks like full id (contains '.')
    // 2) else if week given, map short scene via index
    // 3) else default to latest unlocked week core (index last of list)
    sceneId = null;

    indexData = await loadIndex();

    const scenes = Array.isArray(indexData?.scenes) ? indexData.scenes : [];
    // unlockedWeek: last week number in index (assume index ordered)
    let unlockedWeek = 1;
    for(let i=scenes.length-1;i>=0;i--){
      const m = String(scenes[i].id||'').match(/^w(\d{2})\./);
      if(m){ unlockedWeek = parseInt(m[1],10); break; }
    }

    // choose week
    let weekN = safeInt(paramWeek);
    if(!weekN) weekN = unlockedWeek;
    weekN = Math.min(weekN, unlockedWeek);

    if(paramScene){
      if(paramScene.includes('.')) {
        sceneId = paramScene;
      } else {
        sceneId = sceneFromIndexByWeekAndShortScene(indexData, weekN, paramScene);
      }
    }

    if(!sceneId){
      // default: weekN core
      const wk = String(weekN).padStart(2,'0');
      const core = scenes.find(s => String(s.id||'').startsWith(`w${wk}.core.`));
      sceneId = core?.id || scenes[0]?.id || 'w01.core.coffee_shop';
    }

    lesson = await loadLesson(sceneId);
  }

  /* ---------- Wire buttons ---------- */
  function bindUI(){
    if(el.btnFill) el.btnFill.addEventListener('click', cycleLevel);
    if(el.btnFillReset) el.btnFillReset.addEventListener('click', () => renderCloze(level));
    if(el.btnHint) el.btnHint.addEventListener('click', showHintFull);

    if(el.btnSendFill) el.btnSendFill.addEventListener('click', () => {
      if(!lesson) return;
      const input = el.fillInput ? el.fillInput.value : '';
      const { got, total, pct } = scoreFill(input, lastAnswers);
      if(total===0){
        toast('æ­¤é¡Œç‚ºæç¤ºå¼ï¼ˆç„¡æŒ–ç©ºï¼‰');
        return;
      }
      toast(`å¾—åˆ† ${got}/${total} Â· ${pct}%`);
      saveScore(sceneId, pct);
    });

    if(el.btnHideFill){
      el.btnHideFill.addEventListener('click', () => {
        const box = $('#fillCard');
        if(!box) return;
        const isHidden = box.style.display === 'none';
        box.style.display = isHidden ? '' : 'none';
        el.btnHideFill.textContent = isHidden ? 'éš±è—' : 'é¡¯ç¤º';
      });
    }

    if(el.btnReplay){
      el.btnReplay.addEventListener('click', () => {
        const t = (el.lineEn && el.lineEn.textContent) ? el.lineEn.textContent : '';
        speak(t);
      });
    }

    // Teacher select -> replay current line
    if(el.selTeacher){
      el.selTeacher.addEventListener('change', () => {
        const t = (el.lineEn && el.lineEn.textContent) ? el.lineEn.textContent : '';
        if(t) speak(t);
      });
    }
  }

  /* ---------- Boot ---------- */
  (async () => {
    await guardSubscription(); // may redirect
    bindUI();
    try{
      await initScene();
      setHeaderFromLesson(lesson);
      setTeacherLineFromLesson(lesson);
      renderCloze(null); // auto by mode
      // speak teacher first line on load (optional)
      // speak(el.lineEn?.textContent || '');
    }catch(e){
      console.error('[Talk slim] init failed:', e);
      toast('è¼‰å…¥å¤±æ•—ï¼šè«‹ç¢ºèª index.json / é€±æ¬¡ json è·¯å¾‘');
      if(el.sceneTitle) el.sceneTitle.textContent = 'Load failed';
      if(el.sceneSub) el.sceneSub.textContent = String(e?.message || e);
    }
  })();

})();
</script>

</body>
</html>
