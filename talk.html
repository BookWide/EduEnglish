<!doctype html>
<html lang="zh-Hant">
<head>

<script id="bw-mobile-lite-global">

/* === FETCH TIMEOUT PATCH v1 === */
async function fetchWithTimeout(url, opts={}, ms=9000){
  const controller = new AbortController();
  const id = setTimeout(()=>controller.abort(), ms);
  try{
    const res = await fetch(url, Object.assign({cache:"no-store", signal: controller.signal}, opts||{}));
    return res;
  } finally {
    clearTimeout(id);
  }
}
/* === end FETCH TIMEOUT PATCH v1 === */


  window.MOBILE_LITE = !!(window.matchMedia && window.matchMedia("(max-width:520px)").matches);

  var MOBILE_LITE = window.MOBILE_LITE;
  try{ if(MOBILE_LITE) document.documentElement.classList.add("mobileLite"); }catch(_e){}
</script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>

  const SUPABASE_URL = 'https://jeajrwpmrgczimmrflxo.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do';
  window.SUPABASE_URL = SUPABASE_URL;
  window.SUPABASE_ANON_KEY = SUPABASE_ANON_KEY;
</script>
<script>
(async function() {

try{ if(MOBILE_LITE) document.documentElement.classList.add("mobileLite"); }catch(_e){}

  try {
    const SUPABASE_URL = window.SUPABASE_URL;
    const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY;
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });

    const { data: sess } = await supabase.auth.getSession();
    const session = sess && sess.session;
    if (!session || !session.user) {
      const red = encodeURIComponent(location.pathname + location.search + location.hash);
      location.replace('/account/login.html?redirect=' + red);
      return;
    }

    const user = session.user;
    const uid = user.id;
    const email = (user.email || '').toLowerCase();

    const today = new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Taipei' });

    const { data: prof, error: perr } = await supabase
      .from('profiles')
      .select('id, expires_at, is_paused')
      .eq('id', uid)
      .maybeSingle();

    const paused = !!(prof && prof.is_paused);
    const pexp = prof && prof.expires_at ? String(prof.expires_at).slice(0,10) : '';

    let oexp = '';
    let opaid = '';
    let ocreated = '';
    let hasPaid = false;
    try {

      const r1 = await supabase
        .from('orders')
        .select('status,expires_at,paid_at,created_at')
        .eq('user_id', uid)
        .order('created_at', { ascending:false })
        .limit(1);
      if (!r1.error && r1.data && r1.data.length) {
        const row = r1.data[0];
        if (row?.status) hasPaid = String(row.status).toLowerCase() === 'paid';
        if (row?.expires_at) oexp = String(row.expires_at).slice(0,10);
        if (row?.paid_at) opaid = String(row.paid_at);
        if (row?.created_at) ocreated = String(row.created_at);
      } else {

        const r2 = await supabase
          .from('orders')
          .select('status,expires_at,paid_at,created_at')
          .eq('email', email)
          .order('created_at', { ascending:false })
          .limit(1);
        if (!r2.error && r2.data && r2.data.length) {
          const row = r2.data[0];
          if (row?.status) hasPaid = String(row.status).toLowerCase() === 'paid';
          if (row?.expires_at) oexp = String(row.expires_at).slice(0,10);
          if (row?.paid_at) opaid = String(row.paid_at);
          if (row?.created_at) ocreated = String(row.created_at);
        }
      }
    } catch (e) {}

const today_sub = new Date().toISOString().slice(0,10);

let ok = (!paused) && (
  (pexp && pexp >= today) ||
  (oexp && oexp >= today)
);

if (!ok && hasPaid) {
  const base = (opaid || ocreated || '').slice(0,10);
  if (base) {
    const t0 = new Date(base + 'T00:00:00Z').getTime();
    const t1 = Date.now();
    const days = (t1 - t0) / 86400000;
    if (days >= 0 && days <= 400) ok = true;
  } else {
    ok = true;
  }
}
window.BW_SUB_OK = ok;
    window.BW_SUB_EXPIRES_AT = (pexp && pexp >= today) ? pexp : (oexp || null);
    window.BW_PROFILE_OK = !perr;

    if (!ok) {
      location.replace('/account/subscription.html');
      return;
    }
  } catch (e) {
    location.replace('/account/subscription.html?err=guard');
  }
})();
</script>

<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>TalkÔºàÊØèÈÄ±Âè£Ë™™ÔºâÔΩúBookWide</title>
<style>

:root{
  --bg:#f4f6fb; --card:#fff; --ink:#0b1220; --muted:#5b667a; --line:#e6eaf0;
  --shadow:0 10px 28px rgba(10,20,40,.10); --r:18px; --r2:24px;
  --brand:#0b66ff; --brand2:#084fc6; --soft:#f6f8fb;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
  background:var(--bg); color:var(--ink);
  overscroll-behavior: none;
  padding-bottom:18px;
}
a{color:inherit}
.wrap{max-width:980px; margin:0 auto; padding:14px 14px 24px}
.card{background:var(--card); border:1px solid var(--line); border-radius:var(--r2); box-shadow:var(--shadow)}
.topbar{padding:14px; display:flex; gap:10px; align-items:center; justify-content:space-between}
.leftTop{display:flex; align-items:center; gap:12px}
.btnIcon{
  width:44px; height:44px; border-radius:999px; border:1px solid var(--line);
  background:#fff; display:grid; place-items:center; box-shadow:0 6px 18px rgba(10,20,40,.08);
}
.brandTitle{font-weight:800; font-size:22px; line-height:1}
.sub{font-size:12px; color:var(--muted); margin-top:4px}
.rightTop{display:flex; gap:10px; align-items:center}
.smallBtn{
  border:1px solid var(--line); background:#fff; border-radius:999px; padding:10px 12px;
  font-weight:700; color:var(--brand2); box-shadow:0 6px 18px rgba(10,20,40,.08);
}
.smallBtn:active{transform:translateY(1px)}
.pill{
  border:1px solid var(--line); background:#fff; border-radius:999px; padding:10px 12px;
  display:flex; align-items:center; gap:8px; font-weight:800;
}
.pill select{border:none;background:transparent;font:inherit;color:inherit;outline:none;padding:0 2px;}
.pill .meta{margin-right:6px;opacity:.75;font-size:12px;}
.pill .meta{font-size:12px; color:var(--muted); font-weight:700}
.grid{display:grid; grid-template-columns:1fr; gap:14px; padding:14px}
.hero{padding:14px}
.heroRow{display:flex; gap:14px; align-items:center}
.avatar{
  width:92px; height:92px; border-radius:999px;
  border:1px solid var(--line);
  background: radial-gradient(circle at 30% 30%, #ffffff 0%, #eef3ff 40%, #e8eefb 100%);
  box-shadow:inset 0 0 0 10px rgba(255,255,255,.6);
  position:relative; flex:0 0 auto;
}
  .avatar{ position:relative; overflow:hidden; }
  .teacherMedia{ width:100%; height:100%; object-fit:cover; border-radius:999px; display:block; }

.dot{position:absolute; left:12px; top:14px; width:12px; height:12px; border-radius:999px; background:#22c55e; box-shadow:0 0 0 4px rgba(34,197,94,.15)}
.heroText{min-width:0}
.sceneTitle{font-weight:900; font-size:16px}
.sceneSub{color:var(--muted); font-size:12px; margin-top:4px}
.big{
  padding:16px; border-radius:var(--r2); border:1px solid var(--line);
  background:var(--soft);
}
.big .en{font-size:34px; font-weight:900; letter-spacing:.2px}
.big .zh{margin-top:10px; font-size:15px; color:var(--muted)}
.controls{
  display:grid; grid-template-columns:86px 1fr 1fr; gap:12px; align-items:center;
}
.mic{
  width:86px; height:86px; border-radius:999px; border:none;
  background:linear-gradient(180deg,var(--brand) 0%, var(--brand2) 100%);
  color:#fff; font-size:28px; font-weight:900;
  box-shadow:0 16px 40px rgba(11,102,255,.35);
}
.ctrlBtn{
  height:52px; border-radius:999px; border:1px solid var(--line);
  background:#fff; font-weight:900; font-size:18px; color:var(--brand2);
  display:flex; align-items:center; justify-content:center; gap:10px;
  box-shadow:0 10px 24px rgba(10,20,40,.08);
}
.ctrlBtn small{font-size:14px; color:var(--muted); font-weight:800}
.row2{display:flex; gap:10px; flex-wrap:wrap}
.chip{
  border:1px solid var(--line); border-radius:999px; background:#fff;
  padding:10px 12px; font-weight:900; color:var(--ink);
}
.chip.on{background:#0b1220; color:#fff; border-color:#0b1220}
.fillCard{padding:14px}
.fillHead{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px}
.fillHead .h{font-weight:900; font-size:18px}
.badges{display:flex; gap:10px; align-items:center}
.badge{
  border:1px solid var(--line); border-radius:999px; padding:8px 12px; background:#fff;
  font-weight:900; color:var(--muted);
}
.badge.lev{color:#0b1220}
.fillEn{font-size:34px; font-weight:950; line-height:1.05}
.fillHint{margin-top:10px; color:var(--muted); font-weight:700}
.fillRow{display:flex; gap:10px; margin-top:14px; align-items:center}
.primary{
  height:54px; border-radius:999px; border:none;
  background:linear-gradient(180deg,var(--brand) 0%, var(--brand2) 100%);
  color:#fff; font-weight:950; padding:0 18px; font-size:18px;
  box-shadow:0 16px 40px rgba(11,102,255,.28);
}
.ghost{
  height:54px; border-radius:999px; border:1px solid var(--line); background:#fff;
  font-weight:950; padding:0 18px; font-size:18px; color:var(--brand2);
}
.inp{
  width:100%; height:54px; border-radius:16px; border:1px solid var(--line);
  padding:0 14px; font-size:18px; font-weight:800; outline:none;
  background:#fff;
}
.toast{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:18px; background:#0b1220; color:#fff; padding:10px 12px;
  border-radius:999px; font-weight:800; font-size:13px;
  box-shadow:0 18px 45px rgba(0,0,0,.25);
  max-width:min(92vw,520px); display:none;
}
.modalMask{position:fixed; inset:0; background:rgba(0,0,0,.34); display:none; align-items:flex-start; justify-content:center; padding:18px}
.modal{
  width:min(720px, 94vw);
  background:#fff; border:1px solid var(--line);
  border-radius:24px; box-shadow:0 24px 80px rgba(0,0,0,.25);
  overflow:hidden;
}
.modalTop{padding:14px 14px 10px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--line)}
.modalTop .t{font-weight:950}
.modalBody{padding:12px; max-height:70vh; overflow:auto}
.group{border:1px solid var(--line); border-radius:18px; overflow:hidden; margin-bottom:12px}
.group .gHead{padding:10px 12px; background:#f7f9ff; font-weight:950; display:flex; justify-content:space-between; align-items:center}
.group .gHead .lock{font-size:12px; color:var(--muted); font-weight:900}
.item{padding:12px; border-top:1px solid var(--line); display:flex; gap:10px; align-items:center; justify-content:space-between}
.item .name{font-weight:900}
.item .sub{margin:0; font-size:12px}
.item button{white-space:nowrap}

.fileTag{display:inline-block; margin-left:10px; font-size:12px; color:var(--muted); max-width:240px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
.bottomPanel{
  position:sticky; bottom:10px; left:auto; transform:none;
  width:100%;
  margin-top:12px;
  border:1px solid var(--line);
  border-radius:var(--r2);
  background:var(--card);
  box-shadow:0 10px 28px rgba(10,20,40,.10);
  padding:12px 14px;
  z-index:5;
}
.bpRow{display:flex; gap:10px; align-items:flex-start;}
.bpTitle{flex:0 0 auto; font-weight:800; font-size:13px; padding:4px 10px; border-radius:999px; background:var(--soft); color:var(--brand2);}
.bpBody{flex:1 1 auto; font-size:13px; color:var(--ink); line-height:1.35; min-height:22px;}
.bpLinks{margin-top:8px; display:flex; gap:10px; flex-wrap:wrap;}
.bpLink{font-size:12px; color:var(--brand2); text-decoration:none; padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:#fff;}
.bpLink:hover{background:var(--soft);}

:root{
  --card-pad:10px;
}

.wrap{padding:8px 10px 12px !important;}
.card{padding:var(--card-pad) !important; margin:8px 0 !important;}
.hr{margin:8px 0 !important;}

.topbar{padding:6px 10px !important; gap:8px !important;}
.iconBtn{width:36px !important; height:36px !important;}
.brand .t{font-size:18px !important; line-height:1.05 !important;}
.brand .s{font-size:12px !important; margin-top:1px !important; line-height:1.05 !important;}
.smallBtn{padding:6px 10px !important; border-radius:999px !important; font-size:12px !important;}

.hero{padding:10px !important;}
.heroGrid{gap:10px !important;}
.avatarWrap{width:74px !important; height:74px !important;}
.heroTitle{font-size:18px !important; margin-bottom:2px !important; line-height:1.1 !important;}
.heroSub{font-size:12px !important; line-height:1.15 !important;}
.progress{font-size:12px !important; line-height:1.15 !important;}

.big .en{font-size:24px !important; line-height:1.05 !important;}
.big .zh{margin-top:4px !important; font-size:12px !important; line-height:1.15 !important;}

.controls{margin-top:8px !important;}
.ctrlRow{gap:10px !important;}
.micBtn{width:64px !important; height:64px !important;}
.ctrlBtn{height:40px !important; padding:0 14px !important; font-size:14px !important;}
.ctrlBtn .ico{font-size:16px !important; margin-right:8px !important;}
.ctrlRow2{gap:10px !important; margin-top:8px !important;}
.pillBtn{padding:8px 14px !important; font-size:14px !important;}

.replyCard{padding:10px !important;}
.replyHead{margin-bottom:6px !important;}
.replyTitle{font-size:16px !important; line-height:1.05 !important;}
.replyDesc{font-size:11px !important; line-height:1.15 !important; margin-top:4px !important;}
.fillEn{font-size:24px !important; line-height:1.05 !important;}
.fillHint{margin-top:4px !important; font-size:11px !important; line-height:1.15 !important;}
.input{margin-top:8px !important; padding:10px 12px !important; font-size:14px !important; border-radius:16px !important;}

.fillActions{gap:10px !important; margin-top:10px !important;}
.fillSend{
  min-height:36px !important;
  padding:0 14px !important;
  font-size:14px !important;
  border-radius:18px !important;
  box-shadow:0 10px 22px rgba(37,99,235,.22) !important;
}
.fillReroll{
  min-height:36px !important;
  padding:0 14px !important;
  font-size:14px !important;
  border-radius:18px !important;
}
.fillSend .check{width:22px !important; height:22px !important; margin-right:8px !important; font-size:13px !important;}

.bottomPanel{margin-top:10px !important;}
.sheetTabs{gap:10px !important;}
.sheetTab{padding:8px 12px !important; font-size:14px !important;}
.sheet{margin-top:8px !important;}
.sheetBody{padding:10px !important;}
.taskItem{padding:10px !important; margin-bottom:8px !important;}
.taskItem .k{font-size:14px !important; margin-bottom:4px !important;}
.taskItem .v{font-size:12px !important; line-height:1.2 !important;}

.zh .jaWrap{ display:inline-flex; align-items:center; gap:4px; }
.zh .jaText{ font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif; }
.jaSpeak{
  border:0;
  background:transparent;
  padding:0 2px;
  margin-left:2px;
  font-size:12px;
  line-height:1;
  opacity:.75;
  cursor:pointer;
}
.jaSpeak:hover{ opacity:1; }

.zh-line{display:flex;gap:6px;align-items:flex-start}
.jaSpeakBtn{
  border:1px solid rgba(0,0,0,.08);
  background:#fff;
  border-radius:10px;
  padding:2px 6px;
  font-size:12px;
  line-height:1;
  cursor:pointer;
}
.jaSpeakBtn:active{transform:scale(0.98)}

@media (max-width:520px){

  .wrap{padding:10px 10px 18px}
  .topbar{padding:12px}
  .brandTitle{font-size:20px}
  .big .en{font-size:30px}
  .fillEn{font-size:30px}
  .controls{grid-template-columns:78px 1fr 1fr}
  .mic{width:78px; height:78px; font-size:26px}
  .ctrlBtn{height:50px; font-size:17px}

  .brandTitle{font-size:14px}
  .sub{font-size:10px}
  .pill .meta{font-size:10px}
  .sceneTitle{font-size:13px}
  .sceneSub{font-size:10px}
  .big .en{font-size:20px}
  .big .zh{font-size:12px}
  .micBtn{min-height:64px}
  .micBtn .label{font-size:14px}
  .ctrlBtn{min-height:44px}
  .ctrlBtn span{font-size:14px}
  .ctrlBtn small{font-size:11px}
  .fillCard{padding:12px}
  .fillHead .h{font-size:14px}
  .fillEn{font-size:20px}
  .fillHint{font-size:11px}
  .fillSend,.fillReroll{min-height:44px; font-size:14px; padding:0 14px}
  .fillInput{min-height:44px; font-size:14px}
  .chip{font-size:11px; padding:8px 10px}

  .fileTag{max-width:120px}
  .bottomPanel{bottom:8px; padding:10px 12px; border-radius:16px;}

  .wrap{padding:6px 10px 14px !important;}
  .topbar{padding:8px 10px !important; gap:8px !important;}
  .backBtn,.back{width:40px !important; height:40px !important; border-radius:14px !important;}
  .brandTitle{font-size:13px !important;}
  .sub{font-size:9px !important; margin-top:2px !important;}
  .pill{padding:6px 8px !important; gap:6px !important;}
  .pill .meta{font-size:9px !important;}
  .pill .w{font-size:12px !important;}
  .replayBtn,.btnReplay{width:44px !important; height:44px !important; font-size:12px !important;}
  .hero{padding:10px !important;}
  .avatar{width:72px !important; height:72px !important;}
  .sceneTitle{font-size:14px !important;}
  .sceneSub{font-size:10px !important;}
  .big{padding:12px !important;}
  .big .zh{margin-top:4px !important; font-size:10px !important;}
}

.controlsWrap{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
  margin-top: 6px;
  margin-bottom: 6px;
}

.controls, .row2{
  display:flex !important;
  align-items:center;
  gap:10px !important;
  margin:0 !important;
  padding:0 !important;
  box-shadow:none !important;
  background:transparent !important;
}

.mic{
  width:52px !important;
  height:52px !important;
  border-radius:50% !important;
  font-size:20px !important;
  box-shadow: 0 10px 24px rgba(15,23,42,.14) !important;
}
.ctrlBtn{
  height:40px !important;
  padding:0 14px !important;
  font-size:12px !important;
  border-radius:999px !important;
}
.ctrlBtn span{ font-size:12px !important; }

.chip{
  height:34px !important;
  padding:0 12px !important;
  font-size:12px !important;
  border-radius:999px !important;
}

.ctrlBtn:active, .chip:active, .mic:active{
  transform: translateY(1px) scale(0.98);
  filter: saturate(1.15) contrast(1.05);
  box-shadow: inset 0 0 0 3px rgba(37,99,235,.18), 0 8px 18px rgba(15,23,42,.12) !important;
}
.ctrlBtn:focus-visible, .chip:focus-visible, .mic:focus-visible{
  outline: none;
  box-shadow: 0 0 0 3px rgba(37,99,235,.22), 0 10px 24px rgba(15,23,42,.14) !important;
}

.big{ margin-bottom: 10px !important; }

:root{
  --card-pad:10px;
}

.wrap{padding:8px 10px 12px !important;}
.card{padding:var(--card-pad) !important; margin:8px 0 !important;}
.hr{margin:8px 0 !important;}

.topbar{padding:6px 10px !important; gap:8px !important;}
.iconBtn{width:36px !important; height:36px !important;}
.brand .t{font-size:18px !important; line-height:1.05 !important;}
.brand .s{font-size:12px !important; margin-top:1px !important; line-height:1.05 !important;}
.smallBtn{padding:6px 10px !important; border-radius:999px !important; font-size:12px !important;}

.hero{padding:10px !important;}
.heroGrid{gap:10px !important;}
.avatarWrap{width:74px !important; height:74px !important;}
.heroTitle{font-size:18px !important; margin-bottom:2px !important; line-height:1.1 !important;}
.heroSub{font-size:12px !important; line-height:1.15 !important;}
.progress{font-size:12px !important; line-height:1.15 !important;}

.big .en{font-size:24px !important; line-height:1.05 !important;}
.big .zh{margin-top:4px !important; font-size:12px !important; line-height:1.15 !important;}

.controls{margin-top:8px !important;}
.ctrlRow{gap:10px !important;}
.micBtn{width:64px !important; height:64px !important;}
.ctrlBtn{height:40px !important; padding:0 14px !important; font-size:14px !important;}
.ctrlBtn .ico{font-size:16px !important; margin-right:8px !important;}
.ctrlRow2{gap:10px !important; margin-top:8px !important;}
.pillBtn{padding:8px 14px !important; font-size:14px !important;}

.replyCard{padding:10px !important;}
.replyHead{margin-bottom:6px !important;}
.replyTitle{font-size:16px !important; line-height:1.05 !important;}
.replyDesc{font-size:11px !important; line-height:1.15 !important; margin-top:4px !important;}
.fillEn{font-size:24px !important; line-height:1.05 !important;}
.fillHint{margin-top:4px !important; font-size:11px !important; line-height:1.15 !important;}
.input{margin-top:8px !important; padding:10px 12px !important; font-size:14px !important; border-radius:16px !important;}

.fillActions{gap:10px !important; margin-top:10px !important;}
.fillSend{
  min-height:36px !important;
  padding:0 14px !important;
  font-size:14px !important;
  border-radius:18px !important;
  box-shadow:0 10px 22px rgba(37,99,235,.22) !important;
}
.fillReroll{
  min-height:36px !important;
  padding:0 14px !important;
  font-size:14px !important;
  border-radius:18px !important;
}
.fillSend .check{width:22px !important; height:22px !important; margin-right:8px !important; font-size:13px !important;}

.bottomPanel{margin-top:10px !important;}
.sheetTabs{gap:10px !important;}
.sheetTab{padding:8px 12px !important; font-size:14px !important;}
.sheet{margin-top:8px !important;}
.sheetBody{padding:10px !important;}
.taskItem{padding:10px !important; margin-bottom:8px !important;}
.taskItem .k{font-size:14px !important; margin-bottom:4px !important;}
.taskItem .v{font-size:12px !important; line-height:1.2 !important;}

@media (max-width:520px){

  .wrap{padding:6px 10px 14px !important;}
  .topbar{padding:8px 10px !important; gap:8px !important;}
  .backBtn,.back{width:40px !important; height:40px !important; border-radius:14px !important;}
  .brandTitle{font-size:13px !important;}
  .sub{font-size:9px !important; margin-top:2px !important;}
  .pill{padding:6px 8px !important; gap:6px !important;}
  .pill .meta{font-size:9px !important;}
  .pill .w{font-size:12px !important;}
  .replayBtn,.btnReplay{width:44px !important; height:44px !important; font-size:12px !important;}
  .hero{padding:10px !important;}
  .avatar{width:72px !important; height:72px !important;}
  .sceneTitle{font-size:14px !important;}
  .sceneSub{font-size:10px !important;}
  .big{padding:12px !important;}
  .big .zh{margin-top:4px !important; font-size:10px !important;}
}

.heroRow{align-items:flex-start}
.heroText{display:flex; flex-direction:column; gap:4px}

.aiInline{
  background:#f6f8fb;
  border:1px solid var(--line);
  border-radius:14px;
  padding:8px 10px;
}
.aiInline .en{font-size:18px !important; line-height:1.1 !important; font-weight:900}
.aiInline .zh{font-size:12px !important; line-height:1.15 !important; margin-top:4px !important; color:var(--muted)}

.sceneTitle{display:none !important}

body{line-height:1.1}
.big{display:none !important}

.ctrlBtn{height:40px !important; font-size:14px !important}
.mic{width:56px !important; height:56px !important; font-size:22px !important}

.fillEn{font-size:18px !important; line-height:1.1 !important}
.fillHint{font-size:11px !important}

.fileTag { display: none !important; }

  #bottomPanel{display:none !important;}

#sceneSub{display:none !important;}

#btnSave,#btnFill{display:none !important;}

#btnHideFill{display:none !important;}

label.pill[title="ÈÅ∏ÊìáËÄÅÂ∏´"] .meta{display:none !important;}

@media (max-width:520px){

  #scenePickLabel{
    max-width:120px;
    display:inline-block;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    vertical-align:bottom;
  }
}

@media (max-width:520px){

  #scenePickLabel{display:none !important;}

  #btnMic{
    transform: scale(0.5);
    transform-origin: left center;
  }
  #btnSendFill{
    transform: scale(0.5);
    transform-origin: left center;
  }

  #btnMic, #btnSendFill{
    margin-right:-20px;
  }
}

@media (max-width:520px){

  html,body{height:100% !important;}
  body{
    overflow:hidden !important;
    overscroll-behavior:none !important;
  }

  .wrap{padding:4px 6px 6px !important; max-width:100% !important;}
  .card{margin:6px 0 !important; box-shadow:0 6px 16px rgba(10,20,40,.06) !important;}
  .topbar{padding:6px 8px !important;}
  .btnIcon{width:34px !important; height:34px !important;}
  .brandTitle{font-size:14px !important; line-height:1 !important;}
  #subTitle{display:none !important;}

  #weekLabel{font-size:12px !important;}
  #fileTag{display:none !important;}

  label.pill{padding:6px 8px !important;}
  #selTeacher{font-size:12px !important; max-width:90px !important;}

  .grid{gap:10px !important; padding:10px !important;}
  .hero{padding:10px !important;}
  .avatar{width:64px !important; height:64px !important;}
  .aiInline{padding:6px 8px !important;}
  .aiInline .en{font-size:16px !important; line-height:1.05 !important;}
  .aiInline .zh{font-size:11px !important; margin-top:2px !important; line-height:1.1 !important;}

  .controlsWrap{gap:6px !important; margin:6px 0 !important;}
  .controls{gap:6px !important; flex-wrap:nowrap !important;}
  .ctrlBtn{
    height:32px !important;
    padding:0 10px !important;
    font-size:12px !important;
  }
  #btnMic{
    width:44px !important;
    height:44px !important;
    font-size:18px !important;
    transform:none !important;
    margin-right:0 !important;
  }

  .row2{display:none !important;}

  #fillCard{padding:10px !important;}
  .fillHead{margin-bottom:6px !important;}
  .fillHead .h{font-size:14px !important;}
  #levBadge{padding:6px 10px !important;}
  .fillEn{font-size:16px !important; line-height:1.05 !important;}
  .fillHint{font-size:10px !important; line-height:1.1 !important; margin-top:2px !important;}

  .chipsRow,.chipRow,.optRow{flex-wrap:nowrap !important; overflow:hidden !important;}
  .chip{height:28px !important; padding:0 10px !important; font-size:11px !important;}

  .inp{height:42px !important; font-size:14px !important; border-radius:14px !important;}

  #btnSendFill{
    transform:none !important;
    height:40px !important;
    padding:0 12px !important;
    font-size:13px !important;
    border-radius:16px !important;
    box-shadow:0 10px 22px rgba(11,102,255,.18) !important;
    margin-right:0 !important;
  }
  #btnFillReset{
    height:40px !important;
    padding:0 12px !important;
    font-size:13px !important;
    border-radius:16px !important;
  }

  #bottomPanel{display:none !important;}
  .toast{bottom:8px !important; font-size:12px !important; padding:8px 10px !important;}

  .wrap{max-height:100vh !important;}
  .grid{max-height:calc(100vh - 70px) !important;}
}

#sceneSub{display:block !important;}

@media (max-width:520px){

  #sceneSub{
    display:block !important;
    position:fixed;
    top:10px;
    right:10px;
    z-index:9999;
    background:rgba(255,255,255,.92);
    border:1px solid rgba(0,0,0,.08);
    border-radius:999px;
    padding:4px 8px;
    font-size:11px;
    font-weight:800;
    color:#0b1220;
    max-width:48vw;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    box-shadow:0 6px 16px rgba(10,20,40,.10);
  }
}

@media (max-width:520px){
  /* hide translations by default, but allow tap-to-show via .show-zh */
  .aiInline:not(.show-zh) .zh,
  .aiInline:not(.show-zh) .jp,
  .aiInline:not(.show-zh) .ja,
  .aiInline:not(.show-zh) .sub,
  .aiInline:not(.show-zh) .trans,
  .aiInline:not(.show-zh) [data-lang="zh"],
  .aiInline:not(.show-zh) [data-lang="ja"],
  .aiInline:not(.show-zh) [data-lang="jp"]{
    display:none !important;
  }
}
@media (max-width:520px){

  #sceneSub{
    position:static !important;
    display:block !important;
    margin:6px 0 0 0 !important;
    padding:0 !important;
    border:none !important;
    background:transparent !important;
    box-shadow:none !important;
    font-size:12px !important;
    font-weight:800 !important;
    color:#0b1220 !important;
    white-space:nowrap !important;
  }

  #sceneSub .progBadge, #sceneSub{
    opacity:0.9;
  }
}

@media (max-width:520px){

  .mobileLite *{ transition:none !important; animation:none !important; }
  .mobileLite .card{ box-shadow:none !important; }
  .mobileLite .hero{ filter:none !important; }
}

@media (max-width:520px){

  html.mobileLite .card{ box-shadow:none !important; }
  html.mobileLite .hero{ box-shadow:none !important; }
  html.mobileLite .wrap{ box-shadow:none !important; }
}

@media (max-width:520px){

  #sceneSub{display:block !important;}

  #sceneSub{
    font-size:12px !important;
    font-weight:800 !important;
    margin-top:6px !important;
    direction:rtl;
    unicode-bidi:plaintext;
    text-align:left;
    max-width:70vw;
    overflow:hidden;
    white-space:nowrap;
    text-overflow:ellipsis;
  }
}

@media (max-width:520px){

  .modal, .modalContent, #sceneModal, #scenePickerModal{ font-size:12px; }
  #sceneModal .row, #sceneModal .item, #sceneModal li,
  #scenePickerModal .row, #scenePickerModal .item, #scenePickerModal li{
    font-size:11px !important;
    line-height:1.15 !important;
  }

  #sceneModal .title, #scenePickerModal .title{ font-size:12px !important; }
  #sceneModal .sub, #scenePickerModal .sub{ font-size:10px !important; opacity:.85; }

  #sceneModal .row, #scenePickerModal .row,
  #sceneModal .item, #scenePickerModal .item{
    white-space:normal !important;
    word-break:break-all !important;
  }
}

@media (max-width:520px){

  .aiInline, #aiInline, .aiText, #aiText{ max-width:72vw; }
  .aiInline .en, #aiInline .en, .aiText .en, #aiText .en,
  #lineEnInline{
    white-space:normal !important;
    overflow:hidden !important;
    display:-webkit-box !important;
    -webkit-line-clamp:2 !important;
    -webkit-box-orient:vertical !important;
    line-height:1.12 !important;
  }
}

@media (max-width:520px){

  .ctrlRow button, .ctrlRow .ctrlBtn, .ctrlBtn, .btn, button{
    font-size: 70% !important;
  }

  .chips button, .chip, .optBtn{
    font-size: 70% !important;
    padding: 8px 10px !important;
  }
}

/* === MOBILE ZH TOGGLE v2 (tap to show) === */
@media (max-width:520px){
  .aiInline .zh{
    display:none;
    font-size:11px;
    line-height:1.1;
    color:#8a8a8a;
    margin-top:2px;
  }
  .aiInline.show-zh .zh{
    display:block;
  }
}


/* === MOBILE ZH TOGGLE OVERRIDE v2 === */
@media (max-width:520px){
  .aiInline .zh{ display:none !important; }
  .aiInline.show-zh .zh{ display:block !important; }
}


/* === MOBILE ZH/JA FONT SAFETY === */
@media (max-width:520px){
  .aiInline .zh{
    font-family: "Noto Sans TC","PingFang TC","Microsoft JhengHei","Noto Sans JP","Hiragino Kaku Gothic ProN",system-ui,-apple-system,sans-serif !important;
  }
}


/* === MOBILE EN FULL (no clamp) === */
@media (max-width:520px){
  .aiInline .en, #aiInline .en, .aiText .en, #aiText .en, #lineEnInline{
    display:block !important;
    overflow:visible !important;
    -webkit-line-clamp:unset !important;
    -webkit-box-orient:unset !important;
    white-space:normal !important;
    line-height:1.08 !important;
    font-size:13px !important;
  }
}


/* === MOBILE TRANSLATION MULTILINE === */
@media (max-width:520px){
  .aiInline .zh{
    white-space:pre-line !important;
  }
}


/* === TALK MOBILE FINAL UI SPACE PATCH v1 === */
@media (max-width:520px){
  /* give teacher bubble more width */
  .aiInline, #aiInline, .aiText, #aiText{ max-width:82vw !important; }
  /* show translations fully when expanded */
  .aiInline .zh{
    white-space:pre-line !important;
    overflow:visible !important;
    max-height:none !important;
    word-break:break-word !important;
  }
  /* shrink the mic/control row vertical whitespace (about 50%) */
  .controlsWrap{ margin-top:3px !important; margin-bottom:3px !important; gap:4px !important; }
  .controls{ gap:4px !important; }
  .mic{ width:44px !important; height:44px !important; font-size:20px !important; }
  .ctrlBtn{ height:32px !important; padding:0 10px !important; font-size:12px !important; }
  /* reduce the extra blank above controls on some layouts */
  .hero{ padding-bottom:6px !important; }
}
/* === end TALK MOBILE FINAL UI SPACE PATCH v1 === */

</style>

</head>
<body>
<div class="wrap">
  <div class="card topbar" role="banner">
    <div class="leftTop">
      <button class="btnIcon" id="btnBack" aria-label="ËøîÂõû">‚Üê</button>
      <div>
        <div class="brandTitle">Talk</div>
        <div class="sub" id="subTitle">ÊØèÈÄ±Âè£Ë™™ ¬∑ Browser Speech</div>
      </div>
    </div>
    <div class="rightTop">
      <button class="pill" id="btnPick" title="ÈÅ∏ÊìáÊú¨ÈÄ±ÊÉÖÂ¢É">
        <span id="weekLabel">W1</span>
        <span class="meta" id="scenePickLabel">ÈÅ∏ÊìáÊÉÖÂ¢É</span>
        <span aria-hidden="true">‚ñæ</span>
      </button>

        <label class="pill" title="ÈÅ∏ÊìáËÄÅÂ∏´">
          <span class="meta">Teacher</span>
          <select id="selTeacher" aria-label="Teacher">
                        <option value="Diana.mp4">Diana</option>
            <option value="Emma.mp4">Emma</option>
            <option value="Sophia.mp4">Sophia</option>
          </select>
        </label>
      <button class="smallBtn" id="btnReplay">ÈáçÊí≠</button>
      <span class="fileTag" id="fileTag"></span>
    </div>
  </div>

  <div class="card grid">
    <div class="hero card">
      <div class="heroRow">
        <div class="avatar" aria-label="AI ËÄÅÂ∏´È†≠ÂÉè">
          <video id="teacherVideo" class="teacherMedia" autoplay muted playsinline webkit-playsinline></video>
          <span class="dot" id="dotLive"></span>
        </div>
        <div class="heroText">
<div class="aiInline">
  <div class="en" id="lineEnInline">Loading‚Ä¶</div>
  <div class="zh" id="lineZhInline">ÔºàËºâÂÖ•‰∏≠‚Ä¶Ôºâ</div>
</div>

          <div class="sceneTitle" id="sceneTitle">ËºâÂÖ•‰∏≠‚Ä¶</div>
          <div class="sceneSub" id="sceneSub">Êú¨ÈÄ±Ôºö3ÔºàC/V/ChÔºâ</div>
        </div>
      </div>
    </div>

    <div class="big">
      <div class="en" id="lineEn">Loading‚Ä¶</div>
      <div class="zh" id="lineZh">ÔºàËºâÂÖ•‰∏≠‚Ä¶Ôºâ</div>
    </div>

    <div class="controlsWrap"><div class="controls">
      <button class="mic" id="btnMic" aria-label="ÈñãÂßãË™ûÈü≥Ëæ®Ë≠ò">üé§</button>
      <button class="ctrlBtn" id="btnType"><span aria-hidden="true">‚å®Ô∏è</span><span>Ëº∏ÂÖ•</span></button>
      <button class="ctrlBtn" id="btnSkip"><span>Ë∑≥ÈÅé</span></button>
      <button class="ctrlBtn" id="btnHint"><span>ÊèêÁ§∫</span></button>
    </div><div class="row2">
      <button class="chip" id="btnSave">Êî∂Ëóè</button>
      <button class="chip" id="btnFill">Â°´Á©∫ÂºïÂ∞é</button>
    </div></div>

    <div class="card fillCard" id="fillCard">
      <div class="fillHead">
        <div class="h" id="fillTitle">‰Ω†ÁöÑÂõûË¶Ü</div>
        <div class="badges">
          <span class="badge lev" id="levBadge">A1</span>
          <button class="badge" id="btnHideFill" type="button">Èö±Ëóè</button>
        </div>
      </div>
      <div class="fillEn" id="fillEn">Can I get a ____ , please?</div>
      <div class="fillHint" id="fillHint">ÂÖàÁî®„ÄåÂ°´Á©∫„ÄçÂÆåÊàê‰∏ÄÂè•ÔºåÂÜçÊîπÊàê‰Ω†Ëá™Â∑±ÁöÑË™™Ê≥ï„ÄÇ</div>
      <div class="fillRow">
        <input class="inp" id="fillInput" placeholder="Â°´ÂÖ•Á©∫Ê†º‚Ä¶"/>
      </div>
      <div class="fillRow" style="margin-top:10px">
        <button class="primary" id="btnSendFill">‚úÖ ÈÄÅÂá∫Â°´Â•ΩÂè•</button>
        <button class="ghost" id="btnFillReset">Èáç‰æÜ</button>
      </div>
    </div>
  </div>
<div class="bottomPanel" id="bottomPanel" aria-label="‰ªªÂãôËàáÂèÉËÄÉ">
  <div class="bpRow">
    <div class="bpTitle">‰ªªÂãô</div>
  </div>
</div>

<div class="toast" id="toast"></div>

<div class="modalMask" id="mask" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="ÈÅ∏ÊìáÊÉÖÂ¢É">
    <div class="modalTop">
      <div class="t">ÈÅ∏ÊìáÊÉÖÂ¢ÉÔºà‰æùÈÄ±Êé®Âá∫Ôºâ</div>
      <button class="btnIcon" id="btnClose" aria-label="ÈóúÈñâ">‚úï</button>
    </div>
    <div class="modalBody" id="modalBody"></div>
  </div>
</div>

<script>

(function(){
  const $ = (id)=>document.getElementById(id);
  const toastEl = $("toast");
  const mask = $("mask");
  const modalBody = $("modalBody");

  const __teacherVideo = document.getElementById("teacherVideo");

  const TEACHER_BASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/talk/teacher/";
  function normalizeTeacherFile(v){
    const s = String(v||"").trim();
    if(!s) return "teacher.mp4";
    if(!s.toLowerCase().endsWith(".mp4")) return s + ".mp4";
    return s;
  }
  function getTeacherFromURL(){
    const u = new URL(location.href);
    return (u.searchParams.get("teacher") || u.searchParams.get("t") || "");
  }
  function setTeacher(file){
    const f = normalizeTeacherFile(file);
    try{ localStorage.setItem("bw_teacher_file", f); }catch(_ ){}
    const el = document.getElementById("selTeacher");
    if(el) el.value = f;
    if(__teacherVideo){
      __teacherVideo.src = TEACHER_BASE_URL + encodeURIComponent(f) + "?v=" + Date.now();
      __teacherVideo.load();
    }
  }
let __tvWatch = null;

  function __tvStop(){
    try{
      if(!__teacherVideo) return;
      try{ __teacherVideo.pause(); }catch(_){}
      try{ __teacherVideo.currentTime = 0; }catch(_){}
    }catch(_){}
  }
  function __tvStart(){
    try{
      if(!__teacherVideo) return;
      __teacherVideo.loop = false;
      __teacherVideo.muted = true;
      __teacherVideo.playsInline = true;
      if(__teacherVideo.readyState >= 2){
        try{ __teacherVideo.currentTime = 0; }catch(_){}
      }
      const p = __teacherVideo.play();
      if(p && typeof p.catch === "function") p.catch(()=>{});
    }catch(_){}
  }
  try{
    if(__teacherVideo){
      __teacherVideo.loop = false;
      __teacherVideo.addEventListener("ended", __tvStop, {passive:true});
    }
  }catch(e){}

  const INDEX_URL = "/talk/index.json";
const FALLBACK_INDEX_URLS = [];

  function normalizeIndex(raw){
    try{

      if(raw && Array.isArray(raw.scenes)) return raw;

      if(raw && Array.isArray(raw.weeks)){
        const scenes = [];
        for(const w of raw.weeks){
          const wkStr = String(w?.week || "").trim();
          const wkNum = Number((wkStr.match(/(\d{1,3})/)||[])[1] || 0) || 0;
          const items = Array.isArray(w?.items) ? w.items : [];
          for(const it of items){
            const filename = String(it?.filename || it?.file || "").trim();
            const base = filename ? filename.replace(/\.json$/i,"") : String(it?.id||"").trim();
            const id = base || String(it?.id||"").trim();
            if(!id) continue;
            const slug = String(it?.slug || "").trim();
            const t = String(it?.title || it?.name || "").trim();
            const title = t || (slug ? slug.replace(/[_-]+/g," ").replace(/\b\w/g, m=>m.toUpperCase()) : id);
            scenes.push({
              id,
              title,
              week: wkNum || undefined,
              level: "",
              file: filename ? (filename.startsWith("/") ? filename : ("/talk/" + filename)) : ("/talk/" + id + ".json"),
              slug: slug || undefined,
              legacy_id: it?.id || undefined
            });
          }
        }
        return { scenes, schema: raw?.schema || "weeks_v1", source: "weeks" };
      }

      if(Array.isArray(raw)){
        return { scenes: raw.map((s)=>({
          id: s?.id || s?.scene_id || s?.key || "",
          title: s?.title || s?.name || (s?.id||""),
          level: s?.level || s?.lev || "",
          file: s?.file || s?.url || (s?.id ? ("/talk/"+String(s.id)+".json") : "")
        })).filter(x=>x.id) };
      }
      if(raw && Array.isArray(raw.items)){
        return { scenes: raw.items.map((s)=>({
          id: s?.id || s?.scene_id || s?.key || "",
          title: s?.title || s?.name || (s?.id||""),
          level: s?.level || s?.lev || "",
          file: s?.file || s?.url || (s?.id ? ("/talk/"+String(s.id)+".json") : "")
        })).filter(x=>x.id) };
      }

      return { scenes: [] };
    }catch(e){
      return { scenes: [] };
    }
  }

  const LS_START = "BW_TALK_LEARNER_START_TS";
  const LS_SAVED = "BW_TALK_SAVED_LINES";
    const fileTag = $("fileTag");
  const missionText = $("missionText");
  const lnkRole = $("lnkRole");
  const lnkDialog = $("lnkDialog");
  const lnkMeta = $("lnkMeta");
  let currentSceneJson = null;
const LS_LAST_SCENE = "BW_TALK_LAST_SCENE";

  const DAY = 24*60*60*1000;
  const MAX_WEEKS = 999;
  const ITEMS_PER_WEEK = 3;

  const weekLabel = $("weekLabel");
  const scenePickLabel = $("scenePickLabel");
  const sceneTitle = $("sceneTitle");
  const sceneSub = $("sceneSub");
  const levBadge = $("levBadge");

  const lineEn = $("lineEn");
  const lineZh = $("lineZh");

  const btnPick = $("btnPick");
  const btnClose = $("btnClose");
  const btnReplay = $("btnReplay");
  const btnMic = $("btnMic");
btnMic && btnMic.addEventListener('click', (event)=>{ try{event.preventDefault();}catch(_){ } startMicOnce(); });


  setupIOSMicFallback();
  mobileLiteVideo();
  placeProgressUnderEnglish();
    mobileFixProgressText();
  const btnType = $("btnType");
  const btnSkip = $("btnSkip");

  const btnHint = $("btnHint");
  const btnSave = $("btnSave");
  const btnFill = $("btnFill");
  const fillCard = $("fillCard");
  const fillTitle = $("fillTitle");
  const btnHideFill = $("btnHideFill");
  const fillEn = $("fillEn");
  const fillHint = $("fillHint");
  const fillInput = $("fillInput");
  const btnSendFill = $("btnSendFill");
  const btnFillReset = $("btnFillReset");
  const btnBack = $("btnBack");

  let indexData = null;
  let byWeek = new Map();
  let unlockedWeek = 1;
  let talkMode = "dialogue";
  let activeWeek = 1;
  let activeSceneId = null;
  let activeSceneTitle = "";
  let activeScene = null;
  let turns = [];
  let turnIdx = 0;
  let lastTts = null;
  let lastTtsAt = 0;

  function showToast(msg){
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toastEl.style.display="none", 1800);
  }

function mobileFixProgressText(){
  try{
    if(!window.matchMedia || !window.matchMedia("(max-width:520px)").matches) return;
    const sub = document.getElementById("sceneSub");
    if(!sub) return;
    const t = (sub.textContent||"").trim();
    const m = t.match(/(\d+\s*\/\s*\d+)/);
    if(m){
      sub.textContent = m[1].replace(/\s+/g,'');
    }

    sub.style.display = "block";
  }catch(_e){}
}

function tuneRecognitionForMobile(){/* patched: disabled for iOS stability */}


function focusNoScroll(el){
  try{
    if(!el) return;
    if(el.focus) el.focus({preventScroll:true});
  }catch(_e){
    try{ el && el.focus && el.focus(); }catch(__){}
  }
}
function lockScrollDuring(fn){
  if(!window.matchMedia || !window.matchMedia("(max-width:520px)").matches) return fn();
  const sx = window.scrollX, sy = window.scrollY;
  try{ return fn(); }
  finally{
    try{ window.scrollTo(sx, sy); }catch(_){}
    setTimeout(()=>{ try{ window.scrollTo(sx, sy); }catch(_e){} }, 0);
    setTimeout(()=>{ try{ window.scrollTo(sx, sy); }catch(_e){} }, 60);
    setTimeout(()=>{ try{ window.scrollTo(sx, sy); }catch(_e){} }, 200);
  }
}

function mobileLiteVideo(){
  try{
    if(!window.MOBILE_LITE && !(typeof MOBILE_LITE!=='undefined' && MOBILE_LITE)) return;
    const v = document.getElementById("teacherVideo");
    if(!v) return;
    v.removeAttribute("autoplay");
    v.preload = "metadata";
    try{ v.pause(); }catch(_){}

    v.addEventListener("loadeddata", ()=>{ try{ v.pause(); }catch(_){} }, {once:true});
  }catch(_e){}
}

function placeProgressUnderEnglish(){
    if(MOBILE_LITE) return;

  try{
    if(window.matchMedia && !window.matchMedia("(max-width:520px)").matches) return;
    const sub = document.getElementById("sceneSub");
    if(!sub) return;

    const ai = document.querySelector(".aiInline") || document.querySelector("#aiInline") || document.querySelector(".aiText") || document.querySelector("#aiText");
    if(!ai) return;

    if(sub.parentElement === ai) return;

    ai.appendChild(sub);
  }catch(_e){}
}

function isIOS(){
  const ua = navigator.userAgent || "";
  return /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
}
function hasSpeechRec(){
  // iPhone Safari/Chrome often exposes the API but is unreliable; disable to prevent freezes
  if(isIOS && isIOS()) return false;
  return !!(window.SpeechRecognition || window.webkitSpeechRecognition);
}
function setupIOSMicFallback(){
  try{
    const mic = document.getElementById("btnMic");
    if(!mic) return;
    if(isIOS() && !hasSpeechRec()){

      mic.title = "iPhone Safari ‰∏çÊîØÊè¥Ë™ûÈü≥Ëæ®Ë≠òÔºåÊîπÁî®ÈçµÁõ§Ëº∏ÂÖ•";
      mic.addEventListener("click", (e)=>{
        e.preventDefault();
        try{ showToast("iPhone Ë™ûÈü≥Ëæ®Ë≠ò‰∏çÊîØÊè¥ÔºöË´ãÁî®„ÄéËº∏ÂÖ•„ÄèÊàñÁõ¥Êé•ÈªûËº∏ÂÖ•Ê°Ü"); }catch(_){}
        const inp = document.getElementById("fillInput");
        if(inp) { inp.focus(); }
      }, {passive:false});

      mic.addEventListener("touchstart", (e)=>{
        e.preventDefault();
        try{ showToast("iPhone Ë™ûÈü≥Ëæ®Ë≠ò‰∏çÊîØÊè¥ÔºöË´ãÁî®„ÄéËº∏ÂÖ•„ÄèÊàñÁõ¥Êé•ÈªûËº∏ÂÖ•Ê°Ü"); }catch(_){}
        const inp = document.getElementById("fillInput");
        if(inp) { inp.focus(); }
      }, {passive:false});

      mic.style.opacity = "0.55";
    }
  }catch(_e){}
}
  function openModal(){
    mask.style.display = "flex";
    mask.setAttribute("aria-hidden","false");
  }
  function closeModal(){
    mask.style.display = "none";
    mask.setAttribute("aria-hidden","true");
  }
  function getWeekFromId(id){
    const m = String(id||"").match(/^w(\d{2})\./i);
    return m ? parseInt(m[1],10) : null;
  }
  function safeText(v){ return (v==null) ? "" : String(v); }

  async function fetchJsonAny(urls){
    let lastErr = null;
    for(const u of urls){
      try{
        const res = await fetch(u, {cache:"no-cache"});
        if(!res.ok) throw new Error("HTTP "+res.status);
        return await res.json();
      }catch(e){ lastErr = e; }
    }
    throw lastErr || new Error("fetch failed");
  }

  function getUserId(){

    try{
      return (window.BW_USER_ID || localStorage.getItem("BW_USER_ID") || "").toString();
    }catch(e){ return ""; }
  }

  const LS_ANCHOR_BASE = "BW_TALK_ANCHOR_TS_";
  const LS_EXPIRES_BASE = "BW_TALK_EXPIRES_AT_";

  const WEEK_DAYS = 7;
  const ADVANCE_WEEKS = 0.5;

  function ensureAnchorTs(){
    const uid = getUserId() || "anon";
    const k = LS_ANCHOR_BASE + uid;
    let ts = 0;
    try{ ts = Number(localStorage.getItem(k)||"0"); }catch(e){ ts = 0; }

    const expNow = (()=>{ try{ return (window.BW_SUB_EXPIRES_AT || localStorage.getItem("BW_SUB_EXPIRES_AT") || "").toString(); }catch(e){ return ""; }})();
    try{
      const expKey = LS_EXPIRES_BASE + uid;
      const expOld = localStorage.getItem(expKey) || "";
      if(expNow && !expOld) localStorage.setItem(expKey, expNow);
    }catch(_e){}

    if(!ts){
      ts = Date.now();
      try{ localStorage.setItem(k, String(ts)); }catch(e){}
    }
    return ts;
  }

  function computeUnlockedWeek(){
    const ts = ensureAnchorTs();
    const diff = Date.now() - ts;
    const weekMs = WEEK_DAYS * DAY;
    const passed = diff / weekMs;
    const w = Math.floor(passed + ADVANCE_WEEKS) + 1;
    return Math.max(1, Math.min(MAX_WEEKS, w));
  }

function normalizeTurns(raw){

    let arr = [];
    if(Array.isArray(raw)){
      arr = raw;
    }else if(raw && typeof raw === "object"){
      const pick = (k)=>{
        const v = raw[k];
        return Array.isArray(v) && v.length ? v : null;
      };
      arr = pick("turns") || pick("dialogue") || pick("lines") || pick("items") || [];

      if(!arr.length){
        const v1 = Array.isArray(raw.turns) ? raw.turns : null;
        const v2 = Array.isArray(raw.dialogue) ? raw.dialogue : null;
        const v3 = Array.isArray(raw.lines) ? raw.lines : null;
        const v4 = Array.isArray(raw.items) ? raw.items : null;
        arr = v1 || v2 || v3 || v4 || [];
      }
    }

    return (arr||[]).map(t=>{
      if(!t) return null;

      const text = (t.text ?? t.english ?? t.en ?? "").toString();
      const en = (t.en ?? t.english ?? t.text ?? '').toString().trim();
      const zh = (t.zh ?? t.tw ?? t.cn ?? t.chinese ?? '').toString().trim();

      let roleRaw = ((t.role ?? t.speaker ?? '').toString().trim()) || "";
      let role = roleRaw;
      if(!role){

        role = (!t.en && (t.hint_en || t.hint_zh)) ? "USER" : "AI";
      }else{
        const r = roleRaw.toLowerCase();
        if(r === "assistant" || r === "ai" || r === "bot" || r === "system") role = "AI";
        else if(r === "user" || r === "student" || r === "learner") role = "USER";
        else role = roleRaw;
      }

      const level = (t.level ?? t.cefr ?? raw?.meta?.level ?? raw?.meta?.cefr ?? '').toString().trim() || 'A1';
      const hint = (t.hint ?? '').toString().trim();
      const fill = (t.fill ?? t.blank ?? '').toString();
      const answer = (t.answer ?? '').toString().trim();

      return { en, zh, role, level, hint, fill, answer };
    }).filter(x=>x && x.en);
  }

  function getOverrides(){
    return { weekOverride: null, sceneOverride: null };
  }

  function currentTurn(){
    return turns[Math.max(0, Math.min(turnIdx, turns.length-1))] || {en:"",zh:"",level:"A1",hint:"",fill:"",answer:""};
  }

function extractJapanese(text){
  if(MOBILE_LITE) return "";
  if(!text) return "";
  const m = text.match(/[\u3040-\u30ff\u3400-\u9fff][\u3040-\u30ff\u3400-\u9fff\u3000-\u303f\u0020-\u007e]*/);
  return m ? m[0].trim() : "";
}

function speakJA(text){
  try{
    if(!('speechSynthesis' in window)) return;
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'ja-JP';
    u.rate = 0.95;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  }catch(e){}
}

/* === TALK MOBILE FINAL helpers v1 === */
function __stripLatin(s){ return (s||"").replace(/[A-Za-z0-9]/g,""); }
function __hasKana(s){ return /[\u3040-\u30ff]/.test(s||""); } // hiragana/katakana
function __keepZh(s){
  // keep CJK ideographs + punctuation/spaces, drop kana + latin
  let out = (s||"")
    .replace(/[\u3040-\u30ff]/g,"")  // drop kana
    .replace(/[A-Za-z0-9]/g,"")      // drop latin/digits
    .replace(/\s+/g," ")
    .trim();
  return out;
}
function __keepJa(s){
  // keep kana + CJK (kanji) + punctuation/spaces, drop latin
  let out = (s||"")
    .replace(/[A-Za-z0-9]/g,"")
    .replace(/\s+/g," ")
    .trim();
  return out;
}
function splitZhJa(raw){
  const r = (raw||"").toString().trim();
  if(!r) return { zh:"", ja:"" };

  // If already has explicit labels, keep as-is
  if(/(^|\n)\s*(‰∏≠|‰∏≠Êñá|ZH)\s*[:Ôºö]/.test(r) || /(^|\n)\s*(Êó•|Êó•Êñá|JA)\s*[:Ôºö]/.test(r)){
    // best-effort parse
    const lines = r.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    let zh="", ja="";
    for(const line of lines){
      if(/^(‰∏≠|‰∏≠Êñá|ZH)\s*[:Ôºö]/.test(line)) zh = line.replace(/^(‰∏≠|‰∏≠Êñá|ZH)\s*[:Ôºö]\s*/,"").trim();
      else if(/^(Êó•|Êó•Êñá|JA)\s*[:Ôºö]/.test(line)) ja = line.replace(/^(Êó•|Êó•Êñá|JA)\s*[:Ôºö]\s*/,"").trim();
    }
    return {zh, ja};
  }

  // Heuristic: if kana exists, split into kana-containing segments (JA) vs others (ZH)
  const parts = r.split(/\n+|\s*[ÔΩú|]+\s*|\s*\/\s*/).map(s=>s.trim()).filter(Boolean);

  let jaParts=[], zhParts=[];
  for(const p of parts){
    if(__hasKana(p)){
      const ja = __keepJa(p);
      if(ja) jaParts.push(ja);
    }else{
      const zh = __keepZh(p);
      if(zh) zhParts.push(zh);
    }
  }

  // If everything went to JA (because kanji-only), fall back to ZH as well
  if(!zhParts.length && !jaParts.length){
    const z = __keepZh(r);
    return { zh: z, ja: "" };
  }
  if(!zhParts.length){
    // also try derive a ZH line from removing latin from whole string
    const z = __keepZh(r);
    if(z) zhParts.push(z);
  }
  if(!jaParts.length && __hasKana(r)){
    const j = __keepJa(r);
    if(j) jaParts.push(j);
  }

  return {
    zh: zhParts.join(" / "),
    ja: jaParts.join(" / ")
  };
}

/* Browser TTS: always English only for teacher */
function browserSpeakEN(text){
  try{
    if(!text) return;
    if(!('speechSynthesis' in window)) return;
    const u = new SpeechSynthesisUtterance(String(text));
    u.lang = 'en-US';
    u.rate = 1.0;
    u.pitch = 1.0;
    // pick a voice if available (best-effort)
    try{
      const voices = speechSynthesis.getVoices ? speechSynthesis.getVoices() : [];
      const prefer = (voices||[]).find(v=>/en-US/i.test(v.lang||"")) || (voices||[]).find(v=>/en/i.test(v.lang||""));
      if(prefer) u.voice = prefer;
    }catch(_){}
    try{ window.speechSynthesis.cancel(); }catch(_){}
    window.speechSynthesis.speak(u);
  }catch(_){}
}
/* === end TALK MOBILE FINAL helpers v1 === */

function renderZhJa(containerEl, zhText){
  if(!containerEl) return;
  const raw = (zhText||"").toString().trim();
  if(!raw){ containerEl.textContent=""; containerEl.style.display="none"; return; }
  containerEl.style.display = "";

  // Mobile Lite: show clean zh/ja lines (no English mix), tap-to-show handled by CSS
  if(MOBILE_LITE){
    const r = splitZhJa(raw);
    const out = [];
    if(r.zh) out.push("‰∏≠Ôºö" + r.zh);
    if(r.ja) out.push("Êó•Ôºö" + r.ja);
    containerEl.style.whiteSpace = "pre-line";
    containerEl.textContent = out.length ? out.join("\n") : raw;
    return;
  }

  // Desktop: show separated lines + optional JA speak button
  containerEl.innerHTML = "";
  const r = splitZhJa(raw);
  const lines = [];
  if(r.zh) lines.push({label:"‰∏≠Ôºö", text:r.zh});
  if(r.ja) lines.push({label:"Êó•Ôºö", text:r.ja});

  if(!lines.length){
    const wrap = document.createElement("div");
    wrap.className = "zh-line";
    wrap.textContent = raw;
    containerEl.appendChild(wrap);
    return;
  }

  lines.forEach((ln, idx)=>{
    const wrap = document.createElement("div");
    wrap.className = "zh-line";
    const span = document.createElement("span");
    span.textContent = ln.label + ln.text;
    wrap.appendChild(span);

    // Only attach JA speak on the Japanese line
    if(ln.label.startsWith("Êó•") && ln.text){
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "jaSpeakBtn";
      btn.title = "ÊúóËÆÄÊó•Êñá";
      btn.textContent = "üîä";
      btn.addEventListener("click", (ev)=>{ ev.stopPropagation(); speakJA(ln.text); });
      wrap.appendChild(btn);
    }
    containerEl.appendChild(wrap);
  });
}

function updateUI(){
    if(MOBILE_LITE){
      const now = Date.now();
      window.__bw_lastUI = window.__bw_lastUI || 0;

      const li = document.getElementById('lineEnInline');
      const isLoading = !li || /^Loading/.test(li.textContent||'');
      if(!isLoading && (now - window.__bw_lastUI < 140)) return;
      window.__bw_lastUI = now;
    }

    if(talkMode === "dialogue"){

      let aiIdx = turnIdx;
      while(aiIdx < turns.length && turns[aiIdx]?.role === "USER") aiIdx++;
      if(aiIdx >= turns.length) aiIdx = Math.max(0, turns.length-1);
      const ai = turns[aiIdx] || {en:"‚Äî",zh:"",level:"A1",role:"AI"};
      const user = (turns[aiIdx+1] && turns[aiIdx+1].role==="USER") ? turns[aiIdx+1] : null;

      lineEn.textContent = ai.en || "‚Äî";
      const li = document.getElementById("lineEnInline"); if(li) li.textContent = ai.en || "‚Äî";
      renderZhJa(lineZh, ai.zh); const lz = document.getElementById("lineZhInline"); renderZhJa(lz, ai.zh);
      levBadge.textContent = ai.level || "A1";

      fillTitle.textContent = "‰Ω†ÁöÑÂõûË¶Ü";
      let expected = (user?.en || "").trim();
      let expectedSrc = "json";
      if(!expected){
        expected = synthUserFromAI(ai.en||"", activeSceneId||"");
        expectedSrc = "generated";
        console.warn("[Talk] Áº∫ USER Âª∫Ë≠∞Âè•ÔºöÂ∑≤Áî®Ë¶èÂâáÁîüÊàêÔºàË´ãË£ú JSONÔºâ", { sceneId: activeSceneId, ai: ai.en });
      }

      const cl = makeCloze(expected);

      fillEn.textContent = expected ? (cl.cloze || "Ë´ãËº∏ÂÖ•‰Ω†ÁöÑÂõûË¶Ü‚Ä¶") : "Ë´ãËº∏ÂÖ•‰Ω†ÁöÑÂõûË¶Ü‚Ä¶";
      renderFillOptions(cl);
      fillHint.textContent = "Â∞çË©±Ê®°ÂºèÔºöAI ÂÖàË™™‰∏ÄÂè•ÔºåÁ≠â‰Ω†ÂõûË¶ÜÔºàË™ûÈü≥ÊàñËº∏ÂÖ•ÔºâÊâçÊúÉÈÄ≤‰∏ã‰∏ÄÂè•„ÄÇÊåâ„ÄåÊèêÁ§∫„ÄçÂèØÈ°ØÁ§∫ÂÆåÊï¥Âª∫Ë≠∞Âè•„ÄÇ" + (expectedSrc==="generated" ? "  ‚ö† Áº∫ USER Âª∫Ë≠∞Âè•ÔºöÂ∑≤Áî®Ë¶èÂâáÁîüÊàêÔºåË´ãË£ú JSON„ÄÇ" : "");

      weekLabel.textContent = "W" + String(activeWeek);
      scenePickLabel.textContent = activeSceneTitle ? activeSceneTitle : "ÈÅ∏ÊìáÊÉÖÂ¢É";
      sceneTitle.textContent = activeSceneTitle ? activeSceneTitle : "ËºâÂÖ•‰∏≠‚Ä¶";
      const progMax = Math.max(1, Math.ceil(turns.length/2));
      const progNow = Math.min(progMax, Math.floor(aiIdx/2)+1);
      sceneSub.textContent = `Êú¨ÈÄ±Ôºö${ITEMS_PER_WEEK}ÔºàC/V/ChÔºâ¬∑${progNow}/${progMax}`;
    placeProgressUnderEnglish();
      return;
    }

    const t = currentTurn();
    lineEn.textContent = t.en || "‚Äî";
    const li2 = document.getElementById("lineEnInline"); if(li2) li2.textContent = t.en || "‚Äî";
    renderZhJa(lineZh, t.zh); const lz2 = document.getElementById("lineZhInline"); renderZhJa(lz2, t.zh);
    levBadge.textContent = t.level || "A1";

    const fillText = t.fill && t.fill.trim() ? t.fill : guessFillFromSentence(t.en);
    fillTitle.textContent = "Â°´Á©∫ÊèêÁ§∫";
    fillEn.textContent = fillText || "Can I get a ____ , please?";
    fillHint.textContent = t.hint && t.hint.trim()
      ? t.hint
      : "ÂÖàÁî®„ÄåÂ°´Á©∫„ÄçÂÆåÊàê‰∏ÄÂè•ÔºåÂÜçÊîπÊàê‰Ω†Ëá™Â∑±ÁöÑË™™Ê≥ï„ÄÇ";
    if(!fillInput.value) fillInput.value = "";

    weekLabel.textContent = "W" + String(activeWeek);
    scenePickLabel.textContent = activeSceneTitle ? activeSceneTitle : "ÈÅ∏ÊìáÊÉÖÂ¢É";
    sceneTitle.textContent = activeSceneTitle ? activeSceneTitle : "ËºâÂÖ•‰∏≠‚Ä¶";
    sceneSub.textContent = `Êú¨ÈÄ±Ôºö${ITEMS_PER_WEEK}ÔºàC/V/ChÔºâ¬∑${turnIdx+1}/${Math.max(1,turns.length)}`;
    placeProgressUnderEnglish();
  }

  function synthUserFromAI(aiEn, sceneId){
    const s = (aiEn||"").trim();
    if(!s) return "‚Äî";
    const lower = s.toLowerCase();
    const isQ = /\?$/.test(s);

    const sid = (sceneId||"").toLowerCase();
    const isDir = sid.includes("direction");
    const isAirport = sid.includes("airport");
    const isCoffee = sid.includes("coffee");

    if(isQ){
      if(isDir && (lower.includes("where") || lower.includes("how do i get"))){
        return "It's over there.";
      }
      if(isAirport && (lower.includes("passport") || lower.includes("boarding") || lower.includes("gate"))){
        return "Sure. Let me check that for you.";
      }
      if(isCoffee && (lower.includes("would you like") || lower.includes("what can i get"))){
        return "I'd like a coffee, please.";
      }
      if(lower.startsWith("can i") || lower.startsWith("could i") || lower.startsWith("may i")){
        return "Yes, please.";
      }
      return "Sure.";
    }

    return s;
  }

function makeCloze(expectedEn){
    const s = (expectedEn||"").trim();
    if(!s) return {cloze:"", answer:"", options:[]};

    const tokens = s.replace(/[?!.]/g,"").split(/\s+/).filter(Boolean);
    let target = "";

    for(const tk of tokens){
      if(/\d/.test(tk)){ target = tk; break; }
    }
    if(!target){
      for(let i=tokens.length-1;i>=0;i--){
        const tk = tokens[i].replace(/[^A-Za-z0-9'-]/g,"");
        if(tk.length>=4 && !/^(this|that|with|have|your|what|where|when|could|would|please)$/i.test(tk)){
          target = tokens[i];
          break;
        }
      }
    }
    if(!target) target = tokens[Math.max(0, tokens.length-1)];

    const esc = target.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const cloze = s.replace(new RegExp('\\b'+esc+'\\b'), '____');

    const pool = ["gate","terminal","passport","boarding","information","coffee","small","large","help","today","tomorrow","please","thanks","baggage","counter","check-in"];
    const lower = target.toLowerCase();
    const opts = [target];
    for(const w of pool){
      if(opts.length>=3) break;
      if(w.toLowerCase()===lower) continue;

      if(/\d/.test(target)){
        if(/\d/.test(w)) opts.push(w);
      }else{
        if(!/\d/.test(w)) opts.push(w);
      }
    }

    if(/\d/.test(target) && opts.length<3){
      const n = parseInt(target.replace(/\D/g,""),10) || 12;
      while(opts.length<3){
        const cand = String(n + (opts.length===1?1:2));
        if(!opts.includes(cand)) opts.push(cand);
      }
    }
    return {cloze, answer: target, options: opts};
  }

  function ensureFillOpts(){
    let el = document.getElementById("fillOpts");
    if(!el){
      el = document.createElement("div");
      el.id = "fillOpts";
      el.className = "fillOpts";
      el.style.display = "flex";
      el.style.flexWrap = "wrap";
      el.style.gap = "10px";
      el.style.marginTop = "10px";

      fillHint.insertAdjacentElement("afterend", el);
    }
    return el;
  }

  function renderFillOptions(cl){
    const el = ensureFillOpts();
    el.innerHTML = "";
    if(!cl || !cl.options || cl.options.length===0) return;
    cl.options.forEach((opt)=>{
      const b = document.createElement("button");
      b.type = "button";
      b.className = "optBtn";
      b.textContent = opt;
      b.style.border = "1px solid var(--line)";
      b.style.background = "#fff";
      b.style.borderRadius = "999px";
      b.style.padding = "10px 14px";
      b.style.cursor = "pointer";

      let lastTouch = 0;
      const applyOpt = ()=>{
        const expected = (currentExpectedEn()||"").trim();
        if(!expected){
          fillInput.value = opt;
          if(window.MOBILE_LITE || (window.matchMedia && window.matchMedia("(pointer: coarse)").matches)){
            try{ fillInput.blur(); }catch(e){}
            const y = window.scrollY;
            requestAnimationFrame(()=>{ try{ window.scrollTo(0,y); }catch(e){} });
          }
          return;
        }
        const cl2 = makeCloze(expected);
        const completed = (cl2.cloze||"").includes("____")
          ? cl2.cloze.replace("____", opt)
          : expected;
        fillInput.value = completed;

        if(window.MOBILE_LITE || (window.matchMedia && window.matchMedia("(pointer: coarse)").matches)){
          try{ fillInput.blur(); }catch(e){}

          const y = window.scrollY;
          requestAnimationFrame(()=>{ try{ window.scrollTo(0,y); }catch(e){} });
        }else{
          focusNoScroll(fillInput);
        }
      };
      b.addEventListener("touchend", ()=>{ lastTouch = Date.now(); applyOpt(); }, {passive:true});
      b.addEventListener("click", ()=>{ if(Date.now()-lastTouch < 700) return; applyOpt(); });
      el.appendChild(b);
    });
  }

  function currentExpectedEn(){
    if(talkMode!=="dialogue") return "";

    const aiIdx = turnIdx;
    const user = (turns[aiIdx+1] && turns[aiIdx+1].role==="USER") ? turns[aiIdx+1] : expectedAfter(aiIdx);
    return (user && user.en) ? user.en : "";
  }

function guessFillFromSentence(en){
    if(!en) return "";

    const s = String(en).trim();
    if(s.includes("____")) return s;
    const words = s.replace(/[‚Äú‚Äù"]/g,"").split(/\s+/).filter(Boolean);
    if(words.length<4) return s.replace(/\b(\w+)\b/, "____");

    const k = Math.max(1, words.length-2);
    const target = words[k].replace(/[.,!?;:]+$/,"");
    return s.replace(target, "____");
  }

  const USE_AZURE_TTS = true;
  const AZURE_TTS_ENDPOINT = `${SUPABASE_URL}/functions/v1/azure-tts`;

  const TEACHER_AZURE_VOICE = {
    "Diana": "en-GB-LibbyNeural",
    "Emma": "en-AU-NatashaNeural",
    "Sophia": "en-US-AriaNeural"
  };

  const TEACHER_TTS_STYLE = {
    "Diana": { rate: "-2%", pitch: "+10%" },
    "Emma":  { rate: "+6%", pitch: "+2%" },
    "Sophia":{ rate: "0%",  pitch: "-6%" }
  };

  let __ttsAudio = null;
  let __ttsBlobUrl = null;

async function speak(text){
    try{
      const now = Date.now();
      if (text && text === lastTts && (now - lastTtsAt) < 800) return;
      lastTtsAt = now;
      lastTts = text;

      try{ if(window.speechSynthesis) window.speechSynthesis.cancel(); }catch(e){}
      try{ if(__ttsAudio){ __ttsAudio.pause(); __ttsAudio.currentTime = 0; } }catch(e){}
      try{ if(__ttsBlobUrl){ URL.revokeObjectURL(__ttsBlobUrl); } }catch(e){}
      __ttsAudio = null;
      __ttsBlobUrl = null;

      __tvStart();

      /* TALK MOBILE FINAL: azure fallback */
      let __spoke = false;


      if (USE_AZURE_TTS){
        try{
        const sel = document.getElementById("selTeacher");
        const raw = sel ? String(sel.value||"") : "";
        const key = raw.toLowerCase();
        const base = key.split('/').pop();
        const name = base.replace(/\.mp4$/,'');
        const cap = name ? (name.charAt(0).toUpperCase() + name.slice(1)) : raw;

        const voice = (TEACHER_AZURE_VOICE[raw] || TEACHER_AZURE_VOICE[cap] || TEACHER_AZURE_VOICE[base] || "en-US-AriaNeural");
        const st = (TEACHER_TTS_STYLE[raw] || TEACHER_TTS_STYLE[cap] || TEACHER_TTS_STYLE[base] || { rate: "0%", pitch: "0%" });

        const r = await fetch(AZURE_TTS_ENDPOINT, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": "Bearer " + SUPABASE_ANON_KEY
          },
          body: JSON.stringify({ text, voice, rate: st.rate, pitch: st.pitch })
        });

        if(!r.ok){
          const t = await r.text().catch(()=> "");
          console.warn("[azure-tts] failed:", r.status, t.slice(0,200));
          throw new Error("azure-tts " + r.status);
        }

        const blob = await r.blob();
        __ttsBlobUrl = URL.createObjectURL(blob);
        __ttsAudio = new Audio(__ttsBlobUrl);

        __ttsAudio.onended = ()=>{
          __tvStop();
          try{ if(__ttsBlobUrl) URL.revokeObjectURL(__ttsBlobUrl); }catch(e){}
          __ttsAudio = null;
          __ttsBlobUrl = null;
        };
        __ttsAudio.onerror = ()=>{
          __tvStop();
        };

        await __ttsAudio.play();
        return;
        }catch(_e){ /* fallthrough to browser */ }
      }

      if(!("speechSynthesis" in window)){ __tvStop(); return; }
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "en-US";
      u.rate = 1.0;
      window.speechSynthesis.speak(u);
        __spoke = true;
      u.onend = ()=>{ __tvStop(); };
      u.onerror = ()=>{ __tvStop(); };
    }catch(e){
      try{ __tvStop(); }catch(_){}
    }
  }

  function stopSpeak(){
    try{ window.speechSynthesis.cancel(); }catch(e){}
    __tvStop();
  }

  function isAI(t){ return !!t && (t.role||'AI') !== 'USER'; }
  function nextAIIndex(from){
    for(let i=from+1;i<turns.length;i++){
      if(isAI(turns[i])) return i;
    }
    return -1;
  }
  function expectedAfter(aiIndex){
    for(let i=aiIndex+1;i<turns.length;i++){
      const t = turns[i];
      if(!t) continue;
      if(isAI(t)) break;
      return t;
    }
    return null;
  }

  function nextTurn(){
    const ni = nextAIIndex(turnIdx);
    if(ni >= 0){
      turnIdx = ni;
      updateUI();
      speak(currentTurn().en);
    }else{
      showToast("Êú¨ÊÉÖÂ¢ÉÂÆåÊàê ‚úÖ");
try{showReport();}catch(e){}
    }
  }

  function saveLine(){
    const t = currentTurn();
    if(!t.en) return;
    let arr = [];
    try{ arr = JSON.parse(localStorage.getItem(LS_SAVED)||"[]"); }catch(e){}
    arr.unshift({en:t.en, zh:t.zh, at:new Date().toISOString(), scene:activeSceneId});
    arr = arr.slice(0,200);
    localStorage.setItem(LS_SAVED, JSON.stringify(arr));
    showToast("Â∑≤Êî∂Ëóè");
  }

  async function loadSceneById(id, title){
    activeSceneId = id;
    activeSceneTitle = title || id;

    const url = new URL("/talk/" + encodeURIComponent(id) + ".json", location.origin).toString();
    const fallback = [
      url,
      new URL("./" + encodeURIComponent(id) + ".json", location.href).toString(),
      new URL("../talk/" + encodeURIComponent(id) + ".json", location.href).toString(),
    ];
    try{
      activeScene = await fetchJsonAny(fallback);
      currentSceneJson = activeScene;
      if(fileTag) fileTag.textContent = (activeSceneId ? (activeSceneId + ".json") : "");

      const tz = safeText(activeScene?.title_zh || activeScene?.titleZh || "");
      const te = safeText(activeScene?.title_en || activeScene?.titleEn || "");
      const sc = safeText(activeScene?.scene || "");
      const lv = safeText(activeScene?.level || "");
      const head = (tz || te) ? (tz || te) : (sc ? sc : activeSceneTitle);
      const sub = (tz && te) ? te : (te || tz ? "" : "");
      const extra = [lv?(" ¬∑ "+lv):"", sc?(" ¬∑ "+sc):""].join("");
      if(missionText) missionText.innerHTML = "<b>"+escapeHtml(head)+"</b>" + (sub?(" <span class=\"sub\">"+escapeHtml(sub)+"</span>"):"") + (extra?(" <span class=\"sub\">"+escapeHtml(extra.trim())+"</span>"):"");

    }catch(e){
      showToast("Êâæ‰∏çÂà∞Â†¥ÊôØ JSONÔºö" + id);
      turns = [{en:"Scene JSON not found.", zh:"Êâæ‰∏çÂà∞Â†¥ÊôØ JSONÔºàË´ãÁ¢∫Ë™çÊ™îÊ°àÊîæÂú® /talk/Ôºâ", level:"A1"}];
      turnIdx = 0;
      updateUI();
      return;
    }

    turns = normalizeTurns(activeScene);
    if(!turns.length){
      turns = [{en:"(No turns found in JSON)", zh:"JSON Ê≤íÊúâ turns/dialogue/lines/items Èô£Âàó", level: String(activeScene?.meta?.level || "A1")}];
    }
    turnIdx = 0;
    fillInput.value = "";
    updateUI();

    speak(currentTurn().en);
  }

  function buildWeekMap(){
    byWeek = new Map();
    const scenes = (indexData && Array.isArray(indexData.scenes)) ? indexData.scenes : [];
    for(const s of scenes){
      const id = s.id || s.scene_id || s.key;
      if(!id) continue;
      const wk = getWeekFromId(id);
      if(!wk) continue;
      if(!byWeek.has(wk)) byWeek.set(wk, []);
      byWeek.get(wk).push({id, title: s.title || id, level: s.level || s.lev || ""});
    }

    for(const [wk, arr] of byWeek){
      arr.sort((a,b)=>String(a.id).localeCompare(String(b.id)));
    }
  }

  function renderPicker(){
    modalBody.innerHTML = "";
    for(let wk=1; wk<=MAX_WEEKS; wk++){
      const list = byWeek.get(wk) || [];
      if(!list.length) continue;

  if(wk !== unlockedWeek && wk !== unlockedWeek + 1) continue;

  if(wk === unlockedWeek + 1){
    const g = document.createElement("div");
    g.className = "group";
    const head = document.createElement("div");
    head.className = "gHead";
    head.innerHTML = `<div>Week ${wk}</div><div class="lock">üîí Â∞öÊú™Ëß£Èéñ</div>`;
    g.appendChild(head);

    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `
      <div>
        <div class="name">‰∏ã‰∏ÄÈÄ±Âç≥Â∞áËß£Èéñ</div>
        <p class="sub">ÂÆåÊàêÊú¨ÈÄ±Âè£Ë™™‰ªªÂãôÂæåÔºåÁ≥ªÁµ±ÊúÉËá™ÂãïÈñãÊîæ Week ${wk}</p>
      </div>
      <button class="ghost" style="height:42px;font-size:15px" disabled>Â∞öÊú™</button>
    `;
    g.appendChild(row);
    modalBody.appendChild(g);
    continue;
  }

      if(wk > unlockedWeek + 1) continue;

      if(wk === unlockedWeek + 1){
        const g = document.createElement("div");
        g.className = "group";
        const head = document.createElement("div");
        head.className = "gHead";
        head.innerHTML = `<div>Week ${wk}</div><div class="lock">üîí Â∞öÊú™Ëß£Èéñ</div>`;
        g.appendChild(head);

        const row = document.createElement("div");
        row.className = "item";
        row.innerHTML = `
          <div>
            <div class="name">‰∏ã‰∏ÄÈÄ±Âç≥Â∞áËß£Èéñ</div>
            <p class="sub">ÂÆåÊàêÊú¨ÈÄ±Âè£Ë™™‰ªªÂãôÂæåÔºåÁ≥ªÁµ±ÊúÉËá™ÂãïÈñãÊîæ Week ${wk}</p>
          </div>
          <button class="ghost" style="height:42px;font-size:15px" disabled>Â∞öÊú™</button>
        `;
        g.appendChild(row);

        modalBody.appendChild(g);
        continue;
      }

      const locked = wk !== unlockedWeek;
      const g = document.createElement("div");
      g.className = "group";
      const head = document.createElement("div");
      head.className = "gHead";
      head.innerHTML = `<div>Week ${wk}</div><div class="lock">${locked ? "üîí Â∞öÊú™Ëß£Èéñ" : "‚úÖ ÂèØÁ∑¥Áøí"}</div>`;
      g.appendChild(head);

      for(const it of list){
        const row = document.createElement("div");
        row.className = "item";
        const left = document.createElement("div");
        left.innerHTML = `<div class="name">${escapeHtml(it.title)}</div><p class="sub">${escapeHtml(it.id)}${it.level?(" ¬∑ "+escapeHtml(it.level)):""}</p>`;
        const btn = document.createElement("button");
        btn.className = locked ? "ghost" : "primary";
        btn.style.height = "42px";
        btn.style.fontSize = "15px";
        btn.textContent = locked ? "Â∞öÊú™" : "ÈñãÂßã";
        btn.disabled = locked;
        btn.addEventListener("click", ()=>{
          activeWeek = wk;
          localStorage.setItem(LS_LAST_SCENE, it.id);
          closeModal();
          loadSceneById(it.id, it.title);
        });
        row.appendChild(left);
        row.appendChild(btn);
        g.appendChild(row);
      }
      modalBody.appendChild(g);
    }
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"]/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]));
  }

  function showModalHtml(title, inner){
    modalBody.innerHTML = '<div style="font-weight:900; margin-bottom:10px">'+escapeHtml(title)+'</div>' + inner;
    openModal();
  }
  function escapeHtml(s){
    return String(s??"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }
  function buildDialogueHtml(){
    const d = (currentSceneJson && Array.isArray(currentSceneJson.dialogue)) ? currentSceneJson.dialogue : [];
    if(!d.length) return '<div class="sub">ÔºàÊ≠§ÊÉÖÂ¢ÉÊ≤íÊúâ dialogueÔºâ</div>';
    return d.map((x,i)=>{
      const who = escapeHtml(x.speaker||x.role||"");
      const en = escapeHtml(x.en||"");
      const zh = escapeHtml(x.zh||"");
      return '<div style="padding:10px 0;border-bottom:1px solid var(--line)"><div style="font-weight:800">'+(i+1)+'. '+who+'</div><div>'+en+'</div><div class="sub" style="margin-top:4px">'+zh+'</div></div>';
    }).join("");
  }
  function buildRoleHtml(){
    const r = (currentSceneJson && currentSceneJson.role) ? currentSceneJson.role : {};
    const aiName = escapeHtml(r.ai_name || "AI");
    const aiRole = escapeHtml(r.ai_role || "");
    const scene = escapeHtml(currentSceneJson?.scene || "");
    const lvl = escapeHtml(currentSceneJson?.level || "");
    return [
      '<div style="display:grid; gap:8px">',
      '<div><b>AIÔºö</b>'+aiName+(aiRole?(' ¬∑ '+aiRole):'')+'</div>',
      scene ? ('<div><b>ÊÉÖÂ¢ÉÔºö</b>'+scene+'</div>') : '',
      lvl ? ('<div><b>Á≠âÁ¥öÔºö</b>'+lvl+'</div>') : '',
      '</div>'
    ].join("");
  }
  function buildMetaHtml(){
    const id = escapeHtml(currentSceneJson?.id || activeSceneId || "");
    const track = escapeHtml(currentSceneJson?.track || "");
    const week = escapeHtml(currentSceneJson?.week ?? "");
    const modes = Array.isArray(currentSceneJson?.training_modes) ? currentSceneJson.training_modes.join(", ") : "";
    return [
      '<div style="display:grid; gap:8px">',
      id?('<div><b>IDÔºö</b>'+id+'</div>'):'',
      week?('<div><b>WeekÔºö</b>'+week+'</div>'):'',
      track?('<div><b>TrackÔºö</b>'+track+'</div>'):'',
      modes?('<div><b>ModesÔºö</b>'+escapeHtml(modes)+'</div>'):'',
      '<div class="sub">ÔºàÊèêÁ§∫ÔºöÂè≥‰∏äÊúÉÈ°ØÁ§∫ÁõÆÂâçËºâÂÖ•ÁöÑ JSON Ê™îÂêçÔºâ</div>',
      '</div>'
    ].join("");
  }
  if(lnkRole) lnkRole.addEventListener("click",(e)=>{ e.preventDefault(); showModalHtml("‰∏ªËßí", buildRoleHtml()); });
  if(lnkDialog) lnkDialog.addEventListener("click",(e)=>{ e.preventDefault(); showModalHtml("ÁØÑ‰æãÂ∞çË©±", buildDialogueHtml()); });
  if(lnkMeta) lnkMeta.addEventListener("click",(e)=>{ e.preventDefault(); showModalHtml("Ë≥áË®ä", buildMetaHtml()); });

async function init(){

  const selTeacher = document.getElementById("selTeacher");
  if(selTeacher){
    selTeacher.addEventListener("change", ()=> setTeacher(selTeacher.value));
  }
  let savedT = "";
  try{ savedT = localStorage.getItem("bw_teacher_file") || ""; }catch(_){}
  const urlT = getTeacherFromURL();
  setTeacher(urlT || savedT || (selTeacher ? selTeacher.value : "teacher.mp4"));
    getOverrides();
    unlockedWeek = computeUnlockedWeek();

    let savedWeek = 0;
    try { savedWeek = Number(localStorage.getItem("talk_active_week") || "0"); } catch(e){}
    activeWeek = unlockedWeek;

    try{ talkMode = localStorage.getItem("talk_mode") || "dialogue"; }catch(_e){ talkMode = "dialogue"; }

    try{ localStorage.setItem("talk_active_week", String(activeWeek)); }catch(_e){}

    try{
      indexData = await fetchJsonAny([INDEX_URL, ...FALLBACK_INDEX_URLS]);
      indexData = normalizeIndex(indexData);
    }catch(e){
      indexData = { scenes: [] };
      showToast("ËÆÄ‰∏çÂà∞ talk/index.json");
    }

    buildWeekMap();
    renderPicker();

    const params = new URLSearchParams(location.search);
    const legacyScene = (params.get("scene")||"").trim();
    const forcedScene = null;
    let forcedByParam = false;

    let firstId = null, firstTitle = null;

    const allScenes = Array.isArray(indexData?.scenes) ? indexData.scenes : [];

    function baseNameNoExt(p){
      if(!p) return "";
      const s = String(p).split("?")[0].split("#")[0];
      const file = s.split("/").pop() || s;
      return file.replace(/\.json$/i,"");
    }
    function resolveScene(param){
      if(!param) return null;
      const q = String(param).trim();

      let hit = allScenes.find(s => (s?.id||"") === q);
      if(hit) return hit;

      const qBase = q.replace(/\.json$/i,"");
      const qTail = qBase.split(".").pop();

      const candidates = [];
      for(const s of allScenes){
        const id = String(s?.id||"");
        const fileBase = baseNameNoExt(s?.file||s?.url||"");
        const idTail = id.split(".").pop();
        if(!id) continue;

        if(fileBase && fileBase === qBase) candidates.push(s);
        else if(fileBase && fileBase.endsWith("." + qBase)) candidates.push(s);
        else if(id === qBase) candidates.push(s);
        else if(id.endsWith("." + qBase)) candidates.push(s);
        else if(qTail && (idTail === qTail || fileBase.endsWith("." + qTail) || id.endsWith("." + qTail))) candidates.push(s);
      }
      if(candidates.length === 0) return null;

      const aw = Number(activeWeek||0);
      let best = null;
      let bestScore = -1;
      for(const s of candidates){
        const w = Number(s?.week||0);
        const tr = String(s?.track||"");
        const score =
          (w === aw ? 1000 : 0) +
          (w ? (100 - Math.abs(w - aw)) : 0) +
          (tr==="core" ? 3 : tr==="variation" ? 2 : tr==="challenge" ? 1 : 0);
        if(score > bestScore){ bestScore = score; best = s; }
      }
      return best || candidates[0];
    }

    if(legacyScene){
      const mapped = resolveScene(legacyScene);
      if(!mapped){

        turns = [{en:`Scene not found: ${legacyScene}`, zh:`Êâæ‰∏çÂà∞Â†¥ÊôØÔºö${legacyScene}„ÄÇË´ãÁ¢∫Ë™ç talk/index.json ÁöÑ id ÊòØÂê¶Â≠òÂú®„ÄÇ`}];
        renderTurns();
        showToast(`Êâæ‰∏çÂà∞Â†¥ÊôØÔºö${legacyScene}`);
        return;
      }
      if(mapped){
        forcedByParam = true;

        firstId = mapped.id;
        firstTitle = mapped.title || mapped.id;

        if(mapped.week){
          if(Number(mapped.week)==Number(unlockedWeek)) activeWeek = Number(mapped.week)||activeWeek;
          try{ localStorage.setItem("talk_active_week", String(activeWeek)); }catch(_e){}
          try{ localStorage.setItem(LS_LAST_SCENE, mapped.id); }catch(_e){}
        }
      }else{

        turns = [{en:"Scene not found: "+legacyScene, zh:"Êâæ‰∏çÂà∞Ê≠§ÊÉÖÂ¢ÉÔºàË´ãÁ¢∫Ë™ç URL ÂèÉÊï∏Êàñ index.json ÊòØÂê¶ÂåÖÂê´Ôºâ", level:"A1"}];
        updateUI();
        return;
      }
    }else if(forcedScene){
      const mapped = resolveScene(forcedScene);
      if(mapped){
        firstId = mapped.id;
        firstTitle = mapped.title || mapped.id;

        if(mapped.week){
          if(Number(mapped.week)==Number(unlockedWeek)) activeWeek = Number(mapped.week)||activeWeek;
          try{ localStorage.setItem("talk_active_week", String(activeWeek)); }catch(_e){}
        }
      }else{
        firstId = forcedScene;
        firstTitle = forcedScene;
      }
    }else{

      let pick = allScenes.find(s => Number(s?.week||0) === Number(activeWeek||0));
      if(!pick) pick = allScenes[0] || null;
      if(pick){
        firstId = pick.id; firstTitle = pick.title || pick.id;
      }
    }

if(!firstId){
      turns = [{en:"No scenes in index.json", zh:"Ë´ãÂÖàÊää w01..w08 ÁöÑ JSON Ëàá talk/index.json ÊîæÂú® /talk/ ÁõÆÈåÑ", level:"A1"}];
      updateUI();
      return;
    }
    await loadSceneById(firstId, firstTitle);
  }

  btnPick.addEventListener("click", openModal);
  btnClose.addEventListener("click", closeModal);
  mask.addEventListener("click", (e)=>{ if(e.target===mask) closeModal(); });

  btnReplay.addEventListener("click", ()=>{
    const t = currentTurn();
    if(t.en) speak(t.en);
    else if(lastTts) speak(lastTts);
  });

  btnSkip.addEventListener("click", ()=>nextTurn());

  btnHint.addEventListener("click", ()=>{
    if(talkMode === "dialogue"){
      const expected = (currentExpectedEn() || "").trim();
      if(!expected){ showToast("Êú¨Âè•Ê≤íÊúâÂª∫Ë≠∞ÂõûË¶Ü"); return; }

      fillEn.textContent = expected;

      speak(expected);
      showToast("Â∑≤È°ØÁ§∫ÊèêÁ§∫ÔºàÂÆåÊï¥Âè•Ôºâ");

      clearTimeout(window.__bwHintTimer);
      window.__bwHintTimer = setTimeout(()=>{
        const cl = makeCloze(expected);
        fillEn.textContent = cl.cloze || expected;
        renderFillOptions(cl);
      }, 3000);
      return;
    }
    const t = currentTurn();
    showToast(t.hint && t.hint.trim() ? t.hint : "ÊèêÁ§∫ÔºöÂÖàË∑üËëóÂî∏‰∏ÄÈÅçÔºåÂÜçÊîπÊàê‰Ω†Ëá™Â∑±ÁöÑË™™Ê≥ï„ÄÇ");
  });

  btnSave.addEventListener("click", saveLine);

  btnFill.addEventListener("click", ()=>{
    fillCard.scrollIntoView({behavior:"smooth", block:"start"});
    focusNoScroll(fillInput);
  });

  btnHideFill.addEventListener("click", ()=>{
    const hidden = fillCard.style.display === "none";
    fillCard.style.display = hidden ? "" : "none";
  });

  btnFillReset.addEventListener("click", ()=>{
    fillInput.value = "";
    focusNoScroll(fillInput);
  });

  btnSendFill.addEventListener("click", async ()=>{
    return lockScrollDuring(async ()=>{

    if(talkMode === "dialogue"){
      const said = (fillInput.value || "").trim();
      if(!said){ showToast("Ë´ãÂÖàËº∏ÂÖ•‰Ω†ÁöÑÂõûË¶Ü"); return; }

      try{ await speak(said); }catch(e){}

      fillInput.value = "";
      showToast("Â∑≤ÈÄÅÂá∫ ‚úÖ");

      nextTurn();
      return;
    }

    const said = (fillInput.value || "").trim();
    if(!said){ showToast("Ë´ãÂÖàÂ°´Á©∫"); return; }
    await speak(said);
    showToast("ÂÅöÂæóÂ•Ω ‚úÖ");
    });

  });

  btnType.addEventListener("click", ()=>{
    if(talkMode === "dialogue"){

      let aiIdx = turnIdx;
      while(aiIdx < turns.length && turns[aiIdx]?.role === "USER") aiIdx++;
      const user = (turns[aiIdx+1] && turns[aiIdx+1].role==="USER") ? turns[aiIdx+1] : null;
      const ans = prompt("Ëº∏ÂÖ•‰Ω†ÁöÑÂõûË¶ÜÔºàÊúÉÁî® TTS ÊúóËÆÄÔºâ", user?.en || "");
      if(ans && ans.trim()){
        fillInput.value = ans.trim();
      }
      return;
    }
    const t = currentTurn();
    const ans = prompt("Ëº∏ÂÖ•‰Ω†ÁöÑÂè•Â≠êÔºàÊúÉÁî® TTS ÊúóËÆÄÔºâ", t.en || "");
    if(ans && ans.trim()){
      speak(ans.trim());
    }
  });

  btnBack.addEventListener("click", ()=>{
    history.length>1 ? history.back() : (location.href = "./");
  });

  let rec = null;
  function startRec(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){
      showToast("Ê≠§ÁÄèË¶ΩÂô®‰∏çÊîØÊè¥Ë™ûÈü≥Ëæ®Ë≠ò");
      return;
    }
    if(rec){ try{rec.stop()}catch(e){} }
    rec = new SR();
    rec.lang = "en-US";
    rec.interimResults = false;
    rec.maxAlternatives = 1;
    $("dotLive").style.background = "#ef4444";
    rec.onresult = (ev)=>{
      const said = (ev.results && ev.results[0] && ev.results[0][0] && ev.results[0][0].transcript) ? ev.results[0][0].transcript : "";
      $("dotLive").style.background = "#22c55e";
      if(!said.trim()){
        showToast("Ê≤íÊúâËÅΩÊ∏ÖÊ•öÔºåË´ãÂÜçË™™‰∏ÄÊ¨°");
        return;
      }

      fillInput.value = said.trim();
      showToast("‰Ω†Ë™™Ôºö " + said.trim());

      setTimeout(()=>{ try{ btnSendFill.click(); }catch(e){} }, 350);
    };
    rec.onerror = ()=>{
      $("dotLive").style.background = "#22c55e";
      showToast("Ë™ûÈü≥Ëæ®Ë≠òÂ§±Êïó");
    };
    rec.onend = ()=>{
      $("dotLive").style.background = "#22c55e";
    };
    try{ rec.start(); }catch(e){ showToast("Ë™ûÈü≥Ëæ®Ë≠òÁÑ°Ê≥ïÂïüÂãï"); }
  }
  btnMic.addEventListener("click", startRec);

  document.addEventListener("touchmove", (e)=>{

    const inModal = e.target && (e.target.closest && e.target.closest("#modalBody"));
    if(mask.style.display==="flex" && inModal) return;

  }, {passive:true});

  init();
})();</script>

<script>
const TEACHER_AZURE_VOICE = {
  "diana.mp4":  "en-US-AvaNeural",
  "emma.mp4":   "en-US-AriaNeural",
  "sophia.mp4": "en-GB-SoniaNeural"
};
const TEACHER_TTS_STYLE = {
  "diana.mp4":  { rate: "-2%", pitch: "+10%" },
  "emma.mp4":   { rate: "+6%", pitch: "+2%" },
  "sophia.mp4": { rate: "0%",  pitch: "-6%" }
};
function getTeacherStyle(sel){
  const key=(sel && sel.value? sel.value: "").toLowerCase();
  return TEACHER_TTS_STYLE[key] || { rate: "0%", pitch: "0%" };
}

function getTeacherVoice(sel){
  const key = (sel && sel.value ? sel.value : "").toLowerCase();
  return TEACHER_AZURE_VOICE[key] || "en-US-JennyNeural";
}
</script>

<div id="bwReportMask" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:9999">
  <div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
              width:min(92vw,420px);background:#fff;border-radius:22px;padding:18px 18px 16px;">
    <div style="text-align:center;font-size:20px;font-weight:700;margin-top:4px">
      <span style="font-size:28px">‚≠ê ‚≠ê ‚≠ê</span><br/>ÂæàÊ£í!
    </div>
    <div style="text-align:center;color:#666;margin:6px 0 10px">Ë≤∑‰∏ÄÊùØÂíñÂï°</div>
    <div style="display:flex;gap:10px;justify-content:space-between;margin:10px 0">
      <div style="flex:1;text-align:center"><b id="rActive">50%</b><div style="color:#777;font-size:12px">‰∏ªÂãïÁ∑¥Áøí</div></div>
      <div style="flex:1;text-align:center"><b id="rPron">53%</b><div style="color:#777;font-size:12px">ÁôºÈü≥</div></div>
      <div style="flex:1;text-align:center"><b id="rWords">116</b><div style="color:#777;font-size:12px">ÂñÆÂ≠óÊï∏</div></div>
    </div>
    <div style="text-align:center;margin:6px 0 14px">
      <div style="font-size:12px;color:#777">ÂÆåÊï¥Â∫¶</div>
      <div style="font-size:28px;font-weight:700" id="rComplete">65</div>
    </div>
    <div style="display:flex;gap:10px">
      <button onclick="closeReport()" style="flex:1;border-radius:14px;border:1px solid #e5e7eb;padding:10px;background:#fff">ÈóúÈñâ</button>
      <button onclick="closeReport()" style="flex:1;border-radius:14px;border:none;padding:10px;background:#2563eb;color:#fff">ÁπºÁ∫å</button>
    </div>
  </div>
</div>
<script>
function showReport(){ document.getElementById('bwReportMask').style.display='block';
  try{bwSaveTalkDailyScore();
  try{ if(typeof totalScore!=='undefined'){ BW_commitTalkScore(totalScore);} }catch(e){}
}catch(e){} }
function closeReport(){ document.getElementById('bwReportMask').style.display='none'; }
</script>

<script>
function bwSaveTalkDailyScore(){
  try{
    const d = new Date();
    const key = d.toISOString().slice(0,10);
    const twKey = d.toLocaleDateString('en-CA', { timeZone: 'Asia/Taipei' });
    const score = (function(){
      const el = document.getElementById('rComplete');
      const v = el ? Number(String(el.textContent||'').trim()) : NaN;
      return Number.isFinite(v) ? Math.max(0, Math.min(100, Math.round(v))) : 65;
    })();
    const active = (function(){
      const el = document.getElementById('rActive');
      if(!el) return null;
      const t = String(el.textContent||'').replace('%','').trim();
      const v = Number(t);
      return Number.isFinite(v) ? Math.max(0, Math.min(100, Math.round(v))) : null;
    })();
    const pron = (function(){
      const el = document.getElementById('rPron');
      if(!el) return null;
      const t = String(el.textContent||'').replace('%','').trim();
      const v = Number(t);
      return Number.isFinite(v) ? Math.max(0, Math.min(100, Math.round(v))) : null;
    })();
    const words = (function(){
      const el = document.getElementById('rWords');
      if(!el) return null;
      const v = Number(String(el.textContent||'').trim());
      return Number.isFinite(v) ? Math.max(0, Math.min(9999, Math.round(v))) : null;
    })();

    let obj = {};
    const raw = localStorage.getItem('bwTalkScores');
    if(raw){ try{ obj = JSON.parse(raw)||{}; }catch(e){ obj = {}; } }
    obj[key] = { score, active, pron, words, updated_at: new Date().toISOString() };
    if (twKey && twKey !== key) obj[twKey] = obj[key];
    localStorage.setItem('bwTalkScores', JSON.stringify(obj));
  }catch(e){}
}
</script>

<script>
(function(){
  const KEY = "BW_DAILY_SCORE_MAP";
  const TZ = "Asia/Taipei";
  function todayKey(){
    return new Date().toLocaleDateString("en-CA",{ timeZone: TZ });
  }
  window.BW_commitTalkScore = function(score){
    try{
      const day = todayKey();
      const map = JSON.parse(localStorage.getItem(KEY) || "{}");
      map[day] = (Number(map[day]) || 0) + Number(score || 0);
      localStorage.setItem(KEY, JSON.stringify(map));
      console.log("[BW SCORE SAVED]", day, map[day]);
    }catch(e){ console.error(e); }
  };
})();
</script>

<script>

(function(){
  const IOS = /iPhone|iPad|iPod/i.test(navigator.userAgent || "");
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;

  function toast(msg){
    try{
      if(typeof showToast === "function"){ showToast(msg); return; }
    }catch(_){}
    try{
      let t=document.getElementById("__bwToast");
      if(!t){
        t=document.createElement("div");
        t.id="__bwToast";
        t.style.cssText="position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(0,0,0,.78);color:#fff;padding:10px 14px;border-radius:999px;font-size:14px;z-index:99999;max-width:92vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;";
        document.body.appendChild(t);
      }
      t.textContent=msg;
      t.style.display="block";
      clearTimeout(t.__tm);
      t.__tm=setTimeout(()=>{t.style.display="none";},1700);
    }catch(_){}
  }

  function findMicBtn(){
    return document.getElementById("micBtn")
      || document.querySelector("[data-role='mic']")
      || document.querySelector(".micBtn")
      || document.querySelector("button[aria-label*='mic' i]")
      || document.querySelector("button[title*='mic' i]");
  }

  function installFallbackIfNeeded(){
    const mic = findMicBtn();
    const input = document.getElementById("fillInput") || document.querySelector("input,textarea");
    if(!mic) return;

    mic.__bwBusy = false;

    mic.addEventListener("click", async (e)=>{
      if(!IOS) return;
      if(mic.__bwBusy) { try{e.preventDefault();}catch(_){ } return; }
      mic.__bwBusy = true;
      setTimeout(()=>{ mic.__bwBusy=false; }, 600);

      if(!SR){
        try{ e.preventDefault(); e.stopPropagation(); }catch(_){}
        toast("iPhone Safari Â∏∏‰∏çÊîØÊè¥ÁÄèË¶ΩÂô®Ë™ûÈü≥Ëæ®Ë≠òÔºõË´ãÈªûËº∏ÂÖ•Ê°ÜÁî®ÈçµÁõ§È∫•ÂÖãÈ¢®üé§");
        try{ input && input.removeAttribute("readonly"); }catch(_){}
        try{ input && input.focus({preventScroll:true}); }catch(_e){ try{ input && input.focus(); }catch(_e2){} }
        return;
      }

      try{
        if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia){
          const stream = await navigator.mediaDevices.getUserMedia({audio:true});

          try{ stream.getTracks().forEach(tr=>tr.stop()); }catch(_){}
        }
      }catch(err){

        toast("Ë´ãÂà∞ iPhone Ë®≠ÂÆö ‚Üí Safari ‚Üí È∫•ÂÖãÈ¢®ÔºöÂÖÅË®±ÔºåÂÜçÈáçË©¶");
        return;
      }

    }, true);

    if(IOS){
      const origConsoleError = console.error;
      console.error = function(...args){
        try{
          const s = String(args && args[0] || "");
          if(s.includes("Speech") || s.includes("speech")){  }
        }catch(_){}
        return origConsoleError.apply(console, args);
      };
    }
  }

  if(document.readyState==="loading"){
    document.addEventListener("DOMContentLoaded", installFallbackIfNeeded, {once:true});
  }else{
    installFallbackIfNeeded();
  }
})();

/* === iOS SR HARDEN PATCH v1 === */
let __sr = null;
let __srRunning = false;
let __srStarting = false;
let __srTimer = null;

function getSR(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR) return null;
  if(__sr) return __sr;

  const r = new SR();
  try{ r.lang = "en-US"; }catch(_){}
  try{ r.interimResults = false; }catch(_){}
  try{ r.continuous = false; }catch(_){}
  try{ r.maxAlternatives = 1; }catch(_){}
  __sr = r;
  return r;
}

function srCleanup(){
  __srRunning = false;
  __srStarting = false;
  if(__srTimer){ clearTimeout(__srTimer); __srTimer = null; }
}

function startMicOnce(){
  const rec = getSR();
  if(!rec){
    try{ showToast("iPhone ‰∏çÊîØÊè¥Ë™ûÈü≥Ëæ®Ë≠òÔºåË´ãÁî®ÈçµÁõ§Ëº∏ÂÖ•"); }catch(_){
      alert("iPhone ‰∏çÊîØÊè¥Ë™ûÈü≥Ëæ®Ë≠òÔºåË´ãÁî®ÈçµÁõ§Ëº∏ÂÖ•");
    }
    return;
  }
  if(__srRunning || __srStarting) return;

  __srStarting = true;

  __srTimer = setTimeout(()=>{
    try{ rec.abort(); }catch(_){}
    srCleanup();
  }, 10000);

  rec.onresult = (e)=>{
    try{
      const t = e && e.results && e.results[0] && e.results[0][0] ? (e.results[0][0].transcript || "") : "";
      if(t){
        if(typeof fillInput !== "undefined" && fillInput) fillInput.value = t;
        else if(typeof qText !== "undefined" && qText) qText.value = t;
        else{
          const el = document.querySelector("#fillInput, #qText, textarea, input[type='text']");
          if(el) el.value = t;
        }
      }
    }finally{
      try{ rec.stop(); }catch(_){}
    }
  };

  rec.onerror = ()=>{
    srCleanup();
  };

  rec.onend = ()=>{
    srCleanup();
  };

  try{
    rec.start();
    __srRunning = true;
  }catch(e){
    srCleanup();
  }
}
/* === end iOS SR HARDEN PATCH v1 === */


/* === ZH TOGGLE HANDLER v2 === */
document.addEventListener("click", function(e){
  var line = e.target.closest(".aiInline");
  if(!line) return;
  if(e.target.classList && e.target.classList.contains("en") || e.target.closest(".en")){
    line.classList.toggle("show-zh");
  }
});
/* === end ZH TOGGLE HANDLER v2 === */


/* === LOADING WATCHDOG v1 === */
(function(){
  const MAX_LOADING_MS = 12000;
  function isLoading(){
    try{
      const el = document.getElementById("loadingText") || document.querySelector(".loadingText");
      if(el && /loading/i.test(el.textContent||"")) return true;
    }catch(_){}
    return false;
  }
  function forceUnblock(){
    try{ if(typeof setLoading==='function') setLoading(false); }catch(_){}
    try{ if(typeof lockUI==='function') lockUI(false); }catch(_){}
    try{ if(typeof showToast==='function') showToast("ËÆÄÂèñÂç°‰ΩèÔºåÂ∑≤Ëß£Èô§ÈéñÂÆöÔºõË´ãÈáçÊí≠ÊàñÊèõÈÄ±"); }catch(_){}
  }
  setTimeout(()=>{ if(isLoading()) forceUnblock(); }, MAX_LOADING_MS);
})();

</script>
</body>
</html>
