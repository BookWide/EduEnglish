<script>
(function () {
  const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";

  function fmtDate(v){
    if (!v) return "-";
    const d = new Date(v);
    return isNaN(d.getTime()) ? "-" : d.toLocaleString();
  }

  function planTextFromRow(o){
    const s = o && o.status ? o.status : "-";
    const exp = o && o.expire_at ? ("到期 " + fmtDate(o.expire_at)) : "無到期日";
    return s + "（" + exp + "）";
  }

  function waitSupabase(cb, ms){
    const start = Date.now();
    (function tick(){
      if (window.supabase) return cb(true);
      if (Date.now() - start > ms) return cb(false);
      setTimeout(tick, 50);
    })();
  }

  waitSupabase(function(ok){
    const $current = document.getElementById("currentSub");
    const $history = document.getElementById("historyBody");
    const $status  = document.getElementById("subStatus");
    const $debug   = document.getElementById("debug");

    if (!ok){
      $status.textContent = "錯誤";
      $current.innerHTML = "<div class='bad'>supabase-js 未載入</div>";
      return;
    }

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    sb.auth.getUser().then(function(res){
      const user = res && res.data && res.data.user;
      if (!user){
        $status.textContent = "未登入";
        $current.innerHTML = "<div class='bad'>尚未登入</div>";
        $history.innerHTML = "<tr><td colspan='3' class='muted'>請先登入</td></tr>";
        return;
      }

      // ★ 一定會送出請求的 orders 查詢
      sb.from("orders")
        .select("id,status,paid_at,expire_at,buyer_id,referrer_id,referral_code")
        .eq("buyer_id", user.id)
        .order("paid_at", { ascending: false })
        .then(function(r){
          const orders = r.data;
          const error = r.error;

          if (error){
            $status.textContent = "錯誤";
            $current.innerHTML = "<div class='bad'>" + error.message + "</div>";
            return;
          }

          if (!orders || orders.length === 0){
            $status.textContent = "無資料";
            $current.innerHTML = "<div class='bad'>尚無訂閱紀錄</div>";
            $history.innerHTML = "<tr><td colspan='3' class='muted'>沒有任何訂單</td></tr>";
            $debug.textContent = "auth uid: " + user.id;
            return;
          }

          const latest = orders[0];
          const active = latest.expire_at ? (new Date(latest.expire_at) > new Date()) : true;

          $status.textContent = active ? "有效" : "已到期";
          $status.className = "pill " + (active ? "ok" : "bad");

          $current.innerHTML =
            "<div style='line-height:1.8'>" +
            "<div>狀態：<span class='" + (active ? "ok":"bad") + "'>" + (latest.status||"-") + "</span></div>" +
            "<div>付款日期：<span class='mono'>" + fmtDate(latest.paid_at) + "</span></div>" +
            "<div>到期日期：<span class='mono'>" + fmtDate(latest.expire_at) + "</span></div>" +
            "<div class='muted tiny'>訂單ID：<span class='mono'>" + latest.id + "</span></div>" +
            "</div>";

          $history.innerHTML = orders.map(function(o){
            return (
              "<tr>" +
              "<td class='mono'>" + fmtDate(o.paid_at) + "</td>" +
              "<td>" + planTextFromRow(o) + "</td>" +
              "<td class='muted'>-</td>" +
              "</tr>"
            );
          }).join("");

          $debug.textContent = "auth uid: " + user.id;
        });
    });
  }, 4000);
})();
</script>













