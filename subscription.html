<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æˆ‘çš„è¨‚é–±ï½œBookWide</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#f4f6fb;
      --card:#fff;
      --ink:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --brand:#2563eb;
      --radius:16px;
      --shadow:0 10px 30px rgba(15,23,42,.08);
    }
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;
      background:var(--bg);
      color:var(--ink);
    }
    .wrap{max-width:960px;margin:40px auto;padding:0 16px;}
    h1{margin:0 0 24px 0;}
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:20px;
      margin-bottom:24px;
    }
    .muted{color:var(--muted);}
    table{width:100%;border-collapse:collapse;margin-top:8px;}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top;}
    th{font-weight:600;color:#374151;}
    .btn{
      display:inline-block;
      background:var(--brand);
      color:#fff;
      padding:10px 16px;
      border-radius:10px;
      text-decoration:none;
      margin-top:12px;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
    .pill{
      display:inline-flex;align-items:center;
      padding:6px 10px;border-radius:999px;
      background:#eef2ff;color:#1e40af;
      font-size:13px;
    }
    .danger{color:#b91c1c;}
    code{background:#f3f4f6;padding:2px 6px;border-radius:6px;}
  </style>
</head>

<body>
  <div class="wrap">
    <h1>æˆ‘çš„è¨‚é–±</h1>

    <div class="card">
      <h3>ç›®å‰è¨‚é–±</h3>
      <div id="currentSub" class="muted">è®€å–ä¸­â€¦</div>
      <div id="debugBox" class="muted" style="margin-top:10px; display:none;"></div>
    </div>

    <div class="card">
      <h3>æ­·å²è¨‚å–®</h3>
      <table>
        <thead>
          <tr>
            <th style="width:180px;">æ™‚é–“</th>
            <th>æ–¹æ¡ˆ</th>
            <th style="width:140px;">é‡‘é¡</th>
          </tr>
        </thead>
        <tbody id="historyBody">
          <tr><td colspan="3" class="muted">è®€å–ä¸­â€¦</td></tr>
        </tbody>
      </table>
    </div>

    <a href="/pricing.html" class="btn">å‰å¾€è¨‚é–±</a>
  </div>

<script>
  // âœ… ä½ çš„å°ˆæ¡ˆè³‡è¨Š
  const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";

  // âœ… ä¸è¦ç”¨ const supabase = supabase...ï¼ˆæœƒè¦†è“‹å…¨åŸŸï¼‰
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $current = document.getElementById("currentSub");
  const $history = document.getElementById("historyBody");
  const $debug = document.getElementById("debugBox");

  function money(n){
    if (n === null || n === undefined) return "-";
    const v = Number(n);
    if (Number.isNaN(v)) return String(n);
    return "NT$ " + v.toLocaleString();
  }

  function formatItems(items){
    // items å¯èƒ½æ˜¯é™£åˆ—ï¼Œä¹Ÿå¯èƒ½æ˜¯å­—ä¸²ï¼ˆçœ‹ä½  insert æ™‚æ€å¯«ï¼‰
    if (!items) return [];
    if (Array.isArray(items)) return items.map(String);
    if (typeof items === "string") {
      // å˜—è©¦è§£æåƒ '["story","music"]'
      try {
        const j = JSON.parse(items);
        if (Array.isArray(j)) return j.map(String);
      } catch (e) {}
      // é€€è€Œæ±‚å…¶æ¬¡ï¼šä»¥é€—è™Ÿåˆ†
      return items.split(",").map(s => s.trim()).filter(Boolean);
    }
    return [String(items)];
  }

  function safeTime(row){
    // ä½  orders è¡¨å¯èƒ½æœ‰ created_at / paid_atï¼›æ²’æœ‰å°±é¡¯ç¤º "-"
    const t = row.paid_at || row.created_at || row.updated_at;
    if (!t) return "-";
    try { return new Date(t).toLocaleString(); } catch(e){ return String(t); }
  }

  function pickTotal(row){
    // ä½ çš„è¡¨æœ‰ total / subtotal / unit_price*quantity éƒ½å¯èƒ½
    if (row.total != null) return row.total;
    if (row.subtotal != null) return row.subtotal;
    if (row.unit_price != null && row.quantity != null) return Number(row.unit_price) * Number(row.quantity);
    return null;
  }

  (async () => {
    // 1) å¿…é ˆå…ˆæœ‰ç™»å…¥ sessionï¼ˆä½ ç¶²ç«™æœ¬ä¾†å°±æœ‰ç™»å…¥ï¼‰
    const { data: { user }, error: userErr } = await sb.auth.getUser();

    if (userErr) {
      $current.innerHTML = `<span class="danger">è®€å–ç™»å…¥è³‡è¨Šå¤±æ•—</span>`;
      $debug.style.display = "block";
      $debug.innerHTML = `auth.getUser() error: <code>${userErr.message}</code>`;
      $history.innerHTML = `<tr><td colspan="3" class="muted">å°šç„¡è³‡æ–™</td></tr>`;
      return;
    }

    if (!user) {
      $current.innerHTML = `å°šæœªç™»å…¥ï¼ˆè«‹å…ˆç™»å…¥å†æŸ¥çœ‹è¨‚é–±ï¼‰`;
      $history.innerHTML = `<tr><td colspan="3" class="muted">å°šç„¡è³‡æ–™</td></tr>`;
      return;
    }

    // 2) è®€ ordersï¼šåªæ’ˆä½ è¡¨è£¡ç¢ºå®šå­˜åœ¨çš„æ¬„ä½
    //    ä½ æˆªåœ–æ¬„ä½ï¼šid, user_id, items, period, unit_price, quantity, subtotal, discount, total, ref_code
    const { data: orders, error } = await sb
      .from("orders")
      .select("id,user_id,items,period,unit_price,quantity,subtotal,discount,total,ref_code,created_at,paid_at,updated_at")
      .eq("user_id", user.id)
      .order("created_at", { ascending: false, nullsFirst: false });

    if (error) {
      // âœ… é€™è£¡å¦‚æœçœ‹åˆ° "permission denied" å°±æ˜¯ä½ æ²’åšä¸Šé¢ RLS policy
      $current.innerHTML = `<span class="danger">è®€å–å¤±æ•—</span>`;
      $debug.style.display = "block";
      $debug.innerHTML = `orders select error: <code>${error.message}</code><br/>
        ğŸ‘‰ è‹¥çœ‹åˆ° permission denied / RLSï¼Œè«‹å…ˆåˆ° SQL Editor åŠ ä¸Š orders_select_own policyã€‚`;
      $history.innerHTML = `<tr><td colspan="3" class="muted">å°šç„¡è³‡æ–™</td></tr>`;
      return;
    }

    if (!orders || orders.length === 0) {
      $current.textContent = "å°šç„¡è¨‚é–±ç´€éŒ„";
      $history.innerHTML = `<tr><td colspan="3" class="muted">å°šç„¡è³‡æ–™</td></tr>`;
      return;
    }

    // 3) ç›®å‰è¨‚é–±ï¼šå…ˆç”¨ã€Œæœ€æ–°ä¸€ç­†ã€ç•¶ä½œç›®å‰ï¼ˆä½ ç›®å‰æ²’æœ‰ expire_at/status çš„æƒ…æ³ä¸‹åªèƒ½é€™æ¨£ï¼‰
    const latest = orders[0];
    const items = formatItems(latest.items);
    const total = pickTotal(latest);

    $current.innerHTML = `
      <div><b>${latest.period || "æ–¹æ¡ˆ"}</b></div>
      <div class="row">
        ${items.length ? items.map(x => `<span class="pill">${x}</span>`).join("") : `<span class="muted">ï¼ˆç„¡é …ç›®ï¼‰</span>`}
      </div>
      <div style="margin-top:10px;" class="muted">
        è¨‚å–®IDï¼š<code>${String(latest.id).slice(0,8)}â€¦</code><br/>
        æ™‚é–“ï¼š${safeTime(latest)}<br/>
        é‡‘é¡ï¼š<b>${money(total)}</b>
      </div>
    `;

    // 4) æ­·å²è¨‚å–®è¡¨
    $history.innerHTML = orders.map(o => {
      const its = formatItems(o.items);
      const t = pickTotal(o);
      return `
        <tr>
          <td>${safeTime(o)}</td>
          <td>
            <div><b>${o.period || "-"}</b></div>
            <div class="row">
              ${its.length ? its.map(x => `<span class="pill">${x}</span>`).join("") : `<span class="muted">ï¼ˆç„¡é …ç›®ï¼‰</span>`}
            </div>
            ${o.ref_code ? `<div class="muted" style="margin-top:6px;">æ¨è–¦ç¢¼ï¼š<code>${o.ref_code}</code></div>` : ``}
          </td>
          <td>${money(t)}</td>
        </tr>
      `;
    }).join("");
  })();
</script>
</body>
</html>






