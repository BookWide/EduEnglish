<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>我的訂閱｜BookWide</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#f4f6fb;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --brand:#2563eb;
      --danger:#b91c1c;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",sans-serif;
      background:var(--bg);
      color:var(--ink);
    }
    a{text-decoration:none;color:inherit}
    .wrap{max-width:1100px;margin:28px auto;padding:0 18px}
    h1{margin:0 0 18px 0;font-size:34px}
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:20px;
    }
    .pill{
      padding:8px 14px;
      background:#fff;
      border-radius:999px;
      box-shadow:0 6px 16px rgba(15,23,42,.08);
      font-size:14px;
    }
    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:22px;
      margin-bottom:22px;
      box-shadow:0 10px 30px rgba(15,23,42,.08);
    }
    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px 40px;
      font-size:16px;
    }
    .label{color:var(--muted)}
    .value{font-weight:600}
    .danger{color:var(--danger)}
    .btns{
      margin-top:18px;
      display:flex;
      gap:12px;
    }
    .btn{
      padding:10px 18px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:15px;
    }
    .btn.primary{background:var(--brand);color:#fff}
    .btn.dark{background:#0b1220;color:#fff}
    table{
      width:100%;
      border-collapse:collapse;
      font-size:15px;
    }
    th,td{
      padding:14px 8px;
      border-bottom:1px solid var(--line);
      text-align:left;
    }
    th{color:var(--muted);font-weight:600}
    td.amount{text-align:right;font-weight:700}
    .empty{color:var(--muted);padding:18px 0}
  </style>
</head>
<body>

<div class="wrap">

  <div class="topbar">
    <a class="pill" href="/index.html">← 回首頁</a>
    <div class="pill" id="userInfo">載入中…</div>
  </div>

  <h1>我的訂閱</h1>

  <!-- 目前訂閱 -->
  <div class="card" id="currentCard">
    <h2>目前訂閱</h2>
    <div class="row" id="currentInfo">
      <div class="label">狀態：</div><div class="value">載入中…</div>
    </div>
    <div class="btns">
      <a class="btn primary" href="/pricing.html">前往訂閱</a>
      <a class="btn dark" href="/player.html">免費試看：Going Back Home</a>
    </div>
  </div>

  <!-- 歷史訂單 -->
  <div class="card">
    <h2>歷史訂單</h2>
    <table>
      <thead>
        <tr>
          <th>付款日期</th>
          <th>方案</th>
          <th style="text-align:right">金額</th>
        </tr>
      </thead>
      <tbody id="orderList">
        <tr><td colspan="3" class="empty">載入中…</td></tr>
      </tbody>
    </table>
  </div>

</div>

<script>
/* ========= Supabase ========= */
const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
const SUPABASE_ANON_KEY = "你的 anon key";

const supabase = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* ========= Utils ========= */
function fmtDate(ts){
  if(!ts) return '-';
  const d = new Date(ts);
  return d.toLocaleString('zh-TW',{
    year:'numeric',month:'2-digit',day:'2-digit',
    hour:'2-digit',minute:'2-digit'
  });
}
function fmtAmount(cents){
  return 'NT$ ' + Math.round((cents||0)/100).toLocaleString();
}

/* ========= Main ========= */
(async ()=>{
  const { data:{ user } } = await supabase.auth.getUser();
  if(!user){
    location.href='/index.html#login';
    return;
  }

  document.getElementById('userInfo').textContent =
    `${user.email} · ${user.id.slice(0,8)}`;

  const { data:orders, error } = await supabase
    .from('orders')
    .select(`
      id,
      status,
      created_at,
      paid_at,
      expire_at,
      subtotal_cents,
      period
    `)
    .eq('user_id', user.id)
    .order('created_at', { ascending:false });

  if(error){
    document.getElementById('orderList').innerHTML =
      `<tr><td colspan="3" class="empty">${error.message}</td></tr>`;
    return;
  }

  if(!orders || orders.length===0){
    document.getElementById('orderList').innerHTML =
      `<tr><td colspan="3" class="empty">尚無任何訂單</td></tr>`;
    return;
  }

  /* ===== 目前訂閱（第一筆） ===== */
  const cur = orders[0];
  document.getElementById('currentInfo').innerHTML = `
    <div class="label">狀態：</div>
    <div class="value ${cur.status!=='paid'?'danger':''}">${cur.status}</div>

    <div class="label">付款日期：</div>
    <div class="value">${fmtDate(cur.paid_at ?? cur.created_at)}</div>

    <div class="label">訂單 ID：</div>
    <div class="value">${cur.id}</div>

    <div class="label">金額：</div>
    <div class="value">${fmtAmount(cur.subtotal_cents)}</div>

    <div class="label">到期日期：</div>
    <div class="value">${fmtDate(cur.expire_at)}</div>
  `;

  /* ===== 歷史訂單 ===== */
  const tbody = document.getElementById('orderList');
  tbody.innerHTML = '';

  orders.forEach(o=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${fmtDate(o.paid_at ?? o.created_at)}</td>
      <td>${o.status}${o.expire_at?'':'（無到期日）'}</td>
      <td class="amount">${fmtAmount(o.subtotal_cents)}</td>
    `;
    tbody.appendChild(tr);
  });
})();
</script>

</body>
</html>
















