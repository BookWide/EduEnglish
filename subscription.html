<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>我的訂閱｜BookWide</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#f4f6fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --brand:#2563eb; --brand2:#1d4ed8; --soft:#eff6ff;
      --danger:#b91c1c; --ok:#065f46;
      --radius:18px; --shadow:0 10px 30px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:22px 16px 60px;}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px;}
    .pill{display:inline-flex;align-items:center;gap:10px;background:#fff;border:1px solid var(--line);border-radius:999px;padding:10px 14px;box-shadow:0 4px 16px rgba(15,23,42,.05);}
    .btn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:10px 14px;
      cursor:pointer;
      font-weight:700;
    }
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff;}
    .btn.primary:hover{background:var(--brand2)}
    .btn.dark{background:#111827;border-color:#111827;color:#fff;}
    h1{font-size:44px;letter-spacing:.02em;margin:10px 0 18px;}
    .grid{display:grid;grid-template-columns:1fr;gap:16px;}
    .card{
      background:var(--card);
      border:1px solid rgba(229,231,235,.85);
      border-radius:28px;
      box-shadow:var(--shadow);
      padding:22px 22px;
    }
    .card h2{margin:0 0 10px;font-size:20px}
    .tag{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:6px 10px;
      font-weight:800;
      color:var(--muted);
      margin-left:10px;
      font-size:13px;
    }
    .status{font-weight:900}
    .status.pending{color:var(--danger)}
    .status.active{color:var(--ok)}
    .kv{display:grid;grid-template-columns:120px 1fr;gap:8px 12px;max-width:720px;}
    .k{color:var(--muted)}
    .v{font-weight:800}
    .actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:14px;}
    .hr{height:1px;background:var(--line);margin:16px 0;}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:12px 10px;border-top:1px solid var(--line);text-align:left;vertical-align:top;}
    th{color:var(--muted);font-size:13px;font-weight:900;}
    td{font-weight:700}
    .right{text-align:right}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-weight:700;color:var(--muted);font-size:12px;}
    .hint{color:var(--muted);font-size:13px;line-height:1.6}
    .warn{
      margin-top:12px;
      background:#fff1f2;
      border:1px solid #fecdd3;
      color:#9f1239;
      border-radius:16px;
      padding:12px 14px;
      font-weight:800;
      display:none;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <button class="pill btn" id="btnHome">← 回首頁</button>

      <div class="pill" id="userPill">
        <span id="userEmail">—</span>
        <span class="mono" id="userUid">—</span>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
        <button class="pill btn" id="btnLogout">登出</button>
        <button class="pill btn" id="btnBack">回上一頁 →</button>
      </div>
    </div>

    <h1>我的訂閱</h1>

    <div class="grid">
      <div class="card">
        <h2>目前訂閱 <span class="tag" id="tagState">讀取中</span></h2>

        <div class="kv">
          <div class="k">狀態：</div>
          <div class="v"><span class="status pending" id="curStatus">—</span></div>

          <div class="k">付款日期：</div>
          <div class="v" id="curPaidAt">—</div>

          <div class="k">訂單ID：</div>
          <div class="v mono" id="curOrderId">—</div>

          <div class="k">金額：</div>
          <div class="v" id="curAmount">—</div>

          <div class="k">到期日期：</div>
          <div class="v" id="curExpireAt">—</div>

          <div class="k">下單帳號：</div>
          <div class="v" id="curEmailTo">—</div>
        </div>

        <div class="actions">
          <button class="btn primary" id="btnGoSubscribe">前往訂閱</button>
          <button class="btn dark" id="btnFreeTry">免費試看：Going Back Home</button>
        </div>

        <div class="warn" id="warnBox"></div>
        <div class="mono" style="margin-top:10px" id="authUidLine">auth uid: —</div>
      </div>

      <div class="card">
        <h2>歷史訂單</h2>
        <div class="hint">只顯示你自己的 orders（依 user_id）。會優先顯示 paid，再顯示 pending。</div>

        <div class="hr"></div>

        <table>
          <thead>
            <tr>
              <th style="width:160px">付款日期</th>
              <th style="width:140px">狀態</th>
              <th style="width:180px">方案</th>
              <th>到期</th>
              <th class="right" style="width:120px">金額</th>
            </tr>
          </thead>
          <tbody id="ordersTbody">
            <tr><td colspan="5" class="hint">讀取中…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  // ✅ 你的 Supabase 設定（不要再留空）
  const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = (id)=>document.getElementById(id);

  function qs(name){
    return new URL(location.href).searchParams.get(name);
  }

  function fmtMoney(cents){
    const n = Math.round((Number(cents||0))/100);
    return "NT$ " + n.toLocaleString("en-US");
  }

  function fmtDate(s){
    if(!s) return "-";
    try{
      const d = new Date(s);
      if(isNaN(d.getTime())) return String(s);
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const HH = String(d.getHours()).padStart(2,'0');
      const MI = String(d.getMinutes()).padStart(2,'0');
      return `${yy}-${mm}-${dd} ${HH}:${MI}`;
    }catch(e){
      return String(s);
    }
  }

  function setWarn(msg){
    const box = $("warnBox");
    if(!msg){ box.style.display="none"; box.textContent=""; return; }
    box.style.display="block";
    box.textContent = msg;
  }

  function setTag(text, ok){
    const t = $("tagState");
    t.textContent = text;
    t.style.color = ok ? "var(--ok)" : "var(--muted)";
    t.style.borderColor = ok ? "rgba(6,95,70,.25)" : "var(--line)";
    t.style.background = ok ? "rgba(6,95,70,.06)" : "#fff";
  }

  function planLabel(period){
    if(period==="year") return "year";
    if(period==="half") return "half";
    if(period==="month") return "month";
    return period || "-";
  }

  async function requireUser(){
    const { data, error } = await supabase.auth.getUser();
    if(error || !data?.user){
      location.href = "/index.html?denied=signin";
      return null;
    }
    return data.user;
  }

  async function load(){
    setWarn("");
    setTag("讀取中", false);

    const user = await requireUser();
    if(!user) return;

    $("userEmail").textContent = user.email || "-";
    $("userUid").textContent = "· " + (user.id ? user.id.slice(0,8) : "-");
    $("authUidLine").textContent = "auth uid: " + user.id;

    // 1) 先抓 subscriptions（如果你表有這筆，就直接用）
    let subRow = null;
    try{
      const { data, error } = await supabase
        .from("subscriptions")
        .select("*")
        .eq("user_id", user.id)
        .order("updated_at", { ascending:false })
        .limit(1);
      if(!error && data && data.length) subRow = data[0];
    }catch(e){}

    // 2) 再抓 orders（你目前畫面 pending，就是靠 orders）
    let orders = [];
    let ordersErr = null;
    try{
      const { data, error } = await supabase
        .from("orders")
        .select("id,status,period,total_cents,paid_at,expire_at,created_at,email_to,merchant_trade_no")
        .eq("user_id", user.id)
        .order("created_at", { ascending:false })
        .limit(50);
      if(error) ordersErr = error;
      orders = data || [];
    }catch(e){
      ordersErr = { message: String(e) };
    }

    // ---- 歷史訂單表 ----
    const tb = $("ordersTbody");
    tb.innerHTML = "";
    if(ordersErr){
      tb.innerHTML = `<tr><td colspan="5" class="hint">讀取 orders 失敗：${ordersErr.message || ordersErr}</td></tr>`;
    }else if(!orders.length){
      tb.innerHTML = `<tr><td colspan="5" class="hint">沒有任何訂單</td></tr>`;
    }else{
      // 排序：paid 優先，再 pending
      const sortScore = (o)=> (o.status==="paid"?0:(o.status==="pending"?1:2));
      const rows = [...orders].sort((a,b)=> sortScore(a)-sortScore(b));
      for(const o of rows){
        const status = o.status || "-";
        const paidAt = o.paid_at ? fmtDate(o.paid_at) : "-";
        const exp = o.expire_at ? fmtDate(o.expire_at) : "-";
        const amount = fmtMoney(o.total_cents);
        const per = planLabel(o.period);
        tb.insertAdjacentHTML("beforeend", `
          <tr>
            <td>${paidAt}</td>
            <td><span class="status ${status==="paid"?"active":"pending"}">${status}</span></td>
            <td>${per} ${o.expire_at ? "" : "( 無到期日 )"}</td>
            <td>${exp}</td>
            <td class="right">${amount}</td>
          </tr>
        `);
      }
    }

    // ---- 目前訂閱顯示 ----
    // 取「有效的 active 訂閱」：先用 subscriptions，其次用 paid order
    const now = Date.now();

    const subActive = subRow && (subRow.status==="active") && subRow.expire_at && (new Date(subRow.expire_at).getTime() > now);

    const paidOrders = orders.filter(o=>o.status==="paid");
    const paidValid = paidOrders.find(o=> o.expire_at && (new Date(o.expire_at).getTime() > now)) || paidOrders[0] || null;

    const pendingOrders = orders.filter(o=>o.status==="pending");
    const latestPending = pendingOrders[0] || null;

    let cur = null;
    let curStateTag = "無資料";
    let curOk = false;

    if(subActive){
      cur = {
        status: "active",
        paid_at: subRow.paid_at || null,
        expire_at: subRow.expire_at || null,
        total_cents: subRow.total_cents || null,
        period: subRow.period || null,
        id: subRow.order_id || subRow.id || null,
        email_to: user.email || null,
      };
      curStateTag = "已啟用";
      curOk = true;
    }else if(paidValid){
      cur = paidValid;
      curStateTag = "已付款";
      curOk = true;
    }else if(latestPending){
      cur = latestPending;
      curStateTag = "待付款";
      curOk = false;
    }

    setTag(curStateTag, curOk);

    if(!cur){
      $("curStatus").textContent = "尚無訂閱紀錄";
      $("curStatus").className = "status pending";
      $("curPaidAt").textContent = "-";
      $("curOrderId").textContent = "-";
      $("curAmount").textContent = "-";
      $("curExpireAt").textContent = "-";
      $("curEmailTo").textContent = user.email || "-";
      return;
    }

    const st = (cur.status || "-");
    $("curStatus").textContent = st;
    $("curStatus").className = "status " + (st==="paid" || st==="active" ? "active" : "pending");

    $("curPaidAt").textContent = cur.paid_at ? fmtDate(cur.paid_at) : "-";
    $("curOrderId").textContent = cur.id || "-";
    $("curAmount").textContent = fmtMoney(cur.total_cents);
    $("curExpireAt").textContent = cur.expire_at ? fmtDate(cur.expire_at) : "-";
    $("curEmailTo").textContent = (cur.email_to || subRow?.email_to || user.email || "-");

    // 如果你確定「綠界已付款成功」但這裡仍顯示 pending
    // 代表 ecpay-return 沒把 orders 更新成 paid，或 orders.user_id 不是這個 auth uid
    if(st==="pending"){
      setWarn("目前仍是 pending：代表 orders 還沒被 ecpay-return 更新成 paid（或此筆訂單 user_id 不是當前登入 uid）。");
    }
  }

  // Buttons
  $("btnHome").onclick = ()=> location.href = "/index.html";
  $("btnBack").onclick = ()=> history.back();
  $("btnGoSubscribe").onclick = ()=>{
    // 你原本的 flow：pricing -> checkout
    location.href = "/pricing.html";
  };
  $("btnFreeTry").onclick = ()=> location.href = "/player.html?category=story&slug=going-back-home";
  $("btnLogout").onclick = async ()=>{
    await supabase.auth.signOut();
    location.href = "/index.html";
  };

  load();
</script>
</body>
</html>














