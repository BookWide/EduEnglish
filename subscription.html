<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>我的訂閱｜BookWide</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#f4f6fb;
  --card:#ffffff;
  --ink:#111827;
  --muted:#6b7280;
  --line:#e5e7eb;
  --brand:#2563eb;
}
body{
  margin:0;
  background:var(--bg);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans TC",sans-serif;
  color:var(--ink);
}
.wrap{max-width:1100px;margin:0 auto;padding:32px}
h1{font-size:36px;margin:0 0 24px}
.card{
  background:var(--card);
  border-radius:20px;
  padding:24px;
  margin-bottom:24px;
}
.row{display:flex;justify-content:space-between;margin:8px 0}
.label{color:var(--muted)}
.value{font-weight:600}
.status-pending{color:#b91c1c}
.status-paid{color:#065f46}
.table{width:100%;border-collapse:collapse}
.table th,.table td{
  padding:14px;
  border-bottom:1px solid var(--line);
  text-align:left;
}
.amount{text-align:right;font-weight:700}
</style>
</head>

<body>
<div class="wrap">
  <h1>我的訂閱</h1>

  <!-- 目前訂閱 -->
  <div class="card">
    <h2>目前訂閱</h2>
    <div id="current">載入中…</div>
  </div>

  <!-- 歷史訂單 -->
  <div class="card">
    <h2>歷史訂單</h2>
    <table class="table">
      <thead>
        <tr>
          <th>付款日期</th>
          <th>狀態</th>
          <th class="amount">金額</th>
        </tr>
      </thead>
      <tbody id="history"></tbody>
    </table>
  </div>
</div>

<script>
const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_ANON_KEY"; // 你原本那支

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

(async ()=>{
  const { data:{ user }, error } = await sb.auth.getUser();
  if (!user) {
    document.getElementById("current").innerHTML = "尚未登入";
    return;
  }

  /* ===============================
     目前訂閱（只抓最新 paid）
  =============================== */
  const { data: current } = await sb
    .from("orders")
    .select("paid_at, expire_at, total_cents, period")
    .eq("user_id", user.id)
    .eq("status", "paid")
    .order("paid_at", { ascending:false })
    .limit(1)
    .maybeSingle();

  const currentBox = document.getElementById("current");

  if (!current) {
    currentBox.innerHTML = `<div class="row">
      <div class="label">狀態</div>
      <div class="value status-pending">尚未訂閱</div>
    </div>`;
  } else {
    currentBox.innerHTML = `
      <div class="row"><div class="label">狀態</div><div class="value status-paid">已啟用</div></div>
      <div class="row"><div class="label">付款日期</div><div class="value">${fmt(current.paid_at)}</div></div>
      <div class="row"><div class="label">到期日期</div><div class="value">${fmt(current.expire_at)}</div></div>
      <div class="row"><div class="label">金額</div><div class="value">NT$ ${Math.round(current.total_cents/100)}</div></div>
      <div class="row"><div class="label">帳號</div><div class="value">${user.email}</div></div>
    `;
  }

  /* ===============================
     歷史訂單（排除 pending）
  =============================== */
  const { data: history } = await sb
    .from("orders")
    .select("paid_at, status, total_cents")
    .eq("user_id", user.id)
    .in("status", ["paid","failed"])
    .order("created_at", { ascending:false });

  const tbody = document.getElementById("history");
  tbody.innerHTML = "";

  history?.forEach(o=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${fmt(o.paid_at)}</td>
      <td>${o.status}</td>
      <td class="amount">NT$ ${Math.round(o.total_cents/100)}</td>
    `;
    tbody.appendChild(tr);
  });
})();

function fmt(v){
  if(!v) return "-";
  const d = new Date(v);
  return d.toLocaleString("zh-TW");
}
</script>
</body>
</html>















