<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BookWide Admin · 上傳自動化＋字幕＋機翻 · v20251106-auto</title>
  <script type="module" src="./supa.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <style>
    :root{ --bg:#ffffff; --fg:#111; --muted:#6b7280; --muted-2:#9ca3af; --line:#e5e7eb; --brand:#2563eb; --chip:#eef2ff; --ok:#16a34a; --warn:#f59e0b; --card:#fafafa; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","PingFang TC","Noto Sans CJK TC","微軟正黑體",sans-serif}
    header{padding:18px 20px;border-bottom:1px solid var(--line);display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .title{font-size:22px;font-weight:700;margin-right:auto}
    .chip{display:inline-block;padding:.35rem .6rem;border-radius:999px;background:var(--chip);color:var(--brand);font-size:12px}
    .wrap{max-width:1120px;margin:24px auto;padding:0 16px}
    .row{display:grid;gap:12px} .grid-2{grid-template-columns:1fr 1fr} .grid-3{grid-template-columns:1fr 1fr 1fr}
    @media (max-width:820px){ .grid-2,.grid-3{grid-template-columns:1fr} }
    .input, select{border:1px solid var(--line);border-radius:10px;padding:.55rem .8rem;background:#fff}
    .btn{border:1px solid var(--brand);background:var(--brand);color:#fff;border-radius:10px;padding:.55rem .9rem;cursor:pointer}
    .btn.outline{background:#fff;color:var(--brand)}
    .table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
    .muted{color:var(--muted)} .hint{color:var(--muted-2);font-size:13px}
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px}
    .drop{border:2px dashed var(--line);border-radius:12px;padding:18px;text-align:center;background:#fff}
    .progress{height:10px;background:#eef2ff;border-radius:99px;overflow:hidden}
    .bar{height:100%;width:0;background:#2563eb;transition:width .2s}
    code{background:#f6f8fa;border:1px solid #eaeef2;border-radius:6px;padding:2px 6px}
    footer{padding:22px 20px;color:var(--muted);border-top:1px solid var(--line);text-align:center;margin-top:28px}
  </style>
</head>
<body>
  <header>
    <div class="title">BookWide Admin 主控台</div>
    <span class="chip">字幕支援 · TXT/SRT/VTT/JSON · 自動中文/日文（簡易/機翻）</span>
  </header>

  <main class="wrap">
    <section id="panel-mp4">
      <div class="card">
        <h3 style="margin:6px 0 14px">MP4 上傳自動化＋字幕（三語同檔）</h3>

        <div class="row grid-3">
          <div><label class="muted">分類</label>
            <select id="cat" class="input">
              <option value="story">story</option>
              <option value="music" selected>music</option>
              <option value="movie">movie</option>
              <option value="news">news</option>
              <option value="pro">pro</option>
            </select>
          </div>
          <div><label class="muted">Slug（不含空白與副檔名）</label><input id="slug" class="input" placeholder="alittlelove"></div>
          <div><label class="muted">顯示標題（可空）</label><input id="title" class="input" placeholder="A Little Love"></div>
        </div>

        <div class="row grid-3" style="margin-top:12px">
          <div>
            <label class="muted">MP4 檔</label>
            <div id="drop" class="drop">
              <input id="mp4File" type="file" accept="video/mp4" style="display:none">
              <div>將檔案拖曳到此處，或 <button id="picker" class="btn outline" type="button">選擇檔案</button></div>
              <div id="chosen" class="hint" style="margin-top:6px">尚未選檔</div>
              <div class="progress" style="margin-top:8px"><div id="bar" class="bar"></div></div>
            </div>
          </div>
          <div><label class="muted">封面（可選）</label><input id="coverFile" type="file" accept="image/*" class="input"></div>
          <div><label class="muted">字幕檔（可選）</label><input id="captionFile" type="file" accept=".srt,.vtt,.json,.txt" class="input"></div>
        </div>

        <div class="row grid-3" style="margin-top:12px">
          <div><label class="muted">公開狀態</label>
            <select id="isPublic" class="input"><option value="true">公開</option><option value="false">非公開</option></select>
          </div>
          <div style="display:flex;align-items:flex-end;gap:10px">
            <label class="hint" style="display:flex;align-items:center;gap:6px">
              <input id="autoAlign" type="checkbox" checked> 自動對齊字幕（吸附靜音）
            </label>
            <label class="hint" style="display:flex;align-items:center;gap:6px">
              <input id="autoMT" type="checkbox"> 自動產生中文/日文
            </label>
            <span class="hint" style="display:flex;align-items:center;gap:6px">
              模式：<input type="radio" name="mtMode" id="mtSimple" value="simple" checked> 簡易
              <input type="radio" name="mtMode" id="mtEdge" value="edge"> 機翻(Edge)
            </span>
            <span class="hint" style="display:flex;align-items:center;gap:6px">
              Function 名稱：<input id="mtFuncName" class="input" style="width:160px" placeholder="mt-translate">
            </span>
          </div>
          <div style="display:flex;align-items:flex-end">
            <span class="hint">影片路徑：<code>videos/{category}/{slug}.mp4</code>；封面：<code>assets/{category}/{slug}/cover.jpg</code></span>
          </div>
        </div>

        <div class="row grid-3" style="margin-top:12px">
          <div class="hint">對齊參數：門檻 <code id="p-th">0.008</code> · 靜音≧ <code id="p-sil">0.25s</code> · 吸附窗口 ±<code id="p-win">1.5s</code></div>
          <div style="display:flex;gap:8px;align-items:center">
            <label class="muted">RMS 門檻</label><input id="th" class="input" type="number" step="0.0001" value="0.008" style="width:110px">
            <label class="muted">最短靜音</label><input id="sil" class="input" type="number" step="0.05" value="0.25" style="width:110px">
            <label class="muted">窗口(±s)</label><input id="win" class="input" type="number" step="0.1" value="1.5" style="width:110px">
          </div>
        </div>

        <div class="row grid-3" style="margin-top:12px">
          <div style="display:flex;align-items:flex-end;gap:10px">
            <button id="btnUpload" class="btn">上傳並寫入資料表</button>
            <a id="zipLink" class="btn outline" href="#" download style="display:none">下載 JSON ZIP</a>
            <button id="btnPreviewJson" class="btn outline" type="button">預覽 JSON（5 件）</button>
            <button id="btnUploadGitHub" class="btn outline" type="button">上傳到 GitHub</button>
          </div>
        </div>

        <div id="previewPanel" class="card" style="display:none;margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:600">JSON 預覽</div>
            <button id="btnClosePreview" class="btn outline" type="button">關閉</button>
          </div>
          <div id="previewBody" style="margin-top:10px;max-height:380px;overflow:auto;font-family:ui-monospace,Consolas,Menlo,monospace;font-size:13px;white-space:pre"></div>
        </div>

        <div class="row grid-3" style="margin-top:12px">
          <div class="card" style="grid-column:1 / -1">
            <div style="font-weight:600;margin-bottom:8px">GitHub 上傳設定（僅本機暫存，不會保存）</div>
            <div class="row grid-3">
              <div><label class="muted">Owner</label><input id="ghOwner" class="input" placeholder="bookwide"></div>
              <div><label class="muted">Repo</label><input id="ghRepo" class="input" placeholder="EduEnglish"></div>
              <div><label class="muted">Branch</label><input id="ghBranch" class="input" placeholder="main"></div>
            </div>
            <div class="row grid-3" style="margin-top:10px">
              <div><label class="muted">Base Path（可留空）</label><input id="ghBasePath" class="input" placeholder="（例如 data/ 或 留空）"></div>
              <div><label class="muted">Commit 訊息</label><input id="ghMessage" class="input" placeholder="Add JSON templates"></div>
              <div><label class="muted">GitHub Token</label><input id="ghToken" class="input" type="password" placeholder="ghp_xxx（Fine-grained 建議）"></div>
            </div>
            <div style="margin-top:8px" class="hint">使用 GitHub Contents API 直接建立/更新檔案。Token 僅用於這次操作，不會保存。</div>
          </div>
        </div>

        <div class="hint" style="margin-top:12px">就緒。</div><div id="upMsg" class="muted">就緒。</div>
      </div>
    </section>
  </main>

  <footer>BookWide Admin · 內嵌 Supabase 版 · v20251106-auto</footer>

  <script type="module">
    const ready = () => new Promise(function(r){ if (window.BW && window.BW.supa) return r(); const t = setInterval(function(){ if(window.BW && window.BW.supa){clearInterval(t); r();}},50); });
    await ready();
    await BW.requireAdmin();
    BW.startHeartbeat(2);
    const supa = BW.supa;

    const $ = (q,root)=> (root||document).querySelector(q);
    const fmtTW = ts => !ts?'':new Date(ts).toLocaleString('zh-TW',{timeZone:'Asia/Taipei',hour12:false});

    const drop = $('#drop'); const picker = $('#picker'); const mp4Input=$('#mp4File'); const chosen=$('#chosen');
    const bar = $('.bar'); const btnUpload = $('#btnUpload'); const upMsg = $('#upMsg'); const zipLink = $('#zipLink');

    drop.addEventListener('dragover',e=>{ e.preventDefault(); drop.classList.add('drag'); });
    drop.addEventListener('dragleave',()=> drop.classList.remove('drag'));
    drop.addEventListener('drop',e=>{ e.preventDefault(); drop.classList.remove('drag'); const f=e.dataTransfer.files&&e.dataTransfer.files[0]; if(f){ mp4Input.files=e.dataTransfer.files; reflectChoose(); }});
    picker.addEventListener('click',()=> mp4Input.click());
    mp4Input.addEventListener('change', reflectChoose);
    function reflectChoose(){
      const f=mp4Input.files&&mp4Input.files[0];
      if(!f){ chosen.textContent='尚未選檔'; return; }
      chosen.textContent = f.name+' · '+(f.size/1024/1024).toFixed(2)+' MB';
      if(!$('#slug').value){ const base=f.name.replace(/\.mp4$/i,'').replace(/\s+/g,'-').toLowerCase(); $('#slug').value=base.slice(0,80); }
    }
    function setBar(p){ bar.style.width = Math.max(3, Math.min(100, p)) + '%'; }

    async function getVideoDuration(file){
      return new Promise(function(resolve){
        const v=document.createElement('video'); v.preload='metadata';
        v.onloadedmetadata=function(){ resolve(Math.round(v.duration||0)); URL.revokeObjectURL(v.src); };
        v.onerror=function(){ resolve(0); }; v.src=URL.createObjectURL(file);
      });
    }
    async function ensureFolder(bucket, pathLike){
      try{ await supa.storage.from(bucket).list(pathLike); return true; }catch(e){ return true; }
    }

    // ===== Caption parse: SRT/VTT/JSON/TXT =====
    window.captionsCues = null; // {time,en,ja,zh}[]
    const capInput = $('#captionFile');
    capInput.addEventListener('change', async ()=>{
      const f = capInput.files && capInput.files[0];
      if(!f) return;
      const name = (f.name||'').toLowerCase();
      try{
        if(name.endsWith('.json')){
          const obj = JSON.parse(await f.text());
          if(Array.isArray(obj)) window.captionsCues = obj.map(x=>({time: x.time||'00:00', en:x.en||'', ja:x.ja||'', zh:x.zh||''}));
        }else if(name.endsWith('.srt') || name.endsWith('.vtt')){
          const txt = await f.text();
          const blocks = txt.replace(/\r/g,'').split(/\n{2,}/);
          const cues=[];
          function pickLang(lines){
            let en='', zh='';
            for(const line of lines){
              if(/[\u4e00-\u9fff]/.test(line)) zh = zh? (zh+' '+line): line;
              else if(/[A-Za-z]/.test(line)) en = en? (en+' '+line): line;
            }
            return {en, zh};
          }
          for(const b of blocks){
            const lines = b.split('\n').filter(Boolean);
            const timeLine = lines.find(l=>/-->/i.test(l));
            if(!timeLine) continue;
            const m = timeLine.match(/(\d{2}:\d{2}:\d{2}[,\.]\d{3})\s*-->\s*(\d{2}:\d{2}:\d{2}[,\.]\d{3})/);
            const s = m? m[1] : '00:00:00,000';
            const mmss = s.slice(3,8);
            const textLines = lines.slice(lines.indexOf(timeLine)+1);
            const {en, zh} = pickLang(textLines);
            cues.push({ time:mmss, en:en||'', ja:'', zh:zh||'' });
          }
          window.captionsCues = cues;
          upMsg.textContent = `✅ 解析字幕：${cues.length} 句`;
        }else if(name.endsWith('.txt')){
          const txt = await f.text();
          const lines = txt.split(/[\r\n]+/).map(s=>s.trim()).filter(Boolean);
          const cues=[]; let sec=0, span=4;
          const mmss = s => { s=Math.max(0,Math.round(s)); const m=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${m}:${ss}`; };
          for(let i=0;i<lines.length;i+=2){ const en=lines[i]||'', zh=lines[i+1]||''; cues.push({time:mmss(sec), en, ja:'', zh}); sec+=span; }
          window.captionsCues = cues;
          upMsg.textContent = `✅ 已從 TXT 成功轉成 ${cues.length} 句字幕`;
        }
      }catch(e){ console.warn('caption parse error', e); upMsg.textContent='字幕檔解析失敗'; }
    });

    // ===== Audio alignment (optional) =====
    async function fetchAudioBuffer(url){
      const ctx = new (window.AudioContext||window.webkitAudioContext)({sampleRate:44100});
      const r = await fetch(url, {mode:'cors'}); const b = await r.arrayBuffer();
      return await ctx.decodeAudioData(b);
    }
    function energyEnvelope(buf, frameSize, hop){
      frameSize = frameSize||1024; hop = hop||256;
      const ch = buf.getChannelData(0);
      const frames = Math.max(0, Math.floor((ch.length - frameSize) / hop));
      const env = new Float32Array(frames);
      for(let i=0;i<frames;i++){ let sum=0; for(let j=0;j<frameSize;j++){ const v = ch[i*hop+j]; sum += v*v; } env[i]=Math.sqrt(sum/frameSize); }
      return {"env": env, "tStep": hop / buf.sampleRate};
    }
    function detectSilences(env, tStep, thresh, minSil){
      thresh = (typeof thresh==='number')?thresh:0.008; minSil = (typeof minSil==='number')?minSil:0.25;
      const minFrames = Math.max(1, Math.floor(minSil / tStep)); const segs=[]; let run=-1;
      for(let i=0;i<env.length;i++){ if(env[i]<thresh){ if(run<0) run=i; } else if(run>=0){ const len=i-run; if(len>=minFrames) segs.push({"s":run*tStep,"e":i*tStep}); run=-1; } }
      if(run>=0){ const i=env.length; const len=i-run; if(len>=minFrames) segs.push({"s":run*tStep,"e":i*tStep}); }
      return segs;
    }
    function snapToSilence(cues, silences, win){
      win = (typeof win==='number')?win:1.5;
      function nearStart(t){ let best=null,d=Infinity; for(const s of silences){ const dd=Math.abs(t-s.s); if(dd<d && dd<=win){ d=dd; best=s; } } return best; }
      function nearEnd(t){ let best=null,d=Infinity; for(const s of silences){ const dd=Math.abs(t-s.e); if(dd<d && dd<=win){ d=dd; best=s; } } return best; }
      const out=cues.map(function(c){ return {"s":c.s,"e":c.e,"t":c.t}; });
      for(const c of out){ const sSil=nearEnd(c.s); const eSil=nearStart(c.e); if(sSil) c.s=Math.max(0,sSil.e); if(eSil) c.e=Math.max(c.s+0.05,eSil.s); }
      for(let i=1;i<out.length;i++){ if(out[i].s<out[i-1].e) out[i].s=out[i-1].e; if(out[i].e<=out[i].s) out[i].e=out[i].s+0.05; }
      return out;
    }
    function secToMMSS(sec){ sec=Math.max(0,Math.round(sec)); const m=String(Math.floor(sec/60)).padStart(2,'0'); const s=String(sec%60).padStart(2,'0'); return `${m}:${s}`; }
    function buildSegments(durationSec){ const total=20, span=Math.max(2,Math.floor((durationSec||120)/total)); const segs=[]; let t=0; for(let i=0;i<total;i++){ const s=t,e=s+span; segs.push({s,e,t:`第 ${String(i+1).padStart(2,'0')} 句（請編輯）`}); t=e; } return segs; }
    function segmentsToCues(segs){ return segs.map(c=>({ time: secToMMSS(c.s), en:"", ja:"", zh:c.t })); }

    // ===== MT helpers =====
    function __bw_simpleDict(target){
      const ZH = { "apple":"蘋果","round":"圓","red":"紅","juicy":"多汁","sweet":"甜","i":"我","love":"愛","you":"你","eat":"吃","little":"小","big":"大","smallest":"最小的","as":"像","me":"我" };
      const JA = { "apple":"リンゴ","round":"丸い","red":"赤い","juicy":"ジューシー","sweet":"甘い","i":"私","love":"愛する","you":"あなた","eat":"食べる","little":"小さい","smallest":"一番小さい","as":"のように","me":"私" };
      return target==="zh"? ZH : JA;
    }
    function __bw_simpleTranslateLine(en, target){
      if(!en) return "";
      const dict = __bw_simpleDict(target);
      const words = en.toLowerCase().replace(/[^a-z'\s]/g,' ').split(/\s+/).filter(Boolean);
      const mapped = words.map(w => dict[w] || null).filter(Boolean);
      if(mapped.length) return mapped.join(' ');
      return `※待翻: ${en}`;
    }
    function __bw_applySimpleMT(cues){
      for(const c of cues){
        if((!c.zh||!c.zh.trim()) && c.en) c.zh = __bw_simpleTranslateLine(c.en,"zh");
        if((!c.ja||!c.ja.trim()) && c.en) c.ja = __bw_simpleTranslateLine(c.en,"ja");
      }
      return cues;
    }
    async function __bw_applyEdgeMT(cues){
      try{
        const func = ($('#mtFuncName')?.value?.trim()) || 'mt-translate';
        const needZh=[], zhIdx=[], needJa=[], jaIdx=[];
        cues.forEach((c,i)=>{ if((!c.zh||!c.zh.trim())&&c.en){needZh.push(c.en); zhIdx.push(i);} if((!c.ja||!c.ja.trim())&&c.en){needJa.push(c.en); jaIdx.push(i);} });
        async function invoke(lines,target){
          if(!lines.length) return [];
          const { data, error } = await supa.functions.invoke(func, { body: { lines, target } });
          if(error) throw error;
          if(!data || !data.ok) throw new Error(data?.error||'mt failed');
          return data.data;
        }
        if(needZh.length){ const zh = await invoke(needZh,'zh'); zh.forEach((t,k)=>{ cues[zhIdx[k]].zh = t || cues[zhIdx[k]].zh || ""; }); }
        if(needJa.length){ const ja = await invoke(needJa,'ja'); ja.forEach((t,k)=>{ cues[jaIdx[k]].ja = t || cues[jaIdx[k]].ja || ""; }); }
      }catch(e){ console.warn('edge MT error', e); }
      return cues;
    }
    async function __bw_applyAutoMT(cues){
      const auto = $('#autoMT')?.checked;
      if(!auto) return cues;
      const mode = $('#mtEdge')?.checked ? 'edge' : 'simple';
      if(mode==='simple') return __bw_applySimpleMT(cues);
      try{
        upMsg.textContent='機翻中（Edge）…';
        const out = await __bw_applyEdgeMT(cues);
        upMsg.textContent='機翻完成';
        return out;
      }catch(e){
        upMsg.textContent='機翻失敗，改用簡易翻譯';
        return __bw_applySimpleMT(cues);
      }
    }

    // ===== JSON builders =====
    function pad2(n){ return n.toString().padStart(2,'0'); }
    function pick(arr, n){ const a=arr.slice(); const out=[]; while(out.length<n && a.length){ out.push(a.splice(Math.floor(Math.random()*a.length),1)[0]); } return out; }
    const BANK = { commonVocab: [{"word":"apple","pos":"n.","zh":"蘋果","en":"a round fruit","example":"I eat an apple."},{"word":"sweet","pos":"adj.","zh":"甜的","en":"tasting like sugar","example":"The cake is sweet."},{"word":"song","pos":"n.","zh":"歌曲","en":"a piece of music with words","example":"This is my favorite song."},{"word":"love","pos":"v.","zh":"愛","en":"to like very much","example":"I love music."}],
      mcDistractors:["sun","star","cloud","tree","river","noodles","cheese","pepper","books","games","rainy","windy"] };
    function buildVocab(){ const words=BANK.commonVocab.slice(); return pick(words,20).map(x=>({ "word":x.word,"pos":x.pos,"zh":x.zh,"en":x.en,"sample":x.example||x.en })); }
    function makeMCQ(q, correct, wrongs){ const ch=pick(wrongs,3); ch.push(correct); for(let i=ch.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [ch[i],ch[j]]=[ch[j],ch[i]]; } return {"type":"mc","q":q,"choices":ch,"answer":ch.indexOf(correct)}; }
    function buildQuizFromVocab(vocab, title){
      const wrongs=BANK.mcDistractors.slice(), quiz=[];
      for(let i=0;i<20;i++){ const v=vocab[i%vocab.length]; quiz.push(makeMCQ('What is the meaning of "'+v.word+'"?', v.zh, wrongs)); }
      while(quiz.length<60){ quiz.push(makeMCQ("The song is very ____.","sweet",["cold","hard","late"])); }
      return quiz;
    }
    function buildAI(title){
      const prompts=["Describe the song.","What do you like about it?","Share your memory.","Who do you sing with?","How does it make you feel?"];
      return { title: title||"Lesson", topics: prompts.map((p,i)=>({ title:`Topic ${i+1}`, prompt:p, hint:"", sample:"" })) };
    }

    async function makeZipJson(opts){
      const {category, slug, title, publicVideoUrl, publicCoverUrl, durationSec} = opts;

      // cues: prefer uploaded captions; else build segments (uniform); then optional autoAlign; then autoMT
      let cues;
      if (window.captionsCues && Array.isArray(window.captionsCues)) {
        cues = window.captionsCues.map(c=>({ time:c.time||'00:00', en:c.en||'', ja:c.ja||'', zh:c.zh||'' }));
      } else {
        const segs = buildSegments(durationSec||0);
        cues = segmentsToCues(segs);
      }

      if ($('#autoAlign')?.checked && !window.captionsCues){
        try{
          const th = parseFloat($('#th').value||'0.008');
          const sil = parseFloat($('#sil').value||'0.25');
          const win = parseFloat($('#win').value||'1.5');
          const buf = await fetchAudioBuffer(publicVideoUrl);
          const o = energyEnvelope(buf);
          const sils = detectSilences(o.env, o.tStep, th, sil);
          const segs2 = snapToSilence(buildSegments(durationSec||0), sils, win);
          cues = segmentsToCues(segs2);
        }catch(e){ console.warn('auto-align failed', e); }
      }

      cues = await __bw_applyAutoMT(cues); // ★ apply MT if enabled

      const vocab = buildVocab();
      const quiz  = buildQuizFromVocab(vocab, title);
      const ai    = buildAI(title);

      const indexJson = {
        "title": title || slug,
        "category": category,
        "slug": slug,
        "video": publicVideoUrl,
        "cover": publicCoverUrl || null,
        "cues": { "zh": `./cues-${slug}.json`, "ja": `./cues-${slug}.json` },
        "vocab": `./vocab-${slug}.json`,
        "quiz":  `./quiz-${slug}.json`,
        "ai":    `./ai-${slug}.json`,
        "is_public": true
      };

      const zip   = new JSZip();
      const dir   = zip.folder(`data/${category}/${slug}`);
      dir.file(`index-${slug}.json`, JSON.stringify(indexJson,  null, 2));
      dir.file(`cues-${slug}.json`,  JSON.stringify(cues,       null, 2));
      dir.file(`vocab-${slug}.json`, JSON.stringify(vocab,      null, 2));
      dir.file(`quiz-${slug}.json`,  JSON.stringify(quiz,       null, 2));
      dir.file(`ai-${slug}.json`,    JSON.stringify(ai,         null, 2));

      window.__lastJsons = { dir: `data/${category}/${slug}/`, indexName:`index-${slug}.json`, cuesName:`cues-${slug}.json`, vocabName:`vocab-${slug}.json`, quizName:`quiz-${slug}.json`, aiName:`ai-${slug}.json`, indexJson, cuesHouyi:cues, vocab, quiz, ai };

      const blob = await zip.generateAsync({type:"blob"});
      return URL.createObjectURL(blob);
    }
    window.makeZipJson = makeZipJson;

    // ===== Preview & GitHub upload =====
    async function showPreview(){
      const p = $('#previewPanel'); const body = $('#previewBody');
      if(!window.__lastJsons){ upMsg.textContent='尚未產生 JSON；請先完成上傳並等待「下載 JSON ZIP」出現'; return; }
      const J = window.__lastJsons;
      const sections = [
        ['index', J.indexName, J.indexJson],
        ['cues',  J.cuesName,  J.cuesHouyi],
        ['vocab', J.vocabName, J.vocab],
        ['quiz',  J.quizName,  J.quiz],
        ['ai',    J.aiName,    J.ai]
      ];
      let out = 'DIR: '+J.dir+'\\n\\n';
      for(const [label,name,obj] of sections){
        out += '=== '+label+' — '+name+' ===\\n'+JSON.stringify(obj, null, 2)+'\\n\\n';
      }
      body.textContent = out;
      p.style.display='block';
    }
    function hidePreview(){ const p = $('#previewPanel'); if(p) p.style.display='none'; }

    async function ghGetSha(owner, repo, path, token, branch){
      const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`;
      const r = await fetch(url, { headers: { 'Authorization': token ? `Bearer ${token}` : undefined, 'Accept': 'application/vnd.github+json' } });
      if(r.status===200){ const j=await r.json(); return j.sha; }
      return null;
    }
    async function ghPutFile(owner, repo, branch, path, contentStr, token, message){
      const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
      const sha = await ghGetSha(owner, repo, path, token, branch);
      const b64 = btoa(unescape(encodeURIComponent(contentStr)));
      const payload = { message: message || `Add ${path}`, branch, content: b64 };
      if(sha) payload.sha = sha;
      const r = await fetch(url, {
        method: 'PUT',
        headers: {
          'Authorization': token ? `Bearer ${token}` : undefined,
          'Accept': 'application/vnd.github+json'
        },
        body: JSON.stringify(payload)
      });
      if(!r.ok){ throw new Error(`GitHub 上傳失敗 ${r.status}`); }
      return await r.json();
    }
    async function uploadAllToGitHub(){
      if(!window.__lastJsons){ upMsg.textContent='尚未產生 JSON；請先完成上傳並等待「下載 JSON ZIP」出現'; return; }
      const owner = $('#ghOwner').value.trim();
      const repo  = $('#ghRepo').value.trim();
      const branch= $('#ghBranch').value.trim() || 'main';
      const base  = ($('#ghBasePath').value||'').trim();
      const token = $('#ghToken').value.trim();
      const msg   = $('#ghMessage').value.trim() || 'Add JSON templates';
      if(!owner||!repo){ upMsg.textContent='請輸入 GitHub owner 與 repo'; return; }
      const baseDir = (base ? (base.endsWith('/')?base:base+'/') : '') + window.__lastJsons.dir;
      const J = window.__lastJsons;
      const entries = [
        [J.indexName, JSON.stringify(J.indexJson, null, 2)],
        [J.cuesName,  JSON.stringify(J.cuesHouyi, null, 2)],
        [J.vocabName, JSON.stringify(J.vocab, null, 2)],
        [J.quizName,  JSON.stringify(J.quiz, null, 2)],
        [J.aiName,    JSON.stringify(J.ai, null, 2)]
      ];
      upMsg.textContent='上傳到 GitHub 中…';
      for(const [name,content] of entries){
        const fullPath = baseDir + name;
        await ghPutFile(owner, repo, branch, fullPath, content, token, msg);
      }
      upMsg.innerHTML = '✅ 已上傳至 GitHub：<code>'+baseDir+'</code>';
    }

    $('#btnPreviewJson').addEventListener('click', showPreview);
    $('#btnClosePreview').addEventListener('click', hidePreview);
    $('#btnUploadGitHub').addEventListener('click', uploadAllToGitHub);

    // ===== Upload button main flow =====
    async function doUpload(){
      const cat=$('#cat').value.trim();
      const slug=$('#slug').value.trim();
      const title=$('#title').value.trim();
      const mp4=mp4Input.files && mp4Input.files[0];
      const cov=$('#coverFile').files[0];
      const isPublic=$('#isPublic').value==='true';
      if(!cat||!slug||!mp4){ upMsg.textContent='請選擇分類、輸入 slug 並選擇 MP4 檔'; return; }
      zipLink.style.display='none'; zipLink.removeAttribute('href');
      btnUpload.disabled=true; setBar(8); upMsg.textContent='開始上傳…';
      try{
        const mp4Rel=cat+'/'+slug+'.mp4'; const mp4Full='videos/'+mp4Rel;
        await ensureFolder('videos',cat);
        setBar(15);
        const up1=await supa.storage.from('videos').upload(mp4Rel,mp4,{"upsert":true,"contentType":"video/mp4"});
        if(up1.error) throw up1.error;
        setBar(55);
        let coverFull=null; if(cov){
          const rel=cat+'/'+slug+'/cover.jpg'; coverFull='assets/'+rel;
          await ensureFolder('assets',cat+'/'+slug);
          const up2=await supa.storage.from('assets').upload(rel,cov,{"upsert":true});
          if(up2.error) throw up2.error;
        }
        setBar(70);
        const duration=await getVideoDuration(mp4);
        const user=(await supa.auth.getUser()).data && (await supa.auth.getUser()).data.user || null;
        const rec={"category":cat,"slug":slug,"title":(title||null),"storage_path":mp4Full,"cover_path":coverFull,"size_bytes":mp4.size||null,"duration_sec":duration||null,"is_public":isPublic,"created_by":(user?user.id:null),"updated_at":new Date().toISOString()};
        const ins=await supa.from('videos').upsert(rec,{"onConflict":"category,slug"}).select('id').maybeSingle();
        if(ins.error) throw ins.error;
        setBar(85);
        const publicVideoUrl = supa.storage.url + '/object/public/' + mp4Full;
        const publicCoverUrl = coverFull ? (supa.storage.url + '/object/public/' + coverFull) : null;
        upMsg.textContent='產生 ZIP（含字幕與翻譯）…';
        const url = await makeZipJson({"category":cat, "slug":slug, "title":title, "publicVideoUrl":publicVideoUrl, "publicCoverUrl":publicCoverUrl, "durationSec": duration});
        zipLink.href = url; zipLink.download = cat+'-'+slug+'-templates.zip'; zipLink.style.display='inline-block';
        setBar(100);
        upMsg.innerHTML='✅ 完成！已上傳並寫入資料表<br>影片：<code>'+mp4Full+'</code>'+(coverFull?('；封面：<code>'+coverFull+'</code>'):'')+'<br>長度：'+(duration||0)+' 秒，大小：'+(mp4.size/1024/1024).toFixed(2)+' MB · <b>請點「下載 JSON ZIP」或「預覽/上傳 GitHub」</b>';
      }catch(err){ console.error(err); upMsg.textContent='上傳/寫入失敗：'+(err && (err.message||err)); setBar(0); }
      finally{ btnUpload.disabled=false; }
    }
    btnUpload.addEventListener('click', doUpload);
  </script>
</body>
</html>
