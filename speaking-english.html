<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Speaking JSON æ¸¬è©¦å™¨</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f172a;
      --border:#24324f;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --brand:#3b82f6;
      --ok:#22c55e;
      --bad:#ef4444;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#070b14);color:var(--text);
      font-family:system-ui,-apple-system,"Segoe UI","Noto Sans TC","Microsoft JhengHei",sans-serif;}
    .wrap{max-width:1200px;margin:18px auto 72px;padding:0 14px;}
    header{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;margin-bottom:12px;}
    h1{font-size:18px;margin:0;letter-spacing:.2px}
    .sub{font-size:12px;color:var(--muted);margin-top:3px;line-height:1.5}
    .row{display:grid;grid-template-columns:minmax(0,1.15fr) minmax(0,0.85fr);gap:12px;align-items:start;}
    @media (max-width:980px){.row{grid-template-columns:1fr;}}
    .panel{background:rgba(15,23,42,.78);border:1px solid var(--border);border-radius:var(--radius);
      box-shadow:0 18px 40px rgba(0,0,0,.35);overflow:hidden;}
    .panel-h{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;
      justify-content:space-between;gap:10px;flex-wrap:wrap}
    .panel-b{padding:12px;}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{border:1px solid var(--border);background:#0b1430;color:var(--text);border-radius:999px;
      padding:7px 12px;font-size:12px;cursor:pointer;transition:transform .08s ease,border-color .15s ease}
    .btn:hover{transform:translateY(-1px);border-color:#35507f}
    .btn.primary{background:rgba(59,130,246,.18);border-color:rgba(59,130,246,.45)}
    .btn.good{background:rgba(34,197,94,.16);border-color:rgba(34,197,94,.45)}
    .btn.warn{background:rgba(245,158,11,.16);border-color:rgba(245,158,11,.45)}
    .btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
    .chip{font-size:11px;color:#cbd5e1;border:1px solid var(--border);
      background:rgba(17,24,39,.35);padding:5px 10px;border-radius:999px}
    input[type="text"]{width:340px;max-width:100%;padding:8px 10px;border-radius:12px;border:1px solid var(--border);
      background:#0b1430;color:var(--text);outline:none;font-size:12px}
    input[type="file"]{font-size:12px;color:var(--muted)}
    .list{max-height:68vh;overflow:auto}
    .item{border-top:1px solid rgba(36,50,79,.7);padding:10px 12px;display:grid;grid-template-columns:92px 1fr;
      gap:10px;cursor:pointer}
    .item:hover{background:rgba(59,130,246,.06)}
    .item.active{background:rgba(59,130,246,.12)}
    .t{font-family:var(--mono);font-size:11px;color:#a7b3cc}
    .en{font-size:13px;line-height:1.45}
    .hint{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.45}
    .meta{font-size:11px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .divider{height:1px;background:rgba(36,50,79,.7);margin:10px 0}
    .big{font-size:16px;line-height:1.4;margin:0}
    .label{font-size:11px;color:var(--muted);margin-bottom:6px}
    .box{background:rgba(11,20,48,.7);border:1px solid var(--border);border-radius:14px;padding:10px}
    .box pre{margin:0;font-family:var(--mono);font-size:11px;color:#cbd5e1;white-space:pre-wrap;word-break:break-word;line-height:1.45}
    .status{font-size:12px;color:var(--muted)}
    .status.ok{color:var(--ok)}
    .status.bad{color:var(--bad)}
    .grid2{display:grid;grid-template-columns:1fr;gap:10px}
    .toggle{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .toggle label{font-size:12px;color:var(--muted)}
    select{padding:7px 10px;border-radius:12px;border:1px solid var(--border);
      background:#0b1430;color:var(--text);font-size:12px;outline:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Speaking JSON æ¸¬è©¦å™¨ï¼ˆshadow / chunkingï¼‰</h1>
        <div class="sub">
          ç”¨ä¾†é©—è­‰ <code style="font-family:var(--mono);font-size:12px">speaking-*.json</code> æ˜¯å¦èƒ½æ­£ç¢ºè®€å–ã€é€å¥æ’­æ”¾ã€ä»¥åŠæŒ‰æ™‚é–“è‡ªå‹•å‰é€²ã€‚<br/>
          ä½ çš„æª”æ¡ˆæ ¼å¼ç¤ºä¾‹ï¼š<code style="font-family:var(--mono);font-size:12px">slug/category/source_url/items[t0,t1,line_en,coach]</code>
        </div>
      </div>
      <div class="chip" id="chip">æœªè¼‰å…¥</div>
    </header>

    <div class="row">
      <section class="panel">
        <div class="panel-h">
          <div class="controls">
            <button class="btn primary" id="btnPrev">â—€ ä¸Šä¸€å¥</button>
            <button class="btn primary" id="btnNext">ä¸‹ä¸€å¥ â–¶</button>
            <button class="btn good" id="btnSpeak">ğŸ”Š æœ—è®€</button>
            <button class="btn warn" id="btnAuto">â± è‡ªå‹•</button>
          </div>
          <div class="controls">
            <span class="status" id="status">è«‹è¼‰å…¥ speaking JSON</span>
          </div>
        </div>
        <div class="panel-b" style="padding:0">
          <div class="list" id="list"></div>
        </div>
      </section>

      <aside class="panel">
        <div class="panel-h">
          <div class="controls">
            <input id="src" type="text" placeholder="è¼¸å…¥ JSON URLï¼ˆæˆ–ç›¸å°è·¯å¾‘ï¼‰ï¼Œä¾‹å¦‚ï¼š./speaking-english-idioms-2.json" />
            <button class="btn primary" id="btnLoad">è¼‰å…¥</button>
          </div>
          <div class="controls">
            <input id="file" type="file" accept=".json,application/json" />
          </div>
        </div>
        <div class="panel-b">
          <div class="grid2">
            <div class="box">
              <div class="label">ç›®å‰å¥å­</div>
              <p class="big" id="curEn">â€”</p>
              <div class="hint" id="curHint">â€”</div>
              <div class="meta" id="curMeta"></div>
            </div>

            <div class="box">
              <div class="toggle">
                <label>èªéŸ³ï¼ˆTTSï¼‰</label>
                <select id="voiceSel"></select>
                <label>é€Ÿåº¦</label>
                <select id="rateSel">
                  <option value="0.9">0.9</option>
                  <option value="1.0" selected>1.0</option>
                  <option value="1.1">1.1</option>
                  <option value="1.2">1.2</option>
                </select>
              </div>
              <div class="divider"></div>
              <div class="label">JSON ç‰‡æ®µï¼ˆdebugï¼‰</div>
              <pre id="debug">â€”</pre>
            </div>

            <div class="box">
              <div class="label">ç”¨é€”ï¼ˆä½ è¦æ¸¬ä»€éº¼ï¼‰</div>
              <pre>
1) æ˜¯å¦èƒ½è®€å…¥ speaking-*.json
2) items æ˜¯å¦æœ‰ t0/t1/time/line_en/coach.say/hint
3) é»ä»»ä¸€å¥ â†’ å³å´é¡¯ç¤º + å¯æœ—è®€
4) é–‹ã€Œè‡ªå‹•ã€â†’ ä¾ (t1 - t0) ç§’æ•¸è‡ªå‹•è·³ä¸‹ä¸€å¥
              </pre>
            </div>
          </div>
        </div>
      </aside>
    </div>

    <div style="margin-top:12px" class="sub">
      è‹¥ä½ è¦ã€Œæ›åœ¨ AI äº’å‹•å³é‚Šä½µé½Šã€ï¼šç”¨ iframe æœ€å¿«ã€‚ç¤ºä¾‹ï¼š<br/>
      <code style="font-family:var(--mono);font-size:12px">
        &lt;iframe src="speaking-english.html?src=./speaking-english-idioms-2.json" style="width:100%;height:740px;border:0;border-radius:16px"&gt;&lt;/iframe&gt;
      </code>
    </div>
  </div>

<script>
(() => {
  const $ = (q) => document.querySelector(q);
  const listEl = $('#list');
  const chip = $('#chip');
  const statusEl = $('#status');

  const btnPrev = $('#btnPrev');
  const btnNext = $('#btnNext');
  const btnSpeak = $('#btnSpeak');
  const btnAuto = $('#btnAuto');

  const srcInput = $('#src');
  const fileInput = $('#file');
  const btnLoad = $('#btnLoad');

  const curEn = $('#curEn');
  const curHint = $('#curHint');
  const curMeta = $('#curMeta');
  const debug = $('#debug');

  const voiceSel = $('#voiceSel');
  const rateSel = $('#rateSel');

  let doc = null;
  let items = [];
  let idx = 0;

  let autoOn = false;
  let autoTimer = null;

  function setStatus(msg, ok=true){
    statusEl.textContent = msg;
    statusEl.className = 'status ' + (ok ? 'ok' : 'bad');
  }

  function escapeHtml(s){
    return String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function renderList(){
    listEl.innerHTML = '';
    items.forEach((it, i) => {
      const div = document.createElement('div');
      div.className = 'item' + (i===idx ? ' active' : '');
      div.innerHTML = `
        <div class="t">${escapeHtml(it.time || '')}<br/><span style="opacity:.75">${it.t0 ?? ''}â€“${it.t1 ?? ''}</span></div>
        <div>
          <div class="en">${escapeHtml(it.line_en || '')}</div>
          <div class="meta">
            <span>goal: ${escapeHtml(it.coach?.goal || '')}</span>
            <span>drill: ${Array.isArray(it.coach?.drill) ? escapeHtml(it.coach.drill.join(',')) : ''}</span>
          </div>
        </div>
      `;
      div.addEventListener('click', () => go(i));
      listEl.appendChild(div);
    });
  }

  function setChip(){
    if (!doc){
      chip.textContent = 'æœªè¼‰å…¥';
      return;
    }
    chip.textContent = `slug: ${doc.slug || ''} Â· cat: ${doc.category || ''} Â· lines: ${items.length}`;
  }

  function stopAuto(){
    autoOn = false;
    if (autoTimer) clearTimeout(autoTimer);
    autoTimer = null;
    btnAuto.textContent = 'â± è‡ªå‹•';
  }

  function startAuto(){
    if (!items.length) return;
    autoOn = true;
    btnAuto.textContent = 'â± è‡ªå‹•ï¼ˆONï¼‰';
    scheduleAutoStep();
  }

  function scheduleAutoStep(){
    if (!autoOn) return;
    const it = items[idx];
    const dur = Math.max(1, (Number(it.t1) - Number(it.t0)) || 3);
    if (autoTimer) clearTimeout(autoTimer);
    autoTimer = setTimeout(() => { next(false); }, dur * 1000);
  }

  function go(i){
    if (!items.length) return;
    idx = Math.max(0, Math.min(items.length-1, i));
    renderList();

    const it = items[idx];
    curEn.textContent = it.line_en || 'â€”';
    curHint.textContent = it.coach?.hint || 'â€”';
    curMeta.innerHTML = `
      <span>t0: ${it.t0}</span>
      <span>t1: ${it.t1}</span>
      <span>time: ${escapeHtml(it.time || '')}</span>
      <span>source_url: ${escapeHtml(doc?.source_url || '')}</span>
    `;
    debug.textContent = JSON.stringify(it, null, 2);

    if (autoOn) scheduleAutoStep();
  }

  function prev(){
    stopAuto();
    go(idx-1);
  }

  function next(stop=true){
    if (!items.length) return;
    if (idx >= items.length-1){
      stopAuto();
      return;
    }
    if (stop) stopAuto();
    go(idx+1);
  }

  // ===== TTS =====
  function loadVoices(){
    const voices = window.speechSynthesis ? speechSynthesis.getVoices() : [];
    voiceSel.innerHTML = '';
    if (!voices.length){
      const opt = document.createElement('option');
      opt.textContent = 'ï¼ˆç­‰å¾… voiceâ€¦ï¼‰';
      voiceSel.appendChild(opt);
      return;
    }
    voices.forEach((v, i) => {
      const opt = document.createElement('option');
      opt.value = String(i);
      opt.textContent = `${v.name} (${v.lang})`;
      voiceSel.appendChild(opt);
    });
    const enIdx = voices.findIndex(v => /^en/i.test(v.lang));
    if (enIdx >= 0) voiceSel.value = String(enIdx);
  }

  if ('speechSynthesis' in window){
    loadVoices();
    speechSynthesis.onvoiceschanged = loadVoices;
  } else {
    const opt = document.createElement('option');
    opt.textContent = 'æ­¤ç€è¦½å™¨ä¸æ”¯æ´ TTS';
    voiceSel.appendChild(opt);
  }

  function speak(){
    if (!items.length || !('speechSynthesis' in window)) return;
    const it = items[idx];
    const text = (it.coach?.say || it.line_en || '').trim();
    if (!text) return;

    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);

    const voices = speechSynthesis.getVoices();
    const vi = parseInt(voiceSel.value || '0', 10);
    if (voices[vi]) u.voice = voices[vi];
    u.rate = parseFloat(rateSel.value || '1.0');
    speechSynthesis.speak(u);
  }

  // ===== Load JSON =====
  function validateSpeakingJson(obj){
    if (!obj || typeof obj !== 'object') return 'ä¸æ˜¯ç‰©ä»¶';
    if (!Array.isArray(obj.items)) return 'ç¼ºå°‘ items[]';
    const it = obj.items[0];
    if (!it) return 'items[] æ˜¯ç©ºçš„';
    if (it.line_en == null) return 'items[0].line_en ç¼ºå°‘';
    if (it.t0 == null || it.t1 == null) return 'items[0].t0/t1 ç¼ºå°‘';
    if (!it.coach || typeof it.coach !== 'object') return 'items[0].coach ç¼ºå°‘';
    return '';
  }

  async function loadFromUrl(url){
    const res = await fetch(url, { cache:'no-store' });
    if (!res.ok) throw new Error(`è®€å–å¤±æ•—ï¼š${res.status}`);
    const obj = await res.json();
    const err = validateSpeakingJson(obj);
    if (err) throw new Error('æ ¼å¼ä¸å°ï¼š' + err);
    doc = obj;
    items = obj.items || [];
    idx = 0;
    setChip();
    renderList();
    go(0);
    setStatus('å·²è¼‰å…¥ speaking JSON âœ…', true);
  }

  function loadFromObject(obj){
    const err = validateSpeakingJson(obj);
    if (err) throw new Error('æ ¼å¼ä¸å°ï¼š' + err);
    doc = obj;
    items = obj.items || [];
    idx = 0;
    setChip();
    renderList();
    go(0);
    setStatus('å·²è¼‰å…¥ speaking JSON âœ…', true);
  }

  btnPrev.addEventListener('click', prev);
  btnNext.addEventListener('click', () => next(true));
  btnSpeak.addEventListener('click', speak);
  btnAuto.addEventListener('click', () => {
    if (!items.length) return;
    if (autoOn) stopAuto();
    else startAuto();
  });

  btnLoad.addEventListener('click', async () => {
    stopAuto();
    const url = (srcInput.value || '').trim();
    if (!url) return;
    try{
      setStatus('è¼‰å…¥ä¸­â€¦', true);
      await loadFromUrl(url);
    }catch(e){
      console.error(e);
      setStatus(String(e.message || e), false);
    }
  });

  fileInput.addEventListener('change', () => {
    stopAuto();
    const f = fileInput.files && fileInput.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = () => {
      try{
        const obj = JSON.parse(String(r.result || ''));
        loadFromObject(obj);
      }catch(e){
        console.error(e);
        setStatus('è®€æª”å¤±æ•—ï¼š' + String(e.message || e), false);
      }
    };
    r.readAsText(f, 'utf-8');
  });

  // init: querystring ?src=
  const qs = new URLSearchParams(location.search);
  const qsrc = (qs.get('src') || '').trim();
  const defaultSrc = "./speaking-english-idioms-2.json";
  if (qsrc){
    srcInput.value = qsrc;
    btnLoad.click();
  } else if (defaultSrc){
    srcInput.value = defaultSrc;
  }
})();
</script>
</body>
</html>
