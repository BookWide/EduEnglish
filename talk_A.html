<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Talk Aï½œè²·ä¸€æ¯å’–å•¡</title>
<meta name="theme-color" content="#ffffff"/>

<style>
  :root{
    --bg:#ffffff;
    --ink:#0f172a;
    --muted:#64748b;
    --line:#e5e7eb;
    --card:#ffffff;
    --soft:#f8fafc;
    --soft2:#f1f5f9;
    --brand:#2563eb;
    --brand2:#1d4ed8;
    --ok:#16a34a;
    --warn:#f59e0b;
    --bad:#ef4444;
    --radius:18px;
    --shadow:0 18px 50px rgba(2,6,23,.08);
    --shadow2:0 10px 30px rgba(2,6,23,.08);
    --w: min(980px, calc(100vw - 28px));
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
    -webkit-font-smoothing:antialiased;
    text-rendering:optimizeLegibility;
  }
  a{color:inherit}
  .app{min-height:100%; display:flex; flex-direction:column; padding:14px 0 18px;}
  .wrap{width:var(--w); margin:0 auto;}
  .topbar{
    display:flex; align-items:center; justify-content:space-between;
    padding:10px 2px 12px;
  }
  .left{display:flex; align-items:center; gap:10px;}
  .back{
    width:40px; height:40px; border-radius:12px; border:1px solid var(--line);
    display:grid; place-items:center; background:#fff;
    box-shadow:0 8px 20px rgba(2,6,23,.06);
  }
  .back:active{transform:scale(.98)}
  .titlebox .kicker{font-size:12px; color:var(--muted)}
  .titlebox .title{font-size:16px; font-weight:800; letter-spacing:.2px; line-height:1.15}
  .right{display:flex; align-items:center; gap:10px;}
  .iconbtn{
    width:40px; height:40px; border-radius:12px; border:1px solid var(--line);
    display:grid; place-items:center; background:#fff;
  }
  .iconbtn:active{transform:scale(.98)}

  /* hero */
  .hero{
    display:grid;
    grid-template-columns: 1.05fr .95fr;
    gap:14px;
    align-items:stretch;
  }
  @media (max-width: 860px){
    .hero{grid-template-columns:1fr;}
  }
  .videoCard{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:22px;
    overflow:hidden;
    box-shadow:var(--shadow);
    display:flex;
    flex-direction:column;
    min-height:340px;
  }
  .videoWrap{position:relative; background:#0b1220;}
  video{width:100%; height:auto; display:block; background:#0b1220;}
  .badge{
    position:absolute; left:12px; top:12px;
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 10px;
    border-radius:999px;
    background:rgba(255,255,255,.92);
    border:1px solid rgba(229,231,235,.9);
    box-shadow:0 10px 25px rgba(2,6,23,.15);
    font-size:12px; color:var(--ink);
  }
  .badge .dot{width:8px;height:8px;border-radius:99px;background:var(--ok)}
  .videoFooter{
    display:flex; gap:10px; align-items:center; justify-content:space-between;
    padding:12px 14px;
    background:#fff;
  }
  .chipRow{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
  .chip{
    font-size:12px; color:var(--ink);
    padding:8px 10px; border-radius:999px;
    border:1px solid var(--line); background:var(--soft);
  }
  .chip b{font-weight:800}
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:10px 12px; border-radius:999px;
    background:linear-gradient(180deg,#fff, #f8fafc);
    border:1px solid var(--line);
  }
  .pill small{color:var(--muted)}

  /* chat card */
  .chatCard{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:22px;
    overflow:hidden;
    box-shadow:var(--shadow);
    display:flex; flex-direction:column;
    min-height:340px;
  }
  .chatHead{
    padding:14px 14px 12px;
    border-bottom:1px solid var(--line);
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .progress{
    height:10px; border-radius:999px; background:var(--soft2);
    overflow:hidden; flex:1;
  }
  .progress > i{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--brand),#60a5fa);}
  .stepText{font-size:12px; color:var(--muted); white-space:nowrap;}
  .chatBody{
    padding:14px;
    display:flex; flex-direction:column; gap:10px;
    overflow:auto;
    max-height: 420px;
  }
  .bubble{
    max-width:92%;
    padding:12px 12px;
    border-radius:18px;
    border:1px solid var(--line);
    background:var(--soft);
    box-shadow:0 10px 22px rgba(2,6,23,.04);
  }
  .bubble.ai{align-self:flex-start; border-top-left-radius:8px;}
  .bubble.user{align-self:flex-end; background:#111827; color:#fff; border-color:#111827; border-top-right-radius:8px;}
  .bubble .meta{font-size:11px; opacity:.85; margin-top:6px}
  .bubble .zh{margin-top:6px; font-size:13px; color:inherit; opacity:.92}
  .bubble.ai .zh{color:var(--muted)}
  .bubble.ai .meta{color:var(--muted)}
  .bubble.user .meta{color:rgba(255,255,255,.7)}
  .bubble.user .zh{color:rgba(255,255,255,.86)}

  .composer{
    border-top:1px solid var(--line);
    padding:12px 14px;
    background:#fff;
  }
  .inputRow{display:flex; gap:10px; align-items:center;}
  .textIn{
    flex:1;
    border:1px solid var(--line);
    border-radius:16px;
    padding:12px 12px;
    font-size:15px;
    outline:none;
    background:var(--soft);
  }
  .btn{
    border:1px solid var(--line);
    background:#fff;
    border-radius:16px;
    padding:12px 12px;
    font-weight:800;
    cursor:pointer;
  }
  .btn.primary{
    border-color:transparent;
    background:linear-gradient(180deg,var(--brand),var(--brand2));
    color:#fff;
    box-shadow:0 14px 28px rgba(37,99,235,.25);
  }
  .btn:active{transform:scale(.99)}
  .mic{
    width:54px; height:54px;
    border-radius:18px;
    border:1px solid var(--line);
    display:grid; place-items:center;
    background:linear-gradient(180deg,#fff,#f8fafc);
    box-shadow:0 14px 30px rgba(2,6,23,.08);
    cursor:pointer;
  }
  .mic.live{
    border-color:rgba(37,99,235,.55);
    box-shadow:0 0 0 6px rgba(37,99,235,.12), 0 18px 40px rgba(37,99,235,.12);
  }
  .hintRow{
    padding:10px 14px 0;
    display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    color:var(--muted); font-size:12px;
  }
  .hintRow .link{
    padding:7px 10px;
    border:1px solid var(--line);
    border-radius:999px;
    background:var(--soft);
    cursor:pointer;
  }

  /* modals */
  .mask{position:fixed; inset:0; background:rgba(2,6,23,.45); display:none; align-items:flex-end; justify-content:center; padding:14px; z-index:50;}
  .mask.show{display:flex;}
  .sheet{
    width:var(--w);
    background:#fff;
    border-radius:26px;
    box-shadow:0 40px 120px rgba(2,6,23,.28);
    border:1px solid rgba(229,231,235,.9);
    overflow:hidden;
  }
  .sheetHead{padding:14px 16px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--line);}
  .sheetHead h3{margin:0; font-size:16px}
  .sheetBody{padding:14px 16px; max-height:70vh; overflow:auto;}
  .tabs{display:flex; gap:10px; background:var(--soft2); padding:6px; border-radius:999px; border:1px solid var(--line);}
  .tab{flex:1; text-align:center; padding:10px 10px; border-radius:999px; font-weight:800; cursor:pointer; color:var(--muted)}
  .tab.on{background:#fff; color:var(--ink); box-shadow:0 10px 24px rgba(2,6,23,.07)}
  .exCard{border:1px solid var(--line); border-radius:18px; padding:12px; background:var(--soft); margin-top:12px;}
  .exTop{display:flex; align-items:center; justify-content:space-between; gap:10px;}
  .exEn{font-weight:900; font-size:16px;}
  .exZh{color:var(--muted); margin-top:6px}
  .row{display:flex; align-items:center; justify-content:space-between; gap:12px;}
  .small{color:var(--muted); font-size:12px}
  .kv{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
  .kv .k{padding:8px 10px; border-radius:999px; background:#fff; border:1px solid var(--line); font-size:12px}
  .divider{height:1px; background:var(--line); margin:14px 0}

  /* report */
  .report{display:none}
  .report.show{display:block}
  .stars{display:flex; gap:14px; justify-content:center; padding:18px 0 8px}
  .star{width:58px;height:58px; border-radius:18px; background:var(--soft); border:1px solid var(--line); display:grid; place-items:center; font-size:28px}
  .scoreGrid{display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-top:10px}
  .metric{
    border:1px solid var(--line); border-radius:18px; padding:12px;
    background:linear-gradient(180deg,#fff,#f8fafc);
  }
  .metric .n{font-size:30px; font-weight:900; letter-spacing:.2px}
  .metric .l{color:var(--muted); font-size:12px; margin-top:4px}
  .bigBtn{width:100%; padding:16px 14px; border-radius:18px; border:none; background:linear-gradient(180deg,var(--brand),var(--brand2)); color:#fff; font-weight:900; font-size:16px; cursor:pointer;}
  .ghostBtn{width:100%; padding:15px 14px; border-radius:18px; border:1px solid var(--line); background:#fff; color:var(--ink); font-weight:900; font-size:16px; cursor:pointer;}
  .footerPad{height:12px}
</style>
</head>
<body>
<div class="app">
  <div class="wrap">
    <div class="topbar">
      <div class="left">
        <button class="back" id="btnBack" aria-label="back">â†</button>
        <div class="titlebox">
          <div class="kicker">Talk A Â· A1 Â· Coffee Shop</div>
          <div class="title">è²·ä¸€æ¯å’–å•¡</div>
        </div>
      </div>
      <div class="right">
        <button class="iconbtn" id="btnExamples" title="ç¯„ä¾‹">â‰¡</button>
        <button class="iconbtn" id="btnSettings" title="è¨­å®š">âš™ï¸</button>
      </div>
    </div>

    <div class="hero" id="mainView">
      <!-- Video -->
      <section class="videoCard">
        <div class="videoWrap">
          <div class="badge"><span class="dot"></span> AI å°å¸« Â· CapCut å½±ç‰‡</div>
          <video id="teacherVideo" src="https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/talk/teacher/intro_coffee_shop.mp4" playsinline webkit-playsinline controls preload="metadata"></video>
        </div>
        <div class="videoFooter">
          <div class="chipRow">
            <span class="chip"><b>Mia</b> Â· Barista</span>
            <span class="chip">ç™½åº•é»‘å­— Â· å£èªªäº’å‹•</span>
          </div>
          <div class="pill">
            <span>ğŸ¯</span>
            <div>
              <div style="font-weight:900; font-size:12px;">ä»»å‹™ 3 é …</div>
              <small id="missionMini">é–‹å§‹å¾Œæœƒè‡ªå‹•å‹¾é¸</small>
            </div>
          </div>
        </div>
      </section>

      <!-- Chat -->
      <section class="chatCard">
        <div class="chatHead">
          <div class="progress" aria-label="progress"><i id="progBar"></i></div>
          <div class="stepText" id="stepText">æº–å‚™é–‹å§‹</div>
        </div>

        <div class="hintRow">
          <span class="link" id="btnStart">é–‹å§‹</span>
          <span class="link" id="btnHint">æç¤º</span>
          <span class="link" id="btnReplay">é‡æ’­è€å¸«</span>
          <span class="link" id="btnReset">é‡ä¾†</span>
        </div>

        <div class="chatBody" id="chatBody"></div>

        <div class="composer">
          <div class="inputRow">
            <button class="mic" id="btnMic" title="æŒ‰ä¸‹è¬›è©±">ğŸ¤</button>
            <input class="textIn" id="txtInput" placeholder="ä¹Ÿå¯ç›´æ¥æ‰“å­—ï¼ˆEnter é€å‡ºï¼‰" autocomplete="off" />
            <button class="btn primary" id="btnSend">é€å‡º</button>
          </div>
          <div class="small" style="margin-top:10px; display:flex; justify-content:space-between; gap:10px; align-items:center;">
            <span id="statusText">èªéŸ³ï¼šå¾…å‘½</span>
            <span id="toggleHideText" style="cursor:pointer; text-decoration:underline;">éš±è—æ–‡å­—ï¼ˆç·´è½åŠ›ï¼‰</span>
          </div>
        </div>
      </section>
    </div>

    <!-- Report -->
    <section class="chatCard report" id="reportView" style="margin-top:14px;">
      <div class="chatHead">
        <div style="font-weight:900">å­¸ç¿’å ±å‘Š</div>
        <div class="stepText" id="reportTitle">å¾ˆæ£’ï¼</div>
      </div>
      <div class="sheetBody">
        <div class="stars" id="starsRow"></div>
        <div style="text-align:center; font-weight:900; font-size:18px; margin-top:4px;">è²·ä¸€æ¯å’–å•¡</div>
        <div class="scoreGrid">
          <div class="metric"><div class="n" id="mRel">0<span style="font-size:16px">%</span></div><div class="l">ä¸»é¡Œç›¸é—œåº¦</div></div>
          <div class="metric"><div class="n" id="mPro">0<span style="font-size:16px">%</span></div><div class="l">ç™¼éŸ³ï¼ˆä¼°ç®—ï¼‰</div></div>
          <div class="metric"><div class="n" id="mWords">0</div><div class="l">ä½¿ç”¨çš„å–®å­—æ•¸</div></div>
        </div>

        <div class="divider"></div>

        <div class="metric" style="text-align:center">
          <div class="n" id="mComp">0</div>
          <div class="l">å®Œæ•´æ€§</div>
        </div>

        <div class="divider"></div>

        <div class="metric">
          <div style="font-weight:900; font-size:14px; margin-bottom:8px;">ä¸€å¥æ”¹é€²ï¼ˆAI ç³¾éŒ¯ï¼‰</div>
          <div class="small" id="oneFix" style="line-height:1.6"></div>
        </div>

        <div class="divider"></div>

        <button class="ghostBtn" id="btnTranscript">èŠå¤©è¨˜éŒ„</button>
        <div class="footerPad"></div>
        <button class="bigBtn" id="btnContinue">ç¹¼çºŒ</button>
      </div>
    </section>

  </div>
</div>

<!-- Examples Sheet -->
<div class="mask" id="exMask" role="dialog" aria-modal="true">
  <div class="sheet">
    <div class="sheetHead">
      <h3>ç¯„ä¾‹</h3>
      <button class="iconbtn" id="exClose">âœ•</button>
    </div>
    <div class="sheetBody">
      <div class="tabs" style="max-width:420px; margin:0 auto;">
        <div class="tab on" id="tabBasic">åŸºç¤</div>
        <div class="tab" id="tabAdv">é€²éš</div>
      </div>
      <div id="exList"></div>
      <div class="divider"></div>
      <div class="row">
        <div>
          <div style="font-weight:900">é—œéµå–®å­—</div>
          <div class="small">é»ä¸€ä¸‹æœƒæœ—è®€</div>
        </div>
        <button class="btn" id="btnSpeakVocab">æœ—è®€å…¨éƒ¨</button>
      </div>
      <div class="kv" id="vocabList"></div>
    </div>
  </div>
</div>

<!-- Settings Sheet -->
<div class="mask" id="setMask" role="dialog" aria-modal="true">
  <div class="sheet">
    <div class="sheetHead">
      <h3>è¨­å®š</h3>
      <button class="iconbtn" id="setClose">âœ•</button>
    </div>
    <div class="sheetBody">
      <div class="metric">
        <div style="font-weight:900">å°å¸«å›è¦†é¢¨æ ¼</div>
        <div class="small" style="margin-top:8px">è¼•é¬†èŠå¤©ï¼šä¸æ‰“æ–·ã€ä¸ç³¾éŒ¯ã€‚æ™ºèƒ½ç³¾éŒ¯ï¼šæº«å’ŒæŒ‡å‡º 1 å€‹é‡é»ã€‚</div>
        <div style="display:flex; gap:10px; margin-top:12px;">
          <button class="btn" id="styleRelax">è¼•é¬†èŠå¤©</button>
          <button class="btn primary" id="styleCorrect">æ™ºèƒ½ç³¾éŒ¯</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="metric">
        <div style="font-weight:900">å°å¸«é›£åº¦</div>
        <div class="small" style="margin-top:8px">ç°¡å–®ï¼šå¤šæç¤ºã€‚é€²éšï¼šæç¤ºè¼ƒå°‘ã€‚</div>
        <div style="display:flex; gap:10px; margin-top:12px;">
          <button class="btn primary" id="diffEasy">ç°¡å–®</button>
          <button class="btn" id="diffHard">é€²éš</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="metric">
        <div style="font-weight:900">èªé€Ÿ</div>
        <div class="small" style="margin-top:8px">0.75x ~ 1.25xï¼ˆå½±éŸ¿ TTSï¼‰</div>
        <input id="rate" type="range" min="0.75" max="1.25" step="0.05" value="1.0" style="width:100%; margin-top:12px"/>
        <div class="row" style="margin-top:10px"><div class="small">ç›®å‰</div><div style="font-weight:900" id="rateLabel">1.0x</div></div>
      </div>

      <div class="divider"></div>

      <div class="metric">
        <div class="row">
          <div>
            <div style="font-weight:900">éš±è—æ–‡å­—ï¼ˆç·´ç¿’è½åŠ›ï¼‰</div>
            <div class="small" style="margin-top:6px">é–‹å•Ÿå¾Œï¼Œå°è©±æ³¡æ³¡çš„æ–‡å­—æœƒè¢«é®ä½ã€‚</div>
          </div>
          <button class="btn" id="toggleHide">é—œ</button>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Transcript Sheet -->
<div class="mask" id="trMask" role="dialog" aria-modal="true">
  <div class="sheet">
    <div class="sheetHead">
      <h3>èŠå¤©è¨˜éŒ„</h3>
      <button class="iconbtn" id="trClose">âœ•</button>
    </div>
    <div class="sheetBody" id="trBody"></div>
  </div>
</div>

<script>
/* ========= Scenario Data (embedded) ========= */
const SCENARIO = {"id": "coffee_shop", "level": "A1", "title_zh": "è²·ä¸€æ¯å’–å•¡", "title_en": "Coffee Shop", "role": {"ai_name": "Mia", "ai_title": "Barista"}, "meta": {"missions": [{"id": 1, "text": "å‘Šè¨´åº—å“¡ä½ æƒ³é»ä¸€æ¯å’–å•¡ã€‚", "complete_on_step": "u2"}, {"id": 2, "text": "èªªæ˜æ¯å‹ / æ˜¯å¦åŠ å¥¶æˆ–ç³–ã€‚", "complete_on_step": "u6"}, {"id": 3, "text": "å®Œæˆä»˜æ¬¾èˆ‡æ”¶å°¾ã€‚", "complete_on_step": "u11"}], "examples": [{"en": "Can I get a black coffee, please?", "zh": "æˆ‘å¯ä»¥è¦ä¸€æ¯é»‘å’–å•¡å—ï¼Ÿ"}, {"en": "Iâ€™d like a latte, please.", "zh": "æˆ‘æƒ³è¦ä¸€æ¯æ‹¿éµã€‚"}, {"en": "Medium, please. No sugar.", "zh": "ä¸­æ¯ï¼Œè¬è¬ã€‚ä¸åŠ ç³–ã€‚"}], "key_vocab": [{"w": "coffee", "zh": "å’–å•¡", "note": "KAW-fee"}, {"w": "latte", "zh": "æ‹¿éµ", "note": "LAH-tay"}, {"w": "black", "zh": "é»‘å’–å•¡", "note": "ä¸åŠ å¥¶"}, {"w": "milk", "zh": "ç‰›å¥¶", "note": ""}, {"w": "sugar", "zh": "ç³–", "note": ""}, {"w": "small/medium/large", "zh": "å°/ä¸­/å¤§", "note": ""}]}, "dialogue": [{"id": "a1", "speaker": "AI", "en": "Welcome to our cafe! What would you like today?", "zh": "æ­¡è¿å…‰è‡¨ï¼ä»Šå¤©æƒ³å–ä»€éº¼ï¼Ÿ"}, {"id": "u2", "speaker": "USER", "hint_en": "Can I get a coffee, please?", "hint_zh": "æˆ‘å¯ä»¥è¦ä¸€æ¯å’–å•¡å—ï¼Ÿ"}, {"id": "a3", "speaker": "AI", "en": "Sure. Would you like it black or with milk?", "zh": "å¥½çš„ã€‚è¦é»‘å’–å•¡é‚„æ˜¯åŠ å¥¶ï¼Ÿ"}, {"id": "u4", "speaker": "USER", "hint_en": "Black, please.", "hint_zh": "é»‘å’–å•¡ï¼Œè¬è¬ã€‚"}, {"id": "a5", "speaker": "AI", "en": "What size would you like: small, medium, or large?", "zh": "è¦å°æ¯ã€ä¸­æ¯é‚„æ˜¯å¤§æ¯ï¼Ÿ"}, {"id": "u6", "speaker": "USER", "hint_en": "Medium, please. No sugar.", "hint_zh": "ä¸­æ¯ï¼Œè¬è¬ã€‚ä¸åŠ ç³–ã€‚"}, {"id": "a7", "speaker": "AI", "en": "Great. Anything else?", "zh": "å¥½çš„ã€‚é‚„éœ€è¦åˆ¥çš„å—ï¼Ÿ"}, {"id": "u8", "speaker": "USER", "hint_en": "Thatâ€™s all, thanks.", "hint_zh": "å°±é€™æ¨£ï¼Œè¬è¬ã€‚"}, {"id": "a9", "speaker": "AI", "en": "Your total is five dollars.", "zh": "ä¸€å…±äº”å…ƒã€‚"}, {"id": "u10", "speaker": "USER", "hint_en": "Here you go.", "hint_zh": "çµ¦ä½ ã€‚"}, {"id": "a11", "speaker": "AI", "en": "Thanks! Your coffee will be ready soon.", "zh": "è¬è¬ï¼å’–å•¡å¾ˆå¿«å°±å¥½ã€‚"}, {"id": "u12", "speaker": "USER", "hint_en": "Thank you!", "hint_zh": "è¬è¬ï¼"}], "feedback_tiers": [{"min": 0, "max": 39, "title": "å†è©¦ä¸€æ¬¡ä¹Ÿæ²’é—œä¿‚ ğŸ‘", "summary": "ä½ é‚„åœ¨ç†Ÿæ‚‰é»é¤æµç¨‹ï¼Œéƒ¨åˆ†å›ç­”æ²’æœ‰å®Œæˆä»»å‹™ã€‚", "metric_notes": {"relevance": "å›ç­”æœ‰å‡ºç¾ï¼Œä½†èˆ‡é»é¤æƒ…å¢ƒä¸å¤ è²¼åˆã€‚", "pronunciation": "é—œéµå–®å­—ä¸å¤ æ¸…æ¥šï¼ˆcoffee/latte/pleaseï¼‰ã€‚", "vocab": "å…ˆç”¨ç°¡å–®å¥å°±å¥½ï¼Œä¸ç”¨è¿½æ±‚å¤šå–®å­—ã€‚"}, "one_fix": {"original": "I want coffee.", "better": "Can I get a coffee, please?"}, "ai_message": "æ²’é—œä¿‚ï¼Œå¾ä¸€å¥é–‹å§‹ç·´å°±å¥½ï¼Œæˆ‘æœƒé™ªä½ ä¸€èµ·ä¾†ã€‚", "cta": "retry"}, {"min": 40, "max": 59, "title": "ä¸éŒ¯çš„é–‹å§‹ï¼", "summary": "ä½ å®Œæˆäº†éƒ¨åˆ†ä»»å‹™ï¼Œä½†è¡¨é”é‚„ä¸å¤ ç©©å®šã€‚", "metric_notes": {"relevance": "å¤§è‡´ç¬¦åˆé»é¤ï¼Œä½†æœ‰äº›å¥å­åèŠå¤©ã€‚", "pronunciation": "coffee / black / medium å†æ¸…æ¥šä¸€é»æœƒæ›´å¥½ã€‚", "vocab": "å¥å­å¯ä»¥æ›´çŸ­ã€æ›´ç›´æ¥ã€‚"}, "one_fix": {"original": "I want a coffee.", "better": "Can I get a black coffee, please?"}, "ai_message": "æ–¹å‘æ˜¯å°çš„ï¼æŠŠå¥å­èªªçŸ­ä¸€é»ï¼Œæœƒé€²æ­¥å¾ˆå¿«ã€‚", "cta": "practice_once_more"}, {"min": 60, "max": 74, "title": "åšå¾—ä¸éŒ¯ï¼", "summary": "ä½ å·²å®Œæˆä¸»è¦ä»»å‹™ï¼Œè¡¨é”å¤§è‡´è‡ªç„¶ã€‚", "metric_notes": {"relevance": "é»é¤æµç¨‹å®Œæ•´ã€‚", "pronunciation": "å¶æœ‰ä¸æ¸…æ¥šä½†ä¸å½±éŸ¿ç†è§£ã€‚", "vocab": "ç”¨å­—æ°ç•¶ã€‚"}, "one_fix": {"original": "I want a coffee.", "better": "Iâ€™d like a coffee, please."}, "ai_message": "ä½ å·²ç¶“èƒ½æ‡‰ä»˜é»é¤äº†ï¼Œä¸‹æ¬¡å°ˆæ³¨èªæ°£å°±æ›´è‡ªç„¶ã€‚", "cta": "next_or_advanced"}, {"min": 75, "max": 89, "title": "å¾ˆå¥½ï¼ğŸ‘", "summary": "ä½ çš„å°è©±è‡ªç„¶æµæš¢ï¼Œæ¥è¿‘æ¯èªä½¿ç”¨è€…ã€‚", "metric_notes": {"relevance": "å®Œå…¨è²¼åˆæƒ…å¢ƒã€‚", "pronunciation": "ç™¼éŸ³æ¸…æ¥šã€‚", "vocab": "ç”¨å­—å¾—é«”ã€‚"}, "one_fix": {"original": "Medium latte, no sugar.", "better": "Can I get a medium latte with no sugar, please?"}, "ai_message": "è¡¨ç¾å¾ˆå¥½ï¼ä½ å·²ç¶“å¯ä»¥åœ¨çœŸå¯¦æƒ…å¢ƒä¸­ä½¿ç”¨äº†ã€‚", "cta": "unlock_real"}, {"min": 90, "max": 100, "title": "å¤ªæ£’äº†ï¼ğŸŒŸ", "summary": "éå¸¸è‡ªç„¶ï¼Œå¹¾ä¹åƒæ¯èªè€…ã€‚", "metric_notes": {"relevance": "ä¸»é¡Œå®Œå…¨æŒæ¡ã€‚", "pronunciation": "ç™¼éŸ³è‡ªç„¶ã€‚", "vocab": "å¥å‹éˆæ´»ã€‚"}, "one_fix": {"original": "Give me a coffee.", "better": "Could I get a coffee when you have a moment?"}, "ai_message": "é€™æ¨£çš„è¡¨é”åœ¨åœ‹å¤–å®Œå…¨æ²’å•é¡Œï¼Œåšå¾—éå¸¸å¥½ï¼", "cta": "next"}]};

/* ========= Video ========= */
const VIDEO_URL = "https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/talk/teacher/intro_coffee_shop.mp4";

/* ========= State ========= */
let stepIndex = 0;
let dialogue = SCENARIO.dialogue || [];
let missions = (SCENARIO.meta && SCENARIO.meta.missions) ? SCENARIO.meta.missions : [];
let styleMode = "correct"; // relax | correct
let diffMode = "easy"; // easy | hard
let ttsRate = 1.0;
let hideText = false;

let metrics = {
  relevance: 0,
  pronunciation: 0, // heuristic
  words: 0,
  completeness: 0,
};
let userTurns = 0;
let transcript = []; // {speaker,en,zh,raw}

const $ = (id)=>document.getElementById(id);

/* ========= Helpers ========= */
function esc(s){
  return String(s||"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

function bubbleHTML({who,en,zh,meta}){
  const cls = who==="AI" ? "bubble ai" : "bubble user";
  const textMask = hideText ? "filter: blur(7px); user-select:none;" : "";
  const zhMask = hideText ? "filter: blur(6px); user-select:none;" : "";
  return `
    <div class="${cls}">
      <div style="${textMask}">${esc(en)}</div>
      ${zh ? `<div class="zh" style="${zhMask}">${esc(zh)}</div>` : ""}
      ${meta ? `<div class="meta">${esc(meta)}</div>` : ""}
    </div>`;
}

function renderFromTranscript(){
  const body = $("chatBody");
  body.innerHTML = "";
  const old = transcript.slice();
  transcript = [];
  old.forEach(x=>{
    pushBubble(x.speaker, x.en, x.zh, x.meta);
  });
  transcript = old; // restore to avoid duplication
  body.scrollTop = body.scrollHeight;
}

function pushBubble(who, en, zh, meta){
  const body = $("chatBody");
  body.insertAdjacentHTML("beforeend", bubbleHTML({who,en,zh,meta}));
  body.scrollTop = body.scrollHeight;
  transcript.push({speaker:who, en:en||"", zh:zh||"", meta:meta||""});
}

function setProgress(){
  const total = dialogue.length || 1;
  const pct = clamp((stepIndex / Math.max(1,(total-1))) * 100, 0, 100);
  $("progBar").style.width = pct + "%";
  $("stepText").textContent = `æ­¥é©Ÿ ${Math.min(stepIndex+1,total)} / ${total}`;
}

function currentTurn(){ return dialogue[stepIndex]; }
function findNextUserStep(startIdx){
  for(let i=startIdx;i<dialogue.length;i++) if(dialogue[i].speaker==="USER") return i;
  return -1;
}
function findNextAiStep(startIdx){
  for(let i=startIdx;i<dialogue.length;i++) if(dialogue[i].speaker==="AI") return i;
  return -1;
}

/* ========= TTS ========= */
function pickVoice(){
  const voices = window.speechSynthesis ? speechSynthesis.getVoices() : [];
  let v = voices.find(v=>/en-US|en_US|English \(United States\)/i.test(v.lang));
  if(!v) v = voices.find(v=>/^en/i.test(v.lang));
  return v || null;
}
function speak(text){
  if(!("speechSynthesis" in window)) return;
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  const v = pickVoice();
  if(v) u.voice = v;
  u.rate = ttsRate;
  u.pitch = 1.0;
  u.lang = "en-US";
  speechSynthesis.speak(u);
}

/* ========= Speech Recognition ========= */
let rec = null;
let listening = false;

function initASR(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR) return null;
  const r = new SR();
  r.lang = "en-US";
  r.interimResults = false;
  r.maxAlternatives = 1;
  return r;
}

function startListen(){
  if(!rec) {
    rec = initASR();
    if(!rec) {
      $("statusText").textContent = "èªéŸ³ï¼šæ­¤ç€è¦½å™¨ä¸æ”¯æ´ï¼ˆå¯æ”¹ç”¨æ‰“å­—ï¼‰";
      return;
    }
    rec.onresult = (ev)=>{
      const t = ev.results[0][0].transcript;
      stopListenUI();
      handleUserInput(t, true);
    };
    rec.onerror = ()=>{ stopListenUI(); };
    rec.onend = ()=>{ stopListenUI(); };
  }
  try {
    listening = true;
    $("btnMic").classList.add("live");
    $("statusText").textContent = "èªéŸ³ï¼šè†è½ä¸­â€¦";
    rec.start();
  } catch(e) {
    // ignore double start
  }
}
function stopListenUI(){
  listening = false;
  $("btnMic").classList.remove("live");
  $("statusText").textContent = "èªéŸ³ï¼šå¾…å‘½";
}

/* ========= Scoring (heuristic) ========= */
function wordList(s){
  return String(s||"").toLowerCase()
    .replace(/[^a-z0-9\s']/g," ")
    .split(/\s+/).filter(Boolean);
}
function unique(arr){
  return [...new Set(arr)];
}
function overlapRatio(a,b){
  const A = new Set(a), B = new Set(b);
  let hit=0;
  for(const w of A) if(B.has(w)) hit++;
  return A.size ? hit / A.size : 0;
}
function estimatePronunciation(userText){
  const w = unique(wordList(userText));
  const key = (SCENARIO.meta?.key_vocab||[]).map(x=>String(x.w||"").toLowerCase());
  const hit = w.filter(x=>key.includes(x)).length;
  const hasPlease = w.includes("please");
  const hasCan = w.includes("can") && w.includes("i") && w.includes("get");
  const len = clamp(w.length, 1, 20);
  let score = 35 + (hit*10) + (hasPlease?8:0) + (hasCan?10:0) + Math.min(20, len*2);
  score += (Math.random()*4 - 2);
  return clamp(Math.round(score), 35, 95);
}
function estimateRelevance(userText, hint){
  const u = unique(wordList(userText));
  const h = unique(wordList(hint));
  const r = overlapRatio(h, u);
  let score = 30 + r*70;
  const key = (SCENARIO.meta?.key_vocab||[]).map(x=>String(x.w||"").toLowerCase());
  const hit = u.filter(x=>key.includes(x)).length;
  score += hit*3;
  return clamp(Math.round(score), 0, 100);
}
function countWords(userText){ return unique(wordList(userText)).length; }

/* ========= Missions ========= */
function updateMissionMini(){
  const done = missions.filter(m=>m.__done).length;
  $("missionMini").textContent = done ? `å·²å®Œæˆ ${done} / ${missions.length}` : `é–‹å§‹å¾Œæœƒè‡ªå‹•å‹¾é¸`;
}
function markMissionIf(stepId){
  for(const m of missions){
    if(m.complete_on_step===stepId) m.__done = true;
  }
  updateMissionMini();
}

/* ========= Flow ========= */
function resetAll(){
  stepIndex = 0;
  userTurns = 0;
  transcript = [];
  metrics = {relevance:0, pronunciation:0, words:0, completeness:0};
  for(const m of missions) m.__done = false;
  updateMissionMini();

  $("chatBody").innerHTML = "";
  $("reportView").classList.remove("show");
  $("reportView").style.display = "none";
  $("mainView").style.display = "";
  $("txtInput").value = "";
  $("progBar").style.width = "0%";
  $("stepText").textContent = "æº–å‚™é–‹å§‹";
  $("statusText").textContent = "èªéŸ³ï¼šå¾…å‘½";
}

function startScenario(){
  resetAll();
  const firstAi = findNextAiStep(0);
  stepIndex = firstAi>=0 ? firstAi : 0;
  playAiTurn();
}

function playAiTurn(){
  const t = currentTurn();
  if(!t) return;
  if(t.speaker!=="AI") return;
  pushBubble("AI", t.en, t.zh, styleMode==="correct" ? "ï¼ˆå¯è·Ÿè‘—èªªï¼‰" : "");
  if(!hideText) speak(t.en);
  setProgress();

  const nextUser = findNextUserStep(stepIndex+1);
  if(nextUser>=0) {
    stepIndex = nextUser;
    setProgress();
  } else {
    finishScenario();
  }
}

function showHint(){
  const t = currentTurn();
  if(!t || t.speaker!=="USER") return;
  const hintEn = t.hint_en || "";
  const hintZh = t.hint_zh || "";
  pushBubble("AI", diffMode==="easy" ? `Hint: ${hintEn}` : "Try a short, polite sentence.", diffMode==="easy" ? hintZh : "", "æç¤º");
  if(diffMode==="easy" && !hideText) speak(hintEn);
}

function handleUserInput(text, fromMic){
  const t = currentTurn();
  if(!t || t.speaker!=="USER") return;

  const userText = String(text||"").trim();
  if(!userText) return;

  userTurns++;
  pushBubble("USER", userText, "", fromMic ? "ğŸ¤" : "âŒ¨ï¸");
  $("txtInput").value = "";

  const hint = t.hint_en || "";
  const rel = estimateRelevance(userText, hint);
  const pro = estimatePronunciation(userText);
  const wd = countWords(userText);

  metrics.relevance = Math.round((metrics.relevance*(userTurns-1) + rel)/userTurns);
  metrics.pronunciation = Math.round((metrics.pronunciation*(userTurns-1) + pro)/userTurns);
  metrics.words += wd;

  markMissionIf(t.id);

  if(styleMode==="correct"){
    const r = rel;
    if(r < 60 && diffMode==="easy"){
      pushBubble("AI", `Good try! You can say: "${hint}"`, t.hint_zh||"", "æ™ºèƒ½ç³¾éŒ¯");
      if(!hideText) speak(`Good try! ${hint}`);
    } else if(r < 60 && diffMode==="hard"){
      pushBubble("AI", "Almost! Try a more polite sentence with please.", "", "æ™ºèƒ½ç³¾éŒ¯");
      if(!hideText) speak("Almost! Try a more polite sentence with please.");
    }
  }

  const nextAi = findNextAiStep(stepIndex+1);
  if(nextAi>=0) {
    stepIndex = nextAi;
    setProgress();
    setTimeout(playAiTurn, 220);
  } else {
    finishScenario();
  }
}

function tierFor(score){
  const tiers = SCENARIO.feedback_tiers || [];
  for(const t of tiers){
    if(score>=t.min && score<=t.max) return t;
  }
  return tiers[tiers.length-1] || null;
}

function finishScenario(){
  const done = missions.filter(m=>m.__done).length;
  const comp = missions.length ? Math.round((done/missions.length)*100) : 100;
  metrics.completeness = comp;

  const overall = Math.round(
    metrics.relevance*0.45 + metrics.pronunciation*0.35 + metrics.completeness*0.20
  );

  const tier = tierFor(overall);
  const title = tier ? tier.title : "å®Œæˆï¼";
  $("reportTitle").textContent = title;

  $("mRel").textContent = metrics.relevance + "%";
  $("mPro").textContent = metrics.pronunciation + "%";
  $("mWords").textContent = metrics.words;
  $("mComp").textContent = metrics.completeness;

  const stars = clamp(Math.round(overall/34), 1, 3);
  const row = $("starsRow");
  row.innerHTML = "";
  for(let i=1;i<=3;i++) {
    row.insertAdjacentHTML("beforeend", `<div class="star">${i<=stars ? "â­ï¸" : "â˜†"}</div>`);
  }

  if(tier && tier.one_fix){
    $("oneFix").innerHTML = `<div class="small">åŸå¥ï¼š<b>${esc(tier.one_fix.original)}</b></div>
    <div style="margin-top:8px">æ›´å¥½ï¼š<b>${esc(tier.one_fix.better)}</b></div>
    <div class="small" style="margin-top:10px">${esc(tier.ai_message||"")}</div>`;
  } else {
    $("oneFix").textContent = "åšå¾—å¾ˆå¥½ï¼";
  }

  $("mainView").style.display = "none";
  $("reportView").style.display = "";
  $("reportView").classList.add("show");
}

function buildExamples(){
  const list = $("exList");
  list.innerHTML = "";

  const basics = (SCENARIO.meta?.examples || []).map(x=>({en:x.en, zh:x.zh}));
  const advs = basics.map(x=>({
    en: x.en
      .replace(/^Can I get /i, "Could I get ")
      .replace(/, please\?$/i, ", please?")
      .replace(/^Iâ€™d like /i, "Iâ€™d love ")
      .replace(/^I'd like /i, "I'd love "),
    zh: (x.zh||"") + "ï¼ˆæ›´è‡ªç„¶ï¼‰"
  }));

  const show = (arr)=>{
    list.innerHTML = "";
    arr.forEach((x)=>{
      const card = document.createElement("div");
      card.className = "exCard";
      card.innerHTML = `
        <div class="exTop">
          <div>
            <div class="exEn">${esc(x.en)}</div>
            <div class="exZh">${esc(x.zh||"")}</div>
          </div>
          <button class="btn" data-say="${esc(x.en)}">ğŸ”Š</button>
        </div>
      `;
      list.appendChild(card);
    });
    list.querySelectorAll("button[data-say]").forEach(b=>{
      b.onclick = ()=> speak(b.getAttribute("data-say"));
    });
  };

  $("tabBasic").onclick = ()=>{ $("tabBasic").classList.add("on"); $("tabAdv").classList.remove("on"); show(basics); };
  $("tabAdv").onclick = ()=>{ $("tabAdv").classList.add("on"); $("tabBasic").classList.remove("on"); show(advs); };
  show(basics);

  const vbox = $("vocabList");
  vbox.innerHTML = "";
  (SCENARIO.meta?.key_vocab || []).forEach(v=>{
    const el = document.createElement("div");
    el.className = "k";
    const label = `${v.w} Â· ${v.zh}${v.note? " Â· "+v.note : ""}`;
    el.textContent = label;
    el.onclick = ()=> speak(v.w);
    vbox.appendChild(el);
  });
}

/* ========= UI Wiring ========= */
$("btnBack").onclick = ()=> history.back();
$("btnExamples").onclick = ()=>{ $("exMask").classList.add("show"); };
$("exClose").onclick = ()=>{ $("exMask").classList.remove("show"); };
$("exMask").onclick = (e)=>{ if(e.target.id==="exMask") $("exMask").classList.remove("show"); };

$("btnSettings").onclick = ()=>{ $("setMask").classList.add("show"); };
$("setClose").onclick = ()=>{ $("setMask").classList.remove("show"); };
$("setMask").onclick = (e)=>{ if(e.target.id==="setMask") $("setMask").classList.remove("show"); };

$("btnStart").onclick = startScenario;
$("btnHint").onclick = showHint;
$("btnReplay").onclick = ()=>{ $("teacherVideo").currentTime = 0; $("teacherVideo").play().catch(()=>{}); };
$("btnReset").onclick = resetAll;

$("btnMic").onclick = ()=>{ if(listening) return; startListen(); };
$("btnSend").onclick = ()=> handleUserInput($("txtInput").value, false);
$("txtInput").addEventListener("keydown", (e)=>{
  if(e.key==="Enter") {
    e.preventDefault();
    handleUserInput($("txtInput").value, false);
  }
});

$("styleRelax").onclick = ()=>{ styleMode="relax"; $("styleRelax").className="btn primary"; $("styleCorrect").className="btn"; };
$("styleCorrect").onclick = ()=>{ styleMode="correct"; $("styleCorrect").className="btn primary"; $("styleRelax").className="btn"; };
$("diffEasy").onclick = ()=>{ diffMode="easy"; $("diffEasy").className="btn primary"; $("diffHard").className="btn"; };
$("diffHard").onclick = ()=>{ diffMode="hard"; $("diffHard").className="btn primary"; $("diffEasy").className="btn"; };

$("rate").oninput = (e)=>{
  ttsRate = parseFloat(e.target.value);
  $("rateLabel").textContent = ttsRate.toFixed(2)+"x";
};

function applyHide(){
  $("toggleHide").textContent = hideText ? "é–‹" : "é—œ";
  $("toggleHideText").textContent = hideText ? "é¡¯ç¤ºæ–‡å­—" : "éš±è—æ–‡å­—ï¼ˆç·´è½åŠ›ï¼‰";
  renderFromTranscript();
}

$("toggleHide").onclick = ()=>{ hideText = !hideText; applyHide(); };
$("toggleHideText").onclick = ()=>{ hideText = !hideText; applyHide(); };

$("btnSpeakVocab").onclick = async ()=>{
  const items = SCENARIO.meta?.key_vocab || [];
  for(const v of items){
    speak(v.w);
    await new Promise(r=>setTimeout(r, 900));
  }
};

$("btnTranscript").onclick = ()=>{
  const b = $("trBody");
  b.innerHTML = "";
  transcript.forEach((x, i)=>{
    const who = x.speaker==="AI" ? "AI" : "YOU";
    const box = document.createElement("div");
    box.className = "exCard";
    box.innerHTML = `<div class="small">${i+1} Â· ${who}</div>
      <div style="font-weight:900; margin-top:6px;">${esc(x.en)}</div>
      ${x.zh ? `<div class="small" style="margin-top:6px;">${esc(x.zh)}</div>` : ""}
      ${x.meta ? `<div class="small" style="margin-top:8px;">${esc(x.meta)}</div>` : ""}`;
    b.appendChild(box);
  });
  $("trMask").classList.add("show");
};
$("trClose").onclick = ()=> $("trMask").classList.remove("show");
$("trMask").onclick = (e)=>{ if(e.target.id==="trMask") $("trMask").classList.remove("show"); };

$("btnContinue").onclick = ()=>{
  $("reportView").classList.remove("show");
  $("reportView").style.display = "none";
  $("mainView").style.display = "";
  startScenario();
};

/* ========= Init ========= */
updateMissionMini();
buildExamples();
setProgress();
if("speechSynthesis" in window){
  speechSynthesis.onvoiceschanged = ()=>{};
}
</script>
</body>
</html>
