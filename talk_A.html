<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Talk Aï½œBookWideï¼ˆSemantic Passï¼‰</title>
<style>
:root{
  --bg:#0b1020; --card:rgba(255,255,255,.06); --line:rgba(255,255,255,.10);
  --ink:#eaf0ff; --muted:rgba(234,240,255,.75); --brand:#4f7cff; --ok:#22c55e; --bad:#ef4444;
  --r:18px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--ink);
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","Microsoft JhengHei",sans-serif;
  background:linear-gradient(180deg,#070b16,#0b1020);
  overflow:hidden;
}
.topbar{
  height:62px; display:flex; align-items:center; justify-content:space-between;
  padding:0 18px; border-bottom:1px solid rgba(255,255,255,.08);
  background:rgba(6,10,22,.72); backdrop-filter: blur(12px);
}
.pill{padding:7px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.08);font-weight:900;font-size:13px}
.layout{height:calc(100vh - 62px);display:grid;grid-template-columns:1.2fr .9fr;gap:14px;padding:14px}
.panel{background:var(--card);border:1px solid rgba(255,255,255,.10);border-radius:var(--r);overflow:hidden;display:flex;flex-direction:column;min-height:0}
.panelHead{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:space-between}
.panelBody{padding:14px 16px;overflow:auto;min-height:0}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
label{display:block;font-weight:900;margin:10px 0 6px}
select,textarea,input{
  width:100%;border-radius:14px;border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.18);color:var(--ink);padding:12px;font-weight:850
}
textarea{min-height:80px}
.hint{color:var(--muted);font-size:12px;font-weight:800}
.videoRow{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
.videoBox{border-radius:16px;border:1px solid rgba(255,255,255,.10);background:#000;aspect-ratio:16/9;position:relative}
video{width:100%;height:100%;object-fit:cover}
.tag{position:absolute;left:10px;top:10px;padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.14);font-weight:900;font-size:12px}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.btn{border-radius:14px;padding:10px 14px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.08);color:var(--ink);font-weight:900}
.btn.ok{background:rgba(34,197,94,.16);border-color:rgba(34,197,94,.35)}
.btn.primary{background:rgba(79,124,255,.18);border-color:rgba(79,124,255,.35)}
.chat{display:flex;flex-direction:column;gap:12px}
.card{border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:12px;background:rgba(255,255,255,.04)}
.msg{font-size:18px;font-weight:900}
.msgHint{margin-top:8px;padding:8px;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);font-size:12px;color:var(--muted)}
.inputBar{margin-top:auto;padding:12px;border-top:1px solid rgba(255,255,255,.08);display:flex;gap:10px}
.inputBar input{flex:1}
.toast{position:fixed;right:14px;bottom:14px;display:none;padding:10px 12px;border-radius:14px;background:rgba(0,0,0,.75);border:1px solid rgba(255,255,255,.12);font-weight:900}
.toast.show{display:block}
</style>
</head>
<body>
<div class="topbar">
  <div style="display:flex;gap:10px;align-items:center;font-weight:950">
    <div style="font-size:22px">BookWide</div>
    <span class="pill">Talk</span><span class="pill">Aï½œ10å¥è…³æœ¬</span>
  </div>
  <div class="pill">é€²åº¦ <span id="prog">1</span>/10</div>
</div>

<div class="layout">
  <div class="panel">
    <div class="panelHead"><div>å½±åƒ + èªªè©±ï¼ˆä½ ï¼‰</div><div class="hint">è€å¸«ä¸€å¥ â†’ ä½ ä¸€å¥</div></div>
    <div class="panelBody">
      <div class="row">
        <div>
          <label>æƒ…å¢ƒ</label>
          <select id="scenario"></select>
        </div>
        <div>
          <label>æç¤ºèªè¨€</label>
          <select id="hintLang"><option value="zh">ä¸­æ–‡</option><option value="en">English</option></select>
        </div>
      </div>
      <label>æç¤ºï¼ˆå¯é¸ï¼‰</label>
      <textarea id="userHint" placeholder="æ…¢æ…¢èªªã€åªçµ¦ä¸€å€‹é‡é»â€¦"></textarea>

      <div class="videoRow">
        <div class="videoBox"><div class="tag">ä½ </div><video id="vUser" muted playsinline></video></div>
        <div class="videoBox"><div class="tag">AI è€å¸«</div><video id="vTeacher" muted loop playsinline></video></div>
      </div>

      <div class="controls">
        <button class="btn primary" id="btnCam">é–‹å•Ÿç›¸æ©Ÿ</button>
        <button class="btn ok" id="btnHold">æŒ‰ä½èªªè©±</button>
        <button class="btn" id="btnReplay">é‡æ’­è€å¸«</button>
        <button class="btn primary" id="btnNext">ä¸‹ä¸€å¥</button>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="panelHead"><div>AI è€å¸«ï¼ˆè…³æœ¬ï¼‰</div><div class="hint" id="scnLabel"></div></div>
    <div class="panelBody chat">
      <div class="card">
        <div class="msg" id="teacherText">â€”</div>
        <div class="msgHint" id="teacherHint">â€”</div>
        <div class="controls"><button class="btn ok" id="btnSpeak">è€å¸«æœ—è®€</button></div>
      </div>
      <div class="card" id="result" style="display:none">
        <div class="msg" id="userSaid">â€”</div>
        <div class="msgHint" id="judge">â€”</div>
      </div>
    </div>
    <div class="inputBar">
      <input id="userInput" placeholder="æˆ–ç›´æ¥æ‰“å­—ï¼šI'm doing my nails." />
      <button class="btn primary" id="btnSend">é€å‡º</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const $=id=>document.getElementById(id);
const toast=(t)=>{const el=$('toast');el.textContent=t;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),2200)};

// ====== PATCH: Semantic Pass ======
function BW_norm(s){
  return (s||'').toLowerCase().replace(/['â€™]/g,'').replace(/[^a-z0-9\s]/g,' ').replace(/\s+/g,' ').trim();
}
function similarity(a,b){
  const A=new Set(BW_norm(a).split(' ').filter(Boolean));
  const B=new Set(BW_norm(b).split(' ').filter(Boolean));
  let inter=0; for(const t of A) if(B.has(t)) inter++;
  const uni=A.size+B.size-inter; return uni? inter/uni:0;
}
function BW_isSemanticPass(userText, expectedText, hints, score, th=0.72){
  const u=BW_norm(userText), e=BW_norm(expectedText);
  if(score>=th) return true;
  if(e.includes(u) && u.length>=4) return true;
  for(const h of (hints||[])) if(u.includes(BW_norm(h))) return true;
  return false;
}
// ====== END PATCH ======

const SCENARIOS={
  nails:{
    label:'nailsï¼ˆç¾ç”²ï¼‰',
    hints:['sure','maybe later'],
    lines:[
      {t:'Do you want to try?', zh:'æç¤ºï¼šSure / Maybe later'},
      {t:'Sure, maybe later.', zh:'è·Ÿè®€ï¼šSure, maybe later.'}
    ]
  },
  coffee:{
    label:'coffeeï¼ˆå’–å•¡ï¼‰',
    hints:['having coffee','getting coffee','drinking coffee'],
    lines:[
      {t:'What are you doing now?', zh:'æç¤ºï¼šI am having/getting/drinking coffee.'},
      {t:'I am having coffee.', zh:'è·Ÿè®€ï¼šI am having coffee.'}
    ]
  }
};

let state={scenario:'nails', idx:0};
const teacherAudio=new Audio();

function mp3Url(){
  const pad=String(state.idx+1).padStart(2,'0');
  return `https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/talk/teacher/${state.scenario}/line-${pad}.mp3`;
}
async function speak(){
  try{
    teacherAudio.src=mp3Url();
    await teacherAudio.play();
  }catch(e){ toast('æ‰¾ä¸åˆ°è€å¸« MP3'); }
}

function render(){
  const sc=SCENARIOS[state.scenario];
  $('prog').textContent=state.idx+1;
  $('scnLabel').textContent=sc.label;
  $('teacherText').textContent=sc.lines[state.idx].t;
  $('teacherHint').textContent=( $('hintLang').value==='zh' ? sc.lines[state.idx].zh : '');
}
function submit(text){
  const sc=SCENARIOS[state.scenario];
  const expected=sc.lines[Math.min(state.idx+1, sc.lines.length-1)].t;
  const score=similarity(text, expected);
  const pass=BW_isSemanticPass(text, expected, sc.hints, score, 0.72);
  $('result').style.display='block';
  $('userSaid').textContent=text;
  $('judge').textContent= pass
    ? 'ğŸ‘ é€šéï¼ˆèªæ„æ­£ç¢ºï¼‰\nå»ºè­°å®Œæ•´å¥ï¼š'+expected
    : 'âŒ é‚„ä¸å¤ªåƒ\nå»ºè­°ï¼š'+expected+'\nç›¸ä¼¼åº¦ï¼š'+score.toFixed(2);
  if(pass){ state.idx=Math.min(state.idx+1, sc.lines.length-1); render(); speak(); }
}

$('scenario').innerHTML=Object.keys(SCENARIOS).map(k=>`<option value="${k}">${SCENARIOS[k].label}</option>`).join('');
$('scenario').value=state.scenario;
$('scenario').onchange=()=>{state.scenario=$('scenario').value; state.idx=0; render(); speak();};
$('hintLang').onchange=render;
$('btnSpeak').onclick=speak;
$('btnReplay').onclick=speak;
$('btnNext').onclick=()=>{state.idx=Math.min(state.idx+1,1); render(); speak();};
$('btnSend').onclick=()=>{const t=$('userInput').value.trim(); if(t) submit(t);};

render();
</script>
</body>
</html>
