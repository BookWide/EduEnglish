<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Talk Aï¼ˆæ‰‹æ©Ÿå£èªªï¼‰ï½œBookWide</title>
  <style>
    :root{
      --bg:#ffffff; --ink:#0b1220; --muted:#5b667a; --line:#e6eaf0; --soft:#f6f8fb;
      --pill:#111827; --pillText:#ffffff; --shadow:0 10px 28px rgba(10,20,40,.10);
      --radius:18px; --radius2:24px; --btn:#0b66ff; --btn2:#084fc6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      background:var(--bg); color:var(--ink); overflow:hidden;
    }
    .app{height:100%;display:flex;flex-direction:column;padding:12px 12px calc(12px + env(safe-area-inset-bottom));gap:10px;max-width:980px;margin:0 auto;}
    .top{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;box-shadow:var(--shadow);}
    .back{width:36px;height:36px;border-radius:999px;border:1px solid var(--line);background:#fff;display:grid;place-items:center;cursor:pointer;flex:0 0 auto;}
    .title{display:flex;flex-direction:column;gap:2px;min-width:0;}
    .title b{font-size:15px;line-height:1.1}
    .title small{font-size:12px;color:var(--muted)}
    .spacer{flex:1}
    .scenario{display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:999px;padding:8px 10px;background:var(--soft);min-width:220px;max-width:420px;}
    .scenario select{width:100%;border:0;background:transparent;font-size:14px;outline:none;color:var(--ink);appearance:none;}
    .btn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 10px;cursor:pointer;font-size:13px;white-space:nowrap;}
    .stage{flex:1;min-height:0;border:1px solid var(--line);border-radius:var(--radius2);background:#fff;box-shadow:var(--shadow);padding:14px;display:flex;flex-direction:column;gap:10px;}
    .who{display:flex;align-items:center;gap:10px;}
    .pill{display:inline-flex;align-items:center;gap:8px;background:var(--pill);color:var(--pillText);border-radius:999px;padding:6px 10px;font-size:12px;}
    .statusDot{width:8px;height:8px;border-radius:99px;background:#94a3b8;}
    .statusDot.on{background:#10b981}
    .who small{color:var(--muted)}

    .center{display:flex;align-items:center;justify-content:flex-start;gap:18px;padding:8px 0 2px;}
    .avatarWrap{
      width:min(180px,42vw); aspect-ratio:1/1; border-radius:999px;
      background:radial-gradient(circle at 30% 30%, #e9eef7, #ffffff 55%, #e9eef7);
      border:1px solid var(--line);
      box-shadow:0 20px 60px rgba(10,20,40,.12) inset;
      display:grid; place-items:center; position:relative; overflow:hidden;
    }
    .avatarImg{
      width:78%; height:78%; border-radius:999px; object-fit:cover;
      border:6px solid rgba(255,255,255,.9);
      box-shadow:0 18px 48px rgba(10,20,40,.18);
      background:#fff;
      transition:transform .18s ease, box-shadow .18s ease;
    }
    .avatarWrap.speaking .avatarImg{transform:scale(1.03); box-shadow:0 26px 80px rgba(0,0,0,.22);}
    .avatarVid{
      display:none;
      width:78%; height:78%; border-radius:999px; object-fit:cover;
      border:6px solid rgba(255,255,255,.9);
      box-shadow:0 18px 48px rgba(10,20,40,.18);
      background:#fff;
    }
    .avatarWrap.speaking .avatarImg{display:none;}
    .avatarWrap.speaking .avatarVid{display:block;transform:scale(1.03); box-shadow:0 26px 80px rgba(0,0,0,.22);}


    .dialog{border:1px solid var(--line);border-radius:var(--radius);padding:14px;background:var(--soft);}
    .dialog .en{font-size:22px;line-height:1.35;font-weight:800;letter-spacing:.2px;}
    .dialog .zh{margin-top:6px;font-size:13px;color:var(--muted);line-height:1.4;}
    .note{border:1px dashed var(--line);border-radius:var(--radius);padding:10px 12px;color:var(--muted);font-size:12px;line-height:1.4;background:#fff;}
    .controls{display:flex;flex-direction:column;gap:10px;}
    .micRow{display:flex;align-items:center;gap:10px;}
    .micBtn{
      flex:1;border:0;background:linear-gradient(180deg,var(--btn),var(--btn2));color:#fff;border-radius:999px;
      padding:14px 16px;font-weight:800;font-size:15px;cursor:pointer;box-shadow:0 14px 30px rgba(11,102,255,.25);
      display:flex;align-items:center;justify-content:center;gap:10px;
    }
    .skipBtn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:14px 16px;font-weight:700;cursor:pointer;min-width:96px;}
    .helperRow{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;}
    .helperBtn{border:1px solid var(--line);background:#fff;border-radius:var(--radius);padding:12px 10px;text-align:left;cursor:pointer;min-height:62px;box-shadow:0 8px 18px rgba(10,20,40,.06);}
    .helperBtn b{display:block;font-size:14px}
    .helperBtn small{display:block;margin-top:4px;color:var(--muted);font-size:12px}
    .softHint{margin-top:12px;padding:12px 14px;border:1px solid var(--line);border-radius:14px;background:#fff7ed;color:#7c2d12;font-size:15px;line-height:1.35;box-shadow:0 10px 28px rgba(15,23,42,.08)}
    .softHint b{font-weight:800}
    .softHint .sub{display:block;margin-top:6px;color:#92400e;font-size:13px}

    .sheetMask{position:fixed;inset:0;background:rgba(0,0,0,.28);display:none;z-index:50;}
    .sheetMask.show{display:block}
    .sheet{position:fixed;left:0;right:0;bottom:0;background:#fff;border-radius:18px 18px 0 0;border:1px solid var(--line);
      box-shadow:0 -24px 60px rgba(10,20,40,.18);max-width:980px;margin:0 auto;max-height:78vh;transform:translateY(110%);
      transition:transform .22s ease;z-index:51;overflow:hidden;}
    .sheet.show{transform:translateY(0)}
    .sheetHead{display:flex;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid var(--line);background:var(--soft);}
    .grab{width:42px;height:5px;border-radius:99px;background:#cfd6e3;margin:0 auto;}
    .sheetClose{margin-left:auto;border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 10px;cursor:pointer;font-weight:800;font-size:13px;}
    .sheetBody{padding:14px;overflow:auto;max-height:calc(78vh - 52px);}
    .card{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff;margin-bottom:10px;}
    .card h3{margin:0 0 8px 0;font-size:14px}
    .card p{margin:0;color:var(--muted);line-height:1.5}
    .row{display:flex;flex-wrap:wrap;gap:8px;}
    .tag{display:inline-flex;align-items:center;padding:4px 8px;border-radius:999px;background:var(--soft);border:1px solid var(--line);font-size:12px;color:var(--muted);}

    .gate{position:fixed;inset:0;background:rgba(255,255,255,.92);display:none;z-index:80;padding:22px;}
    .gate.show{display:flex;align-items:center;justify-content:center}
    .gateBox{width:min(520px,92vw);border:1px solid var(--line);border-radius:18px;background:#fff;box-shadow:var(--shadow);padding:16px;text-align:center;}
    .gateBox h2{margin:6px 0 8px 0;font-size:18px}
    .gateBox p{margin:0 0 12px 0;color:var(--muted);line-height:1.5}
    .gateBox button{border:0;background:linear-gradient(180deg,var(--btn),var(--btn2));color:#fff;border-radius:999px;padding:12px 16px;font-weight:900;cursor:pointer;width:100%;}

    @media (max-width:520px){
      .scenario{min-width:0;max-width:none}
      .dialog .en{font-size:20px}
      .helperRow{gap:8px}
      .helperBtn{padding:10px 8px;min-height:58px}
      .helperBtn b{font-size:13px}
      .helperBtn small{font-size:11px}
      .micBtn{font-size:14px;padding:13px 14px}
      .skipBtn{padding:13px 14px}
    }
  
/* =========================================
   Mobile Only Patch (Talk A11)
   - å…è¨±æ•´é ä¸Šä¸‹æ»‘å‹•ï¼ˆiOS ä¸å†å¡æ­»ï¼‰
   - AI é ­åƒç¸®å°ï¼ˆä¸æ˜¯ä¸»è§’ï¼‰
   - ä¸Šæ–¹å€åŸŸè®Šç˜¦ï¼Œç•™ç©ºé–“çµ¦ä¸‹æ–¹ä»»å‹™åˆ—
========================================= */
@media (max-width: 768px){
  html,body{height:auto !important; overflow:auto !important;}
  body{overflow:auto !important; -webkit-overflow-scrolling:touch !important;}
  .app{height:auto !important; min-height:100vh !important; padding-top:10px !important;}
  .stage{min-height:auto !important; overflow:auto !important; -webkit-overflow-scrolling:touch !important;}

  /* Top bar è®Šç˜¦ */
  .top{padding:8px 10px !important; gap:8px !important;}
  .title small{display:none !important;} /* æ‰‹æ©Ÿå…ˆä¸é¡¯ç¤º TTS å­æ¨™ */
  .scenario{padding:6px 10px !important;}
  .btn{padding:6px 10px !important;}

  /* è®“å ´æ™¯ä¸‹æ‹‰æ›´å¥½é» */
  .scenario select{font-size:13px !important;}

  /* é ­åƒç¸®å°ï¼ˆç•™ç©ºé–“çµ¦åº•éƒ¨ï¼‰ */
  .center{padding:4px 0 0 !important;}
  .avatarWrap{width:min(128px,38vw) !important;}
  .avatarImg,.avatarVid{width:80% !important; height:80% !important;}

  /* å°è©±å¡ç¨å¾®æ”¶é«˜ï¼ˆä¸æ”¹é¢¨æ ¼ï¼‰ */
  .dialog{padding:12px !important;}
  .dialog .en{font-size:20px !important; line-height:1.2 !important;}
  .dialog .zh{font-size:12px !important;}

  /* æŒ‰éˆ•åˆ—ç·Šæ¹Šé»ï¼Œé¿å…æ“ åˆ°åº• */
  .micBtn{padding:12px 14px !important;}
  .skipBtn{padding:12px 14px !important;}
  .helperRow{gap:8px !important;}
  .helperBtn{min-height:56px !important; padding:10px 8px !important;}
}


/* ===== ä»»å‹™/ç¯„ä¾‹æµ®çª— (v20260107-stable) ===== */
#missionBox, #examplesBox{
  position:fixed;
  left:12px; right:12px;
  bottom:12px;
  max-height:62vh;
  overflow:auto;
  background:#ffffff;
  border:1px solid rgba(0,0,0,.08);
  border-radius:18px;
  box-shadow:0 18px 50px rgba(15,23,42,.18);
  padding:14px 14px 18px;
  z-index:9999;
  display:none;
}
#missionBox .btn, #examplesBox .btn{
  display:inline-flex; align-items:center; gap:8px;
  padding:10px 12px; border-radius:14px;
  border:1px solid rgba(0,0,0,.10);
  background:#fff; color:#111827;
  text-decoration:none; font-weight:800;
}
#missionBox .btn:hover, #examplesBox .btn:hover{background:rgba(0,0,0,.03);}

/* ===== å¡«ç©ºæŒ‰éˆ•æ¨£å¼ï¼ˆv20260107-fillï¼‰===== */
.fillChoice{
  border:1px solid rgba(0,0,0,.10);
  background:var(--soft);
  border-radius:999px;
  padding:8px 10px;
  cursor:pointer;
  font-weight:800;
  font-size:13px;
}
.fillChoice:hover{background:rgba(0,0,0,.03);}
.fillSlot{
  border:1px dashed rgba(0,0,0,.18);
  background:#fff;
  border-radius:999px;
  padding:6px 10px;
  font-weight:900;
  font-size:13px;
}


/* ===== æƒ…å¢ƒå½±ç‰‡å€ï¼ˆv20260107-sceneVideoï¼‰===== */
.sceneBox{
  flex:1 1 auto;
  min-width:240px;
  border:1px solid var(--line);
  border-radius:var(--radius);
  background:#fff;
  padding:10px;
}
.sceneHead{display:flex;gap:10px;align-items:baseline;flex-wrap:wrap}
.sceneTitle{font-weight:900}
.sceneHint{color:var(--muted);font-size:12px}
.sceneVid{width:100%;max-height:260px;border-radius:14px;background:#0b1220;display:none}
.sceneEmpty{margin-top:10px;color:var(--muted);font-size:12px}
@media (max-width: 780px){
  .center{flex-direction:column;align-items:center}
  .sceneBox{width:100%}
  .sceneVid{max-height:220px}
}


/* ===== åº•éƒ¨ä»»å‹™åˆ—å›ºå®šï¼ˆv20260107-bottomDockï¼‰===== */
body{padding-bottom:120px;} /* é¿å…è¢«å›ºå®šåˆ—è“‹ä½ */
.helperRow{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:14px;
  width:min(980px, calc(100vw - 24px));
  z-index:50;
  background:rgba(255,255,255,.92);
  border:1px solid var(--line);
  border-radius:16px;
  padding:10px;
  box-shadow:0 18px 46px rgba(15,23,42,.18);
  backdrop-filter: blur(8px);
}
@media (max-width: 780px){
  body{padding-bottom:140px;}
  .helperRow{bottom:10px;border-radius:18px;padding:10px;}
}

</style>
</head>
<body>
  <div class="app">
    <div class="top">
      <button class="back" id="btnBack" aria-label="back">â†</button>
      <div class="title">
        <b>Talk Aï¼ˆæ‰‹æ©Ÿå£èªªï¼‰</b>
        <small id="subTitle">TTSï¼šBrowser SpeechSynthesis</small>
      </div>
      <div class="spacer"></div>
      <div class="scenario">
        <select id="sceneSelect"></select>
      </div>
      <button class="btn" id="btnReplay">é‡æ’­æœ¬å¥</button>
    </div>

    <div class="stage">
      <div class="who">
        <span class="pill"><span class="statusDot" id="dot"></span><span id="roleLabel">AI Â· teacher</span></span>
        <small id="sceneLabel">â€”</small>
      </div>

      <div class="center">
        <div class="avatarWrap" id="avatarWrap">
          <video class="avatarVid" id="avatarVid" preload="auto" playsinline muted></video>
          <img class="avatarImg" id="avatarImg" alt="AI Avatar" style="display:none" />
        </div>

        <!-- ===== æƒ…å¢ƒå½±ç‰‡å€ï¼ˆv20260107-sceneVideoï¼‰===== -->
        <div class="sceneBox" id="sceneBox">
          <div class="sceneHead">
            <div class="sceneTitle">æƒ…å¢ƒå½±ç‰‡</div>
            <div class="sceneHint">ï¼ˆå¯æ”¾ CapCut å½±ç‰‡è³£é»ï¼‰</div>
          </div>
          <video class="sceneVid" id="sceneVid" controls playsinline preload="metadata"></video>
          <div class="sceneEmpty" id="sceneEmpty">å°šæœªè¨­å®šæƒ…å¢ƒå½±ç‰‡ï¼ˆå¯åœ¨å ´æ™¯ JSON çš„ meta.scene_video æŒ‡å®š mp4 URLï¼‰</div>
        </div>
      </div>

      <div class="dialog" id="dialogBox">
        <div class="en" id="lineEN">Loadingâ€¦</div>
        <div class="zh" id="lineZH">ï¼ˆè¼‰å…¥ä¸­â€¦ï¼‰</div>
      </div>

      <div class="note" id="heardText" style="display:none">ä½ èªªï¼šâ€”</div>
      <div class="softHint" id="softHint" style="display:none"></div>

      <div class="controls">
        <div class="micRow">
          <button class="micBtn" id="btnMic">ğŸ¤ é»æˆ‘èªªï¼ˆé–‹å§‹è¾¨è­˜ï¼‰</button>
          <button class="skipBtn" id="btnType">âŒ¨ï¸ è¼¸å…¥</button>
          <button class="skipBtn" id="btnSkip">è·³é</button>
        <!-- ===== å¡«ç©ºå¼•å°åˆ—ï¼ˆv20260107-fillï¼‰===== -->
        <div id="fillBar" style="display:none;margin-top:6px;border:1px solid var(--line);border-radius:var(--radius);padding:10px;background:#fff;">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
            <div style="font-weight:900;font-size:13px;">å¡«ç©ºæç¤º</div>
            <div class="tag" id="fillLevelTag" style="margin-left:auto;">A2</div>
            <button class="btn" id="btnFillHide" type="button">éš±è—</button>
          </div>
          <div id="fillMasked" style="margin-top:8px;font-size:16px;line-height:1.35;font-weight:900;letter-spacing:.2px;"></div>
          <div id="fillSlots" style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;"></div>
          <div id="fillChoices" style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;"></div>
          <div style="margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <button class="micBtn" id="btnFillSubmit" type="button" style="padding:10px 14px;font-size:14px;flex:0 0 auto;box-shadow:none;">âœ… é€å‡ºå¡«å¥½å¥</button>
            <button class="skipBtn" id="btnFillReset" type="button" style="padding:10px 14px;">é‡ä¾†</button>
            <div style="color:var(--muted);font-size:12px;">æç¤ºï¼šå…ˆç”¨ã€Œå¡«ç©ºã€å®Œæˆä¸€å¥ï¼Œå†æ”¹æˆä½ è‡ªå·±çš„èªªæ³•ã€‚</div>
          </div>
        </div>

        </div>

        <div class="helperRow">
          <button class="helperBtn" id="btnTask"><b>ä»»å‹™</b><small>è¦åšä»€éº¼</small></button>
          <button class="helperBtn" id="btnExamples"><b>ç¯„ä¾‹</b><small>ä¸æœƒå¥</small></button>
          <button class="helperBtn" id="btnTranslate"><b>ç¿»è­¯</b><small>ä¸­ / æ—¥</small></button>
          <button class="helperBtn" id="btnSaved"><b>å·²å„²å­˜</b><small>å–®å­—å¥</small></button>
        </div>

        <div id="hintTools" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px;">
          <button class="btn" id="btnHintToggle" type="button">æç¤ºï¼ˆå±•é–‹ï¼‰</button>
          <button class="btn" id="btnHintSave" type="button">â˜… æ”¶è—æœ¬å¥</button>
          <button class="btn" id="btnHintClose" type="button">Ã— é—œé–‰æç¤º</button>
          <button class="btn" id="btnHintFill" type="button">ğŸ§© å¡«ç©ºå¼•å°</button>
        </div>
        <div class="note" id="noteText">ä¸»é ä¿æŒåœ¨å°è©±ä¸­ï¼›é»ã€Œä»»å‹™ / ç¯„ä¾‹ / ç¿»è­¯ / å·²å„²å­˜ã€åªæœƒæ‰“é–‹è¼”åŠ©å°çª—ï¼Œä¸æœƒä¸­æ–·å°è©±ã€‚</div>
      </div>
    </div>
  </div>

  <div class="sheetMask" id="sheetMask"></div>
  <div class="sheet" id="sheet">
    <div class="sheetHead">
      <div style="width:100%"><div class="grab"></div></div>
      <button class="sheetClose" id="sheetClose">é—œé–‰</button>
    </div>
    <div class="sheetBody" id="sheetBody"></div>
  </div>

  <div class="gate" id="gate">
    <div class="gateBox">
      <h2>é»ä¸€ä¸‹å•Ÿå‹•èªéŸ³</h2>
      <p>iPhone/éƒ¨åˆ†ç€è¦½å™¨æœƒé˜»æ“‹ã€Œè‡ªå‹•å‡ºè²ã€ã€‚é»ä¸€æ¬¡å¾Œå°±å¯æ­£å¸¸æœ—è®€ã€‚</p>
      <button id="gateBtn">é–‹å§‹</button>
    </div>
  </div>


  <!-- ä»»å‹™/ç¯„ä¾‹ æµ®çª—ï¼ˆé¿å… missionBox/examplesBox undefinedï¼‰ -->
  <div id="missionBox" aria-label="ä»»å‹™" role="dialog"></div>
  <div id="examplesBox" aria-label="ç¯„ä¾‹" role="dialog"></div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  // ===== é˜²å‘†ï¼šé¿å… Chrome é¡¯ç¤ºã€ŒUncaught (in promise) Objectã€=====
  // é€™é€šå¸¸ä¾†è‡ªç€è¦½å™¨è‡ªå‹•æ’­æ”¾ç­–ç•¥/å¤–æ›/éŸ³è¨Šæ¬Šé™é€ æˆçš„ Promise rejectionã€‚
  // æˆ‘å€‘åœ¨é€™è£¡çµ±ä¸€åƒæ‰æœªè™•ç†çš„ rejectionï¼Œä¸¦åœ¨ console ç•™ä¸‹å¯è¿½æŸ¥è¨Šæ¯ã€‚
  window.addEventListener("unhandledrejection", (e)=>{
    try{
      console.warn("[TalkA] unhandledrejection:", e.reason);
      e.preventDefault();
    }catch(_){}
  });
  window.addEventListener("error", (e)=>{
    try{ console.warn("[TalkA] error:", e.message || e.error || e); }catch(_){}
  });


  // âœ… ç¾å¥³è€å¸«å”¯ä¸€ä¾†æºï¼ˆé–æ­»ï¼‰
// - ä¸åš fallbackã€ä¸åšéš¨æ©Ÿ bust
// - ä½ è¦æ›ç¾å¥³è€å¸«ï¼šåªè¦æŠŠ Supabase é€™æ”¯ talk.mp4 æ›æ‰å³å¯
  
  // ===== æƒ…å¢ƒå½±ç‰‡ï¼šå¾å ´æ™¯ JSON çš„ meta.scene_video æ›è¼‰ï¼ˆv20260107-sceneVideoï¼‰=====
  function updateSceneVideo(){
    const v = $("sceneVid");
    const empty = $("sceneEmpty");
    // æ”¯æ´ï¼šcurSceneData.meta.scene_video / sceneVideo / video
    const meta = (typeof curSceneData === "object" && curSceneData && curSceneData.meta) ? curSceneData.meta : {};
    try{ updateSceneVideo(); }catch(_){ }
    const url = String(meta.scene_video || meta.sceneVideo || meta.video || "");
    if(!v) return;
    if(url){
      v.src = url;
      v.style.display = "block";
      if(empty) empty.style.display = "none";
    }else{
      try{ v.removeAttribute("src"); v.load && v.load(); }catch(_){}
      v.style.display = "none";
      if(empty) empty.style.display = "block";
    }
  }

const AVATAR_VIDEO_URL = "https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/assets/avatars/talk.mp4";

  const avatarWrap = $("avatarWrap");
  const safePlay = ()=>{
    try{
      const p = avatarVid && avatarVid.play ? avatarVid.play() : null;
      if(p && typeof p.catch === "function") p.catch(()=>{});
    }catch(_){ }
  };
  const avatarImg  = $("avatarImg");
  const avatarVid  = $("avatarVid");
  const dot = $("dot");

  // âœ… æ°¸é ä½¿ç”¨ talk.mp4ï¼ˆç¾å¥³è€å¸«ï¼‰ï¼Œä¸åš fallback
  function ensureAvatarVideo(){
    try{
      if(avatarVid && avatarVid.src !== AVATAR_VIDEO_URL){
        avatarVid.src = AVATAR_VIDEO_URL;
        avatarVid.preload = "auto";
        avatarVid.playsInline = true;
        avatarVid.muted = true;
        avatarVid.load();
      }
      if(avatarImg) avatarImg.style.display = "none";
      if(avatarVid) avatarVid.style.display = "block";
    }catch(e){}
  }

  function setAvatarState(state){
    ensureAvatarVideo();

    // state: "idle" | "listen" | "speak"
    try{
      if(state === "speak"){
        avatarVid.loop = true;
        safePlay();
        const p = null; // legacy
        if(p && typeof p.catch === "function") p.catch(()=>{});
        return;
      }
      // idle / listenï¼šåœåœ¨ç¬¬ä¸€å¹€ï¼ˆä¸æ’­æ”¾ï¼‰
      avatarVid.loop = false;
      avatarVid.pause();
      try{ avatarVid.currentTime = 0; }catch(_){}
    }catch(e){}
  }

  function setSpeaking(on){
    avatarWrap.classList.toggle("speaking", !!on);
    setAvatarState(on ? "speak" : "idle");
  }

  // è‹¥å½±ç‰‡è¼‰å…¥å¤±æ•—ï¼šåªæç¤ºï¼Œä¸åˆ‡æ›ä»»ä½• fallback åœ–
  if(avatarVid){
    avatarVid.addEventListener("error", ()=>{
      try{ avatarVid.pause(); }catch(_){}
      console.warn("[TalkA] avatar video load failed:", AVATAR_VIDEO_URL);
    });
  }

  // å…ˆæŠŠå½±ç‰‡æ›ä¸Šï¼ˆé¿å…ç¬¬ä¸€æ¬¡æ‰ set srcï¼‰
  ensureAvatarVideo();

  // ===== TTS =====
  let lastSpoken = "";
  let audioEnabled = false;
  const gate = $("gate");
  const gateBtn = $("gateBtn");

  function canSpeak(){ return ("speechSynthesis" in window) && ("SpeechSynthesisUtterance" in window); }
  function speak(text){
    const t = String(text||"").trim();
    if(!t || !canSpeak()) return Promise.resolve(false);
    lastSpoken = t;
    try{ speechSynthesis.cancel(); }catch(_){}
    return new Promise((resolve)=>{
      const u = new SpeechSynthesisUtterance(t);
      u.lang = "en-US";
      u.onstart = ()=>{ dot.classList.add("on"); setSpeaking(true); };
      u.onend   = ()=>{ dot.classList.remove("on"); setSpeaking(false); resolve(true); };
      u.onerror = ()=>{ dot.classList.remove("on"); setSpeaking(false); resolve(false); };
      try{ speechSynthesis.speak(u); }catch(e){ resolve(false); }
    });
  }
  async function speakOrGate(text){
    const t = String(text||"").trim();
    if(!t) return false;
    lastSpoken = t;
    if(!audioEnabled){
      gate.classList.add("show");
      return false;
    }
    return await speak(t);
  }
  gateBtn.addEventListener("click", async ()=>{
    gate.classList.remove("show");
    audioEnabled = true;
    await speak(lastSpoken);
  });
  ["click","touchstart","keydown"].forEach(evt=>{
    window.addEventListener(evt, ()=>{ if(!gate.classList.contains("show")) audioEnabled = true; }, { once:true, passive:true });
  });

  // ===== Bottom sheet =====
  const sheetMask = $("sheetMask");
  const sheet = $("sheet");
  const sheetBody = $("sheetBody");
  const sheetClose = $("sheetClose");
  function openSheet(title, html){
    const body = (html==null && title!=null) ? String(title) : String(html||"");
    const t = (html==null) ? "" : String(title||"");
    sheetBody.innerHTML = t ? (`<div class="pill" style="font-weight:900;margin-bottom:10px">`+t+`</div>` + body) : body;
    sheetMask.classList.add("show"); sheet.classList.add("show");
  }
  function closeSheet(){ sheetMask.classList.remove("show"); sheet.classList.remove("show"); }
  sheetMask.addEventListener("click", closeSheet);
  sheetClose.addEventListener("click", closeSheet);

  // ===== Scenes (æœ€å°å¯ç”¨ï¼šå…ˆå…§å»ºï¼Œä¸ä¾è³´å¤–éƒ¨ json) =====

  // ===== Scenes (é›¢ç·šå¯ç”¨ï¼šæƒ…å¢ƒè³‡æ–™å…§åµŒï¼›ä¸æ”¹å¤–è§€/äº’å‹•) =====
  const sceneSelect = $("sceneSelect");
  const roleLabel = $("roleLabel");
  const sceneLabel = $("sceneLabel");
  const lineEN = $("lineEN");
  const lineZH = $("lineZH");
  const btnReplay = $("btnReplay");
  const btnMic = $("btnMic");
  const btnSkip = $("btnSkip");
  const btnType = $("btnType");
  const missionBox = $("missionBox");
  const examplesBox = $("examplesBox");
  const heard = $("heardText");
  const softHint = $("softHint");
  let hintTimer = null;

  function showSoftHint(html, ms=2600){
    if(!softHint) return;
    softHint.innerHTML = toText(html);
    softHint.style.display = "block";
    clearTimeout(hintTimer);
    hintTimer = setTimeout(()=>{ softHint.style.display="none"; }, ms);
  }
  function hideSoftHint(){ if(softHint) softHint.style.display="none"; }


  // ===== é˜²å‘†ï¼šä»»ä½• UI é¡¯ç¤ºåªåƒå­—ä¸²ï¼Œé¿å… [object Object] =====
  function toText(v){
    if(v == null) return "";
    if(typeof v === "string") return v;
    if(typeof v === "number" || typeof v === "boolean") return String(v);
    if(typeof v === "object"){
      return String(v.transcript || v.text || v.message || v.reason || "");
    }
    try{ return String(v); }catch(_){ return ""; }
  }

  // ===== æç¤º/æ”¶è—/é—œé–‰ï¼ˆv20260107-hintsï¼‰=====
  const LS_HINT_COLLAPSED = "BW_TALKA_HINT_COLLAPSED";
  const LS_HINT_CLOSED_ONCE = "BW_TALKA_HINT_CLOSED_ONCE";
  const LS_SAVED = "BW_TALKA_SAVED";

  const btnHintToggle = $("btnHintToggle");
  const btnHintSave   = $("btnHintSave");
  const btnHintClose  = $("btnHintClose");
  const btnHintFill   = $("btnHintFill");

  let hintClosed = false;

  function saveText(t){
    const s = String(t||"").trim();
    if(!s) return;
    let arr = [];
    try{ arr = JSON.parse(localStorage.getItem(LS_SAVED) || "[]"); }catch(_){ arr=[]; }
    if(!Array.isArray(arr)) arr = [];
    if(!arr.includes(s)) arr.unshift(s);
    localStorage.setItem(LS_SAVED, JSON.stringify(arr.slice(0,200)));
    showSoftHint(`<b>å·²æ”¶è—</b>ï¼š${s}`, 1600);
  }

  function getCurHint(){
    const s = steps[idx] || {};
    return String(s.hint||"").trim();
  }

  function applyHintUI(){
    const collapsed = localStorage.getItem(LS_HINT_COLLAPSED) === "1";
    if(btnHintToggle) btnHintToggle.textContent = collapsed ? "æç¤ºï¼ˆå±•é–‹ï¼‰" : "æç¤ºï¼ˆæ”¶èµ·ï¼‰";
    if(hintClosed){
      if(softHint) softHint.style.display = "none";
      const fb = $("fillBar"); if(fb) fb.style.display="none";
      return;
    }
    const fb = $("fillBar");
    if(fb && collapsed) fb.style.display="none";
  }

  hintClosed = localStorage.getItem(LS_HINT_CLOSED_ONCE) === "1";
  applyHintUI();

  btnHintToggle && btnHintToggle.addEventListener("click", ()=>{
    const collapsed = localStorage.getItem(LS_HINT_COLLAPSED) === "1";
    localStorage.setItem(LS_HINT_COLLAPSED, collapsed ? "0" : "1");
    const nowCollapsed = localStorage.getItem(LS_HINT_COLLAPSED) === "1";
    if(!nowCollapsed){
      const h = getCurHint();
      if(h) showSoftHint(`åƒè€ƒå›ç­”ï¼ˆç…§è®€ä¹Ÿå¯ä»¥ï¼‰ï¼š<b>${h}</b>`, 2200);
    }
    applyHintUI();
  });

  btnHintSave && btnHintSave.addEventListener("click", ()=>{
    const h = getCurHint();
    saveText(h || lineEN.textContent || "");
  });

  btnHintClose && btnHintClose.addEventListener("click", ()=>{
    hintClosed = true;
    localStorage.setItem(LS_HINT_CLOSED_ONCE, "1");
    applyHintUI();
    showSoftHint("å·²é—œé–‰æç¤ºï¼ˆéœ€è¦æ¢å¾©å¯æ¸…é™¤ localStorage é–‹é—œï¼‰", 1400);
  });

  // ===== å¡«ç©ºå¼•å°ï¼ˆv20260107-fillï¼‰=====
  const fillBar = $("fillBar");
  const btnFillHide = $("btnFillHide");
  const btnFillSubmit = $("btnFillSubmit");
  const btnFillReset = $("btnFillReset");
  const fillMasked = $("fillMasked");
  const fillSlots = $("fillSlots");
  const fillChoices = $("fillChoices");
  const fillLevelTag = $("fillLevelTag");

  let fillTarget = "";
  let fillWords = [];
  let fillPicked = [];

  function shuffle(a){
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  function buildFill(sentence){
    const s = String(sentence||"").trim();
    if(!s) return null;

    const words = s.split(/[^A-Za-z0-9']+/).filter(w=>w.length>=3);
    const ban = new Set(["please","hello","thanks","thank","sure","okay","ok","hi"]);
    const candidates = words.filter(w=>!ban.has(w.toLowerCase()) && w.length>=4);

    const pickN = Math.min(3, Math.max(2, Math.floor(s.length/28)));
    const picked = [];
    const pool = candidates.length ? candidates : words;
    for(const w of pool){
      if(picked.length>=pickN) break;
      const lw = w.toLowerCase();
      if(!picked.map(x=>x.toLowerCase()).includes(lw)) picked.push(w);
    }
    if(!picked.length) return null;

    fillTarget = s;
    fillWords = picked;
    fillPicked = new Array(picked.length).fill("");

    let masked = s;
    picked.forEach((w)=>{
      const re = new RegExp("\\b" + w.replace(/[.*+?^${}()|[\]\\]/g,"\\$&") + "\\b", "i");
      masked = masked.replace(re, "____");
    });

    return { masked, picked };
  }

  function renderFill(){
    if(!fillBar) return;
    const collapsed = localStorage.getItem(LS_HINT_COLLAPSED) === "1";
    if(hintClosed || collapsed){
      fillBar.style.display = "none";
      return;
    }
    fillBar.style.display = "block";

    try{ fillLevelTag.textContent = (curScene && curScene.level) ? curScene.level : "A2"; }catch(_){}

    const def = getCurHint() || "";
    const built = buildFill(def);
    if(!built){
      fillMasked.textContent = "ï¼ˆæœ¬è¼ªæ²’æœ‰å¯ç”¨çš„æç¤ºå¥ï¼‰";
      fillSlots.innerHTML = "";
      fillChoices.innerHTML = "";
      return;
    }

    fillMasked.textContent = built.masked;

    fillSlots.innerHTML = "";
    built.picked.forEach((_, i)=>{
      const sp = document.createElement("span");
      sp.className = "fillSlot";
      sp.textContent = fillPicked[i] ? fillPicked[i] : `ç©ºæ ¼${i+1}`;
      sp.style.cursor = "pointer";
      sp.title = "é»ä¸€ä¸‹æ¸…é™¤é€™æ ¼";
      sp.addEventListener("click", ()=>{
        fillPicked[i] = "";
        renderFill();
      });
      fillSlots.appendChild(sp);
    });

    const extraPool = ["today","tomorrow","ticket","train","New","York","City","one-way","round-trip","afternoon","morning","cash","card","please","by","at","to"];
    const choices = [...built.picked];
    while(choices.length < built.picked.length + 2){
      const x = extraPool[Math.floor(Math.random()*extraPool.length)];
      if(!choices.includes(x)) choices.push(x);
      if(choices.length > 10) break;
    }
    shuffle(choices);

    fillChoices.innerHTML = "";
    choices.forEach((w)=>{
      const b = document.createElement("button");
      b.type="button";
      b.className="fillChoice";
      b.textContent = w;
      b.addEventListener("click", ()=>{
        const k = fillPicked.findIndex(x=>!x);
        if(k === -1) return;
        fillPicked[k] = w;
        renderFill();
      });
      fillChoices.appendChild(b);
    });
  }

  btnHintFill && btnHintFill.addEventListener("click", ()=>{
    localStorage.setItem(LS_HINT_COLLAPSED, "0");
    applyHintUI();
    renderFill();
  });

  btnFillHide && btnFillHide.addEventListener("click", ()=>{
    if(fillBar) fillBar.style.display="none";
  });

  btnFillReset && btnFillReset.addEventListener("click", ()=>{
    renderFill();
  });

  btnFillSubmit && btnFillSubmit.addEventListener("click", async ()=>{
    if(!fillTarget) return;
    let out = fillTarget;
    for(const w of fillPicked){
      if(!w){ showSoftHint("é‚„æ²’å¡«å®Œå–”ï½", 1400); return; }
      out = out.replace("____", w);
    }
    await handleUser(out);
  });

  // --- speech recognition ---
  const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
  let rec = null;
  if(SpeechRec){
    rec = new SpeechRec();
    rec.lang = "en-US";
    rec.interimResults = false;
    rec.maxAlternatives = 1;
  }

  function qs(name){ return new URL(location.href).searchParams.get(name); }
  function setQs(name, value){
    const u = new URL(location.href);
    u.searchParams.set(name, value);
    history.replaceState(null, "", u.toString());
  }

  // è¶…å¯¬é¬†éé—œï¼ˆé¿å…å¡é—œï¼‰
  function norm(s){ return String(s||"").trim().toLowerCase(); }
  function simpleOk(userText, hint){
    const t = norm(userText);
    const h = norm(hint);
    if(!h) return true;
    if(t === h) return true;
    const tokens = h.split(/[^a-z]+/).filter(w=>w.length>=4);
    if(tokens.some(w=>t.includes(w))) return true;
    if(["ok","okay","yes","yeah","yep","thanks","thank you"].some(p=>t===p || t.startsWith(p+" "))) return true;
    return false;
  }

  // âœ… å…§åµŒæƒ…å¢ƒç´¢å¼• + æƒ…å¢ƒè³‡æ–™ï¼ˆfile:// ä¹Ÿèƒ½è·‘ï¼Œä¸ç”¨ fetchï¼‰
  let scenes = [{"id": "coffee_shop", "title_zh": "è²·ä¸€æ¯å’–å•¡", "title_en": "Coffee Shop", "level": "A1", "role": "Barista", "avatar": "assets/avatars/teacher-blonde.jpg"}, {"id": "hotel_checkin", "title_zh": "é£¯åº—å…¥ä½", "title_en": "Hotel Check-in", "level": "A1", "role": "Front Desk", "avatar": "assets/avatars/teacher-blonde.jpg"}, {"id": "restaurant_order", "title_zh": "é¤å»³é»é¤", "title_en": "Restaurant Order", "level": "A1", "role": "Server", "avatar": "assets/avatars/teacher-blonde.jpg"}, {"id": "airport_checkin", "title_zh": "æ©Ÿå ´å ±åˆ°", "title_en": "Airport Check-in", "level": "A2", "role": "Airline Staff", "avatar": "assets/avatars/teacher-blonde.jpg"}, {"id": "business_meeting", "title_zh": "å•†å‹™æœƒè­°é–‹å ´", "title_en": "Business Meeting Opening", "level": "A2", "role": "Colleague", "avatar": "assets/avatars/teacher-blonde.jpg"}, {"id": "speaking-one-way-ticket", "title_zh": "å–®ç¨‹ç¥¨ï½œå£èªªè¨“ç·´", "title_en": "One-way Ticket (Speaking)", "level": "A2", "role": "Ticket Clerk", "avatar": "assets/avatars/teacher-blonde.jpg"}];
  const sceneDataCache = {"coffee_shop": {"id": "coffee_shop", "level": "A1", "title_zh": "è²·ä¸€æ¯å’–å•¡", "title_en": "Coffee Shop", "role": {"ai_name": "Mia", "ai_title": "Barista"}, "meta": {"missions": [{"id": 1, "text": "å‘Šè¨´åº—å“¡ä½ æƒ³é»ä¸€æ¯å’–å•¡ã€‚", "complete_on_step": "u2"}, {"id": 2, "text": "èªªæ˜æ¯å‹ / æ˜¯å¦åŠ å¥¶æˆ–ç³–ã€‚", "complete_on_step": "u6"}, {"id": 3, "text": "å®Œæˆä»˜æ¬¾èˆ‡æ”¶å°¾ã€‚", "complete_on_step": "u11"}], "examples": [{"en": "Can I get a black coffee, please?", "zh": "æˆ‘å¯ä»¥è¦ä¸€æ¯é»‘å’–å•¡å—ï¼Ÿ"}, {"en": "Iâ€™d like a latte, please.", "zh": "æˆ‘æƒ³è¦ä¸€æ¯æ‹¿éµã€‚"}, {"en": "Medium, please. No sugar.", "zh": "ä¸­æ¯ï¼Œè¬è¬ã€‚ä¸åŠ ç³–ã€‚"}], "key_vocab": [{"w": "coffee", "zh": "å’–å•¡", "note": "KAW-fee"}, {"w": "latte", "zh": "æ‹¿éµ", "note": "LAH-tay"}, {"w": "black", "zh": "é»‘å’–å•¡", "note": "ä¸åŠ å¥¶"}, {"w": "milk", "zh": "ç‰›å¥¶", "note": ""}, {"w": "sugar", "zh": "ç³–", "note": ""}, {"w": "small/medium/large", "zh": "å°/ä¸­/å¤§", "note": ""}]}, "dialogue": [{"id": "a1", "speaker": "AI", "en": "Welcome to our cafe! What would you like today?", "zh": "æ­¡è¿å…‰è‡¨ï¼ä»Šå¤©æƒ³å–ä»€éº¼ï¼Ÿ"}, {"id": "u2", "speaker": "USER", "hint_en": "Can I get a coffee, please?", "hint_zh": "æˆ‘å¯ä»¥è¦ä¸€æ¯å’–å•¡å—ï¼Ÿ"}, {"id": "a3", "speaker": "AI", "en": "Sure. Would you like it black or with milk?", "zh": "å¥½çš„ã€‚è¦é»‘å’–å•¡é‚„æ˜¯åŠ å¥¶ï¼Ÿ"}, {"id": "u4", "speaker": "USER", "hint_en": "Black, please.", "hint_zh": "é»‘å’–å•¡ï¼Œè¬è¬ã€‚"}, {"id": "a5", "speaker": "AI", "en": "What size would you like: small, medium, or large?", "zh": "è¦å°æ¯ã€ä¸­æ¯é‚„æ˜¯å¤§æ¯ï¼Ÿ"}, {"id": "u6", "speaker": "USER", "hint_en": "Medium, please. No sugar.", "hint_zh": "ä¸­æ¯ï¼Œè¬è¬ã€‚ä¸åŠ ç³–ã€‚"}, {"id": "a7", "speaker": "AI", "en": "Great. Anything else?", "zh": "å¥½çš„ã€‚é‚„éœ€è¦åˆ¥çš„å—ï¼Ÿ"}, {"id": "u8", "speaker": "USER", "hint_en": "Thatâ€™s all, thanks.", "hint_zh": "å°±é€™æ¨£ï¼Œè¬è¬ã€‚"}, {"id": "a9", "speaker": "AI", "en": "Your total is five dollars.", "zh": "ä¸€å…±äº”å…ƒã€‚"}, {"id": "u10", "speaker": "USER", "hint_en": "Here you go.", "hint_zh": "çµ¦ä½ ã€‚"}, {"id": "a11", "speaker": "AI", "en": "Thanks! Your coffee will be ready soon.", "zh": "è¬è¬ï¼å’–å•¡å¾ˆå¿«å°±å¥½ã€‚"}, {"id": "u12", "speaker": "USER", "hint_en": "Thank you!", "hint_zh": "è¬è¬ï¼"}], "feedback_tiers": [{"min": 0, "max": 39, "title": "å†è©¦ä¸€æ¬¡ä¹Ÿæ²’é—œä¿‚ ğŸ‘", "summary": "ä½ é‚„åœ¨ç†Ÿæ‚‰é»é¤æµç¨‹ï¼Œéƒ¨åˆ†å›ç­”æ²’æœ‰å®Œæˆä»»å‹™ã€‚", "metric_notes": {"relevance": "å›ç­”æœ‰å‡ºç¾ï¼Œä½†èˆ‡é»é¤æƒ…å¢ƒä¸å¤ è²¼åˆã€‚", "pronunciation": "é—œéµå–®å­—ä¸å¤ æ¸…æ¥šï¼ˆcoffee/latte/pleaseï¼‰ã€‚", "vocab": "å…ˆç”¨ç°¡å–®å¥å°±å¥½ï¼Œä¸ç”¨è¿½æ±‚å¤šå–®å­—ã€‚"}, "one_fix": {"original": "I want coffee.", "better": "Can I get a coffee, please?"}, "ai_message": "æ²’é—œä¿‚ï¼Œå¾ä¸€å¥é–‹å§‹ç·´å°±å¥½ï¼Œæˆ‘æœƒé™ªä½ ä¸€èµ·ä¾†ã€‚", "cta": "retry"}, {"min": 40, "max": 59, "title": "ä¸éŒ¯çš„é–‹å§‹ï¼", "summary": "ä½ å®Œæˆäº†éƒ¨åˆ†ä»»å‹™ï¼Œä½†è¡¨é”é‚„ä¸å¤ ç©©å®šã€‚", "metric_notes": {"relevance": "å¤§è‡´ç¬¦åˆé»é¤ï¼Œä½†æœ‰äº›å¥å­åèŠå¤©ã€‚", "pronunciation": "coffee / black / medium å†æ¸…æ¥šä¸€é»æœƒæ›´å¥½ã€‚", "vocab": "å¥å­å¯ä»¥æ›´çŸ­ã€æ›´ç›´æ¥ã€‚"}, "one_fix": {"original": "I want a coffee.", "better": "Can I get a black coffee, please?"}, "ai_message": "æ–¹å‘æ˜¯å°çš„ï¼æŠŠå¥å­èªªçŸ­ä¸€é»ï¼Œæœƒé€²æ­¥å¾ˆå¿«ã€‚", "cta": "practice_once_more"}, {"min": 60, "max": 74, "title": "åšå¾—ä¸éŒ¯ï¼", "summary": "ä½ å·²å®Œæˆä¸»è¦ä»»å‹™ï¼Œè¡¨é”å¤§è‡´è‡ªç„¶ã€‚", "metric_notes": {"relevance": "é»é¤æµç¨‹å®Œæ•´ã€‚", "pronunciation": "å¶æœ‰ä¸æ¸…æ¥šä½†ä¸å½±éŸ¿ç†è§£ã€‚", "vocab": "ç”¨å­—æ°ç•¶ã€‚"}, "one_fix": {"original": "I want a coffee.", "better": "Iâ€™d like a coffee, please."}, "ai_message": "ä½ å·²ç¶“èƒ½æ‡‰ä»˜é»é¤äº†ï¼Œä¸‹æ¬¡å°ˆæ³¨èªæ°£å°±æ›´è‡ªç„¶ã€‚", "cta": "next_or_advanced"}, {"min": 75, "max": 89, "title": "å¾ˆå¥½ï¼ğŸ‘", "summary": "ä½ çš„å°è©±è‡ªç„¶æµæš¢ï¼Œæ¥è¿‘æ¯èªä½¿ç”¨è€…ã€‚", "metric_notes": {"relevance": "å®Œå…¨è²¼åˆæƒ…å¢ƒã€‚", "pronunciation": "ç™¼éŸ³æ¸…æ¥šã€‚", "vocab": "ç”¨å­—å¾—é«”ã€‚"}, "one_fix": {"original": "Medium latte, no sugar.", "better": "Can I get a medium latte with no sugar, please?"}, "ai_message": "è¡¨ç¾å¾ˆå¥½ï¼ä½ å·²ç¶“å¯ä»¥åœ¨çœŸå¯¦æƒ…å¢ƒä¸­ä½¿ç”¨äº†ã€‚", "cta": "unlock_real"}, {"min": 90, "max": 100, "title": "å¤ªæ£’äº†ï¼ğŸŒŸ", "summary": "éå¸¸è‡ªç„¶ï¼Œå¹¾ä¹åƒæ¯èªè€…ã€‚", "metric_notes": {"relevance": "ä¸»é¡Œå®Œå…¨æŒæ¡ã€‚", "pronunciation": "ç™¼éŸ³è‡ªç„¶ã€‚", "vocab": "å¥å‹éˆæ´»ã€‚"}, "one_fix": {"original": "Give me a coffee.", "better": "Could I get a coffee when you have a moment?"}, "ai_message": "é€™æ¨£çš„è¡¨é”åœ¨åœ‹å¤–å®Œå…¨æ²’å•é¡Œï¼Œåšå¾—éå¸¸å¥½ï¼", "cta": "next"}]}, "hotel_checkin": {"id": "hotel_checkin", "level": "A1", "title_zh": "é£¯åº—å…¥ä½", "title_en": "Hotel Check-in", "role": {"ai_name": "Liam", "ai_title": "Front Desk"}, "meta": {"missions": [{"id": 1, "text": "å‘Šè¨´æ«ƒå°ä½ æœ‰è¨‚æˆ¿ã€‚", "complete_on_step": "u2"}, {"id": 2, "text": "å‡ºç¤ºè­‰ä»¶ä¸¦ç¢ºèªæˆ¿å‹ã€‚", "complete_on_step": "u6"}, {"id": 3, "text": "æ‹¿åˆ°æˆ¿å¡ä¸¦æ”¶å°¾ã€‚", "complete_on_step": "u12"}], "examples": [{"en": "I have a reservation under Chen.", "zh": "æˆ‘ç”¨é™³é€™å€‹å§“è¨‚æˆ¿ã€‚"}, {"en": "Here is my passport.", "zh": "é€™æ˜¯æˆ‘çš„è­·ç…§ã€‚"}, {"en": "Could I have a room key, please?", "zh": "æˆ‘å¯ä»¥æ‹¿æˆ¿å¡å—ï¼Ÿ"}], "key_vocab": [{"w": "reservation", "zh": "è¨‚æˆ¿", "note": "rez-er-VAY-shun"}, {"w": "passport", "zh": "è­·ç…§", "note": "PASS-port"}, {"w": "single/double", "zh": "å–®äºº/é›™äººæˆ¿", "note": ""}, {"w": "room key", "zh": "æˆ¿å¡", "note": ""}, {"w": "third floor", "zh": "ä¸‰æ¨“", "note": ""}]}, "dialogue": [{"id": "a1", "speaker": "AI", "en": "Good evening. Welcome! How can I help you?", "zh": "æ™šå®‰ï¼Œæ­¡è¿å…‰è‡¨ï¼æˆ‘èƒ½å¹«æ‚¨ä»€éº¼ï¼Ÿ"}, {"id": "u2", "speaker": "USER", "hint_en": "Hi, I have a reservation.", "hint_zh": "ä½ å¥½ï¼Œæˆ‘æœ‰è¨‚æˆ¿ã€‚"}, {"id": "a3", "speaker": "AI", "en": "Great. What name is the reservation under?", "zh": "å¥½çš„ã€‚è¨‚æˆ¿å§“åæ˜¯ï¼Ÿ"}, {"id": "u4", "speaker": "USER", "hint_en": "Itâ€™s under Chen.", "hint_zh": "å§“é™³ã€‚"}, {"id": "a5", "speaker": "AI", "en": "May I see your passport, please?", "zh": "å¯ä»¥çœ‹ä¸€ä¸‹è­·ç…§å—ï¼Ÿ"}, {"id": "u6", "speaker": "USER", "hint_en": "Sure. Here you are.", "hint_zh": "ç•¶ç„¶ï¼Œçµ¦ä½ ã€‚"}, {"id": "a7", "speaker": "AI", "en": "Thank you. You booked a single room for two nights, correct?", "zh": "è¬è¬ã€‚æ‚¨è¨‚çš„æ˜¯å–®äººæˆ¿å…©æ™šï¼Œå°å—ï¼Ÿ"}, {"id": "u8", "speaker": "USER", "hint_en": "Yes, thatâ€™s right.", "hint_zh": "å°ï¼Œæ²’éŒ¯ã€‚"}, {"id": "a9", "speaker": "AI", "en": "Perfect. Here is your room key.", "zh": "å¥½çš„ï¼Œé€™æ˜¯æ‚¨çš„æˆ¿å¡ã€‚"}, {"id": "a10", "speaker": "AI", "en": "Your room is on the third floor.", "zh": "æ‚¨çš„æˆ¿é–“åœ¨ä¸‰æ¨“ã€‚"}, {"id": "u11", "speaker": "USER", "hint_en": "Thank you. What time is breakfast?", "hint_zh": "è¬è¬ã€‚æ—©é¤å¹¾é»ï¼Ÿ"}, {"id": "a12", "speaker": "AI", "en": "Breakfast is from 7 to 10 a.m. Enjoy your stay!", "zh": "æ—©é¤ 7 åˆ° 10 é»ã€‚ç¥æ‚¨å…¥ä½æ„‰å¿«ï¼"}], "feedback_tiers": [{"min": 0, "max": 39, "title": "å†è©¦ä¸€æ¬¡ä¹Ÿæ²’é—œä¿‚ ğŸ‘", "summary": "å…¥ä½æµç¨‹é‚„ä¸å®Œæ•´ï¼Œé—œéµå¥å¯ä»¥å…ˆç·´ç†Ÿã€‚", "metric_notes": {"relevance": "å›ç­”æœªèšç„¦åœ¨å…¥ä½æµç¨‹ã€‚", "pronunciation": "reservation / passport éœ€è¦æ›´æ¸…æ¥šã€‚", "vocab": "å…ˆç”¨ç°¡çŸ­å¥å®Œæˆä»»å‹™ã€‚"}, "one_fix": {"original": "I have booking.", "better": "I have a reservation."}, "ai_message": "å…ˆæŠŠã€I have a reservationã€ç·´é †å°±æœƒå¥½å¾ˆå¤šã€‚", "cta": "retry"}, {"min": 40, "max": 59, "title": "ä¸éŒ¯çš„é–‹å§‹ï¼", "summary": "ä½ å®Œæˆéƒ¨åˆ†å…¥ä½æ­¥é©Ÿï¼Œä½†è¡¨é”é‚„ä¸ç©©ã€‚", "metric_notes": {"relevance": "å¤§å¤šç¬¦åˆå…¥ä½æƒ…å¢ƒã€‚", "pronunciation": "passport / single room å¯å†æ¸…æ¥šã€‚", "vocab": "æ³¨æ„å† è© a çš„ä½¿ç”¨ã€‚"}, "one_fix": {"original": "I have reservation.", "better": "I have a reservation."}, "ai_message": "æ–¹å‘å°äº†ï¼æŠŠ a åŠ å›å»æœƒæ›´åƒæ¯èªè€…ã€‚", "cta": "practice_once_more"}, {"min": 60, "max": 74, "title": "åšå¾—ä¸éŒ¯ï¼", "summary": "ä½ å·²å®Œæˆä¸»è¦å…¥ä½ä»»å‹™ï¼Œè¡¨é”æ¸…æ¥šã€‚", "metric_notes": {"relevance": "æµç¨‹å®Œæ•´ã€‚", "pronunciation": "å¶æœ‰ä¸æ¸…æ¥šä½†å¯ç†è§£ã€‚", "vocab": "ç”¨å­—æ°ç•¶ã€‚"}, "one_fix": {"original": "Give me room key.", "better": "Could I have a room key, please?"}, "ai_message": "ä½ å·²ç¶“å¾ˆä¸éŒ¯äº†ï¼Œä¸‹æ¬¡æŠŠèªæ°£æ›´ç¦®è²Œæœƒæ›´å°ˆæ¥­ã€‚", "cta": "next_or_advanced"}, {"min": 75, "max": 89, "title": "å¾ˆå¥½ï¼ğŸ‘", "summary": "å…¥ä½å°è©±è‡ªç„¶æµæš¢ï¼Œæ¥è¿‘çœŸå¯¦ä½¿ç”¨ã€‚", "metric_notes": {"relevance": "éå¸¸è²¼åˆã€‚", "pronunciation": "ç™¼éŸ³æ¸…æ¥šã€‚", "vocab": "å¥å‹è‡ªç„¶ã€‚"}, "one_fix": {"original": "Breakfast time?", "better": "What time is breakfast?"}, "ai_message": "ä½ å·²ç¶“èƒ½åœ¨é£¯åº—é †åˆ©æºé€šäº†ï¼", "cta": "unlock_real"}, {"min": 90, "max": 100, "title": "å¤ªæ£’äº†ï¼ğŸŒŸ", "summary": "éå¸¸è‡ªç„¶ï¼ŒåƒçœŸçš„åœ¨æ«ƒå°å°è©±ã€‚", "metric_notes": {"relevance": "å®Œå…¨æŒæ¡ã€‚", "pronunciation": "è‡ªç„¶æ¸…æ™°ã€‚", "vocab": "å½ˆæ€§é«˜ã€‚"}, "one_fix": {"original": "I want late checkout.", "better": "Could I request a late checkout, please?"}, "ai_message": "é€™æ¨£è¬›éå¸¸åˆ°ä½ï¼ŒçœŸå¯¦æƒ…å¢ƒå®Œå…¨æ²’å•é¡Œï¼", "cta": "next"}]}, "restaurant_order": {"id": "restaurant_order", "level": "A1", "title_zh": "é¤å»³é»é¤", "title_en": "Restaurant Order", "role": {"ai_name": "Sara", "ai_title": "Server"}, "meta": {"missions": [{"id": 1, "text": "å‘æœå‹™ç”Ÿè©¢å•èœå–®æˆ–æ¨è–¦ã€‚", "complete_on_step": "u2"}, {"id": 2, "text": "é»ä¸»é¤èˆ‡é£²æ–™ã€‚", "complete_on_step": "u6"}, {"id": 3, "text": "çµå¸³æˆ–æ”¶å°¾ã€‚", "complete_on_step": "u11"}], "examples": [{"en": "Could I see the menu, please?", "zh": "å¯ä»¥çœ‹ä¸€ä¸‹èœå–®å—ï¼Ÿ"}, {"en": "Iâ€™d like to order the steak.", "zh": "æˆ‘æƒ³é»ç‰›æ’ã€‚"}, {"en": "Could we have the bill, please?", "zh": "å¯ä»¥çµå¸³å—ï¼Ÿ"}], "key_vocab": [{"w": "menu", "zh": "èœå–®", "note": ""}, {"w": "recommend", "zh": "æ¨è–¦", "note": ""}, {"w": "steak", "zh": "ç‰›æ’", "note": ""}, {"w": "bill", "zh": "å¸³å–®", "note": ""}]}, "dialogue": [{"id": "a1", "speaker": "AI", "en": "Hi! Welcome. Are you ready to order?", "zh": "ä½ å¥½ï¼æ­¡è¿å…‰è‡¨ã€‚æº–å‚™å¥½é»é¤äº†å—ï¼Ÿ"}, {"id": "u2", "speaker": "USER", "hint_en": "Could I see the menu, please?", "hint_zh": "å¯ä»¥çœ‹ä¸€ä¸‹èœå–®å—ï¼Ÿ"}, {"id": "a3", "speaker": "AI", "en": "Of course. Our pasta is very popular.", "zh": "ç•¶ç„¶ã€‚æˆ‘å€‘çš„ç¾©å¤§åˆ©éºµå¾ˆå—æ­¡è¿ã€‚"}, {"id": "u4", "speaker": "USER", "hint_en": "What do you recommend?", "hint_zh": "ä½ æ¨è–¦ä»€éº¼ï¼Ÿ"}, {"id": "a5", "speaker": "AI", "en": "I recommend the steak. Would you like it medium or well-done?", "zh": "æˆ‘æ¨è–¦ç‰›æ’ã€‚è¦ä¸‰åˆ†ç†Ÿé‚„æ˜¯å…¨ç†Ÿï¼Ÿ"}, {"id": "u6", "speaker": "USER", "hint_en": "Medium, please. And a glass of water.", "hint_zh": "ä¸‰åˆ†ç†Ÿï¼Œè¬è¬ã€‚å†ä¸€æ¯æ°´ã€‚"}, {"id": "a7", "speaker": "AI", "en": "Great. Anything else?", "zh": "å¥½çš„ã€‚é‚„éœ€è¦åˆ¥çš„å—ï¼Ÿ"}, {"id": "u8", "speaker": "USER", "hint_en": "Thatâ€™s all, thank you.", "hint_zh": "å°±é€™æ¨£ï¼Œè¬è¬ã€‚"}, {"id": "a9", "speaker": "AI", "en": "Perfect. Iâ€™ll bring your food soon.", "zh": "å¥½çš„ï¼Œæˆ‘å¾ˆå¿«é€ä¸Šä¾†ã€‚"}, {"id": "a10", "speaker": "AI", "en": "Would you like the bill now?", "zh": "ç¾åœ¨è¦çµå¸³å—ï¼Ÿ"}, {"id": "u11", "speaker": "USER", "hint_en": "Yes, could we have the bill, please?", "hint_zh": "å¥½ï¼Œå¯ä»¥çµå¸³å—ï¼Ÿ"}], "feedback_tiers": [{"min": 0, "max": 39, "title": "å†è©¦ä¸€æ¬¡ä¹Ÿæ²’é—œä¿‚ ğŸ‘", "summary": "é»é¤æµç¨‹å°šæœªå®Œæˆï¼Œå…ˆæŠŠã€çœ‹èœå–®ã€èˆ‡ã€é»ä¸»é¤ã€ç·´ç†Ÿã€‚", "metric_notes": {"relevance": "å¥å­ä¸å¤ è²¼åˆé¤å»³æƒ…å¢ƒã€‚", "pronunciation": "menu / steak / bill éœ€æ›´æ¸…æ¥šã€‚", "vocab": "å…ˆç”¨ç°¡çŸ­å¥å®Œæˆä»»å‹™ã€‚"}, "one_fix": {"original": "I want order steak.", "better": "Iâ€™d like to order the steak."}, "ai_message": "å…ˆæŠŠã€Iâ€™d like to orderâ€¦ã€é€™å€‹å¥å‹ç·´é †ã€‚", "cta": "retry"}, {"min": 40, "max": 59, "title": "ä¸éŒ¯çš„é–‹å§‹ï¼", "summary": "å·²èƒ½è¡¨é”éœ€æ±‚ï¼Œä½†å¥å‹ç•¥ç”Ÿç¡¬ã€‚", "metric_notes": {"relevance": "å¤§å¤šç¬¦åˆé»é¤ã€‚", "pronunciation": "order / recommend å†æ¸…æ¥šä¸€é»ã€‚", "vocab": "å¥å­å¯æ›´ç¦®è²Œã€‚"}, "one_fix": {"original": "Give me menu.", "better": "Could I see the menu, please?"}, "ai_message": "åŠ ä¸Š please æœƒæ›´è‡ªç„¶æœ‰ç¦®è²Œã€‚", "cta": "practice_once_more"}, {"min": 60, "max": 74, "title": "åšå¾—ä¸éŒ¯ï¼", "summary": "ä»»å‹™å®Œæˆï¼Œè¡¨é”æ¸…æ¥šã€‚", "metric_notes": {"relevance": "æµç¨‹å®Œæ•´ã€‚", "pronunciation": "å¯ç†è§£ã€‚", "vocab": "ç”¨å­—æ°ç•¶ã€‚"}, "one_fix": {"original": "Bill!", "better": "Could we have the bill, please?"}, "ai_message": "ä½ å·²ç¶“èƒ½åœ¨é¤å»³é †åˆ©é»é¤äº†ï¼", "cta": "next_or_advanced"}, {"min": 75, "max": 89, "title": "å¾ˆå¥½ï¼ğŸ‘", "summary": "å°è©±è‡ªç„¶ï¼Œæ¥è¿‘çœŸå¯¦æƒ…å¢ƒã€‚", "metric_notes": {"relevance": "éå¸¸è²¼åˆã€‚", "pronunciation": "æ¸…æ¥šè‡ªç„¶ã€‚", "vocab": "å¥å‹æµæš¢ã€‚"}, "one_fix": {"original": "Medium.", "better": "Medium, please."}, "ai_message": "è¡¨ç¾å¾ˆå¥½ï¼èªæ°£å¾ˆåˆ°ä½ã€‚", "cta": "unlock_real"}, {"min": 90, "max": 100, "title": "å¤ªæ£’äº†ï¼ğŸŒŸ", "summary": "éå¸¸è‡ªç„¶ï¼ŒåƒçœŸçš„åœ¨é¤å»³ç”¨è‹±æ–‡é»é¤ã€‚", "metric_notes": {"relevance": "å®Œå…¨æŒæ¡ã€‚", "pronunciation": "æ¯èªæ„Ÿã€‚", "vocab": "å½ˆæ€§é«˜ã€‚"}, "one_fix": {"original": "No ice.", "better": "Could I have it with no ice, please?"}, "ai_message": "ä½ å·²ç¶“å¯ä»¥ç›´æ¥åœ¨åœ‹å¤–é¤å»³ä½¿ç”¨äº†ï¼", "cta": "next"}]}, "airport_checkin": {"id": "airport_checkin", "level": "A2", "title_zh": "æ©Ÿå ´å ±åˆ°", "title_en": "Airport Check-in", "role": {"ai_name": "Alex", "ai_title": "Airline Staff"}, "meta": {"missions": [{"id": 1, "text": "å‘Šè¨´æ«ƒå°ä½ è¦è¾¦ç†å ±åˆ°ã€‚", "complete_on_step": "u2"}, {"id": 2, "text": "å›ç­”è¡Œæèˆ‡åº§ä½å•é¡Œã€‚", "complete_on_step": "u6"}, {"id": 3, "text": "æ‹¿åˆ°ç™»æ©Ÿè­‰ä¸¦æ”¶å°¾ã€‚", "complete_on_step": "u12"}], "examples": [{"en": "Iâ€™d like to check in for my flight.", "zh": "æˆ‘æƒ³è¾¦ç†èˆªç­å ±åˆ°ã€‚"}, {"en": "I have one checked bag.", "zh": "æˆ‘æœ‰ä¸€ä»¶æ‰˜é‹è¡Œæã€‚"}, {"en": "Could I have an aisle seat, please?", "zh": "æˆ‘æƒ³è¦èµ°é“åº§ä½ã€‚"}], "key_vocab": [{"w": "check in", "zh": "å ±åˆ°", "note": ""}, {"w": "boarding pass", "zh": "ç™»æ©Ÿè­‰", "note": ""}, {"w": "checked bag", "zh": "æ‰˜é‹è¡Œæ", "note": ""}, {"w": "aisle seat", "zh": "èµ°é“ä½", "note": ""}]}, "dialogue": [{"id": "a1", "speaker": "AI", "en": "Hello. Where are you flying today?", "zh": "ä½ å¥½ã€‚ä»Šå¤©é£›å¾€å“ªè£¡ï¼Ÿ"}, {"id": "u2", "speaker": "USER", "hint_en": "Hi, Iâ€™d like to check in for my flight to Tokyo.", "hint_zh": "ä½ å¥½ï¼Œæˆ‘è¦è¾¦ç†é£›å¾€æ±äº¬çš„å ±åˆ°ã€‚"}, {"id": "a3", "speaker": "AI", "en": "May I see your passport, please?", "zh": "å¯ä»¥çœ‹ä¸€ä¸‹è­·ç…§å—ï¼Ÿ"}, {"id": "u4", "speaker": "USER", "hint_en": "Sure. Here it is.", "hint_zh": "ç•¶ç„¶ï¼Œçµ¦ä½ ã€‚"}, {"id": "a5", "speaker": "AI", "en": "Do you have any bags to check?", "zh": "æœ‰è¡Œæè¦æ‰˜é‹å—ï¼Ÿ"}, {"id": "u6", "speaker": "USER", "hint_en": "Yes, I have one checked bag.", "hint_zh": "æœ‰ï¼Œæˆ‘æœ‰ä¸€ä»¶æ‰˜é‹è¡Œæã€‚"}, {"id": "a7", "speaker": "AI", "en": "Would you like a window or an aisle seat?", "zh": "è¦é çª—é‚„æ˜¯èµ°é“ï¼Ÿ"}, {"id": "u8", "speaker": "USER", "hint_en": "An aisle seat, please.", "hint_zh": "èµ°é“ä½ï¼Œè¬è¬ã€‚"}, {"id": "a9", "speaker": "AI", "en": "Great. Here is your boarding pass.", "zh": "å¥½çš„ï¼Œé€™æ˜¯æ‚¨çš„ç™»æ©Ÿè­‰ã€‚"}, {"id": "a10", "speaker": "AI", "en": "Boarding starts at 6:30 at Gate 12.", "zh": "6:30 åœ¨ 12 è™Ÿç™»æ©Ÿé–€é–‹å§‹ç™»æ©Ÿã€‚"}, {"id": "u11", "speaker": "USER", "hint_en": "Thank you. Where is Gate 12?", "hint_zh": "è¬è¬ã€‚12 è™Ÿç™»æ©Ÿé–€åœ¨å“ªï¼Ÿ"}, {"id": "a12", "speaker": "AI", "en": "Go straight and turn left. Have a nice flight!", "zh": "ç›´èµ°å†å·¦è½‰ã€‚ç¥æ‚¨æ—…é€”æ„‰å¿«ï¼"}], "feedback_tiers": [{"min": 0, "max": 39, "title": "å†è©¦ä¸€æ¬¡ä¹Ÿæ²’é—œä¿‚ ğŸ‘", "summary": "å ±åˆ°æµç¨‹å°šæœªå®Œæˆï¼Œå…ˆæŠŠã€check in / è¡Œæ / åº§ä½ã€ç·´ç†Ÿã€‚", "metric_notes": {"relevance": "å›ç­”æœªèšç„¦å ±åˆ°æµç¨‹ã€‚", "pronunciation": "boarding pass / checked bag éœ€æ›´æ¸…æ¥šã€‚", "vocab": "å…ˆç”¨æ¨™æº–å¥å®Œæˆä»»å‹™ã€‚"}, "one_fix": {"original": "I have luggage.", "better": "I have one checked bag."}, "ai_message": "å…ˆæŠŠã€I have one checked bagã€ç·´é †å°±æœƒé€²æ­¥å¾ˆå¿«ã€‚", "cta": "retry"}, {"min": 40, "max": 59, "title": "ä¸éŒ¯çš„é–‹å§‹ï¼", "summary": "ä½ å®Œæˆéƒ¨åˆ†ä»»å‹™ï¼Œä½†å›ç­”å¯æ›´ç²¾æº–ã€‚", "metric_notes": {"relevance": "å¤§å¤šç¬¦åˆå ±åˆ°æƒ…å¢ƒã€‚", "pronunciation": "check in / aisle å†æ¸…æ¥šä¸€é»ã€‚", "vocab": "å¥å­å¯æ›´ç›´æ¥ã€‚"}, "one_fix": {"original": "I want aisle.", "better": "An aisle seat, please."}, "ai_message": "æ–¹å‘å°äº†ï¼è£œä¸Š seat æœƒæ›´å®Œæ•´ã€‚", "cta": "practice_once_more"}, {"min": 60, "max": 74, "title": "åšå¾—ä¸éŒ¯ï¼", "summary": "ä»»å‹™å®Œæˆï¼Œè¡¨é”æ¸…æ¥šã€‚", "metric_notes": {"relevance": "æµç¨‹å®Œæ•´ã€‚", "pronunciation": "å¯ç†è§£ã€‚", "vocab": "ç”¨å­—åˆé©ã€‚"}, "one_fix": {"original": "Gate 12 where?", "better": "Where is Gate 12?"}, "ai_message": "ä½ å·²ç¶“èƒ½å®Œæˆæ©Ÿå ´å ±åˆ°å°è©±äº†ï¼", "cta": "next_or_advanced"}, {"min": 75, "max": 89, "title": "å¾ˆå¥½ï¼ğŸ‘", "summary": "å°è©±è‡ªç„¶æµæš¢ï¼Œæ¥è¿‘çœŸå¯¦æ©Ÿå ´æºé€šã€‚", "metric_notes": {"relevance": "éå¸¸è²¼åˆã€‚", "pronunciation": "æ¸…æ¥šè‡ªç„¶ã€‚", "vocab": "å¥å‹æµæš¢ã€‚"}, "one_fix": {"original": "One bag.", "better": "I have one checked bag."}, "ai_message": "å¾ˆæ£’ï¼ä½ å·²ç¶“å¾ˆåƒçœŸçš„åœ¨æ«ƒå°å ±åˆ°ã€‚", "cta": "unlock_real"}, {"min": 90, "max": 100, "title": "å¤ªæ£’äº†ï¼ğŸŒŸ", "summary": "éå¸¸è‡ªç„¶ï¼ŒåƒçœŸå¯¦æ—…å®¢çš„è‹±æ–‡è¡¨é”ã€‚", "metric_notes": {"relevance": "å®Œå…¨æŒæ¡ã€‚", "pronunciation": "æ¯èªæ„Ÿã€‚", "vocab": "å½ˆæ€§é«˜ã€‚"}, "one_fix": {"original": "Change seat?", "better": "Could I change my seat, if possible?"}, "ai_message": "é€™æ¨£è¬›éå¸¸åˆ°ä½ï¼ŒçœŸå¯¦æƒ…å¢ƒå®Œå…¨æ²’å•é¡Œï¼", "cta": "next"}]}, "business_meeting": {"id": "business_meeting", "level": "A2", "title_zh": "å•†å‹™æœƒè­°é–‹å ´", "title_en": "Business Meeting Opening", "role": {"ai_name": "Daniel", "ai_title": "Colleague"}, "meta": {"missions": [{"id": 1, "text": "ç¦®è²Œæ‰“æ‹›å‘¼ä¸¦è‡ªæˆ‘ä»‹ç´¹ã€‚", "complete_on_step": "u2"}, {"id": 2, "text": "ç¢ºèªæœƒè­°ç›®çš„ / è­°ç¨‹ã€‚", "complete_on_step": "u6"}, {"id": 3, "text": "æ”¶å°¾ä¸¦åŒæ„ä¸‹ä¸€æ­¥ã€‚", "complete_on_step": "u10"}], "examples": [{"en": "Itâ€™s great to meet you today.", "zh": "å¾ˆé«˜èˆˆä»Šå¤©è¦‹åˆ°ä½ ã€‚"}, {"en": "Could we review the agenda?", "zh": "æˆ‘å€‘å¯ä»¥çœ‹ä¸€ä¸‹è­°ç¨‹å—ï¼Ÿ"}, {"en": "Letâ€™s follow up by email.", "zh": "æˆ‘å€‘ç”¨ email å¾ŒçºŒè·Ÿé€²ã€‚"}], "key_vocab": [{"w": "agenda", "zh": "è­°ç¨‹", "note": ""}, {"w": "schedule", "zh": "è¡Œç¨‹/å®‰æ’", "note": ""}, {"w": "follow up", "zh": "è·Ÿé€²", "note": ""}, {"w": "next steps", "zh": "ä¸‹ä¸€æ­¥", "note": ""}]}, "dialogue": [{"id": "a1", "speaker": "AI", "en": "Hi, thanks for joining the meeting.", "zh": "å—¨ï¼Œè¬è¬ä½ åƒåŠ æœƒè­°ã€‚"}, {"id": "u2", "speaker": "USER", "hint_en": "Hi, Iâ€™m Ray. Itâ€™s great to meet you.", "hint_zh": "å—¨ï¼Œæˆ‘æ˜¯ Rayã€‚å¾ˆé«˜èˆˆèªè­˜ä½ ã€‚"}, {"id": "a3", "speaker": "AI", "en": "Great to meet you too. Shall we start?", "zh": "æˆ‘ä¹Ÿå¾ˆé«˜èˆˆã€‚é‚£æˆ‘å€‘é–‹å§‹å—ï¼Ÿ"}, {"id": "u4", "speaker": "USER", "hint_en": "Yes. Could we review the agenda first?", "hint_zh": "å¥½ã€‚æˆ‘å€‘å¯ä»¥å…ˆçœ‹ä¸€ä¸‹è­°ç¨‹å—ï¼Ÿ"}, {"id": "a5", "speaker": "AI", "en": "Sure. Today weâ€™ll discuss timeline and budget.", "zh": "å¯ä»¥ã€‚ä»Šå¤©è¨è«–æ™‚ç¨‹èˆ‡é ç®—ã€‚"}, {"id": "u6", "speaker": "USER", "hint_en": "Sounds good. Whatâ€™s the timeline?", "hint_zh": "äº†è§£ã€‚æ™‚ç¨‹æ˜¯æ€éº¼å®‰æ’ï¼Ÿ"}, {"id": "a7", "speaker": "AI", "en": "We plan to finish in two weeks.", "zh": "æˆ‘å€‘è¨ˆç•«å…©é€±å…§å®Œæˆã€‚"}, {"id": "u8", "speaker": "USER", "hint_en": "Great. Letâ€™s confirm next steps by email.", "hint_zh": "å¾ˆå¥½ã€‚æˆ‘å€‘ç”¨ email ç¢ºèªä¸‹ä¸€æ­¥ã€‚"}, {"id": "a9", "speaker": "AI", "en": "Perfect. Iâ€™ll send a summary after the meeting.", "zh": "å¥½çš„ã€‚æˆ‘æœƒå¾Œå¯„å‡ºæ‘˜è¦ã€‚"}, {"id": "u10", "speaker": "USER", "hint_en": "Thank you. Talk to you soon.", "hint_zh": "è¬è¬ï¼Œä¹‹å¾Œå†è¯çµ¡ã€‚"}], "feedback_tiers": [{"min": 0, "max": 39, "title": "å†è©¦ä¸€æ¬¡ä¹Ÿæ²’é—œä¿‚ ğŸ‘", "summary": "æœƒè­°é–‹å ´å¥å‹é‚„ä¸ç†Ÿï¼Œå…ˆç·´å›ºå®šæ¨¡æ¿å°±å¥½ã€‚", "metric_notes": {"relevance": "å¥å­æœªèšç„¦æœƒè­°æƒ…å¢ƒã€‚", "pronunciation": "agenda / schedule å»ºè­°å†æ¸…æ¥šã€‚", "vocab": "ç”¨ç°¡çŸ­æ­£å¼å¥å³å¯ã€‚"}, "one_fix": {"original": "Nice meet.", "better": "Itâ€™s great to meet you."}, "ai_message": "å…ˆæŠŠã€Itâ€™s great to meet youã€ç·´é †ï¼Œæœƒç«‹åˆ»æå‡å°ˆæ¥­æ„Ÿã€‚", "cta": "retry"}, {"min": 40, "max": 59, "title": "ä¸éŒ¯çš„é–‹å§‹ï¼", "summary": "èƒ½ç¦®è²Œé–‹å ´ï¼Œä½†å¥å‹ç•¥ç”Ÿç¡¬ã€‚", "metric_notes": {"relevance": "åŸºæœ¬ç¬¦åˆå•†å‹™æƒ…å¢ƒã€‚", "pronunciation": "review / agenda å†æ¸…æ¥šä¸€é»ã€‚", "vocab": "å¯åŠ ä¸Šç¦®è²Œèªæ°£ã€‚"}, "one_fix": {"original": "We see agenda?", "better": "Could we review the agenda?"}, "ai_message": "åŠ ä¸Š Could weâ€¦ æœƒæ›´è‡ªç„¶ã€æ›´å•†å‹™ã€‚", "cta": "practice_once_more"}, {"min": 60, "max": 74, "title": "åšå¾—ä¸éŒ¯ï¼", "summary": "ä½ å·²èƒ½å®Œæˆæœƒè­°é–‹å ´ï¼Œè¡¨é”æ¸…æ¥šã€‚", "metric_notes": {"relevance": "æµç¨‹å®Œæ•´ã€‚", "pronunciation": "å¯ç†è§£ã€‚", "vocab": "ç”¨å­—æ°ç•¶ã€‚"}, "one_fix": {"original": "Send email.", "better": "Letâ€™s follow up by email."}, "ai_message": "å¾ˆä¸éŒ¯ï¼å†åŠ ä¸€é»èªæ°£æœƒæ›´æœ‰èªªæœåŠ›ã€‚", "cta": "next_or_advanced"}, {"min": 75, "max": 89, "title": "å¾ˆå¥½ï¼ğŸ‘", "summary": "é–‹å ´è‡ªç„¶æµæš¢ï¼Œå¾ˆåƒçœŸå¯¦å•†å‹™å°è©±ã€‚", "metric_notes": {"relevance": "éå¸¸è²¼åˆã€‚", "pronunciation": "æ¸…æ¥šè‡ªç„¶ã€‚", "vocab": "å¥å‹æµæš¢ã€‚"}, "one_fix": {"original": "Next steps email.", "better": "Letâ€™s confirm the next steps by email."}, "ai_message": "è¡¨ç¾å¾ˆå¥½ï¼ä½ å·²ç¶“å…·å‚™å•†å‹™å ´åˆçš„è‡ªç„¶è¡¨é”ã€‚", "cta": "unlock_real"}, {"min": 90, "max": 100, "title": "å¤ªæ£’äº†ï¼ğŸŒŸ", "summary": "éå¸¸è‡ªç„¶ï¼Œåƒæœ‰ç¶“é©—çš„å•†å‹™äººå£«ã€‚", "metric_notes": {"relevance": "å®Œå…¨æŒæ¡ã€‚", "pronunciation": "æ¯èªæ„Ÿã€‚", "vocab": "å½ˆæ€§é«˜ã€‚"}, "one_fix": {"original": "Any concern?", "better": "Do you have any concerns before we proceed?"}, "ai_message": "é€™æ¨£çš„è¡¨é”éå¸¸å°ˆæ¥­ï¼ŒçœŸå¯¦æœƒè­°å®Œå…¨æ²’å•é¡Œï¼", "cta": "next"}]}};

  let curScene = null;
  let curSceneData = null;
  let steps = [];
  let idx = 0;

  function fillSelect(){
    sceneSelect.innerHTML = "";
    scenes.forEach(it=>{
      const opt = document.createElement("option");
      opt.value = it.id;
      opt.textContent = `${it.title_zh}ï½œ${it.title_en} (${it.level})`;
      sceneSelect.appendChild(opt);
    });
  }

  // Convert JSON dialogue -> TalkA steps (AI line + zh + next USER hint_en)
  function jsonToSteps(sceneJson){
    const dlg = Array.isArray(sceneJson?.dialogue) ? sceneJson.dialogue : [];
    const out = [];
    for(let i=0;i<dlg.length;i++){ 
      const row = dlg[i];
      if(!row || row.speaker !== "AI") continue;
      let hint = "";
      for(let j=i+1;j<dlg.length;j++){ 
        if(dlg[j] && dlg[j].speaker === "USER"){ hint = (dlg[j].hint_en || "").trim(); break; }
        if(dlg[j] && dlg[j].speaker === "AI") break;
      }
      out.push({ ai:String(row.en||"").trim(), zh:String(row.zh||"").trim(), hint });
    }
    return out;
  }

  

  // âœ… è‹¥ sceneDataCache æ²’æœ‰ï¼Œæ”¹ç”¨ fetch è®€å– /talk/*.jsonï¼ˆå¯æ”¯æ´æ–°å¢å ´æ™¯ï¼Œä¸å¿…æ¯æ¬¡æ”¹ talk_A.htmlï¼‰
  async function getSceneData(scene){
    const id = scene?.id || "";
    if(!id) return null;
    if(sceneDataCache[id]) return sceneDataCache[id];

    const idDash = id;
    const idUnd = String(id).replace(/-/g,"_");

    const candidates = [
      `talk/${idDash}.json`,
      `talk/${idUnd}.json`,
      `talk/scene-${idDash}.json`,
      `talk/speaking-${idDash}.json`,
      `talk/speaking-${idUnd}.json`,
    ];

    for(const url of candidates){
      try{
        const res = await fetch(url, { cache: "no-store" });
        if(!res.ok) continue;
        const data = await res.json();

        // 1) æ—¢æœ‰ Talk å ´æ™¯ schemaï¼ˆå« dialogueï¼‰
        if(Array.isArray(data?.dialogue)){
          sceneDataCache[id] = data;
          return data;
        }

        // 2) speaking schemaï¼ˆspeaking-{slug}.jsonï¼‰
        if(Array.isArray(data?.items)){
          const converted = speakingToSceneJson(scene, data);
          sceneDataCache[id] = converted;
          return converted;
        }
      }catch(e){
        // ignore and try next
      }
    }
    return null;
  }

  function speakingToSceneJson(scene, speaking){
    const items = Array.isArray(speaking?.items) ? speaking.items : [];
    const dialogue = [];
    for(let k=0;k<items.length;k++){
      const it = items[k] || {};
      const en = String(it.line_en || "").trim();
      if(!en) continue;
      const hint = String(it?.coach?.hint || "").trim();

      dialogue.push({ id: `a${k+1}`, speaker: "AI", en, zh: "" });
      dialogue.push({ id: `u${k+1}`, speaker: "USER", hint_en: hint, hint_zh: "" });
    }

    // âœ… speaking-* å ´æ™¯å°æ‡‰åˆ°æ­£å¼æ’­æ”¾å™¨ slugï¼ˆæŠŠ speaking- å»æ‰ï¼‰
    const slug = String(speaking?.slug || scene.id || "").replace(/^speaking-/, "");
    return {
      id: scene.id,
      title_zh: scene.title_zh || "",
      title_en: scene.title_en || "",
      level: scene.level || "",
      role: { ai_name: "AI", ai_title: scene.role || "Coach" },
      meta: {
        type: "speaking",
        source_url: speaking?.source_url || "",
        slug,
        player_url: `https://bookwide.net/player.html?cat=news&slug=${encodeURIComponent(slug)}`
      },
      dialogue
    };
  }
function render(){
    const s = steps[idx] || {};
    lineEN.textContent = s.ai || "â€”";
    lineZH.textContent = s.zh || "";
    lastSpoken = s.ai || "";
  }

  async function applyScene(id){
    curScene = scenes.find(x=>x.id===id) || scenes[0];
    if(!curScene) return;

    roleLabel.textContent = `AI Â· ${curScene.role || "teacher"}`;
    sceneLabel.textContent = `${curScene.title_zh}ï½œ${curScene.title_en} (${curScene.level || ""})`;

    try{
      curSceneData = await getSceneData(curScene);
      steps = curSceneData ? jsonToSteps(curSceneData) : [];
      if(!steps.length) throw new Error("no steps");
    }catch(e){
      curSceneData = null;
      steps = [{ai:"Loading failed. Please check scene json files.", zh:"è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªæƒ…å¢ƒè³‡æ–™æ˜¯å¦å­˜åœ¨ã€‚", hint:""}];
    }

    idx = 0;
    setAvatarState("idle");
    render();
    try{ await speakOrGate(lineEN.textContent); }catch(_){ }
    try{ renderFill(); }catch(_){ }
    setQs("scene", curScene.id);
  }

  async function handleUser(text){
    const userText = String(text||"").trim();
    if(!userText) return;
    heard.style.display="block";
    heard.textContent = "ä½ èªªï¼š" + userText;

    const s = steps[idx] || {};
    if(simpleOk(userText, s.hint||"")){
      if(idx < steps.length-1){
        idx++;
        render();
        await speakOrGate(lineEN.textContent);
        try{ renderFill(); }catch(_){ }
      }else{
        showSoftHint("<b>å®Œæˆï¼</b> å·²çµæŸã€‚ä½ å¯ä»¥åˆ‡æ›æƒ…å¢ƒç¹¼çºŒç·´ã€‚", 2200);
      }
      return;
    }
    const expected = (s.hint || "").trim() || "ï¼ˆå¯ç”¨ä»»æ„åˆç†å›ç­”ï¼‰";
    showSoftHint(`å†è©¦ä¸€æ¬¡ï¼šä½ å¯ä»¥ç›´æ¥èªªæˆ–æŒ‰ã€ŒâŒ¨ï¸ è¼¸å…¥ã€è²¼ä¸Šï¼š <b>${expected}</b><span class="sub">å°æŠ€å·§ï¼šæ…¢ä¸€é»ã€å°¾éŸ³æ‹‰æ¸…æ¥šï¼ˆä¾‹å¦‚ pleaseï¼‰ã€‚</span>`);
  }

  // hooks
  btnReplay.addEventListener("click", ()=>{ try{ const p = speakOrGate(lastSpoken || lineEN.textContent || ""); if(p && p.catch) p.catch(()=>{}); }catch(_){ } });
  btnSkip.addEventListener("click", async ()=>{
    if(idx < steps.length-1){ idx++; render(); await speakOrGate(lineEN.textContent); }
    else openSheet('<div class="card"><h3>å®Œæˆï¼</h3><p>å·²çµæŸã€‚</p></div>');
  });

  btnType.addEventListener("click", async ()=>{
    audioEnabled = true;
    setAvatarState("listen");
    const s = steps[idx] || {};
    const def = String(s.hint||"").trim();
    const t = prompt("è«‹è¼¸å…¥ä½ è¦å›ç­”çš„è‹±æ–‡ï¼š", def) || "";
    setAvatarState("idle");
    await handleUser(t);
  });

  btnMic.addEventListener("click", async ()=>{
    audioEnabled = true;
    if(!rec){
      const t = prompt("æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ã€‚è«‹è¼¸å…¥ä½ è¦å›ç­”çš„è‹±æ–‡ï¼š") || "";
      await handleUser(t);
      return;
    }
    try{
      btnMic.textContent = "ğŸ™ï¸ è½ä½ èªªâ€¦ï¼ˆèªªå®Œåœä¸€ä¸‹ï¼‰";
      btnMic.disabled = true;
      setAvatarState("listen");

      rec.onresult = async (e)=>{
        const t = e.results && e.results[0] && e.results[0][0] ? e.results[0][0].transcript : "";
        btnMic.textContent = "ğŸ¤ é»æˆ‘èªªï¼ˆé–‹å§‹è¾¨è­˜ï¼‰";
        btnMic.disabled = false;
        setAvatarState("idle");
        await handleUser(t);
      };
      rec.onerror = async ()=>{
        btnMic.textContent = "âŒ¨ï¸ é€™å°ä¸æ”¯æ´èªéŸ³ï¼Œæ”¹ç”¨è¼¸å…¥";
        btnMic.disabled = false;
        setAvatarState("idle");
        const t = prompt("è«‹è¼¸å…¥ä½ è¦å›ç­”çš„è‹±æ–‡ï¼š") || "";
        await handleUser(t);
      };
      rec.onend = ()=>{
        btnMic.textContent = "ğŸ¤ é»æˆ‘èªªï¼ˆé–‹å§‹è¾¨è­˜ï¼‰";
        btnMic.disabled = false;
        setAvatarState("idle");
      };
      rec.start();
    }catch(e){
      btnMic.textContent = "âŒ¨ï¸ é€™å°ä¸æ”¯æ´èªéŸ³ï¼Œæ”¹ç”¨è¼¸å…¥";
      btnMic.disabled = false;
      setAvatarState("idle");
      const t = prompt("è«‹è¼¸å…¥ä½ è¦å›ç­”çš„è‹±æ–‡ï¼š") || "";
      await handleUser(t);
    }
  });

  // Bottom sheet: ä»»å‹™ / ç¯„ä¾‹ï¼ˆåƒ json.metaï¼›å¤–è§€ä¸è®Šï¼‰
  $("btnTask").addEventListener("click", ()=>{
    const esc = (s)=>String(s??"").replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
    const meta = (curSceneData && curSceneData.meta) ? curSceneData.meta : {};
    const missions = Array.isArray(meta.missions) ? meta.missions : [];
    const playerUrl = String(meta.player || curScene?.player || ((curScene?.id||"")==="speaking-one-way-ticket" ? "https://bookwide.net/player.html?cat=news&slug=one-way-ticket" : "") );
    const curHint = (steps[idx] && (steps[idx].hint || steps[idx].hint_en)) ? String(steps[idx].hint || steps[idx].hint_en).trim() : "";

    let h = "";
    if(missions.length){
      // missions may be array of objects {text} or strings
      h += missions.map(m=>`<div class="card"><h3>ä»»å‹™</h3><p>${esc(m.text||m)}</p></div>`).join("");
    }else{
      h += `<div class="card"><h3>ä»»å‹™</h3><p>å…ˆçœ‹æƒ…å¢ƒå½±ç‰‡/æ’­æ”¾å™¨ç†Ÿæ‚‰å…§å®¹ï¼Œå†ç”¨ä¸€å¥è‹±æ–‡å›ç­”ï¼ˆç…§è®€æç¤ºä¹Ÿç®—éï¼‰ã€‚</p></div>`;
    }
    if(playerUrl){
      h += `<a class="btn" style="margin-top:10px;display:inline-flex;gap:8px;align-items:center" target="_blank" rel="noopener" href="${esc(playerUrl)}">ğŸ”— é–‹å•Ÿæ’­æ”¾å™¨ï¼ˆå…ˆç†Ÿæ‚‰å­—å¹•/å…§å®¹ï¼‰</a>`;
    }
    if(curHint){
      h += `<div class="card" style="margin-top:10px"><h3>æœ¬è¼ªæç¤º</h3><p>${esc(curHint)}</p></div>`;
    }
    openSheet("ä»»å‹™", h);
  });
$("btnExamples").addEventListener("click", ()=>{
    const esc = (s)=>String(s??"").replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
    const meta = (curSceneData && curSceneData.meta) ? curSceneData.meta : {};
    const ex = Array.isArray(meta.examples) ? meta.examples : [];
    let h = "";
    if(ex.length){
      h += ex.map(it=>`<div class="card"><h3>${esc(it.en||it)}</h3><p>${esc(it.zh||"")}</p></div>`).join("");
    }else{
      h += `<div class="card"><h3>ç¯„ä¾‹</h3><p>æœ¬æƒ…å¢ƒå°šæœªæä¾›ç¯„ä¾‹ã€‚</p></div>`;
    }
    openSheet("ç¯„ä¾‹", h);
  });
$("btnTranslate").addEventListener("click", ()=> openSheet('<div class="card"><h3>ç¿»è­¯ï¼ˆæœ¬å¥ï¼‰</h3><p>'+lineZH.textContent+'</p></div>'));
  $("btnSaved").addEventListener("click", ()=> openSheet('<div class="card"><h3>å·²å„²å­˜</h3><p>æœ€å°ç‰ˆå…ˆä¸åšã€‚</p></div>'));

  $("btnBack").addEventListener("click", ()=>{ location.href = "./index.html"; });
  sceneSelect.addEventListener("change", ()=> applyScene(sceneSelect.value));

  function bootScenes(){
    fillSelect();
    const initial = qs("scene") || (scenes[0] && scenes[0].id) || "coffee_shop";
    sceneSelect.value = initial;
    applyScene(sceneSelect.value);
    setAvatarState("idle");
  }
  // ESC closes ä»»å‹™/ç¯„ä¾‹
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ try{ missionBox.style.display='none'; examplesBox.style.display='none'; }catch(_){} }});

  bootScenes();
})();
</script>
</body>
</html>
