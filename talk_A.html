<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BookWide Talkï½œå½±åƒå£èªª MVPï¼ˆ10 å¥è…³æœ¬ï¼‰</title>
<style>

  :root{
    --bg0:#070b16;
    --bg1:#0b1224;
    --card:rgba(255,255,255,.06);
    --card2:rgba(255,255,255,.08);
    --line:rgba(255,255,255,.10);
    --ink:#eaf0ff;
    --muted:rgba(234,240,255,.70);
    --brand:#4f7cff;
    --ok:#22c55e;
    --bad:#ef4444;
    --warn:#f59e0b;
    --shadow:0 22px 70px rgba(0,0,0,.45);
    --r:22px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "Microsoft JhengHei", sans-serif;
    color:var(--ink);
    background:
      radial-gradient(1200px 600px at 12% 10%, rgba(79,124,255,.25), transparent 55%),
      radial-gradient(900px 500px at 88% 20%, rgba(34,197,94,.15), transparent 50%),
      linear-gradient(180deg, var(--bg0), var(--bg1));
  }
  .topbar{position:sticky; top:0; z-index:9; padding:14px 18px; background:rgba(6,10,22,.75); backdrop-filter: blur(14px); border-bottom:1px solid rgba(255,255,255,.08);}
  .toprow{display:flex; align-items:center; justify-content:space-between; gap:12px}
  .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.3px}
  .pill{display:inline-flex; align-items:center; gap:8px; padding:7px 12px; border-radius:999px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); font-weight:700; font-size:13px;}
  .pill small{opacity:.75; font-weight:700}
  .actions{display:flex; gap:10px; align-items:center}
  .btn{appearance:none; border:0; cursor:pointer; border-radius:14px; padding:10px 14px; background:rgba(255,255,255,.08); color:var(--ink); border:1px solid rgba(255,255,255,.12); font-weight:800; transition:.15s transform,.15s background,.15s border; user-select:none;}
  .btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.10)}
  .btn:active{transform:translateY(0px)}
  .btn.primary{background:rgba(79,124,255,.20); border-color:rgba(79,124,255,.35)}
  .btn.danger{background:rgba(239,68,68,.16); border-color:rgba(239,68,68,.30)}
  .btn.ok{background:rgba(34,197,94,.14); border-color:rgba(34,197,94,.28)}
  .btn:disabled{opacity:.45; cursor:not-allowed; transform:none}
  .wrap{padding:18px}
  .grid{display:grid; grid-template-columns: 1.15fr 0.85fr; gap:16px; align-items:stretch;}
  @media (max-width: 1040px){ .grid{grid-template-columns:1fr} }
  .card{background:var(--card); border:1px solid rgba(255,255,255,.10); border-radius:var(--r); box-shadow:var(--shadow); overflow:hidden;}
  .card-hd{padding:14px 16px; display:flex; align-items:center; justify-content:space-between; gap:10px; background:linear-gradient(180deg, rgba(255,255,255,.06), transparent); border-bottom:1px solid rgba(255,255,255,.08);}
  .card-hd .title{font-weight:900}
  .card-hd .sub{font-size:12px; color:var(--muted)}
  .card-bd{padding:14px 16px}
  .row{display:flex; gap:12px; flex-wrap:wrap}
  .field{flex:1; min-width:180px}
  label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px 2px; font-weight:800}
  select, textarea, input{width:100%; border-radius:16px; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.18); color:var(--ink); padding:12px 12px; outline:none; font-weight:800;}
  textarea{min-height:72px; resize:vertical; font-weight:700}
  .chips{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
  .chip{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); font-weight:900; font-size:12px;}
  .dot{width:8px; height:8px; border-radius:99px; background:rgba(255,255,255,.25)}
  .dot.ok{background:var(--ok)}
  .dot.bad{background:var(--bad)}
  .dot.warn{background:var(--warn)}
  .mediaGrid{display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px;}
  @media (max-width: 1040px){ .mediaGrid{grid-template-columns:1fr} }
  .mediaBox{background:rgba(0,0,0,.22); border:1px solid rgba(255,255,255,.12); border-radius:18px; overflow:hidden; position:relative; min-height:260px;}
  .mediaBox .tag{position:absolute; top:10px; left:10px; background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.16); padding:6px 10px; border-radius:999px; font-weight:900; font-size:12px; display:inline-flex; align-items:center; gap:8px; z-index:2;}
  .mediaBox video, .mediaBox img{width:100%; height:100%; object-fit:cover; display:block; background:#000;}
  .controls{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
  .help{margin-top:10px; padding:10px 12px; border-radius:16px; border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.05); color:var(--muted); font-size:12px; line-height:1.55; font-weight:700;}
  .chat{height: calc(100vh - 118px); min-height: 620px; display:flex; flex-direction:column;}
  @media (max-width: 1040px){ .chat{height:auto; min-height:520px} }
  .chatLog{padding:14px; overflow:auto; flex:1;}
  .msg{display:flex; gap:10px; align-items:flex-start; margin:0 0 12px 0;}
  .avatar{width:40px; height:40px; border-radius:14px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); overflow:hidden; flex:0 0 auto; display:flex; align-items:center; justify-content:center; font-weight:900;}
  .avatar img{width:100%; height:100%; object-fit:cover}
  .bubble{flex:1; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); border-radius:18px; padding:12px 12px;}
  .who{display:flex; justify-content:space-between; gap:10px; margin-bottom:6px}
  .who b{font-weight:900}
  .ts{font-size:12px; color:var(--muted); font-weight:800}
  .bubble .txt{font-weight:750; line-height:1.55}
  .bubble .big{font-size:22px; font-weight:1000; margin-top:8px}
  .badge{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.20); font-weight:950; font-size:12px; margin-top:10px;}
  .badge.ok{border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.12)}
  .badge.bad{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.10)}
  .kbd{display:inline-flex; align-items:center; justify-content:center; min-width:22px; height:22px; padding:0 8px; border-radius:8px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); font-size:12px; font-weight:950;}
  .chatFoot{padding:12px; border-top:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.18);}
  .inputRow{display:flex; gap:10px; align-items:center}
  .inputRow input{flex:1; padding:14px 14px; border-radius:16px; font-weight:850;}
  .miniHelp{margin-top:8px; color:var(--muted); font-size:12px; font-weight:700}
  .hintLine{margin-top:8px; padding:10px 12px; border-radius:16px; border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.05); color:var(--muted); font-size:12px; font-weight:750; line-height:1.55;}
  .splitBtns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}

  /* ===== v20260102-layout-lock ===== */
  html,body{height:100%; overflow:hidden;}
  :root{ --topbarH:72px; }

  .wrap{height: calc(100vh - var(--topbarH)); overflow:hidden;}
  .grid{height:100%; overflow:hidden;}
  .card{height:100%; display:flex; flex-direction:column; overflow:hidden;}
  .card-bd{flex:1; overflow:auto; min-height:0;}

  /* chat area should scroll inside, not page */
  .chat{height:100%; min-height:0;}
  @media (max-width: 1040px){
    html,body{overflow:auto;} /* mobile allow natural scroll */
    .wrap{height:auto; overflow:visible;}
    .grid{height:auto; overflow:visible;}
    .card{height:auto;}
    .card-bd{overflow:visible;}
    .chat{height:auto;}
  }

  /* shrink videos ~50% and keep stable */
  .mediaBox{min-height:130px; height:180px;}
  @media (max-width: 1040px){ .mediaBox{height:160px;} }
  #userVideo,#teacherVideo,#teacherImg{width:100%; height:100%; object-fit:cover; display:block;}

</style>
</head>
<body>
<div id=\"__bw_ver\" style=\"position:fixed;left:12px;bottom:12px;z-index:99999;background:rgba(0,0,0,.6);color:#fff;padding:6px 10px;border-radius:10px;font:700 12px/1.2 system-ui;letter-spacing:.4px;\">Talk A v2026-01-02 NO-FAIL MODE</div>
<script>console.log('Talk A v2026-01-02 NO-FAIL MODE loaded');</script>
  <div class="topbar">
    <div class="toprow">
      <div class="brand">
        <div style="font-size:22px;">BookWide</div>
        <span class="pill">Talk <small>å½±åƒå£èªª MVP</small></span>
        <span class="pill"><span class="kbd">A</span> <small>10 å¥è…³æœ¬ï¼ˆè·Ÿè®€æµç¨‹ï¼‰</small></span>
      </div>
      <div class="actions">
        <button class="btn danger" id="btnReset">æ¸…ç©º</button>
        <button class="btn" id="btnHome">å›é¦–é </button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <div class="card">
        <div class="card-hd">
          <div>
            <div class="title">å½±åƒ + èªªè©±ï¼ˆä½ ï¼‰</div>
            <div class="sub">å›ºå®šè…³æœ¬ï¼šè€å¸«ä¸€å¥ â†’ ä½ èªªä¸€å¥ â†’ å°äº†æ‰ä¸‹ä¸€å¥ï¼ˆå…± 10 å¥ï¼‰</div>
          </div>
          <div class="pill" id="progressPill">é€²åº¦ <b id="progNow">1</b>/<span id="progTotal">10</span></div>
        </div>

        <div class="card-bd">
          <div class="row">
            <div class="field">
              <label>æƒ…å¢ƒï¼ˆScenarioï¼‰</label>
              <select id="scenarioSel"></select>
            </div>
            <div class="field">
              <label>æç¤ºèªè¨€ï¼ˆHintsï¼‰</label>
              <select id="hintLang">
                <option value="zh">ä¸­æ–‡æç¤ºï¼ˆZHï¼‰</option>
                <option value="en">English hintsï¼ˆENï¼‰</option>
                <option value="both">ZH + EN</option>
              </select>
            </div>
          </div>

          <div class="field" style="margin-top:10px;">
            <label>æç¤ºï¼ˆå¯é¸ï¼Œæœƒå½±éŸ¿è€å¸«å£å»/é‡é»ï¼‰</label>
            <textarea id="extraHint" placeholder="ä¾‹å¦‚ï¼šæ…¢æ…¢èªªã€åªçµ¦ 1 å€‹é‡é»ã€æˆ‘æ€•æ–‡æ³•â€¦"></textarea>
          </div>

          <div class="chips">
            <span class="chip"><span class="dot" id="dotCam"></span>ç›¸æ©Ÿï¼š<b id="stCam">æœªé–‹</b></span>
            <span class="chip"><span class="dot warn" id="dotMic"></span>éº¥å…‹é¢¨ï¼š<b id="stMic">å¾…å‘½</b></span>
            <span class="chip"><span class="dot warn" id="dotAsr"></span>è¾¨è­˜ï¼š<b id="stAsr">å¾…å‘½</b></span>
          </div>

          <div class="mediaGrid">
            <div class="mediaBox">
              <div class="tag">ä½ ï¼ˆç›¸æ©Ÿï¼‰</div>
              <video id="userVideo" playsinline muted autoplay></video>
            </div>
            <div class="mediaBox">
              <div class="tag">AI è€å¸«ï¼ˆç´ æï¼‰</div>
              <video id="teacherVideo" playsinline autoplay muted loop></video>
              <img id="teacherImg" alt="AI teacher" style="display:none"/>
            </div>
          </div>

          <div class="controls">
            <button class="btn primary" id="btnCamOn">é–‹å•Ÿç›¸æ©Ÿ</button>
            <button class="btn" id="btnCamOff" disabled>é—œé–‰ç›¸æ©Ÿ</button>
            <button class="btn primary" id="btnSpeak">æŒ‰ä½èªªè©±</button>
            <button class="btn" id="btnStopAsr" disabled>åœæ­¢è¾¨è­˜</button>
            <button class="btn ok" id="btnReplayTeacher">é‡æ’­è€å¸«</button>
            <button class="btn" id="btnNext" disabled>ä¸‹ä¸€å¥</button>
          </div>

          <div class="help">
            âœ… ç”¨æ³•ï¼šå…ˆæŒ‰ã€Œé–‹å•Ÿç›¸æ©Ÿã€ï¼Œå†æŒ‰ä½ã€ŒæŒ‰ä½èªªè©±ã€è¬›ä¸€å¥è‹±æ–‡ã€‚<br/>
            âœ… é€™ç‰ˆæ˜¯ã€Œå›ºå®š 10 å¥è…³æœ¬ã€ï¼Œç­”å°æ‰æœƒè§£é–ä¸‹ä¸€å¥ã€‚<br/>
            âš ï¸ èªéŸ³è¾¨è­˜åœ¨ Chrome / Edge æœ€ç©©ï¼›æ‰‹æ©Ÿ Safari å¸¸ä¸æ”¯æ´ã€‚è‹¥ä¸æ”¯æ´ï¼Œç”¨å³é‚Šè¼¸å…¥æ¡†æ‰“å­—ä¹Ÿå¯ã€‚
          </div>
        </div>
      </div>

      <div class="card chat">
        <div class="card-hd">
          <div class="title">AI è€å¸«ï¼ˆè…³æœ¬æ•™å­¸ï¼‰</div>
          <div class="sub" id="scriptTitle">â€”</div>
        </div>

        <div class="chatLog" id="chatLog"></div>

        <div class="chatFoot">
          <div class="inputRow">
            <input id="textIn" placeholder="æˆ–ç›´æ¥æ‰“å­—ï¼šä¾‹å¦‚ I'm doing my nails." />
            <button class="btn primary" id="btnSend">é€å‡º</button>
          </div>
          <div class="miniHelp">
            å°æŠ€å·§ï¼šæŒ‰ <span class="kbd">Enter</span> é€å‡ºã€‚ç­”å°æœƒå‡ºç¾ã€Œè·Ÿè®€ã€èˆ‡ã€Œä¸‹ä¸€å¥ã€ã€‚
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
const SB_PUBLIC_BASE = 'https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/assets';
const TEACHER_MP4 = `${SB_PUBLIC_BASE}/ai/teacher.mp4`;
const TEACHER_PNG = `${SB_PUBLIC_BASE}/ai/teacher.png`;

const SCRIPTS = {
  coffee: {
    name: "coffeeï¼ˆå–å’–å•¡/é£²æ–™ï¼‰",
    lines: [
      {teacher:"Hi! What are you doing now?", expect:"I'm having coffee.", variants:["I'm getting a coffee.","I'm drinking coffee."], zh:"ç”¨ I'm having / getting / drinking + coffeeã€‚", en:"Use I'm having/getting/drinking + coffee."},
      {teacher:"Where are you having coffee?", expect:"I'm at a cafe.", variants:["I'm in a cafe.","I'm at the coffee shop."], zh:"åœ°é»ï¼šat/in + åœ°é»ï¼ˆcafe/coffee shopï¼‰ã€‚", en:"Place: at/in + place (cafe/coffee shop)."},
      {teacher:"Who are you with?", expect:"I'm with my friend.", variants:["I'm with a friend.","I'm with my friends."], zh:"ç”¨ I'm with ...", en:"Use I'm with ..."},
      {teacher:"How does it taste?", expect:"It tastes great.", variants:["It tastes good.","It tastes amazing."], zh:"It tastes + å½¢å®¹è©ã€‚", en:"It tastes + adjective."},
      {teacher:"What kind of coffee is it?", expect:"It's a latte.", variants:["It's an Americano.","It's iced coffee."], zh:"It's a + é£²å“ã€‚", en:"It's a + drink."},
      {teacher:"Do you come here often?", expect:"Yes, I come here often.", variants:["Yes, pretty often.","Yes, I come here a lot."], zh:"often / a lotã€‚", en:"often / a lot."},
      {teacher:"What will you do after this?", expect:"I'll go back to work.", variants:["I'm going back to work.","I'll get back to work."], zh:"I'll + å‹•è©ã€‚", en:"I'll + verb."},
      {teacher:"Do you want something to eat?", expect:"No, I'm fine. Thanks.", variants:["No, I'm good. Thanks.","No, thanks. I'm okay."], zh:"å©‰æ‹’ï¼šNo, I'm good/fine. Thanks.", en:"Polite no: No, I'm good/fine. Thanks."},
      {teacher:"Tell me one more sentence about the coffee.", expect:"It's warm and smells nice.", variants:["It smells great.","It's warm and delicious."], zh:"smells nice / warmã€‚", en:"smells nice / warm."},
      {teacher:"Great! Say it again clearly.", expect:"I'm having coffee.", variants:["I'm getting a coffee.","I'm drinking coffee."], zh:"é‡è¤‡ç¬¬ä¸€å¥ï¼Œèªªæ¸…æ¥šã€‚", en:"Repeat line 1 clearly."},
    ]
  },
  nails: {
    name: "nailsï¼ˆå¡—æŒ‡ç”²/ç¾ç”²ï¼‰",
    lines: [
      {teacher:"Hi! What are you doing?", expect:"I'm doing my nails.", variants:["I'm painting my nails.","I'm getting my nails done."], zh:"I'm doing/painting my nailsã€‚", en:"I'm doing/painting my nails."},
      {teacher:"What color are you using?", expect:"I'm using red.", variants:["I'm using pink.","I'm using a light color."], zh:"I'm using + é¡è‰²ã€‚", en:"I'm using + color."},
      {teacher:"Is it hard?", expect:"A little, but it's fun.", variants:["It's a bit hard, but fun.","Kind of, but I like it."], zh:"A little / a bitã€‚", en:"A little / a bit."},
      {teacher:"Why are you doing your nails today?", expect:"I want to look nice.", variants:["I want to look good.","I have an event."], zh:"I want to look + å½¢å®¹è©ã€‚", en:"I want to look + adjective."},
      {teacher:"How long does it take?", expect:"It takes about ten minutes.", variants:["About 10 minutes.","Around ten minutes."], zh:"It takes about + æ™‚é–“ã€‚", en:"It takes about + time."},
      {teacher:"Do you do this often?", expect:"Not really. Only sometimes.", variants:["Not often.","Only once in a while."], zh:"Not really / sometimesã€‚", en:"Not really / sometimes."},
      {teacher:"What will you do after that?", expect:"I'll let them dry.", variants:["I'll wait for them to dry.","I'll let it dry."], zh:"let them dryã€‚", en:"let them dry."},
      {teacher:"Show me your nails in one sentence.", expect:"They look shiny.", variants:["They look nice.","They look great."], zh:"They look + å½¢å®¹è©ã€‚", en:"They look + adjective."},
      {teacher:"Any problems?", expect:"No, everything is okay.", variants:["No problems.","All good."], zh:"No, everything is okay. / All good.", en:"No, everything is okay. / All good."},
      {teacher:"Great! Repeat the key sentence.", expect:"I'm doing my nails.", variants:["I'm painting my nails.","I'm getting my nails done."], zh:"é‡è¤‡ç¬¬ä¸€å¥ã€‚", en:"Repeat line 1."},
    ]
  },
  intro: {
    name: "introï¼ˆè‡ªæˆ‘ä»‹ç´¹ï¼‰",
    lines: [
      {teacher:"Hi! Please introduce yourself.", expect:"Hi, I'm Raymond.", variants:["Hello, I'm Raymond.","Hi, my name is Raymond."], zh:"Hi/Hello, I'm ...", en:"Hi/Hello, I'm ..."},
      {teacher:"Where are you from?", expect:"I'm from Taiwan.", variants:["I'm from Taipei.","I'm from Taiwan, Taipei."], zh:"I'm from + åœ°æ–¹ã€‚", en:"I'm from + place."},
      {teacher:"What do you do?", expect:"I work on an English-learning app.", variants:["I'm building an English-learning platform.","I build learning tools."], zh:"I work on / I'm building ...", en:"I work on / I'm building ..."},
      {teacher:"What do you like?", expect:"I like learning languages.", variants:["I like English.","I like practicing speaking."], zh:"I like + å‹•åè©/åè©ã€‚", en:"I like + gerund/noun."},
      {teacher:"What are you doing right now?", expect:"I'm practicing speaking.", variants:["I'm practicing English speaking.","I'm practicing my English."], zh:"I'm practicing ...", en:"I'm practicing ..."},
      {teacher:"What's your goal?", expect:"I want to speak more naturally.", variants:["I want to speak fluently.","I want to sound natural."], zh:"I want to + å‹•è©ã€‚", en:"I want to + verb."},
      {teacher:"How often do you practice?", expect:"I practice every day.", variants:["I practice daily.","I practice almost every day."], zh:"every day / dailyã€‚", en:"every day / daily."},
      {teacher:"What topic do you want to practice?", expect:"I want to practice daily conversations.", variants:["Daily conversation.","Real-life conversations."], zh:"daily conversationsã€‚", en:"daily conversations."},
      {teacher:"Say one polite sentence.", expect:"Nice to meet you.", variants:["Nice to meet you too.","It's nice to meet you."], zh:"Nice to meet you.", en:"Nice to meet you."},
      {teacher:"Great! Repeat your first sentence clearly.", expect:"Hi, I'm Raymond.", variants:["Hello, I'm Raymond.","Hi, my name is Raymond."], zh:"é‡è¤‡ç¬¬ä¸€å¥ã€‚", en:"Repeat line 1."},
    ]
  }
};

const $ = (id)=>document.getElementById(id);
const nowTime = ()=>new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
function norm(s){ return (s||"").toLowerCase().replace(/[â€œâ€"']/g,"").replace(/[.,!?ï¼Œã€‚ï¼ï¼Ÿ]/g,"").replace(/\s+/g," ").trim(); }
function approxMatch(user, targets){
  const u = norm(user);
  for (const t of targets){
    if (!t) continue;
    const tt = norm(t);
    if (u === tt) return true;
    if (u === tt.replace(/^im /,"") || ("im "+u) === tt) return true;
    if ((u.includes(tt) || tt.includes(u)) && Math.min(u.length, tt.length) >= 8) return true;
  }
  return false;
}

let scenarioKey = 'coffee';
let idx = 0;
let camStream = null;
let recognizer = null;
let recognizing = false;

function initTeacherMedia(){
  const v = $('teacherVideo');
  const img = $('teacherImg');
  v.src = TEACHER_MP4;
  v.addEventListener('error', ()=>{
    v.style.display='none';
    img.style.display='block';
    img.src = TEACHER_PNG;
  }, {once:true});
  img.src = TEACHER_PNG;
}

async function camOn(){
  try{
    camStream = await navigator.mediaDevices.getUserMedia({video:true, audio:false});
    $('userVideo').srcObject = camStream;
    $('stCam').textContent='å·²é–‹';
    $('dotCam').classList.add('ok');
    $('btnCamOn').disabled=true;
    $('btnCamOff').disabled=false;
  }catch(e){ alert('ç›¸æ©Ÿæ¬Šé™å¤±æ•—ï¼š'+(e?.message||e)); }
}
function camOff(){
  try{ if (camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream=null; } }catch{}
  $('userVideo').srcObject=null;
  $('stCam').textContent='æœªé–‹';
  $('dotCam').classList.remove('ok');
  $('btnCamOn').disabled=false;
  $('btnCamOff').disabled=true;
}

function setupASR(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR){ $('stAsr').textContent='ä¸æ”¯æ´'; return null; }
  const r = new SR();
  r.lang='en-US';
  r.interimResults=false;
  r.maxAlternatives=1;
  r.onstart=()=>{recognizing=true; $('stAsr').textContent='è¾¨è­˜ä¸­'; $('dotAsr').classList.add('warn'); $('btnStopAsr').disabled=false;};
  r.onend=()=>{recognizing=false; $('stAsr').textContent='å¾…å‘½'; $('dotAsr').classList.remove('warn'); $('btnStopAsr').disabled=true;};
  r.onerror=()=>{ $('stAsr').textContent='éŒ¯èª¤'; };
  r.onresult=(ev)=>{ const text = ev.results?.[0]?.[0]?.transcript || ''; handleUser(text); };
  return r;
}
function asrStart(){ if (!recognizer) return alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼Œè«‹ç”¨å³ä¸‹è¼¸å…¥æ¡†æ‰“å­—ã€‚'); if (recognizing) return; try{ recognizer.start(); }catch{} }
function asrStop(){ try{ recognizer && recognizer.stop(); }catch{} }

function speak(text){
  try{
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang='en-US'; u.rate=0.95;
    speechSynthesis.speak(u);
  }catch{}


/* ====== Teacher MP3 (Supabase Storage) ======
   - looks for: https://.../storage/v1/object/public/talk/teacher/{scenario}/line-XX.mp3
   - if missing, fallback to browser TTS speak()
*/
const TALK_PUBLIC_BASE = 'https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/talk';
let __teacherAudio = null;
function __teacherMp3Url(scenario, lineNo){
  const pad = String(lineNo).padStart(2,'0');
  return `${TALK_PUBLIC_BASE}/teacher/${scenario}/line-${pad}.mp3`;
}
async function __playTeacherMp3OrTTS(text, scenario, lineNo){
  const url = __teacherMp3Url(scenario, lineNo);
  try{
    const head = await fetch(url, { method:'HEAD', cache:'no-store' });
    if (!head.ok) throw new Error('mp3 missing');
    if (!__teacherAudio) __teacherAudio = new Audio();
    __teacherAudio.src = url;
    __teacherAudio.currentTime = 0;
    await __teacherAudio.play();
    return true;
  }catch(e){
    speak(text);
    return false;
  }
}

}

function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

function addMsg(who, html, avatarImg){
  const el = document.createElement('div'); el.className='msg';
  const av = document.createElement('div'); av.className='avatar';
  if (avatarImg){ const im=document.createElement('img'); im.src=avatarImg; im.alt=who; av.appendChild(im); }
  else av.textContent = (who==='AI')?'AI':'ä½ ';
  const bubble=document.createElement('div'); bubble.className='bubble';
  bubble.innerHTML = `<div class="who"><b>${who}</b><span class="ts">${nowTime()}</span></div><div class="txt">${html}</div>`;
  el.appendChild(av); el.appendChild(bubble);
  $('chatLog').appendChild(el);
  $('chatLog').scrollTop = $('chatLog').scrollHeight;
}

function currentLines(){ return SCRIPTS[scenarioKey].lines; }
function currentLine(){ return currentLines()[idx]; }

function hintText(line){
  const mode = $('hintLang').value;
  const extra = norm($('extraHint').value) ? `<div class="hintLine">é¡å¤–æé†’ï¼š${escapeHtml($('extraHint').value)}</div>` : '';
  if (mode==='zh') return `<div class="hintLine">æç¤ºï¼š${escapeHtml(line.zh||'')}</div>${extra}`;
  if (mode==='en') return `<div class="hintLine">Hint: ${escapeHtml(line.en||'')}</div>${extra}`;
  return `<div class="hintLine">æç¤ºï¼š${escapeHtml(line.zh||'')}<br/>Hint: ${escapeHtml(line.en||'')}</div>${extra}`;
}

function setProgress(){
  $('progNow').textContent=String(idx+1);
  $('progTotal').textContent=String(currentLines().length);
  $('scriptTitle').textContent=`${SCRIPTS[scenarioKey].name}ï½œç¬¬ ${idx+1} å¥ / ${currentLines().length} å¥`;
}

function startScenario(key){
  scenarioKey=key; idx=0;
  $('chatLog').innerHTML='';
  $('btnNext').disabled=true;
  setProgress();
  const line=currentLine();
  addMsg('AI', `<div><b>${escapeHtml(line.teacher)}</b></div>${hintText(line)}<div class="splitBtns"><button class="btn ok" onclick="window.__replayTeacher()">è€å¸«æœ—è®€</button></div>`, TEACHER_PNG);
  (__playTeacherMp3OrTTS(line.teacher, scenarioKey, idx+1));
}

function replayTeacher(){ (__playTeacherMp3OrTTS(currentLine().teacher, scenarioKey, idx+1)); }

function ttsCorrect(){ speak(currentLine().expect); }
async function copyCorrect(){ try{ await navigator.clipboard.writeText(currentLine().expect); }catch{} }

function showFeedback(){
  const line=currentLine();
  $('btnNext').disabled=false;

  addMsg('AI',
    `<div class="badge ok">ğŸ‘ æˆ‘è½åˆ°äº†ï¼åšå¾—å¥½ã€‚</div>
     <div class="big">${escapeHtml(line.expect)}</div>
     ${line.variants?.length?`<div style="margin-top:8px;color:var(--muted);font-weight:800;">ä½ ä¹Ÿå¯ä»¥é€™æ¨£èªªï¼š${escapeHtml(line.variants.join(' / '))}</div>`:''}
     ${hintText(line)}
     <div class="splitBtns">
       <button class="btn ok" onclick="window.__ttsCorrect()">è·Ÿè®€</button>
       <button class="btn primary" onclick="window.__nextLine()">ä¸‹ä¸€å¥</button>
     </div>`,
    TEACHER_PNG
  );
}

function handleUser(text){
  const t=(text||'').trim();
  if (!t) return;
  addMsg('ä½ ', `<div class="big">${escapeHtml(t)}</div>`);
  const line=currentLine();
  showFeedback();
}

function nextLine(){
  if ($('btnNext').disabled) return;
  idx++;
    if (idx>=currentLines().length){
    addMsg('AI',
      `<div class="badge ok">ğŸ‰ å®Œæˆï¼</div>
       <div class="txt" style="margin-top:8px">ä½ å·²å®Œæˆé€™å€‹æƒ…å¢ƒçš„ 10 å¥ã€‚ä¸‹ä¸€æ­¥å»ºè­°ï¼š</div>
       <div class="splitBtns" style="margin-top:10px">
         <a class="btn primary" href="talk_b.html">é€²éšç·´ç¿’ï¼ˆTalk Bï¼‰</a>
         <a class="btn" href="talk_free.html">è‡ªç”±å°è©±ï¼ˆTalk Freeï¼‰</a>
       </div>`,
      TEACHER_PNG
    );
    $('btnNext').disabled=true;
    setProgress();
    return;
  }$('btnNext').disabled=true;
  setProgress();
  const line=currentLine();
  addMsg('AI', `<div><b>${escapeHtml(line.teacher)}</b></div>${hintText(line)}<div class="splitBtns"><button class="btn ok" onclick="window.__replayTeacher()">è€å¸«æœ—è®€</button></div>`, TEACHER_PNG);
  (__playTeacherMp3OrTTS(line.teacher, scenarioKey, idx+1));
}

function boot(){
  const sel=$('scenarioSel');
  sel.innerHTML = Object.entries(SCRIPTS).map(([k,v])=>`<option value="${k}">${v.name}</option>`).join('');
  sel.value=scenarioKey;

  initTeacherMedia();
  recognizer=setupASR();
  $('stMic').textContent='å¯ç”¨';
  $('dotMic').classList.add('ok');

  $('btnCamOn').addEventListener('click', camOn);
  $('btnCamOff').addEventListener('click', camOff);

  const sp=$('btnSpeak');
  sp.addEventListener('mousedown', (e)=>{ e.preventDefault(); asrStart(); });
  sp.addEventListener('mouseup', (e)=>{ e.preventDefault(); asrStop(); });
  sp.addEventListener('mouseleave', ()=>{ if (recognizing) asrStop(); });
  sp.addEventListener('touchstart', (e)=>{ e.preventDefault(); asrStart(); }, {passive:false});
  sp.addEventListener('touchend', (e)=>{ e.preventDefault(); asrStop(); }, {passive:false});

  $('btnStopAsr').addEventListener('click', asrStop);
  $('btnReplayTeacher').addEventListener('click', replayTeacher);
  $('btnNext').addEventListener('click', nextLine);

  $('btnSend').addEventListener('click', ()=>{ handleUser($('textIn').value); $('textIn').value=''; });
  $('textIn').addEventListener('keydown', (e)=>{ if (e.key==='Enter'){ e.preventDefault(); $('btnSend').click(); } });

  $('btnReset').addEventListener('click', ()=>{ if (confirm('ç¢ºå®šè¦æ¸…ç©ºå°è©±ä¸¦é‡ç½®é€²åº¦ï¼Ÿ')) startScenario(sel.value); });
  $('btnHome').addEventListener('click', ()=>{ location.href='/index.html'; });

  sel.addEventListener('change', ()=> startScenario(sel.value));
  $('hintLang').addEventListener('change', ()=> startScenario(sel.value));

  window.__nextLine = nextLine;
  window.__ttsCorrect = ttsCorrect;
  window.__copyCorrect = copyCorrect;
  window.__replayTeacher = replayTeacher;

  startScenario(scenarioKey);
}

document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
