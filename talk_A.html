const PUBLIC_BASE = 'https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public';
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Talk Aï½œBookWideï¼ˆASR Betterï¼‰</title>
  <style>
    :root{
      --bg0:#070b16; --bg1:#0b1020;
      --card:rgba(255,255,255,.06); --card2:rgba(255,255,255,.045);
      --line:rgba(255,255,255,.10);
      --ink:#eaf0ff; --muted:rgba(234,240,255,.72);
      --brand:#4f7cff; --ok:#22c55e; --bad:#ef4444;
      --r:18px; --shadow:0 18px 50px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","Microsoft JhengHei",sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1100px 650px at 14% 10%, rgba(79,124,255,.22), transparent 55%),
        radial-gradient(1000px 600px at 90% 15%, rgba(34,197,94,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden; /* æ•´é ä¸æ»¾å‹• */
    }
    .topbar{
      height:62px; display:flex; align-items:center; justify-content:space-between;
      padding:0 18px; border-bottom:1px solid rgba(255,255,255,.08);
      background:rgba(6,10,22,.72); backdrop-filter: blur(14px);
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:950}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 12px; border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      font-weight:900; font-size:13px;
    }
    .layout{
      height:calc(100vh - 62px);
      display:grid; grid-template-columns: 1.25fr .9fr;
      gap:14px; padding:14px;
    }
    @media (max-width: 980px){
      body{overflow:auto}
      .layout{height:auto; grid-template-columns:1fr;}
    }
    .panel{
      background:var(--card);
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex; flex-direction:column; min-height:0;
    }
    .panelHead{
      padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:rgba(0,0,0,.12);
    }
    .panelHead .title{font-weight:950; font-size:16px}
    .panelBody{padding:14px 16px; overflow:auto; min-height:0;}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:1100px){.row{grid-template-columns:1fr;}}
    label{display:block; font-weight:900; margin:10px 0 6px}
    input,select,textarea{
      width:100%; border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:var(--ink);
      padding:12px 12px;
      outline:none; font-weight:850;
    }
    textarea{min-height:84px; resize:vertical}
    .hint{color:var(--muted); font-weight:800; font-size:12px; line-height:1.55}
    .btn{
      appearance:none; border:0; cursor:pointer;
      border-radius:14px; padding:10px 14px;
      background:rgba(255,255,255,.08);
      color:var(--ink);
      border:1px solid rgba(255,255,255,.12);
      font-weight:950;
    }
    .btn.primary{background:rgba(79,124,255,.18); border-color:rgba(79,124,255,.35)}
    .btn.ok{background:rgba(34,197,94,.16); border-color:rgba(34,197,94,.35)}
    .btn.bad{background:rgba(239,68,68,.14); border-color:rgba(239,68,68,.35)}
    .btn:disabled{opacity:.45; cursor:not-allowed}
    .chips{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      font-weight:900; font-size:12px; color:var(--muted);
    }
    .chip strong{color:var(--ink)}
    .videoRow{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px}
    .videoBox{
      border-radius:16px; border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25); overflow:hidden;
      aspect-ratio:16/9; position:relative;
    }
    video{width:100%; height:100%; object-fit:cover; background:#000}
    .tag{
      position:absolute; left:10px; top:10px;
      padding:6px 10px; border-radius:999px;
      background:rgba(0,0,0,.38);
      border:1px solid rgba(255,255,255,.14);
      font-weight:950; font-size:12px;
    }
    .controls{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .progressPill{font-weight:950}
    .chat{display:flex; flex-direction:column; gap:12px;}
    .cardMsg{
      background:var(--card2);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:12px 12px;
    }
    .msgTop{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:6px;}
    .msgWho{display:flex; align-items:center; gap:10px; font-weight:950}
    .avatar{
      width:34px; height:34px; border-radius:10px;
      background:rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .avatar img{width:100%; height:100%; object-fit:cover}
    .msgText{font-size:18px; font-weight:950; line-height:1.35}
    .msgHint{
      margin-top:8px; padding:8px 10px; border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      color:var(--muted);
      font-weight:850; font-size:12px;
      white-space:pre-wrap;
    }
    .actions{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap}
    .inputBar{
      margin-top:auto; padding:12px 12px;
      border-top:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.12);
      display:flex; gap:10px; align-items:center;
    }
    .inputBar input{flex:1; min-width:0;}
    .status{
      margin-top:12px; padding:10px 12px; border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      color:var(--muted);
      font-size:12px; font-weight:850;
      white-space:pre-wrap; line-height:1.55;
    }
    .toast{
      position:fixed; right:14px; bottom:14px; z-index:20;
      max-width:520px;
      padding:10px 12px; border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.70);
      color:var(--ink);
      font-weight:900;
      box-shadow:var(--shadow);
      display:none;
    }
    .toast.show{display:block}
    .kbd{padding:2px 6px; border-radius:8px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.08); font-weight:950; font-size:12px;}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div style="font-size:22px;">BookWide</div>
      <span class="pill">Talk</span>
      <span class="pill">å½±åƒå£èªª MVP</span>
      <span class="pill">Aï½œ10å¥è…³æœ¬ï¼ˆè·Ÿè®€æµç¨‹ï¼‰</span>
    </div>
    <div class="pill progressPill">é€²åº¦ <span id="prog">1</span> / 10</div>
  </div>

  <div class="layout">
    <div class="panel">
      <div class="panelHead">
        <div class="title">å½±åƒ + èªªè©±ï¼ˆä½ ï¼‰</div>
        <div class="hint">å›ºå®šè…³æœ¬ï¼šè€å¸«ä¸€å¥ â†’ ä½ èªªä¸€å¥ â†’ å°äº†æ‰ä¸‹ä¸€å¥ï¼ˆå…±10å¥ï¼Œå…è¨±å¤šç¨®æ­£ç¢ºå›ç­”ï¼‰</div>
      </div>
      <div class="panelBody">
        <div class="row">
          <div>
            <label>æƒ…å¢ƒï¼ˆScenarioï¼‰</label>
            <select id="scenario"></select>
          </div>
          <div>
            <label>æç¤ºèªè¨€ï¼ˆHintsï¼‰</label>
            <select id="hintLang">
              <option value="zh">ä¸­æ–‡æç¤ºï¼ˆZHï¼‰</option>
              <option value="en">English hints</option>
            </select>
          </div>
        </div>

        <label>æç¤ºï¼ˆå¯é¸ï¼Œæœƒå½±éŸ¿è€å¸«å£å»/é‡é»ï¼‰</label>
        <textarea id="userHint" placeholder="ä¾‹å¦‚ï¼šæ…¢æ…¢èªªã€åªçµ¦1å€‹é‡é»ã€æˆ‘æ€•æ–‡æ³•â€¦ï¼ˆé€™è£¡æœƒé¡¯ç¤ºåœ¨è€å¸«æç¤ºè£¡ï¼‰"></textarea>

        <div class="chips">
          <span class="chip">ç›¸æ©Ÿï¼š<strong id="camStat">æœªé–‹</strong></span>
          <span class="chip">éº¥å…‹é¢¨ï¼š<strong id="micStat">å¾…å‘½</strong></span>
          <span class="chip">è¾¨è­˜ï¼š<strong id="asrStat">å¯ç”¨</strong></span>
          <span class="chip">èªè¨€ï¼š<strong>en-US</strong></span>
        </div>

        <div class="videoRow">
          <div class="videoBox">
            <div class="tag">ä½ ï¼ˆç›¸æ©Ÿï¼‰</div>
            <video id="vUser" playsinline muted></video>
          </div>
          <div class="videoBox">
            <div class="tag">AI è€å¸«ï¼ˆç´ æï¼‰</div>
            <video id="vTeacher" playsinline loop muted></video>
          </div>
        </div>

        <div class="controls">
          <button class="btn primary" id="btnCam">é–‹å•Ÿç›¸æ©Ÿ</button>
          <button class="btn" id="btnCamOff" disabled>é—œé–‰ç›¸æ©Ÿ</button>
          <button class="btn ok" id="btnHold">æŒ‰ä½èªªè©±</button>
          <button class="btn" id="btnStopASR" disabled>åœæ­¢è¾¨è­˜</button>
          <button class="btn" id="btnReplayTeacher">é‡æ’­è€å¸«</button>
          <button class="btn primary" id="btnNext">ä¸‹ä¸€å¥</button>
        </div>

        <div class="status" id="leftStatus">ç”¨æ³•ï¼šå…ˆæŒ‰ã€Œé–‹å•Ÿç›¸æ©Ÿã€ï¼Œå†æŒ‰ä½ã€ŒæŒ‰ä½èªªè©±ã€è¬›ä¸€å¥è‹±æ–‡ï¼ˆ3~8ç§’ï¼‰ã€‚
é—œéµæ”¹è‰¯ï¼šcontinuous + interimResults + onend è‡ªå‹•çºŒè½ï¼ˆä¸æœƒåªå‰©å…©å€‹å­—ï¼‰ã€‚
å°æŠ€å·§ï¼šæŒ‰ <span class="kbd">Enter</span> ä¹Ÿå¯é€å‡ºï¼ˆå³å´è¼¸å…¥æ¡†ï¼‰ã€‚</div>
      </div>
    </div>

    <div class="panel">
      <div class="panelHead">
        <div class="title">AI è€å¸«ï¼ˆè…³æœ¬æ•™å­¸ï¼‰</div>
        <div class="hint" id="scnLabel">â€”</div>
      </div>

      <div class="panelBody chat" id="chatBody">
        <div class="cardMsg" id="teacherCard">
          <div class="msgTop">
            <div class="msgWho">
              <div class="avatar"><img id="teacherAvatar" alt="AI" /></div>
              <div>AI</div>
            </div>
            <div class="hint" id="timeNow"></div>
          </div>
          <div class="msgText" id="teacherText">â€”</div>
          <div class="msgHint" id="teacherHint">â€”</div>
          <div class="actions">
            <button class="btn ok" id="btnTeacherSpeak">è€å¸«æœ—è®€</button>
          </div>
        </div>

        <div class="cardMsg" id="resultCard" style="display:none">
          <div class="msgTop">
            <div class="msgWho">
              <div class="avatar"><img id="userAvatar" alt="ä½ " /></div>
              <div>ä½ </div>
            </div>
            <div class="hint" id="timeNow2"></div>
          </div>
          <div class="msgText" id="userSaid">â€”</div>
          <div class="msgHint" id="judgeHint">â€”</div>
          <div class="actions">
            <button class="btn" id="btnUserSpeak">æˆ‘æœ—è®€ï¼ˆç”·è²ï¼‰</button>
          </div>
        </div>
      </div>

      <div class="inputBar">
        <input id="userInput" placeholder="æˆ–ç›´æ¥æ‰“å­—ï¼šä¾‹å¦‚ I'm doing my nails." />
        <button class="btn primary" id="btnSend">é€å‡º</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  const toast = (msg, ms=2200) => {
    const el = $("toast");
    el.textContent = msg;
    el.classList.add("show");
    clearTimeout(el._t);
    el._t = setTimeout(()=>el.classList.remove("show"), ms);
  };
  const nowHHMM = () => {
    const d = new Date();
    const h = String(d.getHours()).padStart(2,'0');
    const m = String(d.getMinutes()).padStart(2,'0');
    return `${h}:${m}`;
  };

  // --- TTS (browser) for user speak (male) ---
  function pickMaleEnVoice(){
    const voices = window.speechSynthesis ? window.speechSynthesis.getVoices() : [];
    if(!voices || !voices.length) return null;
    // Heuristic: prefer en-US male-ish names
    const prefer = voices.filter(v => /en[-_]?US/i.test(v.lang || ""));
    const rank = (v) => {
      const n = (v.name||"").toLowerCase();
      // common male voice hints
      const maleHint = (n.includes("male") || n.includes("david") || n.includes("guy") || n.includes("alex") || n.includes("mark"));
      const femaleHint = (n.includes("female") || n.includes("samantha") || n.includes("victoria") || n.includes("zira"));
      return (maleHint ? 100 : 0) + (!femaleHint ? 10 : 0) + (v.default ? 5 : 0);
    };
    prefer.sort((a,b)=>rank(b)-rank(a));
    return prefer[0] || voices[0];
  }
  function pickFemaleEnVoice(){
    const voices = window.speechSynthesis ? window.speechSynthesis.getVoices() : [];
    if(!voices || !voices.length) return null;
    const prefer = voices.filter(v => /en[-_]?US/i.test(v.lang || ""));
    const rank = (v) => {
      const n = (v.name||"").toLowerCase();
      const femaleHint = (n.includes("female") || n.includes("samantha") || n.includes("victoria") || n.includes("zira") || n.includes("jenny") || n.includes("aria"));
      const maleHint = (n.includes("male") || n.includes("david") || n.includes("guy") || n.includes("alex") || n.includes("mark"));
      return (femaleHint ? 100 : 0) + (!maleHint ? 10 : 0) + (v.default ? 5 : 0);
    };
    prefer.sort((a,b)=>rank(b)-rank(a));
    return prefer[0] || voices[0];
  }
  function speakTeacher(text){
    if(!text) return;
    if(!window.speechSynthesis){
      toast("æ­¤ç€è¦½å™¨ä¸æ”¯æ´æœ—è®€ï¼ˆspeechSynthesisï¼‰");
      return;
    }
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "en-US";
    u.rate = 0.98;
    u.pitch = 1.06; // ç¨å¾®åé«˜ï¼Œåƒå¥³è²
    const v = pickFemaleEnVoice();
    if(v) u.voice = v;
    try{
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }catch(e){}
  }

  // teacher voice mp3 fallback control
  let TEACHER_AUDIO_MODE = "auto"; // auto | mp3 | tts
function speakUser(text){
    if(!text) return;
    if(!window.speechSynthesis){
      toast("æ­¤ç€è¦½å™¨ä¸æ”¯æ´æœ—è®€ï¼ˆspeechSynthesisï¼‰");
      return;
    }
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "en-US";
    u.rate = 0.98;
    u.pitch = 0.92; // ç¨å¾®åä½ï¼Œåƒç”·è²
    const v = pickMaleEnVoice();
    if(v) u.voice = v;
    try{
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }catch(e){}
  }

  // voices lazy-load
  try{
    if(window.speechSynthesis){
      window.speechSynthesis.onvoiceschanged = ()=>{};
    }
  }catch(e){}

  // --- scenarios (demo + multi-answers) ---
// è¦å‰‡ï¼šè€å¸«ä¸€å¥ -> ä½ ä¸€å¥ï¼ˆæœŸæœ›ç­”æ¡ˆå–ã€Œä¸‹ä¸€å¥ã€çš„ alts / tï¼‰
// altsï¼šå¯æ¥å—çš„å¤šç¨®ç­”æ¡ˆï¼ˆè¶Šé å‰è¶Šå…¸å‹ï¼‰
const SCENARIOS = {
  nails: {
    label: "nailsï¼ˆå¡—æŒ‡ç”²/ç¾ç”²ï¼‰",
    audioDir: "teacher",
    teacherAvatar: "https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/talk/teacher.png",
    teacherVideo: "",
    lines: [
      { t:"Hi! What are you doing?", hint_zh:"æç¤ºï¼šç”¨ I'm doing / painting my nailsã€‚", hint_en:"Hint: say I'm doing/painting my nails."},
      { t:"I'm painting my nails.", alts:[
          "I'm painting my nails.",
          "I'm doing my nails.",
          "I'm doing my nail polish.",
          "I'm painting my fingernails."
        ],
        hint_zh:"è·Ÿè®€/å¯è®Šï¼šI'm painting my nails / I'm doing my nailsâ€¦",
        hint_en:"Repeat/variants: I'm painting my nails / I'm doing my nailsâ€¦"
      },
      { t:"Do you do it yourself?", hint_zh:"æç¤ºï¼šYes, I do. / No, I go to a salon.", hint_en:"Hint: Yes, I do. / No, I go to a salon."},
      { t:"Yes, I do.", alts:[
          "Yes, I do.",
          "Yeah, I do.",
          "Yes, I do it myself.",
          "I do."
        ],
        hint_zh:"è·Ÿè®€/å¯è®Šï¼šYes, I do / I do it myselfâ€¦",
        hint_en:"Repeat/variants: Yes, I do / I do it myselfâ€¦"
      },
      { t:"What color do you like?", hint_zh:"æç¤ºï¼šI like red / pink / blue.", hint_en:"Hint: I like red/pink/blue."},
      { t:"I like red.", alts:[
          "I like red.",
          "I like pink.",
          "I like blue.",
          "Red, please."
        ],
        hint_zh:"è·Ÿè®€/å¯è®Šï¼šI like red / pink / blueâ€¦",
        hint_en:"Repeat/variants: I like red / pink / blueâ€¦"
      },
      { t:"That looks nice.", hint_zh:"è·Ÿè®€ï¼šThat looks nice.", hint_en:"Repeat: That looks nice."},
      { t:"Thanks!", alts:[
          "Thanks!",
          "Thank you!",
          "Thanks a lot.",
          "Thank you so much."
        ],
        hint_zh:"è·Ÿè®€/å¯è®Šï¼šThanks / Thank youâ€¦",
        hint_en:"Repeat/variants: Thanks / Thank youâ€¦"
      },
      { t:"Do you want to try?", hint_zh:"æç¤ºï¼šSure. / Maybe later.", hint_en:"Hint: Sure. / Maybe later."},
      { t:"Sure, maybe later.", alts:[
          "Sure, maybe later.",
          "Maybe later.",
          "Sure.",
          "Maybe later, sure."
        ],
        hint_zh:"è·Ÿè®€/å¯è®Šï¼šSure / Maybe laterâ€¦",
        hint_en:"Repeat/variants: Sure / Maybe laterâ€¦"
      },
    ]
  },
  coffee: {
    label: "coffeeï¼ˆå–å’–å•¡/é£²æ–™ï¼‰",
    audioDir: "teacher",
    teacherAvatar: "https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/talk/teacher.png",
    teacherVideo: "",
    lines: [
      { t:"Hi! What are you doing now?", hint_zh:"æç¤ºï¼šI'm having / getting / drinking coffee.", hint_en:"Hint: I'm having/getting/drinking coffee."},
      { t:"I'm having coffee.", alts:[
          "I'm having coffee.",
          "I'm drinking coffee.",
          "I'm getting a coffee.",
          "I'm grabbing a coffee."
        ],
        hint_zh:"è·Ÿè®€/å¯è®Šï¼šI'm having coffee / I'm drinking coffeeâ€¦",
        hint_en:"Repeat/variants: I'm having coffee / I'm drinking coffeeâ€¦"
      },
      { t:"Do you want one?", hint_zh:"æç¤ºï¼šYes, please. / No, thanks.", hint_en:"Hint: Yes, please. / No, thanks."},
      { t:"Yes, please.", alts:[
          "Yes, please.",
          "Sure, please.",
          "Yes, I'd love one.",
          "Yes, that'd be great."
        ],
        hint_zh:"è·Ÿè®€/å¯è®Šï¼šYes, please / I'd love oneâ€¦",
        hint_en:"Repeat/variants: Yes, please / I'd love oneâ€¦"
      },
      { t:"How do you like it?", hint_zh:"æç¤ºï¼šBlack / with milk / with sugar.", hint_en:"Hint: Black / with milk / with sugar."},
      { t:"With milk, please.", alts:[
          "With milk, please.",
          "With milk and sugar, please.",
          "Black, please.",
          "With sugar, please."
        ],
        hint_zh:"è·Ÿè®€/å¯è®Šï¼šWith milk / Black / With sugarâ€¦",
        hint_en:"Repeat/variants: With milk / Black / With sugarâ€¦"
      },
      { t:"Here you go.", hint_zh:"è·Ÿè®€ï¼šHere you go.", hint_en:"Repeat: Here you go."},
      { t:"Thank you!", alts:[
          "Thank you!",
          "Thanks!",
          "Thank you so much.",
          "Thanks a lot."
        ],
        hint_zh:"è·Ÿè®€/å¯è®Šï¼šThank you / Thanksâ€¦",
        hint_en:"Repeat/variants: Thank you / Thanksâ€¦"
      },
      { t:"You're welcome.", hint_zh:"è·Ÿè®€ï¼šYou're welcome.", hint_en:"Repeat: You're welcome."},
      { t:"See you later.", alts:[
          "See you later.",
          "See you.",
          "Talk to you later.",
          "Catch you later."
        ],
        hint_zh:"è·Ÿè®€/å¯è®Šï¼šSee you later / Talk to you laterâ€¦",
        hint_en:"Repeat/variants: See you later / Talk to you laterâ€¦"
      },
    ]
  }
};


  // --- similarity judge (tolerant) ---
  function norm(s){
    return (s||"")
      .toLowerCase()
      .replace(/[â€™']/g,"'")
      .replace(/[^a-z0-9\s']/g," ")
      .replace(/\b(i'm|im)\b/g,"i'm")
      .replace(/\b(a|an|the)\b/g," ")
      .replace(/\s+/g," ")
      .trim();
  }
  function tokenSet(s){
    const n = norm(s);
    if(!n) return new Set();
    return new Set(n.split(" "));
  }
  function similarity(a,b){
    const A = tokenSet(a), B = tokenSet(b);
    if(!A.size || !B.size) return 0;
    let inter=0;
    for(const t of A) if(B.has(t)) inter++;
    const uni = A.size + B.size - inter;
    return inter / uni;
  }

  function missingTokens(user, expected){
    const U = tokenSet(user);
    const E = tokenSet(expected);
    const missing = [];
    for(const t of E){
      if(!U.has(t)) missing.push(t);
    }
    return missing;
  }

  function bestMatch(userText, candidates){
    // candidates: string[]
    let best = {text: candidates[0]||"", score: 0};
    for(const c of candidates){
      const sc = similarity(userText, c);
      if(sc > best.score) best = {text: c, score: sc};
    }
    return best;
  }

  // --- teacher mp3 (public storage) ---
  const TALK_BUCKET = "talk";
  const USER_AVATAR = "https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/talk/user.png";
  function teacherMp3Url(scenario, lineNo){
    const pad = String(lineNo).padStart(2,'0');
    return `https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/${TALK_BUCKET}/teacher/${scenario}/line-${pad}.mp3`;
  }
  const teacherAudio = new Audio();
  teacherAudio.preload = "auto";
  async function playTeacherMp3(){
    const sc = SCENARIOS[state.scenario];
    const lineNo = state.idx + 1;

    // å…ˆå–ã€Œè€å¸«é€™ä¸€å¥ã€æ–‡å­—ï¼ˆTTS fallback ç”¨ï¼‰
    const teacherText = (sc && sc.lines && sc.lines[state.idx]) ? sc.lines[state.idx].t : "";

    // è‹¥å¼·åˆ¶ TTS
    if(TEACHER_AUDIO_MODE === "tts"){
      speakTeacher(teacherText);
      return;
    }

    const dir = (sc && sc.audioDir) ? sc.audioDir : state.scenario;
    const url = `${PUBLIC_BASE}/${TALK_BUCKET}/${dir}/line-${String(lineNo).padStart(2,"0")}.mp3`;

    // è‹¥å¼·åˆ¶ mp3
    if(TEACHER_AUDIO_MODE === "mp3"){
      try{
        const a = new Audio(url);
        await a.play();
        return;
      }catch(e){
        toast("è€å¸« MP3 æ’­æ”¾å¤±æ•—ï¼Œè«‹ç¢ºèª MP3 æª”æ¡ˆæ˜¯å¦å­˜åœ¨");
        return;
      }
    }

    // autoï¼šå…ˆè©¦ MP3ï¼Œå¤±æ•—å°±æ”¹ç”¨ TTSï¼ˆä¸æœƒè®“æµç¨‹å¡æ­»ï¼‰
    try{
      const a = new Audio(url);
      const p = a.play();
      if(p && typeof p.then === "function") await p;
    }catch(e){
      // fallback to TTS
      TEACHER_AUDIO_MODE = "tts";
      toast("æ‰¾ä¸åˆ°è€å¸« MP3ï¼Œæ”¹ç”¨ç€è¦½å™¨å¥³è²æœ—è®€ï¼ˆä¸å½±éŸ¿ä½¿ç”¨ï¼‰");
      speakTeacher(teacherText);
    }
  }

  // --- state & render ---
  const state = { scenario:"nails", idx:0 };
  function renderScenarioOptions(){
    const sel = $("scenario");
    sel.innerHTML = "";
    Object.keys(SCENARIOS).forEach(k=>{
      const opt = document.createElement("option");
      opt.value = k;
      opt.textContent = SCENARIOS[k].label;
      sel.appendChild(opt);
    });
    sel.value = state.scenario;
  }
  function renderTeacher(){
    const sc = SCENARIOS[state.scenario];
    const line = sc.lines[state.idx];
    $("prog").textContent = String(state.idx+1);
    $("scnLabel").textContent = sc.label;
    $("teacherAvatar").src = sc.teacherAvatar;
    try{$("userAvatar").src = USER_AVATAR;}catch(e){}
    $("teacherText").textContent = line.t;
    $("teacherHint").textContent = ($("hintLang").value==="zh" ? line.hint_zh : line.hint_en);

// â˜…å¯ç”¨ç­”æ¡ˆé è¦½ï¼šè®“ä½¿ç”¨è€…ä¸ç”¨å…ˆéŒ¯ä¸€æ¬¡æ‰çŸ¥é“æ€å›ç­”ï¼ˆæ›´åƒè€å¸«ï¼‰
try{
  const cands = expectedCandidates();
  const ex = cands.slice(0,3).map(a=>"â€¢ " + a).join("\n");
  if(ex){
    $("teacherHint").textContent += ($("hintLang").value==="zh"
      ? "\n\nä½ å¯ä»¥å›ç­”ï¼š\n" + ex
      : "\n\nYou can answer:\n" + ex);
  }
}catch(e){}

    // â˜…1å€ï¼ˆæç¤ºï¼‰ä½¿ç”¨æ–¹å¼ï¼šä½ è¼¸å…¥çš„å…§å®¹æœƒé¡¯ç¤ºåœ¨è€å¸«æç¤ºè£¡ï¼Œç•¶æˆã€Œå­¸å“¡éœ€æ±‚/å£å»ã€
    const uh = ($("userHint") && $("userHint").value) ? $("userHint").value.trim() : "";
    if(uh){
      $("teacherHint").textContent += ($("hintLang").value==="zh"
        ? "\n\nä½ çš„éœ€æ±‚ï¼š\n" + uh
        : "\n\nYour preference:\n" + uh);
    }

    $("timeNow").textContent = "ä¸‹åˆ" + nowHHMM();
    $("timeNow2").textContent = "ä¸‹åˆ" + nowHHMM();

    const vT = $("vTeacher");
    if(sc.teacherVideo){
      if(vT.src !== sc.teacherVideo) vT.src = sc.teacherVideo;
      vT.muted = true; vT.loop = true;
      vT.play().catch(()=>{});
    }else{
      vT.removeAttribute("src");
      vT.load();
    }
  }
  function expectedCandidates(){
    // è€å¸«ä¸€å¥ -> ä½ ä¸€å¥ï¼šå–ã€Œä¸‹ä¸€å¥ã€çš„ altsï¼ˆè‹¥æœ‰ï¼‰å¦å‰‡ç”¨ t
    const sc = SCENARIOS[state.scenario];
    const nextIdx = Math.min(state.idx+1, sc.lines.length-1);
    const obj = sc.lines[nextIdx];
    const alts = (obj && Array.isArray(obj.alts) && obj.alts.length) ? obj.alts : [obj.t];
    // å»é‡ï¼ˆé¿å… UI é¡¯ç¤ºé‡è¤‡ï¼‰
    const seen = new Set();
    const out = [];
    for(const a of alts){
      const k = norm(a);
      if(!k || seen.has(k)) continue;
      seen.add(k);
      out.push(a);
    }
    return out.length ? out : [obj.t];
  }


  async function submitUser(text){
    $("resultCard").style.display = "block";
    $("userSaid").textContent = text;

    const cands = expectedCandidates();
    const best = bestMatch(text, cands);
    const score = best.score;

// â˜…å°æ”¾å¯¬ï¼šçŸ­ç­”ï¼ˆ1~3è©ï¼‰åªè¦æŠ“åˆ°é—œéµè©å°±å¯ä»¥éï¼ˆæ›´åƒå£èªªç·´ç¿’ï¼‰
let pass = score >= 0.72;
if(!pass){
  const exp0 = best.text || cands[0];
  const U = tokenSet(text);
  const E = tokenSet(exp0);
  let inter = 0;
  for(const t of E) if(U.has(t)) inter++;
  const cover = E.size ? inter / E.size : 0;
  if(U.size <= 3 && cover >= 0.70) pass = true;
}

    if(pass){
      $("judgeHint").textContent = `ğŸ‘ æˆ‘è½åˆ°äº†ï¼åšå¾—å¥½ã€‚
ï¼ˆç›¸ä¼¼åº¦ï¼š${score.toFixed(2)}ï¼‰`;
      state.idx = Math.min(state.idx+1, 9);
      renderTeacher();
      await playTeacherMp3();
    }else{
      const exp = best.text || cands[0];

      // â˜…æ›´åƒçœŸäººè€å¸«ï¼šå¦‚æœä½ å…¶å¯¦æ˜¯åœ¨ã€Œé‡è¤‡è€å¸«çš„å•é¡Œã€ï¼Œç›´æ¥æé†’ä½ è¦ç”¨å›ç­”å¥å‹
      const sc = SCENARIOS[state.scenario];
      const teacherLine = (sc && sc.lines && sc.lines[state.idx]) ? sc.lines[state.idx].t : "";
      const qScore = teacherLine ? similarity(text, teacherLine) : 0;
      if(qScore >= 0.62 && qScore > score + 0.10){
        const ex2 = cands.slice(0,3).map(a=>"â€¢ " + a).join("\n");
        $("judgeHint").textContent =
          "âš ï¸ ä½ å‰›å‰›åƒæ˜¯åœ¨é‡è¤‡ã€Œè€å¸«çš„å•é¡Œã€ã€‚\n" + "è«‹ç›´æ¥ç”¨ã€Œå›ç­”å¥ã€å›æ‡‰ã€‚\n\n" + "å¯æ¥å—å›ç­”ä¾‹ï¼š\n" + ex2 + "\n\n" + "ï¼ˆä½ å‰›æ‰æ›´åƒå•é¡Œå¥ï¼Œç›¸ä¼¼åº¦ï¼š" + qScore.toFixed(2) + "ï¼‰";
        return;
      }

      const miss = missingTokens(text, exp);
      let teachHint = "";
      if(miss.length){
        teachHint =
          "ä½ å°‘èªªäº†é—œéµå­—ï¼š\n" +
          miss.slice(0, 8).map(w => "â€¢ " + w).join("\n");
      }else{
        teachHint = "å¥å‹å¤§è‡´æ­£ç¢ºï¼Œè©¦è‘—æ›´æ¸…æ¥šåœ°èªªä¸€æ¬¡ã€‚";
      }

      const ex = cands.slice(0,4).map(a=>"â€¢ " + a).join("\n");
      $("judgeHint").textContent =
        `âŒ é‚„å·®ä¸€é»ã€‚

${teachHint}

å¯æ¥å—ç­”æ¡ˆä¾‹ï¼š
${ex}

ï¼ˆæœ€ä½³ç›¸ä¼¼åº¦ï¼š${score.toFixed(2)}ï¼‰`;
    }
  }


  // --- camera ---
  let camStream = null;
  async function startCam(){
    try{
      camStream = await navigator.mediaDevices.getUserMedia({video:true, audio:false});
      $("vUser").srcObject = camStream;
      await $("vUser").play();
      $("camStat").textContent = "å·²é–‹";
      $("btnCam").disabled = true;
      $("btnCamOff").disabled = false;
    }catch(e){
      toast("ç›¸æ©Ÿé–‹å•Ÿå¤±æ•—ï¼šè«‹å…è¨±ç€è¦½å™¨ç›¸æ©Ÿæ¬Šé™");
    }
  }
  function stopCam(){
    try{
      if(camStream){
        camStream.getTracks().forEach(t=>t.stop());
        camStream = null;
      }
      $("vUser").srcObject = null;
      $("camStat").textContent = "æœªé–‹";
      $("btnCam").disabled = false;
      $("btnCamOff").disabled = true;
    }catch(e){}
  }

  // --- ASR: Better Hold-to-talk ---
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  let rec = null;
  let holding = false;
  let finalText = "";
  let interimText = "";
  let restarting = false;
  let lastStartAt = 0;

  function asrSupported(){ return !!SR; }

  function buildRecognizer(){
    if(!asrSupported()) return null;
    const r = new SR();
    r.lang = "en-US";          // â˜…ä½ è¬›è‹±æ–‡å°±é– en-USï¼ˆæœ€é—œéµï¼‰
    r.continuous = true;       // â˜…é€£çºŒ
    r.interimResults = true;   // â˜…å³æ™‚é è¦½
    r.maxAlternatives = 1;

    r.onstart = () => {
      $("micStat").textContent = "è†è½ä¸­";
      $("asrStat").textContent = "è†è½ä¸­";
    };

    r.onresult = (ev) => {
      let newFinal = "";
      let newInterim = "";
      for(let i=ev.resultIndex; i<ev.results.length; i++){
        const res = ev.results[i];
        const txt = (res[0] && res[0].transcript) ? res[0].transcript : "";
        if(res.isFinal) newFinal += txt + " ";
        else newInterim += txt + " ";
      }
      if(newFinal.trim()) finalText = (finalText + " " + newFinal).trim();
      interimText = newInterim.trim();

      const live = (finalText + " " + interimText).trim();
      if(live) $("userInput").value = live;
    };

    r.onerror = (e) => {
      $("micStat").textContent = "å¾…å‘½";
      $("asrStat").textContent = "å¯ç”¨";
      if(e && e.error){
        if(e.error === "not-allowed" || e.error === "service-not-allowed"){
          toast("éº¥å…‹é¢¨æ¬Šé™è¢«æ‹’çµ•ï¼šè«‹å…è¨±éº¥å…‹é¢¨");
        }else if(e.error === "no-speech"){
          // ä¸æ‰“æ“¾
        }else{
          toast("è¾¨è­˜éŒ¯èª¤ï¼š" + e.error);
        }
      }
    };

    r.onend = () => {
      $("micStat").textContent = "å¾…å‘½";
      $("asrStat").textContent = "å¯ç”¨";
      // â˜…æŒ‰ä½æ™‚ Chrome å¸¸è‡ªå·±çµæŸ â†’ è‡ªå‹•é‡å•Ÿï¼ˆæ ¸å¿ƒæ”¹è‰¯ï¼‰
      if(holding){
        const now = Date.now();
        if(now - lastStartAt < 350) return;
        if(restarting) return;
        restarting = true;
        setTimeout(() => {
          try{
            restarting = false;
            lastStartAt = Date.now();
            r.start();
          }catch(e){}
        }, 120);
      }
    };

    return r;
  }

  function asrReset(){ finalText=""; interimText=""; }

  function asrStartHold(){
    if(!rec) rec = buildRecognizer();
    if(!rec){
      toast("æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼ˆSpeechRecognitionï¼‰");
      $("asrStat").textContent = "ä¸æ”¯æ´";
      return;
    }
    holding = true;
    asrReset();
    try{
      lastStartAt = Date.now();
      rec.start();
      $("btnStopASR").disabled = false;
      $("btnHold").classList.add("bad");
      $("btnHold").textContent = "è†è½ä¸­â€¦(æ”¾é–‹é€å‡º)";
    }catch(e){
      // å¯èƒ½å·²åœ¨ start ç‹€æ…‹ï¼Œå¿½ç•¥
    }
  }

  async function asrStopHold(send=true){
    holding = false;
    $("btnStopASR").disabled = true;
    $("btnHold").classList.remove("bad");
    $("btnHold").textContent = "æŒ‰ä½èªªè©±";
    try{ rec && rec.stop(); }catch(e){}
    const text = $("userInput").value.trim();
    if(send && text) await submitUser(text);
  }

  // --- wire ---
  function wire(){
    $("btnCam").addEventListener("click", startCam);
    $("btnCamOff").addEventListener("click", stopCam);

    $("scenario").addEventListener("change", async (e)=>{
      state.scenario = e.target.value;
      state.idx = 0;
      $("resultCard").style.display = "none";
      $("userInput").value = "";
      renderTeacher();
      await playTeacherMp3();
    });
    $("hintLang").addEventListener("change", renderTeacher);

    $("userHint").addEventListener("input", ()=>{ renderTeacher(); });

    $("btnReplayTeacher").addEventListener("click", playTeacherMp3);
    $("btnTeacherSpeak").addEventListener("click", playTeacherMp3);

    $("btnUserSpeak").addEventListener("click", ()=>{
      const t = ($("userSaid") && $("userSaid").textContent) ? $("userSaid").textContent.trim() : ($("userInput").value||"").trim();
      speakUser(t);
    });

    $("btnNext").addEventListener("click", async ()=>{
      state.idx = Math.min(state.idx+1, 9);
      renderTeacher();
      await playTeacherMp3();
    });

    const holdBtn = $("btnHold");
    holdBtn.addEventListener("pointerdown", (e)=>{ e.preventDefault(); asrStartHold(); });
    const endHold = async (e)=>{ e.preventDefault(); await asrStopHold(true); };
    holdBtn.addEventListener("pointerup", endHold);
    holdBtn.addEventListener("pointercancel", endHold);
    holdBtn.addEventListener("pointerleave", (e)=>{ if(holding) endHold(e); });

    $("btnStopASR").addEventListener("click", ()=>asrStopHold(false));

    $("btnSend").addEventListener("click", async ()=>{
      const text = $("userInput").value.trim();
      if(!text) return;
      await submitUser(text);
    });
    $("userInput").addEventListener("keydown", async (e)=>{
      if(e.key === "Enter"){
        e.preventDefault();
        const text = $("userInput").value.trim();
        if(!text) return;
        await submitUser(text);
      }
    });

    if(!asrSupported()){
      $("asrStat").textContent = "ä¸æ”¯æ´";
      toast("æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ã€‚å»ºè­°ç”¨ Chrome/Edge æœ€æ–°ç‰ˆã€‚", 4200);
    }
  }

  // --- init ---
  renderScenarioOptions();
  renderTeacher();
  wire();

  // è§£é™¤ã€Œå•äº†ã€ï¼šå…ˆç”¨ä»»æ„é»æ“Šè§£é– audio
  let audioUnlocked = false;
  const unlock = async ()=>{
    if(audioUnlocked) return;
    audioUnlocked = true;
    try{
      teacherAudio.src = "data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA";
      await teacherAudio.play().catch(()=>{});
      teacherAudio.pause();
    }catch(e){}
    toast("éŸ³è¨Šå·²å•Ÿç”¨ âœ“ï¼ˆè€å¸«æœ—è®€æœƒæœ‰è²éŸ³ï¼‰", 1800);
    window.removeEventListener("pointerdown", unlock, true);
    window.removeEventListener("keydown", unlock, true);
  };
  window.addEventListener("pointerdown", unlock, true);
  window.addEventListener("keydown", unlock, true);

  setTimeout(()=>toast("æç¤ºï¼šå…ˆé»ä¸€ä¸‹ç•«é¢å•Ÿç”¨éŸ³è¨Šï¼Œå†æŒ‰ã€Œè€å¸«æœ—è®€ã€æˆ–ã€ŒæŒ‰ä½èªªè©±ã€ã€‚", 3800), 300);
})();
</script>
</body>
</html>
