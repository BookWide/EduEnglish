<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Talk Aï¼ˆæ‰‹æ©Ÿå£èªªï¼‰ï½œBookWide</title>
<style>
:root{
  --bg0:#070b18;
  --bg1:#0c1530;
  --card:rgba(255,255,255,.06);
  --card2:rgba(255,255,255,.08);
  --line:rgba(255,255,255,.10);
  --text:#eaf0ff;
  --muted:rgba(234,240,255,.65);
  --brand:#4c8dff;
  --brand2:#2f6bff;
  --ok:#25c55a;
  --warn:#ffcc66;
  --danger:#ff5a6a;
  --shadow:0 18px 50px rgba(0,0,0,.45);
  --r:22px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
  color:var(--text);
  background:
    radial-gradient(1200px 600px at 20% 10%, rgba(76,141,255,.20), transparent 60%),
    radial-gradient(900px 600px at 80% 0%, rgba(255,255,255,.06), transparent 55%),
    linear-gradient(180deg,var(--bg0),var(--bg1));
  overflow:hidden;
}
a{color:inherit}

.app{
  height:100%;
  display:flex;
  flex-direction:column;
  padding:16px;
  gap:12px;
}
.topbar{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  border-radius:999px;
  background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
  border:1px solid var(--line);
  box-shadow:0 10px 30px rgba(0,0,0,.25);
}
.dot{
  width:10px;height:10px;border-radius:50%;
  background:var(--brand);
  box-shadow:0 0 0 6px rgba(76,141,255,.15);
}
.titlewrap{flex:1; min-width:0}
.h1{
  font-weight:800;
  letter-spacing:.2px;
  font-size:16px;
  line-height:1.2;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.sub{
  font-size:12px;
  color:var(--muted);
  margin-top:2px;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.controls{
  display:flex;
  align-items:center;
  gap:8px;
}
.btn{
  appearance:none;
  border:1px solid var(--line);
  color:var(--text);
  background:rgba(255,255,255,.06);
  border-radius:999px;
  padding:10px 12px;
  font-weight:700;
  font-size:13px;
  cursor:pointer;
  user-select:none;
}
.btn:active{transform:translateY(1px)}
.btn.primary{
  background:linear-gradient(180deg, rgba(76,141,255,.95), rgba(47,107,255,.95));
  border-color:rgba(255,255,255,.18);
}
.btn.ghost{background:transparent}
.select{
  border-radius:999px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.06);
  color:var(--text);
  font-weight:800;
  padding:10px 12px;
  max-width:48vw;
}
.select option{color:#111827}
.pane{
  flex:1;
  display:flex;
  flex-direction:column;
  gap:12px;
  min-height:0;
}
.card{
  background:linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.04));
  border:1px solid var(--line);
  border-radius:var(--r);
  box-shadow:var(--shadow);
}
.avatarCard{
  position:relative;
  padding:18px;
  min-height:220px;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}
.badge{
  position:absolute;
  left:16px; top:14px;
  padding:8px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background:rgba(0,0,0,.20);
  font-weight:800;
  font-size:12px;
  color:rgba(234,240,255,.85);
}
.statusPill{
  position:absolute;
  left:16px; bottom:14px;
  display:flex; align-items:center; gap:8px;
  padding:8px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background:rgba(0,0,0,.22);
  font-weight:800;
  font-size:12px;
  color:rgba(234,240,255,.85);
}
.statusDot{width:10px;height:10px;border-radius:50%; background:var(--ok); box-shadow:0 0 0 6px rgba(37,197,90,.12)}
.statusDot.idle{background:rgba(234,240,255,.45); box-shadow:0 0 0 6px rgba(234,240,255,.08)}
.stepPill{
  position:absolute;
  right:16px; bottom:14px;
  padding:8px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background:rgba(0,0,0,.22);
  font-weight:800;
  font-size:12px;
  color:rgba(234,240,255,.85);
}
.avatarRing{
  width:min(260px, 52vw);
  aspect-ratio:1/1;
  border-radius:50%;
  background:radial-gradient(circle at 50% 35%, rgba(255,255,255,.16), rgba(255,255,255,.03) 55%, rgba(255,255,255,.02) 100%);
  border:1px solid rgba(255,255,255,.12);
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
}
.avatarRing::before{
  content:"";
  position:absolute; inset:-18px;
  border-radius:50%;
  background:radial-gradient(circle at 50% 50%, rgba(76,141,255,.18), transparent 60%);
  filter:blur(1px);
  opacity:.8;
}
.avatarWrap{
  width:58%;
  aspect-ratio:1/1;
  border-radius:18px;
  background:rgba(0,0,0,.18);
  border:1px solid rgba(255,255,255,.14);
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
  position:relative;
}
.avatarImg{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
  transform:scale(1.02);
}
.aiFace{
  width:100%;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  letter-spacing:.8px;
  color:rgba(234,240,255,.70);
}
.mouth{
  position:absolute;
  left:50%;
  top:66%;
  transform:translate(-50%,-50%);
  width:46%;
  height:10%;
  border-radius:999px;
  background:rgba(0,0,0,.25);
  border:1px solid rgba(255,255,255,.16);
  opacity:0;
}
.talking .mouth{
  opacity:1;
  animation:mouth 140ms infinite alternate;
}
@keyframes mouth{
  from{transform:translate(-50%,-50%) scaleY(.55)}
  to{transform:translate(-50%,-50%) scaleY(1.15)}
}

.dialogCard{
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:12px;
  min-height:0;
}
.bigline{
  font-size:26px;
  line-height:1.22;
  font-weight:900;
  letter-spacing:.2px;
}
.smallline{
  font-size:14px;
  color:rgba(234,240,255,.72);
  margin-top:-6px;
}
.row{
  display:flex;
  gap:10px;
  align-items:center;
}
.micBtn{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  padding:14px 14px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.16);
  background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
  cursor:pointer;
  font-weight:900;
  user-select:none;
}
.micBtn:active{transform:translateY(1px)}
.micIcon{
  width:18px;height:18px; border-radius:4px;
  display:inline-flex; align-items:center; justify-content:center;
}
.skipBtn{
  padding:14px 14px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.06);
  cursor:pointer;
  font-weight:900;
  min-width:70px;
}
.bottomBar{
  display:flex;
  gap:12px;
  padding:14px;
  border-top:1px solid rgba(255,255,255,.09);
  background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.15));
  border-radius:0 0 var(--r) var(--r);
}
.tile{
  flex:1;
  padding:12px 12px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.05);
  cursor:pointer;
}
.tileTitle{font-weight:900; font-size:14px}
.tileSub{font-size:12px; color:rgba(234,240,255,.65); margin-top:2px}
.note{
  margin:0 2px;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.20);
  color:rgba(234,240,255,.75);
  font-size:12px;
}

/* Sheet */
.sheetMask{
  position:fixed; inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:flex-end;
  z-index:99;
}
.sheet{
  width:100%;
  max-height:78vh;
  border-radius:22px 22px 0 0;
  border:1px solid rgba(255,255,255,.14);
  background:linear-gradient(180deg, rgba(18,26,55,.98), rgba(9,12,25,.98));
  box-shadow:0 30px 80px rgba(0,0,0,.55);
  padding:14px;
  overflow:auto;
}
.sheetHeader{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding:4px 2px 10px 2px;
}
.sheetTitle{font-weight:1000; font-size:16px}
.sheetClose{
  border:none;
  background:rgba(255,255,255,.08);
  color:var(--text);
  border:1px solid rgba(255,255,255,.12);
  border-radius:999px;
  padding:10px 12px;
  cursor:pointer;
  font-weight:900;
}
.kv{
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.04);
  border-radius:16px;
  padding:12px;
  margin-bottom:10px;
}
.kv h3{margin:0 0 8px 0; font-size:14px}
.kv p, .kv li{margin:0; color:rgba(234,240,255,.75); font-size:13px; line-height:1.5}
.kv ul{margin:8px 0 0 18px; padding:0}
.hr{height:1px; background:rgba(255,255,255,.08); margin:10px 0}
.mini{
  font-size:12px; color:rgba(234,240,255,.65);
}

/* Review */
.reviewStars{
  display:flex; gap:10px; align-items:center; justify-content:center;
  padding:6px 0 2px 0;
}
.star{
  width:44px;height:44px;
  border-radius:16px;
  display:flex; align-items:center; justify-content:center;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.12);
  font-size:22px;
}
.metrics{
  display:flex; gap:18px; justify-content:space-between;
  padding:12px 4px 2px 4px;
}
.metric{
  flex:1;
  text-align:center;
}
.metricNum{font-weight:1000; font-size:34px}
.metricLbl{color:rgba(234,240,255,.65); font-size:12px; margin-top:-6px}
.reviewBig{
  text-align:center;
  font-weight:1000;
  font-size:34px;
  color:#45e08a;
  padding:6px 0;
}
</style>
</head>
<body>
<div class="app">
  <div class="topbar card">
    <div class="dot"></div>
    <div class="titlewrap">
      <div class="h1">Talk Aï¼ˆæ‰‹æ©Ÿå£èªªï¼‰</div>
      <div class="sub" id="ttsLine">TTSï¼šBrowser SpeechSynthesis</div>
    </div>
    <select id="sceneSelect" class="select" title="é¸æ“‡æƒ…å¢ƒ"></select>
    <button class="btn ghost" id="btnReplay">é‡æ’­æœ¬å¥</button>
  </div>

  <div class="pane">
    <div class="card avatarCard">
      <div class="badge" id="roleBadge">AI Â· teacher</div>
      <div class="avatarRing" id="avatarRing">
        <div class="avatarWrap" id="avatarWrap">
          <img id="avatarImg" class="avatarImg" alt="AI Avatar" style="display:none"/>
          <div id="avatarFallback" class="aiFace">AI</div>
          <div class="mouth" aria-hidden="true"></div>
        </div>
      </div>
      <div class="statusPill"><span id="statusDot" class="statusDot idle"></span><span id="statusText">Ready</span></div>
      <div class="stepPill" id="stepPill">step: -</div>
    </div>

    <div class="card dialogCard" id="dialogCard">
      <div class="bigline" id="bigLine">ï¼ˆè¼‰å…¥ä¸­â€¦ï¼‰</div>
      <div class="smallline" id="smallLine"></div>

      <div class="row">
        <div class="micBtn" id="micBtn" role="button" aria-label="é–‹å§‹è¾¨è­˜">
          <span class="micIcon">ğŸ™ï¸</span>
          <span id="micLabel">é»æˆ‘èªªï¼ˆé–‹å§‹è¾¨è­˜ï¼‰</span>
        </div>
        <button class="skipBtn" id="skipBtn">è·³é</button>
      </div>

      <div class="bottomBar">
        <div class="tile" data-sheet="task"><div class="tileTitle">ä»»å‹™</div><div class="tileSub">è¦åšä»€éº¼</div></div>
        <div class="tile" data-sheet="examples"><div class="tileTitle">ç¯„ä¾‹</div><div class="tileSub">ä¸ç¯„å¥</div></div>
        <div class="tile" data-sheet="translate"><div class="tileTitle">ç¿»è­¯</div><div class="tileSub">ä¸­ / æ—¥</div></div>
        <div class="tile" data-sheet="saved"><div class="tileTitle">å·²å„²å­˜</div><div class="tileSub">å–®å­—å¥</div></div>
      </div>

      <div class="note" id="hintNote">ä¸»é ä¿æŒåœ¨å°è©±ä¸­ï¼›é»ã€Œä»»å‹™ / ç¯„ä¾‹ / ç¿»è­¯ / å·²å„²å­˜ã€åªæœƒæ‰“é–‹è¼”åŠ©å°çª—ï¼Œä¸æœƒä¸­æ–·å°è©±ã€‚</div>
    </div>
  </div>
</div>

<!-- Sheet -->
<div class="sheetMask" id="sheetMask" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true">
    <div class="sheetHeader">
      <div class="sheetTitle" id="sheetTitle">...</div>
      <button class="sheetClose" id="sheetClose">é—œé–‰</button>
    </div>
    <div id="sheetBody"></div>
  </div>
</div>

<script>
/* ============================
   Talk A - repaired build
   - æ”¯æ´ index.json çš„ scenes æˆ– items æ ¼å¼
   - æ”¯æ´ 5 å€‹ä¸»é¡Œï¼ˆcoffee_shop / hotel_checkin / restaurant_order / airport_checkin / business_meetingï¼‰
   - ä¸æ›é ï¼šä»»å‹™/ç¯„ä¾‹/ç¿»è­¯/å·²å„²å­˜ ä»¥ Sheet é¡¯ç¤º
   - ä¸»å‹•å‡ºè²ï¼šè¼‰å…¥æƒ…å¢ƒå¾Œï¼Œè‡ªå‹•å”¸ç¬¬ä¸€å¥ AI å°è©ï¼ˆéœ€ä½¿ç”¨è€…æ›¾é»æ“Šä»»æ„æŒ‰éˆ•è§£é–éŸ³è¨Šï¼‰
============================ */

const $ = (q)=>document.querySelector(q);
const sceneSelect = $('#sceneSelect');
const bigLine = $('#bigLine');
const smallLine = $('#smallLine');
const roleBadge = $('#roleBadge');
const stepPill = $('#stepPill');
const statusDot = $('#statusDot');
const statusText = $('#statusText');
const avatarImg = $('#avatarImg');
const avatarFallback = $('#avatarFallback');
const avatarWrap = $('#avatarWrap');
const avatarRing = $('#avatarRing');
const btnReplay = $('#btnReplay');
const micBtn = $('#micBtn');
const micLabel = $('#micLabel');
const skipBtn = $('#skipBtn');
const sheetMask = $('#sheetMask');
const sheetTitle = $('#sheetTitle');
const sheetBody = $('#sheetBody');
const sheetClose = $('#sheetClose');

let BASE_TALK_DIR = null; // e.g. "./talk/"
let INDEX = null;
let SCENES = [];
let currentSceneKey = null;
let currentScene = null;
let steps = [];
let stepIdx = 0;
let lastSpoken = "";
let voice = null;
let audioUnlocked = false;

let recog = null;
let recognizing = false;

const FALLBACK_INDEX = {
  version: "2026-01-04",
  title: "Talk Scenarios",
  items: [
    { id:"coffee_shop", title_zh:"è²·ä¸€æ¯å’–å•¡", title_en:"Coffee Shop", level:"A1", role:"Barista", avatar:"assets/avatars/teacher-blonde.jpg" },
    { id:"hotel_checkin", title_zh:"é£¯åº—å…¥ä½", title_en:"Hotel Check-in", level:"A1", role:"Front Desk", avatar:"assets/avatars/teacher-blonde.jpg" },
    { id:"restaurant_order", title_zh:"é¤å»³é»é¤", title_en:"Restaurant Order", level:"A1", role:"Server", avatar:"assets/avatars/teacher-blonde.jpg" },
    { id:"airport_checkin", title_zh:"æ©Ÿå ´å ±åˆ°", title_en:"Airport Check-in", level:"A2", role:"Airline Staff", avatar:"assets/avatars/teacher-blonde.jpg" },
    { id:"business_meeting", title_zh:"å•†å‹™æœƒè­°é–‹å ´", title_en:"Business Meeting Opening", level:"A2", role:"Colleague", avatar:"assets/avatars/teacher-blonde.jpg" }
  ]
};

function setStatus(kind, text){
  statusText.textContent = text;
  statusDot.classList.toggle('idle', kind!=='ok');
  if(kind==='ok'){ statusDot.style.background = 'var(--ok)'; }
  if(kind==='warn'){ statusDot.style.background = 'var(--warn)'; statusDot.classList.remove('idle'); }
  if(kind==='danger'){ statusDot.style.background = 'var(--danger)'; statusDot.classList.remove('idle'); }
  if(kind==='idle'){ statusDot.classList.add('idle'); }
}

function safeText(x){ return (x==null) ? "" : String(x); }

async function fetchFirstOk(urls){
  let lastErr = null;
  for(const u of urls){
    try{
      const r = await fetch(u, {cache:"no-store"});
      if(!r.ok) { lastErr = new Error(`HTTP ${r.status} for ${u}`); continue; }
      const j = await r.json();
      return {url:u, json:j};
    }catch(e){ lastErr = e; }
  }
  throw lastErr || new Error("fetch failed");
}

function dirname(path){
  const s = path.split('?')[0].split('#')[0];
  return s.slice(0, s.lastIndexOf('/')+1);
}

function normalizeIndex(raw){
  const out = { title: raw.title || raw.name || "Talk", version: raw.version || "", scenes: [] };
  // æ”¯æ´ raw.scenesï¼ˆèˆŠï¼‰/ raw.itemsï¼ˆä½ é€™ç‰ˆï¼‰
  const arr = Array.isArray(raw.scenes) ? raw.scenes : (Array.isArray(raw.items) ? raw.items : []);
  out.scenes = arr.map(it=>{
    const key = it.key || it.id || it.slug || it.name;
    const title_zh = it.title_zh || it.titleZh || it.zh || it.title || key;
    const title_en = it.title_en || it.titleEn || it.en || it.subtitle || "";
    const level = it.level || it.cefr || "";
    const role = it.role || it.ai_role || it.aiRole || "teacher";
    const avatar = it.avatar || it.avatar_url || it.avatarUrl || "";
    const file = it.file || it.json || it.jsonFile || "";
    return { key, title_zh, title_en, level, role, avatar, file };
  }).filter(x=>x.key);
  return out;
}

function inferSceneFile(sceneKey, meta){
  // GitHub repo ç›®å‰çœ‹åˆ°ï¼šairport.json (ä¸æ˜¯ airport_checkin.json)
  if(meta && meta.file) return meta.file;
  if(sceneKey === 'airport_checkin') return 'airport.json';
  return `${sceneKey}.json`;
}

function bestTitle(meta){
  const zh = meta?.title_zh || meta?.titleZh || meta?.zh || "";
  const en = meta?.title_en || meta?.titleEn || meta?.en || "";
  const lvl = meta?.level ? `(${meta.level})` : "";
  if(zh && en) return `${zh} | ${en} ${lvl}`.trim();
  if(zh) return `${zh} ${lvl}`.trim();
  return `${en} ${lvl}`.trim();
}

function setAvatar(url){
  if(!url){
    avatarImg.style.display = "none";
    avatarFallback.style.display = "flex";
    return;
  }
  avatarImg.src = url;
  avatarImg.onload = ()=>{
    avatarImg.style.display = "block";
    avatarFallback.style.display = "none";
  };
  avatarImg.onerror = ()=>{
    avatarImg.style.display = "none";
    avatarFallback.style.display = "flex";
  };
}

function setTalking(on){
  avatarWrap.classList.toggle('talking', !!on);
  avatarRing.style.filter = on ? "drop-shadow(0 0 12px rgba(76,141,255,.35))" : "none";
}

function pickVoice(){
  const voices = speechSynthesis.getVoices ? speechSynthesis.getVoices() : [];
  // prefer en-US female-ish
  const prefers = [
    (v)=>/en(-|_)US/i.test(v.lang) && /female|jenny|susan|zira|aria|emma|olivia/i.test(v.name),
    (v)=>/en(-|_)US/i.test(v.lang),
    (v)=>/^en/i.test(v.lang),
  ];
  for(const fn of prefers){
    const found = voices.find(fn);
    if(found) return found;
  }
  return voices[0] || null;
}

function speak(text){
  text = safeText(text).trim();
  if(!text) return;
  lastSpoken = text;

  // æŸäº›ç€è¦½å™¨éœ€ä½¿ç”¨è€…äº’å‹•å¾Œæ‰å…è¨±ç™¼è²ï¼šæˆ‘å€‘ç”¨ audioUnlocked æ——æ¨™æç¤º
  if(!('speechSynthesis' in window)){
    setStatus('warn', 'æ­¤ç€è¦½å™¨ä¸æ”¯æ´ TTS');
    return;
  }
  try{ speechSynthesis.cancel(); }catch(_){}

  const u = new SpeechSynthesisUtterance(text);
  u.rate = 1.0;
  u.pitch = 1.0;
  u.volume = 1.0;
  u.lang = voice?.lang || 'en-US';
  if(voice) u.voice = voice;

  u.onstart = ()=>{ setTalking(true); setStatus('ok','Speaking'); };
  u.onend = ()=>{ setTalking(false); setStatus('ok','Ready'); };
  u.onerror = ()=>{ setTalking(false); setStatus('warn','TTS å¤±æ•—'); };

  try{
    speechSynthesis.speak(u);
  }catch(e){
    setTalking(false);
    setStatus('warn','TTS è¢«é˜»æ“‹ï¼ˆè«‹å…ˆé»ä»»æ„æŒ‰éˆ•ï¼‰');
  }
}

function ensureAudioUnlock(){
  // åªè¦é»éä¸€æ¬¡ï¼Œå°±è¦–ç‚ºå·²è§£é–
  audioUnlocked = true;
}

function normalizeScene(raw, meta){
  // ç›¡é‡å®¹éŒ¯ï¼šæ”¯æ´ steps / dialog / lines
  let rawSteps = [];
  if(Array.isArray(raw.steps)) rawSteps = raw.steps;
  else if(Array.isArray(raw.dialog)) rawSteps = raw.dialog;
  else if(Array.isArray(raw.lines)) rawSteps = raw.lines;

  // è‹¥æ¯æ­¥æ˜¯ {ai:"...", user:"..."} å½¢å¼ï¼Œå±•é–‹
  let flat = [];
  for(const s of rawSteps){
    if(s==null) continue;
    if(typeof s === 'string'){
      flat.push({role:'ai', en:s});
    }else if(s.ai && s.user){
      flat.push({role:'ai', en:s.ai, zh:s.ai_zh||s.aiZh||""});
      flat.push({role:'user', en:s.user, zh:s.user_zh||s.userZh||""});
    }else{
      const role = s.role || s.speaker || s.who || (s.is_ai ? 'ai' : (s.is_user ? 'user' : 'ai'));
      const en = s.en || s.text || s.line || s.say || "";
      const zh = s.zh || s.tw || s.cn || s.translation || "";
      flat.push({role, en, zh, tip:s.tip, vocab:s.vocab, examples:s.examples});
    }
  }

  // ç¢ºä¿è‡³å°‘ 10-15 å¥ï¼ˆè‹¥ä¸è¶³ï¼Œç”¨ç°¡å–®æ¨¡æ¿è£œé½Šï¼Œä¸ç ´å£åŸè³‡æ–™ï¼‰
  if(flat.length < 10){
    const pad = [
      {role:'ai', en:"Anything else for you today?", zh:"é‚„éœ€è¦å…¶ä»–å—ï¼Ÿ"},
      {role:'user', en:"That's all, thank you.", zh:"å°±é€™æ¨£ï¼Œè¬è¬ã€‚"},
      {role:'ai', en:"You're welcome. Have a nice day!", zh:"ä¸å®¢æ°£ï¼Œç¥ä½ æœ‰ç¾å¥½çš„ä¸€å¤©ï¼"},
    ];
    flat = flat.concat(pad.slice(0, Math.max(0, 10-flat.length)));
  }

  // review
  const review = raw.review || raw.comment || raw.feedback || "";
  const task = raw.task || raw.objective || (meta?.title_zh ? `å®Œæˆã€Œ${meta.title_zh}ã€æƒ…å¢ƒå°è©±ï¼Œç·´ç¿’åŸºæœ¬å£èªã€‚` : "å®Œæˆæƒ…å¢ƒå°è©±ã€‚");
  const examples = raw.examples || raw.example || [];
  const vocab = raw.vocab || raw.words || [];

  return {
    meta,
    task,
    examples,
    vocab,
    review,
    steps: flat
  };
}

function renderStep(){
  const step = steps[stepIdx] || null;
  if(!step){
    // finished
    renderReview();
    return;
  }
  const role = (step.role || 'ai').toLowerCase();
  const isAI = role.includes('ai') || role.includes('teacher') || role.includes('barista') || role.includes('staff') || role.includes('server') || role.includes('desk');

  // UI
  bigLine.textContent = safeText(step.en) || "â€¦";
  smallLine.textContent = safeText(step.zh) || "";
  stepPill.textContent = `step: ${stepIdx+1} / ${steps.length}`;

  // mic label
  if(isAI){
    micLabel.textContent = "é»æˆ‘èªªï¼ˆå›è¦†ä¸‹ä¸€å¥ï¼‰";
  }else{
    micLabel.textContent = "é»æˆ‘èªªï¼ˆé–‹å§‹è¾¨è­˜ï¼‰";
  }

  // AI ä¸»å‹•è¬›
  if(isAI){
    if(audioUnlocked){
      speak(step.en);
    }else{
      setStatus('warn', 'æŒ‰ä¸€æ¬¡ä»»æ„æŒ‰éˆ•å¾Œï¼ŒAI æœƒè‡ªå‹•å‡ºè²');
    }
  }else{
    setStatus('ok', 'Ready');
  }
}

function advanceWithUser(text){
  text = safeText(text).trim();
  if(!text) return;
  // è¨˜éŒ„ç°¡æ˜“ï¼šæŠŠä½¿ç”¨è€…èªéŸ³æ”¾åˆ° smallLine ä¸€ç¬æç¤ºï¼ˆä¸åšèŠå¤©å®¤é•·åˆ—è¡¨ï¼Œé¿å…ä½ ä¸å–œæ­¡ç‰ˆé¢è¢«æ”¹ï¼‰
  smallLine.textContent = `ä½ èªªï¼š${text}`;
  // å‰é€²ç›´åˆ°ä¸‹ä¸€å€‹ AI stepï¼ˆå‡è¨­æ­¥é©Ÿäº¤æ›¿ï¼‰
  if(stepIdx < steps.length-1) stepIdx++;
  renderStep();
}

function skipStep(){
  if(stepIdx < steps.length-1) stepIdx++;
  renderStep();
}

function renderSceneMeta(){
  const m = currentScene?.meta || {};
  const role = m.role || 'teacher';
  roleBadge.textContent = `AI Â· ${role}`;
  setAvatar(m.avatar || "");
  // select title
  const title = bestTitle(m);
  const opt = sceneSelect.querySelector(`option[value="${m.key}"]`);
  if(opt) opt.textContent = title;
}

function openSheet(kind){
  if(!currentScene) return;
  const m = currentScene.meta || {};
  sheetBody.innerHTML = "";
  let title = "";
  if(kind==='task'){
    title = "ä»»å‹™èªªæ˜";
    sheetBody.innerHTML = `
      <div class="kv">
        <h3>é€™ä¸€é—œè¦åšä»€éº¼</h3>
        <p>${escapeHtml(currentScene.task || "")}</p>
      </div>
      <div class="kv">
        <h3>å°æç¤º</h3>
        <ul>
          <li>å…ˆè½ AI ä¸€å¥ â†’ å†ç”¨ä¸€å¥ç°¡çŸ­è‹±æ–‡å›è¦†ã€‚</li>
          <li>ä¸æœƒèªªä¹Ÿæ²’é—œä¿‚ï¼ŒæŒ‰ã€Œè·³éã€å¾€ä¸‹èµ°ï¼Œä¿æŒç¯€å¥ã€‚</li>
          <li>æƒ³å†è½ä¸€æ¬¡å°±æŒ‰å³ä¸Šã€Œé‡æ’­æœ¬å¥ã€ã€‚</li>
        </ul>
      </div>
      <div class="mini">ï¼ˆä¸æ›é ï¼šé—œé–‰å°çª—å³å¯å›åˆ°åŸæœ¬å°è©±ç‹€æ…‹ï¼‰</div>
    `;
  }else if(kind==='examples'){
    title = "ç¯„ä¾‹ï¼ˆä¸ç¯„å¥ï¼‰";
    const ex = normalizeList(currentScene.examples);
    sheetBody.innerHTML = `
      <div class="kv">
        <h3>å¯ç”¨å¥å‹</h3>
        ${ex.length ? `<ul>${ex.map(x=>`<li>${escapeHtml(x)}</li>`).join('')}</ul>` : `<p>ï¼ˆæ­¤æƒ…å¢ƒå°šæœªæä¾›ç¯„ä¾‹å¥ï¼‰</p>`}
      </div>
    `;
  }else if(kind==='translate'){
    title = "ç¿»è­¯ï¼ˆä¸­ / æ—¥ï¼‰";
    const step = steps[stepIdx] || {};
    const en = safeText(step.en);
    const zh = safeText(step.zh);
    const ja = (step.ja || step.jp || "");
    sheetBody.innerHTML = `
      <div class="kv">
        <h3>ç›®å‰é€™å¥</h3>
        <p><b>EN</b>ï¼š${escapeHtml(en)}</p>
        <p style="margin-top:6px"><b>ä¸­æ–‡</b>ï¼š${escapeHtml(zh || "ï¼ˆæ­¤å¥å°šæœªæä¾›ä¸­æ–‡ç¿»è­¯ï¼‰")}</p>
        <p style="margin-top:6px"><b>æ—¥æ–‡</b>ï¼š${escapeHtml(ja || "ï¼ˆæ­¤å¥å°šæœªæä¾›æ—¥æ–‡ç¿»è­¯ï¼‰")}</p>
      </div>
      <div class="kv">
        <h3>ä¸€éµæœ—è®€</h3>
        <p><button class="btn primary" id="speakThis">æœ—è®€ EN</button></p>
      </div>
    `;
    setTimeout(()=>{
      const b = $('#speakThis');
      if(b) b.onclick = ()=>{ ensureAudioUnlock(); speak(en); };
    },0);
  }else if(kind==='saved'){
    title = "ä¸»é¡Œå–®å­— / å·²å„²å­˜";
    const v = normalizeVocab(currentScene.vocab);
    sheetBody.innerHTML = `
      <div class="kv">
        <h3>å¸¸ç”¨å–®å­—</h3>
        ${v.length ? `<ul>${v.map(o=>`<li><b>${escapeHtml(o.word)}</b>${o.meaning?`ï¼š${escapeHtml(o.meaning)}`:""}</li>`).join('')}</ul>` : `<p>ï¼ˆæ­¤æƒ…å¢ƒå°šæœªæä¾›å–®å­—ï¼‰</p>`}
      </div>
      <div class="kv">
        <h3>å¿«é€Ÿç·´ç¿’</h3>
        <p>æŒ‘ 3 å€‹å–®å­—é€ å¥ï¼Œä¸¦å¤§è²å”¸å‡ºä¾†ã€‚</p>
      </div>
    `;
  }
  sheetTitle.textContent = title;
  sheetMask.style.display = "flex";
  sheetMask.setAttribute('aria-hidden','false');
}

function closeSheet(){
  sheetMask.style.display = "none";
  sheetMask.setAttribute('aria-hidden','true');
}

function escapeHtml(s){
  return String(s||"").replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;");
}
function normalizeList(x){
  if(!x) return [];
  if(Array.isArray(x)) return x.map(safeText).filter(Boolean);
  if(typeof x === 'string') return x.split(/\n+/).map(t=>t.trim()).filter(Boolean);
  return [];
}
function normalizeVocab(x){
  if(!x) return [];
  if(Array.isArray(x)){
    return x.map(it=>{
      if(typeof it === 'string') return {word:it, meaning:""};
      return {word: it.word||it.en||it.term||"", meaning: it.zh||it.meaning||it.def||""};
    }).filter(o=>o.word);
  }
  return [];
}

function renderReview(){
  const m = currentScene?.meta || {};
  const title = bestTitle(m);
  const wordCount = steps.reduce((n,s)=> n + (safeText(s.en).split(/\s+/).filter(Boolean).length), 0);
  const completion = Math.round(100 * Math.min(1, (stepIdx+1)/Math.max(1, steps.length)));
  const topic = Math.max(50, Math.min(100, 40 + Math.round(completion*0.6)));
  const pron = audioUnlocked ? 53 : 0;

  openSheet('task'); // reuse mask
  sheetTitle.textContent = "å­¸ç¿’å ±å‘Š";
  sheetBody.innerHTML = `
    <div class="reviewStars">
      <div class="star">â­</div>
      <div class="star">â­</div>
      <div class="star">â­</div>
    </div>
    <div class="reviewBig">å¾ˆæ£’ï¼</div>
    <div class="kv" style="text-align:center">
      <h3 style="margin-bottom:0">${escapeHtml(m.title_zh||title)}</h3>
      <p class="mini" style="margin-top:8px">ä½ å¯ä»¥ç¹¼çºŒä¸‹ä¸€å€‹æƒ…å¢ƒï¼Œæˆ–é‡æ’­ä¸¦å†ç·´ä¸€æ¬¡ã€‚</p>
    </div>
    <div class="metrics">
      <div class="metric"><div class="metricNum">${topic}%</div><div class="metricLbl">ä¸»é¡Œç›¸é—œåº¦</div></div>
      <div class="metric"><div class="metricNum">${pron}%</div><div class="metricLbl">ç™¼éŸ³</div></div>
      <div class="metric"><div class="metricNum">${wordCount}</div><div class="metricLbl">ä½¿ç”¨çš„å–®å­—æ•¸</div></div>
    </div>
    <div class="kv">
      <h3>å»ºè­° / è©•èª</h3>
      <p>${escapeHtml(currentScene.review || "ä¿æŒå¥å­çŸ­ä¸€é»ã€ç¯€å¥å¿«ä¸€é»ã€‚ä¸‹ä¸€è¼ªè©¦è‘—æŠŠã€Œè«‹æ±‚ã€èˆ‡ã€Œç¢ºèªã€å„èªªä¸€æ¬¡ã€‚")}</p>
      <div class="hr"></div>
      <p class="mini">æç¤ºï¼šå¦‚æœ AI æ²’æœ‰ä¸»å‹•å‡ºè²ï¼Œå¤šåŠæ˜¯ç€è¦½å™¨çš„è‡ªå‹•æ’­æ”¾é™åˆ¶ã€‚å…ˆæŒ‰ä¸€æ¬¡ä»»ä½•æŒ‰éˆ•ï¼ˆä¾‹å¦‚ã€Œé‡æ’­æœ¬å¥ã€ï¼‰å³å¯è§£é–ã€‚</p>
    </div>
    <p style="display:flex; gap:10px; margin:0">
      <button class="btn primary" id="btnContinue" style="flex:1">ç¹¼çºŒ</button>
      <button class="btn" id="btnShowLog" style="flex:1">èŠå¤©è¨˜éŒ„</button>
    </p>
  `;
  setTimeout(()=>{
    const c = $('#btnContinue'); if(c) c.onclick = ()=>{ closeSheet(); };
    const l = $('#btnShowLog'); if(l) l.onclick = ()=>{ alert("æ­¤ç°¡åŒ–ç‰ˆå…ˆä¸é¡¯ç¤ºé•·åˆ—è¡¨ï¼ˆé¿å…ç‰ˆé¢è®Šå¾—æ›´è¤‡é›œï¼‰ã€‚ä½ è¦ã€ŒèŠå¤©è¨˜éŒ„ã€æˆ‘å¯ä»¥ä¸‹ä¸€ç‰ˆåŠ ã€‚"); };
  },0);
}

/* Speech Recognition */
function setupRecognition(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){
    micLabel.textContent = "æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜";
    micBtn.style.opacity = .6;
    return;
  }
  recog = new SR();
  recog.lang = "en-US";
  recog.continuous = false;
  recog.interimResults = true;

  recog.onstart = ()=>{ recognizing = true; setStatus('ok','Listening'); micLabel.textContent = "è½å–ä¸­â€¦ï¼ˆå†æŒ‰ä¸€æ¬¡åœæ­¢ï¼‰"; };
  recog.onend = ()=>{ recognizing = false; setStatus('ok','Ready'); micLabel.textContent = "é»æˆ‘èªªï¼ˆé–‹å§‹è¾¨è­˜ï¼‰"; };
  recog.onerror = ()=>{ recognizing = false; setStatus('warn','è¾¨è­˜å¤±æ•—'); micLabel.textContent = "é»æˆ‘èªªï¼ˆé–‹å§‹è¾¨è­˜ï¼‰"; };
  recog.onresult = (ev)=>{
    let finalTxt = "";
    let interim = "";
    for(let i=ev.resultIndex;i<ev.results.length;i++){
      const t = ev.results[i][0].transcript;
      if(ev.results[i].isFinal) finalTxt += t;
      else interim += t;
    }
    if(interim) smallLine.textContent = `ä½ èªªï¼ˆè¾¨è­˜ä¸­ï¼‰ï¼š${interim}`;
    if(finalTxt){
      ensureAudioUnlock();
      advanceWithUser(finalTxt);
      try{ recog.stop(); }catch(_){}
    }
  };
}

async function loadIndex(){
  // å˜—è©¦å¤šå€‹è·¯å¾‘ï¼Œé¿å…ä½ é‡åˆ° 404 å°±æ•´å€‹æ›æ‰
  const candidates = [
    "./talk/index.json",
    "talk/index.json",
    "/talk/index.json",
    "./EduEnglish/talk/index.json",
    "/EduEnglish/talk/index.json",
  ];
  try{
    const {url, json} = await fetchFirstOk(candidates);
    BASE_TALK_DIR = dirname(url);
    INDEX = normalizeIndex(json);
  }catch(e){
    BASE_TALK_DIR = "./talk/";
    INDEX = normalizeIndex(FALLBACK_INDEX);
  }
  SCENES = INDEX.scenes || [];
  if(!SCENES.length){
    // æœ€å¾Œä¿åº•
    INDEX = normalizeIndex(FALLBACK_INDEX);
    SCENES = INDEX.scenes;
  }
}

function buildSceneSelector(){
  sceneSelect.innerHTML = "";
  for(const s of SCENES){
    const opt = document.createElement('option');
    opt.value = s.key;
    opt.textContent = bestTitle(s);
    sceneSelect.appendChild(opt);
  }
}

async function loadScene(sceneKey){
  currentSceneKey = sceneKey;
  const meta = SCENES.find(x=>x.key===sceneKey) || {key:sceneKey, title_zh:sceneKey, level:"", role:"teacher", avatar:""};
  // æ›´æ–° selector é¡¯ç¤º
  sceneSelect.value = sceneKey;

  const file = inferSceneFile(sceneKey, meta);
  const urls = [
    `${BASE_TALK_DIR}${file}`,
    `./talk/${file}`,
    `talk/${file}`,
    `/talk/${file}`,
    `./EduEnglish/talk/${file}`,
    `/EduEnglish/talk/${file}`,
  ];
  setStatus('ok','Loading');
  bigLine.textContent = "ï¼ˆè¼‰å…¥ä¸­â€¦ï¼‰";
  smallLine.textContent = "";
  try{
    const {json} = await fetchFirstOk(urls);
    currentScene = normalizeScene(json, {...meta, key: sceneKey});
  }catch(e){
    // ä»ç„¶è®“ UI æ´»è‘—
    currentScene = normalizeScene({
      task:`å®Œæˆã€Œ${meta.title_zh||sceneKey}ã€å°è©±ï¼Œå…ˆè½å¾Œèªªï¼Œæ¯æ¬¡ä¸€å¥ã€‚`,
      steps:[
        {role:'ai', en:'Hello! Letâ€™s start.' , zh:'ä½ å¥½ï¼æˆ‘å€‘é–‹å§‹å§ã€‚'},
        {role:'user', en:'Okay.' , zh:'å¥½ã€‚'},
        {role:'ai', en:'Great. Try the real scenario next.' , zh:'å¾ˆå¥½ï¼Œæ¥è‘—æ›çœŸå¯¦æƒ…å¢ƒã€‚'},
      ],
      review:"æ‰¾ä¸åˆ° JSON æª”æ™‚ï¼Œè«‹ç¢ºèª talk/ è³‡æ–™å¤¾å…§æª”åèˆ‡è·¯å¾‘ã€‚"
    }, {...meta, key: sceneKey});
    setStatus('warn','æ‰¾ä¸åˆ°æƒ…å¢ƒ JSONï¼ˆå·²ç”¨ä¿åº•ç¤ºç¯„ï¼‰');
  }
  renderSceneMeta();

  steps = currentScene.steps || [];
  stepIdx = 0;
  // ç¢ºä¿ç¬¬ä¸€å¥æ˜¯ AIï¼ˆå¦‚æœç¬¬ä¸€å¥æ˜¯ userï¼Œå°±å¾€å¾Œæ‰¾ä¸‹ä¸€å¥ AIï¼‰
  if(steps[0] && String(steps[0].role||'').toLowerCase().includes('user')){
    const aiPos = steps.findIndex(s=>!String(s.role||'').toLowerCase().includes('user'));
    if(aiPos>0) stepIdx = aiPos;
  }

  renderStep();
}

/* UI events */
btnReplay.addEventListener('click', ()=>{
  ensureAudioUnlock();
  if(lastSpoken) speak(lastSpoken);
});

skipBtn.addEventListener('click', ()=>{
  ensureAudioUnlock();
  skipStep();
});

micBtn.addEventListener('click', ()=>{
  ensureAudioUnlock();
  const step = steps[stepIdx] || {};
  const role = String(step.role||'ai').toLowerCase();
  const isAI = !role.includes('user');

  // è‹¥ç›®å‰æ˜¯ AI æ­¥é©Ÿï¼šæŒ‰ mic ç­‰åŒã€Œæˆ‘å›è¦†ä¸‹ä¸€å¥ï¼ˆç”¨ç°¡å–®é è¨­å¥ï¼‰ã€é¿å…å¡ä½
  if(isAI){
    // ä¾æƒ…å¢ƒçµ¦ä¸€å€‹åˆç†çŸ­å›è¦†ï¼ˆä½ ä¹Ÿå¯ä»¥æ”¹æˆä½¿ç”¨è€…çœŸçš„èªªè©±ï¼‰
    const autoReply = guessQuickReply(currentSceneKey);
    advanceWithUser(autoReply);
    return;
  }

  if(!recog){
    alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼ˆSpeechRecognitionï¼‰ã€‚ä½ ä»å¯ç”¨ã€Œè·³éã€æˆ–é‡æ’­ç·´ç¿’ã€‚");
    return;
  }
  try{
    if(recognizing){ recog.stop(); }
    else recog.start();
  }catch(e){
    // iOS/æŸäº›ç€è¦½å™¨å¯èƒ½éœ€è¦ HTTPS/æ¬Šé™
    setStatus('warn','ç„¡æ³•å•Ÿå‹•è¾¨è­˜ï¼ˆè«‹å…è¨±éº¥å…‹é¢¨ï¼‰');
  }
});

sceneSelect.addEventListener('change', ()=>{
  ensureAudioUnlock();
  loadScene(sceneSelect.value);
});

sheetClose.addEventListener('click', closeSheet);
sheetMask.addEventListener('click', (e)=>{ if(e.target===sheetMask) closeSheet(); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeSheet(); });

document.querySelectorAll('.tile').forEach(el=>{
  el.addEventListener('click', ()=>{
    ensureAudioUnlock();
    openSheet(el.getAttribute('data-sheet'));
  });
});

/* Helpers */
function guessQuickReply(sceneKey){
  const map = {
    coffee_shop: "I'd like a latte, please.",
    hotel_checkin: "I have a reservation under Lin.",
    restaurant_order: "I'd like the chicken sandwich, please.",
    airport_checkin: "I'm checking in for my flight.",
    business_meeting: "Thanks for joining. Shall we begin?",
  };
  return map[sceneKey] || "Okay.";
}

/* Boot */
function boot(){
  setStatus('ok','Loading');
  // voice list may come late
  function loadVoices(){
    voice = pickVoice();
  }
  loadVoices();
  if('speechSynthesis' in window){
    window.speechSynthesis.onvoiceschanged = loadVoices;
  }
  setupRecognition();

  loadIndex().then(()=>{
    buildSceneSelector();
    // default: first scene
    const first = (SCENES && SCENES[0] && SCENES[0].key) ? SCENES[0].key : "coffee_shop";
    // if URL has ?scene=
    const u = new URL(location.href);
    const qs = u.searchParams.get('scene') || u.searchParams.get('id') || u.searchParams.get('topic');
    const pick = qs && SCENES.find(s=>s.key===qs) ? qs : first;
    loadScene(pick);
  }).catch((e)=>{
    setStatus('danger','åˆå§‹åŒ–å¤±æ•—');
    bigLine.textContent = "è¼‰å…¥å¤±æ•—";
    smallLine.textContent = String(e);
  });
}
boot();
</script>
</body>
</html>
