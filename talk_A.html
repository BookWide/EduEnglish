<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BookWide Talkï½œå½±åƒå£èªªåŠ©æ•™</title>
<style>
:root{
  --bg:#f4f6fb; --card:#fff; --ink:#0f172a; --muted:#64748b;
  --brand:#2563eb; --brand2:#1d4ed8; --line:#e5e7eb;
  --warn:#f59e0b; --bad:#ef4444; --ok:#10b981;
}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;background:var(--bg);color:var(--ink)}
header{background:#0b1220;color:#fff;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;gap:12px}
header .right{display:flex;gap:10px;align-items:center}
header a{color:#fff;text-decoration:none;opacity:.9}
main{display:grid;grid-template-columns:420px 1fr;gap:16px;padding:16px;max-width:1200px;margin:0 auto}
@media (max-width: 980px){ main{grid-template-columns:1fr} }
.card{background:var(--card);border-radius:18px;padding:16px;border:1px solid var(--line);box-shadow:0 10px 28px rgba(15,23,42,.06)}
h2{margin:0 0 10px;font-size:18px}
label{display:block;font-size:12px;color:var(--muted);margin-top:10px;margin-bottom:6px}
select,input,button,textarea{font:inherit}
select,input,textarea{
  width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;outline:none;
}
textarea{min-height:64px;resize:vertical}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
button{
  padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer;
}
button.primary{background:var(--brand);border-color:var(--brand);color:#fff}
button.primary:active{background:var(--brand2)}
button.danger{background:var(--bad);border-color:var(--bad);color:#fff}
button:disabled{opacity:.5;cursor:not-allowed}
.videoWrap{margin-top:10px;border-radius:16px;overflow:hidden;background:#000;aspect-ratio: 4 / 3;display:flex;align-items:center;justify-content:center}
video{width:100%;height:100%;object-fit:cover}
.badge{font-size:12px;color:#fff;background:rgba(255,255,255,.16);padding:6px 10px;border-radius:999px}
.panelTitle{display:flex;align-items:center;justify-content:space-between;gap:10px}
.kpi{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff}
.pill.ok{border-color:rgba(16,185,129,.4);background:rgba(16,185,129,.08)}
.pill.bad{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.08)}
.pill.warn{border-color:rgba(245,158,11,.4);background:rgba(245,158,11,.10)}
.msg{
  border:1px solid var(--line);
  border-radius:16px;
  padding:14px;
  background:#fff;
  margin-top:10px;
}
.msg.ai{background:#f8fafc}
.banner{
  margin-top:10px;
  border-radius:14px;
  padding:10px 12px;
  border:1px solid rgba(245,158,11,.45);
  background:rgba(245,158,11,.12);
  color:#7c2d12;
  font-size:13px;
}
hr{border:none;border-top:1px solid var(--line);margin:14px 0}
small{color:var(--muted)}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:10px">
    <strong style="font-size:18px">BookWide Talk</strong>
    <span class="badge">å½±åƒå£èªª</span>
  </div>
  <div class="right">
    <a href="/index.html">å›é¦–é </a>
  </div>
</header>

<main>
  <section class="card">
    <div class="panelTitle">
      <h2>å£èªªç·´ç¿’è¨­å®š</h2>
      <div class="kpi">
        <span id="camState" class="pill warn">ç›¸æ©Ÿæœªé–‹</span>
        <span id="micState" class="pill warn">éº¥å…‹é¢¨æœªéŒ„</span>
      </div>
    </div>

    <div class="row">
      <div>
        <label>æƒ…å¢ƒ</label>
        <select id="scene">
          <option value="nails">å¡—æŒ‡ç”² nails</option>
          <option value="makeup">åŒ–å¦ makeup</option>
          <option value="cooking" selected>åšèœ cooking</option>
          <option value="coffee">å–å’–å•¡ coffee</option>
          <option value="shopping">é€›è¡— shopping</option>
        </select>
      </div>
      <div>
        <label>èªè¨€</label>
        <select id="lang">
          <option value="en" selected>è‹±æ–‡ï¼ˆENï¼‰</option>
          <option value="ja">æ—¥æ–‡ï¼ˆJAï¼‰</option>
        </select>
      </div>
    </div>

    <label>AI ç«¯é»ï¼ˆEdge Functionï¼‰</label>
    <input id="endpoint" class="mono" placeholder="https://YOURPROJECT.supabase.co/functions/v1/talk-vision" />
    <small>âš ï¸ GitHub Pages ä¸èƒ½ç”¨ <span class="mono">/functions/v1/...</span> ç›¸å°è·¯å¾‘ï¼›ä¸€å®šè¦å¡«å®Œæ•´ç¶²å€ã€‚</small>

    <label>æç¤ºï¼ˆå¯é¸ï¼‰</label>
    <textarea id="hint" placeholder="ä¾‹å¦‚ï¼šç”¨ç°¡å–®å¥ã€æ…¢æ…¢èªªï¼›æ¯æ¬¡ä¸€å¥å°±å¥½ã€‚"></textarea>

    <div class="videoWrap">
      <video id="cam" autoplay muted playsinline></video>
    </div>

    <div class="btns">
      <button id="btnCam" class="primary">é–‹å•Ÿç›¸æ©Ÿ</button>
      <button id="btnTest" >æ¸¬è©¦ç«¯é»</button>
      <button id="btnClear" class="danger">æ¸…ç©ºçµæœ</button>
    </div>

    <hr>

    <div class="btns">
      <button id="btnHold" class="primary" disabled>æŒ‰ä½èªªè©±</button>
      <button id="btnSendText" disabled>é€å‡ºæ–‡å­—</button>
    </div>

    <label>ä½ çš„å¥å­ï¼ˆå¯æ‰“å­—æ¸¬è©¦ï¼Œä¸ç”¨éŒ„éŸ³ï¼‰</label>
    <input id="textInput" placeholder="ä¾‹å¦‚ï¼šI'm cooking dinner." />

    <div class="banner">
      ä½¿ç”¨æ–¹å¼ï¼šå…ˆæŒ‰ã€Œé–‹å•Ÿç›¸æ©Ÿã€â†’ å†æŒ‰ä½ã€ŒæŒ‰ä½èªªè©±ã€è¬› 1 å¥ â†’ æ”¾é–‹å°±æœƒé€ AI åˆ†æï¼ˆç•«é¢ + è²éŸ³ï¼‰ã€‚
    </div>
  </section>

  <section class="card">
    <div class="panelTitle">
      <h2>AI å³æ™‚ç³¾éŒ¯</h2>
      <div class="kpi">
        <span id="netState" class="pill warn">å¾…å‘½</span>
      </div>
    </div>

    <div id="out">
      <div class="msg ai">
        <div class="mono">å°šæœªé–‹å§‹</div>
        <small>è‹¥ä½ çœ‹åˆ°ã€ŒUnexpected token '&lt;'ã€è¡¨ç¤ºç«¯é»å›å‚³çš„æ˜¯ HTMLï¼ˆå¸¸è¦‹ï¼š404/401/500/è¢«å°åˆ°ç™»å…¥é ï¼‰ã€‚</small>
      </div>
    </div>
  </section>
</main>

<script>
/* ===== BookWide Talk Cam+Voice MVP (v2) =====
   - ä¿®æ­£ï¼šUnexpected token '<'ï¼šæ”¹æˆã€Œåµæ¸¬ content-type / é JSON é¡¯ç¤ºåŸæ–‡ã€
   - ä¿®æ­£ï¼šGitHub Pages ç›¸å°è·¯å¾‘å¤±æ•—ï¼šé è¨­å¡ Supabase å®Œæ•´ç¶²å€
*/

const $ = (id)=>document.getElementById(id);
const cam = $('cam');
const camState = $('camState');
const micState = $('micState');
const netState = $('netState');

let stream = null;
let mediaRecorder = null;
let audioChunks = [];
let holding = false;

const SUPABASE_URL = 'https://jeajrwpmrgczimmrflxo.supabase.co'; // ä½ çš„å°ˆæ¡ˆ
const DEFAULT_ENDPOINT = SUPABASE_URL + '/functions/v1/talk-vision';

$('endpoint').value = DEFAULT_ENDPOINT;

function pill(el, kind, text){
  el.className = 'pill ' + (kind||'');
  el.textContent = text;
}

function addMsg(html){
  const wrap = document.createElement('div');
  wrap.className = 'msg ai';
  wrap.innerHTML = html;
  $('out').prepend(wrap);
}

function clearOut(){
  $('out').innerHTML = '';
  addMsg('<div class="mono">å·²æ¸…ç©º</div>');
}

$('btnClear').addEventListener('click', clearOut);

$('btnCam').addEventListener('click', async ()=>{
  try{
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'user' }, audio: true });
    cam.srcObject = stream;
    pill(camState,'ok','ç›¸æ©Ÿå·²é–‹');
    pill(micState,'ok','éº¥å…‹é¢¨å¯ç”¨');
    $('btnHold').disabled = false;
    $('btnSendText').disabled = false;
  }catch(err){
    pill(camState,'bad','ç›¸æ©Ÿå¤±æ•—');
    pill(micState,'bad','éº¥å…‹é¢¨å¤±æ•—');
    addMsg(`<div class="mono">ç„¡æ³•å–å¾—ç›¸æ©Ÿ/éº¥å…‹é¢¨ï¼š${escapeHtml(err.message||String(err))}</div>`);
  }
});

$('btnTest').addEventListener('click', async ()=>{
  const endpoint = $('endpoint').value.trim();
  if(!endpoint){ alert('è«‹å¡«ç«¯é»'); return; }
  pill(netState,'warn','æ¸¬è©¦ä¸­â€¦');
  try{
    const res = await fetch(endpoint, { method:'OPTIONS' }).catch(()=>null);
    // é€™è£¡ä¸è¦æ±‚æˆåŠŸï¼ˆæœ‰äº› edge ä¸å› OPTIONSï¼‰ï¼Œåªè¦ä¸æ˜¯ç«‹åˆ»å°åˆ° HTML æˆ– 404
    pill(netState,'ok','ç«¯é»å¯é€£');
    addMsg(`<div><b>ç«¯é»ï¼š</b><span class="mono">${escapeHtml(endpoint)}</span></div><small>å¦‚æœæ­£å¼é€å‡ºä»å› HTMLï¼Œä»£è¡¨è¢«æ“‹ï¼ˆ401ï¼‰æˆ–è·¯å¾‘ä¸å°ï¼ˆ404ï¼‰ã€‚</small>`);
  }catch(err){
    pill(netState,'bad','ç«¯é»å¤±æ•—');
    addMsg(`<div class="mono">ç«¯é»æ¸¬è©¦å¤±æ•—ï¼š${escapeHtml(err.message||String(err))}</div>`);
  }
});

/* ----- Hold-to-talk (mouse/touch) ----- */
const btnHold = $('btnHold');

btnHold.addEventListener('mousedown', ()=> startRec());
btnHold.addEventListener('mouseup', ()=> stopRec());
btnHold.addEventListener('mouseleave', ()=> { if(holding) stopRec(); });

btnHold.addEventListener('touchstart', (e)=>{ e.preventDefault(); startRec(); }, {passive:false});
btnHold.addEventListener('touchend', (e)=>{ e.preventDefault(); stopRec(); }, {passive:false});

function startRec(){
  if(!stream){ alert('è«‹å…ˆé–‹å•Ÿç›¸æ©Ÿ'); return; }
  if(holding) return;
  holding = true;
  audioChunks = [];
  pill(micState,'warn','éŒ„éŸ³ä¸­â€¦');
  btnHold.textContent = 'éŒ„éŸ³ä¸­â€¦(æ”¾é–‹é€å‡º)';

  try{
    mediaRecorder = new MediaRecorder(stream, { mimeType: pickMimeType() });
  }catch{
    mediaRecorder = new MediaRecorder(stream);
  }

  mediaRecorder.ondataavailable = (e)=>{ if(e.data && e.data.size>0) audioChunks.push(e.data); };
  mediaRecorder.onstop = ()=> sendToAI();
  mediaRecorder.start(200);
}

function stopRec(){
  if(!holding) return;
  holding = false;
  btnHold.textContent = 'æŒ‰ä½èªªè©±';
  try{
    if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
  }catch{}
}

function pickMimeType(){
  const prefers = ['audio/webm;codecs=opus','audio/webm','audio/mp4'];
  for(const t of prefers){
    if(window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(t)) return t;
  }
  return '';
}

/* ----- Send text mode ----- */
$('btnSendText').addEventListener('click', async ()=>{
  const sentence = $('textInput').value.trim();
  if(!sentence){ alert('è«‹å…ˆè¼¸å…¥ä¸€å¥'); return; }
  await sendToAI({text: sentence});
});

/* ----- Core send ----- */
async function sendToAI(extra={}){
  const endpoint = $('endpoint').value.trim();
  if(!endpoint){ alert('è«‹å¡«ç«¯é»'); return; }

  pill(netState,'warn','AI åˆ†æä¸­â€¦');

  // audio blob
  let audioBlob = null;
  if(!extra.text){
    audioBlob = new Blob(audioChunks, { type: mediaRecorder?.mimeType || 'audio/webm' });
  }

  // capture image as blob file
  const imgBlob = await captureFrameBlob().catch(()=>null);

  const fd = new FormData();
  fd.append('scene', $('scene').value);
  fd.append('lang', $('lang').value);
  fd.append('hint', $('hint').value || '');
  if(imgBlob) fd.append('image_file', imgBlob, 'frame.jpg');
  if(audioBlob) fd.append('audio_file', audioBlob, 'speech.webm');
  if(extra.text) fd.append('text', extra.text);

  try{
    const res = await fetch(endpoint, { method:'POST', body: fd });
    const ctype = (res.headers.get('content-type') || '').toLowerCase();
    const raw = await res.text(); // å…ˆæ‹¿ textï¼Œå†è¦–æƒ…æ³ parse json

    if(!res.ok){
      pill(netState,'bad', `HTTP ${res.status}`);
      addMsg(renderHttpError(res.status, raw));
      return;
    }

    if(!ctype.includes('application/json')){
      // å¾ˆå¸¸è¦‹ï¼šå› HTMLï¼ˆ404/401 è¢«å°é ï¼‰
      pill(netState,'bad','é JSON å›æ‡‰');
      addMsg(renderNonJson(raw));
      return;
    }

    let j;
    try{ j = JSON.parse(raw); }
    catch(e){
      pill(netState,'bad','JSON è§£æå¤±æ•—');
      addMsg(`<div class="mono">JSON è§£æå¤±æ•—ï¼š${escapeHtml(e.message||String(e))}</div><hr><div class="mono">${escapeHtml(raw.slice(0,1200))}</div>`);
      return;
    }

    pill(netState,'ok','å®Œæˆ');

    // å…è¨±å¤šç¨®å›å‚³æ ¼å¼ï¼š{incorrect,correct,hint,followup} æˆ– {reply,...}
    const incorrect = j.incorrect || j.bad || '';
    const correct   = j.correct   || j.good || '';
    const zhHint    = j.hint || j.zh_hint || '';
    const follow    = j.followup || j.next || j.reply || '';

    addMsg(`
      <div class="banner" style="border-color:rgba(16,185,129,.35);background:rgba(16,185,129,.10);color:#065f46">
        âœ… å·²æ”¶åˆ°ï¼š${escapeHtml($('scene').value)} / ${escapeHtml($('lang').value.toUpperCase())}
      </div>
      ${incorrect ? `<div style="margin-top:10px"><b>âŒ Incorrect:</b><div class="mono">${escapeHtml(incorrect)}</div></div>` : ``}
      ${correct ? `<div style="margin-top:10px"><b>âœ… You should say:</b><div class="mono">${escapeHtml(correct)}</div></div>` : ``}
      ${zhHint ? `<div style="margin-top:10px"><b>ğŸ§  ä¸­æ–‡æç¤º:</b><div>${escapeHtml(zhHint)}</div></div>` : ``}
      ${follow ? `<div style="margin-top:10px"><b>â¡ Follow-up:</b><div class="mono">${escapeHtml(follow)}</div></div>` : ``}
      ${(!incorrect && !correct && !zhHint && !follow) ? `<div class="mono">${escapeHtml(JSON.stringify(j,null,2))}</div>` : ``}
    `);

  }catch(err){
    pill(netState,'bad','ç¶²è·¯éŒ¯èª¤');
    addMsg(`<div class="mono">é€å‡ºå¤±æ•—ï¼š${escapeHtml(err.message||String(err))}</div>`);
  }finally{
    pill(micState, stream ? 'ok':'warn', stream ? 'éº¥å…‹é¢¨å¯ç”¨':'éº¥å…‹é¢¨æœªå°±ç·’');
  }
}

function renderHttpError(status, raw){
  const preview = escapeHtml((raw||'').slice(0,1200));
  return `
    <div class="banner" style="border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.10);color:#7f1d1d">
      â— ç«¯é»å› HTTP ${status}ï¼ˆé€šå¸¸æ˜¯è·¯å¾‘éŒ¯ / éœ€è¦æˆæ¬Š / function 500ï¼‰
    </div>
    <div style="margin-top:10px"><b>å›æ‡‰å‰ 1200 å­—ï¼š</b></div>
    <div class="mono">${preview}</div>
    <hr>
    <small>å¦‚æœä½ çœ‹åˆ° HTMLï¼ˆ<span class="mono">&lt;html&gt;</span> é–‹é ­ï¼‰ï¼Œä»£è¡¨ä¸æ˜¯ function çš„ JSONï¼Œå¸¸è¦‹åŸå› ï¼š<br>
    1) ä½ ç”¨çš„æ˜¯ç›¸å°è·¯å¾‘ï¼›2) function æœªéƒ¨ç½²ï¼›3) è¢«å°åˆ°ç™»å…¥/éŒ¯èª¤é ã€‚</small>
  `;
}

function renderNonJson(raw){
  const preview = escapeHtml((raw||'').slice(0,1200));
  return `
    <div class="banner">
      âš ï¸ ç«¯é»å›ã€Œé JSONã€ï¼ˆå¤šåŠæ˜¯ HTMLï¼‰ã€‚è«‹ç¢ºèªï¼š<span class="mono">${escapeHtml($('endpoint').value.trim())}</span>
    </div>
    <div class="mono">${preview}</div>
  `;
}

async function captureFrameBlob(){
  if(!stream) return null;
  const v = cam;
  // videoWidth æœ‰æ™‚ç‚º 0ï¼ˆå°šæœª readyï¼‰ï¼Œå…ˆç­‰ä¸€ä¸‹
  if(!v.videoWidth){
    await new Promise(r=>setTimeout(r, 250));
  }
  const w = 640, h = 480;
  const canvas = document.createElement('canvas');
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(v, 0, 0, w, h);
  return await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.85));
}

function escapeHtml(s){
  return String(s||'').replace(/[&<>"']/g, (m)=>({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}
</script>
</body>
</html>
