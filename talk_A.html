<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Talk Aï½œBookWide</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1b33;
      --card:#101f3d;
      --ink:#eaf1ff;
      --muted:#9fb3d9;
      --brand:#4f8cff;
      --ok:#19c37d;
      --bad:#ff5a7a;
      --line:rgba(255,255,255,.08);
      --radius:18px;
      --shadow:0 18px 60px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:radial-gradient(1200px 600px at 50% -10%, #1a2f5a 0%, var(--bg) 55%);
      color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .wrap{
      min-height:100%;
      display:flex;
      flex-direction:column;
      padding:16px 14px 18px;
      gap:12px;
      max-width:720px;
      margin:0 auto;
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px; border:1px solid var(--line); border-radius:14px;
      background:rgba(16,31,61,.55); backdrop-filter: blur(10px);
      gap:10px;
      flex-wrap:wrap;
    }
    .brand{display:flex; gap:10px; align-items:center}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--brand);box-shadow:0 0 18px rgba(79,140,255,.9)}
    .title{font-weight:700}
    .meta{font-size:12px;color:var(--muted)}
    .btn{
      appearance:none;border:1px solid var(--line); background:rgba(255,255,255,.06);
      color:var(--ink); border-radius:12px; padding:8px 10px; cursor:pointer;
      font-weight:700;
    }
    .btn:active{transform:translateY(1px)}
    select.btn{padding:8px 10px}
    .rightBtns{display:flex; gap:10px; align-items:center; flex-wrap:wrap}

    .main{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .avatarCard{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(16,31,61,.85), rgba(16,31,61,.45));
      box-shadow:var(--shadow);
      padding:14px 14px 16px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
      position:relative;
      overflow:hidden;
    }
    .badge{
      position:absolute; top:12px; left:12px;
      font-size:12px; color:var(--muted);
      background:rgba(0,0,0,.22);
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
    }
    .avatar{
      width:160px;height:160px;border-radius:50%;
      border:1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(circle at 35% 30%, rgba(255,255,255,.22), rgba(255,255,255,0) 45%),
        radial-gradient(circle at 55% 75%, rgba(79,140,255,.25), rgba(79,140,255,0) 55%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      box-shadow:0 18px 70px rgba(0,0,0,.45);
      display:grid; place-items:center;
      position:relative;
      transform-origin:50% 70%;
    }
    .face{
      width:70%; height:70%;
      border-radius:50%;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.16);
      position:relative;
      overflow:hidden;
    }
    .eyes{
      position:absolute; top:38%;
      width:100%; display:flex; justify-content:center; gap:16%;
    }
    .eye{
      width:16px;height:16px;border-radius:50%;
      background:rgba(234,241,255,.85);
      box-shadow:0 0 10px rgba(234,241,255,.25);
    }
    .mouth{
      position:absolute; top:62%; left:50%;
      width:44px;height:14px;border-radius:0 0 20px 20px;
      border:2px solid rgba(234,241,255,.65);
      border-top:0;
      transform:translateX(-50%);
      opacity:.9;
    }
    .statusLine{
      width:100%;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      font-size:12px;
      color:var(--muted);
    }
    .statusPill{
      padding:6px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:rgba(0,0,0,.18);
      display:flex; align-items:center; gap:8px;
    }
    .pillDot{width:8px;height:8px;border-radius:50%; background:rgba(255,255,255,.25)}
    .pillDot.ok{background:var(--ok); box-shadow:0 0 12px rgba(25,195,125,.7)}
    .pillDot.bad{background:var(--bad); box-shadow:0 0 12px rgba(255,90,122,.7)}
    .pillDot.info{background:var(--brand); box-shadow:0 0 12px rgba(79,140,255,.7)}

    .talkCard{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:rgba(16,31,61,.55);
      box-shadow:var(--shadow);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .sentence{
      font-size:22px; line-height:1.35;
      font-weight:900;
      letter-spacing:.2px;
    }
    .subtitle{
      font-size:14px; color:var(--muted); line-height:1.35;
      min-height:18px;
    }
    .choices{
      display:flex; flex-wrap:wrap; gap:10px;
      margin-top:2px;
    }
    .chip{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--ink);
      border-radius:999px;
      padding:8px 12px;
      font-weight:800;
      font-size:14px;
      cursor:pointer;
      user-select:none;
    }

    .controls{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      margin-top:6px;
      flex-wrap:wrap;
    }
    .micBtn{
      flex:1;
      min-width:180px;
      display:flex; align-items:center; justify-content:center;
      gap:10px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(79,140,255,.32), rgba(79,140,255,.12));
      color:var(--ink);
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .micBtn[disabled]{opacity:.55; cursor:not-allowed}
    .ghost{
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--ink);
      font-weight:800;
      cursor:pointer;
    }
    .small{font-size:12px;color:var(--muted)}
    .log{
      margin-top:4px;
      font-size:12px;
      color:rgba(234,241,255,.75);
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      min-height:40px;
      white-space:pre-wrap;
    }
    .hint{
      color:rgba(234,241,255,.9);
      border-left:3px solid rgba(79,140,255,.9);
      padding-left:10px;
      margin-top:2px;
      font-size:13px;
      line-height:1.35;
    }

    /* Avatar states */
    .state-idle .avatar{animation:idle 2.6s ease-in-out infinite}
    @keyframes idle{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}

    .state-speaking .avatar{animation:speak 0.22s ease-in-out infinite}
    .state-speaking .mouth{animation:mouth 0.18s ease-in-out infinite}
    @keyframes speak{0%,100%{transform:rotate(0deg) translateY(0)}50%{transform:rotate(1.2deg) translateY(-1px)}}
    @keyframes mouth{0%,100%{height:14px; width:44px; opacity:.95}50%{height:22px; width:40px; opacity:1}}

    .state-listening .avatar{animation:listen .9s ease-in-out infinite}
    @keyframes listen{0%,100%{transform:rotate(0deg)}50%{transform:rotate(-1.2deg)}}

    .state-positive .avatar{animation:nod .35s ease-in-out 2}
    @keyframes nod{0%{transform:rotate(0deg)}50%{transform:rotate(6deg) translateY(1px)}100%{transform:rotate(0deg)}}

    .state-encourage .avatar{animation:shake .25s ease-in-out 3}
    @keyframes shake{0%{transform:rotate(0deg)}50%{transform:rotate(-4deg)}100%{transform:rotate(0deg)}}

    @media (max-width:420px){
      .sentence{font-size:20px}
      .avatar{width:150px;height:150px}
    }
  
    /* ===== bottom sheets (assist + report) ===== */
    .sheet{position:fixed; inset:0; display:none; z-index:9999;}
    .sheet[aria-hidden="false"]{display:block;}
    .sheetBack{position:absolute; inset:0; background:rgba(0,0,0,.55); backdrop-filter: blur(2px);}
    .sheetCard{
      position:absolute; left:0; right:0; bottom:0;
      background:rgba(16,24,48,.96);
      border-top:1px solid rgba(255,255,255,.10);
      border-radius:18px 18px 0 0;
      box-shadow:0 -18px 50px rgba(0,0,0,.55);
      max-height:80vh; display:flex; flex-direction:column;
      transform:translateY(0);
    }
    .sheetHead{display:flex; align-items:center; justify-content:space-between; padding:14px 14px 10px;}
    .sheetTitle{font-weight:800; letter-spacing:.2px;}
    .sheetClose{
      width:38px;height:38px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06); color:var(--ink);
      display:grid; place-items:center; font-size:18px;
    }
    .sheetBody{padding:0 14px 14px; overflow:auto;}
    .sheetBody .card{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px; padding:12px; margin:10px 0;
    }
    .kv{display:flex; gap:10px; align-items:baseline;}
    .kv b{font-size:28px;}
    .kv span{color:var(--muted);}
    .stars{display:flex; gap:10px; font-size:34px; padding:8px 0;}
    .stars .on{filter:drop-shadow(0 6px 18px rgba(255,210,80,.35));}
    .sheetFoot{padding:0 14px 14px;}
    .btnPrimary{
      width:100%; height:52px; border-radius:18px; border:0;
      background:linear-gradient(90deg, #3b82f6, #2563eb);
      color:white; font-weight:800; font-size:18px;
      box-shadow:0 16px 40px rgba(37,99,235,.35);
    }

    /* ===== assist row ===== */

    .assistRow{display:flex; gap:10px; padding:10px 0 0;}
    .assistBtn{
      flex:1;
      padding:10px 10px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
      color:var(--ink);
      text-align:left;
    }
    .assistBtn span{display:block; font-weight:900; font-size:14px; letter-spacing:.2px;}
    .assistBtn small{display:block; margin-top:2px; color:var(--muted); font-size:11px;}


/* ===== bottom assist hint line ===== */
    .assistHint{
      position:sticky; bottom:0; margin-top:10px;
      padding:8px 10px; border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      color:rgba(255,255,255,.76);
      font-size:12px; line-height:1.35;
    }
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="title">Talk Aï¼ˆæ‰‹æ©Ÿå£èªªï¼‰</div>
          <div class="meta" id="metaLine">TTSï¼šBrowser SpeechSynthesis</div>
        </div>
      </div>

      <div class="rightBtns">
        <select id="sceneSel" class="btn" title="é¸æ“‡æƒ…å¢ƒ"></select>
        <button class="btn" id="btnReload">é‡æ’­æœ¬å¥</button>
      </div>
    </div>

    <div class="main">
      <div class="avatarCard" id="avatarCard">
        <div class="badge" id="badge">-</div>

        <div class="avatar">
          <div class="face">
            <div class="eyes">
              <div class="eye"></div>
              <div class="eye"></div>
            </div>
            <div class="mouth"></div>
          </div>
        </div>

        <div class="statusLine">
          <div class="statusPill"><span class="pillDot info" id="pillDot"></span><span id="statusText">Ready</span></div>
          <div class="small" id="stepText">step: -</div>
        </div>
      </div>

      <div class="talkCard">
        <div class="sentence" id="sentence">ï¼ˆè¼‰å…¥ä¸­â€¦ï¼‰</div>
        <div class="subtitle" id="subtitle"></div>
        <div class="choices" id="choices"></div>

        <div class="controls">
          <button class="micBtn" id="btnMic">ğŸ™ï¸ é»æˆ‘èªªï¼ˆé–‹å§‹è¾¨è­˜ï¼‰</button>
          <button class="ghost" id="btnNext">è·³é</button>
        </div>

      <div class="assistRow" aria-label="è¼”åŠ©åŠŸèƒ½">
        <button class="assistBtn" data-assist="task"><span>ä»»å‹™</span><small>è¦åšä»€éº¼</small></button>
        <button class="assistBtn" data-assist="example"><span>ç¯„ä¾‹</span><small>ç¤ºç¯„å¥</small></button>
        <button class="assistBtn" data-assist="translate"><span>ç¿»è­¯</span><small>ä¸­/æ—¥</small></button>
        <button class="assistBtn" data-assist="saved"><span>å·²å„²å­˜</span><small>å–®å­—å¥</small></button>
      </div>
      <div class="assistHint">ä¸»é ä¿æŒåœ¨å°è©±ä¸­ï¼›é»ã€Œä»»å‹™ï¼ç¯„ä¾‹ï¼ç¿»è­¯ï¼å·²å„²å­˜ã€åªæœƒæ‰“é–‹è¼”åŠ©å°çª—ï¼Œä¸æœƒä¸­æ–·å°è©±ã€‚</div>

        <div class="hint" id="hint" style="display:none"></div>
        <div class="log" id="log"></div>
      </div>
    
    <!-- Assist Panel (keeps main dialog running) -->
    <div class="sheet" id="sheet" aria-hidden="true">
      <div class="sheetBack" id="sheetBack"></div>
      <div class="sheetCard" role="dialog" aria-modal="true">
        <div class="sheetHead">
          <div class="sheetTitle" id="sheetTitle">-</div>
          <button class="sheetClose" id="sheetClose">âœ•</button>
        </div>
        <div class="sheetBody" id="sheetBody"></div>
      </div>
    </div>

    <!-- Report Sheet -->
    <div class="sheet" id="report" aria-hidden="true">
      <div class="sheetBack" id="reportBack"></div>
      <div class="sheetCard" role="dialog" aria-modal="true">
        <div class="sheetHead">
          <div class="sheetTitle">å­¸ç¿’å ±å‘Š</div>
          <button class="sheetClose" id="reportClose">âœ•</button>
        </div>
        <div class="sheetBody" id="reportBody"></div>
        <div class="sheetFoot">
          <button class="btnPrimary" id="reportContinue">ç¹¼çºŒ</button>
        </div>
      </div>
    </div>

</div>
  </div>

<script>
/* Talk A (GitHub Pages mode): loads ./talk/index.json and ./talk/<scene>.json */
const $ = (id)=>document.getElementById(id);
const UI = {
  card: $('avatarCard'),
  pillDot: $('pillDot'),
  statusText: $('statusText'),
  stepText: $('stepText'),
  sentence: $('sentence'),
  subtitle: $('subtitle'),
  choices: $('choices'),
  hint: $('hint'),
  log: $('log'),
  btnMic: $('btnMic'),
  btnNext: $('btnNext'),
  btnReload: $('btnReload'),
  metaLine: $('metaLine'),
  sceneSel: $('sceneSel'),
  badge: $('badge')
};

const BASE = './talk';

function setAvatarState(state){
  UI.card.classList.remove('state-idle','state-speaking','state-listening','state-positive','state-encourage');
  UI.card.classList.add('state-'+state);
  const dot = UI.pillDot;
  dot.classList.remove('ok','bad','info');
  if(state==='positive') dot.classList.add('ok');
  else if(state==='encourage') dot.classList.add('bad');
  else dot.classList.add('info');
}
function setStatus(text){ UI.statusText.textContent = text; }
function logLine(s){
  UI.log.textContent = (UI.log.textContent ? UI.log.textContent + "\\n" : "") + s;
  UI.log.scrollTop = UI.log.scrollHeight;
}
function norm(s){
  return (s||"").toLowerCase().replace(/[^\\w\\s']/g,' ').replace(/\\s+/g,' ').trim();
}

/* ===== TTS ===== */
function pickVoice(){
  const voices = speechSynthesis.getVoices() || [];
  let v = voices.find(x => /en-US/i.test(x.lang));
  if(!v) v = voices.find(x => /^en/i.test(x.lang));
  return v || null;
}
function speak(text){
  return new Promise((resolve)=>{
    try{
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      const v = pickVoice();
      if(v) u.voice = v;
      u.lang = (v && v.lang) ? v.lang : 'en-US';
      u.rate = 1.0;
      u.pitch = 1.0;
      u.onstart = ()=>{ isSpeaking = true; setAvatarState('speaking'); setStatus('Speaking'); };
      u.onend   = ()=>{ isSpeaking = false; resolve(); };
      u.onerror = ()=>{ isSpeaking = false; resolve(); };
      speechSynthesis.speak(u);
    }catch(e){ resolve(); }
  });
}

/* ===== Speech Recognition ===== */
let recognition = null;
let isSpeaking = false;
let failCount = {};
let stepsById = {};
let currentId = "";
let SCRIPT = null;

function setupRecognition(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){
    UI.metaLine.textContent = "TTSï¼šSpeechSynthesisï¼ˆâš ï¸æ­¤ç€è¦½å™¨ç„¡èªéŸ³è¾¨è­˜ï¼‰";
    UI.btnMic.disabled = true;
    logLine("âš ï¸ æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Web Speech APIï¼ˆèªéŸ³è¾¨è­˜ï¼‰ã€‚å»ºè­°ç”¨ Chrome/Edgeã€‚");
    return;
  }
  recognition = new SR();
  recognition.lang = 'en-US';
  recognition.interimResults = true;
  recognition.continuous = false;

  recognition.onstart = ()=>{
    setAvatarState('listening');
    setStatus('Listening');
    UI.btnMic.textContent = "ğŸŸ¢ æ­£åœ¨è½â€¦";
  };
  recognition.onend = ()=>{
    UI.btnMic.textContent = "ğŸ™ï¸ é»æˆ‘èªªï¼ˆé–‹å§‹è¾¨è­˜ï¼‰";
  };
  recognition.onerror = (e)=>{
    logLine("SR error: " + (e.error || "unknown"));
  };
  recognition.onresult = (e)=>{
    let finalText = "";
    let interim = "";
    for(let i=e.resultIndex; i<e.results.length; i++){
      const t = e.results[i][0].transcript.trim();
      if(e.results[i].isFinal) finalText += (finalText?" ":"") + t;
      else interim += (interim?" ":"") + t;
    }
    if(interim) UI.subtitle.textContent = "ä½ èªªï¼š " + interim;
    if(finalText){
      UI.subtitle.textContent = "ä½ èªªï¼š " + finalText;
      logLine("You said: " + finalText);
      STATS.utter.push(finalText);
      finalText.split(/\s+/).forEach(w=>{w=w.trim().toLowerCase(); if(w) STATS.words.add(w);});
      handleUserText(finalText);
    }
  };
}

function matchChoice(userText, expect){
  const t = norm(userText);
  const opts = (expect.options||[]);
  const aliases = expect.aliases || {};
  for(const opt of opts){
    const list = [opt, ...(aliases[opt]||[])].map(norm).filter(Boolean);
    for(const a of list){
      if(!a) continue;
      if(t.includes(a)) return opt;
    }
  }
  return null;
}

function renderStep(step){
  UI.stepText.textContent = "step: " + step.id;
  UI.sentence.textContent = step.text || "";
  UI.subtitle.textContent = step.zh ? step.zh : "";
  UI.hint.style.display = "none";
  UI.hint.textContent = "";
  UI.choices.innerHTML = "";

  if(step.expect && step.expect.mode === "choice"){
    for(const opt of step.expect.options){
      const chip = document.createElement('div');
      chip.className = 'chip';
      chip.textContent = opt;
      chip.onclick = ()=>{ logLine("Tapped: " + opt); handleUserText(opt); };
      UI.choices.appendChild(chip);
    }
  }
}

function goto(id){
  currentId = id;
  const step = stepsById[currentId];
  if(!step){ logLine("âŒ step not found: " + id); return; }
  runStep(step);
}

async function runStep(step){
  setAvatarState('idle');
  setStatus('Ready');
  renderStep(step);

  if(step.type === "ai_hint"){
    UI.hint.style.display = "block";
    UI.hint.textContent = step.text || "";
    await speak(step.text || "");
    setAvatarState('idle'); setStatus('Ready');
    if(step.repeat) goto(step.repeat);
    return;
  }

  if(step.type === "ai_say"){
    await speak(step.text || "");
    setAvatarState('listening');
    setStatus('Listening');
    return;
  }
}

function bumpFail(key){
  failCount[key] = (failCount[key]||0) + 1;
  return failCount[key];
}

async function handleSuccess(step, matched){
  setAvatarState('positive');
  setStatus('Good!');
  if(matched) STATS.ok++;
  UI.subtitle.textContent = `âœ… OKï¼š${matched}`;
  await new Promise(r=>setTimeout(r, 520));

  if(step.end){
    setAvatarState('idle');
    setStatus('Done');
    UI.subtitle.textContent = "âœ… å®Œæˆï¼";
    STATS.ok++;
    STATS.endedAt = Date.now();
    showReport();
    return;
  }
  if(step.on_success) goto(step.on_success);
}

async function handleFail(step){
  setAvatarState('encourage');
  setStatus('Try again');
  await new Promise(r=>setTimeout(r, 380));

  const n = bumpFail(step.id);
  if(n === 1 && step.on_fail){ goto(step.on_fail); return; }

  UI.subtitle.textContent = "æ²’é—œä¿‚ï¼Œç›´æ¥ä¸‹ä¸€å¥ã€‚";
  await speak("That's okay. Let's move on.");
  if(step.on_success) goto(step.on_success);
}

function handleUserText(text){
  STATS.tries++;
  const step = stepsById[currentId];
  if(!step || !step.expect) return;
  if(isSpeaking) return;

  const mode = step.expect.mode;
  if(mode === "none"){ handleSuccess(step); return; }

  if(mode === "choice"){
    const matched = matchChoice(text, step.expect);
    if(matched) handleSuccess(step, matched);
    else handleFail(step);
    return;
  }

  if(mode === "free"){
    const kws = (step.expect.keywords||[]).map(norm).filter(Boolean);
    const t = norm(text);
    const hit = kws.some(k=>t.includes(k));
    if(hit) handleSuccess(step);
    else handleFail(step);
  }
}

/* ===== GitHub Pages loader ===== */
async function fetchJson(url){
  const r = await fetch(url, { cache: "no-store" });
  if(!r.ok) throw new Error("HTTP " + r.status + " " + url);
  return r.json();
}


async function fetchSceneJson(sceneKey){
  const tries = [];
  const push = (k)=>{ if(k && !tries.includes(k)) tries.push(k); };
  push(sceneKey);
  // common aliases
  if(sceneKey){
    push(sceneKey.replace(/_checkin$/,''));
    push(sceneKey.split('_')[0]);
  }
  for(const k of tries){
    try{
      return await fetchJson(`${BASE}/${k}.json`);
    }catch(e){
      // continue
    }
  }
  throw new Error("Fetch failed: 404 /talk/" + (sceneKey||"") + ".json");
}

async function buildSceneSelector(){
  const idxRaw = await fetchJson(`${BASE}/index.json`);
  // Accept multiple index formats:
  // 1) {items:[{id,title_zh,title_en,level,role,avatar,...}], default?:id}
  // 2) {scenes:[...], default?:key}  (older)
  // 3) [...] (array)
  const scenes = Array.isArray(idxRaw) ? idxRaw : (idxRaw.items || idxRaw.scenes || []);
  UI.sceneSel.innerHTML = "";

  const getLabel = (s)=>{
    const zh = s.title_zh || s.titleZh || s.title || s.name_zh || "";
    const en = s.title_en || s.titleEn || s.titleEN || s.name_en || "";
    const lvl = s.level ? ` (${s.level})` : "";
    if(zh && en) return `${zh}ï½œ${en}${lvl}`;
    return `${zh || en || (s.id||s.key||"Scene")}${lvl}`;
  };

  scenes.forEach(s=>{
    const key = s.id || s.key || s.scene || s.slug || "";
    if(!key) return;
    const opt = document.createElement("option");
    opt.value = key;
    opt.textContent = getLabel(s);
    UI.sceneSel.appendChild(opt);
  });

  // default scene key
  let defaultKey = "";
  if(typeof idxRaw === "object" && idxRaw){
    defaultKey = idxRaw.default || idxRaw.default_id || idxRaw.defaultId || "";
  }
  if(!defaultKey){
    defaultKey = (scenes[0] && (scenes[0].id || scenes[0].key || scenes[0].scene)) || "";
  }
  UI.sceneSel.value = defaultKey;

  // Load default scene (if any)
  if(defaultKey){
    await loadScene(defaultKey, {silent:true});
  }else{
    toast("æ‰¾ä¸åˆ°å¯ç”¨çš„æƒ…å¢ƒï¼ˆindex.json æ²’æœ‰ items/scenesï¼‰");
  }

  UI.sceneSel.addEventListener("change", ()=> loadScene(UI.sceneSel.value));
}

async function loadScene(sceneKey){
  if(!sceneKey){ sceneKey = (INDEX && INDEX.items && INDEX.items[0] && INDEX.items[0].id) ? INDEX.items[0].id : 'coffee_shop'; }
  try{
    SCRIPT = await fetchSceneJson(sceneKey);
    stepsById = Object.fromEntries((SCRIPT.steps||[]).map(s=>[s.id,s]));
    failCount = {};
    currentId = (SCRIPT.steps && SCRIPT.steps[0] && SCRIPT.steps[0].id) ? SCRIPT.steps[0].id : "";

    UI.badge.textContent = `${SCRIPT.persona?.name || "AI"} Â· ${SCRIPT.persona?.role || "teacher"}`;
    logLine(`\\n=== Scene: ${SCRIPT.scene} (${SCRIPT.level}) ===`);

    if(!currentId){ logLine("âŒ empty steps"); return; }
    goto(currentId);
  }catch(e){
    logLine("âŒ loadScene failed: " + (e && e.message ? e.message : e));
  }
}

/* ===== UI events ===== */
UI.btnMic.onclick = ()=>{
  if(!recognition) return;
  if(isSpeaking) speechSynthesis.cancel();
  try{ recognition.stop(); recognition.start(); }catch(e){}
};
UI.btnNext.onclick = ()=>{
  const step = stepsById[currentId];
  if(step && step.on_success) goto(step.on_success);
};
UI.btnReload.onclick = ()=>{
  const step = stepsById[currentId];
  if(step && step.text) speak(step.text);
};


/* ===== Assist + Report (no page navigation) ===== */
const Sheet = {
  el: document.getElementById('sheet'),
  back: document.getElementById('sheetBack'),
  title: document.getElementById('sheetTitle'),
  body: document.getElementById('sheetBody'),
  close: document.getElementById('sheetClose'),
};
const Report = {
  el: document.getElementById('report'),
  back: document.getElementById('reportBack'),
  body: document.getElementById('reportBody'),
  close: document.getElementById('reportClose'),
  cont: document.getElementById('reportContinue'),
};

function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
}
function openSheet(kind){
  if(!Sheet.el) return;
  Sheet.el.setAttribute('aria-hidden','false');
  const meta = (INDEX && INDEX.items ? INDEX.items.find(x=>x.id===sceneId) : null) || {};
  const title = ({task:'ä»»å‹™', example:'ç¯„ä¾‹', translate:'ç¿»è­¯', saved:'å·²å„²å­˜'})[kind] || 'è¼”åŠ©';
  Sheet.title.textContent = `${title}ï½œ${meta.title_zh || meta.title_en || sceneId || ''}`;
  Sheet.body.innerHTML = renderAssist(kind);
}
function closeSheet(){ Sheet.el && Sheet.el.setAttribute('aria-hidden','true'); }
function closeReport(){ Report.el && Report.el.setAttribute('aria-hidden','true'); }

function renderAssist(kind){
  const sc = SCRIPT || {};
  const support = sc.support || sc.assist || {};
  const tasks = support.task || support.tasks || sc.task || sc.tasks || [];
  const examples = support.example || support.examples || sc.examples || [];
  const trans = support.translate || support.translations || sc.translate || sc.translations || null;
  const vocab = support.vocab || support.words || sc.vocab || sc.words || [];
  const saved = window.__SAVED__ || {words:[], lines:[]};

  const toList = (arr)=> (Array.isArray(arr) && arr.length)
    ? `<div class="card">${arr.map(x=>`<div style="margin:6px 0">${escapeHtml(String(x))}</div>`).join('')}</div>`
    : `<div class="card" style="color:rgba(255,255,255,.7)">ï¼ˆæ­¤æƒ…å¢ƒå°šæœªæä¾›å…§å®¹ï¼Œä½ å¯ä»¥æŠŠ JSON åŠ ä¸Š support æ¬„ä½ï¼štasks/examples/translations/vocabï¼‰</div>`;

  if(kind==='task'){
    return toList(tasks.length?tasks:[
      "ç›®æ¨™ï¼šå®Œæˆ 10â€“15 å¥æƒ…å¢ƒå°è©±",
      "åšæ³•ï¼šè·Ÿè‘—å”¸ï¼æ”¹å¯«ï¼åŠ ç´°ç¯€ï¼ˆæ™‚é–“ã€äººæ•¸ã€å–œå¥½ï¼‰",
      "å»ºè­°ï¼šæ¯å¥èªªæ¸…æ¥šã€é€Ÿåº¦æ…¢ä¸€é»ã€é‡è¤‡ 2 æ¬¡"
    ]);
  }
  if(kind==='example'){
    return toList(examples.length?examples:(sc.steps?sc.steps.map(s=>s.text).filter(Boolean).slice(0,8):[]));
  }
  if(kind==='translate'){
    // show current teacher sentence translation if provided
    const step = stepsById[currentId] || {};
    const en = step.text || "";
    let zh = (step.zh || (trans && trans[currentId] && trans[currentId].zh) || (trans && trans.zh && trans.zh[currentId]) || "");
    let ja = (step.ja || (trans && trans[currentId] && trans[currentId].ja) || (trans && trans.ja && trans.ja[currentId]) || "");
    if(!zh && step.text){ zh = "ï¼ˆå¯åœ¨ JSON è£œä¸Š step.zhï¼‰"; }
    if(!ja && step.text){ ja = "ï¼ˆå¯åœ¨ JSON è£œä¸Š step.jaï¼‰"; }
    return `
      <div class="card">
        <div style="opacity:.8;margin-bottom:6px">ç›®å‰è€å¸«å¥ï¼š</div>
        <div style="font-size:18px;font-weight:800;line-height:1.35">${escapeHtml(en)}</div>
      </div>
      <div class="card">
        <div style="opacity:.8;margin-bottom:6px">ä¸­æ–‡ï¼š</div>
        <div>${escapeHtml(zh || "â€”")}</div>
      </div>
      <div class="card">
        <div style="opacity:.8;margin-bottom:6px">æ—¥æ–‡ï¼š</div>
        <div>${escapeHtml(ja || "â€”")}</div>
      </div>
      <div class="card" style="color:rgba(255,255,255,.7)">
        å°æŠ€å·§ï¼šä½ å¯ä»¥å…ˆã€Œä¸­æ–‡æƒ³å¥½ â†’ ç”¨è‹±æ–‡èªªã€ï¼›ä¸ç¢ºå®šå°±é»ã€Œç¯„ä¾‹ã€æ‹¿ä¸€å€‹å¥å‹å†æ”¹ã€‚
      </div>
    `;
  }
  if(kind==='saved'){
    const wordCards = saved.words.length ? saved.words.map(w=>`<div style="margin:6px 0">â€¢ ${escapeHtml(w)}</div>`).join('') : '<div style="opacity:.7">ï¼ˆå°šæœªå„²å­˜ï¼‰</div>';
    const lineCards = saved.lines.length ? saved.lines.map(w=>`<div style="margin:6px 0">â€¢ ${escapeHtml(w)}</div>`).join('') : '<div style="opacity:.7">ï¼ˆå°šæœªå„²å­˜ï¼‰</div>';
    return `
      <div class="card">
        <div style="font-weight:900;margin-bottom:6px">å–®å­—</div>
        ${wordCards}
      </div>
      <div class="card">
        <div style="font-weight:900;margin-bottom:6px">å¥å­</div>
        ${lineCards}
      </div>
      <div class="card">
        <button class="ghost" style="width:100%" onclick="window.__SAVED__={words:[],lines:[]}; openSheet('saved');">æ¸…ç©º</button>
      </div>
    `;
  }
  return toList([]);
}

function showReport(){
  if(!Report.el) return;
  const total = SCRIPT && SCRIPT.steps ? SCRIPT.steps.filter(s=>!s.end).length : 0;
  const done = Math.max(0, STATS.ok-1); // end step counted once
  const completeness = total ? Math.round((done/total)*100) : 0;
  const pronunciation = Math.min(100, Math.round((done/Math.max(1, STATS.tries))*120)); // heuristic
  const relevance = Math.min(100, Math.round(completeness*0.9 + 10));
  const wordsUsed = STATS.words.size;

  const stars = (score)=>{
    const s = Math.max(1, Math.min(3, Math.round(score/40)));
    return `<div class="stars">${[1,2,3].map(i=>`<span class="${i<=s?'on':''}">${i<=s?'â­ï¸':'â˜†'}</span>`).join('')}</div>`;
  };

  Report.body.innerHTML = `
    <div class="card">
      <div style="font-size:26px;font-weight:900;margin-bottom:2px">å¾ˆæ£’ï¼</div>
      <div style="opacity:.75">${escapeHtml((((INDEX&&INDEX.items)||[]).find(x=>x.id===sceneId)||{}).title_zh||'')}</div>
      ${stars(completeness)}
    </div>

    <div class="card">
      <div class="kv"><b>${relevance}%</b><span>ä¸»é¡Œç›¸é—œåº¦ï¼ˆä¼°ç®—ï¼‰</span></div>
      <div class="kv"><b>${pronunciation}%</b><span>ç™¼éŸ³ï¼ˆä¼°ç®—ï¼‰</span></div>
      <div class="kv"><b>${wordsUsed}</b><span>ä½¿ç”¨çš„å–®å­—æ•¸</span></div>
      <div class="kv"><b>${completeness}%</b><span>å®Œæ•´æ€§</span></div>
    </div>

    <div class="card">
      <div style="font-weight:900;margin-bottom:6px">è©•è«– / å»ºè­°</div>
      <div style="opacity:.85;line-height:1.45">
        ${completeness>=80 ? "ä½ æŠŠæ•´æ®µå°è©±èµ°å®Œäº†ï¼Œå¾ˆæ£’ï¼" : "ä½ å·²å®Œæˆä¸€éƒ¨åˆ†å°è©±ï¼Œå»ºè­°å†æŠŠå¾ŒåŠæ®µè£œé½Šã€‚"}
        ${pronunciation>=60 ? " ç™¼éŸ³å¤§è‡´æ¸…æ¥šï¼›å¯ä»¥å†æŠŠé‡éŸ³æ”¾åœ¨é—œéµå­—ä¸Šã€‚" : " å»ºè­°æ”¾æ…¢é€Ÿåº¦ã€æ¯å¥é‡è¤‡ 2 æ¬¡ï¼Œå…ˆæ±‚æ¸…æ¥šå†æ±‚å¿«ã€‚"}
        å¦å¤–ï¼šè©¦è‘—ç”¨ä¸€å€‹ã€ŒåŠ ç´°ç¯€ã€å¥å‹ï¼ˆä¾‹å¦‚æ™‚é–“ / æ•¸é‡ / åå¥½ï¼‰è®“å›ç­”æ›´è‡ªç„¶ã€‚
      </div>
      <div style="margin-top:10px;opacity:.75">ä½ ä¹Ÿå¯ä»¥é»ã€Œå·²å„²å­˜ã€æŠŠå‰›å‰›ä¸ç†Ÿçš„å–®å­—æ•´ç†èµ·ä¾†ã€‚</div>
    </div>
  `;
  Report.el.setAttribute('aria-hidden','false');
}

function wireAssistButtons(){
  document.querySelectorAll('.assistBtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      openSheet(btn.dataset.assist);
    });
  });
  if(Sheet.back) Sheet.back.onclick = closeSheet;
  if(Sheet.close) Sheet.close.onclick = closeSheet;

  if(Report.back) Report.back.onclick = closeReport;
  if(Report.close) Report.close.onclick = closeReport;
  if(Report.cont) Report.cont.onclick = closeReport;
}


/* ===== Boot ===== */
(function init(){
  speechSynthesis.onvoiceschanged = ()=>{};
  setupRecognition();
  setAvatarState('idle');
  setStatus('Ready');
  logLine("âœ… Talk A loaded. (GitHub Pages mode)");
  buildSceneSelector();
  wireAssistButtons();
})();
</script>
</body>
</html>
