<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BookWide Talkï½œå½±åƒå£èªª MVP</title>
<style>
  :root{
    --bg:#f4f6fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
    --brand:#2563eb; --brand2:#1d4ed8; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    --radius:18px; --shadow:0 10px 30px rgba(15,23,42,.10);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;}
  .topbar{
    height:64px; display:flex; align-items:center; justify-content:space-between;
    padding:0 18px; background:linear-gradient(90deg,#0b1220,#111827);
    color:#fff; position:sticky; top:0; z-index:50;
  }
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:22px}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.14);font-size:13px}
  .wrap{max-width:1200px;margin:18px auto;padding:0 14px}
  .grid{display:grid;grid-template-columns: 1fr 1.25fr;gap:16px}
  @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
  .card{
    background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
    box-shadow:var(--shadow); overflow:hidden;
  }
  .card-hd{padding:14px 16px;border-bottom:1px solid var(--line)}
  .card-hd h2{margin:0;font-size:18px}
  .card-hd .sub{margin-top:4px;color:var(--muted);font-size:13px}
  .card-bd{padding:14px 16px}
  label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px}
  select, textarea, input{
    width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:12px;
    outline:none; font-size:14px; background:#fff;
  }
  textarea{min-height:64px; resize:vertical}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:520px){ .row{grid-template-columns:1fr} }
  .statusbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .tag{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;color:var(--muted)}
  .tag.ok{border-color:#bbf7d0;background:#ecfdf5;color:#065f46}
  .tag.bad{border-color:#fecaca;background:#fef2f2;color:#7f1d1d}
  .tag.warn{border-color:#fde68a;background:#fffbeb;color:#7c2d12}
  .cam{
    margin-top:12px; border-radius:16px; overflow:hidden; background:#000;
    border:1px solid var(--line);
    position:relative;
  }
  video{width:100%; height:360px; object-fit:cover; display:block; background:#000}
  @media (max-width:980px){ video{height:320px} }
  .cam-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  button{
    border:1px solid var(--line); background:#fff; color:var(--ink);
    border-radius:14px; padding:10px 14px; font-size:14px; cursor:pointer;
  }
  button.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  button.primary:hover{background:var(--brand2)}
  button.danger{background:#fff;border-color:#fecaca;color:#991b1b}
  button:disabled{opacity:.5;cursor:not-allowed}
  .ptt{
    display:flex;gap:12px;align-items:center;border:1px dashed var(--line);
    padding:12px;border-radius:16px;background:#f8fafc;margin-top:12px
  }
  .ptt .big{
    width:110px; min-width:110px; height:64px; border-radius:16px;
    background:var(--brand); color:#fff; border:0; font-weight:800;
  }
  .ptt .big.rec{background:#ef4444}
  .ptt .help{color:var(--muted);font-size:13px;line-height:1.45}
  .feed{
    height:520px; overflow:auto; padding:14px 16px; background:#fff;
  }
  @media (max-width:980px){ .feed{height:420px} }
  .msg{margin:0 0 12px 0}
  .bubble{
    border:1px solid var(--line); border-radius:16px; padding:12px 14px; background:#fff;
  }
  .bubble.ai{background:#f8fafc}
  .meta{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  .who{font-weight:800;font-size:13px}
  .time{color:var(--muted);font-size:12px}
  .hl{
    display:inline-flex;align-items:center;gap:8px;
    padding:10px 12px;border-radius:14px;border:1px solid #fde68a;
    background:#fffbeb;color:#7c2d12;margin:8px 0 0 0;font-weight:700
  }
  .good{border-color:#bbf7d0;background:#ecfdf5;color:#065f46}
  .bad{border-color:#fecaca;background:#fef2f2;color:#7f1d1d}
  .line2{color:var(--muted);font-size:13px;margin-top:6px;line-height:1.5}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div>BookWide</div>
      <span class="pill">Talkï½œå½±åƒå£èªª MVP</span>
    </div>
    <div class="pill">å…ˆèƒ½ç©ï¼šä¸æ¥ Supabaseã€ä¸ç™»å…¥ã€ä¸æœƒ 401</div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- å·¦ï¼šè¨­å®š + ç›¸æ©Ÿ + èªéŸ³ -->
      <div class="card">
        <div class="card-hd">
          <h2>å£èªªç·´ç¿’è¨­å®š</h2>
          <div class="sub">æŒ‰ä½èªªè©±ï¼ˆèªéŸ³è¾¨è­˜ï¼‰â†’ ç«‹å³ç³¾éŒ¯ / æ­£ç¢ºå¥ / è·Ÿè®€ï¼ˆTTSï¼‰</div>
        </div>
        <div class="card-bd">
          <div class="row">
            <div>
              <label>æƒ…å¢ƒ</label>
              <select id="scene">
                <option value="nails">å¡—æŒ‡ç”² nails</option>
                <option value="makeup">åŒ–å¦ makeup</option>
                <option value="cooking" selected>åšèœ cooking</option>
                <option value="coffee">å–å’–å•¡ coffee</option>
                <option value="shopping">è³¼ç‰© shopping</option>
                <option value="gym">å¥èº« gym</option>
                <option value="commute">é€šå‹¤ commute</option>
                <option value="cleaning">æ‰“æƒ cleaning</option>
              </select>
            </div>
            <div>
              <label>èªè¨€ï¼ˆç¤ºç¯„å…ˆåšè‹±æ–‡ï¼‰</label>
              <select id="lang">
                <option value="en-US" selected>è‹±æ–‡ï¼ˆENï¼‰</option>
              </select>
            </div>
          </div>

          <label>æç¤ºï¼ˆå¯é¸ï¼‰</label>
          <textarea id="hint" placeholder="ä¾‹å¦‚ï¼šç”¨ç°¡å–®å¥ã€æ…¢æ…¢èªªã€‚å…ˆèªª 1 å¥å°±å¥½ã€‚"></textarea>

          <div class="statusbar">
            <span class="tag" id="camTag">ç›¸æ©Ÿï¼šæœªé–‹</span>
            <span class="tag" id="micTag">éº¥å…‹é¢¨ï¼šæœªç”¨</span>
            <span class="tag warn" id="sttTag">è¾¨è­˜ï¼šå¾…å‘½</span>
          </div>

          <div class="cam">
            <video id="video" autoplay playsinline muted></video>
          </div>

          <div class="cam-actions">
            <button id="btnCam" class="">é–‹å•Ÿç›¸æ©Ÿ</button>
            <button id="btnSnap">æ‹ä¸€å¼µï¼ˆåªé¡¯ç¤ºï¼Œä¸é€å‡ºï¼‰</button>
            <button id="btnClear" class="danger">æ¸…ç©ºå°è©±</button>
          </div>

          <div class="ptt">
            <button id="btnPTT" class="big" disabled>æŒ‰ä½èªªè©±</button>
            <div class="help">
              Chrome / Edge æ”¯æ´èªéŸ³è¾¨è­˜ã€‚<br/>
              <span class="small">è‹¥ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´ï¼Œè«‹æ”¹ç”¨æ‰‹å‹•è¼¸å…¥ï¼ˆå³å´åº•éƒ¨ï¼‰ã€‚</span>
            </div>
          </div>

          <div class="actions">
            <input id="manual" placeholder="æ‰‹å‹•è¼¸å…¥ä¸€å¥è‹±æ–‡ï¼ˆä¾‹å¦‚ï¼šI am doing my nails.ï¼‰" />
            <button id="btnSend" class="primary">é€å‡º</button>
          </div>

          <div class="small" style="margin-top:10px;">
            æ³¨æ„ï¼šé€™ç‰ˆæ˜¯ã€Œå…ˆèƒ½ç©ã€MVPã€‚AI å›è¦†ç‚ºæœ¬æ©Ÿè¦å‰‡æ¨¡æ“¬ï¼ˆä¸èµ°å¾Œç«¯ã€ä¸æœƒ 401ï¼‰ã€‚
          </div>
        </div>
      </div>

      <!-- å³ï¼šå°è©± + ç³¾éŒ¯ -->
      <div class="card">
        <div class="card-hd">
          <h2>AI å³æ™‚ç³¾éŒ¯</h2>
          <div class="sub">åƒ TalkMeï¼šçœ‹ä½ åœ¨åšä»€éº¼ï¼ˆç”¨æƒ…å¢ƒï¼‰+ ä½ èªªä¸€å¥ â†’ ç«‹å³æç¤ºæ­£ç¢ºèªªæ³•</div>
        </div>
        <div class="feed" id="feed"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const feed = $("feed");

  const camTag = $("camTag");
  const micTag = $("micTag");
  const sttTag = $("sttTag");
  const btnCam = $("btnCam");
  const btnSnap = $("btnSnap");
  const btnClear = $("btnClear");
  const btnPTT = $("btnPTT");
  const btnSend = $("btnSend");
  const manual = $("manual");
  const sceneSel = $("scene");
  const hint = $("hint");
  const video = $("video");

  let stream = null;
  let recognizing = false;
  let recognition = null;
  let lastSnapshotDataUrl = null;

  function nowTime(){
    const d = new Date();
    return d.toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  }

  function addMsg(who, text, opts={}){
    const wrap = document.createElement("div");
    wrap.className = "msg";
    const bubble = document.createElement("div");
    bubble.className = "bubble" + (who==="AI" ? " ai" : "");
    const meta = document.createElement("div");
    meta.className = "meta";
    meta.innerHTML = `<div class="who">${who==="AI"?"AI":"ä½ èªª"}</div><div class="time">${nowTime()}</div>`;
    bubble.appendChild(meta);

    const p = document.createElement("div");
    p.textContent = text;
    bubble.appendChild(p);

    if(opts.badge){
      const b = document.createElement("div");
      b.className = "hl " + (opts.badgeType||"");
      b.textContent = opts.badge;
      bubble.appendChild(b);
    }
    if(opts.sub){
      const s = document.createElement("div");
      s.className = "line2";
      s.textContent = opts.sub;
      bubble.appendChild(s);
    }
    if(opts.actions){
      const a = document.createElement("div");
      a.className = "actions";
      opts.actions.forEach(btn => a.appendChild(btn));
      bubble.appendChild(a);
    }

    wrap.appendChild(bubble);
    feed.appendChild(wrap);
    feed.scrollTop = feed.scrollHeight;
  }

  function ttsSpeak(text){
    try{
      if(!window.speechSynthesis) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = $("lang").value || "en-US";
      u.rate = 0.95;
      window.speechSynthesis.speak(u);
    }catch(e){}
  }

  function normalize(s){
    return (s||"").trim().replace(/\s+/g," ");
  }

  // ====== MVPï¼šæœ¬æ©Ÿã€Œè¦å‰‡å¼æ•™ç·´ã€ ======
  const SCENES = {
    nails: {
      coachOpen: "Wow, wow. Whatâ€™s up? Are you doing your nails?",
      target: "I'm doing my nails.",
      tips: ["Use present continuous: I'm + -ing", "Say it slowly: I'm / doing / my / nails."],
      patterns: [
        { re: /\b(do|doing)\b.*\bnail/i, ok: true },
        { re: /\bpaint\b.*\bnail/i, ok: true, alt: "I'm painting my nails." },
        { re: /\bmake\b.*\bnail/i, ok: false, fix: "I'm doing my nails." }
      ]
    },
    makeup: {
      coachOpen: "Hey! Are you doing your makeup?",
      target: "I'm putting on makeup.",
      tips: ["Say: I'm putting on makeup.", "Or: I'm doing my makeup."],
      patterns: [
        { re: /\bmakeup\b/i, ok: true },
        { re: /\bmake\s*up\b/i, ok: false, fix: "I'm putting on makeup." }
      ]
    },
    cooking: {
      coachOpen: "It smells good! Are you cooking?",
      target: "I'm cooking dinner.",
      tips: ["Add object: I'm cooking dinner.", "Or: I'm making a meal."],
      patterns: [
        { re: /\bcook(ing)?\b/i, ok: true },
        { re: /\bmake\b.*\bfood\b/i, ok: true, alt: "I'm making food." }
      ]
    },
    coffee: {
      coachOpen: "Nice! Are you getting coffee?",
      target: "I'm having a coffee.",
      tips: ["Say: I'm having a coffee.", "Or: I'm grabbing a coffee."],
      patterns: [
        { re: /\bcoffee\b/i, ok: true }
      ]
    },
    shopping: {
      coachOpen: "Oh, shopping time? What are you looking for?",
      target: "I'm shopping for clothes.",
      tips: ["Say: I'm shopping for ___."],
      patterns: [
        { re: /\bshop(ping)?\b/i, ok: true }
      ]
    },
    gym: {
      coachOpen: "Workout mode! Are you at the gym?",
      target: "I'm working out.",
      tips: ["Say: I'm working out.", "Or: I'm at the gym."],
      patterns: [
        { re: /\bgym\b/i, ok: true },
        { re: /\bwork\s*out\b/i, ok: true }
      ]
    },
    commute: {
      coachOpen: "On the way somewhere? Are you commuting?",
      target: "I'm on my way to work.",
      tips: ["Say: I'm on my way to work.", "Or: I'm commuting."],
      patterns: [
        { re: /\bcommut(e|ing)\b/i, ok: true },
        { re: /\bon my way\b/i, ok: true }
      ]
    },
    cleaning: {
      coachOpen: "Cleaning day? What are you cleaning?",
      target: "I'm cleaning my room.",
      tips: ["Say: I'm cleaning my room.", "Or: I'm doing some cleaning."],
      patterns: [
        { re: /\bclean(ing)?\b/i, ok: true }
      ]
    }
  };

  function coachReply(userText){
    const sceneKey = sceneSel.value;
    const sc = SCENES[sceneKey] || SCENES.cooking;
    const ut = normalize(userText);

    // é–‹å ´å…ˆåƒ TalkMe å•ä¸€å¥ï¼ˆåªåœ¨å°è©±å‰›é–‹å§‹æˆ–å¾ˆçŸ­æ™‚ï¼‰
    const first = feed.children.length === 0;

    let verdict = null;
    let fix = sc.target;
    let alt = null;

    for(const p of sc.patterns){
      if(p.re.test(ut)){
        verdict = p.ok ? "ok" : "bad";
        if(p.fix) fix = p.fix;
        if(p.alt) alt = p.alt;
        break;
      }
    }
    if(!verdict){
      // ä¸åŒ¹é…å°±çµ¦æƒ…å¢ƒå¼•å° + æ­£ç¢ºå¥
      verdict = "bad";
      fix = sc.target;
    }

    const coachLine = first ? sc.coachOpen : "Got it. Try this:";
    const badge = verdict==="ok" ? "âœ… å¾ˆæ¥è¿‘ï¼ä½ å¯ä»¥é€™æ¨£æ›´è‡ªç„¶ï¼š" : "âŒ ä¸å¤ªè‡ªç„¶ï¼Œä½ æ‡‰è©²èªªï¼š";
    const badgeType = verdict==="ok" ? "good" : "bad";
    const better = alt || fix;

    const btnSpeak = document.createElement("button");
    btnSpeak.className = "primary";
    btnSpeak.textContent = "ğŸ”Š è·Ÿè®€";
    btnSpeak.onclick = () => ttsSpeak(better);

    const btnCopy = document.createElement("button");
    btnCopy.textContent = "ğŸ“‹ è¤‡è£½æ­£ç¢ºå¥";
    btnCopy.onclick = async () => {
      try{ await navigator.clipboard.writeText(better); }catch(e){}
    };

    const tipText = (hint.value||"").trim()
      ? "æ•™ç·´æç¤ºï¼ˆä½ å¡«çš„ï¼‰ï¼š " + hint.value.trim()
      : "å°æç¤ºï¼š " + (sc.tips.join(" / "));

    addMsg("AI", coachLine, {
      badge,
      badgeType,
      sub: better + "  " + " (" + tipText + ")",
      actions: [btnSpeak, btnCopy]
    });
  }

  // ====== ç›¸æ©Ÿ ======
  async function startCam(){
    try{
      stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
      video.srcObject = stream;
      camTag.className = "tag ok";
      camTag.textContent = "ç›¸æ©Ÿï¼šå·²é–‹";
      btnCam.textContent = "é—œé–‰ç›¸æ©Ÿ";
    }catch(e){
      camTag.className = "tag bad";
      camTag.textContent = "ç›¸æ©Ÿï¼šå¤±æ•—";
      addMsg("AI","ç›¸æ©Ÿé–‹å•Ÿå¤±æ•—ï¼Œè«‹å…è¨±ç€è¦½å™¨ç›¸æ©Ÿæ¬Šé™ã€‚",{badge:"âš ï¸ ç›¸æ©Ÿæ¬Šé™æœªé–‹",badgeType:"bad"});
    }
  }
  function stopCam(){
    if(stream){
      stream.getTracks().forEach(t=>t.stop());
      stream=null;
    }
    video.srcObject = null;
    camTag.className = "tag";
    camTag.textContent = "ç›¸æ©Ÿï¼šæœªé–‹";
    btnCam.textContent = "é–‹å•Ÿç›¸æ©Ÿ";
  }
  btnCam.onclick = async () => {
    if(stream) stopCam();
    else await startCam();
  };

  btnSnap.onclick = () => {
    if(!stream){
      addMsg("AI","å…ˆé–‹å•Ÿç›¸æ©Ÿå†æ‹ç…§ã€‚",{badge:"âš ï¸ ç›¸æ©Ÿæœªé–‹",badgeType:"bad"});
      return;
    }
    const c = document.createElement("canvas");
    c.width = video.videoWidth || 640;
    c.height = video.videoHeight || 360;
    const ctx = c.getContext("2d");
    ctx.drawImage(video,0,0,c.width,c.height);
    lastSnapshotDataUrl = c.toDataURL("image/jpeg",0.8);
    addMsg("AI","ğŸ“¸ Snapshot å·²æ‹ç…§ï¼ˆMVP ç‰ˆä¸é€å‡ºï¼Œåªæ˜¯è®“ä½ ç¢ºèªå½±åƒå¯ç”¨ï¼‰ã€‚",{badge:"ğŸ“¸ Snapshot",badgeType:"good"});
  };

  btnClear.onclick = () => {
    feed.innerHTML = "";
    addMsg("AI","æ­¡è¿ä¾†åˆ° BookWide Talkï¼ˆMVPï¼‰ã€‚å…ˆé¸æƒ…å¢ƒï¼ŒæŒ‰ä½èªªä¸€å¥è‹±æ–‡å°±å¥½ã€‚",{badge:"âœ… å¯é–‹å§‹",badgeType:"good"});
  };

  // ====== èªéŸ³è¾¨è­˜ï¼ˆSTTï¼‰ ======
  function initSTT(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){
      sttTag.className = "tag bad";
      sttTag.textContent = "è¾¨è­˜ï¼šæ­¤ç€è¦½å™¨ä¸æ”¯æ´";
      btnPTT.disabled = true;
      return;
    }
    recognition = new SR();
    recognition.lang = $("lang").value || "en-US";
    recognition.continuous = false;
    recognition.interimResults = true;

    recognition.onstart = () => {
      recognizing = true;
      btnPTT.classList.add("rec");
      btnPTT.textContent = "æ”¾é–‹åœæ­¢";
      micTag.className = "tag ok";
      micTag.textContent = "éº¥å…‹é¢¨ï¼šä½¿ç”¨ä¸­";
      sttTag.className = "tag warn";
      sttTag.textContent = "è¾¨è­˜ï¼šè½å–ä¸­";
    };

    let finalText = "";

    recognition.onresult = (e) => {
      let interim = "";
      for(let i=e.resultIndex;i<e.results.length;i++){
        const t = e.results[i][0].transcript;
        if(e.results[i].isFinal) finalText += t;
        else interim += t;
      }
      // é¡¯ç¤º interim ç‹€æ…‹ï¼ˆä¸åˆ·å±ï¼‰
      if(interim.trim()){
        sttTag.className = "tag warn";
        sttTag.textContent = "è¾¨è­˜ï¼š" + interim.trim().slice(0,18) + (interim.trim().length>18?"â€¦":"");
      }
    };

    recognition.onerror = () => {
      sttTag.className = "tag bad";
      sttTag.textContent = "è¾¨è­˜ï¼šå¤±æ•—";
    };

    recognition.onend = () => {
      recognizing = false;
      btnPTT.classList.remove("rec");
      btnPTT.textContent = "æŒ‰ä½èªªè©±";
      micTag.className = "tag";
      micTag.textContent = "éº¥å…‹é¢¨ï¼šæœªç”¨";
      sttTag.className = "tag warn";
      sttTag.textContent = "è¾¨è­˜ï¼šå¾…å‘½";

      const text = normalize(finalText);
      finalText = "";
      if(text){
        addMsg("YOU", text);
        coachReply(text);
      }
    };

    btnPTT.disabled = false;
  }

  function startSTT(){
    if(!recognition) return;
    recognition.lang = $("lang").value || "en-US";
    try{ recognition.start(); }catch(e){}
  }
  function stopSTT(){
    if(!recognition) return;
    try{ recognition.stop(); }catch(e){}
  }

  // PTTï¼šæŒ‰ä¸‹é–‹å§‹ï¼Œæ”¾é–‹åœæ­¢
  btnPTT.addEventListener("mousedown", startSTT);
  btnPTT.addEventListener("touchstart", (e)=>{ e.preventDefault(); startSTT(); }, {passive:false});
  window.addEventListener("mouseup", ()=>{ if(recognizing) stopSTT(); });
  window.addEventListener("touchend", ()=>{ if(recognizing) stopSTT(); });

  // æ‰‹å‹•é€å‡º
  btnSend.onclick = () => {
    const t = normalize(manual.value);
    if(!t) return;
    manual.value = "";
    addMsg("YOU", t);
    coachReply(t);
  };
  manual.addEventListener("keydown",(e)=>{
    if(e.key==="Enter"){ e.preventDefault(); btnSend.click(); }
  });

  // åˆå§‹åŒ–
  btnClear.click();
  initSTT();

})();
</script>
</body>
</html>
