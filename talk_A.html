<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Talk Aï¼ˆæ‰‹æ©Ÿå£èªªï¼‰ï½œBookWide</title>
  <style>
    :root{
      --bg:#f4f6fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --brand:#2563eb; --shadow:0 18px 50px rgba(15,23,42,.10); --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;}
    .top{
      position:sticky;top:0;z-index:30;background:rgba(244,246,251,.85);
      backdrop-filter:blur(10px);border-bottom:1px solid rgba(229,231,235,.7);
    }
    .topbar{max-width:980px;margin:0 auto;padding:14px 14px;display:flex;gap:10px;align-items:center;}
    .back{width:42px;height:42px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .title{flex:1;min-width:0}
    .title b{display:block;font-size:18px;line-height:1.15}
    .title small{display:block;color:var(--muted);margin-top:2px}
    .pill{
      border:1px solid var(--line);background:#fff;border-radius:999px;
      padding:8px 12px;display:flex;gap:8px;align-items:center;max-width:40%;
    }
    select{border:none;outline:none;background:transparent;font:inherit;max-width:260px}
    .wrap{max-width:980px;margin:18px auto;padding:0 14px 28px;}
    .card{background:var(--card);border:1px solid rgba(229,231,235,.7);border-radius:24px;box-shadow:var(--shadow);overflow:hidden}
    .cardInner{padding:18px}
    .head{display:flex;gap:12px;align-items:center;margin-bottom:10px}
    .badge{
      display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:999px;
      background:#0b1220;color:#fff;font-weight:700;font-size:13px;
    }
    .dot{width:8px;height:8px;border-radius:99px;background:#22c55e;box-shadow:0 0 0 3px rgba(34,197,94,.20)}
    .meta{color:var(--muted);font-weight:600}
    .avatarStage{display:flex;justify-content:center;align-items:center;padding:12px 0 8px}
    .halo{
      width:min(520px,78vw);aspect-ratio:1/1;border-radius:9999px;
      background:radial-gradient(circle at 35% 30%, #ffffff 0%, #e9eef8 50%, #dfe6f4 100%);
      position:relative;display:flex;align-items:center;justify-content:center;
      box-shadow: inset 0 0 40px rgba(15,23,42,.06);
    }
    .ring{
      width:58%;aspect-ratio:1/1;border-radius:9999px;background:#fff;
      border:6px solid rgba(255,255,255,.95);
      box-shadow:0 18px 70px rgba(15,23,42,.18);
      overflow:hidden;display:flex;align-items:center;justify-content:center;
    }
    .ring video,.ring img{width:100%;height:100%;object-fit:cover;display:block}
    .prompt{
      margin-top:10px;border:1px solid rgba(229,231,235,.9);border-radius:18px;background:#f8fafc;
      padding:18px;
    }
    .prompt h2{margin:0;font-size:40px;letter-spacing:.2px}
    .prompt p{margin:8px 0 0;color:var(--muted)}
    .controls{display:flex;gap:12px;align-items:center;margin-top:14px;flex-wrap:wrap}
    .btnMain{
      flex:1;min-width:240px;height:64px;border-radius:999px;border:2px solid rgba(15,23,42,.9);
      background:linear-gradient(180deg,#1d4ed8,#0b5cff);color:#fff;font-weight:900;font-size:18px;
      cursor:pointer;box-shadow:0 16px 45px rgba(37,99,235,.25);
    }
    .btn{
      height:52px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;
      padding:0 18px;font-weight:800;
    }
    .hintToast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:#0b1220;color:#fff;padding:10px 14px;border-radius:999px;
      font-weight:700;font-size:13px;opacity:0;pointer-events:none;transition:.2s;
      box-shadow:0 14px 40px rgba(0,0,0,.25);
    }
    .hintToast.show{opacity:1}
    .smallRow{margin-top:10px;color:var(--muted);font-size:13px}
    .smallRow b{color:var(--ink)}
  </style>
</head>
<body>
  <div class="top">
    <div class="topbar">
      <button class="back" id="backBtn" title="è¿”å›">â†</button>
      <div class="title">
        <b>Talk Aï¼ˆæ‰‹æ©Ÿå£èªªï¼‰</b>
        <small>TTSï¼šBrowser SpeechSynthesis</small>
      </div>
      <div class="pill">
        <span>æƒ…å¢ƒï¼š</span>
        <select id="sceneSelect"></select>
      </div>
      <div class="pill">
        <span>è€å¸«ï¼š</span>
        <select id="teacherSelect"></select>
      </div>
      <button class="btn" id="replayBtn">é‡æ’­æœ¬å¥</button>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="cardInner">
        <div class="head">
          <div class="badge"><span class="dot"></span><span id="roleLabel">AI Â· Barista</span></div>
          <div class="meta" id="sceneLabel">è²·ä¸€æ¯å’–å•¡ï½œCoffee Shop (A1)</div>
        </div>

        <div class="avatarStage">
          <div class="halo">
            <div class="ring" id="avatarRing">
              <!-- video inserted here -->
            </div>
          </div>
        </div>

        <div class="prompt">
          <h2 id="promptEn">Loadingâ€¦</h2>
          <p id="promptZh">ï¼ˆè¼‰å…¥ä¸­â€¦ï¼‰</p>
        </div>

        <div class="controls">
          <button class="btnMain" id="micBtn">ğŸ¤ é»æˆ‘èªªï¼ˆé–‹å§‹è¾¨è­˜ï¼‰</button>
          <button class="btn" id="typeBtn">âŒ¨ï¸ è¼¸å…¥</button>
          <button class="btn" id="skipBtn">è·³é</button>
        </div>

        <div class="smallRow">ç‹€æ…‹ï¼š<b id="statusText">å°±ç·’</b>ã€€|ã€€ä½ èªªï¼š<b id="heardText">â€”</b></div>
      </div>
    </div>
  </div>

  <div class="hintToast" id="toast">æç¤º</div>

<script>
(() => {
  // ====== CONFIG (åªæ”¹é€™è£¡å°±å¥½) ======
  const TEACHERS = {
    pineapple: {
      key:'pineapple',
      name:'Pineapple',
      role:'AI Â· Barista',
      video:'https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/assets/avatars/Pineapple.mp4'
    },
    mermaid: {
      key:'mermaid',
      name:'Mermaid',
      role:'AI Â· Mermaid',
      video:'https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/assets/avatars/mermaid.mp4'
    },
    lychee: {
      key:'lychee',
      name:'Lychee',
      role:'AI Â· Lychee',
      video:'https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/assets/avatars/Lychee.mp4'
    }
  };

  // 5 æƒ…å¢ƒï¼šå„ªå…ˆè®€ä½ ç¾æœ‰çš„ jsonï¼ˆæ”¾åœ¨åŒç¶²åŸŸ /talk/ å…§ï¼‰ï¼Œè®€ä¸åˆ°å°±ç”¨å…§å»º fallback
  const SCENES = [
    { key:'coffee_shop',      title:'è²·ä¸€æ¯å’–å•¡ï½œCoffee Shop (A1)',        role:'AI Â· Barista',      url:'/talk/coffee_shop.json' },
    { key:'restaurant_order', title:'é¤å»³é»é¤ï½œRestaurant Order (A1)',     role:'AI Â· Server',       url:'/talk/restaurant_order.json' },
    { key:'hotel_checkin',    title:'é£¯åº—å…¥ä½ï½œHotel Check-in (A2)',       role:'AI Â· Reception',   url:'/talk/hotel_checkin.json' },
    { key:'airport_checkin',  title:'æ©Ÿå ´å ±åˆ°ï½œAirport Check-in (A2)',     role:'AI Â· Airline Staff', url:'/talk/airport_checkin.json' },
    { key:'business_meeting', title:'å•†å‹™æœƒè­°ï½œBusiness Meeting (B1)',     role:'AI Â· Colleague',   url:'/talk/business_meeting.json' }
  ];

  // ====== DOM ======
  const $sceneSel = document.getElementById('sceneSelect');
  const $teacherSel = document.getElementById('teacherSelect');
  const $sceneLabel = document.getElementById('sceneLabel');
  const $roleLabel  = document.getElementById('roleLabel');
  const $promptEn = document.getElementById('promptEn');
  const $promptZh = document.getElementById('promptZh');
  const $status = document.getElementById('statusText');
  const $heard = document.getElementById('heardText');
  const $toast = document.getElementById('toast');
  const $avatarRing = document.getElementById('avatarRing');

  function toast(msg){
    $toast.textContent = msg;
    $toast.classList.add('show');
    clearTimeout(toast._t);
    toast._t = setTimeout(()=> $toast.classList.remove('show'), 1400);
  }

  // ====== URL PARAMS (ä¸æœƒæŠŠä½ å°åˆ° bookwide.net/ ï¼Œåªåœ¨ talk_A.html è‡ªå·±æ›´æ–° query) ======
  const url = new URL(location.href);
  let sceneKey = (url.searchParams.get('scene') || 'coffee_shop').trim();
  let teacherKey = (url.searchParams.get('teacher') || 'pineapple').trim().toLowerCase();

  function setUrlParams(){
    const u = new URL(location.href);
    u.searchParams.set('scene', sceneKey);
    u.searchParams.set('teacher', teacherKey);
    history.replaceState({}, '', u.toString());
  }

  // ====== Populate selects ======
  function buildSelects(){
    $sceneSel.innerHTML = '';
    for (const s of SCENES){
      const opt = document.createElement('option');
      opt.value = s.key;
      opt.textContent = s.title;
      $sceneSel.appendChild(opt);
    }
    $teacherSel.innerHTML = '';
    for (const k of Object.keys(TEACHERS)){
      const t = TEACHERS[k];
      const opt = document.createElement('option');
      opt.value = t.key;
      opt.textContent = t.name;
      $teacherSel.appendChild(opt);
    }
  }

  // ====== Avatar video (æœ€å°ç©©å®šç‰ˆï¼šåªç”¨ mp4ï¼Œç„¡åœ–) ======
  let currentVideoEl = null;

  function mountTeacherVideo(){
    const t = TEACHERS[teacherKey] || TEACHERS.pineapple;
    teacherKey = t.key;

    // æ¸…æ‰èˆŠçš„
    $avatarRing.innerHTML = '';
    currentVideoEl = document.createElement('video');
    currentVideoEl.setAttribute('playsinline','');
    currentVideoEl.setAttribute('webkit-playsinline','');
    currentVideoEl.muted = true;          // autoplay å¿…å‚™
    currentVideoEl.loop = true;
    currentVideoEl.autoplay = true;
    currentVideoEl.preload = 'auto';
    currentVideoEl.src = t.video;

    currentVideoEl.addEventListener('error', () => {
      toast('è€å¸«å½±ç‰‡è¼‰å…¥å¤±æ•—ï¼ˆè«‹æª¢æŸ¥ mp4 URL / æ¬Šé™ï¼‰');
    });

    $avatarRing.appendChild(currentVideoEl);

    // æŸäº›ç€è¦½å™¨éœ€è¦ user gesture æ‰èƒ½ playï¼šæˆ‘å€‘å…ˆå˜—è©¦ï¼Œå¤±æ•—å°±ç­‰ä½¿ç”¨è€…æŒ‰éˆ•å†å•Ÿå‹•
    const tryPlay = () => currentVideoEl.play().catch(()=>{});
    tryPlay();
    window.addEventListener('click', tryPlay, {once:true, passive:true});

    $roleLabel.textContent = (TEACHERS[teacherKey]?.role) || 'AI Â· teacher';
  }

  // ====== Scene loader ======
  // å…¼å®¹ä½ ä¹‹å‰çš„ json æ ¼å¼ï¼šå…è¨± prompts / lines / itemsã€‚åªæŠ½ç¬¬ä¸€å¥é¡¯ç¤ºï¼ˆä½ è¦æ›´å®Œæ•´æˆ‘å†åŠ å›å°è©±å¼•æ“ï¼‰
  async function loadScene(){
    const s = SCENES.find(x=>x.key===sceneKey) || SCENES[0];
    sceneKey = s.key;
    $sceneLabel.textContent = s.title;

    // role ä»¥ã€Œè€å¸«ã€ç‚ºä¸»ï¼›æƒ…å¢ƒ role åªæ˜¯æç¤º
    // $roleLabel set in mountTeacherVideo()

    $promptEn.textContent = 'Loadingâ€¦';
    $promptZh.textContent = 'ï¼ˆè¼‰å…¥ä¸­â€¦ï¼‰';

    const fallback = {
      en: 'Hi there! Welcome to our cafe.',
      zh: 'å—¨ï¼æ­¡è¿ä¾†åˆ°æˆ‘å€‘çš„å’–å•¡åº—ã€‚'
    };

    try{
      const res = await fetch(s.url, {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();

      // best-effort extract
      let en = '', zh = '';
      if (Array.isArray(data?.prompts) && data.prompts[0]){
        en = data.prompts[0].en || data.prompts[0].text || '';
        zh = data.prompts[0].zh || data.prompts[0].translation || '';
      } else if (Array.isArray(data?.lines) && data.lines[0]){
        en = data.lines[0].en || data.lines[0].text || '';
        zh = data.lines[0].zh || data.lines[0].translation || '';
      } else if (Array.isArray(data) && data[0]){
        en = data[0].en || data[0].text || '';
        zh = data[0].zh || data[0].translation || '';
      }

      en = (en || fallback.en).trim();
      zh = (zh || fallback.zh).trim();

      $promptEn.textContent = en;
      $promptZh.textContent = zh;
      speak(en);
      $status.textContent = 'å·²è¼‰å…¥';
    }catch(e){
      // ä¸è¦é˜»æ–·ï¼šçµ¦ fallback
      $promptEn.textContent = fallback.en;
      $promptZh.textContent = fallback.zh;
      speak(fallback.en);
      $status.textContent = 'é›¢ç·š/æ‰¾ä¸åˆ°æƒ…å¢ƒæª”ï¼ˆå·²ç”¨å…§å»ºå¥ï¼‰';
    }
  }

  // ====== TTS ======
  function speak(text){
    try{
      if(!('speechSynthesis' in window)) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'en-US';
      u.rate = 1.0;
      window.speechSynthesis.speak(u);
    }catch(_){}
  }

  // ====== Speech Recognition (å¯ç”¨å°±ç”¨ï¼›ä¸å¯ç”¨å°±èµ°è¼¸å…¥) ======
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  let rec = null;
  if (SR){
    rec = new SR();
    rec.lang = 'en-US';
    rec.interimResults = false;
    rec.maxAlternatives = 3;
  }

  function startRec(){
    if (!rec){
      toast('æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼Œæ”¹ç”¨è¼¸å…¥');
      return typeAnswer();
    }
    $status.textContent = 'è½ä½ èªªâ€¦';
    try{ rec.start(); }catch(_){}
  }

  function typeAnswer(){
    const ans = prompt('è«‹è¼¸å…¥ä½ è¦å›ç­”çš„è‹±æ–‡ï¼š', '');
    if (ans == null) return;
    $heard.textContent = ans.trim() || 'â€”';
    $status.textContent = 'å·²è¼¸å…¥';
    toast('OKï¼ˆå·²æ”¶åˆ°ï¼‰');
  }

  if (rec){
    rec.onresult = (ev) => {
      const t = (ev.results?.[0]?.[0]?.transcript || '').trim();
      $heard.textContent = t || 'â€”';
      $status.textContent = t ? 'è¾¨è­˜å®Œæˆ' : 'æ²’è½æ¸…æ¥š';
      if(!t) toast('æ²’è½æ¸…æ¥šï¼Œè«‹å†è©¦ä¸€æ¬¡æˆ–æ”¹è¼¸å…¥');
    };
    rec.onerror = () => {
      $status.textContent = 'è¾¨è­˜å¤±æ•—';
      toast('è¾¨è­˜å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡æˆ–æ”¹è¼¸å…¥');
    };
  }

  // ====== Events ======
  document.getElementById('micBtn').addEventListener('click', startRec);
  document.getElementById('typeBtn').addEventListener('click', typeAnswer);
  document.getElementById('skipBtn').addEventListener('click', () => {
    toast('è·³éï¼ˆå…ˆä¸åšè©•åˆ†ï¼‰');
    $status.textContent = 'å·²è·³é';
  });
  document.getElementById('replayBtn').addEventListener('click', () => speak($promptEn.textContent));
  document.getElementById('backBtn').addEventListener('click', () => {
    // ä¸è¦ç¢° index.htmlï¼šåªåš history.backï¼›æ²’æœ‰æ­·å²å°±å›é¦–é 
    if (history.length > 1) history.back();
    else location.href = '/index.html';
  });

  $sceneSel.addEventListener('change', () => {
    sceneKey = $sceneSel.value;
    setUrlParams();
    loadScene();
  });

  $teacherSel.addEventListener('change', () => {
    teacherKey = $teacherSel.value;
    setUrlParams();
    mountTeacherVideo();
  });

  // ====== Init ======
  buildSelects();
  // sanitize keys
  if(!SCENES.some(s=>s.key===sceneKey)) sceneKey = 'coffee_shop';
  if(!TEACHERS[teacherKey]) teacherKey = 'pineapple';

  $sceneSel.value = sceneKey;
  $teacherSel.value = teacherKey;

  setUrlParams();
  mountTeacherVideo();
  loadScene();
})();
</script>
</body>
</html>
