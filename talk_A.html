<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Talk Aï¼ˆæ‰‹æ©Ÿå£èªªï¼‰ï½œBookWide</title>

  <style>
    :root{
      --bg0:#071025;
      --bg1:#0b1633;
      --card:#0f234d;
      --card2:#0c1a3a;
      --ink:#eaf2ff;
      --muted:#a6b7d3;
      --line:rgba(255,255,255,.08);
      --brand:#4aa3ff;
      --brand2:#2f7dff;
      --ok:#28d17c;
      --bad:#ff5a7a;
      --warn:#ffd166;
      --radius:18px;
      --shadow:0 18px 60px rgba(0,0,0,.35);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      color:var(--ink);
      background: radial-gradient(1200px 600px at 25% 0%, rgba(74,163,255,.18), transparent 60%),
                  radial-gradient(900px 500px at 85% 10%, rgba(255,90,122,.10), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* ===== Top bar ===== */
    .topbar{
      position:sticky;
      top:0;
      z-index:10;
      padding: calc(10px + var(--safe-top)) 14px 10px;
      backdrop-filter: blur(14px);
      background: linear-gradient(180deg, rgba(7,16,37,.85), rgba(7,16,37,.35));
      border-bottom:1px solid var(--line);
    }
    .toprow{
      display:flex; align-items:center; gap:10px;
    }
    .titleWrap{flex:1; min-width:0}
    .title{
      font-size:16px; font-weight:800; letter-spacing:.2px;
      display:flex; align-items:center; gap:8px;
      margin:0;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.22);
      box-shadow:0 0 0 3px rgba(255,255,255,.06);
    }
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--bad)}
    .dot.info{background:var(--brand)}
    .sub{
      margin:2px 0 0;
      color:var(--muted);
      font-size:12px;
      opacity:.95;
    }
    .controls{
      display:flex; gap:8px; align-items:center;
    }
    select, button{
      font:inherit;
    }
    .sel{
      height:34px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--ink);
      padding:0 10px;
      outline:none;
      max-width: 170px;
    }
    .btn{
      height:34px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--ink);
      padding:0 12px;
      cursor:pointer;
      transition:.15s transform, .15s background;
      display:flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:active{transform:scale(.98)}
    .btn.primary{
      background:linear-gradient(180deg, rgba(74,163,255,.22), rgba(74,163,255,.10));
      border-color: rgba(74,163,255,.35);
    }
    .btn.ghost{
      background:transparent;
    }
    .btnIcon{
      width:18px; height:18px; display:inline-flex; align-items:center; justify-content:center;
      border-radius:6px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      font-size:12px;
    }

    /* ===== Main layout ===== */
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 14px 14px calc(120px + var(--safe-bottom));
    }
    .card{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* ===== Avatar stage ===== */
    .stage{
      margin-top:12px;
      padding: 16px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--muted);
      font-size:12px;
      width:fit-content;
    }
    .avatarRow{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 6px 0 2px;
    }
    .avatarCard{
      width: 220px;
      height: 220px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(70% 70% at 50% 45%, rgba(74,163,255,.18), rgba(74,163,255,.05) 60%, rgba(0,0,0,.12) 100%),
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      transform: translateZ(0);
    }
    .avatarHalo{
      position:absolute; inset:-35px;
      border-radius:999px;
      border:2px solid rgba(255,255,255,.05);
      filter: blur(.2px);
    }
    .avatarImg{
      width: 128px;
      height: 128px;
      border-radius: 18px;
      object-fit: cover;
      box-shadow:0 12px 30px rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.04);
    }
    .avatarFallback{
      width: 128px; height: 128px; border-radius: 18px;
      border:1px solid rgba(255,255,255,.18);
      background:
        radial-gradient(40px 40px at 40% 40%, rgba(255,255,255,.22), rgba(255,255,255,.05)),
        radial-gradient(50px 50px at 65% 65%, rgba(74,163,255,.18), rgba(74,163,255,.04));
      box-shadow:0 12px 30px rgba(0,0,0,.35);
      display:flex; align-items:center; justify-content:center;
      color:rgba(255,255,255,.65);
      font-weight:800;
    }

    /* subtle animation states */
    .state-idle{animation: floaty 3.4s ease-in-out infinite}
    .state-speaking{animation: speak 1.0s ease-in-out infinite}
    .state-listening{animation: listen 1.2s ease-in-out infinite}
    .state-positive{animation: pop 600ms ease-out 1}
    .state-encourage{animation: nudge 700ms ease-out 1}

    @keyframes floaty{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}
    @keyframes speak{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-3px) scale(1.01)}}
    @keyframes listen{0%,100%{transform:translateY(0)}50%{transform:translateY(2px)}}
    @keyframes pop{0%{transform:scale(.98)}60%{transform:scale(1.02)}100%{transform:scale(1)}}
    @keyframes nudge{0%{transform:translateX(0)}35%{transform:translateX(4px)}70%{transform:translateX(-3px)}100%{transform:translateX(0)}}

    /* ===== Sentence + controls ===== */
    .line{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      color:var(--muted);
      font-size:12px;
      padding: 0 2px;
    }
    .stepTag{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
    }
    .stepTag b{color:var(--ink)}
    .sentenceCard{
      margin-top:10px;
      padding: 16px 16px 14px;
      border-top:1px solid var(--line);
      background:linear-gradient(180deg, rgba(0,0,0,.12), rgba(0,0,0,.08));
    }
    .sentence{
      font-size: 28px;
      font-weight: 900;
      letter-spacing: .2px;
      line-height: 1.2;
      margin:0;
      text-shadow:0 6px 20px rgba(0,0,0,.25);
      word-break: break-word;
    }
    .subtitle{
      margin-top:10px;
      color:rgba(255,255,255,.72);
      font-size:14px;
      line-height:1.3;
      min-height: 18px;
    }
    .choices{
      margin-top:12px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .chip{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      cursor:pointer;
      user-select:none;
      transition:.15s transform,.15s background;
      font-weight:700;
    }
    .chip:active{transform:scale(.98)}
    .hint{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.18);
      background:rgba(255,255,255,.04);
      color:rgba(255,255,255,.75);
      font-size:13px;
      display:none;
    }

    .btnRow{
      margin-top:14px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:center;
      padding-bottom: 6px;
    }
    .bigBtn{
      width: 64px;
      height: 64px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: radial-gradient(60% 60% at 50% 40%, rgba(74,163,255,.30), rgba(74,163,255,.12)),
                  rgba(255,255,255,.05);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      box-shadow:0 18px 40px rgba(0,0,0,.35);
      transition:.15s transform;
    }
    .bigBtn:active{transform:scale(.98)}
    .bigBtn.disabled{opacity:.45; pointer-events:none}
    .bigBtn .mic{
      width:18px;height:22px;border-radius:8px;
      border:2px solid rgba(255,255,255,.78);
      position:relative;
    }
    .bigBtn .mic:after{
      content:"";
      position:absolute;
      left:50%; transform:translateX(-50%);
      bottom:-12px;
      width:24px;height:10px;border-radius:0 0 14px 14px;
      border:2px solid rgba(255,255,255,.78);
      border-top:0;
    }
    .skipBtn{
      height:44px;
      padding:0 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      cursor:pointer;
      color:rgba(255,255,255,.9);
      font-weight:800;
      user-select:none;
    }
    .skipBtn:active{transform:scale(.99)}

    /* ===== log ===== */
    .log{
      margin-top:14px;
      padding: 12px 14px;
      border-top:1px solid var(--line);
      background:rgba(0,0,0,.10);
      color:rgba(255,255,255,.74);
      font-size:12px;
      line-height:1.45;
      max-height: 220px;
      overflow:auto;
      white-space: pre-wrap;
    }

    /* ===== Helper bar ===== */
    .helperBar{
      position:fixed;
      left:0; right:0;
      bottom:0;
      z-index:20;
      padding: 10px 12px calc(10px + var(--safe-bottom));
      background: linear-gradient(180deg, rgba(7,16,37,0), rgba(7,16,37,.88) 35%, rgba(7,16,37,.96));
      border-top:1px solid var(--line);
      backdrop-filter: blur(14px);
    }
    .helperRow{
      max-width:980px;
      margin:0 auto;
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
    }
    .hbtn{
      flex:1;
      height:44px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.88);
      font-weight:900;
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      min-width:0;
    }
    .hbtn:active{transform:scale(.99)}
    .hbtn .k{opacity:.8; font-weight:800}
    .hbtn.active{
      background: linear-gradient(180deg, rgba(74,163,255,.22), rgba(74,163,255,.10));
      border-color: rgba(74,163,255,.35);
    }

    /* ===== Bottom sheet modal ===== */
    .sheetMask{
      position:fixed; inset:0;
      background: rgba(0,0,0,.45);
      z-index:30;
      display:none;
    }
    .sheet{
      position:fixed;
      left:0; right:0;
      bottom:0;
      z-index:31;
      background: linear-gradient(180deg, rgba(12,26,58,.96), rgba(7,16,37,.98));
      border-top-left-radius: 22px;
      border-top-right-radius: 22px;
      border-top:1px solid rgba(255,255,255,.12);
      box-shadow: 0 -22px 80px rgba(0,0,0,.55);
      max-height: 46vh;
      transform: translateY(12px);
      display:none;
    }
    .sheetHead{
      padding: 10px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .grab{
      width:44px; height:5px;
      border-radius:999px;
      background: rgba(255,255,255,.20);
      margin: 6px auto 0;
    }
    .sheetTitle{
      font-weight:900; font-size:16px;
    }
    .sheetClose{
      height:34px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.9);
      cursor:pointer;
      padding:0 12px;
      font-weight:900;
    }
    .sheetBody{
      padding: 12px 14px calc(14px + var(--safe-bottom));
      overflow:auto;
      max-height: 64vh;
    }
    .section{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding: 12px 12px;
      margin-bottom: 12px;
    }
    .secTitle{
      font-weight:900;
      margin:0 0 10px;
      font-size:14px;
      color:rgba(255,255,255,.92);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .list{
      margin:0;
      padding-left:18px;
      color:rgba(255,255,255,.80);
      line-height:1.45;
      font-size:13px;
    }
    .exRow{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:10px 0;
      border-top:1px dashed rgba(255,255,255,.10);
    }
    .exRow:first-of-type{border-top:0; padding-top:0}
    .exMain{flex:1; min-width:0}
    .exEn{font-weight:900; font-size:14px; margin:0; color:rgba(255,255,255,.94)}
    .exZh{margin:6px 0 0; color:rgba(255,255,255,.72); font-size:13px}
    .miniBtns{display:flex; gap:8px; align-items:center}
    .mini{
      height:34px; width:34px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      user-select:none;
      font-weight:900;
    }
    .textarea{
      width:100%;
      min-height: 96px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.92);
      padding: 10px 12px;
      outline:none;
      resize: vertical;
      font-size: 14px;
      line-height: 1.35;
    }
    .row2{display:flex; gap:10px; margin-top:10px}
    .row2 .btn{flex:1; justify-content:center; font-weight:900}
    .muted{color:rgba(255,255,255,.70); font-size:13px; line-height:1.4}
    .pill{
      display:inline-flex; align-items:center;
      gap:8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      padding: 6px 10px;
      color:rgba(255,255,255,.82);
      font-size:12px;
      margin: 6px 8px 0 0;
    }

    /* ===== Report overlay ===== */
    .reportMask{
      position:fixed; inset:0;
      background: radial-gradient(900px 500px at 50% 0%, rgba(74,163,255,.18), transparent 55%),
                  rgba(0,0,0,.55);
      z-index:40;
      display:none;
    }
    .report{
      position:fixed;
      left:50%;
      top: 10%;
      transform:translateX(-50%);
      width:min(560px, calc(100vw - 28px));
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.14);
      border-radius:22px;
      box-shadow: 0 28px 90px rgba(0,0,0,.55);
      z-index:41;
      display:none;
      overflow:hidden;
    }
    .reportHead{
      padding: 14px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
    }
    .reportHead h3{
      margin:0;
      font-size:18px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .reportBody{padding: 16px}
    .stars{
      display:flex; justify-content:center; gap:16px;
      font-size:42px; line-height:1; margin: 6px 0 8px;
    }
    .stars span{filter: drop-shadow(0 10px 24px rgba(0,0,0,.25))}
    .bigMsg{
      text-align:center;
      font-weight:900;
      font-size:22px;
      color: var(--ok);
      margin: 0 0 10px;
    }
    .topicName{
      text-align:center;
      font-weight:900;
      font-size:18px;
      margin:0 0 12px;
      color:rgba(255,255,255,.92);
    }
    .metrics{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      margin-top: 8px;
    }
    .metric{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius:16px;
      padding: 10px 10px;
      text-align:center;
    }
    .metric .n{font-weight:950; font-size:26px}
    .metric .t{color:rgba(255,255,255,.72); font-size:12px; margin-top:4px}
    .reviewBox{
      margin-top: 12px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.10);
      border-radius: 16px;
      padding: 12px 12px;
      color:rgba(255,255,255,.82);
      font-size:13px;
      line-height:1.45;
    }
    .reportBtns{
      margin-top: 14px;
      display:flex; gap:10px;
    }
    .reportBtns .btn{flex:1; justify-content:center; font-weight:900; height:44px; border-radius:999px}
    .reportCloseX{
      height:34px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.9);
      cursor:pointer;
      padding:0 12px;
      font-weight:900;
    }

    @media (max-width:460px){
      .sentence{font-size:24px}
      .sel{max-width: 150px}
      .avatarCard{width: 206px; height: 206px}
    }
  
    /* --- helper hint under buttons --- */
    .helperHint{
      margin-top:8px;
      font-size:12px;
      color:rgba(255,255,255,.55);
      text-align:center;
      padding:0 10px;
      line-height:1.35;
    }

    /* --- simple mouth animation (fallback) --- */
    #avatarCard{ position:relative; overflow:hidden; }
    .mouth{
      position:absolute;
      left:50%;
      top:66%;
      width:56px;
      height:10px;
      transform:translateX(-50%);
      border-radius: 0 0 999px 999px;
      border: 3px solid rgba(255,255,255,.75);
      border-top: none;
      opacity:0;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.35));
      pointer-events:none;
    }
    .state-speaking .mouth{
      opacity:.95;
      animation: mouthTalk .16s infinite alternate;
    }
    @keyframes mouthTalk{
      from{ height:8px; }
      to{ height:18px; }
    }

</style>
</head>

<body>
  <div class="topbar">
    <div class="toprow">
      <div class="titleWrap">
        <h1 class="title">
          <span id="pillDot" class="dot info"></span>
          <span>Talk Aï¼ˆæ‰‹æ©Ÿå£èªªï¼‰</span>
        </h1>
        <div id="metaLine" class="sub">TTSï¼šBrowser SpeechSynthesis</div>
      </div>

      <div class="controls">
        <select id="sceneSel" class="sel" title="é¸æ“‡æƒ…å¢ƒ"></select>
        <button id="btnReplay" class="btn ghost" title="é‡æ’­æœ¬å¥">
          <span class="btnIcon">ğŸ”Š</span>
          <span class="hideSm">é‡æ’­</span>
        </button>
        <button id="btnReload" class="btn primary" title="é‡æ–°è¼‰å…¥">
          <span class="btnIcon">â†»</span>
          <span class="hideSm">é‡è¼‰</span>
        </button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card stage">
      <div class="badge" id="badge">AI Â· teacher</div>

      <div class="avatarRow">
        <div id="avatarCard" class="avatarCard state-idle">
          <div class="avatarHalo"></div>
          <img id="avatarImg" class="avatarImg" alt="AI avatar" style="display:none" />
          <div id="avatarFallback" class="avatarFallback">AI</div>
          <div class="mouth" aria-hidden="true"></div>
        </div>
      </div>

      <div class="line">
        <div class="stepTag"><span>â€¢</span> <b id="statusText">Ready</b></div>
        <div class="stepTag">step: <b id="stepText">-</b></div>
      </div>

      <div class="sentenceCard">
        <p id="sentence" class="sentence">Loadingâ€¦</p>
        <div id="subtitle" class="subtitle"></div>
        <div id="choices" class="choices"></div>
        <div id="hint" class="hint"></div>

        <div class="btnRow">
          <button id="btnNext" class="skipBtn" title="è·³é/ä¸‹ä¸€å¥">è·³é</button>
          <div id="btnMic" class="bigBtn" title="æŒ‰ä½èªªè©± / é»ä¸€ä¸‹é–‹å§‹">
            <div class="mic"></div>
          </div>
          <button id="btnDone" class="skipBtn" title="å®Œæˆæœ¬ä¸»é¡Œ" style="display:none">å®Œæˆ</button>
        </div>
      </div>

      <div id="log" class="log"></div>
    </div>
  </div>

  <!-- Helper bar -->
  <div class="helperBar">
    <div class="helperRow">
      <button class="hbtn" id="hTasks"><span class="k">ä»»å‹™</span></button>
      <button class="hbtn" id="hExamples"><span class="k">ç¯„ä¾‹</span></button>
      <button class="hbtn" id="hTranslate"><span class="k">ç¿»è­¯</span></button>
      <button class="hbtn" id="hSaved"><span class="k">å·²å„²å­˜</span></button>
    </div>
      <div class="helperHint">ä¸»é ä¿æŒåœ¨å°è©±ä¸­ï¼›é»ã€Œä»»å‹™ï¼ç¯„ä¾‹ï¼ç¿»è­¯ï¼å·²å„²å­˜ã€åªæœƒæ‰“é–‹è¼”åŠ©å°çª—ï¼Œä¸æœƒä¸­æ–·å°è©±ã€‚</div>
  </div>

  <!-- Bottom sheet -->
  <div id="sheetMask" class="sheetMask"></div>
  <div id="sheet" class="sheet" role="dialog" aria-modal="true">
    <div class="grab"></div>
    <div class="sheetHead">
      <div class="sheetTitle" id="sheetTitle">ä»»å‹™</div>
      <button class="sheetClose" id="sheetClose">é—œé–‰</button>
    </div>
    <div class="sheetBody" id="sheetBody"></div>
  </div>

  <!-- Report -->
  <div id="reportMask" class="reportMask"></div>
  <div id="report" class="report" role="dialog" aria-modal="true">
    <div class="reportHead">
      <h3>å­¸ç¿’å ±å‘Š</h3>
      <button class="reportCloseX" id="reportCloseX">é—œé–‰</button>
    </div>
    <div class="reportBody">
      <div class="stars" id="stars"><span>â­</span><span>â­</span><span>â­</span></div>
      <div class="bigMsg" id="bigMsg">å¾ˆæ£’ï¼</div>
      <div class="topicName" id="topicName">-</div>

      <div class="metrics">
        <div class="metric"><div class="n" id="mTopic">0%</div><div class="t">ä¸»é¡Œç›¸é—œåº¦</div></div>
        <div class="metric"><div class="n" id="mPron">0%</div><div class="t">ç™¼éŸ³</div></div>
        <div class="metric"><div class="n" id="mWords">0</div><div class="t">ä½¿ç”¨çš„å–®å­—æ•¸</div></div>
      </div>

      <div class="reviewBox" id="reviewBox">â€”</div>

      <div class="reportBtns">
        <button class="btn" id="btnChatLog">èŠå¤©è¨˜éŒ„</button>
        <button class="btn primary" id="btnContinue">ç¹¼çºŒ</button>
      </div>
    </div>
  </div>

  <script>
/* Talk A (GitHub Pages mode): loads ./talk/index.json and ./talk/<scene>.json */
const $ = (id)=>document.getElementById(id);
const UI = {
  card: $('avatarCard'),
  pillDot: $('pillDot'),
  statusText: $('statusText'),
  stepText: $('stepText'),
  sentence: $('sentence'),
  subtitle: $('subtitle'),
  choices: $('choices'),
  hint: $('hint'),
  log: $('log'),
  btnMic: $('btnMic'),
  btnNext: $('btnNext'),
  btnDone: $('btnDone'),
  btnReload: $('btnReload'),
  btnReplay: $('btnReplay'),
  metaLine: $('metaLine'),
  sceneSel: $('sceneSel'),
  badge: $('badge'),
  avatarImg: $('avatarImg'),
  avatarFallback: $('avatarFallback'),
  // helpers
  hTasks: $('hTasks'),
  hExamples: $('hExamples'),
  hTranslate: $('hTranslate'),
  hSaved: $('hSaved'),
  sheetMask: $('sheetMask'),
  sheet: $('sheet'),
  sheetTitle: $('sheetTitle'),
  sheetBody: $('sheetBody'),
  sheetClose: $('sheetClose'),
  // report
  reportMask: $('reportMask'),
  report: $('report'),
  reportCloseX: $('reportCloseX'),
  topicName: $('topicName'),
  reviewBox: $('reviewBox'),
  mTopic: $('mTopic'),
  mPron: $('mPron'),
  mWords: $('mWords'),
  btnChatLog: $('btnChatLog'),
  btnContinue: $('btnContinue'),
};

const BASE = './talk';

/** Optional: your translation endpoint (POST JSON: {text, target:"en"} -> {translated}) */
const TRANSLATE_ENDPOINT = ""; // e.g. "https://<your-supabase>.supabase.co/functions/v1/translate"

let INDEX = null;
let SCRIPT = null;
let stepsById = {};
let currentId = "";
let failCount = {};
let speaking = false;

let metrics = {
  totalTurns: 0,
  topicHits: 0,
  userWords: 0,
  approxPronOK: 0, // proxy: success turns
  chat: []
};

function setAvatarState(state){
  UI.card.classList.remove('state-idle','state-speaking','state-listening','state-positive','state-encourage');
  UI.card.classList.add('state-'+state);
  const dot = UI.pillDot;
  dot.classList.remove('ok','bad','info');
  if(state==='positive') dot.classList.add('ok');
  else if(state==='encourage') dot.classList.add('bad');
  else dot.classList.add('info');
}

function logLine(t){
  UI.log.textContent += t + "\n";
  UI.log.scrollTop = UI.log.scrollHeight;
}

function escapeHtml(s){
  return String(s||"").replace(/[&<>"]/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]));
}

/* ---------- Storage for saved (sentences + words) ---------- */
const LS_KEY = "BW_TALK_SAVED_V1";
function loadSaved(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY)||'{"words":[],"sentences":[]}'); }
  catch(e){ return {words:[], sentences:[]}; }
}
function saveSaved(obj){
  localStorage.setItem(LS_KEY, JSON.stringify(obj));
}
function addSavedSentence(en, zh){
  const s = loadSaved();
  const key = (en||"").trim();
  if(!key) return;
  if(!s.sentences.some(x=>x.en===key)){
    s.sentences.unshift({en:key, zh: (zh||"").trim(), ts: Date.now()});
    if(s.sentences.length>200) s.sentences.length=200;
    saveSaved(s);
  }
}
function addSavedWord(w, zh){
  const s = loadSaved();
  const key = (w||"").trim().toLowerCase();
  if(!key) return;
  if(!s.words.some(x=>x.w===key)){
    s.words.unshift({w:key, zh:(zh||"").trim(), ts: Date.now()});
    if(s.words.length>400) s.words.length=400;
    saveSaved(s);
  }
}

/* ---------- fetch json ---------- */
async function fetchJson(url){
  const res = await fetch(url, {cache:"no-store"});
  if(!res.ok) throw new Error(`Fetch failed: ${res.status} ${url}`);
  return await res.json();
}

/* ---------- TTS ---------- */
function speak(text, lang){
  if(!text) return;
  try{
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = lang || "en-US";
    u.rate = 1.0;
    u.pitch = 1.0;
    u.onstart = ()=>{ speaking=true; setAvatarState('speaking'); };
    u.onend = ()=>{ speaking=false; setAvatarState('idle'); };
    speechSynthesis.speak(u);
  }catch(e){
    console.warn(e);
  }
}

/* ---------- Speech Recognition ---------- */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let rec = null;

function ensureRec(){
  if(!SpeechRecognition) return null;
  if(rec) return rec;
  rec = new SpeechRecognition();
  rec.lang = "en-US";
  rec.interimResults = false;
  rec.maxAlternatives = 1;
  return rec;
}

function norm(s){
  return String(s||"").toLowerCase().replace(/[^a-z0-9\s']/g,' ').replace(/\s+/g,' ').trim();
}

function countWords(s){
  const t = norm(s);
  if(!t) return 0;
  return t.split(" ").filter(Boolean).length;
}

/* ---------- Helpers UI (Tasks / Examples / Translate / Saved) ---------- */
function openSheet(kind){
  // active state
  [UI.hTasks, UI.hExamples, UI.hTranslate, UI.hSaved].forEach(b=>b.classList.remove("active"));
  if(kind==="tasks") UI.hTasks.classList.add("active");
  if(kind==="examples") UI.hExamples.classList.add("active");
  if(kind==="translate") UI.hTranslate.classList.add("active");
  if(kind==="saved") UI.hSaved.classList.add("active");

  UI.sheetTitle.textContent =
    kind==="tasks" ? "ä»»å‹™ / å–®å­—" :
    kind==="examples" ? "ç¯„ä¾‹" :
    kind==="translate" ? "ç¿»è­¯" : "å·²å„²å­˜";

  UI.sheetBody.innerHTML = "";
  if(kind==="tasks") renderTasks();
  if(kind==="examples") renderExamples();
  if(kind==="translate") renderTranslate();
  if(kind==="saved") renderSaved();

  UI.sheetMask.style.display = "block";
  UI.sheet.style.display = "block";
}
function closeSheet(){
  UI.sheetMask.style.display = "none";
  UI.sheet.style.display = "none";
  [UI.hTasks, UI.hExamples, UI.hTranslate, UI.hSaved].forEach(b=>b.classList.remove("active"));
}
UI.sheetMask.addEventListener("click", closeSheet);
UI.sheetClose.addEventListener("click", closeSheet);

UI.hTasks.addEventListener("click", ()=>openSheet("tasks"));
UI.hExamples.addEventListener("click", ()=>openSheet("examples"));
UI.hTranslate.addEventListener("click", ()=>openSheet("translate"));
UI.hSaved.addEventListener("click", ()=>openSheet("saved"));

function renderTasks(){
  const h = (SCRIPT && SCRIPT.helpers) ? SCRIPT.helpers : null;
  const tasks = h && Array.isArray(h.tasks) ? h.tasks : [];
  const vocab = h && Array.isArray(h.vocab) ? h.vocab : [];

  const sec1 = document.createElement("div");
  sec1.className = "section";
  sec1.innerHTML = `<div class="secTitle">å¯é¸ä»»å‹™</div>` +
    (tasks.length
      ? `<ol class="list">${tasks.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ol>`
      : `<div class="muted">æ­¤ä¸»é¡Œå°šæœªæä¾›ä»»å‹™ï¼ˆå¯åœ¨ JSON çš„ helpers.tasks è£œä¸Šï¼‰ã€‚</div>`);
  UI.sheetBody.appendChild(sec1);

  const sec2 = document.createElement("div");
  sec2.className = "section";
  sec2.innerHTML = `<div class="secTitle">ä¸»è¦å–®å­—</div>` +
    (vocab.length
      ? `<div>${vocab.map(v=>{
          const w = escapeHtml(v.w||"");
          const zh = escapeHtml(v.zh||"");
          return `<span class="pill" title="é»æˆ‘å„²å­˜å–®å­—" data-w="${w}" data-zh="${zh}">${w}${zh?` Â· ${zh}`:""}</span>`;
        }).join("")}</div>
         <div class="muted" style="margin-top:10px">æç¤ºï¼šé»å–®å­—å¯åŠ å…¥ã€Œå·²å„²å­˜ã€ã€‚</div>`
      : `<div class="muted">æ­¤ä¸»é¡Œå°šæœªæä¾›å–®å­—ï¼ˆå¯åœ¨ JSON çš„ helpers.vocab è£œä¸Šï¼‰ã€‚</div>`);
  UI.sheetBody.appendChild(sec2);

  // bind pill save
  sec2.querySelectorAll(".pill").forEach(el=>{
    el.addEventListener("click", ()=>{
      addSavedWord(el.getAttribute("data-w"), el.getAttribute("data-zh"));
      el.style.borderColor = "rgba(40,209,124,.45)";
    });
  });
}

function renderExamples(){
  const h = (SCRIPT && SCRIPT.helpers) ? SCRIPT.helpers : null;
  const ex = h && Array.isArray(h.examples) ? h.examples : [];

  const sec = document.createElement("div");
  sec.className = "section";
  sec.innerHTML = `<div class="secTitle">ç¯„ä¾‹å¥ï¼ˆé» ğŸ”Š å¯æœ—è®€ï¼Œé» â­ å¯å„²å­˜ï¼‰</div>`;
  if(!ex.length){
    sec.innerHTML += `<div class="muted">æ­¤ä¸»é¡Œå°šæœªæä¾›ç¯„ä¾‹ï¼ˆå¯åœ¨ JSON çš„ helpers.examples è£œä¸Šï¼‰ã€‚</div>`;
  }else{
    ex.forEach((e, i)=>{
      const row = document.createElement("div");
      row.className = "exRow";
      const en = (e.en||"").trim();
      const zh = (e.zh||"").trim();
      row.innerHTML = `
        <div class="exMain">
          <p class="exEn">${escapeHtml(en)}</p>
          <p class="exZh">${escapeHtml(zh)}</p>
        </div>
        <div class="miniBtns">
          <div class="mini" title="æœ—è®€" data-act="speak">ğŸ”Š</div>
          <div class="mini" title="å„²å­˜" data-act="save">â­</div>
        </div>`;
      row.querySelector('[data-act="speak"]').addEventListener("click", ()=> speak(en, "en-US"));
      row.querySelector('[data-act="save"]').addEventListener("click", ()=>{
        addSavedSentence(en, zh);
        row.style.opacity = "0.95";
      });
      sec.appendChild(row);
    });
  }
  UI.sheetBody.appendChild(sec);
}

function renderTranslate(){
  const sec = document.createElement("div");
  sec.className = "section";
  sec.innerHTML = `
    <div class="secTitle">ç”¨ä½ çš„æ¯èªè¼¸å…¥æƒ³æ³•</div>
    <textarea id="trIn" class="textarea" placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³è¦ä¸€æ¯ä¸­æ¯å†°æ‹¿éµï¼Œä¸è¦ç³–ã€‚"></textarea>
    <div class="row2">
      <button class="btn primary" id="btnTr">ç¿»è­¯</button>
      <button class="btn" id="btnTrSave">å„²å­˜å¥å­</button>
    </div>
    <div class="section" style="margin-top:12px">
      <div class="secTitle">ç¿»è­¯çµæœï¼ˆEnglishï¼‰</div>
      <div id="trOut" class="muted">â€”</div>
      <div class="row2" style="margin-top:10px">
        <button class="btn" id="btnTrSpeak">ğŸ”Š æœ—è®€</button>
        <button class="btn" id="btnTrCopy">è¤‡è£½</button>
      </div>
      <div class="muted" style="margin-top:10px">
        æç¤ºï¼šè‹¥è¦ã€ŒçœŸæ­£è‡ªå‹•ç¿»è­¯ã€ï¼Œè«‹åœ¨ talk_A.html å…§è¨­å®š TRANSLATE_ENDPOINTï¼ˆä½ çš„ Supabase Edge Functionï¼‰ã€‚
        æœªè¨­å®šæ™‚ï¼Œé€™è£¡æœƒç”¨ç°¡æ˜“æç¤ºæ–¹å¼ã€‚
      </div>
    </div>
  `;
  UI.sheetBody.appendChild(sec);

  const trIn = sec.querySelector("#trIn");
  const trOut = sec.querySelector("#trOut");
  const btnTr = sec.querySelector("#btnTr");
  const btnTrSave = sec.querySelector("#btnTrSave");
  const btnTrSpeak = sec.querySelector("#btnTrSpeak");
  const btnTrCopy = sec.querySelector("#btnTrCopy");

  let lastOut = "";

  async function doTranslate(){
    const txt = (trIn.value||"").trim();
    if(!txt){ trOut.textContent = "è«‹å…ˆè¼¸å…¥å…§å®¹ã€‚"; return; }

    // If endpoint configured, call it.
    if(TRANSLATE_ENDPOINT){
      trOut.textContent = "ç¿»è­¯ä¸­â€¦";
      try{
        const res = await fetch(TRANSLATE_ENDPOINT, {
          method:"POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({text: txt, target:"en"})
        });
        const j = await res.json();
        lastOut = (j.translated || j.text || "").trim();
        trOut.textContent = lastOut || "(ç©ºç™½çµæœ)";
        return;
      }catch(e){
        trOut.textContent = "ç¿»è­¯å¤±æ•—ï¼ˆendpoint éŒ¯èª¤ï¼‰ã€‚";
        return;
      }
    }

    // Fallback (no API): gentle helper
    lastOut = "";
    trOut.innerHTML =
      `<div class="muted">å°šæœªè¨­å®šç¿»è­¯æœå‹™ã€‚ä½ å¯ä»¥å…ˆç”¨ã€Œç¯„ä¾‹ã€å¥å‹æ‹¼å‡ºè‹±æ–‡ï¼Œæˆ–æŠŠä¸­æ–‡ç°¡åŒ–å¾Œç›´æ¥å£èªªã€‚</div>
       <div style="margin-top:8px" class="muted">å»ºè­°ä½ è©¦è¬›ï¼š<b>I would like ...</b> / <b>Can I get ...</b> / <b>Medium, iced, please.</b></div>`;
  }

  btnTr.addEventListener("click", doTranslate);

  btnTrSave.addEventListener("click", ()=>{
    if(lastOut){
      addSavedSentence(lastOut, (trIn.value||"").trim());
      btnTrSave.textContent = "å·²å„²å­˜ âœ…";
      setTimeout(()=>btnTrSave.textContent="å„²å­˜å¥å­", 900);
    }else{
      addSavedSentence((trIn.value||"").trim(), "");
      btnTrSave.textContent = "å·²å„²å­˜ âœ…";
      setTimeout(()=>btnTrSave.textContent="å„²å­˜å¥å­", 900);
    }
  });

  btnTrSpeak.addEventListener("click", ()=>{
    if(lastOut) speak(lastOut, "en-US");
  });

  btnTrCopy.addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(lastOut || trIn.value || "");
      btnTrCopy.textContent = "å·²è¤‡è£½ âœ…";
      setTimeout(()=>btnTrCopy.textContent="è¤‡è£½", 900);
    }catch(e){
      btnTrCopy.textContent = "è¤‡è£½å¤±æ•—";
      setTimeout(()=>btnTrCopy.textContent="è¤‡è£½", 900);
    }
  });
}

function renderSaved(){
  const s = loadSaved();
  const sec1 = document.createElement("div");
  sec1.className = "section";
  sec1.innerHTML = `<div class="secTitle">å¥å­ <span style="opacity:.75">(${s.sentences.length})</span></div>`;
  if(!s.sentences.length){
    sec1.innerHTML += `<div class="muted">é‚„æ²’æœ‰å„²å­˜ä»»ä½•å¥å­ï¼ˆåœ¨ã€Œç¯„ä¾‹ã€æˆ–ã€Œç¿»è­¯ã€å¯å„²å­˜ï¼‰ã€‚</div>`;
  }else{
    s.sentences.slice(0,80).forEach(item=>{
      const row = document.createElement("div");
      row.className = "exRow";
      row.innerHTML = `
        <div class="exMain">
          <p class="exEn">${escapeHtml(item.en)}</p>
          <p class="exZh">${escapeHtml(item.zh||"")}</p>
        </div>
        <div class="miniBtns">
          <div class="mini" title="æœ—è®€">ğŸ”Š</div>
        </div>`;
      row.querySelector(".mini").addEventListener("click", ()=> speak(item.en, "en-US"));
      sec1.appendChild(row);
    });
  }
  UI.sheetBody.appendChild(sec1);

  const sec2 = document.createElement("div");
  sec2.className = "section";
  sec2.innerHTML = `<div class="secTitle">å–®å­— <span style="opacity:.75">(${s.words.length})</span></div>`;
  if(!s.words.length){
    sec2.innerHTML += `<div class="muted">é‚„æ²’æœ‰å„²å­˜ä»»ä½•å–®å­—ï¼ˆåœ¨ã€Œä»»å‹™/å–®å­—ã€é»å–®å­—å¯å„²å­˜ï¼‰ã€‚</div>`;
  }else{
    sec2.innerHTML += `<div>${s.words.slice(0,160).map(v=>{
      const w = escapeHtml(v.w);
      const zh = escapeHtml(v.zh||"");
      return `<span class="pill">${w}${zh?` Â· ${zh}`:""}</span>`;
    }).join("")}</div>`;
  }
  sec2.innerHTML += `
    <div class="row2" style="margin-top:12px">
      <button class="btn" id="btnClearSaved">æ¸…ç©ºå·²å„²å­˜</button>
      <button class="btn primary" id="btnExportSaved">åŒ¯å‡º JSON</button>
    </div>`;
  UI.sheetBody.appendChild(sec2);

  sec2.querySelector("#btnClearSaved").addEventListener("click", ()=>{
    if(confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å·²å„²å­˜å…§å®¹ï¼Ÿ")){
      saveSaved({words:[], sentences:[]});
      renderSaved(); // rerender
      openSheet("saved");
    }
  });
  sec2.querySelector("#btnExportSaved").addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(loadSaved(), null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "bookwide_saved.json";
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  });
}

/* ---------- Report overlay ---------- */
function openReport(finalReviewText){
  const title = (SCRIPT && SCRIPT.title) ? SCRIPT.title : (INDEX && INDEX.scenes ? (INDEX.scenes.find(s=>s.key===UI.sceneSel.value)||{}).title : "");
  UI.topicName.textContent = title || UI.sceneSel.value || "-";

  // compute metrics
  const t = metrics.totalTurns || 1;
  const topic = Math.round((metrics.topicHits / t) * 100);
  const pron = Math.round((metrics.approxPronOK / t) * 100);
  const words = metrics.userWords || 0;

  UI.mTopic.textContent = `${topic}%`;
  UI.mPron.textContent = `${pron}%`;
  UI.mWords.textContent = `${words}`;

  UI.reviewBox.textContent = (finalReviewText || "").trim() || "å»ºè­°ï¼šä¸‹æ¬¡æŠŠã€Œå°ºå¯¸ + å†°ç†± + å“é …ã€é€£æˆä¸€å¥ï¼šI'd like an iced medium latte, please.";

  UI.reportMask.style.display = "block";
  UI.report.style.display = "block";
}
function closeReport(){
  UI.reportMask.style.display = "none";
  UI.report.style.display = "none";
}
UI.reportMask.addEventListener("click", closeReport);
UI.reportCloseX.addEventListener("click", closeReport);
UI.btnContinue.addEventListener("click", closeReport);
UI.btnChatLog.addEventListener("click", ()=>{
  // show log only
  closeReport();
  UI.log.scrollIntoView({behavior:"smooth", block:"start"});
});

/* ---------- Script engine ---------- */
function setHint(msg){
  if(!msg){ UI.hint.style.display="none"; UI.hint.textContent=""; return; }
  UI.hint.textContent = msg;
  UI.hint.style.display="block";
}

function setChoices(options, onPick){
  UI.choices.innerHTML = "";
  if(!options || !options.length) return;
  options.forEach(opt=>{
    const b = document.createElement("div");
    b.className = "chip";
    b.textContent = opt;
    b.onclick = ()=> onPick(opt);
    UI.choices.appendChild(b);
  });
}

function getStep(id){
  return stepsById[id] || null;
}

function gotoStep(id){
  currentId = id || "";
  renderCurrent();
}

function renderCurrent(){
  const step = getStep(currentId);
  if(!step){
    UI.statusText.textContent = "Done";
    UI.stepText.textContent = "-";
    UI.sentence.textContent = "Done.";
    setHint("");
    UI.btnDone.style.display = "inline-flex";
    UI.btnNext.style.display = "none";
    setAvatarState("positive");
    return;
  }

  UI.stepText.textContent = step.id || "-";
  UI.statusText.textContent = step.type || "step";

  // show content
  UI.sentence.textContent = step.text || "â€¦";
  UI.subtitle.textContent = step.zh || step.subtitle || "";

  // avatar
  const url = step.avatar_url || (SCRIPT && SCRIPT.avatar_url) || "";
  if(url){
    UI.avatarImg.src = url;
    UI.avatarImg.style.display = "";
    UI.avatarFallback.style.display = "none";
  }else{
    UI.avatarImg.style.display = "none";
    UI.avatarFallback.style.display = "";
    UI.avatarFallback.textContent = (SCRIPT && SCRIPT.persona && SCRIPT.persona.name) ? SCRIPT.persona.name.slice(0,2) : "AI";
  }

  // speech
  setHint("");
  setChoices(null, ()=>{});

  if(step.type === "ai_hint"){
    setHint(step.text || "");
    // hint steps usually repeat target
    if(step.repeat) UI.btnNext.textContent = "è¿”å›";
    else UI.btnNext.textContent = "ä¸‹ä¸€å¥";
    UI.btnDone.style.display = "none";
    UI.btnNext.style.display = "inline-flex";
    speak(step.text || "", "en-US");
    return;
  }

  if(step.type === "ai_say"){
    UI.btnNext.textContent = "è·³é";
    UI.btnDone.style.display = "none";
    UI.btnNext.style.display = "inline-flex";

    // choices mode?
    const exp = step.expect || {};
    if(exp.mode === "choice" && Array.isArray(exp.options) && exp.options.length){
      setChoices(exp.options, (picked)=>{
        // treat as user response
        handleUser(picked, {forced:true});
      });
    }
    // auto TTS
    speak(step.text || "", "en-US");
    return;
  }
}

function nextFromStep(step, ok){
  if(!step) return;
  if(ok && step.on_success) return step.on_success;
  if(!ok && step.on_fail) return step.on_fail;
  // fallback: next in array
  const arr = (SCRIPT && SCRIPT.steps) ? SCRIPT.steps : [];
  const idx = arr.findIndex(x=>x.id===step.id);
  if(idx>=0 && arr[idx+1]) return arr[idx+1].id;
  return "";
}

function checkExpect(step, transcript){
  const exp = step.expect || {};
  if(exp.mode === "none") return {ok:true, hit:false};
  const txt = norm(transcript);

  // update topic hits using keywords if given
  let hit = false;
  if(exp.keywords && Array.isArray(exp.keywords) && exp.keywords.length){
    const keys = exp.keywords.map(k=>norm(k));
    hit = keys.some(k=>k && txt.includes(k));
  }

  if(exp.mode === "choice"){
    const opts = (exp.options||[]).map(o=>norm(o));
    const ok = opts.some(o=>o && (txt===o || txt.includes(o)));
    return {ok, hit};
  }
  if(exp.mode === "free"){
    if(!exp.keywords || !exp.keywords.length) return {ok:!!txt, hit:false};
    // free: require at least one keyword
    const keys = exp.keywords.map(k=>norm(k));
    const ok = keys.some(k=>k && txt.includes(k));
    return {ok, hit};
  }
  // default
  return {ok: !!txt, hit};
}

function appendChat(role, text, zh){
  metrics.chat.push({role, text: String(text||""), zh: String(zh||""), ts: Date.now()});
}

function handleUser(transcript, opts={}){
  const step = getStep(currentId);
  if(!step) return;

  const userText = (transcript||"").trim();
  appendChat("user", userText, "");
  logLine(`You: ${userText}`);

  metrics.totalTurns += 1;
  metrics.userWords += countWords(userText);

  const {ok, hit} = checkExpect(step, userText);

  if(hit) metrics.topicHits += 1;
  if(ok) metrics.approxPronOK += 1;

  // feedback
  if(ok){
    setAvatarState("positive");
  }else{
    setAvatarState("encourage");
    const n = (failCount[step.id]||0)+1;
    failCount[step.id]=n;
    if(n>=2 && step.on_fail){
      // show hint if on_fail is hint
      // nothing extra here; engine will go there
    }
  }

  const nextId = nextFromStep(step, ok);
  gotoStep(nextId);

  // if end
  const nextStep = getStep(nextId);
  if(nextStep && nextStep.end){
    // show done button in UI on next render
  }
}

async function startListening(){
  if(speaking){
    speechSynthesis.cancel();
    speaking = false;
  }
  const r = ensureRec();
  if(!r){
    alert("æ­¤è£ç½®ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼ˆSpeechRecognitionï¼‰ã€‚è«‹æ”¹ç”¨ Chrome / Edgeï¼Œæˆ–ç”¨é¸é …æŒ‰éˆ•ä½œç­”ã€‚");
    return;
  }
  setAvatarState("listening");
  UI.statusText.textContent = "Listeningâ€¦";

  return new Promise((resolve)=>{
    let done = false;
    r.onresult = (e)=>{
      if(done) return;
      done = true;
      const transcript = (e.results && e.results[0] && e.results[0][0] && e.results[0][0].transcript) ? e.results[0][0].transcript : "";
      resolve(transcript);
    };
    r.onerror = ()=>{
      if(done) return;
      done = true;
      resolve("");
    };
    r.onend = ()=>{
      if(done) return;
      done = true;
      resolve("");
    };
    try{ r.start(); }catch(err){ resolve(""); }
  });
}

/* ---------- Scene load ---------- */
async function boot(){
  UI.log.textContent = "";
  logLine("Loading index.json â€¦");
  try{
    INDEX = await fetchJson(`${BASE}/index.json`);
  }catch(e){
    // fallback if index.json missing
    INDEX = {
      default: "coffee_shop",
      scenes: [
        {key:"coffee_shop", title:"è²·ä¸€æ¯å’–å•¡", level:"A1"},
        {key:"hotel_checkin", title:"é£¯åº—å…¥ä½", level:"A1"},
        {key:"airport", title:"æ©Ÿå ´å•è·¯", level:"A2"},
        {key:"restaurant_order", title:"é¤å»³é»é¤", level:"A1"},
        {key:"business_meeting", title:"å•†å‹™æœƒè­°", level:"B1"},
      ]
    };
    logLine("âš ï¸ æ‰¾ä¸åˆ° ./talk/index.jsonï¼Œå·²ä½¿ç”¨å…§å»ºæ¸…å–®ï¼ˆè«‹ç¢ºèªæª”æ¡ˆè·¯å¾‘ï¼‰ã€‚");
  }

  UI.sceneSel.innerHTML = "";
  (INDEX.scenes||[]).forEach(s=>{
    const opt = document.createElement("option");
    opt.value = s.key;
    opt.textContent = `${s.title} (${s.level})`;
    UI.sceneSel.appendChild(opt);
  });

  const qs = new URLSearchParams(location.search);
  const key = qs.get("scene") || INDEX.default || (INDEX.scenes[0] && INDEX.scenes[0].key) || "coffee_shop";
  UI.sceneSel.value = key;

  UI.sceneSel.onchange = ()=> loadScene(UI.sceneSel.value);

  await loadScene(key);
}

async function loadScene(sceneKey){
  UI.log.textContent = "";
  metrics = { totalTurns:0, topicHits:0, userWords:0, approxPronOK:0, chat:[] };
  try{
    SCRIPT = await fetchJson(`${BASE}/${sceneKey}.json`);
    stepsById = Object.fromEntries((SCRIPT.steps||[]).map(s=>[s.id,s]));
    failCount = {};
    currentId = (SCRIPT.steps && SCRIPT.steps[0] && SCRIPT.steps[0].id) ? SCRIPT.steps[0].id : "";

    UI.badge.textContent = `${SCRIPT.persona?.name || "AI"} Â· ${SCRIPT.persona?.role || "teacher"}`;
    logLine(`== ${SCRIPT.scene || sceneKey} ==`);
    logLine((SCRIPT.description||"").trim());
    logLine("");

    // avatar url (scene-level)
    const url = SCRIPT.avatar_url || "";
    if(url){
      UI.avatarImg.src = url;
      UI.avatarImg.style.display = "";
      UI.avatarFallback.style.display = "none";
    }else{
      UI.avatarImg.style.display = "none";
      UI.avatarFallback.style.display = "";
      UI.avatarFallback.textContent = (SCRIPT.persona?.name ? SCRIPT.persona.name.slice(0,2) : "AI");
    }

    // update top line
    UI.metaLine.textContent = `TTSï¼šBrowser SpeechSynthesis Â· æƒ…å¢ƒï¼š${(INDEX.scenes.find(s=>s.key===sceneKey)||{}).title || sceneKey}`;

    // initial render
    setAvatarState("idle");
    UI.btnDone.style.display = "none";
    UI.btnNext.style.display = "inline-flex";
    UI.btnNext.textContent = "è·³é";
    renderCurrent();
  }catch(e){
    console.error(e);
    UI.sentence.textContent = "è¼‰å…¥å¤±æ•—ï¼šæ‰¾ä¸åˆ°æƒ…å¢ƒ JSON";
    UI.subtitle.textContent = `è«‹ç¢ºèªï¼š${BASE}/${sceneKey}.json æ˜¯å¦å­˜åœ¨`;
    logLine("ERROR: " + e.message);
  }
}

/* ---------- Buttons ---------- */
UI.btnMic.addEventListener("click", async ()=>{
  const step = getStep(currentId);
  if(!step) return;
  if(step.type !== "ai_say"){
    // allow listen anyway
  }
  const transcript = await startListening();
  if(!transcript){
    setAvatarState("encourage");
    setHint("æˆ‘æ²’è½æ¸…æ¥šï½å†èªªä¸€æ¬¡æˆ–ç”¨é¸é …æŒ‰éˆ•ã€‚");
    return;
  }
  setAvatarState("idle");
  handleUser(transcript);
});

UI.btnNext.addEventListener("click", ()=>{
  const step = getStep(currentId);
  if(!step){ return; }
  // jump logic: if hint has repeat, go back
  if(step.type==="ai_hint" && step.repeat){
    gotoStep(step.repeat);
    return;
  }
  // otherwise go to next regardless
  const nextId = nextFromStep(step, true);
  gotoStep(nextId);
});

UI.btnReplay.addEventListener("click", ()=>{
  const step = getStep(currentId);
  if(!step) return;
  if(step.text) speak(step.text, "en-US");
});

UI.btnReload.addEventListener("click", ()=>{
  loadScene(UI.sceneSel.value);
});

UI.btnDone.addEventListener("click", ()=>{
  // show report
  const review = findReviewText();
  openReport(review);
});

function findReviewText(){
  // find last ai_hint with "Review" or any ai_hint near end
  const arr = (SCRIPT && SCRIPT.steps) ? SCRIPT.steps : [];
  for(let i=arr.length-1;i>=0;i--){
    const s = arr[i];
    if(s && s.type==="ai_hint" && (s.text||"").trim()){
      return s.text;
    }
  }
  return "";
}

/* When we reach a step with end:true, auto-open report after it speaks */
const _origGotoStep = gotoStep;
gotoStep = function(id){
  _origGotoStep(id);
  const step = getStep(currentId);
  if(step && step.end){
    appendChat("ai", step.text||"", step.zh||"");
    logLine(`AI: ${step.text||""}`);
    // also save this final sentence optionally
    addSavedSentence(step.text||"", step.zh||"");
    // open report a bit later
    setTimeout(()=>{
      openReport(findReviewText());
    }, 650);
  }else if(step && step.type==="ai_say"){
    appendChat("ai", step.text||"", step.zh||"");
    logLine(`AI: ${step.text||""}`);
  }else if(step && step.type==="ai_hint"){
    logLine(`Hint: ${step.text||""}`);
  }
};

boot();
  </script>
</body>
</html>
