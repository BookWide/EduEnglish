<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Talk Aï½œBookWide</title>
  <style>
    :root{
      --bg:#ffffff;
      --ink:#0b1220;
      --muted:#5b667a;
      --line:#e6eaf0;
      --soft:#f6f8fb;
      --pill:#111827;
      --pillText:#ffffff;
      --shadow:0 10px 28px rgba(10,20,40,.10);
      --radius:18px;
      --radius2:24px;
      --btn:#0b66ff;
      --btn2:#084fc6;
      --ok:#0f766e;
      --warn:#b91c1c;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      background:var(--bg);
      color:var(--ink);
      overflow:hidden;
    }
    a{color:inherit}
    .app{
      height:100%;
      display:flex;
      flex-direction:column;
      padding:12px 12px calc(12px + env(safe-area-inset-bottom));
      gap:10px;
      max-width:980px;
      margin:0 auto;
    }

    /* Top bar */
    .top{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:999px;
      background:#fff;
      box-shadow:var(--shadow);
    }
    .back{
      width:36px;height:36px;border-radius:999px;border:1px solid var(--line);
      background:#fff;display:grid;place-items:center;cursor:pointer;
      flex:0 0 auto;
    }
    .title{
      display:flex;flex-direction:column;gap:2px;min-width:0;
    }
    .title b{font-size:15px;line-height:1.1}
    .title small{font-size:12px;color:var(--muted)}
    .spacer{flex:1}
    .scenario{
      display:flex;align-items:center;gap:8px;
      border:1px solid var(--line);
      border-radius:999px;
      padding:8px 10px;
      background:var(--soft);
      min-width:220px;
      max-width:420px;
    }
    .scenario select{
      width:100%;
      border:0;
      background:transparent;
      font-size:14px;
      outline:none;
      color:var(--ink);
      appearance:none;
    }
    .btn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:8px 10px;
      cursor:pointer;
      font-size:13px;
      white-space:nowrap;
    }

    /* Main stage */
    .stage{
      flex:1;
      min-height:0;
      border:1px solid var(--line);
      border-radius:var(--radius2);
      background:#fff;
      box-shadow:var(--shadow);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .who{
      display:flex;align-items:center;gap:10px;
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      background:var(--pill);
      color:var(--pillText);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
    }
    .statusDot{
      width:8px;height:8px;border-radius:99px;background:#94a3b8;
    }
    .statusDot.on{background:#10b981}
    .who small{color:var(--muted)}
    .center{
      display:grid;
      place-items:center;
      padding:8px 0 2px;
    }

    /* Avatar (simple lip animation) */
    .avatarWrap{
      width:min(260px,70vw);
      aspect-ratio:1/1;
      border-radius:999px;
      background:radial-gradient(circle at 30% 30%, #e9eef7, #ffffff 55%, #e9eef7);
      border:1px solid var(--line);
      box-shadow:0 20px 60px rgba(10,20,40,.12) inset;
      display:grid;
      place-items:center;
      position:relative;
      overflow:hidden;
    }
    .avatarImg{
      width:62%;
      height:62%;
      border-radius:18px;
      object-fit:cover;
      border:1px solid var(--line);
      background:#fff;
      box-shadow:0 10px 30px rgba(10,20,40,.10);
    }
    .mouth{
      position:absolute;
      width:42px;height:22px;
      border:2px solid rgba(15,23,42,.55);
      border-top:0;
      border-radius:0 0 30px 30px;
      bottom:32%;
      left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,0);
      opacity:.55;
    }
    .speaking .mouth{
      animation:talk .13s infinite alternate ease-in-out;
      opacity:.8;
    }
    @keyframes talk{
      from{height:8px}
      to{height:22px}
    }

    /* Dialog line */
    .dialog{
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      background:var(--soft);
    }
    .dialog .en{
      font-size:22px;
      line-height:1.35;
      font-weight:800;
      letter-spacing:.2px;
    }
    .dialog .zh{
      margin-top:6px;
      font-size:13px;
      color:var(--muted);
      line-height:1.4;
    }

    /* Controls */
    .controls{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .micRow{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .micBtn{
      flex:1;
      border:0;
      background:linear-gradient(180deg,var(--btn),var(--btn2));
      color:#fff;
      border-radius:999px;
      padding:14px 16px;
      font-weight:800;
      font-size:15px;
      cursor:pointer;
      box-shadow:0 14px 30px rgba(11,102,255,.25);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .skipBtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:14px 16px;
      font-weight:700;
      cursor:pointer;
      min-width:96px;
    }
    .helperRow{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:10px;
    }
    .helperBtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:var(--radius);
      padding:12px 10px;
      text-align:left;
      cursor:pointer;
      min-height:62px;
      box-shadow:0 8px 18px rgba(10,20,40,.06);
    }
    .helperBtn b{display:block;font-size:14px}
    .helperBtn small{display:block;margin-top:4px;color:var(--muted);font-size:12px}

    .note{
      border:1px dashed var(--line);
      border-radius:var(--radius);
      padding:10px 12px;
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
      background:#fff;
    }

    /* Bottom sheet */
    .sheetMask{
      position:fixed;inset:0;
      background:rgba(0,0,0,.28);
      display:none;
      z-index:50;
    }
    .sheetMask.show{display:block}
    .sheet{
      position:fixed;
      left:0;right:0;
      bottom:0;
      background:#fff;
      border-radius:18px 18px 0 0;
      border:1px solid var(--line);
      box-shadow:0 -24px 60px rgba(10,20,40,.18);
      max-width:980px;
      margin:0 auto;
      max-height:78vh;
      transform:translateY(110%);
      transition:transform .22s ease;
      z-index:51;
      overflow:hidden;
    }
    .sheet.show{transform:translateY(0)}
    .sheetHead{
      display:flex;align-items:center;gap:10px;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background:var(--soft);
    }
    .grab{
      width:42px;height:5px;border-radius:99px;background:#cfd6e3;margin:0 auto;
    }
    .sheetTitle{font-weight:900}
    .sheetClose{
      margin-left:auto;
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:800;
      font-size:13px;
    }
    .sheetBody{
      padding:14px;
      overflow:auto;
      max-height:calc(78vh - 52px);
    }
    .card{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:#fff;
      margin-bottom:10px;
    }
    .card h3{margin:0 0 8px 0;font-size:14px}
    .card p{margin:0;color:var(--muted);line-height:1.5}
    .list{margin:0;padding-left:18px;color:var(--muted);line-height:1.55}
    .tag{
      display:inline-flex;align-items:center;
      padding:4px 8px;border-radius:999px;
      background:var(--soft);
      border:1px solid var(--line);
      font-size:12px;color:var(--muted);
      margin-right:6px;margin-bottom:6px;
    }
    .row{
      display:flex;flex-wrap:wrap;gap:8px;
    }
    .mini{
      font-size:12px;color:var(--muted)
    }
    .warn{
      color:var(--warn);
      font-weight:800;
      font-size:12px;
    }

    /* Start audio gate */
    .gate{
      position:fixed;inset:0;
      background:rgba(255,255,255,.92);
      display:none;
      z-index:80;
      padding:22px;
    }
    .gate.show{display:flex;align-items:center;justify-content:center}
    .gateBox{
      width:min(520px,92vw);
      border:1px solid var(--line);
      border-radius:18px;
      background:#fff;
      box-shadow:var(--shadow);
      padding:16px;
      text-align:center;
    }
    .gateBox h2{margin:6px 0 8px 0;font-size:18px}
    .gateBox p{margin:0 0 12px 0;color:var(--muted);line-height:1.5}
    .gateBox button{
      border:0;background:linear-gradient(180deg,var(--btn),var(--btn2));
      color:#fff;border-radius:999px;padding:12px 16px;font-weight:900;cursor:pointer;
      width:100%;
    }

    /* Mobile tweaks */
    @media (max-width:520px){
      .scenario{min-width:0;max-width:none}
      .dialog .en{font-size:20px}
      .helperRow{grid-template-columns:repeat(4,1fr);gap:8px}
      .helperBtn{padding:10px 8px;min-height:58px}
      .helperBtn b{font-size:13px}
      .helperBtn small{font-size:11px}
      .micBtn{font-size:14px;padding:13px 14px}
      .skipBtn{padding:13px 14px}
    }
  
/* ===== Patch: 3 teachers video avatar (2026-01-06) ===== */
video.avatarImg{object-fit:cover;}
.avatarWrap{height:min(30vh,260px)!important;}
body{overflow:hidden;}
</style>
</head>
<body>
  <div class="app">

    <div class="top">
      <button class="back" id="btnBack" aria-label="back">â†</button>

      <div class="title">
        <b>Talk Aï¼ˆæ‰‹æ©Ÿå£èªªï¼‰</b>
        <small id="subTitle">TTSï¼šBrowser SpeechSynthesis</small>
      </div>

      <div class="spacer"></div>

      <div class="scenario" title="é¸æ“‡æƒ…å¢ƒ">
        <select id="sceneSelect"></select>
          <select id="teacherSelect" class="chipSelect" title="é¸æ“‡è€å¸«">
            <option value="pineapple">Pineapple</option>
            <option value="lychee">Lychee</option>
            <option value="mermaid">Mermaid</option>
          </select>
      </div>

      <button class="btn" id="btnReplay">é‡æ’­æœ¬å¥</button>
    </div>

    <div class="stage">
      <div class="who">
        <span class="pill"><span class="statusDot" id="dot"></span><span id="roleLabel">AI Â· teacher</span></span>
        <small id="sceneLabel">â€”</small>
      </div>

      <div class="center">
        <div class="avatarWrap" id="avatarWrap">
          <video class="avatarImg" id="avatarVid" alt="AI Avatar" / class="avatarImg" playsinline muted preload="metadata"></video>
          <div class="mouth" aria-hidden="true"></div>
        </div>
      </div>

      <div class="dialog" id="dialogBox">
        <div class="en" id="lineEN">Loadingâ€¦</div>
        <div class="zh" id="lineZH">ï¼ˆè¼‰å…¥ä¸­â€¦ï¼‰</div>
      </div>

      <div class="controls">
        <div class="micRow">
          <button class="micBtn" id="btnMic">ğŸ¤ é»æˆ‘èªªï¼ˆé–‹å§‹è¾¨è­˜ï¼‰</button>
          <button class="skipBtn" id="btnSkip">è·³é</button>
        </div>

        <div class="helperRow">
          <button class="helperBtn" id="btnTask"><b>ä»»å‹™</b><small>è¦åšä»€éº¼</small></button>
          <button class="helperBtn" id="btnExamples"><b>ç¯„ä¾‹</b><small>ä¸æœƒå¥</small></button>
          <button class="helperBtn" id="btnTranslate"><b>ç¿»è­¯</b><small>ä¸­ / æ—¥</small></button>
          <button class="helperBtn" id="btnSaved"><b>å·²å„²å­˜</b><small>å–®å­—å¥</small></button>
        </div>

        <div class="note" id="noteText">ä¸»é ä¿æŒåœ¨å°è©±ä¸­ï¼›é»ã€Œä»»å‹™ / ç¯„ä¾‹ / ç¿»è­¯ / å·²å„²å­˜ã€åªæœƒæ‰“é–‹è¼”åŠ©å°çª—ï¼Œä¸æœƒä¸­æ–·å°è©±ã€‚</div>
      </div>
    </div>
  </div>

  <!-- Bottom sheet -->
  <div class="sheetMask" id="sheetMask"></div>
  <div class="sheet" id="sheet">
    <div class="sheetHead">
      <div style="width:100%">
        <div class="grab"></div>
      </div>
      <button class="sheetClose" id="sheetClose">é—œé–‰</button>
    </div>
    <div class="sheetBody" id="sheetBody"></div>
  </div>

  <!-- Audio gate -->
  <div class="gate" id="gate">
    <div class="gateBox">
      <div class="mini">iPhone/éƒ¨åˆ†ç€è¦½å™¨æœƒé˜»æ“‹ã€Œè‡ªå‹•å‡ºè²ã€</div>
      <h2>é»ä¸€ä¸‹å•Ÿå‹•èªéŸ³</h2>
      <p>å•Ÿå‹•å¾Œï¼ŒAI æœƒã€Œä¸»å‹•å…ˆå‡ºè²ã€ï¼Œä¹‹å¾Œæ¯å¥éƒ½æœƒè‡ªå‹•æœ—è®€ã€‚</p>
      <button id="gateBtn">é–‹å§‹</button>
      <p class="mini" style="margin-top:10px">ï¼ˆåªè¦é»ä¸€æ¬¡ï¼Œä»¥å¾Œå°±ä¸ç”¨ï¼‰</p>
    </div>
  </div>

<script>
/* =========================
   Talk A (Rebuild) - 2026-01-04
   ç›®æ¨™ï¼šç™½åº•é»‘å­—ã€æ‰‹æ©Ÿå„ªå…ˆã€ä¸»ç•«é¢æ°¸é æ˜¯å°è©±ã€ä¸‹æ–¹æŠ½å±œè¼”åŠ©ã€ä¸æ›é ã€AI ä¸»å‹•å…ˆå‡ºè²
   ========================= */

(function(){
  const $ = (id)=>document.getElementById(id);

  // --- DOM ---
  const sceneSelect = $("sceneSelect");
  const roleLabel = $("roleLabel");
  const sceneLabel = $("sceneLabel");
  const avatarVid = $("avatarVid");
    const teacherSelect = $("teacherSelect");
  const avatarWrap = $("avatarWrap");
  const lineEN = $("lineEN");
  const lineZH = $("lineZH");
  const btnReplay = $("btnReplay");
  const btnMic = $("btnMic");
  const btnSkip = $("btnSkip");
  const dot = $("dot");

    /* ===== Teachers (video avatars) ===== */
    const TEACHERS = {
      pineapple: { key:"pineapple", label:"Pineapple", video:"https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/assets/avatars/Pineapple.mp4" },
      lychee:    { key:"lychee",    label:"Lychee",    video:"https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/assets/avatars/Lychee.mp4" },
      mermaid:   { key:"mermaid",   label:"Mermaid",   video:"https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/assets/avatars/mermaid.mp4" }
    };

    function normalizeTeacherKey(k){
      k = (k||"").toString().toLowerCase().trim();
      return TEACHERS[k] ? k : "pineapple";
    }

    let currentTeacherKey = normalizeTeacherKey(qs.get("teacher") || "pineapple");

    // video setup
    avatarVid.loop = false;
    avatarVid.muted = true; // allow autoplay after user gesture; keep safe
    avatarVid.playsInline = true;
    avatarVid.setAttribute("playsinline","");
    avatarVid.setAttribute("webkit-playsinline","");
    avatarVid.preload = "metadata";

    function resetAvatarToStart(){
      try{
        avatarVid.pause();
        const seek0 = ()=>{ try{ avatarVid.currentTime = 0; avatarVid.pause(); }catch(e){} };
        if(Number.isFinite(avatarVid.duration) && avatarVid.duration>0) seek0();
        else avatarVid.addEventListener("loadedmetadata", seek0, { once:true });
      }catch(e){}
    }

    function applyTeacher(){
      const t = TEACHERS[currentTeacherKey] || TEACHERS.pineapple;
      if(!teacherSelect) return;
      teacherSelect.value = t.key;

      // update pill label with scene role + teacher name
      const role = (window.__sceneRole || "teacher");
      roleLabel.textContent = `AI Â· ${role} Â· ${t.label}`;

      const prev = avatarVid.getAttribute("data-src");
      if(prev !== t.video){
        avatarVid.src = t.video;
        avatarVid.setAttribute("data-src", t.video);
        avatarVid.load();
      }
      resetAvatarToStart();
    }

    async function startTalkVideo(){
      try{
        // rewind if ended
        if(Number.isFinite(avatarVid.duration) && avatarVid.currentTime >= (avatarVid.duration-0.05)){
          avatarVid.currentTime = 0;
        }
        const p = avatarVid.play();
        if(p && typeof p.then==="function") await p;
      }catch(e){}
    }
    function stopTalkVideo(){
      try{ avatarVid.pause(); avatarVid.currentTime = 0; }catch(e){}
    }


  const sheetMask = $("sheetMask");
  const sheet = $("sheet");
  const sheetBody = $("sheetBody");
  const sheetClose = $("sheetClose");

  const btnTask = $("btnTask");
  const btnExamples = $("btnExamples");
  const btnTranslate = $("btnTranslate");
  const btnSaved = $("btnSaved");

  const gate = $("gate");
  const gateBtn = $("gateBtn");

  // --- State ---
  const BASE = getBasePath(); // for local or gh pages
  let indexData = null;
  let currentScene = null;
  let steps = [];
  let stepIdx = 0;

  let lastSpoken = "";
  let audioEnabled = false;

  // Speech recognition (if available)
  const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
  let rec = null;
  if (SpeechRec) {
    rec = new SpeechRec();
    rec.lang = "en-US";
    rec.interimResults = false;
    rec.maxAlternatives = 1;
  }

  // --- Utils ---
  function getBasePath(){
    const p = location.pathname;
    const dir = p.slice(0, p.lastIndexOf("/") + 1);
    return location.origin + dir;
  }

  function qs(name){
    const u = new URL(location.href);
    return u.searchParams.get(name);
  }
  function setQs(name, value){
    const u = new URL(location.href);
    u.searchParams.set(name, value);
    history.replaceState(null, "", u.toString());
  }

  function safeText(x){ return (x==null) ? "" : String(x); }
  function normalizeLower(s){ return safeText(s).trim().toLowerCase(); }
  function uniq(arr){ return Array.from(new Set(arr)); }
  function escapeHtml(str){
    return safeText(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }
  function delay(ms){ return new Promise(r=>setTimeout(r,ms)); }

  // --- Bottom sheet ---
  function openSheet(html){
    sheetBody.innerHTML = html;
    sheetMask.classList.add("show");
    sheet.classList.add("show");
  }
  function closeSheet(){
    sheetMask.classList.remove("show");
    sheet.classList.remove("show");
  }
  sheetMask.addEventListener("click", closeSheet);
  sheetClose.addEventListener("click", closeSheet);

  // --- Saved ---
  const SAVED_KEY = "BW_TALK_SAVED_V1";
  function readSaved(){
    try{ return JSON.parse(localStorage.getItem(SAVED_KEY) || "[]"); }
    catch(_){ return []; }
  }
  function writeSaved(items){
    localStorage.setItem(SAVED_KEY, JSON.stringify(items.slice(0,200)));
  }
  function savePhrase(phrase){
    const p = safeText(phrase).trim();
    if(!p) return;
    const items = readSaved();
    items.unshift({ text:p, t:Date.now(), scene: currentScene?.id || "" });
    const only = uniq(items.map(x=>x.text || x)).slice(0,200).map(t=>({text:t, t:Date.now()}));
    writeSaved(only);
  }

  // --- Speech (TTS) ---
  function canSpeak(){
    return "speechSynthesis" in window && "SpeechSynthesisUtterance" in window;
  }

  function speak(text, {rate=1.0, pitch=1.0, volume=1.0} = {}){
    const t = safeText(text).trim();
    if(!t) return Promise.resolve(false);
    lastSpoken = t;

    if(!canSpeak()) return Promise.resolve(false);

    try{ speechSynthesis.cancel(); }catch(_){}

    return new Promise((resolve)=>{
      const u = new SpeechSynthesisUtterance(t);
      u.lang = "en-US";
      u.rate = rate;
      u.pitch = pitch;
      u.volume = volume;

      u.onstart = ()=>{
        avatarWrap.classList.add("speaking");
        dot.classList.add("on");
        startTalkVideo();
      };
      u.onend = ()=>{
        avatarWrap.classList.remove("speaking");
        dot.classList.remove("on");
        stopTalkVideo();
        resolve(true);
      };
      u.onerror = ()=>{
        avatarWrap.classList.remove("speaking");
        dot.classList.remove("on");
        stopTalkVideo();
        resolve(false);
      };

      try{ speechSynthesis.speak(u); }
      catch(e){ resolve(false); }
    });
  }

  async function speakOrGate(text){
    if(!audioEnabled){
      const ok = await speak(text);
      if(ok){
        audioEnabled = true;
        return true;
      }
      gate.classList.add("show");
      return false;
    }else{
      return await speak(text);
    }
  }

  gateBtn.addEventListener("click", async ()=>{
    gate.classList.remove("show");
    audioEnabled = true;
    await delay(60);
    speak(lastSpoken || lineEN.textContent || "");
  });

  ["click","touchstart","keydown"].forEach(evt=>{
    window.addEventListener(evt, ()=>{
      if(!audioEnabled && gate.classList.contains("show")) return;
      audioEnabled = true;
    }, { once:true, passive:true });
  });

  // --- Data loading ---
  async function fetchJson(url){
    const res = await fetch(url, { cache:"no-store" });
    if(!res.ok) throw new Error("Fetch failed: " + res.status + " / " + url);
    return await res.json();
  }

  function fallbackIndex(){
    return {
      version:"2026-01-04",
      title:"Talk Scenarios",
      items:[
        {id:"coffee_shop", title_zh:"è²·ä¸€æ¯å’–å•¡", title_en:"Coffee Shop", level:"A1", role:"Barista", avatar:"assets/avatars/teacher-blonde.jpg"},
        {id:"hotel_checkin", title_zh:"é£¯åº—å…¥ä½", title_en:"Hotel Check-in", level:"A1", role:"Front Desk", avatar:"assets/avatars/teacher-blonde.jpg"},
        {id:"restaurant_order", title_zh:"é¤å»³é»é¤", title_en:"Restaurant Order", level:"A1", role:"Server", avatar:"assets/avatars/teacher-blonde.jpg"},
        {id:"airport_checkin", title_zh:"æ©Ÿå ´å ±åˆ°", title_en:"Airport Check-in", level:"A2", role:"Airline Staff", avatar:"assets/avatars/teacher-blonde.jpg"},
        {id:"business_meeting", title_zh:"å•†å‹™æœƒè­°é–‹å ´", title_en:"Business Meeting Opening", level:"A2", role:"Colleague", avatar:"assets/avatars/teacher-blonde.jpg"}
      ]
    };
  }

  function fallbackScene(id){
    const meta = (indexData?.items || fallbackIndex().items).find(x=>x.id===id) || fallbackIndex().items[0];
    const base = {
      id: meta.id,
      title_zh: meta.title_zh,
      title_en: meta.title_en,
      level: meta.level,
      role: meta.role,
      avatar: meta.avatar,
      task: "å®Œæˆé€™å€‹æƒ…å¢ƒå°è©±ã€‚ç”¨ç°¡çŸ­å¥å­å›ç­”ï¼Œç›¡é‡èªªå®Œæ•´ã€‚",
      examples: [
        "I'd like a latte, please.",
        "Can I have it iced?",
        "That's all, thank you."
      ],
      vocab: [
        {en:"please", zh:"è«‹"},
        {en:"I'd like...", zh:"æˆ‘æƒ³è¦..."},
        {en:"that's all", zh:"å°±é€™äº›"}
      ],
      steps: []
    };
    if(id==="coffee_shop"){
      base.steps = [
        step("Welcome to our cafe! What kind of coffee would you like today?", "æ­¡è¿ä¾†åˆ°å’–å•¡åº—ï¼ä½ ä»Šå¤©æƒ³å–ä»€éº¼å’–å•¡ï¼Ÿ", ["latte","americano","coffee"], "Great. What size would you like?", "Try: 'I'd like a latte.'"),
        step("What size would you like? Small, medium, or large?", "ä½ è¦å°æ¯ã€ä¸­æ¯ã€é‚„æ˜¯å¤§æ¯ï¼Ÿ", ["small","medium","large"], "Got it. Hot or iced?", "Say: 'Medium, please.'"),
        step("Hot or iced?", "è¦ç†±çš„é‚„æ˜¯å†°çš„ï¼Ÿ", ["hot","iced"], "Perfect. Anything else?", "Say: 'Iced, please.'"),
        step("Anything else?", "é‚„è¦åˆ¥çš„å—ï¼Ÿ", ["no","that's all","nothing"], "Alright. Your total is five dollars.", "Say: 'That's all, thank you.'"),
        step("How would you like to pay? Cash or card?", "ä½ è¦ç”¨ç¾é‡‘é‚„æ˜¯åˆ·å¡ï¼Ÿ", ["cash","card"], "Thanks! Please wait a moment.", "Say: 'By card, please.'"),
        step("Can I have your name for the order?", "æˆ‘å¯ä»¥å¯«ä½ çš„åå­—å—ï¼Ÿ", ["my name is","it's"], "Great. We'll call you soon.", "Say: 'My name is Alex.'"),
        step("Would you like sugar or milk?", "è¦åŠ ç³–æˆ–ç‰›å¥¶å—ï¼Ÿ", ["sugar","milk","no"], "Okay. Your drink will be ready soon.", "Say: 'No sugar, thanks.'"),
        step("Do you want it to go or for here?", "å¤–å¸¶é‚„æ˜¯å…§ç”¨ï¼Ÿ", ["to go","for here"], "Sure. Please wait.", "Say: 'To go, please.'"),
        step("Here is your drink. Enjoy!", "é€™æ˜¯ä½ çš„é£²æ–™ï¼Œæ…¢ç”¨ï¼", ["thank you","thanks"], "You're welcome. Have a nice day!", "Say: 'Thank you!'"),
        endStep("You're welcome. Have a nice day!", "ä¸å®¢æ°£ï¼Œç¥ä½ æœ‰ç¾å¥½çš„ä¸€å¤©ï¼")
      ];
    }else{
      base.steps = [
        step("Hello! How can I help you today?", "ä½ å¥½ï¼æˆ‘å¯ä»¥æ€éº¼å¹«ä½ ï¼Ÿ", ["i'd like","i want","can i"], "Sure. Can you tell me more?", "Try: 'I'd like to check in.'"),
        step("Sure. Can you tell me more?", "å¥½çš„ï¼Œèƒ½å¤šèªªä¸€é»å—ï¼Ÿ", ["reservation","book","name"], "Thanks. May I see your ID?", "Say: 'I have a reservation.'"),
        step("May I see your ID, please?", "å¯ä»¥çœ‹ä¸€ä¸‹ä½ çš„è­‰ä»¶å—ï¼Ÿ", ["here","sure"], "Thank you. One moment.", "Say: 'Sure, here you are.'"),
        step("Thank you. One moment, please.", "è¬è¬ï¼Œè«‹ç¨ç­‰ã€‚", ["okay","sure"], "All set. Here you go.", "Say: 'Okay.'"),
        step("All set. Here you go.", "å¥½äº†ï¼Œçµ¦ä½ ã€‚", ["thank"], "You're welcome. Anything else?", "Say: 'Thank you.'"),
        step("Anything else you need?", "é‚„éœ€è¦ä»€éº¼å—ï¼Ÿ", ["no","that's all"], "Great. Have a nice day!", "Say: 'No, that's all.'"),
        step("Have a nice day!", "ç¥ä½ æœ‰ç¾å¥½çš„ä¸€å¤©ï¼", ["you too","thanks"], "Thank you!", "Say: 'You too!'"),
        step("Before you go, can you repeat the key phrase?", "é›¢é–‹å‰ï¼Œèƒ½å†èªªä¸€æ¬¡é—œéµå¥å—ï¼Ÿ", ["i'd like"], "Perfect! Let's wrap up.", "Try: 'I'd like ...'"),
        step("Perfect! Let's wrap up.", "å¾ˆæ£’ï¼æˆ‘å€‘æ”¶å°¾ã€‚", ["okay"], "Awesome. See you next time!", "Say: 'Okay.'"),
        endStep("Awesome. See you next time!", "å¤ªæ£’äº†ï¼Œä¸‹æ¬¡è¦‹ï¼")
      ];
    }
    return base;

    function step(ai, zh, expect, ok, retry){
      return { ai, zh, expect, ok, retry, type:"step" };
    }
    function endStep(ai, zh){
      return { ai, zh, type:"end" };
    }
  }

  function normalizeSceneJson(raw, id){
    const meta = (indexData?.items || []).find(x=>x.id===id) || {};
    const out = {
      id,
      title_zh: raw.title_zh || raw.titleZh || meta.title_zh || "",
      title_en: raw.title_en || raw.titleEn || meta.title_en || id,
      level: raw.level || meta.level || "A1",
      role: raw.role || meta.role || "teacher",
      avatar: raw.avatar || meta.avatar || "assets/avatars/teacher-blonde.jpg",
      task: raw.task || raw.mission || raw.goal || "",
      examples: raw.examples || raw.sample || raw.samples || [],
      vocab: raw.vocab || raw.words || raw.keywords || [],
      translations: raw.translations || raw.translate || null,
      review: raw.review || raw.comment || raw.feedback || null,
      steps: []
    };

    let s = raw.steps || raw.dialogues || raw.lines || raw.conversation || null;
    if(Array.isArray(s)){
      out.steps = s.map((x, i)=>({
        ai: x.ai || x.teacher || x.bot || x.text || "",
        zh: x.zh || x.tw || x.cn || x.translation_zh || "",
        expect: x.expect || x.keywords || x.must || [],
        ok: x.ok || x.ai_ok || x.next || "",
        retry: x.retry || x.ai_retry || x.hint || "",
        type: x.type || (i===s.length-1 ? "end":"step")
      }));
    }else{
      out.steps = fallbackScene(id).steps;
    }

    if(out.steps.length < 10){
      const pad = fallbackScene(id).steps;
      while(out.steps.length < 10 && pad[out.steps.length]){
        out.steps.push(pad[out.steps.length]);
      }
    }
    if(out.steps.length > 15){
      out.steps = out.steps.slice(0, 15);
      out.steps[out.steps.length-1].type = "end";
    }

    out.steps = out.steps.map((x, i)=>{
      const ai = safeText(x.ai).trim();
      const zh = safeText(x.zh).trim();
      return { ...x, ai: ai || (i===0 ? "Hello!" : "Okay."), zh: zh || "" };
    });

    return out;
  }

  async function loadIndex(){
    const url = BASE + "talk/index.json";
    try{ indexData = await fetchJson(url); }
    catch(e){ console.warn(e); indexData = fallbackIndex(); }
  }

  function fillSelect(){
    const items = indexData?.items || [];
    sceneSelect.innerHTML = "";
    items.forEach(it=>{
      const opt = document.createElement("option");
      opt.value = it.id;
      opt.textContent = `${it.title_zh}ï½œ${it.title_en} (${it.level})`;
      sceneSelect.appendChild(opt);
    });
  }

  async function loadScene(id){
    const url = BASE + "talk/" + id + ".json";
    let raw = null;
    try{ raw = await fetchJson(url); }
    catch(e){ console.warn("Scene json missing, fallback:", e); raw = fallbackScene(id); }
    currentScene = normalizeSceneJson(raw, id);
    applyScene(currentScene);
  }

  function applyScene(scene){
    roleLabel.textContent = `AI Â· ${scene.role || "teacher"}`;
    sceneLabel.textContent = `${scene.title_zh}ï½œ${scene.title_en} (${scene.level})`;
    avatarImg.src = BASE + scene.avatar.replace(/^\/+/,"");
    avatarImg.onerror = ()=>{
      avatarImg.src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512">
          <rect width="512" height="512" rx="32" fill="#f6f8fb"/>
          <circle cx="256" cy="220" r="90" fill="#dbe3ef"/>
          <circle cx="224" cy="210" r="10" fill="#111"/>
          <circle cx="288" cy="210" r="10" fill="#111"/>
          <path d="M210 270 Q256 310 302 270" stroke="#111" stroke-width="10" fill="none" stroke-linecap="round"/>
          <text x="256" y="410" text-anchor="middle" font-family="system-ui" font-weight="800" font-size="40" fill="#0b1220">AI</text>
        </svg>
      `);
    };

    steps = scene.steps || [];
    stepIdx = 0;

    renderStep();
    speakOrGate(lineEN.textContent);

    setQs("scene", scene.id);
  }

  function renderStep(){
    const s = steps[stepIdx] || null;
    if(!s){
      lineEN.textContent = "Loadingâ€¦";
      lineZH.textContent = "ï¼ˆè¼‰å…¥ä¸­â€¦ï¼‰";
      return;
    }
    lineEN.textContent = s.ai;
    lineZH.textContent = s.zh ? s.zh : "";
    lastSpoken = s.ai;
  }

  function isEnd(){
    const s = steps[stepIdx];
    return s && (s.type === "end" || stepIdx >= steps.length-1);
  }

  function getExpectList(){
    const s = steps[stepIdx] || {};
    let ex = s.expect || [];
    if(typeof ex === "string") ex = ex.split(",").map(x=>x.trim()).filter(Boolean);
    if(!Array.isArray(ex)) ex = [];
    return ex.map(x=>String(x).toLowerCase()).filter(Boolean);
  }

  function evaluateUser(text){
    const t = normalizeLower(text);
    const ex = getExpectList();
    if(ex.length === 0) return { ok:true, reason:"no_expect" };
    const hit = ex.some(k => t.includes(k));
    return { ok: hit, reason: hit ? "hit" : "miss", expect: ex };
  }

  async function handleUser(text){
    const userText = safeText(text).trim();
    if(!userText) return;

    savePhrase(userText);

    const s = steps[stepIdx] || {};
    const ev = evaluateUser(userText);

    if(isEnd()){
      await showReview();
      return;
    }

    if(ev.ok){
      if(s.ok){
        lineEN.textContent = s.ok;
        lineZH.textContent = "";
        lastSpoken = s.ok;
        await speakOrGate(s.ok);
      }
      stepIdx = Math.min(stepIdx + 1, steps.length-1);
      renderStep();
      await speakOrGate(lineEN.textContent);
      if(isEnd()) await showReview();
    }else{
      const msg = s.retry || (ev.expect?.length ? `Try including: ${ev.expect.slice(0,3).join(", ")}` : "Try again.");
      lineEN.textContent = msg;
      lineZH.textContent = "ï¼ˆå†è©¦ä¸€æ¬¡ï¼šç”¨æ›´å®Œæ•´çš„å¥å­å›ç­”ï¼‰";
      lastSpoken = msg;
      await speakOrGate(msg);
      renderStep();
      await delay(200);
      await speakOrGate(lineEN.textContent);
    }
  }

  async function showReview(){
    const review = currentScene?.review;
    if(review){
      openSheet(renderReviewHTML(review));
      attachSheetInteractions();
    }else{
      openSheet(renderReviewHTML({
        title:"è©•è«– / å»ºè­°",
        items:[
          "å¾ˆæ£’ï¼å®Œæˆæ•´å€‹æƒ…å¢ƒã€‚",
          "å»ºè­°ï¼šæ¯å¥åŠ ä¸Š please / thank you æœƒæ›´è‡ªç„¶ã€‚",
          "ä¸‹æ¬¡ç›®æ¨™ï¼šæŠŠå¥å­èªªå®Œæ•´ï¼Œä¾‹å¦‚ï¼šI'd like a medium latte, please."
        ]
      }));
      attachSheetInteractions();
    }
  }

  function renderReviewHTML(review){
    let title = "è©•è«– / å»ºè­°";
    let items = [];
    if(typeof review === "string"){
      items = [review];
    }else if(Array.isArray(review)){
      items = review;
    }else if(review && typeof review === "object"){
      title = review.title || title;
      items = review.items || review.lines || [];
      if(typeof items === "string") items = [items];
    }
    items = (items || []).filter(Boolean);

    return `
      <div class="card">
        <h3>${escapeHtml(title)}</h3>
        <ul class="list">
          ${items.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}
        </ul>
      </div>
      <div class="card">
        <h3>ä¸‹ä¸€æ­¥</h3>
        <p>ä½ å¯ä»¥åˆ‡æ›ä¸Šæ–¹æƒ…å¢ƒç¹¼çºŒç·´ï¼Œä¸»ç•«é¢ä¸æœƒä¸­æ–·å°è©±ã€‚</p>
      </div>
    `;
  }

  function renderTask(){
    const t = currentScene?.task || "å®Œæˆé€™å€‹æƒ…å¢ƒå°è©±ã€‚ç”¨ç°¡çŸ­å¥å­å›ç­”ï¼Œç›¡é‡èªªå®Œæ•´ã€‚";
    return `
      <div class="card">
        <h3>ä»»å‹™èªªæ˜</h3>
        <p>${escapeHtml(t)}</p>
      </div>
      <div class="card">
        <h3>å°æç¤º</h3>
        <ul class="list">
          <li>è½å®Œ AI çš„å¥å­å¾Œï¼Œç›´æ¥å›ç­”ä¸€å¥è‹±æ–‡å³å¯ã€‚</li>
          <li>èªªéŒ¯æ²’é—œä¿‚ï¼ŒAI æœƒæç¤ºä½ é‡èªªã€‚</li>
          <li>å®Œæˆ 10â€“15 å¥å¾Œæœƒçµ¦è©•è«–èˆ‡å»ºè­°ã€‚</li>
        </ul>
      </div>
    `;
  }

  function renderExamples(){
    const ex = Array.isArray(currentScene?.examples) ? currentScene.examples : [];
    const list = ex.length ? ex : ["I'd like ... , please.", "Can I ... ?", "That's all, thank you."];
    return `
      <div class="card">
        <h3>ç¯„ä¾‹å¥ï¼ˆé»ä¸€ä¸‹å¯å„²å­˜ï¼‰</h3>
        <div class="row">
          ${list.map(s=>`<span class="tag" data-save="${escapeHtml(s)}">${escapeHtml(s)}</span>`).join("")}
        </div>
        <p class="mini">ï¼ˆé»ä»»ä¸€ç¯„ä¾‹æœƒåŠ å…¥ã€Œå·²å„²å­˜ã€ï¼‰</p>
      </div>
    `;
  }

  function renderTranslate(){
    const cur = steps[stepIdx] || {};
    const zh = cur.zh || "";
    let jp = "";
    const map = currentScene?.translations;
    if(map && typeof map === "object"){
      jp = map[cur.ai] || map[normalizeLower(cur.ai)] || "";
    }
    return `
      <div class="card">
        <h3>ç¿»è­¯ï¼ˆæœ¬å¥ï¼‰</h3>
        <p><b>EN</b>ï¼š${escapeHtml(cur.ai || "")}</p>
        <p style="margin-top:8px"><b>ä¸­æ–‡</b>ï¼š${escapeHtml(zh || "ï¼ˆæ­¤æƒ…å¢ƒæœªæä¾›ä¸­æ–‡ï¼‰")}</p>
        <p style="margin-top:8px"><b>æ—¥æ–‡</b>ï¼š${escapeHtml(jp || "ï¼ˆæ­¤æƒ…å¢ƒæœªæä¾›æ—¥æ–‡ï¼‰")}</p>
      </div>
      <div class="card">
        <h3>ä¸€éµæœ—è®€</h3>
        <p class="mini">é»ã€Œé‡æ’­æœ¬å¥ã€å°±æœƒæœ—è®€è‹±æ–‡ï¼›è‹¥ä½ è¦æœ—è®€ä¸­æ–‡/æ—¥æ–‡ï¼Œå¯ç”¨æ‰‹æ©Ÿçš„æœ—è®€å·¥å…·ã€‚</p>
      </div>
    `;
  }

  function renderSaved(){
    const items = readSaved();
    if(!items.length){
      return `
        <div class="card">
          <h3>å·²å„²å­˜</h3>
          <p>ç›®å‰æ²’æœ‰å„²å­˜å…§å®¹ã€‚ä½ æ¯æ¬¡å›ç­”æœƒè‡ªå‹•å„²å­˜ä¸€ç­†ï¼›ä¹Ÿå¯ä»¥åœ¨ã€Œç¯„ä¾‹ã€é»å¥å­å„²å­˜ã€‚</p>
        </div>
      `;
    }
    const top = items.slice(0,50);
    return `
      <div class="card">
        <h3>å·²å„²å­˜ï¼ˆå‰ 50 ç­†ï¼‰</h3>
        <div class="row">
          ${top.map(x=>`<span class="tag" data-say="${escapeHtml(x.text || x)}">${escapeHtml(x.text || x)}</span>`).join("")}
        </div>
        <p class="mini">é»å¥å­å¯æœ—è®€è‹±æ–‡ã€‚</p>
      </div>
      <div class="card">
        <button class="btn" id="clearSaved" style="width:100%;padding:12px;border-radius:14px">æ¸…ç©ºå·²å„²å­˜</button>
        <p class="mini" style="margin-top:8px">æ¸…ç©ºåªæœƒå½±éŸ¿é€™å°è£ç½®ã€‚</p>
      </div>
    `;
  }

  function attachSheetInteractions(){
    sheetBody.querySelectorAll("[data-save]").forEach(el=>{
      el.addEventListener("click", ()=>{
        const s = el.getAttribute("data-save") || "";
        savePhrase(s);
        const old = el.textContent;
        el.textContent = "âœ… å·²å„²å­˜";
        setTimeout(()=>{ el.textContent = old; }, 700);
      });
    });
    sheetBody.querySelectorAll("[data-say]").forEach(el=>{
      el.addEventListener("click", ()=>{
        const s = el.getAttribute("data-say") || "";
        speakOrGate(s);
      });
    });
    const clear = sheetBody.querySelector("#clearSaved");
    if(clear){
      clear.addEventListener("click", ()=>{
        writeSaved([]);
        sheetBody.innerHTML = renderSaved();
        attachSheetInteractions();
      });
    }
  }

  btnReplay.addEventListener("click", ()=> speakOrGate(lastSpoken || lineEN.textContent || ""));
  btnSkip.addEventListener("click", async ()=>{
    if(isEnd()){ await showReview(); return; }
    stepIdx = Math.min(stepIdx + 1, steps.length-1);
    renderStep();
    await speakOrGate(lineEN.textContent);
    if(isEnd()) await showReview();
  });

  btnMic.addEventListener("click", async ()=>{
    audioEnabled = true;

    if(rec){
      try{
        btnMic.textContent = "ğŸ™ï¸ è½ä½ èªªâ€¦ï¼ˆèªªå®Œåœä¸€ä¸‹ï¼‰";
        btnMic.disabled = true;
        rec.onresult = async (e)=>{
          const t = e.results && e.results[0] && e.results[0][0] ? e.results[0][0].transcript : "";
          btnMic.textContent = "ğŸ¤ é»æˆ‘èªªï¼ˆé–‹å§‹è¾¨è­˜ï¼‰";
          btnMic.disabled = false;
          await handleUser(t);
        };
        rec.onerror = async ()=>{
          btnMic.textContent = "âŒ¨ï¸ é€™å°ä¸æ”¯æ´èªéŸ³ï¼Œæ”¹ç”¨è¼¸å…¥";
          btnMic.disabled = false;
          const t = prompt("è«‹è¼¸å…¥ä½ è¦å›ç­”çš„è‹±æ–‡ï¼š") || "";
          await handleUser(t);
        };
        rec.onend = ()=>{
          btnMic.textContent = "ğŸ¤ é»æˆ‘èªªï¼ˆé–‹å§‹è¾¨è­˜ï¼‰";
          btnMic.disabled = false;
        };
        rec.start();
      }catch(e){
        btnMic.textContent = "âŒ¨ï¸ é€™å°ä¸æ”¯æ´èªéŸ³ï¼Œæ”¹ç”¨è¼¸å…¥";
        btnMic.disabled = false;
        const t = prompt("è«‹è¼¸å…¥ä½ è¦å›ç­”çš„è‹±æ–‡ï¼š") || "";
        await handleUser(t);
      }
    }else{
      const t = prompt("æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ã€‚è«‹è¼¸å…¥ä½ è¦å›ç­”çš„è‹±æ–‡ï¼š") || "";
      await handleUser(t);
    }
  });

  btnTask.addEventListener("click", ()=>{
    openSheet(renderTask()); attachSheetInteractions();
  });
  btnExamples.addEventListener("click", ()=>{
    openSheet(renderExamples()); attachSheetInteractions();
  });
  btnTranslate.addEventListener("click", ()=>{
    openSheet(renderTranslate()); attachSheetInteractions();
  });
  btnSaved.addEventListener("click", ()=>{
    openSheet(renderSaved()); attachSheetInteractions();
  });

  sceneSelect.addEventListener("change", async ()=>{
    await loadScene(sceneSelect.value);
  });

  $("btnBack").addEventListener("click", ()=>{
    const guessHome = BASE.replace(/\/[^\/]*$/,"/") + "index.html";
    location.href = guessHome;
  });

  async function boot(){
    lineEN.textContent = "Loadingâ€¦";
    lineZH.textContent = "ï¼ˆè¼‰å…¥ä¸­â€¦ï¼‰";
    dot.classList.remove("on");

    await loadIndex();
    fillSelect();

    const initial = qs("scene") || (indexData?.items?.[0]?.id) || "coffee_shop";
    sceneSelect.value = initial;
    if(!sceneSelect.value && indexData?.items?.length){
      sceneSelect.value = indexData.items[0].id;
    }

    await loadScene(sceneSelect.value);
  }

  boot();
})();
</script>
</body>
</html>
