<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Talk Aï¼ˆæ‰‹æ©Ÿå£èªªï¼‰ï½œBookWide</title>
<style>
:root{
  --bg:#f4f6fb; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
  --brand:#2563eb; --brand2:#1d4ed8; --soft:#eef2ff; --radius:18px;
  --shadow:0 14px 40px rgba(15,23,42,.10);
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;}
a{color:inherit}
.wrap{max-width:980px;margin:0 auto;padding:18px}
.topbar{
  display:flex; align-items:center; gap:12px;
  background:var(--card); border:1px solid var(--line); border-radius:999px;
  padding:10px 12px; box-shadow:var(--shadow);
}
.back{
  width:40px;height:40px;border-radius:999px;border:1px solid var(--line);
  display:grid;place-items:center;background:#fff;cursor:pointer;
}
.title{font-weight:900}
.sub{font-size:12px;color:var(--muted);margin-top:2px}
.spacer{flex:1}
.sel{
  border:1px solid var(--line); border-radius:999px; padding:10px 12px;
  min-width:280px; background:#fff;
}
.btn{
  border:none; border-radius:999px; padding:10px 14px; cursor:pointer;
  font-weight:800;
}
.btn.secondary{background:#fff;border:1px solid var(--line)}
.btn.brand{background:linear-gradient(180deg,var(--brand),var(--brand2)); color:#fff}
.stage{
  margin-top:14px;
  background:var(--card); border:1px solid var(--line); border-radius:28px;
  box-shadow:var(--shadow); overflow:hidden;
}
.stageInner{padding:20px 18px 16px}
.badge{
  display:inline-flex; align-items:center; gap:8px;
  background:#0f172a; color:#fff; border-radius:999px; padding:8px 12px;
  font-weight:900; font-size:12px;
}
.badge .dot{width:8px;height:8px;border-radius:999px;background:#22c55e}
.avatarWrap{display:grid;place-items:center;margin:18px 0 8px}
.avatar{
  width:220px;height:220px;border-radius:999px; overflow:hidden;
  border:10px solid #fff; box-shadow:0 25px 60px rgba(15,23,42,.18);
  background:#fff;
}
.avatar img{width:100%;height:100%;object-fit:cover}
.bubble{
  margin:10px 0 0;
  background:#f8fafc; border:1px solid var(--line); border-radius:22px;
  padding:18px 18px;
}
.en{font-size:34px; font-weight:1000; letter-spacing:.2px; line-height:1.15}
.zh{margin-top:8px; color:var(--muted); font-size:14px}
.controls{
  margin-top:12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;
}
.bigBtn{
  flex:1;
  border:none; border-radius:999px;
  padding:16px 18px; cursor:pointer; font-weight:1000; font-size:18px;
  color:#fff;
  background:linear-gradient(180deg,#1d4ed8,#2563eb);
  box-shadow:0 18px 50px rgba(37,99,235,.35);
}
.smallBtn{
  border:1px solid var(--line); background:#fff; border-radius:999px;
  padding:14px 16px; cursor:pointer; font-weight:900; min-width:110px;
}
.grid4{
  margin-top:14px;
  display:grid; grid-template-columns:repeat(4,1fr); gap:12px;
}
.card{
  background:#fff;border:1px solid var(--line); border-radius:18px;
  padding:14px 14px; cursor:pointer; box-shadow:0 10px 26px rgba(15,23,42,.06);
}
.cardTitle{font-weight:1000}
.cardSub{margin-top:6px;color:var(--muted);font-size:12px}
.notice{
  margin-top:10px; color:var(--muted); font-size:12px;
  text-align:center;
}
@media (max-width:860px){
  .wrap{padding:14px}
  .sel{min-width:200px}
  .en{font-size:28px}
  .grid4{grid-template-columns:repeat(2,1fr)}
}
@media (max-width:420px){
  .en{font-size:24px}
  .avatar{width:190px;height:190px}
}

/* bottom sheet */
.mask{position:fixed; inset:0; background:rgba(2,6,23,.45); display:none; z-index:50;}
.sheet{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:-100%;
  width:min(980px, calc(100vw - 22px));
  background:#fff; border:1px solid var(--line);
  border-radius:22px 22px 0 0;
  box-shadow:0 30px 90px rgba(15,23,42,.35);
  z-index:60;
  transition:bottom .22s ease;
  overflow:hidden;
}
.sheetHead{
  display:flex; align-items:center; gap:10px; padding:12px 14px;
  border-bottom:1px solid var(--line);
}
.sheetTitle{font-weight:1000}
.sheetClose{
  margin-left:auto;
  border:1px solid var(--line);
  background:#fff; border-radius:999px; padding:8px 12px; cursor:pointer; font-weight:900;
}
.sheetBody{padding:14px 14px 18px; max-height:55vh; overflow:auto}
.pill{
  display:inline-flex; align-items:center; gap:8px;
  padding:8px 12px; border-radius:999px;
  border:1px solid var(--line);
  background:#f8fafc; margin:6px 6px 0 0;
  font-weight:900; font-size:13px;
}
.hint{color:var(--muted); font-size:13px; margin-top:10px; line-height:1.55}
.linkBtn{
  display:inline-flex; align-items:center; gap:8px;
  margin-top:10px;
  padding:10px 12px; border-radius:12px;
  border:1px solid var(--line); background:var(--soft);
  font-weight:1000; text-decoration:none;
}
pre{
  white-space:pre-wrap; word-break:break-word;
  background:#0b1020; color:#e5e7eb; padding:12px; border-radius:14px;
  overflow:auto;
}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <button class="back" id="btnBack" title="å›ä¸Šä¸€é ">â†</button>
    <div>
      <div class="title">Talk Aï¼ˆæ‰‹æ©Ÿå£èªªï¼‰</div>
      <div class="sub">TTSï¼šBrowser SpeechSynthesis</div>
    </div>
    <div class="spacer"></div>
    <select class="sel" id="sceneSelect"></select>
    <button class="btn secondary" id="btnReplay">é‡æ’­æœ¬å¥</button>
  </div>

  <div class="stage">
    <div class="stageInner">
      <div class="badge"><span class="dot"></span><span id="roleLabel">AI</span><span id="sceneLabel" style="opacity:.85"></span></div>

      <div class="avatarWrap">
        <div class="avatar">
        <img id="avatarImg" alt="avatar" />
        <video id="avatarVid" muted autoplay loop playsinline style="display:none"></video>
      </div>
      </div>

      <div class="bubble">
        <div class="en" id="lineEn">è¼‰å…¥ä¸­â€¦</div>
        <div class="zh" id="lineZh"></div>
      </div>

      <div class="controls">
        <button class="bigBtn" id="btnSpeak">ğŸ¤ é»æˆ‘èªªï¼ˆé–‹å§‹è¾¨è­˜ï¼‰</button>
        <button class="smallBtn" id="btnType">âŒ¨ï¸ è¼¸å…¥</button>
        <button class="smallBtn" id="btnSkip">è·³é</button>
      </div>

      <div class="grid4">
        <div class="card" id="btnTask"><div class="cardTitle">ä»»å‹™</div><div class="cardSub" id="subTask">è¦åšä»€éº¼</div></div>
        <div class="card" id="btnExample"><div class="cardTitle">ç¯„ä¾‹</div><div class="cardSub" id="subExample">ä¸æœƒå¥</div></div>
        <div class="card" id="btnTrans"><div class="cardTitle">ç¿»è­¯</div><div class="cardSub">ä¸­ / æ—¥</div></div>
        <div class="card" id="btnSaved"><div class="cardTitle">å·²å„²å­˜</div><div class="cardSub">å–®å­—å¥</div></div>
      </div>

      <div class="notice">ä¸»é ä¿æŒåœ¨å°è©±ä¸­ï¼›é»ã€Œä»»å‹™ / ç¯„ä¾‹ / ç¿»è­¯ / å·²å„²å­˜ã€åªæœƒæ‰“é–‹è¼”åŠ©å°çª—ï¼Œä¸æœƒä¸­æ–·å°è©±ã€‚</div>
    </div>
  </div>
</div>

<div class="mask" id="mask"></div>
<div class="sheet" id="sheet">
  <div class="sheetHead">
    <div class="sheetTitle" id="sheetTitle">ä»»å‹™</div>
    <button class="sheetClose" id="sheetClose">é—œé–‰</button>
  </div>
  <div class="sheetBody" id="sheetBody"></div>
</div>

<script>
(function(){
  const qs = (id)=>document.getElementById(id);
  const esc = (s)=>String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  const params = new URLSearchParams(location.search);
  const BUST = params.get("v") ? ("?v="+encodeURIComponent(params.get("v"))) : ("?v="+Date.now());
  const state = {
    sceneId: params.get("scene") || "",
    sceneMeta: null,
    mode: "scene", // scene | speaking
    steps: [],
    idx: 0,
    saved: loadSaved(),
    recognizer: null,
  };

  // --- UI refs ---
  const sceneSelect = qs("sceneSelect");
  const roleLabel = qs("roleLabel");
  const sceneLabel = qs("sceneLabel");
  const avatarImg = qs("avatarImg");
  const lineEn = qs("lineEn");
  const lineZh = qs("lineZh");
  const btnSpeak = qs("btnSpeak");
  const btnReplay = qs("btnReplay");
  const btnSkip = qs("btnSkip");
  const btnType = qs("btnType");
  const btnTask = qs("btnTask");
  const btnExample = qs("btnExample");
  const btnTrans = qs("btnTrans");
  const btnSaved = qs("btnSaved");
  const sheet = qs("sheet");
  const mask = qs("mask");
  const sheetTitle = qs("sheetTitle");
  const sheetBody = qs("sheetBody");
  const sheetClose = qs("sheetClose");

  qs("btnBack").onclick = ()=> history.length>1 ? history.back() : location.href="/";

  // --- bottom sheet ---
  function openSheet(title, html){
    sheetTitle.textContent = title;
    sheetBody.innerHTML = html || "";
    mask.style.display = "block";
    sheet.style.bottom = "0";
  }
  function closeSheet(){
    sheet.style.bottom = "-100%";
    mask.style.display = "none";
  }
  mask.onclick = closeSheet;
  sheetClose.onclick = closeSheet;

  // --- saved ---
  function loadSaved(){
    try{
      const raw = localStorage.getItem("BW_TALK_SAVED") || "[]";
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    }catch(e){ return []; }
  }
  function saveSaved(){
    try{ localStorage.setItem("BW_TALK_SAVED", JSON.stringify(state.saved.slice(0,200))); }catch(e){}
  }
  function addSaved(text){
    const t = String(text||"").trim();
    if(!t) return;
    if(!state.saved.includes(t)) state.saved.unshift(t);
    saveSaved();
  }

  // --- scene loading ---
  async function fetchJson(url){
    const r = await fetch(url, {cache:"no-store"});
    if(!r.ok) throw new Error(r.status + " " + r.statusText);
    return await r.json();
  }

  function normalizeStepsFromSceneJson(sceneData){
    // Try multiple schemas:
    // 1) { meta, dialogue:[{en,zh,role,...}] }
    // 2) { meta, steps:[{en,zh,...}] }
    // 3) speaking-{slug}.json : array of items with line_en/coach...
    const meta = sceneData.meta || {};
    let steps = [];
    if(Array.isArray(sceneData.dialogue)) steps = sceneData.dialogue;
    else if(Array.isArray(sceneData.steps)) steps = sceneData.steps;
    else if(Array.isArray(sceneData.items)) steps = sceneData.items;
    else if(Array.isArray(sceneData)) steps = sceneData;
    // Normalize to {en,zh,hint,role}
    const norm = steps.map((it, i)=>{
      if(!it || typeof it !== "object") return {en:String(it||""), zh:"", hint:"", role: meta.role||"AI"};
      // speaking item format
      const en = it.en || it.line_en || (it.ai && it.ai.en) || "";
      const zh = it.zh || it.line_zh || (it.ai && it.ai.zh) || "";
      const hint = (it.hint) || (it.coach && it.coach.hint) || "";
      const role = it.role || meta.role || (meta.ai_role) || "AI";
      return { en:String(en||""), zh:String(zh||""), hint:String(hint||""), raw:it, role };
    }).filter(x=>x.en.trim().length>0);

    // If sceneData has intro line
    if(meta.opening_en && !norm.length){
      norm.push({en:String(meta.opening_en), zh:String(meta.opening_zh||""), hint:"", role: meta.role||"AI"});
    }
    return { meta, norm };
  }

  async function loadIndex(){
    // try several possible paths (GitHub Pages root may differ)
    const candidates = [
      "/talk/index.json",
      "talk/index.json",
      "./talk/index.json",
      "/EduEnglish/talk/index.json",
      "EduEnglish/talk/index.json"
    ];
    let lastErr = null;
    for(const base of candidates){
      try{
        const url = base + (base.includes("?") ? "&" : "?") + "v=" + encodeURIComponent(BUST);
        const r = await fetch(url, { cache: "no-store" });
        if(!r.ok) throw new Error("HTTP " + r.status + " @ " + url);
        const j = await r.json();
        if(j && j.items && Array.isArray(j.items)) return j;
        // tolerate legacy structure
        if(j && Array.isArray(j)) return { items: j };
        throw new Error("Bad JSON shape @ " + url);
      }catch(e){
        lastErr = e;
      }
    }
    throw lastErr || new Error("Failed to load index.json");
  }

  async function loadScene(sceneId){
    const tryUrls = [
      `/talk/${sceneId}.json${BUST}`,
      `/talk/scene-${sceneId}.json${BUST}`,
      // underscore fallback
      `/talk/${sceneId.replaceAll("-","_")}.json${BUST}`,
      `/talk/scene-${sceneId.replaceAll("-","_")}.json${BUST}`,
      // speaking fallback
      `/talk/speaking-${sceneId}.json${BUST}`,
      `/talk/speaking-${sceneId.replaceAll("_","-")}.json${BUST}`,
    ];
    let lastErr = null;
    for(const u of tryUrls){
      try{
        const d = await fetchJson(u);
        const isSpeaking = u.includes("/speaking-");
        return { data:d, mode: isSpeaking ? "speaking" : "scene", url:u };
      }catch(e){ lastErr = e; }
    }
    throw lastErr || new Error("scene not found");
  }

  function sceneToPlayerUrl(sceneId, meta = {}) {
    // å…è¨± scene èˆ‡ player slug ä¸åŒï¼ˆä¾‹å¦‚ speaking-one-way-ticket -> one-way-ticketï¼‰
    const cat = (meta.player_cat || meta.cat || meta.category || 'news');
    let slug = (meta.player_slug || meta.slug || sceneId || '');
    slug = String(slug).trim();

    // æ…£ä¾‹ï¼šå£èªªè¨“ç·´æª”å speaking-{slug}.jsonï¼Œä½†æ’­æ”¾å™¨ä»ç”¨åŸæœ¬ {slug}
    if (/^speaking-/.test(slug)) slug = slug.replace(/^speaking-/, '');

    return `https://bookwide.net/player.html?cat=${encodeURIComponent(cat)}&slug=${encodeURIComponent(slug)}`;
  }


  function resolvePublicAssetUrl(path) {
    if (!path) return '';
    const p = String(path).trim();
    if (!p) return '';
    if (/^https?:\/\//i.test(p)) return p;

    // ä½  talk/index.json ç›®å‰ç”¨ "assets/avatars/xxx.jpg"
    // é€™è£¡çµ±ä¸€æŒ‡å‘ Supabase publicï¼š/storage/v1/object/public/...
    const SUPA_PUBLIC = 'https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public';
    return `${SUPA_PUBLIC}/${p.replace(/^\/+/, '')}`;
  }

  function renderStep(){
    const step = state.steps[state.idx] || {en:"", zh:"", hint:"", role:"AI"};
    roleLabel.textContent = "AI Â· " + (state.sceneMeta?.role || step.role || "Teacher");
    sceneLabel.textContent = " " + (state.sceneMeta?.title_zh || state.sceneMeta?.title_en || state.sceneId || "");
    lineEn.textContent = step.en || "ï¼ˆæ­¤æƒ…å¢ƒæœªæä¾›å°è©ï¼‰";
    lineZh.textContent = step.zh || "";
  }

  function speak(text){
    try{
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "en-US";
      u.rate = 1.0;
      window.speechSynthesis.speak(u);
    }catch(e){}
  }

  // --- Speech recognition (optional) ---
  function ensureRecognizer(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR) return null;
    const rec = new SR();
    rec.lang = "en-US";
    rec.interimResults = false;
    rec.maxAlternatives = 1;
    return rec;
  }
  function startRecognize(){
    const rec = ensureRecognizer();
    if(!rec){
      openSheet("æç¤º", `<div class="hint">ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ã€‚å¯ä»¥ç”¨ã€Œè¼¸å…¥ã€æ¨¡å¼ã€‚</div>`);
      return;
    }
    const expected = (state.steps[state.idx]?.en || "").trim();
    rec.onresult = (ev)=>{
      const said = ev.results && ev.results[0] && ev.results[0][0] ? ev.results[0][0].transcript : "";
      const score = simpleScore(expected, said);
      const html = `
        <div class="hint"><b>ä½ èªªï¼š</b> ${esc(said)}</div>
        <div class="hint"><b>åƒè€ƒå¥ï¼š</b> ${esc(expected)}</div>
        <div class="hint"><b>ç›¸ä¼¼åº¦ï¼ˆç²—ä¼°ï¼‰ï¼š</b> ${esc(score.toFixed(0))} / 100</div>
        <a class="linkBtn" href="javascript:void(0)" id="saveLine">ğŸ’¾ å­˜é€™å¥</a>
      `;
      openSheet("è¾¨è­˜çµæœ", html);
      setTimeout(()=>{
        const a = document.getElementById("saveLine");
        if(a) a.onclick = ()=>{ addSaved(expected); openSheet("å·²å„²å­˜", `<div class="pill">å·²å„²å­˜ï¼š${esc(expected)}</div>`); };
      },0);
    };
    rec.onerror = ()=>{};
    try{ rec.start(); }catch(e){}
  }
  function simpleScore(a,b){
    a = (a||"").toLowerCase().replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim();
    b = (b||"").toLowerCase().replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim();
    if(!a || !b) return 0;
    const aw = new Set(a.split(" "));
    const bw = new Set(b.split(" "));
    let inter = 0;
    for(const w of aw) if(bw.has(w)) inter++;
    const union = new Set([...aw,...bw]).size || 1;
    return (inter/union)*100;
  }

  // --- helpers sheet content ---
  function htmlTask(){
    const meta = state.sceneMeta || {};
    const step = state.steps[state.idx] || {};
    const playerUrl = meta.player_url || meta.playerUrl || sceneToPlayerUrl(state.sceneId, meta);
    const goal = meta.role ? `ä½ ç¾åœ¨æ˜¯ã€Œ${esc(meta.role)}ã€ï¼Œè«‹ç”¨è‹±æ–‡è‡ªç„¶å›ç­”ã€‚` : `è«‹ç”¨è‹±æ–‡è‡ªç„¶å›ç­”ã€‚`;
    const hint = step.hint ? `<div class="hint"><b>æç¤ºï¼š</b> ${esc(step.hint)}</div>` : `<div class="hint">æç¤ºï¼šå…ˆæŒ‰ã€Œç¯„ä¾‹ã€çœ‹å¼•å°å¥ï¼Œå†å›ä¾†å›ç­”ã€‚</div>`;
    return `
      <div class="pill">ä»»å‹™ï¼šçœ‹æ‡‚æƒ…å¢ƒ â†’ ç”¨ä¸€å¥è©±å›ç­”ï¼ˆè‹±æ–‡ï¼‰ã€‚</div>
      <div class="hint">${goal}</div>
      ${hint}
      <a class="linkBtn" target="_blank" rel="noopener" href="${esc(playerUrl)}">ğŸ”— é–‹å•Ÿæ’­æ”¾å™¨ï¼ˆå…ˆé–±è®€/ç†Ÿæ‚‰å–®å…ƒï¼‰</a>
      <div class="hint">ï¼ˆè‹¥ä½ å‰›ä¸Šå‚³ index.json æˆ–æ–°æª”æ¡ˆï¼Œå¯èƒ½éœ€è¦ Ctrl+F5 æˆ–ç¶²å€åŠ  ?v=æ™‚é–“ é‡æ–°è¼‰å…¥ã€‚ï¼‰</div>
    `;
  }

  function htmlExamples(){
    const meta = state.sceneMeta || {};
    const step = state.steps[state.idx] || {};
    const list = [];
    // meta.examples can be array of strings or objects {text,...}
    if(Array.isArray(meta.examples)){
      for(const it of meta.examples){
        if(typeof it === "string") list.push(it);
        else if(it && typeof it === "object"){
          const t = it.text || it.en || it.sentence || "";
          if(t) list.push(String(t));
        }
      }
    }
    // speaking coach hint
    if(step.hint) list.push(step.hint);
    const cur = (step.en||"").trim();
    let html = "";
    if(list.length){
      html += list.slice(0,12).map(t=>`<div class="pill">${esc(t)}</div>`).join("");
      if(cur) html += `<div class="hint" style="margin-top:10px"><b>æœ¬è¼ªæƒ…å¢ƒï¼š</b> ${esc(cur)}</div>`;
    }else{
      html += `<div class="pill">ä¾‹å¥å¼•å°ï¼ˆç…§è‘—è¬›ä¹Ÿå¯ä»¥ï¼‰</div>`;
      if(cur) html += `<div class="hint" style="margin-top:10px"><b>æœ¬è¼ªæƒ…å¢ƒï¼š</b> ${esc(cur)}</div>`;
      if(step.hint){
        html += `<div class="pill" style="margin-top:10px"><b>åƒè€ƒå›ç­”ï¼š</b> ${esc(step.hint.split("/")[0].trim())}</div>`;
      }else{
        html += `<div class="hint" style="margin-top:10px">æ²’æœ‰æä¾›ä¾‹å¥ã€‚ä½ å¯ä»¥å…ˆæŒ‰ã€Œé‡æ’­æœ¬å¥ã€è·Ÿè®€ï¼Œå†ç”¨è‡ªå·±çš„è©±èªªä¸€æ¬¡ã€‚</div>`;
      }
    }
    html += `<div class="hint" style="margin-top:10px">å°æŠ€å·§ï¼šå…ˆã€Œè·Ÿè®€ã€â†’ å†ã€Œæ”¹ä¸€å…©å€‹è©ã€â†’ æœ€å¾Œè‡ªå·±å®Œæ•´å›ç­”ã€‚</div>`;
    return html;
  }

  function htmlTrans(){
    const step = state.steps[state.idx] || {};
    const meta = state.sceneMeta || {};
    const ja = step.raw && (step.raw.ja || step.raw.line_ja || (step.raw.ai && step.raw.ai.ja)) ? (step.raw.ja || step.raw.line_ja || step.raw.ai.ja) : "";
    return `
      <div class="hint"><b>è‹±æ–‡ï¼š</b> ${esc(step.en||"")}</div>
      <div class="hint"><b>ä¸­æ–‡ï¼š</b> ${esc(step.zh||"ï¼ˆç„¡ï¼‰")}</div>
      <div class="hint"><b>æ—¥æ–‡ï¼š</b> ${esc(ja||"ï¼ˆç„¡ï¼‰")}</div>
      ${meta.source_url ? `<div class="hint"><b>ä¾†æºï¼š</b> ${esc(meta.source_url)}</div>`:""}
    `;
  }

  function htmlSaved(){
    if(!state.saved.length) return `<div class="hint">å°šæœªå„²å­˜ä»»ä½•å¥å­ã€‚ä½ å¯ä»¥å…ˆç”¨èªéŸ³è¾¨è­˜å¾ŒæŒ‰ã€Œå­˜é€™å¥ã€ã€‚</div>`;
    const items = state.saved.slice(0,80).map(t=>`<div class="pill">${esc(t)}</div>`).join("");
    return items + `<div class="hint" style="margin-top:10px">æç¤ºï¼šå„²å­˜æ˜¯å­˜åœ¨é€™å°è£ç½®çš„ç€è¦½å™¨ localStorageã€‚</div>`;
  }

  // --- events ---
  btnReplay.onclick = ()=> speak(state.steps[state.idx]?.en || "");
  btnSkip.onclick = ()=>{
    state.idx = Math.min(state.idx + 1, Math.max(0, state.steps.length-1));
    renderStep();
    speak(state.steps[state.idx]?.en || "");
  };
  btnType.onclick = ()=>{
    const expected = state.steps[state.idx]?.en || "";
    const html = `
      <div class="hint">æŠŠä½ æƒ³èªªçš„è‹±æ–‡æ‰“åœ¨ä¸‹é¢ï¼ŒæŒ‰ã€Œæ¯”å°ã€çœ‹çœ‹ã€‚</div>
      <textarea id="typed" style="width:100%;min-height:110px;border:1px solid var(--line);border-radius:14px;padding:10px;font-size:14px;"></textarea>
      <button class="btn brand" id="btnCheck" style="width:100%;margin-top:10px;border-radius:14px;">æ¯”å°</button>
      <div class="hint" id="typedResult" style="margin-top:10px"></div>
    `;
    openSheet("è¼¸å…¥æ¨¡å¼", html);
    setTimeout(()=>{
      const ta = document.getElementById("typed");
      const bt = document.getElementById("btnCheck");
      const out = document.getElementById("typedResult");
      if(ta) ta.value = expected;
      if(bt) bt.onclick = ()=>{
        const said = (ta && ta.value) ? ta.value : "";
        const score = simpleScore(expected, said);
        if(out) out.innerHTML = `<b>ç›¸ä¼¼åº¦ï¼ˆç²—ä¼°ï¼‰ï¼š</b> ${esc(score.toFixed(0))} / 100`;
      };
    },0);
  };
  btnSpeak.onclick = startRecognize;

  btnTask.onclick = ()=> openSheet("ä»»å‹™", htmlTask());
  btnExample.onclick = ()=> openSheet("ç¯„ä¾‹", htmlExamples());
  btnTrans.onclick = ()=> openSheet("ç¿»è­¯", htmlTrans());
  btnSaved.onclick = ()=> openSheet("å·²å„²å­˜", htmlSaved());

  sceneSelect.onchange = ()=>{
    const id = sceneSelect.value;
    const url = new URL(location.href);
    url.searchParams.set("scene", id);
    if(!url.searchParams.get("v")) url.searchParams.set("v", String(Date.now()));
    location.href = url.toString();
  };

  // --- init ---
  function setAvatar(avatar){
    const DEFAULT_AVATAR = "https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/assets/avatars/talk.mp4";
    const vid = document.getElementById("avatarVid");
    const img = document.getElementById("avatarImg");
    let url = (avatar && String(avatar).trim()) ? String(avatar).trim() : DEFAULT_AVATAR;

    // If it's a relative path like assets/avatars/xxx, keep as-is (GitHub Pages), but provide fallback.
    const isVideo = /\.(mp4|webm|mov)(\?|#|$)/i.test(url);

    function fallback(){
      if(vid){
        vid.pause?.();
        vid.removeAttribute("src");
        vid.style.display = "none";
      }
      if(img){
        img.style.display = "none";
      }
      // Always show default (video) as last resort
      if(vid){
        vid.src = DEFAULT_AVATAR;
        vid.style.display = "";
        vid.load?.();
      }
    }

    if(isVideo){
      if(img) img.style.display = "none";
      if(vid){
        vid.onerror = fallback;
        vid.src = url;
        vid.style.display = "";
        vid.load?.();
      }else{
        fallback();
      }
    }else{
      if(vid){
        vid.pause?.();
        vid.removeAttribute("src");
        vid.style.display = "none";
      }
      if(img){
        img.onerror = fallback;
        img.src = url;
        img.style.display = "";
      }else{
        fallback();
      }
    }
  }


  async function init(){
    try{
      const items = await loadIndex();
      // fill select
      const wanted = state.sceneId;
      sceneSelect.innerHTML = items.map(it=>{
        const id = it.id || it.slug || "";
        const zh = it.title_zh || it.titleZh || it.title || id;
        const en = it.title_en || it.titleEn || "";
        const lv = it.level ? ` (${it.level})` : "";
        const label = `${zh}${en?(" | "+en):""}${lv}`;
        return `<option value="${esc(id)}"${id===wanted?" selected":""}>${esc(label)}</option>`;
      }).join("");

      if(!state.sceneId){
        state.sceneId = (items[0].id || items[0].slug || "");
        const url = new URL(location.href);
        url.searchParams.set("scene", state.sceneId);
        if(!url.searchParams.get("v")) url.searchParams.set("v", String(Date.now()));
        location.replace(url.toString());
        return;
      }

      const metaFromIndex = items.find(it=> (it.id||it.slug) === state.sceneId) || {};
      // avatar / role
      const avatar = metaFromIndex.avatar || metaFromIndex.avatar_url || metaFromIndex.avatarUrl || "https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/talk/teacher/teacher_default.jpg";
      // default avatar (video) â€” never break UI if index.json has a missing jpg
      setAvatar(AVATAR.speak_vid);

      // if index.json provides a valid MP4 avatar, allow override
      const _avatarUrl = resolvePublicAssetUrl(avatar);
      if (typeof _avatarUrl === 'string' && _avatarUrl.toLowerCase().includes('.mp4')) {
        setAvatar(_avatarUrl);
      }

      // load scene data
      const {data, mode} = await loadScene(state.sceneId);
      state.mode = mode;

      const {meta, norm} = normalizeStepsFromSceneJson(data);
      state.sceneMeta = Object.assign({}, metaFromIndex, meta);

      // infer category for one-way-ticket, if missing
      if(!state.sceneMeta.category && !state.sceneMeta.cat && state.sceneId.includes("one-way-ticket")){
        state.sceneMeta.category = "news";
      }

      state.steps = norm.length ? norm : [{en:"ï¼ˆæ­¤æƒ…å¢ƒæœªæä¾›å°è©ï¼‰", zh:"", hint:"", role: state.sceneMeta.role||"AI"}];
      state.idx = 0;

      // labels
      roleLabel.textContent = "AI Â· " + (state.sceneMeta.role || "Teacher");
      sceneLabel.textContent = " " + (state.sceneMeta.title_zh || state.sceneMeta.title_en || state.sceneId || "");
      if(state.sceneMeta.avatar) // Keep default avatar video for all scenes; only override if sceneMeta.avatar is an MP4 URL
      const _metaAvatar = state.sceneMeta && state.sceneMeta.avatar;
      if (typeof _metaAvatar === 'string' && _metaAvatar.toLowerCase().includes('.mp4')) {
        setAvatar(resolvePublicAssetUrl(_metaAvatar));
      }

      renderStep();
      speak(state.steps[0].en);
    }catch(e){
      lineEn.textContent = "è¼‰å…¥å¤±æ•—";
      lineZh.textContent = String(e && e.message ? e.message : e);
      openSheet("éŒ¯èª¤", `<div class="hint">ç„¡æ³•è¼‰å…¥ talk/index.json æˆ–å ´æ™¯æª”ã€‚è«‹ç¢ºèªæª”æ¡ˆå·²ä¸Šå‚³åˆ° GitHub Pagesï¼š<br>
      <div class="pill">/talk/index.json</div>
      <div class="pill">/talk/{scene}.json æˆ– /talk/speaking-{scene}.json</div>
      </div><pre>${esc(String(e && (e.stack||e.message||e) || e))}</pre>`);
    }
  }

  init();
})();
</script>
</body>
</html>
