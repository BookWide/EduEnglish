<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å£èªªç·´ç¿’ Talkï½œBookWide</title>
  <meta name="description" content="BookWide å£èªªç·´ç¿’ï¼ˆTalkï¼‰â€” è½‰å¯«ã€AI å›è¦†ã€å³æ™‚ç³¾éŒ¯èˆ‡è·Ÿè®€ã€‚" />
  <style>
    :root{
      --bg:#f4f6fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --brand:#2563eb; --brand2:#1d4ed8; --soft:#eef2ff; --ok:#065f46; --bad:#b91c1c;
      --radius:18px; --shadow:0 14px 40px rgba(15,23,42,.10);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    html,body{margin:0; background:var(--bg); color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;}
    a{color:inherit; text-decoration:none}
    .topbar{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 18px; background:#0b1220; color:#fff;
    }
    .brand{display:flex; gap:10px; align-items:center; font-weight:800; letter-spacing:.2px}
    .beta{font-size:12px; padding:2px 8px; border-radius:999px; background:rgba(255,255,255,.12)}
    .right{display:flex; gap:10px; align-items:center}
    .pill{border:1px solid rgba(255,255,255,.25); background:rgba(255,255,255,.06);
      padding:8px 12px; border-radius:999px; font-size:14px;}
    .btn{border:0; cursor:pointer; border-radius:12px; padding:10px 14px; font-weight:700}
    .btn.primary{background:var(--brand); color:#fff}
    .btn.ghost{background:transparent; color:#fff; border:1px solid rgba(255,255,255,.25)}
    .wrap{max-width:1200px; margin:18px auto; padding:0 14px}
    .grid{display:grid; gap:14px}
    @media (min-width: 960px){
      .grid{grid-template-columns: 420px 1fr}
    }
    .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow)}
    .card .hd{padding:14px 16px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; gap:10px; align-items:center}
    .title{font-weight:900; font-size:16px}
    .muted{color:var(--muted); font-size:13px}
    .card .bd{padding:14px 16px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    select,input,textarea{font:inherit}
    select, input[type=text]{width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:#fff}
    textarea{width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:12px; min-height:88px; resize:vertical}
    .small{font-size:12px}
    .kbd{font-family:var(--mono); font-size:12px; padding:2px 6px; border:1px solid var(--line); border-bottom-width:2px; border-radius:8px; background:#fff}
    .chat{display:flex; flex-direction:column; gap:10px}
    .msg{border:1px solid var(--line); border-radius:16px; padding:10px 12px; background:#fff}
    .msg.me{background:#f8fafc}
    .msg.ai{background:var(--soft)}
    .msg .meta{display:flex; justify-content:space-between; gap:10px; margin-bottom:6px}
    .tag{font-size:12px; font-weight:800; letter-spacing:.3px}
    .tag.me{color:#334155}
    .tag.ai{color:#1d4ed8}
    .actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn2{border:1px solid var(--line); background:#fff; border-radius:12px; padding:10px 12px; font-weight:800; cursor:pointer}
    .btn2.primary{background:var(--brand); color:#fff; border-color:transparent}
    .btn2.danger{background:#fff; border-color:#fecaca; color:#b91c1c}
    .btn2:disabled{opacity:.55; cursor:not-allowed}
    .hint{padding:10px 12px; border-radius:14px; background:#fff7ed; border:1px solid #fed7aa; color:#9a3412; font-size:13px}
    .okbox{padding:10px 12px; border-radius:14px; background:#ecfdf5; border:1px solid #bbf7d0; color:#065f46; font-size:13px}
    .mono{font-family:var(--mono)}
    .split{display:grid; gap:10px}
    @media (min-width: 960px){ .split{grid-template-columns:1fr 1fr} }
    .foot{text-align:center; color:#94a3b8; font-size:12px; padding:20px 0}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div style="font-size:22px; line-height:1;">BookWide</div>
      <span class="beta">Talk</span>
    </div>
    <div class="right">
      <span id="userPill" class="pill">æœªç™»å…¥</span>
      <a id="backHome" class="pill" href="/index.html">å›é¦–é </a>
      <button id="btnSignOut" class="btn ghost" style="display:none;">ç™»å‡º</button>
    </div>
  </header>

  <div class="wrap">
    <div class="grid">
      <section class="card">
        <div class="hd">
          <div>
            <div class="title">å£èªªç·´ç¿’è¨­å®š</div>
            <div class="muted">MVPï¼šè¬›ä¸€å¥ â†’ è½‰å¯« â†’ AI å›è¦† â†’ ç«‹åˆ»ç³¾éŒ¯/è·Ÿè®€</div>
          </div>
        </div>
        <div class="bd">
          <div class="row" style="margin-bottom:10px;">
            <div style="flex:1; min-width:220px;">
              <div class="muted small" style="margin:0 0 6px;">ç·´ç¿’æ¨¡å¼</div>
              <select id="modeSel">
                <option value="roleplay">æƒ…å¢ƒå°è©±ï¼ˆRoleplayï¼‰</option>
                <option value="free">è‡ªç”±ç·´ç¿’ï¼ˆFree talkï¼‰</option>
                <option value="repeat">è·Ÿè®€è¨“ç·´ï¼ˆShadowingï¼‰</option>
              </select>
            </div>
            <div style="flex:1; min-width:220px;">
              <div class="muted small" style="margin:0 0 6px;">èªè¨€</div>
              <select id="langSel">
                <option value="en">è‹±æ–‡ï¼ˆENï¼‰</option>
                <option value="ja">æ—¥æ–‡ï¼ˆJPï¼‰</option>
                <option value="zh">ä¸­æ–‡ï¼ˆZHï¼‰</option>
              </select>
            </div>
          </div>

          <div style="margin-bottom:10px;">
            <div class="muted small" style="margin:0 0 6px;">æƒ…å¢ƒï¼ˆRoleplayï¼‰</div>
            <select id="sceneSel">
              <option value="intro">è‡ªæˆ‘ä»‹ç´¹ï¼ˆIntroduce yourselfï¼‰</option>
              <option value="restaurant">é»é¤ï¼ˆOrdering foodï¼‰</option>
              <option value="travel">å•è·¯ï¼ˆAsking for directionsï¼‰</option>
              <option value="interview">é¢è©¦ï¼ˆJob interviewï¼‰</option>
            </select>
          </div>

          <div class="hint" id="gateHint" style="display:none; margin-bottom:10px;">
            éœ€è¦ç™»å…¥ä¸”è¨‚é–±æœ‰æ•ˆæ‰èƒ½ä½¿ç”¨å£èªªç·´ç¿’ã€‚è‹¥ä½ ç¢ºå®šå·²è¨‚é–±ï¼Œè«‹åˆ°ã€Œæˆ‘çš„è¨‚é–±ã€ç¢ºèªåˆ°æœŸæ—¥æ˜¯å¦å·²å¯«å…¥ profiles.expires_atã€‚
          </div>

          <div class="okbox" id="readyBox" style="display:none; margin-bottom:10px;">
            âœ… å®ˆé–€é€šéï¼šä½ å¯ä»¥é–‹å§‹å£èªªç·´ç¿’ã€‚
          </div>

          <div class="split" style="margin-bottom:10px;">
            <div>
              <div class="muted small" style="margin:0 0 6px;">AI ç«¯é»ï¼ˆSupabase Edge Functionï¼‰</div>
              <input id="endpoint" type="text" value="/functions/v1/talk-chat" />
              <div class="muted small" style="margin-top:6px;">
                é è¨­å‘¼å« <span class="mono">/functions/v1/talk-chat</span>ï¼ˆä¹‹å¾Œæˆ‘å†çµ¦ä½  talk-chat Edge Function å®Œæ•´ç‰ˆï¼‰ã€‚
              </div>
            </div>
            <div>
              <div class="muted small" style="margin:0 0 6px;">æç¤ºï¼ˆå¯é¸ï¼‰</div>
              <input id="coachHint" type="text" value="ç”¨ç°¡å–®å¥ã€æ…¢æ…¢èªªã€‚å…ˆèªª 1~2 å¥å°±å¥½ã€‚" />
              <div class="muted small" style="margin-top:6px;">æœƒä¸€èµ·é€åˆ° AIï¼Œç”¨ä¾†æ§åˆ¶é¢¨æ ¼ï¼ˆæ•™ç·´å£å»ï¼‰ã€‚</div>
            </div>
          </div>

          <div class="actions">
            <button id="btnMic" class="btn2 primary">ğŸ™ï¸ é–‹å§‹èªª</button>
            <button id="btnStop" class="btn2" disabled>â¹ åœæ­¢</button>
            <button id="btnScene" class="btn2">ğŸ¬ å•Ÿå‹•æƒ…å¢ƒ</button>
            <button id="btnSend" class="btn2">â¡ï¸ é€å‡ºæ–‡å­—</button>
            <button id="btnClear" class="btn2 danger">æ¸…ç©ºå°è©±</button>
          </div>

          <div style="margin-top:10px;">
            <div class="muted small" style="margin:0 0 6px;">ä½ çš„å¥å­ï¼ˆè½‰å¯«/æ‰‹æ‰“ï¼‰</div>
            <textarea id="userText" placeholder="æŒ‰ã€é–‹å§‹èªªã€å¾Œæœƒè‡ªå‹•è½‰å¯«ï¼›æˆ–ä½ ä¹Ÿå¯ä»¥ç›´æ¥åœ¨é€™è£¡æ‰“å­—ã€‚"></textarea>
            <div class="muted small" style="margin-top:6px;">
              å¿«æ·éµï¼š<span class="kbd">Ctrl</span>+<span class="kbd">Enter</span> é€å‡º
            </div>
          </div>

          <div style="margin-top:12px;">
            <div class="muted small" style="margin:0 0 6px;">è·Ÿè®€å¥ï¼ˆAI å›è¦†å¾Œå¯æŒ‰æ’­æ”¾ï¼‰</div>
            <div class="row">
              <button id="btnSpeakAI" class="btn2" disabled>ğŸ”Š æœ—è®€ AI</button>
              <button id="btnSpeakFix" class="btn2" disabled>ğŸ” æœ—è®€ã€Œæ›´è‡ªç„¶ç‰ˆæœ¬ã€</button>
              <span class="muted small">ï¼ˆç€è¦½å™¨ TTSï¼›ä¹‹å¾Œå¯æ›ä½ çš„ Azure TTS / Supabase MP3ï¼‰</span>
            </div>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="hd">
          <div>
            <div class="title">å°è©±èˆ‡ç³¾éŒ¯</div>
            <div class="muted">AI æœƒå›è¦† + çµ¦ã€Œæ›´è‡ªç„¶ç‰ˆæœ¬ / ä¸€å€‹é‡é» / è·Ÿè®€å¥ã€ã€‚</div>
          </div>
          <div class="muted small" id="status">å¾…å‘½</div>
        </div>
        <div class="bd">
          <div id="chat" class="chat"></div>
        </div>
      </section>
    </div>

    <div class="foot">BookWide Â© 2026 Â· Talk MVP</div>
  </div>

  <script type="module">
    const ROOT_BASE = (
      location.pathname.startsWith('/EduEnglish') || location.hostname.includes('github.io')
    ) ? '/EduEnglish' : '';

    const backHome = document.getElementById('backHome');
    backHome.href = (ROOT_BASE || '') + '/index.html';

    // ä½¿ç”¨ä½ çš„ supa.jsï¼ˆESM exports: supabase, BWï¼‰
    import { supabase, BW } from './supa.js';

    // ===== å®ˆé–€ï¼šéœ€ç™»å…¥ + è¨‚é–±æœ‰æ•ˆï¼ˆèˆ‡ BookWide Player åŒé‚è¼¯ï¼‰=====
    async function bwRequireTalkAccess(){
      const next = encodeURIComponent(location.pathname + location.search);

      // 1) å¿…é ˆç™»å…¥
      const user = await BW.getUser();
      if (!user){
        // å›é¦–é ç™»å…¥ï¼ˆä½ ç¾æœ‰ç™»å…¥å…¥å£ï¼‰
        location.href = `/index.html#login`;
        throw new Error('BW_TALK_DENY_NOLOGIN');
      }

      // 2) ç®¡ç†å“¡æ”¾è¡Œï¼ˆå¯é¸ï¼‰
      try{
        const prof = await supabase.from('profiles').select('*').eq('id', user.id).maybeSingle();
        const p = prof?.data || null;
        if (p?.is_admin === true) return { user, is_admin:true, profile:p };

        // 3) å¾ profiles è£¡æ‰¾ã€Œåˆ°æœŸæ—¥ã€æ¬„ä½ï¼ˆç”¨ select('*') é¿å…æ¬„ä½ä¸å­˜åœ¨å ±éŒ¯ï¼‰
        const candKeys = [
          'expires_at','expire_at','paid_until','subscription_expires_at','subscription_expiry',
          'plan_expires_at','pro_expires_at','active_until'
        ];
        let exp = null;
        for (const k of candKeys){
          if (p && p[k]){
            const d = new Date(p[k]);
            if (!isNaN(d.getTime())) { exp = d; break; }
          }
        }
        const now = new Date();
        if (exp && exp.getTime() > now.getTime()){
          return { user, is_admin:false, profile:p, expires_at:exp.toISOString() };
        }
      }catch(e){
        console.warn('[talk] profiles check failed', e);
      }

      // 4) é€€è€Œæ±‚å…¶æ¬¡ï¼šå˜—è©¦ subscriptions / ordersï¼ˆå®¹éŒ¯ï¼Œä¸åŒæ¬„ä½ä¹Ÿèƒ½è·‘ï¼‰
      async function tryTable(table, userKey){
        try{
          const r = await supabase.from(table).select('*').eq(userKey, user.id).order('created_at', { ascending:false }).limit(1);
          if (r.error) return null;
          const row = (r.data && r.data[0]) ? r.data[0] : null;
          return row;
        }catch(_){ return null; }
      }
      function pickExpiry(row){
        if (!row) return null;
        const keys = ['expires_at','expire_at','paid_until','valid_until','end_at','end_date','expiry','expire_date'];
        for (const k of keys){
          if (row[k]){
            const d = new Date(row[k]);
            if (!isNaN(d.getTime())) return d;
          }
        }
        return null;
      }
      function isPaid(row){
        if (!row) return false;
        const s = String(row.status || row.pay_status || row.state || '').toLowerCase();
        return s === 'paid' || s === 'success' || s === 'succeeded' || s === 'ok';
      }

      // subscriptions
      const sub = (await tryTable('subscriptions','user_id')) ||
                  (await tryTable('subscriptions','uid')) ||
                  (await tryTable('subscriptions','profile_id'));
      const subExp = pickExpiry(sub);
      if (subExp && subExp.getTime() > Date.now()){
        return { user, is_admin:false, subscription:sub, expires_at:subExp.toISOString() };
      }

      // ordersï¼ˆéœ€ paid + æœªéæœŸï¼‰
      const ord = (await tryTable('orders','user_id')) ||
                  (await tryTable('orders','uid')) ||
                  (await tryTable('orders','profile_id'));
      const ordExp = pickExpiry(ord);
      if (isPaid(ord) && ordExp && ordExp.getTime() > Date.now()){
        return { user, is_admin:false, order:ord, expires_at:ordExp.toISOString() };
      }

      // 5) ä¸é€šé â†’ å» pricing
      location.href = `/pricing.html?denied=noactive&next=${next}`;
      throw new Error('BW_TALK_DENY_NOACTIVE');
    }

    // é€²é ç«‹åˆ»å®ˆé–€
    let BW_ACCESS = null;
    try{
      BW_ACCESS = await bwRequireTalkAccess();
      // é¡¯ç¤ºç™»å…¥è³‡è¨Š
      try{
        const ut = document.getElementById('userText');
        if (ut && BW_ACCESS?.user?.email){
          const email = BW_ACCESS.user.email;
          ut.textContent = email.length > 24 ? (email.slice(0,18) + 'â€¦') : email;
        }
      }catch(_){}

    }catch(e){
      // å·² redirect
      console.warn(e);
      return;
    }


    const $ = (s, e=document) => e.querySelector(s);
    const chat = $('#chat');
    const statusEl = $('#status');
    const userPill = $('#userPill');
    const btnSignOut = $('#btnSignOut');
    const gateHint = $('#gateHint');
    const readyBox = $('#readyBox');

    const modeSel = $('#modeSel');
    const langSel = $('#langSel');
    const sceneSel = $('#sceneSel');
    const endpointEl = $('#endpoint');
    const coachHintEl = $('#coachHint');
    const userText = $('#userText');

    const btnMic = $('#btnMic');
    const btnStop = $('#btnStop');
    const btnScene = $('#btnScene');
    const btnSend = $('#btnSend');
    const btnClear = $('#btnClear');
    const btnSpeakAI = $('#btnSpeakAI');
    const btnSpeakFix = $('#btnSpeakFix');

    const messages = [];
    let currentUser = null;
    let lastAI = '';
    let lastFix = '';
    let recog = null;
    let recognizing = false;

    function setStatus(t){ statusEl.textContent = t; }
    function esc(s){ return String(s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    function addMsg(who, text, extra={}){
      const div = document.createElement('div');
      div.className = 'msg ' + (who === 'me' ? 'me' : 'ai');
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `
        <span class="tag ${who === 'me' ? 'me' : 'ai'}">${who === 'me' ? 'YOU' : 'AI'}</span>
        <span class="muted small">${new Date().toLocaleTimeString()}</span>
      `;
      const body = document.createElement('div');
      body.innerHTML = `<div style="white-space:pre-wrap; line-height:1.55;">${esc(text)}</div>`;

      if (extra.fix || extra.focus || extra.shadow){
        const box = document.createElement('div');
        box.style.marginTop = '10px';
        box.style.display = 'grid';
        box.style.gap = '8px';
        box.innerHTML = `
          ${extra.fix ? `<div class="msg" style="background:#ffffff;"><div class="muted small" style="margin-bottom:4px;">æ›´è‡ªç„¶ç‰ˆæœ¬</div><div style="white-space:pre-wrap;">${esc(extra.fix)}</div></div>` : ''}
          ${extra.focus ? `<div class="msg" style="background:#ffffff;"><div class="muted small" style="margin-bottom:4px;">é‡é»ï¼ˆ1 å€‹å°±å¥½ï¼‰</div><div style="white-space:pre-wrap;">${esc(extra.focus)}</div></div>` : ''}
          ${extra.shadow ? `<div class="msg" style="background:#ffffff;"><div class="muted small" style="margin-bottom:4px;">è·Ÿè®€å¥</div><div style="white-space:pre-wrap;">${esc(extra.shadow)}</div></div>` : ''}
        `;
        body.appendChild(box);
      }

      div.appendChild(meta);
      div.appendChild(body);
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function speak(text){
      if (!('speechSynthesis' in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      const lang = langSel.value;
      u.lang = (lang === 'en') ? 'en-US' : (lang === 'ja') ? 'ja-JP' : 'zh-TW';
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }
    btnSpeakAI.addEventListener('click', ()=>{ if(lastAI) speak(lastAI); });
    btnSpeakFix.addEventListener('click', ()=>{ if(lastFix) speak(lastFix); });

    // ä»¥ profiles.expires_at ä½œç‚ºå”¯ä¸€è¨‚é–±åˆ¤å®šï¼ˆå’Œä½ ç¾åœ¨çš„ player å®ˆé–€ä¸€è‡´ï¼‰
    async function ensureGate(){
      setStatus('æª¢æŸ¥ç™»å…¥/è¨‚é–±â€¦');
      gateHint.style.display = 'none';
      readyBox.style.display = 'none';

      const next = location.pathname + location.search;

      // âœ… ä»¥ Session ç‚ºæº–ï¼ˆæœ€ç©©ã€ä¹Ÿè·Ÿ player ä¸€è‡´ï¼‰
      const { data: { session } } = await supabase.auth.getSession();
      currentUser = session?.user || null;

      // ç›£è½ç™»å…¥ç‹€æ…‹ï¼šè‹¥è¢«ä½ ã€Œå–®è£ç½®å®ˆé–€ã€è¸¢å‡ºï¼Œæœƒç«‹åˆ»å°å›ç™»å…¥
      if (!window.__bwTalkAuthSub){
        window.__bwTalkAuthSub = supabase.auth.onAuthStateChange((event, s)=>{
          const u = s?.user || null;
          if (!u){
            userPill.textContent = 'æœªç™»å…¥';
            btnSignOut.style.display = 'none';
            gateHint.style.display = 'block';
            setStatus('å·²ç™»å‡º/è¢«è¸¢å‡º â†’ å›é¦–é ç™»å…¥');
            location.href = (ROOT_BASE || '') + '/index.html#login?next=' + encodeURIComponent(next);
            return;
          }
          currentUser = u;
          userPill.textContent = u.email || ('User ' + u.id.slice(0,6));
          btnSignOut.style.display = '';
        });
      }

      if (!currentUser){
        userPill.textContent = 'æœªç™»å…¥';
        btnSignOut.style.display = 'none';
        gateHint.style.display = 'block';
        setStatus('æœªç™»å…¥ â†’ å›é¦–é ç™»å…¥');
        location.href = (ROOT_BASE || '') + '/index.html#login?next=' + encodeURIComponent(next);
        return false;
      }

      // é¡¯ç¤ºç™»å…¥è€…
      userPill.textContent = currentUser.email || ('User ' + currentUser.id.slice(0,6));
      btnSignOut.style.display = '';
      btnSignOut.onclick = async ()=>{
        await supabase.auth.signOut();
        location.href = (ROOT_BASE || '') + '/index.html';
      };

      // ç®¡ç†å“¡æ”¾è¡Œï¼ˆprofiles.is_adminï¼‰
      try{
        const r = await supabase.from('profiles').select('is_admin').eq('id', currentUser.id).maybeSingle();
        if (r?.data?.is_admin){
          readyBox.style.display = 'block';
          setStatus('ç®¡ç†å“¡ï¼šå·²æ”¾è¡Œ');
          return true;
        }
      }catch(_){}

      // è¨‚é–±åˆ°æœŸæ—¥ï¼ˆèˆ‡ä½ ç¾è¡Œå¯«æ³•ä¸€è‡´ï¼šprofiles.expires_atï¼‰
      const { data: p, error } = await supabase
        .from('profiles')
        .select('expires_at')
        .eq('id', currentUser.id)
        .maybeSingle();

      if (error){
        console.warn('profiles read error', error);
      }

      const exp = p?.expires_at ? new Date(p.expires_at) : null;
      const ok = exp && !isNaN(exp.getTime()) && exp.getTime() > Date.now();

      if (!ok){
        // æ²’è¨‚é–±æˆ–å·²éæœŸ â†’ å» pricing
        const next2 = encodeURIComponent(location.pathname + location.search);
        location.href = (ROOT_BASE || '') + '/pricing.html?denied=noactive&next=' + next2;
        return false;
      }

      readyBox.style.display = 'block';
      setStatus('å®ˆé–€é€šéï¼šå¯ä»¥é–‹å§‹å£èªªç·´ç¿’');
      return true;
    }


    // Web Speech Recognitionï¼ˆChrome æ¡Œæ©Ÿé€šå¸¸æ”¯æ´ï¼‰
    function initSpeech(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) return null;
      const r = new SR();
      r.continuous = false;
      r.interimResults = true;
      r.maxAlternatives = 1;
      r.lang = (langSel.value === 'en') ? 'en-US' : (langSel.value === 'ja') ? 'ja-JP' : 'zh-TW';

      r.onstart = ()=>{ recognizing = true; btnMic.disabled = true; btnStop.disabled = false; setStatus('éŒ„éŸ³ä¸­â€¦'); };
      r.onend = ()=>{ recognizing = false; btnMic.disabled = false; btnStop.disabled = true; setStatus('å¾…å‘½'); };
      r.onerror = (e)=>{ console.warn('speech error', e); setStatus('èªéŸ³è¾¨è­˜å¤±æ•—ï¼ˆå¯æ”¹ç”¨æ‰‹æ‰“ï¼‰'); };
      r.onresult = (evt)=>{
        let finalText = '';
        let interim = '';
        for (let i=evt.resultIndex; i<evt.results.length; i++){
          const t = evt.results[i][0].transcript;
          if (evt.results[i].isFinal) finalText += t;
          else interim += t;
        }
        userText.value = (finalText || interim).trim();
      };
      return r;
    }
    function refreshRecog(){
      try{ if(recog && recognizing) recog.stop(); }catch(_){}
      recog = initSpeech();
    }
    langSel.addEventListener('change', ()=>{ refreshRecog(); });

    btnMic.addEventListener('click', ()=>{
      if (!recog) {
        alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼ˆSpeechRecognitionï¼‰ã€‚ä½ ä»å¯ç”¨æ‰‹æ‰“ + é€å‡ºã€‚\\n\\nå»ºè­°ï¼šChrome æ¡Œæ©Ÿé€šå¸¸æ”¯æ´ã€‚');
        return;
      }
      try{ recog.start(); }catch(e){ console.warn(e); }
    });
    btnStop.addEventListener('click', ()=>{ try{ recog?.stop(); }catch(_){ } });

    function systemPrompt(){
      const mode = modeSel.value;
      const lang = langSel.value;
      const scene = sceneSel.value;

      const sceneMap = {
        intro: 'ä½ æ˜¯å£èªªæ•™ç·´ã€‚æƒ…å¢ƒï¼šè‡ªæˆ‘ä»‹ç´¹ã€‚ç›®æ¨™ï¼šè®“ä½¿ç”¨è€…ç”¨ç°¡çŸ­è‡ªç„¶å¥è¡¨é”è‡ªå·±ã€‚',
        restaurant: 'ä½ æ˜¯å£èªªæ•™ç·´ã€‚æƒ…å¢ƒï¼šé¤å»³é»é¤ã€‚ç›®æ¨™ï¼šèƒ½è‡ªç„¶ä¸‹å–®ã€è©¢å•æ¨è–¦ã€ç¢ºèªéœ€æ±‚ã€‚',
        travel: 'ä½ æ˜¯å£èªªæ•™ç·´ã€‚æƒ…å¢ƒï¼šæ—…éŠå•è·¯ã€‚ç›®æ¨™ï¼šèƒ½å•æ–¹å‘ã€ç¢ºèªåœ°æ¨™ã€é“è¬ã€‚',
        interview: 'ä½ æ˜¯å£èªªæ•™ç·´ã€‚æƒ…å¢ƒï¼šé¢è©¦ã€‚ç›®æ¨™ï¼šç”¨æ¢ç†å›ç­”ã€èªæ°£è‡ªä¿¡è‡ªç„¶ã€‚',
      };

      const base = sceneMap[scene] || sceneMap.intro;
      const hint = (coachHintEl.value || '').trim();

      return `
ä½ æ˜¯ä¸€ä½ã€Œåš´æ ¼ä½†å‹å–„ã€çš„èªè¨€å£èªªæ•™ç·´ã€‚
è«‹ç”¨ JSON å›è¦†ï¼Œæ ¼å¼å›ºå®šç‚ºï¼š

å¦å¤–ï¼šè‹¥ meta.intent == "scene_opening" æˆ–ä½¿ç”¨è€…è¼¸å…¥ç‚º "START_SCENE"ï¼Œè«‹åªè¼¸å‡ºé–‹å ´å¥åœ¨ replyï¼ˆæˆ– coach_openingï¼‰ï¼Œå…¶é¤˜ fix/focus/shadow å¯ç‚ºç©ºå­—ä¸²ã€‚
{
  "reply": "AI çš„å›è¦†ï¼ˆå°è©±å¼ï¼‰",
  "fix": "æŠŠä½¿ç”¨è€…å¥å­æ”¹æˆæ›´è‡ªç„¶ç‰ˆæœ¬ï¼ˆè¶ŠçŸ­è¶Šå¥½ï¼‰",
  "focus": "åªæŒ‘ 1 å€‹æœ€é‡è¦çš„ç³¾éŒ¯é»ï¼ˆæ–‡æ³•/ç™¼éŸ³/ç”¨å­—æ“‡ä¸€ï¼‰",
  "shadow": "ä¸€å€‹æœ€é©åˆè·Ÿè®€çš„çŸ­å¥ï¼ˆè·Ÿ fix å¯ç›¸åŒï¼‰",
  "score": 0~100
}

è¦å‰‡ï¼š
- reply ç”¨å°è©±å£å»ï¼Œè®“ä½¿ç”¨è€…é¡˜æ„æ¥è‘—èªªä¸‹ä¸€å¥ã€‚
- fix / focus / shadow å¿…é ˆç²¾ç°¡ã€‚
- è‹¥ä½¿ç”¨è€…è¬›ä¸­æ–‡ä½†æ¨¡å¼æ˜¯è‹±æ–‡ï¼Œè«‹å¼•å°ä»–ç”¨è‹±æ–‡å›ç­”ã€‚
- ä¸è¦è¼¸å‡ºå¤šé¤˜æ–‡å­—ï¼Œåªè¼¸å‡º JSONã€‚
- ç›®æ¨™ï¼šæ¯å›åˆåªä¿® 1 å€‹é‡é»ï¼Œé¿å…ä½¿ç”¨è€…æŒ«æŠ˜ã€‚

æ¨¡å¼ï¼š${mode}
èªè¨€ï¼š${lang}
æƒ…å¢ƒï¼š${base}
é¡å¤–æç¤ºï¼š${hint}
      `.trim();
    }

    async function callAI(userLine, metaOverride=null){
      const sliced = messages.slice(-12);

      const payload = {
        messages: [
          { role:'system', content: systemPrompt() },
          ...sliced,
          { role:'user', content: userLine }
        ],
        meta: {
          mode: modeSel.value,
          lang: langSel.value,
          scene: sceneSel.value,
          ts: new Date().toISOString(),
          ...(metaOverride||{})
        }
      };

      const endpoint = (endpointEl.value || '').trim() || '/functions/v1/talk-chat';

      // å„ªå…ˆèµ° supabase.functions.invokeï¼ˆä½ å·²è™•ç†å¥½ CORS / auth çš„è©±æœƒæ›´ç©©ï¼‰
      try {
        if (supabase?.functions?.invoke) {
          const fnName = endpoint.replace(/^\/functions\/v1\//,'').replace(/^\//,'');
          const r = await supabase.functions.invoke(fnName, { body: payload });
          if (r.error) throw r.error;
          return r.data;
        }
      } catch(e) {
        console.warn('[talk] functions.invoke failed, fallback fetch', e);
      }

      // é€€å› fetchï¼ˆéœ€è¦ Edge Function æœ‰å› CORSï¼‰
      const res = await fetch(endpoint, {
        method: 'POST',
        headers: { 'content-type':'application/json' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error('AI endpoint HTTP ' + res.status);
      return await res.json();
    }

    // ===== æƒ…å¢ƒå•Ÿå‹•ï¼ˆA æ¨¡å¼ï¼šæ‰‹å‹•é¸æƒ…å¢ƒ â†’ AI é–‹å ´ï¼‰=====
    const SCENE_OPENING = {
      nails: [
        "Hey! Are you doing your nails?",
        "What color are you going for today?"
      ],
      makeup: [
        "Looks like you're doing your makeup!",
        "What kind of look are you trying today?"
      ],
      cooking: [
        "Are you cooking right now?",
        "What are you making?"
      ],
      eating: [
        "Are you eating now?",
        "What are you having?"
      ],
      coffee: [
        "Is that coffee or a drink?",
        "How does it taste?"
      ],
      shopping: [
        "Are you shopping?",
        "What are you looking for?"
      ],
      gym: [
        "Are you working out?",
        "What exercise are you doing today?"
      ],
      commute: [
        "Are you on your way somewhere?",
        "Where are you heading?"
      ],
      cleaning: [
        "Looks like you're cleaning.",
        "What are you cleaning today?"
      ],
      pet: [
        "Aww, is that your pet?",
        "Whatâ€™s your petâ€™s name?"
      ],
      intro: [
        "Let's practice speaking!",
        "Tell me one short sentence about yourself."
      ]
    };

    async function startScene(){
      const sceneId = sceneSel.value || 'intro';

      setStatus('å•Ÿå‹•æƒ…å¢ƒâ€¦');
      btnScene.disabled = true;
      btnSend.disabled = true;
      btnMic.disabled = true;
      btnStop.disabled = true;

      try{
        // å‘¼å« AIï¼šç”¨ START_SCENE ä½œç‚ºè§¸ç™¼å­—
        const data = await callAI("START_SCENE", { intent: "scene_opening", scene_id: sceneId });

        // å…è¨±å¾Œç«¯å› coach_opening æˆ– reply
        const opening = (data && (data.coach_opening || data.reply)) || '';
        if (opening){
          lastAI = opening;
          lastFix = '';
          addMsg('ai', opening);
          messages.push({ role:'assistant', content: opening });
          btnSpeakAI.disabled = !lastAI;
          btnSpeakFix.disabled = true;
          setStatus('å°±ç·’ Â· å·²å•Ÿå‹•æƒ…å¢ƒ');
          return;
        }
        throw new Error('AI opening missing');
      }catch(e){
        console.warn('[talk] startScene fallback', e);
        // fallbackï¼šç”¨å‰ç«¯æ¨¡æ¿çµ¦é–‹å ´ï¼ˆå¾Œç«¯æœªæ¥å¥½ä¹Ÿèƒ½ç”¨ï¼‰
        const arr = SCENE_OPENING[sceneId] || SCENE_OPENING.intro;
        const opening = arr.join("\n");
        lastAI = opening;
        lastFix = '';
        addMsg('ai', opening);
        messages.push({ role:'assistant', content: opening });
        btnSpeakAI.disabled = !lastAI;
        btnSpeakFix.disabled = true;
        setStatus('å°±ç·’ Â· å·²å•Ÿå‹•æƒ…å¢ƒï¼ˆæœ¬æ©Ÿæ¨¡æ¿ï¼‰');
      }finally{
        btnScene.disabled = false;
        btnSend.disabled = false;
        btnMic.disabled = false;
        btnStop.disabled = true;
      }
    }
    btnScene.addEventListener('click', startScene);


    async function sendLine(){
      const line = (userText.value || '').trim();
      if (!line) return;

      addMsg('me', line);
      messages.push({ role:'user', content: line });
      userText.value = '';

      setStatus('AI æ€è€ƒä¸­â€¦');
      btnSend.disabled = true;
      btnMic.disabled = true;
      btnStop.disabled = true;

      try {
        const data = await callAI(line);
        const reply = data?.reply ?? '(AI æœªå›è¦† reply)';
        const fix = data?.fix ?? '';
        const focus = data?.focus ?? '';
        const shadow = data?.shadow ?? '';
        const score = Number.isFinite(data?.score) ? data.score : null;

        lastAI = reply;
        lastFix = fix || shadow || '';

        addMsg('ai', reply, { fix, focus, shadow });
        messages.push({ role:'assistant', content: reply });

        btnSpeakAI.disabled = !lastAI;
        btnSpeakFix.disabled = !lastFix;

        setStatus(score != null ? ('å®Œæˆ Â· score ' + score) : 'å®Œæˆ');
      } catch (e) {
        console.error(e);
        setStatus('AI ç«¯é»å¤±æ•—ï¼ˆå…ˆç”¨æ‰‹æ‰“ç·´ç¿’ä¹Ÿå¯ä»¥ï¼‰');
        addMsg('ai',
`ï¼ˆç›®å‰é‚„æ²’æ¥ä¸Š talk-chat Edge Functionï¼Œæ‰€ä»¥ AI å›è¦†å¤±æ•—ï¼‰
ä½ å¯ä»¥å…ˆç…§é€™æ¨£ç·´ï¼š
1) ä½ æ‰“ä¸€å…©å¥è‹±æ–‡
2) è‡ªå·±æŠŠå¥å­ç¸®çŸ­
3) å†æ”¹æˆæ›´è‡ªç„¶ç‰ˆæœ¬

å¦‚æœä½ è¦æˆ‘ç¾åœ¨å°±æŠŠ talk-chat Edge Function ä¹Ÿè£œä¸Šï¼Œæˆ‘å¯ä»¥ç›´æ¥çµ¦ä½ å®Œæ•´å¯ deploy çš„ç¨‹å¼ã€‚`);
      } finally {
        btnSend.disabled = false;
        btnMic.disabled = false;
        btnStop.disabled = true;
      }
    }

    btnSend.addEventListener('click', sendLine);
    btnClear.addEventListener('click', ()=>{
      chat.innerHTML = '';
      messages.length = 0;
      lastAI = ''; lastFix = '';
      btnSpeakAI.disabled = true;
      btnSpeakFix.disabled = true;
      setStatus('å·²æ¸…ç©º');
    });
    userText.addEventListener('keydown', (e)=>{
      if (e.ctrlKey && e.key === 'Enter') sendLine();
    });

    addMsg('ai', 'æ­¡è¿ä¾†åˆ° BookWide Talkã€‚å…ˆæŒ‰ã€ŒğŸ™ï¸é–‹å§‹èªªã€æˆ–ç›´æ¥æ‰“å­—ï¼Œè¬› 1 å¥å°±å¥½ã€‚\n\nä¾‹ï¼šI am learning English for work.');
    refreshRecog();
    await ensureGate();
  </script>
</body>
</html>
