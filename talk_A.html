<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Talk Aï¼ˆæ‰‹æ©Ÿå£èªªï¼‰ï½œBookWide</title>
  <style>
    :root{
      --bg:#ffffff; --ink:#0b1220; --muted:#5b667a; --line:#e6eaf0; --soft:#f6f8fb;
      --pill:#111827; --pillText:#ffffff; --shadow:0 10px 28px rgba(10,20,40,.10);
      --radius:18px; --radius2:24px; --btn:#0b66ff; --btn2:#084fc6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      background:var(--bg); color:var(--ink); overflow:hidden;
    }
    .app{height:100%;display:flex;flex-direction:column;padding:12px 12px calc(12px + env(safe-area-inset-bottom));gap:10px;max-width:980px;margin:0 auto;}
    .top{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;box-shadow:var(--shadow);}
    .back{width:36px;height:36px;border-radius:999px;border:1px solid var(--line);background:#fff;display:grid;place-items:center;cursor:pointer;flex:0 0 auto;}
    .title{display:flex;flex-direction:column;gap:2px;min-width:0;}
    .title b{font-size:15px;line-height:1.1}
    .title small{font-size:12px;color:var(--muted)}
    .spacer{flex:1}
    .scenario{display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:999px;padding:8px 10px;background:var(--soft);min-width:220px;max-width:420px;}
    .scenario select{width:100%;border:0;background:transparent;font-size:14px;outline:none;color:var(--ink);appearance:none;}
    .btn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 10px;cursor:pointer;font-size:13px;white-space:nowrap;}
    .stage{flex:1;min-height:0;border:1px solid var(--line);border-radius:var(--radius2);background:#fff;box-shadow:var(--shadow);padding:14px;display:flex;flex-direction:column;gap:10px;}
    .who{display:flex;align-items:center;gap:10px;}
    .pill{display:inline-flex;align-items:center;gap:8px;background:var(--pill);color:var(--pillText);border-radius:999px;padding:6px 10px;font-size:12px;}
    .statusDot{width:8px;height:8px;border-radius:99px;background:#94a3b8;}
    .statusDot.on{background:#10b981}
    .who small{color:var(--muted)}

    .center{display:grid;place-items:center;padding:8px 0 2px;}
    .avatarWrap{
      width:min(260px,70vw); aspect-ratio:1/1; border-radius:999px;
      background:radial-gradient(circle at 30% 30%, #e9eef7, #ffffff 55%, #e9eef7);
      border:1px solid var(--line);
      box-shadow:0 20px 60px rgba(10,20,40,.12) inset;
      display:grid; place-items:center; position:relative; overflow:hidden;
    }
    .avatarImg{
      width:78%; height:78%; border-radius:999px; object-fit:cover;
      border:6px solid rgba(255,255,255,.9);
      box-shadow:0 18px 48px rgba(10,20,40,.18);
      background:#fff;
      transition:transform .18s ease, box-shadow .18s ease;
    }
    .avatarWrap.speaking .avatarImg{transform:scale(1.03); box-shadow:0 26px 80px rgba(0,0,0,.22);}
    .avatarVid{
      display:none;
      width:78%; height:78%; border-radius:999px; object-fit:cover;
      border:6px solid rgba(255,255,255,.9);
      box-shadow:0 18px 48px rgba(10,20,40,.18);
      background:#fff;
    }
    .avatarWrap.speaking .avatarImg{display:none;}
    .avatarWrap.speaking .avatarVid{display:block;transform:scale(1.03); box-shadow:0 26px 80px rgba(0,0,0,.22);}


    .dialog{border:1px solid var(--line);border-radius:var(--radius);padding:14px;background:var(--soft);}
    .dialog .en{font-size:22px;line-height:1.35;font-weight:800;letter-spacing:.2px;}
    .dialog .zh{margin-top:6px;font-size:13px;color:var(--muted);line-height:1.4;}
    .note{border:1px dashed var(--line);border-radius:var(--radius);padding:10px 12px;color:var(--muted);font-size:12px;line-height:1.4;background:#fff;}
    .controls{display:flex;flex-direction:column;gap:10px;}
    .micRow{display:flex;align-items:center;gap:10px;}
    .micBtn{
      flex:1;border:0;background:linear-gradient(180deg,var(--btn),var(--btn2));color:#fff;border-radius:999px;
      padding:14px 16px;font-weight:800;font-size:15px;cursor:pointer;box-shadow:0 14px 30px rgba(11,102,255,.25);
      display:flex;align-items:center;justify-content:center;gap:10px;
    }
    .skipBtn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:14px 16px;font-weight:700;cursor:pointer;min-width:96px;}
    .helperRow{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;}
    .helperBtn{border:1px solid var(--line);background:#fff;border-radius:var(--radius);padding:12px 10px;text-align:left;cursor:pointer;min-height:62px;box-shadow:0 8px 18px rgba(10,20,40,.06);}
    .helperBtn b{display:block;font-size:14px}
    .helperBtn small{display:block;margin-top:4px;color:var(--muted);font-size:12px}
    .softHint{margin-top:12px;padding:12px 14px;border:1px solid var(--line);border-radius:14px;background:#fff7ed;color:#7c2d12;font-size:15px;line-height:1.35;box-shadow:0 10px 28px rgba(15,23,42,.08)}
    .softHint b{font-weight:800}
    .softHint .sub{display:block;margin-top:6px;color:#92400e;font-size:13px}

    .sheetMask{position:fixed;inset:0;background:rgba(0,0,0,.28);display:none;z-index:50;}
    .sheetMask.show{display:block}
    .sheet{position:fixed;left:0;right:0;bottom:0;background:#fff;border-radius:18px 18px 0 0;border:1px solid var(--line);
      box-shadow:0 -24px 60px rgba(10,20,40,.18);max-width:980px;margin:0 auto;max-height:78vh;transform:translateY(110%);
      transition:transform .22s ease;z-index:51;overflow:hidden;}
    .sheet.show{transform:translateY(0)}
    .sheetHead{display:flex;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid var(--line);background:var(--soft);}
    .grab{width:42px;height:5px;border-radius:99px;background:#cfd6e3;margin:0 auto;}
    .sheetClose{margin-left:auto;border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 10px;cursor:pointer;font-weight:800;font-size:13px;}
    .sheetBody{padding:14px;overflow:auto;max-height:calc(78vh - 52px);}
    .card{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff;margin-bottom:10px;}
    .card h3{margin:0 0 8px 0;font-size:14px}
    .card p{margin:0;color:var(--muted);line-height:1.5}
    .row{display:flex;flex-wrap:wrap;gap:8px;}
    .tag{display:inline-flex;align-items:center;padding:4px 8px;border-radius:999px;background:var(--soft);border:1px solid var(--line);font-size:12px;color:var(--muted);}

    .gate{position:fixed;inset:0;background:rgba(255,255,255,.92);display:none;z-index:80;padding:22px;}
    .gate.show{display:flex;align-items:center;justify-content:center}
    .gateBox{width:min(520px,92vw);border:1px solid var(--line);border-radius:18px;background:#fff;box-shadow:var(--shadow);padding:16px;text-align:center;}
    .gateBox h2{margin:6px 0 8px 0;font-size:18px}
    .gateBox p{margin:0 0 12px 0;color:var(--muted);line-height:1.5}
    .gateBox button{border:0;background:linear-gradient(180deg,var(--btn),var(--btn2));color:#fff;border-radius:999px;padding:12px 16px;font-weight:900;cursor:pointer;width:100%;}

    @media (max-width:520px){
      .scenario{min-width:0;max-width:none}
      .dialog .en{font-size:20px}
      .helperRow{gap:8px}
      .helperBtn{padding:10px 8px;min-height:58px}
      .helperBtn b{font-size:13px}
      .helperBtn small{font-size:11px}
      .micBtn{font-size:14px;padding:13px 14px}
      .skipBtn{padding:13px 14px}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <button class="back" id="btnBack" aria-label="back">â†</button>
      <div class="title">
        <b>Talk Aï¼ˆæ‰‹æ©Ÿå£èªªï¼‰</b>
        <small id="subTitle">TTSï¼šBrowser SpeechSynthesis</small>
      </div>
      <div class="spacer"></div>
      <div class="scenario">
        <select id="sceneSelect"></select>
      </div>
      <button class="btn" id="btnReplay">é‡æ’­æœ¬å¥</button>
    </div>

    <div class="stage">
      <div class="who">
        <span class="pill"><span class="statusDot" id="dot"></span><span id="roleLabel">AI Â· teacher</span></span>
        <small id="sceneLabel">â€”</small>
      </div>

      <div class="center">
        <div class="avatarWrap" id="avatarWrap">
          <img class="avatarImg" id="avatarImg" alt="AI Avatar" />
          <video class="avatarVid" id="avatarVid" preload="auto" playsinline muted loop></video>
        </div>
      </div>

      <div class="dialog" id="dialogBox">
        <div class="en" id="lineEN">Loadingâ€¦</div>
        <div class="zh" id="lineZH">ï¼ˆè¼‰å…¥ä¸­â€¦ï¼‰</div>
      </div>

      <div class="note" id="heardText" style="display:none">ä½ èªªï¼šâ€”</div>
      <div class="softHint" id="softHint" style="display:none"></div>

      <div class="controls">
        <div class="micRow">
          <button class="micBtn" id="btnMic">ğŸ¤ é»æˆ‘èªªï¼ˆé–‹å§‹è¾¨è­˜ï¼‰</button>
          <button class="skipBtn" id="btnType">âŒ¨ï¸ è¼¸å…¥</button>
          <button class="skipBtn" id="btnSkip">è·³é</button>
        </div>

        <div class="helperRow">
          <button class="helperBtn" id="btnTask"><b>ä»»å‹™</b><small>è¦åšä»€éº¼</small></button>
          <button class="helperBtn" id="btnExamples"><b>ç¯„ä¾‹</b><small>ä¸æœƒå¥</small></button>
          <button class="helperBtn" id="btnTranslate"><b>ç¿»è­¯</b><small>ä¸­ / æ—¥</small></button>
          <button class="helperBtn" id="btnSaved"><b>å·²å„²å­˜</b><small>å–®å­—å¥</small></button>
        </div>

        <div class="note" id="noteText">ä¸»é ä¿æŒåœ¨å°è©±ä¸­ï¼›é»ã€Œä»»å‹™ / ç¯„ä¾‹ / ç¿»è­¯ / å·²å„²å­˜ã€åªæœƒæ‰“é–‹è¼”åŠ©å°çª—ï¼Œä¸æœƒä¸­æ–·å°è©±ã€‚</div>
      </div>
    </div>
  </div>

  <div class="sheetMask" id="sheetMask"></div>
  <div class="sheet" id="sheet">
    <div class="sheetHead">
      <div style="width:100%"><div class="grab"></div></div>
      <button class="sheetClose" id="sheetClose">é—œé–‰</button>
    </div>
    <div class="sheetBody" id="sheetBody"></div>
  </div>

  <div class="gate" id="gate">
    <div class="gateBox">
      <h2>é»ä¸€ä¸‹å•Ÿå‹•èªéŸ³</h2>
      <p>iPhone/éƒ¨åˆ†ç€è¦½å™¨æœƒé˜»æ“‹ã€Œè‡ªå‹•å‡ºè²ã€ã€‚é»ä¸€æ¬¡å¾Œå°±å¯æ­£å¸¸æœ—è®€ã€‚</p>
      <button id="gateBtn">é–‹å§‹</button>
    </div>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  // âœ… ä½  Supabase å·²ä¸Šå‚³çš„ 3 å¼µï¼ˆèªªè©±/è½/ç­‰å¾…ï¼‰
  const BUST = "v=" + Date.now();
  const AVATAR = {
    idle:  "https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/assets/avatars/ai-teacher-idle.png?"  + BUST,
    listen:"https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/assets/avatars/ai-teacher-listen.png?" + BUST,
    speak_vid: "https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/assets/avatars/talk.mp4?"  + BUST,
    speak: "https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/assets/avatars/ai-teacher-speak.png?"  + BUST,
    fallback:"https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/assets/avatars/ai-teacher-female.png?" + BUST
  };

  const avatarWrap = $("avatarWrap");
  const avatarImg  = $("avatarImg");
  const avatarVid  = $("avatarVid");
  const dot = $("dot");

  function setAvatarState(state){
    // idle / listen / fallback use IMG
    avatarImg.src = AVATAR[state] || AVATAR.fallback;
  }
  avatarImg.onerror = ()=>{ avatarImg.src = AVATAR.fallback; };
  avatarVid.onerror = ()=>{
    // If MP4 cannot load, keep using PNG speak frame.
    if(avatarWrap.classList.contains("speaking")) setAvatarState("speak");
  };

  function setSpeaking(on){
    avatarWrap.classList.toggle("speaking", !!on);
    if(on){
      // speaking: use MP4 (muted loop). If it fails, fall back to PNG.
      try{
        setAvatarState("speak");
        if(!avatarVid.src){ avatarVid.src = AVATAR.speak_vid || ""; }
        avatarVid.currentTime = 0;
        const p = avatarVid.play();
        if(p && typeof p.catch === "function") p.catch(()=>{});
      }catch(e){}
    }else{
      try{ avatarVid.pause(); }catch(e){}
      // idle: show idle PNG
      setAvatarState("idle");
    }
  }

  // ===== TTS =====
  let lastSpoken = "";
  let audioEnabled = false;
  const gate = $("gate");
  const gateBtn = $("gateBtn");

  function canSpeak(){ return ("speechSynthesis" in window) && ("SpeechSynthesisUtterance" in window); }
  function speak(text){
    const t = String(text||"").trim();
    if(!t || !canSpeak()) return Promise.resolve(false);
    lastSpoken = t;
    try{ speechSynthesis.cancel(); }catch(_){}
    return new Promise((resolve)=>{
      const u = new SpeechSynthesisUtterance(t);
      u.lang = "en-US";
      u.onstart = ()=>{ dot.classList.add("on"); setSpeaking(true); };
      u.onend   = ()=>{ dot.classList.remove("on"); setSpeaking(false); resolve(true); };
      u.onerror = ()=>{ dot.classList.remove("on"); setSpeaking(false); resolve(false); };
      try{ speechSynthesis.speak(u); }catch(e){ resolve(false); }
    });
  }
  async function speakOrGate(text){
    const t = String(text||"").trim();
    if(!t) return false;
    lastSpoken = t;
    if(!audioEnabled){
      gate.classList.add("show");
      return false;
    }
    return await speak(t);
  }
  gateBtn.addEventListener("click", async ()=>{
    gate.classList.remove("show");
    audioEnabled = true;
    await speak(lastSpoken);
  });
  ["click","touchstart","keydown"].forEach(evt=>{
    window.addEventListener(evt, ()=>{ if(!gate.classList.contains("show")) audioEnabled = true; }, { once:true, passive:true });
  });

  // ===== Bottom sheet =====
  const sheetMask = $("sheetMask");
  const sheet = $("sheet");
  const sheetBody = $("sheetBody");
  const sheetClose = $("sheetClose");
  function openSheet(html){ sheetBody.innerHTML = html; sheetMask.classList.add("show"); sheet.classList.add("show"); }
  function closeSheet(){ sheetMask.classList.remove("show"); sheet.classList.remove("show"); }
  sheetMask.addEventListener("click", closeSheet);
  sheetClose.addEventListener("click", closeSheet);

  // ===== Scenes (æœ€å°å¯ç”¨ï¼šå…ˆå…§å»ºï¼Œä¸ä¾è³´å¤–éƒ¨ json) =====
  const sceneSelect = $("sceneSelect");
  const roleLabel = $("roleLabel");
  const sceneLabel = $("sceneLabel");
  const lineEN = $("lineEN");
  const lineZH = $("lineZH");
  const btnReplay = $("btnReplay");
  const btnMic = $("btnMic");
  const btnSkip = $("btnSkip");
  const btnType = $("btnType");
  const heard = $("heardText");
  const softHint = $("softHint");
  let hintTimer = null;
  function showSoftHint(html, ms=2600){
    if(!softHint) return;
    softHint.innerHTML = html;
    softHint.style.display = "block";
    clearTimeout(hintTimer);
    hintTimer = setTimeout(()=>{ softHint.style.display="none"; }, ms);
  }
  function hideSoftHint(){ if(softHint) softHint.style.display="none"; }

  const scenes = [
    {id:"coffee_shop", title_zh:"è²·ä¸€æ¯å’–å•¡", title_en:"Coffee Shop", level:"A1", role:"Barista",
     steps:[
       {ai:"Hi there! Welcome to our cafe.", zh:"å—¨ï¼æ­¡è¿ä¾†åˆ°æˆ‘å€‘çš„å’–å•¡åº—ã€‚", hint:"Hi."},
       {ai:"What kind of coffee would you like?", zh:"ä½ æƒ³å–ä»€éº¼å’–å•¡ï¼Ÿ", hint:"I'd like a latte, please."},
       {ai:"What size would you like? Small, medium, or large?", zh:"ä½ è¦å°æ¯ã€ä¸­æ¯ã€é‚„æ˜¯å¤§æ¯ï¼Ÿ", hint:"Medium, please."},
       {ai:"Hot or iced?", zh:"è¦ç†±çš„é‚„æ˜¯å†°çš„ï¼Ÿ", hint:"Iced, please."},
       {ai:"Anything else?", zh:"é‚„è¦åˆ¥çš„å—ï¼Ÿ", hint:"That's all, thank you."},
       {ai:"How would you like to pay? Cash or card?", zh:"è¦ä»˜ç¾é‚„æ˜¯åˆ·å¡ï¼Ÿ", hint:"By card, please."}
     ]
    }
  ];

  const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
  let rec = null;
  if(SpeechRec){
    rec = new SpeechRec();
    rec.lang = "en-US";
    rec.interimResults = false;
    rec.maxAlternatives = 1;
  }

  function qs(name){ return new URL(location.href).searchParams.get(name); }
  function setQs(name, value){
    const u = new URL(location.href);
    u.searchParams.set(name, value);
    history.replaceState(null, "", u.toString());
  }

  // è¶…å¯¬é¬†éé—œï¼ˆé¿å…ä½ å¡é—œï¼‰
  function norm(s){ return String(s||"").trim().toLowerCase(); }
  function simpleOk(userText, hint){
    const t = norm(userText);
    const h = norm(hint);
    if(!h) return true;
    if(t === h) return true;
    const tokens = h.split(/[^a-z]+/).filter(w=>w.length>=4);
    if(tokens.some(w=>t.includes(w))) return true;
    if(["ok","okay","yes","yeah","yep","thanks","thank you"].some(p=>t===p || t.startsWith(p+" "))) return true;
    return false;
  }

  let curScene = null;
  let steps = [];
  let idx = 0;

  function fillSelect(){
    sceneSelect.innerHTML = "";
    scenes.forEach(it=>{
      const opt = document.createElement("option");
      opt.value = it.id;
      opt.textContent = `${it.title_zh}ï½œ${it.title_en} (${it.level})`;
      sceneSelect.appendChild(opt);
    });
  }

  function applyScene(id){
    curScene = scenes.find(x=>x.id===id) || scenes[0];
    roleLabel.textContent = `AI Â· ${curScene.role}`;
    sceneLabel.textContent = `${curScene.title_zh}ï½œ${curScene.title_en} (${curScene.level})`;
    steps = curScene.steps || [];
    idx = 0;
    setAvatarState("idle");
    render();
    speakOrGate(lineEN.textContent);
    setQs("scene", curScene.id);
  }

  function render(){
    const s = steps[idx] || {};
    lineEN.textContent = s.ai || "â€”";
    lineZH.textContent = s.zh || "";
    lastSpoken = s.ai || "";
  }

  async function handleUser(text){
    const userText = String(text||"").trim();
    if(!userText) return;
    heard.style.display="block";
    heard.textContent = "ä½ èªªï¼š" + userText;

    const s = steps[idx] || {};
    if(simpleOk(userText, s.hint||"")){
      if(idx < steps.length-1){
        idx++;
        render();
        await speakOrGate(lineEN.textContent);
      }else{
        showSoftHint("<b>å®Œæˆï¼</b> å·²çµæŸã€‚ä½ å¯ä»¥åˆ‡æ›æƒ…å¢ƒç¹¼çºŒç·´ã€‚", 2200);
      }
      return;
    }
    // ä¸éå°±æç¤ºï¼ˆä¸æ‰“æ–·ç•«é¢ï¼‰
    showSoftHint(`å†è©¦ä¸€æ¬¡ï¼šä½ å¯ä»¥ç›´æ¥èªªæˆ–æŒ‰ã€ŒâŒ¨ï¸ è¼¸å…¥ã€è²¼ä¸Šï¼š <b>${expected}</b><span class="sub">å°æŠ€å·§ï¼šæ…¢ä¸€é»ã€å°¾éŸ³æ‹‰æ¸…æ¥šï¼ˆä¾‹å¦‚ pleaseï¼‰ã€‚</span>`);
}

  // hooks
  btnReplay.addEventListener("click", ()=> speakOrGate(lastSpoken || lineEN.textContent || ""));
  btnSkip.addEventListener("click", async ()=>{
    if(idx < steps.length-1){ idx++; render(); await speakOrGate(lineEN.textContent); }
    else openSheet('<div class="card"><h3>å®Œæˆï¼</h3><p>å·²çµæŸã€‚</p></div>');
  });

  btnType.addEventListener("click", async ()=>{
    audioEnabled = true;
    setAvatarState("listen");
    const s = steps[idx] || {};
    const def = String(s.hint||"").trim();
    const t = prompt("è«‹è¼¸å…¥ä½ è¦å›ç­”çš„è‹±æ–‡ï¼š", def) || "";
    setAvatarState("idle");
    await handleUser(t);
  });

  btnMic.addEventListener("click", async ()=>{
    audioEnabled = true;
    if(!rec){
      const t = prompt("æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ã€‚è«‹è¼¸å…¥ä½ è¦å›ç­”çš„è‹±æ–‡ï¼š") || "";
      await handleUser(t);
      return;
    }
    try{
      btnMic.textContent = "ğŸ™ï¸ è½ä½ èªªâ€¦ï¼ˆèªªå®Œåœä¸€ä¸‹ï¼‰";
      btnMic.disabled = true;
      setAvatarState("listen");

      rec.onresult = async (e)=>{
        const t = e.results && e.results[0] && e.results[0][0] ? e.results[0][0].transcript : "";
        btnMic.textContent = "ğŸ¤ é»æˆ‘èªªï¼ˆé–‹å§‹è¾¨è­˜ï¼‰";
        btnMic.disabled = false;
        setAvatarState("idle");
        await handleUser(t);
      };
      rec.onerror = async ()=>{
        btnMic.textContent = "âŒ¨ï¸ é€™å°ä¸æ”¯æ´èªéŸ³ï¼Œæ”¹ç”¨è¼¸å…¥";
        btnMic.disabled = false;
        setAvatarState("idle");
        const t = prompt("è«‹è¼¸å…¥ä½ è¦å›ç­”çš„è‹±æ–‡ï¼š") || "";
        await handleUser(t);
      };
      rec.onend = ()=>{
        btnMic.textContent = "ğŸ¤ é»æˆ‘èªªï¼ˆé–‹å§‹è¾¨è­˜ï¼‰";
        btnMic.disabled = false;
        setAvatarState("idle");
      };
      rec.start();
    }catch(e){
      btnMic.textContent = "âŒ¨ï¸ é€™å°ä¸æ”¯æ´èªéŸ³ï¼Œæ”¹ç”¨è¼¸å…¥";
      btnMic.disabled = false;
      setAvatarState("idle");
      const t = prompt("è«‹è¼¸å…¥ä½ è¦å›ç­”çš„è‹±æ–‡ï¼š") || "";
      await handleUser(t);
    }
  });

  $("btnTask").addEventListener("click", ()=> openSheet('<div class="card"><h3>ä»»å‹™</h3><p>å®Œæˆå’–å•¡åº—æƒ…å¢ƒå°è©±ï¼Œç›¡é‡èªªå®Œæ•´å¥ã€‚</p></div>'));
  $("btnExamples").addEventListener("click", ()=> openSheet('<div class="card"><h3>ç¯„ä¾‹</h3><p>I\'d like a latte, please.<br/>Medium, please.<br/>That\'s all, thank you.</p></div>'));
  $("btnTranslate").addEventListener("click", ()=> openSheet('<div class="card"><h3>ç¿»è­¯ï¼ˆæœ¬å¥ï¼‰</h3><p>'+lineZH.textContent+'</p></div>'));
  $("btnSaved").addEventListener("click", ()=> openSheet('<div class="card"><h3>å·²å„²å­˜</h3><p>æœ€å°ç‰ˆå…ˆä¸åšã€‚</p></div>'));

  $("btnBack").addEventListener("click", ()=>{ location.href = "./index.html"; });

  sceneSelect.addEventListener("change", ()=> applyScene(sceneSelect.value));

  // boot
  fillSelect();
  const initial = qs("scene") || "coffee_shop";
  sceneSelect.value = initial;
  applyScene(sceneSelect.value);

  // IMPORTANT: show avatar immediately
  setAvatarState("idle");
})();
</script>
</body>
</html>
