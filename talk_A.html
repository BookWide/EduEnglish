<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BookWide Talkï½œå½±åƒï¼‹å£èªªå°è«‡</title>
<style>
:root{
  --bg:#f4f6fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
  --brand:#2563eb; --brand2:#1d4ed8; --soft:#eef2ff; --radius:18px;
  --shadow:0 14px 40px rgba(15,23,42,.10);
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif}
a{color:inherit;text-decoration:none}
.topbar{
  position:sticky;top:0;z-index:10;
  background:linear-gradient(90deg,#071a2e,#0b1220);
  color:#fff;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;
}
.brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:20px}
.badge{font-size:12px;font-weight:700;background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.18);padding:3px 10px;border-radius:999px}
.actions{display:flex;align-items:center;gap:10px}
.btn{
  appearance:none;border:1px solid rgba(255,255,255,.22);background:rgba(255,255,255,.08);
  color:#fff;border-radius:999px;padding:8px 12px;font-weight:700;cursor:pointer
}
.btn:active{transform:translateY(1px)}
.wrap{max-width:1180px;margin:22px auto;padding:0 14px}
.grid{display:grid;grid-template-columns: 420px 1fr;gap:16px}
.card{
  background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
  box-shadow:var(--shadow);overflow:hidden;
}
.card h2{margin:0;padding:16px 16px 10px;font-size:18px}
.card .sub{padding:0 16px 14px;color:var(--muted);font-size:13px;border-bottom:1px solid var(--line)}
.section{padding:14px 16px}
.row{display:flex;gap:10px;flex-wrap:wrap}
label{display:block;color:var(--muted);font-size:12px;margin:10px 0 6px}
select,input,textarea{
  width:100%;border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:14px;background:#fff
}
textarea{min-height:74px;resize:vertical}
.pills{display:flex;gap:8px;flex-wrap:wrap}
.pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#fff;font-size:12px;color:var(--muted)}
.pill.ok{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
.pill.bad{background:#fef2f2;border-color:#fecaca;color:#991b1b}
.camBox{
  border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#000;
}
video{width:100%;height:auto;display:block}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.cbtn{
  border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer
}
.cbtn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
.cbtn.ghost{background:#fff}
.cbtn:disabled{opacity:.5;cursor:not-allowed}
.hold{
  display:flex;align-items:center;gap:10px;margin-top:10px;padding:10px 12px;border-radius:14px;
  background:var(--soft);border:1px solid #dbe4ff;color:#1d4ed8;font-weight:800
}
.small{font-size:12px;color:var(--muted);font-weight:600}
.log{padding:12px 16px;min-height:420px}
.msg{
  border:1px solid var(--line);border-radius:14px;padding:12px 12px;margin:10px 0;background:#fff
}
.msg.ai{background:#f8fafc}
.msg .t{font-weight:900;margin-bottom:6px}
.msg .m{white-space:pre-wrap;line-height:1.45}
.err{border-color:#fecaca;background:#fef2f2}
@media (max-width: 980px){
  .grid{grid-template-columns:1fr}
  .log{min-height:320px}
}
</style>
</head>
<body>
  <div class="topbar">
    <div class="brand">BookWide <span class="badge">Talkï½œå½±åƒå£èªª</span></div>
    <div class="actions">
      <button class="btn" id="btnHome">å›é¦–é </button>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <h2>å£èªªç·´ç¿’è¨­å®š</h2>
        <div class="sub">MVPï¼šç›¸æ©Ÿç•«é¢ + æŒ‰ä½èªªè©±ï¼ˆèªéŸ³è¾¨è­˜ï¼‰ + AI ç«‹åˆ»ç³¾éŒ¯ï¼ˆå«ã€Œä½ åœ¨åšä»€éº¼ã€æƒ…å¢ƒå¼•å°ï¼‰ã€‚</div>

        <div class="section">
          <div class="row">
            <div style="flex:1;min-width:170px">
              <label>æƒ…å¢ƒ</label>
              <select id="scenario">
                <option value="nails">åšæŒ‡ç”² / nails</option>
                <option value="makeup">åŒ–å¦ / makeup</option>
                <option value="cooking" selected>åšèœ / cooking</option>
                <option value="coffee">å–å’–å•¡ / coffee</option>
                <option value="shopping">é€›è¡— / shopping</option>
                <option value="gym">å¥èº« / gym</option>
                <option value="commute">é€šå‹¤ / commute</option>
                <option value="cleaning">æ‰“æƒ / cleaning</option>
              </select>
            </div>
            <div style="flex:1;min-width:170px">
              <label>èªè¨€</label>
              <select id="lang">
                <option value="en" selected>è‹±æ–‡ï¼ˆENï¼‰</option>
                <option value="ja">æ—¥æ–‡ï¼ˆJAï¼‰</option>
                <option value="zh">ä¸­æ–‡ï¼ˆZHï¼‰</option>
              </select>
            </div>
          </div>

          <label>AI ç«¯é»ï¼ˆSupabase Edge Functionï¼Œå®Œæ•´ç¶²å€ï¼‰</label>
          <input id="endpoint" value="https://jeajrwpmrgczimmrflxo.supabase.co/functions/v1/talk-vision"/>

          <label>æç¤ºï¼ˆå¯é¸ï¼‰</label>
          <textarea id="hint">ç”¨ç°¡å–®å¥ã€æ…¢æ…¢èªªã€‚å…ˆèªª 1 å¥å°±å¥½ã€‚</textarea>

          <div style="margin-top:12px" class="pills">
            <span class="pill" id="pillCam">ç›¸æ©Ÿï¼šæœªé–‹</span>
            <span class="pill" id="pillMic">éº¥å…‹é¢¨ï¼šæœªé–‹</span>
            <span class="pill" id="pillStt">è¾¨è­˜ï¼šå¾…å‘½</span>
          </div>

          <div style="margin-top:12px" class="camBox">
            <video id="video" autoplay playsinline muted></video>
          </div>

          <div class="controls">
            <button class="cbtn" id="btnCam">é–‹å•Ÿç›¸æ©Ÿ</button>
            <button class="cbtn ghost" id="btnSnap" disabled>æ‹ä¸€å¼µï¼ˆé€ AIï¼‰</button>
          </div>

          <div class="hold">
            <button class="cbtn primary" id="btnHold" disabled>æŒ‰ä½èªªè©±</button>
            <div>
              <div>æŒ‰ä½èªªä¸€å¥ â†’ æ”¾é–‹å°±é€ AI åˆ†æ</div>
              <div class="small">Chrome / Edge æ”¯æ´èªéŸ³è¾¨è­˜ï¼›è‹¥å¤±æ•—å¯ç”¨ä¸‹æ–¹æ‰‹å‹•è¼¸å…¥ã€‚</div>
            </div>
          </div>

          <label>æ‰‹å‹•è¼¸å…¥ï¼ˆå‚™æ´ï¼‰</label>
          <div class="row">
            <input id="manual" placeholder="ä¾‹å¦‚ï¼šI am doing my nails."/>
            <button class="cbtn primary" id="btnSend">é€å‡º</button>
          </div>
          <div class="small" style="margin-top:8px">
            å¦‚æœä½ çœ‹åˆ° <b>HTTP 401</b>ï¼šä»£è¡¨ä½ çš„ Edge Function è¦æ±‚æˆæ¬Šã€‚å…ˆæŠŠ function è¨­æˆ publicï¼ˆverify_jwt=falseï¼‰ï¼Œæˆ–æ”¹æˆç”¨ supabase session å¸¶ Authorizationã€‚
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <h2>AI å³æ™‚ç³¾éŒ¯</h2>
        <div class="sub" id="status">å°šæœªé–‹å§‹</div>
        <div class="log" id="log"></div>
      </div>
    </div>
  </div>

<script>
/* ========= helpers ========= */
const $ = (id)=>document.getElementById(id);
const logEl = $("log");
function addMsg(title, msg, cls=""){
  const d=document.createElement("div");
  d.className="msg "+cls;
  d.innerHTML = '<div class="t">'+escapeHtml(title)+'</div><div class="m">'+escapeHtml(msg)+'</div>';
  logEl.prepend(d);
}
function setStatus(s){ $("status").textContent=s; }
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function setPill(el, text, ok=null){
  el.textContent=text;
  el.classList.remove("ok","bad");
  if(ok===true) el.classList.add("ok");
  if(ok===false) el.classList.add("bad");
}

/* ========= camera ========= */
let stream=null;
let lastImageDataUrl=null;

async function startCam(){
  stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:"user" }, audio:false });
  $("video").srcObject = stream;
  setPill($("pillCam"), "ç›¸æ©Ÿï¼šå·²é–‹", true);
  $("btnSnap").disabled=false;
}
function snapshot(){
  const v=$("video");
  const c=document.createElement("canvas");
  const w=v.videoWidth||640, h=v.videoHeight||480;
  c.width=w; c.height=h;
  const ctx=c.getContext("2d");
  ctx.drawImage(v,0,0,w,h);
  lastImageDataUrl = c.toDataURL("image/jpeg", 0.8);
  addMsg("ğŸ“¸ Snapshot", "å·²æ‹ç…§ï¼ˆJPEGï¼‰", "ai");
}

/* ========= speech to text (Chrome/Edge) ========= */
let Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
let rec=null, holding=false, partial="";
function setupSTT(){
  if(!Rec){
    setPill($("pillStt"), "è¾¨è­˜ï¼šæ­¤ç€è¦½å™¨ä¸æ”¯æ´", false);
    return;
  }
  rec = new Rec();
  rec.lang = "en-US";
  rec.interimResults = true;
  rec.continuous = false;

  rec.onstart = ()=>{
    setPill($("pillMic"), "éº¥å…‹é¢¨ï¼šå·²é–‹", true);
    setPill($("pillStt"), "è¾¨è­˜ï¼šè†è½ä¸­â€¦", true);
    partial="";
  };
  rec.onresult = (e)=>{
    let t="";
    for(let i=e.resultIndex;i<e.results.length;i++){
      t += e.results[i][0].transcript;
    }
    partial = t.trim();
  };
  rec.onerror = (e)=>{
    setPill($("pillStt"), "è¾¨è­˜ï¼šéŒ¯èª¤ "+(e.error||""), false);
  };
  rec.onend = async ()=>{
    setPill($("pillMic"), "éº¥å…‹é¢¨ï¼šæœªé–‹", null);
    setPill($("pillStt"), "è¾¨è­˜ï¼šå¾…å‘½", null);
    if(holding){
      holding=false;
      if(partial){
        $("manual").value = partial;
        await sendToAI(partial);
      }else{
        addMsg("âš ï¸ STT", "æ²’æœ‰è½åˆ°å…§å®¹ï¼ˆå¯æ”¹ç”¨æ‰‹å‹•è¼¸å…¥ï¼‰", "err");
      }
    }
  };
  $("btnHold").disabled=false;
  setPill($("pillStt"), "è¾¨è­˜ï¼šå¾…å‘½", null);
}
function setRecLang(){
  const lang = $("lang").value;
  if(!rec) return;
  rec.lang = (lang==="ja") ? "ja-JP" : (lang==="zh" ? "zh-TW" : "en-US");
}

/* ========= AI call ========= */
async function sendToAI(userText){
  const endpoint = $("endpoint").value.trim();
  const scenario = $("scenario").value;
  const lang = $("lang").value;
  const hint = $("hint").value || "";
  const image = lastImageDataUrl; // optional

  addMsg("ğŸ§‘ ä½ èªª", userText);
  setStatus("é€å‡ºåˆ° AIâ€¦");

  try{
    const r = await fetch(endpoint, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        scenario, lang, hint,
        user_text: userText,
        image_data_url: image || null
      })
    });

    const ct = r.headers.get("content-type") || "";
    const text = await r.text();

    if(!r.ok){
      addMsg("âŒ ç«¯é»éŒ¯èª¤", "HTTP "+r.status+"\n"+text.slice(0,800), "err");
      setStatus("éŒ¯èª¤ï¼šHTTP "+r.status);
      return;
    }
    if(!ct.includes("application/json")){
      addMsg("âŒ è§£æå¤±æ•—", "ä¸æ˜¯ JSONï¼ˆå¤šåŠå›åˆ° HTMLï¼‰ï¼š\n"+text.slice(0,800), "err");
      setStatus("éŒ¯èª¤ï¼šä¸æ˜¯ JSON");
      return;
    }
    const data = JSON.parse(text);

    // expected fields
    const out = data.corrected || data.reply || data.output_text || "";
    const tips = (data.tips && Array.isArray(data.tips)) ? data.tips.join("\n") : (data.tips || "");
    const follow = data.follow_up || "";

    addMsg("ğŸ¤– AI æ›´è‡ªç„¶èªªæ³•", out || "(empty)", "ai");
    if(tips) addMsg("ğŸ“ é‡é»", tips, "ai");
    if(follow) addMsg("â“ è¿½å•", follow, "ai");
    setStatus("å®Œæˆ");
  }catch(err){
    addMsg("âŒ ä¾‹å¤–", String(err), "err");
    setStatus("éŒ¯èª¤ï¼šä¾‹å¤–");
  }
}

/* ========= bind ========= */
$("btnHome").onclick = ()=> location.href="index.html";

$("btnCam").onclick = async ()=>{
  try{ await startCam(); }catch(e){ addMsg("âŒ ç›¸æ©Ÿ", "é–‹å•Ÿå¤±æ•—ï¼š"+e, "err"); }
};
$("btnSnap").onclick = snapshot;

$("btnSend").onclick = async ()=>{
  const t = $("manual").value.trim();
  if(!t) return;
  await sendToAI(t);
};

$("btnHold").addEventListener("mousedown", ()=>{
  if(!rec) return;
  setRecLang();
  holding=true;
  try{ rec.start(); }catch(e){}
});
$("btnHold").addEventListener("mouseup", ()=>{
  if(!rec) return;
  try{ rec.stop(); }catch(e){}
});
$("btnHold").addEventListener("touchstart", (e)=>{
  e.preventDefault();
  if(!rec) return;
  setRecLang();
  holding=true;
  try{ rec.start(); }catch(e){}
},{passive:false});
$("btnHold").addEventListener("touchend", (e)=>{
  e.preventDefault();
  if(!rec) return;
  try{ rec.stop(); }catch(e){}
},{passive:false});

$("lang").addEventListener("change", setRecLang);

setupSTT();
</script>
</body>
</html>
