<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Talk AÔΩúBookWide</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1b33;
      --card:#101f3d;
      --ink:#eaf1ff;
      --muted:#9fb3d9;
      --brand:#4f8cff;
      --ok:#19c37d;
      --bad:#ff5a7a;
      --line:rgba(255,255,255,.08);
      --radius:18px;
      --shadow:0 18px 60px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:radial-gradient(1200px 600px at 50% -10%, #1a2f5a 0%, var(--bg) 55%);
      color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .wrap{
      min-height:100%;
      display:flex;
      flex-direction:column;
      padding:16px 14px 18px;
      gap:12px;
      max-width:720px;
      margin:0 auto;
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px; border:1px solid var(--line); border-radius:14px;
      background:rgba(16,31,61,.55); backdrop-filter: blur(10px);
      gap:10px;
      flex-wrap:wrap;
    }
    .brand{display:flex; gap:10px; align-items:center}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--brand);box-shadow:0 0 18px rgba(79,140,255,.9)}
    .title{font-weight:700}
    .meta{font-size:12px;color:var(--muted)}
    .btn{
      appearance:none;border:1px solid var(--line); background:rgba(255,255,255,.06);
      color:var(--ink); border-radius:12px; padding:8px 10px; cursor:pointer;
      font-weight:700;
    }
    .btn:active{transform:translateY(1px)}
    select.btn{padding:8px 10px}
    .rightBtns{display:flex; gap:10px; align-items:center; flex-wrap:wrap}

    .main{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .avatarCard{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(16,31,61,.85), rgba(16,31,61,.45));
      box-shadow:var(--shadow);
      padding:14px 14px 16px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
      position:relative;
      overflow:hidden;
    }
    .badge{
      position:absolute; top:12px; left:12px;
      font-size:12px; color:var(--muted);
      background:rgba(0,0,0,.22);
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
    }
    .avatar{
      width:160px;height:160px;border-radius:50%;
      border:1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(circle at 35% 30%, rgba(255,255,255,.22), rgba(255,255,255,0) 45%),
        radial-gradient(circle at 55% 75%, rgba(79,140,255,.25), rgba(79,140,255,0) 55%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      box-shadow:0 18px 70px rgba(0,0,0,.45);
      display:grid; place-items:center;
      position:relative;
      transform-origin:50% 70%;
    }
    .face{
      width:70%; height:70%;
      border-radius:50%;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.16);
      position:relative;
      overflow:hidden;
    }
    .eyes{
      position:absolute; top:38%;
      width:100%; display:flex; justify-content:center; gap:16%;
    }
    .eye{
      width:16px;height:16px;border-radius:50%;
      background:rgba(234,241,255,.85);
      box-shadow:0 0 10px rgba(234,241,255,.25);
    }
    .mouth{
      position:absolute; top:62%; left:50%;
      width:44px;height:14px;border-radius:0 0 20px 20px;
      border:2px solid rgba(234,241,255,.65);
      border-top:0;
      transform:translateX(-50%);
      opacity:.9;
    }
    .statusLine{
      width:100%;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      font-size:12px;
      color:var(--muted);
    }
    .statusPill{
      padding:6px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:rgba(0,0,0,.18);
      display:flex; align-items:center; gap:8px;
    }
    .pillDot{width:8px;height:8px;border-radius:50%; background:rgba(255,255,255,.25)}
    .pillDot.ok{background:var(--ok); box-shadow:0 0 12px rgba(25,195,125,.7)}
    .pillDot.bad{background:var(--bad); box-shadow:0 0 12px rgba(255,90,122,.7)}
    .pillDot.info{background:var(--brand); box-shadow:0 0 12px rgba(79,140,255,.7)}

    .talkCard{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:rgba(16,31,61,.55);
      box-shadow:var(--shadow);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .sentence{
      font-size:22px; line-height:1.35;
      font-weight:900;
      letter-spacing:.2px;
    }
    .subtitle{
      font-size:14px; color:var(--muted); line-height:1.35;
      min-height:18px;
    }
    .choices{
      display:flex; flex-wrap:wrap; gap:10px;
      margin-top:2px;
    }
    .chip{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--ink);
      border-radius:999px;
      padding:8px 12px;
      font-weight:800;
      font-size:14px;
      cursor:pointer;
      user-select:none;
    }

    .controls{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      margin-top:6px;
      flex-wrap:wrap;
    }
    .micBtn{
      flex:1;
      min-width:180px;
      display:flex; align-items:center; justify-content:center;
      gap:10px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(79,140,255,.32), rgba(79,140,255,.12));
      color:var(--ink);
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .micBtn[disabled]{opacity:.55; cursor:not-allowed}
    .ghost{
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--ink);
      font-weight:800;
      cursor:pointer;
    }
    .small{font-size:12px;color:var(--muted)}
    .log{
      margin-top:4px;
      font-size:12px;
      color:rgba(234,241,255,.75);
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      min-height:40px;
      white-space:pre-wrap;
    }
    .hint{
      color:rgba(234,241,255,.9);
      border-left:3px solid rgba(79,140,255,.9);
      padding-left:10px;
      margin-top:2px;
      font-size:13px;
      line-height:1.35;
    }

    /* Avatar states */
    .state-idle .avatar{animation:idle 2.6s ease-in-out infinite}
    @keyframes idle{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}

    .state-speaking .avatar{animation:speak 0.22s ease-in-out infinite}
    .state-speaking .mouth{animation:mouth 0.18s ease-in-out infinite}
    @keyframes speak{0%,100%{transform:rotate(0deg) translateY(0)}50%{transform:rotate(1.2deg) translateY(-1px)}}
    @keyframes mouth{0%,100%{height:14px; width:44px; opacity:.95}50%{height:22px; width:40px; opacity:1}}

    .state-listening .avatar{animation:listen .9s ease-in-out infinite}
    @keyframes listen{0%,100%{transform:rotate(0deg)}50%{transform:rotate(-1.2deg)}}

    .state-positive .avatar{animation:nod .35s ease-in-out 2}
    @keyframes nod{0%{transform:rotate(0deg)}50%{transform:rotate(6deg) translateY(1px)}100%{transform:rotate(0deg)}}

    .state-encourage .avatar{animation:shake .25s ease-in-out 3}
    @keyframes shake{0%{transform:rotate(0deg)}50%{transform:rotate(-4deg)}100%{transform:rotate(0deg)}}

    @media (max-width:420px){
      .sentence{font-size:20px}
      .avatar{width:150px;height:150px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="title">Talk AÔºàÊâãÊ©üÂè£Ë™™Ôºâ</div>
          <div class="meta" id="metaLine">TTSÔºöBrowser SpeechSynthesis</div>
        </div>
      </div>

      <div class="rightBtns">
        <select id="sceneSel" class="btn" title="ÈÅ∏ÊìáÊÉÖÂ¢É"></select>
        <button class="btn" id="btnReload">ÈáçÊí≠Êú¨Âè•</button>
      </div>
    </div>

    <div class="main">
      <div class="avatarCard" id="avatarCard">
        <div class="badge" id="badge">-</div>

        <div class="avatar">
          <div class="face">
            <div class="eyes">
              <div class="eye"></div>
              <div class="eye"></div>
            </div>
            <div class="mouth"></div>
          </div>
        </div>

        <div class="statusLine">
          <div class="statusPill"><span class="pillDot info" id="pillDot"></span><span id="statusText">Ready</span></div>
          <div class="small" id="stepText">step: -</div>
        </div>
      </div>

      <div class="talkCard">
        <div class="sentence" id="sentence">ÔºàËºâÂÖ•‰∏≠‚Ä¶Ôºâ</div>
        <div class="subtitle" id="subtitle"></div>
        <div class="choices" id="choices"></div>

        <div class="controls">
          <button class="micBtn" id="btnMic">üéôÔ∏è ÈªûÊàëË™™ÔºàÈñãÂßãËæ®Ë≠òÔºâ</button>
          <button class="ghost" id="btnNext">Ë∑≥ÈÅé</button>
        </div>

        <div class="hint" id="hint" style="display:none"></div>
        <div class="log" id="log"></div>
      </div>
    </div>
  </div>

<script>
/* Talk A (GitHub Pages mode): loads ./talk/index.json and ./talk/<scene>.json */
const $ = (id)=>document.getElementById(id);
const UI = {
  card: $('avatarCard'),
  pillDot: $('pillDot'),
  statusText: $('statusText'),
  stepText: $('stepText'),
  sentence: $('sentence'),
  subtitle: $('subtitle'),
  choices: $('choices'),
  hint: $('hint'),
  log: $('log'),
  btnMic: $('btnMic'),
  btnNext: $('btnNext'),
  btnReload: $('btnReload'),
  metaLine: $('metaLine'),
  sceneSel: $('sceneSel'),
  badge: $('badge')
};

const BASE = './talk';

function setAvatarState(state){
  UI.card.classList.remove('state-idle','state-speaking','state-listening','state-positive','state-encourage');
  UI.card.classList.add('state-'+state);
  const dot = UI.pillDot;
  dot.classList.remove('ok','bad','info');
  if(state==='positive') dot.classList.add('ok');
  else if(state==='encourage') dot.classList.add('bad');
  else dot.classList.add('info');
}
function setStatus(text){ UI.statusText.textContent = text; }
function logLine(s){
  UI.log.textContent = (UI.log.textContent ? UI.log.textContent + "\\n" : "") + s;
  UI.log.scrollTop = UI.log.scrollHeight;
}
function norm(s){
  return (s||"").toLowerCase().replace(/[^\\w\\s']/g,' ').replace(/\\s+/g,' ').trim();
}

/* ===== TTS ===== */
function pickVoice(){
  const voices = speechSynthesis.getVoices() || [];
  let v = voices.find(x => /en-US/i.test(x.lang));
  if(!v) v = voices.find(x => /^en/i.test(x.lang));
  return v || null;
}
function speak(text){
  return new Promise((resolve)=>{
    try{
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      const v = pickVoice();
      if(v) u.voice = v;
      u.lang = (v && v.lang) ? v.lang : 'en-US';
      u.rate = 1.0;
      u.pitch = 1.0;
      u.onstart = ()=>{ isSpeaking = true; setAvatarState('speaking'); setStatus('Speaking'); };
      u.onend   = ()=>{ isSpeaking = false; resolve(); };
      u.onerror = ()=>{ isSpeaking = false; resolve(); };
      speechSynthesis.speak(u);
    }catch(e){ resolve(); }
  });
}

/* ===== Speech Recognition ===== */
let recognition = null;
let isSpeaking = false;
let failCount = {};
let stepsById = {};
let currentId = "";
let SCRIPT = null;

function setupRecognition(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){
    UI.metaLine.textContent = "TTSÔºöSpeechSynthesisÔºà‚ö†Ô∏èÊ≠§ÁÄèË¶ΩÂô®ÁÑ°Ë™ûÈü≥Ëæ®Ë≠òÔºâ";
    UI.btnMic.disabled = true;
    logLine("‚ö†Ô∏è Ê≠§ÁÄèË¶ΩÂô®‰∏çÊîØÊè¥ Web Speech APIÔºàË™ûÈü≥Ëæ®Ë≠òÔºâ„ÄÇÂª∫Ë≠∞Áî® Chrome/Edge„ÄÇ");
    return;
  }
  recognition = new SR();
  recognition.lang = 'en-US';
  recognition.interimResults = true;
  recognition.continuous = false;

  recognition.onstart = ()=>{
    setAvatarState('listening');
    setStatus('Listening');
    UI.btnMic.textContent = "üü¢ Ê≠£Âú®ËÅΩ‚Ä¶";
  };
  recognition.onend = ()=>{
    UI.btnMic.textContent = "üéôÔ∏è ÈªûÊàëË™™ÔºàÈñãÂßãËæ®Ë≠òÔºâ";
  };
  recognition.onerror = (e)=>{
    logLine("SR error: " + (e.error || "unknown"));
  };
  recognition.onresult = (e)=>{
    let finalText = "";
    let interim = "";
    for(let i=e.resultIndex; i<e.results.length; i++){
      const t = e.results[i][0].transcript.trim();
      if(e.results[i].isFinal) finalText += (finalText?" ":"") + t;
      else interim += (interim?" ":"") + t;
    }
    if(interim) UI.subtitle.textContent = "‰Ω†Ë™™Ôºö " + interim;
    if(finalText){
      UI.subtitle.textContent = "‰Ω†Ë™™Ôºö " + finalText;
      logLine("You said: " + finalText);
      handleUserText(finalText);
    }
  };
}

function matchChoice(userText, expect){
  const t = norm(userText);
  const opts = (expect.options||[]);
  const aliases = expect.aliases || {};
  for(const opt of opts){
    const list = [opt, ...(aliases[opt]||[])].map(norm).filter(Boolean);
    for(const a of list){
      if(!a) continue;
      if(t.includes(a)) return opt;
    }
  }
  return null;
}

function renderStep(step){
  UI.stepText.textContent = "step: " + step.id;
  UI.sentence.textContent = step.text || "";
  UI.subtitle.textContent = step.zh ? step.zh : "";
  UI.hint.style.display = "none";
  UI.hint.textContent = "";
  UI.choices.innerHTML = "";

  if(step.expect && step.expect.mode === "choice"){
    for(const opt of step.expect.options){
      const chip = document.createElement('div');
      chip.className = 'chip';
      chip.textContent = opt;
      chip.onclick = ()=>{ logLine("Tapped: " + opt); handleUserText(opt); };
      UI.choices.appendChild(chip);
    }
  }
}

function goto(id){
  currentId = id;
  const step = stepsById[currentId];
  if(!step){ logLine("‚ùå step not found: " + id); return; }
  runStep(step);
}

async function runStep(step){
  setAvatarState('idle');
  setStatus('Ready');
  renderStep(step);

  if(step.type === "ai_hint"){
    UI.hint.style.display = "block";
    UI.hint.textContent = step.text || "";
    await speak(step.text || "");
    setAvatarState('idle'); setStatus('Ready');
    if(step.repeat) goto(step.repeat);
    return;
  }

  if(step.type === "ai_say"){
    await speak(step.text || "");
    setAvatarState('listening');
    setStatus('Listening');
    return;
  }
}

function bumpFail(key){
  failCount[key] = (failCount[key]||0) + 1;
  return failCount[key];
}

async function handleSuccess(step, matched){
  setAvatarState('positive');
  setStatus('Good!');
  if(matched) UI.subtitle.textContent = `‚úÖ OKÔºö${matched}`;
  await new Promise(r=>setTimeout(r, 520));

  if(step.end){
    setAvatarState('idle');
    setStatus('Done');
    UI.subtitle.textContent = "‚úÖ ÂÆåÊàêÔºÅ";
    return;
  }
  if(step.on_success) goto(step.on_success);
}

async function handleFail(step){
  setAvatarState('encourage');
  setStatus('Try again');
  await new Promise(r=>setTimeout(r, 380));

  const n = bumpFail(step.id);
  if(n === 1 && step.on_fail){ goto(step.on_fail); return; }

  UI.subtitle.textContent = "Ê≤íÈóú‰øÇÔºåÁõ¥Êé•‰∏ã‰∏ÄÂè•„ÄÇ";
  await speak("That's okay. Let's move on.");
  if(step.on_success) goto(step.on_success);
}

function handleUserText(text){
  const step = stepsById[currentId];
  if(!step || !step.expect) return;
  if(isSpeaking) return;

  const mode = step.expect.mode;
  if(mode === "none"){ handleSuccess(step); return; }

  if(mode === "choice"){
    const matched = matchChoice(text, step.expect);
    if(matched) handleSuccess(step, matched);
    else handleFail(step);
    return;
  }

  if(mode === "free"){
    const kws = (step.expect.keywords||[]).map(norm).filter(Boolean);
    const t = norm(text);
    const hit = kws.some(k=>t.includes(k));
    if(hit) handleSuccess(step);
    else handleFail(step);
  }
}

/* ===== GitHub Pages loader ===== */
async function fetchJson(url){
  const r = await fetch(url, { cache: "no-store" });
  if(!r.ok) throw new Error("HTTP " + r.status + " " + url);
  return r.json();
}

async function buildSceneSelector(){
  const idx = await fetchJson(`${BASE}/index.json`);
  UI.sceneSel.innerHTML = "";
  idx.scenes.forEach(s=>{
    const opt = document.createElement("option");
    opt.value = s.key;
    opt.textContent = `${s.title} (${s.level})`;
    UI.sceneSel.appendChild(opt);
  });

  const qs = new URLSearchParams(location.search);
  const key = qs.get("scene") || idx.default || (idx.scenes[0] && idx.scenes[0].key) || "coffee_shop";
  UI.sceneSel.value = key;

  UI.sceneSel.onchange = ()=> loadScene(UI.sceneSel.value);

  await loadScene(key);
}

async function loadScene(sceneKey){
  try{
    SCRIPT = await fetchJson(`${BASE}/${sceneKey}.json`);
    stepsById = Object.fromEntries((SCRIPT.steps||[]).map(s=>[s.id,s]));
    failCount = {};
    currentId = (SCRIPT.steps && SCRIPT.steps[0] && SCRIPT.steps[0].id) ? SCRIPT.steps[0].id : "";

    UI.badge.textContent = `${SCRIPT.persona?.name || "AI"} ¬∑ ${SCRIPT.persona?.role || "teacher"}`;
    logLine(`\\n=== Scene: ${SCRIPT.scene} (${SCRIPT.level}) ===`);

    if(!currentId){ logLine("‚ùå empty steps"); return; }
    goto(currentId);
  }catch(e){
    logLine("‚ùå loadScene failed: " + (e && e.message ? e.message : e));
  }
}

/* ===== UI events ===== */
UI.btnMic.onclick = ()=>{
  if(!recognition) return;
  if(isSpeaking) speechSynthesis.cancel();
  try{ recognition.stop(); recognition.start(); }catch(e){}
};
UI.btnNext.onclick = ()=>{
  const step = stepsById[currentId];
  if(step && step.on_success) goto(step.on_success);
};
UI.btnReload.onclick = ()=>{
  const step = stepsById[currentId];
  if(step && step.text) speak(step.text);
};

/* ===== Boot ===== */
(function init(){
  speechSynthesis.onvoiceschanged = ()=>{};
  setupRecognition();
  setAvatarState('idle');
  setStatus('Ready');
  logLine("‚úÖ Talk A loaded. (GitHub Pages mode)");
  buildSceneSelector();
})();
</script>
</body>
</html>
