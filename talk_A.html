<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Talk Aï½œBookWide</title>
<style>
:root{
  --bg:#ffffff;
  --ink:#0b1220;
  --muted:#5b667a;
  --line:#e6eaf0;
  --soft:#f6f8fb;
  --pill:#111827;
  --pillText:#ffffff;
  --shadow:0 10px 28px rgba(10,20,40,.10);
  --radius:18px;
  --radius2:24px;
  --btn:#0b66ff;
  --btn2:#084fc6;
  --warn:#b91c1c;
  --ok:#0f766e;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
  background:var(--bg);
  color:var(--ink);
  overflow:hidden;
}
a{color:inherit}
.app{
  height:100%;
  display:flex;
  flex-direction:column;
  padding:12px 12px calc(12px + env(safe-area-inset-bottom));
  gap:10px;
  max-width:980px;
  margin:0 auto;
}
.top{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  border:1px solid var(--line);
  border-radius:999px;
  background:#fff;
  box-shadow:var(--shadow);
}
.back{
  width:36px;height:36px;border-radius:999px;border:1px solid var(--line);
  background:#fff;display:grid;place-items:center;cursor:pointer;
  flex:0 0 auto;
}
.title{display:flex;flex-direction:column;gap:2px;min-width:0}
.title b{font-size:15px;line-height:1.1}
.title small{font-size:12px;color:var(--muted)}
.spacer{flex:1}
.scenario{
  display:flex;align-items:center;gap:8px;
  border:1px solid var(--line);
  border-radius:999px;
  padding:8px 10px;
  background:var(--soft);
  min-width:220px;
  max-width:420px;
}
.scenario select{
  width:100%;
  border:0;
  background:transparent;
  font-size:14px;
  outline:none;
  color:var(--ink);
  appearance:none;
}
.btn{
  border:1px solid var(--line);
  background:#fff;
  border-radius:999px;
  padding:8px 10px;
  cursor:pointer;
  font-size:13px;
  white-space:nowrap;
}
.stage{
  flex:1;
  min-height:0;
  border:1px solid var(--line);
  border-radius:var(--radius2);
  background:#fff;
  box-shadow:var(--shadow);
  padding:14px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.who{display:flex;align-items:center;gap:10px}
.pill{
  display:inline-flex;align-items:center;gap:8px;
  background:var(--pill);
  color:var(--pillText);
  border-radius:999px;
  padding:6px 10px;
  font-size:12px;
}
.statusDot{width:8px;height:8px;border-radius:99px;background:#94a3b8}
.statusDot.on{background:#10b981}
.who small{color:var(--muted)}
.center{display:grid;place-items:center;padding:8px 0 2px}
.avatarWrap{
  width:min(260px,70vw);
  aspect-ratio:1/1;
  border-radius:999px;
  background:radial-gradient(circle at 30% 30%, #e9eef7, #ffffff 55%, #e9eef7);
  border:1px solid var(--line);
  box-shadow:0 20px 60px rgba(10,20,40,.12) inset;
  display:grid;
  place-items:center;
  position:relative;
  overflow:hidden;
}
.avatarImg{
  width:62%;
  height:62%;
  border-radius:18px;
  object-fit:cover;
  border:1px solid var(--line);
  background:#fff;
  box-shadow:0 10px 30px rgba(10,20,40,.10);
}
.mouth{
  position:absolute;
  width:42px;height:22px;
  border:2px solid rgba(15,23,42,.55);
  border-top:0;
  border-radius:0 0 30px 30px;
  bottom:32%;
  left:50%;
  transform:translateX(-50%);
  opacity:.55;
}
.speaking .mouth{animation:talk .13s infinite alternate ease-in-out;opacity:.85}
@keyframes talk{from{height:8px}to{height:22px}}

.dialog{
  border:1px solid var(--line);
  border-radius:var(--radius);
  padding:14px;
  background:var(--soft);
}
.dialog .en{font-size:22px;line-height:1.35;font-weight:850;letter-spacing:.2px}
.dialog .zh{margin-top:6px;font-size:13px;color:var(--muted);line-height:1.4}
.hint{margin-top:10px;font-size:12px;color:#6b7280;line-height:1.35}
.controls{display:flex;flex-direction:column;gap:10px}
.micRow{display:flex;align-items:center;gap:10px}
.micBtn{
  flex:1;border:0;
  background:linear-gradient(180deg,var(--btn),var(--btn2));
  color:#fff;border-radius:999px;
  padding:14px 16px;
  font-weight:850;font-size:15px;cursor:pointer;
  box-shadow:0 14px 30px rgba(11,102,255,.25);
  display:flex;align-items:center;justify-content:center;gap:10px;
}
.skipBtn{
  border:1px solid var(--line);
  background:#fff;border-radius:999px;
  padding:14px 16px;font-weight:750;cursor:pointer;min-width:96px;
}
.helperRow{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.helperBtn{
  border:1px solid var(--line);
  background:#fff;border-radius:var(--radius);
  padding:12px 10px;text-align:left;
  cursor:pointer;min-height:62px;
  box-shadow:0 8px 18px rgba(10,20,40,.06);
}
.helperBtn b{display:block;font-size:14px}
.helperBtn small{display:block;margin-top:4px;color:var(--muted);font-size:12px}
.note{
  border:1px dashed var(--line);
  border-radius:var(--radius);
  padding:10px 12px;
  color:var(--muted);
  font-size:12px;
  line-height:1.4;
  background:#fff;
}

/* Bottom sheet */
.sheetMask{position:fixed;inset:0;background:rgba(0,0,0,.28);display:none;z-index:50}
.sheetMask.show{display:block}
.sheet{
  position:fixed;left:0;right:0;bottom:0;
  background:#fff;border-radius:18px 18px 0 0;
  border:1px solid var(--line);
  box-shadow:0 -24px 60px rgba(10,20,40,.18);
  max-width:980px;margin:0 auto;
  max-height:78vh;
  transform:translateY(110%);
  transition:transform .22s ease;
  z-index:51;overflow:hidden;
}
.sheet.show{transform:translateY(0)}
.sheetHead{display:flex;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid var(--line);background:var(--soft)}
.grab{width:42px;height:5px;border-radius:99px;background:#cfd6e3;margin:0 auto}
.sheetClose{margin-left:auto;border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 10px;cursor:pointer;font-weight:850;font-size:13px}
.sheetBody{padding:14px;overflow:auto;max-height:calc(78vh - 52px)}
.card{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff;margin-bottom:10px}
.card h3{margin:0 0 8px 0;font-size:14px}
.card p{margin:0;color:var(--muted);line-height:1.5}
.list{margin:0;padding-left:18px;color:var(--muted);line-height:1.55}
.tag{display:inline-flex;align-items:center;padding:4px 8px;border-radius:999px;background:var(--soft);border:1px solid var(--line);font-size:12px;color:var(--muted);margin-right:6px;margin-bottom:6px}
.row{display:flex;flex-wrap:wrap;gap:8px}
.warn{color:var(--warn);font-weight:850;font-size:12px}

/* Audio gate */
.gate{position:fixed;inset:0;background:rgba(255,255,255,.92);display:none;z-index:80;padding:22px}
.gate.show{display:flex;align-items:center;justify-content:center}
.gateBox{
  width:min(520px,92vw);
  border:1px solid var(--line);
  border-radius:18px;
  background:#fff;
  box-shadow:var(--shadow);
  padding:16px;
  text-align:center;
}
.gateBox h2{margin:6px 0 8px 0;font-size:18px}
.gateBox p{margin:0 0 12px 0;color:var(--muted);line-height:1.5}
.gateBox button{border:0;background:linear-gradient(180deg,var(--btn),var(--btn2));color:#fff;border-radius:999px;padding:12px 16px;font-weight:900;cursor:pointer;width:100%}
.mini{font-size:12px;color:var(--muted)}

@media (max-width:520px){
  .scenario{min-width:0;max-width:none}
  .dialog .en{font-size:20px}
  .helperRow{grid-template-columns:repeat(4,1fr);gap:8px}
  .helperBtn{padding:10px 8px;min-height:58px}
  .helperBtn b{font-size:13px}
  .helperBtn small{font-size:11px}
  .micBtn{font-size:14px;padding:13px 14px}
  .skipBtn{padding:13px 14px}
}
</style>
</head>
<body>
<div class="app">
  <div class="top">
    <button class="back" id="btnBack" aria-label="back">â†</button>
    <div class="title">
      <b>Talk Aï¼ˆæ‰‹æ©Ÿå£èªªï¼‰</b>
      <small id="subTitle">TTSï¼šBrowser SpeechSynthesis</small>
    </div>
    <div class="spacer"></div>
    <div class="scenario" title="é¸æ“‡æƒ…å¢ƒ">
      <select id="sceneSelect"></select>
    </div>
    <button class="btn" id="btnReplay">é‡æ’­æœ¬å¥</button>
        <button class="btn" id="btnIntro">é‡æ’­é–‹å ´</button>
  </div>

  <div class="stage">
    <div class="who">
      <span class="pill"><span class="statusDot" id="dot"></span><span id="roleLabel">AI Â· teacher</span></span>
      <small id="sceneLabel">â€”</small>
    </div>

    <div class="center">
      <div class="avatarWrap" id="avatarWrap">
        <img class="avatarImg" id="avatarImg" alt="AI Avatar" />
        <div class="mouth" aria-hidden="true"></div>
      </div>
    </div>

    <div class="dialog" id="dialogBox">
      <div class="en" id="lineEN">Loadingâ€¦</div>
      <div class="zh" id="lineZH">ï¼ˆè¼‰å…¥ä¸­â€¦ï¼‰</div>
      <div class="hint" id="hintLine">æç¤ºï¼šå…ˆè½ AI é–‹å ´ï¼Œå†ç”¨çŸ­å¥å›ç­”ï¼›ä¸ç¢ºå®šå°±æŒ‰ã€Œç¯„ä¾‹ã€ã€‚</div>
    </div>

    <div class="controls">
      <div class="micRow">
        <button class="micBtn" id="btnMic">ğŸ¤ é»æˆ‘èªªï¼ˆé–‹å§‹è¾¨è­˜ï¼‰</button>
        <button class="skipBtn" id="btnSkip">è·³é</button>
      </div>

      <div class="helperRow">
        <button class="helperBtn" id="btnTask"><b>ä»»å‹™</b><small>è¦åšä»€éº¼</small></button>
        <button class="helperBtn" id="btnExamples"><b>ç¯„ä¾‹</b><small>ä¸æœƒå¥</small></button>
        <button class="helperBtn" id="btnTranslate"><b>ç¿»è­¯</b><small>ä¸­ / æ—¥</small></button>
        <button class="helperBtn" id="btnSaved"><b>å·²å„²å­˜</b><small>å–®å­—å¥</small></button>
      </div>

      <div class="note" id="noteText">ä¸»é ä¿æŒåœ¨å°è©±ä¸­ï¼›é»ã€Œä»»å‹™ / ç¯„ä¾‹ / ç¿»è­¯ / å·²å„²å­˜ã€åªæœƒæ‰“é–‹è¼”åŠ©å°çª—ï¼Œä¸æœƒä¸­æ–·å°è©±ã€‚</div>
    </div>
  </div>
</div>

<!-- Bottom sheet -->
<div class="sheetMask" id="sheetMask"></div>
<div class="sheet" id="sheet">
  <div class="sheetHead">
    <div style="width:100%"><div class="grab"></div></div>
    <button class="sheetClose" id="sheetClose">é—œé–‰</button>
  </div>
  <div class="sheetBody" id="sheetBody"></div>
</div>

<!-- Audio gate -->
<div class="gate" id="gate">
  <div class="gateBox">
    <div class="mini">iPhone/éƒ¨åˆ†ç€è¦½å™¨æœƒé˜»æ“‹ã€Œè‡ªå‹•å‡ºè²ã€</div>
    <h2>é»ä¸€ä¸‹å•Ÿå‹•èªéŸ³</h2>
    <p>å•Ÿå‹•å¾Œï¼ŒAI æœƒã€Œä¸»å‹•å…ˆå‡ºè²ã€ï¼Œä¹‹å¾Œæ¯å¥éƒ½æœƒè‡ªå‹•æœ—è®€ã€‚</p>
    <button id="gateBtn">é–‹å§‹</button>
    <p class="mini" style="margin-top:10px">ï¼ˆåªè¦é»ä¸€æ¬¡ï¼Œä»¥å¾Œå°±ä¸ç”¨ï¼‰</p>
  </div>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  // DOM
  const sceneSelect = $("sceneSelect");
  const roleLabel = $("roleLabel");
  const sceneLabel = $("sceneLabel");
  const avatarImg = $("avatarImg");
  const avatarWrap = $("avatarWrap");
  const lineEN = $("lineEN");
  const lineZH = $("lineZH");
  const hintLine = $("hintLine");
  const btnReplay = $("btnReplay");
  const btnMic = $("btnMic");
  const btnSkip = $("btnSkip");
  const dot = $("dot");
  const btnBack = $("btnBack");

  const sheetMask = $("sheetMask");
  const sheet = $("sheet");
  const sheetBody = $("sheetBody");
  const sheetClose = $("sheetClose");
  const btnTask = $("btnTask");
  const btnExamples = $("btnExamples");
  const btnTranslate = $("btnTranslate");
  const btnSaved = $("btnSaved");

  const gate = $("gate");
  const gateBtn = $("gateBtn");

  // State
  let ROOT = null;         // e.g. https://bookwide.net/EduEnglish/
  let TALK = null;         // ROOT + "talk/"
  let indexData = null;    // talk/index.json
  let scene = null;        // current scenario json
  let sceneMeta = null;    // item from index
  let pos = 0;             // dialogue index
  let unlockedAudio = false;

  // Intro video (per scene)
  const INTRO_URL_COFFEE = 'https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/talk/teacher/intro_coffee_shop.mp4';
  const INTRO_SCENES = { coffee_shop: true };
  const INTRO_DONE = {};


  // --- Utilities ---
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
  const safeText = (v)=> (v==null ? "" : String(v));
  const esc = (s)=> safeText(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

  async function tryFetchJSON(url){
    try{
      const res = await fetch(url, {cache:"no-store"});
      if(!res.ok) return null;
      return await res.json();
    }catch(e){ return null; }
  }


  function showIntroIfNeeded(sceneId){
    return new Promise((resolve)=>{
      if(!INTRO_SCENES[sceneId]) return resolve(false);
      if(INTRO_DONE[sceneId]) return resolve(false);

      const overlay = $("introOverlay");
      const video = $("introVideo");
      const playBtn = $("introPlayBtn");
      const skipBtn = $("introSkipBtn");
      if(!overlay || !video || !playBtn || !skipBtn) return resolve(false);

      // ensure src
      const src = video.querySelector("source");
      if(src && !src.src) src.src = INTRO_URL_COFFEE;

      try{ video.pause(); video.currentTime = 0; }catch(e){}
      overlay.style.display = "block";

      let finished = false;
      const finish = ()=>{
        if(finished) return;
        finished = true;
        INTRO_DONE[sceneId] = true;
        overlay.style.display = "none";
        video.onended = null;
        playBtn.onclick = null;
        skipBtn.onclick = null;
        resolve(true);
      };

      video.onended = finish;
      playBtn.onclick = ()=>{ const p = video.play(); if(p && p.catch) p.catch(()=>{}); };
      skipBtn.onclick = finish;

      // try autoplay (may be blocked)
      const p = video.play();
      if(p && p.catch) p.catch(()=>{ /* user click play */ });
    });
  }

  function resetIntro(sceneId){
    if(sceneId) INTRO_DONE[sceneId] = false;
  }


  // Robust root resolver: try current folder /EduEnglish/ / (site root)
  async function resolveRoot(){
    const origin = location.origin;
    const path = location.pathname; // /talk_A.html or /EduEnglish/talk_A.html ...
    const dir = origin + path.slice(0, path.lastIndexOf("/") + 1); // current folder
    const candidates = [
      dir,
      origin + "/EduEnglish/",
      origin + "/"
    ];
    for (const root of candidates){
      const data = await tryFetchJSON(root + "talk/index.json");
      if (data && data.items && Array.isArray(data.items)){
        return {root, data};
      }
    }
    return {root: candidates[0], data: null};
  }

  function setStatus(on){
    dot.classList.toggle("on", !!on);
    avatarWrap.classList.toggle("speaking", !!on);
  }

  function setLine(en, zh, hint){
    lineEN.textContent = en || "";
    lineZH.textContent = zh || "";
    hintLine.textContent = hint || "æç¤ºï¼šå…ˆè½ AI é–‹å ´ï¼Œå†ç”¨çŸ­å¥å›ç­”ï¼›ä¸ç¢ºå®šå°±æŒ‰ã€Œç¯„ä¾‹ã€ã€‚";
  }

  // --- TTS ---
  function pickVoice(){
    const voices = speechSynthesis.getVoices();
    // prefer en-US female-ish if available; fallback to first English
    const pref = voices.find(v => /en-US/i.test(v.lang) && /female|woman|zira|jenny|samantha/i.test(v.name));
    if (pref) return pref;
    const anyEn = voices.find(v => /^en/i.test(v.lang));
    return anyEn || voices[0] || null;
  }

  function speak(text){
    return new Promise((resolve)=>{
      if(!("speechSynthesis" in window) || !text){
        resolve(); return;
      }
      try{ speechSynthesis.cancel(); }catch(e){}
      const u = new SpeechSynthesisUtterance(text);
      const v = pickVoice();
      if(v) u.voice = v;
      u.rate = 1.0;
      u.pitch = 1.0;
      u.onstart = ()=>setStatus(true);
      u.onend = ()=>{ setStatus(false); resolve(); };
      u.onerror = ()=>{ setStatus(false); resolve(); };
      speechSynthesis.speak(u);
    });
  }

  async function ensureAudioUnlocked(){
    if(unlockedAudio) return true;
    // show gate if autoplay blocked
    gate.classList.add("show");
    await new Promise((resolve)=>{
      gateBtn.onclick = async ()=>{
        try{
          // tiny speak to unlock
          await speak("Hello.");
        }catch(e){}
        gate.classList.remove("show");
        unlockedAudio = true;
        resolve();
      };
    });
    return true;
  }

  // --- Speech Recognition ---
  function hasASR(){
    return ("webkitSpeechRecognition" in window) || ("SpeechRecognition" in window);
  }

  function startASR(){
    return new Promise((resolve)=>{
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR){ resolve({ok:false, text:""}); return; }
      const r = new SR();
      r.lang = "en-US";
      r.interimResults = false;
      r.maxAlternatives = 1;

      let done = false;
      const finish = (obj)=>{
        if(done) return;
        done = true;
        try{ r.stop(); }catch(e){}
        resolve(obj);
      };

      r.onresult = (ev)=>{
        const t = ev.results && ev.results[0] && ev.results[0][0] ? ev.results[0][0].transcript : "";
        finish({ok:true, text:(t||"").trim()});
      };
      r.onerror = ()=>finish({ok:false, text:""});
      r.onend = ()=>{ if(!done) finish({ok:false, text:""}); };

      try{ r.start(); }catch(e){ finish({ok:false, text:""}); }
    });
  }

  // --- Sheet ---
  function openSheet(html){
    sheetBody.innerHTML = html;
    sheetMask.classList.add("show");
    sheet.classList.add("show");
  }
  function closeSheet(){
    sheetMask.classList.remove("show");
    sheet.classList.remove("show");
    sheetBody.innerHTML = "";
  }

  // --- Scenario loading ---
  async function loadScenarioById(id){
    if(!indexData) return;

    const item = indexData.items.find(x=>x.id===id) || indexData.items[0];
    sceneMeta = item;

    // avatar
    if(item && item.avatar){
      avatarImg.src = ROOT + item.avatar.replace(/^\/+/, "");
    }else{
      avatarImg.src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(
        '<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256"><rect width="256" height="256" fill="#fff"/><text x="50%" y="52%" font-size="42" font-family="Arial" text-anchor="middle" fill="#111">AI</text></svg>'
      );
    }

    // label
    roleLabel.textContent = "AI Â· " + (item.role || "teacher");
    sceneLabel.textContent = `${item.title_zh || ""}ï½œ${item.title_en || ""} (${item.level || ""})`;

    // try fetch scenario json
    const candidates = [
      TALK + id + ".json",
      // special: repo uses airport.json but index id is airport_checkin
      (id==="airport_checkin") ? (TALK + "airport.json") : null
    ].filter(Boolean);

    let data = null;
    for (const url of candidates){
      data = await tryFetchJSON(url);
      if (data) break;
    }
    scene = data;

    if(!scene || !Array.isArray(scene.dialogue) || scene.dialogue.length===0){
      setLine("Error", "Failed to load scenario JSON", `æ‰¾ä¸åˆ°ï¼š${id}.jsonï¼ˆè«‹ç¢ºèª talk/ å…§æª”åï¼‰`);
      return;
    }

    // start at first line
    pos = 0;
    await showIntroIfNeeded(id);
    await renderCurrent(true);
  }

  function buildTaskHTML(){
    const missions = (scene && scene.meta && Array.isArray(scene.meta.missions)) ? scene.meta.missions : [];
    if(!missions.length){
      return '<div class="card"><h3>ä»»å‹™</h3><p class="mini">æ­¤æƒ…å¢ƒå°šæœªæä¾› missionsã€‚</p></div>';
    }
    return `
      <div class="card">
        <h3>ä»»å‹™</h3>
        <ul class="list">
          ${missions.map(m=>`<li>${esc(m.text || "")}</li>`).join("")}
        </ul>
      </div>
    `;
  }

  function buildExamplesHTML(){
    const ex = (scene && scene.meta && Array.isArray(scene.meta.examples)) ? scene.meta.examples : [];
    if(!ex.length){
      return '<div class="card"><h3>ç¯„ä¾‹</h3><p class="mini">æ­¤æƒ…å¢ƒå°šæœªæä¾› examplesã€‚</p></div>';
    }
    return `
      <div class="card">
        <h3>ç¯„ä¾‹</h3>
        ${ex.slice(0,8).map(x=>`
          <div style="padding:8px 0;border-top:1px dashed var(--line)">
            <b>${esc(x.en||"")}</b><br/>
            <span class="mini">${esc(x.zh||"")}</span>
          </div>
        `).join("")}
      </div>
    `;
  }

  function buildTranslateHTML(){
    const d = (scene && Array.isArray(scene.dialogue)) ? scene.dialogue : [];
    const rows = d.slice(Math.max(0,pos-6), Math.min(d.length, pos+6));
    return `
      <div class="card">
        <h3>ç¿»è­¯ï¼ˆé™„è¿‘å¥å­ï¼‰</h3>
        ${rows.map(x=>{
          const who = (x.speaker || "").toUpperCase()==="AI" ? "AI" : "YOU";
          const en = x.en || x.hint_en || "";
          const zh = x.zh || x.hint_zh || "";
          return `<div style="padding:8px 0;border-top:1px dashed var(--line)">
            <span class="tag">${who}</span>
            <b>${esc(en)}</b><br/>
            <span class="mini">${esc(zh)}</span>
          </div>`;
        }).join("")}
      </div>
    `;
  }

  // saved phrases (localStorage)
  const LS_KEY = "talkA_saved_phrases_v1";
  function getSaved(){
    try{ return JSON.parse(localStorage.getItem(LS_KEY) || "[]") || []; }catch(e){ return []; }
  }
  function addSaved(en, zh){
    const arr = getSaved();
    const item = {en: en||"", zh: zh||"", t: Date.now()};
    arr.unshift(item);
    const trimmed = arr.slice(0,50);
    localStorage.setItem(LS_KEY, JSON.stringify(trimmed));
  }
  function buildSavedHTML(){
    const arr = getSaved();
    return `
      <div class="card">
        <h3>å·²å„²å­˜</h3>
        ${arr.length ? arr.map(x=>`
          <div style="padding:8px 0;border-top:1px dashed var(--line)">
            <b>${esc(x.en||"")}</b><br/>
            <span class="mini">${esc(x.zh||"")}</span>
          </div>
        `).join("") : '<p class="mini">å°šç„¡å„²å­˜ã€‚ä½ å¯ä»¥åœ¨ AI å¥å­ä¸ŠæŒ‰ã€Œé‡æ’­æœ¬å¥ã€å¾Œï¼Œå†é»ã€Œå·²å„²å­˜ã€ä¾†å­˜ä¸€å¥ã€‚</p>'}
      </div>
    `;
  }

  async function renderCurrent(autoSpeakIfAI){
    if(!scene || !scene.dialogue) return;
    const d = scene.dialogue;
    const cur = d[pos] || null;
    if(!cur){
      setLine("Great job!", "æœ¬æƒ…å¢ƒçµæŸ âœ…", "ä½ å¯ä»¥æ›ä¸‹ä¸€å€‹æƒ…å¢ƒç¹¼çºŒç·´ã€‚");
      return;
    }

    const speaker = (cur.speaker || "").toUpperCase();
    if(speaker==="AI"){
      const en = safeText(cur.en).trim();
      const zh = safeText(cur.zh).trim();
      setLine(en, zh, "æç¤ºï¼šè½å®Œå¾Œï¼ŒæŒ‰ã€ŒğŸ¤ é»æˆ‘èªªã€ç”¨è‹±æ–‡å›ç­”ã€‚");
      btnMic.disabled = false;
      btnMic.textContent = hasASR() ? "ğŸ¤ é»æˆ‘èªªï¼ˆé–‹å§‹è¾¨è­˜ï¼‰" : "âš ï¸ ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜";
      if(autoSpeakIfAI){
        await ensureAudioUnlocked();
        await speak(en);
      }
    }else{
      // USER turn: show hint prompt
      const hintEN = safeText(cur.hint_en || cur.en).trim();
      const hintZH = safeText(cur.hint_zh || cur.zh).trim();
      setLine(hintEN || "Your turn.", hintZH || "è¼ªåˆ°ä½ èªªã€‚", "æç¤ºï¼šç…§ä¸Šé¢é‚£å¥èªªï¼ŒçŸ­å¥ä¹Ÿå¯ä»¥ã€‚");
      btnMic.disabled = !hasASR();
      btnMic.textContent = hasASR() ? "ğŸ¤ é»æˆ‘èªªï¼ˆé–‹å§‹è¾¨è­˜ï¼‰" : "âš ï¸ ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜";
    }
  }

  async function next(){
    pos = Math.min(pos + 1, (scene && scene.dialogue ? scene.dialogue.length : 0));
    await renderCurrent(true);
  }

  async function replay(){
    if(!scene || !scene.dialogue) return;
    const cur = scene.dialogue[pos];
    if(!cur) return;
    const speaker = (cur.speaker || "").toUpperCase();
    const en = speaker==="AI" ? (cur.en||"") : (cur.hint_en || cur.en || "");
    if(!en) return;
    await ensureAudioUnlocked();
    await speak(en);
  }

  async function onMic(){
    if(!scene || !scene.dialogue) return;
    const cur = scene.dialogue[pos];
    if(!cur) return;

    const speaker = (cur.speaker || "").toUpperCase();
    if(speaker==="AI"){
      // if currently AI line, move to USER hint line (next) if it exists
      await next();
      return;
    }

    if(!hasASR()){
      setLine(lineEN.textContent, lineZH.textContent, "âš ï¸ æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼Œå»ºè­°ç”¨ Chrome/Edgeã€‚");
      return;
    }

    btnMic.disabled = true;
    btnMic.textContent = "ğŸ§ è½ä½ èªªâ€¦";

    const result = await startASR();
    btnMic.disabled = false;
    btnMic.textContent = "ğŸ¤ é»æˆ‘èªªï¼ˆé–‹å§‹è¾¨è­˜ï¼‰";

    if(!result.ok || !result.text){
      setLine(lineEN.textContent, lineZH.textContent, "ï¼ˆæ²’è½æ¸…æ¥šï¼‰å†æŒ‰ä¸€æ¬¡ğŸ¤ï¼Œæˆ–æŒ‰ã€Œè·³éã€ã€‚");
      return;
    }

    // show transcript quickly
    const transcript = result.text;
    setLine(transcript, "ï¼ˆä½ å‰›å‰›èªªçš„ï¼‰", "å¾ˆå¥½ï¼æˆ‘å¹«ä½ æ¥ä¸‹ä¸€å¥ã€‚");

    // save the hint as a study phrase (optional)
    const hintEN = safeText(cur.hint_en || cur.en).trim();
    const hintZH = safeText(cur.hint_zh || cur.zh).trim();
    if(hintEN) addSaved(hintEN, hintZH);

    await sleep(450);
    await next(); // go to next (likely AI)
  }

  // --- Init ---
  async function boot(){
    // back
    btnBack.onclick = ()=>{ history.back(); };

    // sheet wiring
    sheetMask.addEventListener("click", closeSheet);
    sheetClose.addEventListener("click", closeSheet);

    btnTask.onclick = ()=> openSheet(buildTaskHTML());
    btnExamples.onclick = ()=> openSheet(buildExamplesHTML());
    btnTranslate.onclick = ()=> openSheet(buildTranslateHTML());
    btnSaved.onclick = ()=> openSheet(buildSavedHTML());

    btnReplay.onclick = replay;
    btnIntro.onclick = async ()=>{ if(sceneMeta && sceneMeta.id){ resetIntro(sceneMeta.id); await showIntroIfNeeded(sceneMeta.id); } };
    btnMic.onclick = onMic;
    btnSkip.onclick = next;

    // load index
    const resolved = await resolveRoot();
    ROOT = resolved.root;
    indexData = resolved.data;
    TALK = ROOT + "talk/";

    if(!indexData){
      setLine("Error", "Failed to fetch", "æ‰¾ä¸åˆ° talk/index.jsonï¼ˆè«‹ç¢ºèªï¼š/EduEnglish/talk/index.json å­˜åœ¨ï¼‰");
      return;
    }

    // build select
    sceneSelect.innerHTML = "";
    indexData.items.forEach((it)=>{
      const opt = document.createElement("option");
      opt.value = it.id;
      opt.textContent = `${it.title_zh}ï½œ${it.title_en} (${it.level})`;
      sceneSelect.appendChild(opt);
    });

    sceneSelect.onchange = ()=> loadScenarioById(sceneSelect.value);

    // default: first
    await loadScenarioById(sceneSelect.value || indexData.items[0].id);

    // voices load async
    if("speechSynthesis" in window){
      speechSynthesis.onvoiceschanged = ()=>{};
    }
  }

  boot();
})();
</script>

<!-- ===== Coffee Shop Intro Overlay ===== -->
<div id="introOverlay" style="display:none;position:fixed;inset:0;z-index:99999;background:#fff;">
  <div style="max-width:980px;margin:0 auto;padding:16px;display:flex;flex-direction:column;gap:12px;height:100%;">
    <div style="display:flex;align-items:center;gap:10px;">
      <div style="font-weight:900;font-size:16px;">Coffee Shop Intro</div>
      <div style="margin-left:auto;display:flex;gap:8px;">
        <button id="introPlayBtn" class="btn">æ’­æ”¾</button>
        <button id="introSkipBtn" class="btn">è·³é</button>
      </div>
    </div>
    <div style="flex:1;display:flex;align-items:center;justify-content:center;border:1px solid var(--line);border-radius:18px;background:var(--soft);overflow:hidden;">
      <video id="introVideo" playsinline webkit-playsinline preload="auto" style="width:100%;height:100%;max-height:74vh;object-fit:contain;background:#000">
        <source src="https://jeajrwpmrgczimmrflxo.supabase.co/storage/v1/object/public/talk/teacher/intro_coffee_shop.mp4" type="video/mp4" />
      </video>
    </div>
    <div class="mini" id="introHint">è‹¥ç€è¦½å™¨é˜»æ“‹è‡ªå‹•æ’­æ”¾ï¼ŒæŒ‰ã€Œæ’­æ”¾ã€å³å¯ã€‚</div>
  </div>
</div>

</body>
</html>
