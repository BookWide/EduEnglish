<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BookWide Talkï½œå½±åƒå£èªªåŠ©æ•™</title>

<style>
:root{
  --bg:#f4f6fb; --card:#fff; --ink:#0f172a; --muted:#64748b;
  --brand:#2563eb; --line:#e5e7eb;
}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:var(--bg);color:var(--ink)}
header{background:#0b1220;color:#fff;padding:12px 20px;display:flex;justify-content:space-between;align-items:center}
main{display:grid;grid-template-columns:360px 1fr;gap:16px;padding:16px}
.card{background:var(--card);border-radius:16px;padding:16px;border:1px solid var(--line)}
h3{margin:0 0 8px}
select,button{padding:8px 10px;margin:4px 0}
button.primary{background:var(--brand);color:#fff;border:none;border-radius:8px}
button.warn{background:#ef4444;color:#fff;border:none;border-radius:8px}
video{width:100%;border-radius:12px;background:#000}
pre{white-space:pre-wrap}
small{color:var(--muted)}
</style>
</head>

<body>

<header>
  <strong>BookWide Talk</strong>
  <span>å½±åƒå£èªªåŠ©æ•™</span>
</header>

<main>

<!-- å·¦å´ï¼šè¨­å®š + ç›¸æ©Ÿ -->
<div class="card">
  <h3>å£èªªç·´ç¿’è¨­å®š</h3>

  <label>æƒ…å¢ƒ</label>
  <select id="scene">
    <option value="nails">å¡—æŒ‡ç”² nails</option>
    <option value="makeup">åŒ–å¦ makeup</option>
    <option value="cooking">åšèœ cooking</option>
  </select>

  <hr>

  <video id="cam" autoplay muted playsinline></video>
  <button onclick="startCam()">é–‹å•Ÿç›¸æ©Ÿ</button>

  <hr>

  <button class="primary"
    onmousedown="startRec()"
    onmouseup="stopRec()">æŒ‰ä½èªªè©±</button>

  <small>æŒ‰ä½èªªä¸€å¥ï¼Œæ”¾é–‹å³é€ AI åˆ†æ</small>
</div>

<!-- å³å´ï¼šAI å›é¥‹ -->
<div class="card">
  <h3>AI å³æ™‚ç³¾éŒ¯</h3>
  <pre id="out">å°šæœªé–‹å§‹</pre>
</div>

</main>

<script>
let stream;
let mediaRecorder;
let audioChunks = [];

async function startCam(){
  stream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  document.getElementById('cam').srcObject = stream;
}

function startRec(){
  if(!stream){ alert('è«‹å…ˆé–‹å•Ÿç›¸æ©Ÿ'); return; }
  audioChunks=[];
  mediaRecorder = new MediaRecorder(stream);
  mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
  mediaRecorder.onstop = sendToAI;
  mediaRecorder.start();
}

function stopRec(){
  if(mediaRecorder && mediaRecorder.state !== 'inactive'){
    mediaRecorder.stop();
  }
}

async function sendToAI(){
  const audioBlob = new Blob(audioChunks,{type:'audio/webm'});

  // æ“·å–ä¸€å¼µç•«é¢
  const video = document.getElementById('cam');
  const canvas = document.createElement('canvas');
  canvas.width = 320;
  canvas.height = 240;
  canvas.getContext('2d').drawImage(video,0,0,320,240);
  const imageData = canvas.toDataURL('image/jpeg');

  const fd = new FormData();
  fd.append('audio', audioBlob);
  fd.append('image', imageData);
  fd.append('scene', document.getElementById('scene').value);

  document.getElementById('out').textContent = 'AI åˆ†æä¸­â€¦';

  try{
    const res = await fetch('/functions/v1/talk-vision',{
      method:'POST',
      body:fd
    });
    const j = await res.json();

    document.getElementById('out').textContent =
`âŒ Incorrect:
${j.incorrect}

âœ… You should say:
${j.correct}

ğŸ§  ä¸­æ–‡èªªæ˜ï¼š
${j.hint}

â¡ Follow-up:
${j.followup}`;
  }catch(err){
    document.getElementById('out').textContent = 'éŒ¯èª¤ï¼š' + err.message;
  }
}
</script>

</body>
</html>
