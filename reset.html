<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>重設密碼｜BookWide</title>

  <style>
    body{
      margin:0; background:#0b1324; color:#fff;
      font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;
    }
    .wrap{
      max-width:480px; margin:60px auto; padding:20px;
      background:#0f172a; border-radius:18px;
      box-shadow:0 10px 40px rgba(0,0,0,.4);
    }
    h2{ margin-top:0; font-size:28px; }
    .ipt{
      width:100%; padding:14px; border-radius:10px;
      border:1px solid #334155; background:#1e293b; color:#fff;
      margin:12px 0;
      font-size:16px;
    }
    .btn{
      width:100%; padding:14px; border:none; border-radius:12px;
      background:linear-gradient(90deg,#3b82f6,#22c55e);
      color:#fff; font-size:18px; cursor:pointer;
      margin-top:10px;
    }
    .btn:disabled{
      opacity:.6; cursor:not-allowed;
    }
    .err{ color:#f87171; margin-top:12px; }
    .ok{ color:#4ade80; margin-top:12px; }
  </style>
</head>

<body>
<div class="wrap">
  <h2>重設密碼</h2>

  <input id="newPwd" type="password" class="ipt" placeholder="請輸入新密碼">
  <input id="newPwd2" type="password" class="ipt" placeholder="再次確認新密碼">
  <button id="btnReset" class="btn">重設密碼</button>

  <div id="msg" class="err"></div>
</div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  // ⚠ 這兩個值一定要用「複製按鈕」重新 copy，避免亂碼
  const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
  const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY_HERE";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: {
      // 會自動從 URL 的 #access_token 把 session 建起來
      detectSessionInUrl: true
    }
  });

  const msgEl = document.getElementById("msg");
  const btnReset = document.getElementById("btnReset");

  // 共用：檢查目前是否有有效 session（recovery token）
  async function ensureRecoverySession() {
    const { data, error } = await supabase.auth.getSession();
    if (error) {
      console.error("getSession error:", error);
    }

    const session = data && data.session ? data.session : null;

    if (!session) {
      msgEl.className = "err";
      msgEl.textContent =
        "驗證連結無效或已過期，請回登入頁面重新申請重設密碼。";
      btnReset.disabled = true;
      return null;
    }

    return session;
  }

  // 進頁面先檢查一次
  (async () => {
    await ensureRecoverySession();
  })();

  // 點擊「重設密碼」
  btnReset.addEventListener("click", async () => {
    msgEl.className = "err";
    msgEl.textContent = "";

    const p1 = document.getElementById("newPwd").value.trim();
    const p2 = document.getElementById("newPwd2").value.trim();

    if (!p1 || !p2) {
      msgEl.textContent = "請輸入新密碼";
      return;
    }
    if (p1 !== p2) {
      msgEl.textContent = "兩次密碼不一致";
      return;
    }

    btnReset.disabled = true;

    try {
      // 再確認一次 session（避免連結已過期）
      const session = await ensureRecoverySession();
      if (!session) return;

      const { error } = await supabase.auth.updateUser({ password: p1 });
      if (error) {
        console.error("updateUser error:", error);

        const msg = (error.message || "").toLowerCase();
        if (msg.includes("session") || msg.includes("jwt") || msg.includes("token")) {
          msgEl.textContent =
            "驗證連結無效或已過期，請回登入頁面重新申請重設密碼。";
        } else {
          msgEl.textContent = error.message || "操作失敗，請稍後再試。";
        }
        return;
      }

      msgEl.className = "ok";
      msgEl.textContent = "密碼重設成功，請重新登入。";

      setTimeout(() => {
        // 成功後回到你的登入入口（可依需要改）
        window.location.href = "https://bookwide.net/index.html?denied=signin";
      }, 1500);
    } catch (err) {
      console.error(err);
      msgEl.textContent = err.message || "操作失敗，請稍後再試。";
    } finally {
      // 若前面已判定 session 無效，btn 已經被 disable，不會影響
      if (!btnReset.disabled) return;
      // 如果你希望無論如何都可再試一次，可以改成：
      // btnReset.disabled = false;
    }
  });
</script>

</body>
</html>

