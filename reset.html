<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>重設密碼｜BookWide</title>
  <style>
    :root{
      --bg:#020617;
      --card-bg:#020617;
      --ink:#e5e7eb;
      --muted:#94a3b8;
      --accent:#3b82f6;
      --accent-soft:#1d4ed8;
      --danger:#f97373;
      --success:#4ade80;
      --radius-lg:20px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      min-height:100vh;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,
        "Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      background:radial-gradient(circle at top,#1e293b,#020617 55%);
      color:var(--ink);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px 12px;
    }
    .wrap{
      width:100%;
      max-width:420px;
      background:rgba(15,23,42,.96);
      border-radius:var(--radius-lg);
      box-shadow:0 24px 60px rgba(0,0,0,.75);
      padding:26px 22px 24px;
      border:1px solid rgba(148,163,184,.25);
      backdrop-filter:blur(18px);
    }
    .logo{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:18px;
    }
    .logo-left{
      display:flex;
      align-items:center;
      gap:.75rem;
    }
    .logo-mark{
      width:32px;height:32px;
      border-radius:999px;
      background:linear-gradient(135deg,#38bdf8,#4f46e5);
      display:flex;align-items:center;justify-content:center;
      font-weight:800;font-size:18px;color:#e0f2fe;
      box-shadow:0 8px 20px rgba(56,189,248,.55);
    }
    .logo-title{
      font-size:20px;
      letter-spacing:.03em;
      font-weight:800;
    }
    .badge{
      font-size:12px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.5);
      color:var(--muted);
    }

    h1{
      margin:8px 0 4px;
      font-size:22px;
      letter-spacing:.08em;
    }
    p.sub{
      margin:0 0 18px;
      font-size:14px;
      color:var(--muted);
      line-height:1.6;
    }

    .field{
      margin-bottom:14px;
    }
    .label{
      font-size:13px;
      color:var(--muted);
      margin-bottom:4px;
    }
    .ipt{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(148,163,184,.45);
      background:#020617;
      color:var(--ink);
      padding:10px 12px;
      font-size:15px;
      outline:none;
      transition:border-color .15s,box-shadow .15s,background .15s;
    }
    .ipt:focus{
      border-color:#60a5fa;
      box-shadow:0 0 0 1px rgba(96,165,250,.9);
    }

    .btn-primary{
      width:100%;
      margin-top:6px;
      border:none;
      border-radius:14px;
      padding:11px 14px;
      font-size:16px;
      font-weight:600;
      letter-spacing:.12em;
      background:linear-gradient(135deg,#3b82f6,#2563eb);
      color:#e5f0ff;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:.5rem;
      box-shadow:0 16px 40px rgba(37,99,235,.75);
    }
    .btn-primary:disabled{
      opacity:.65;
      cursor:default;
      box-shadow:none;
    }

    .msg{
      margin-top:10px;
      font-size:13px;
      line-height:1.6;
    }
    .msg.error{color:var(--danger);}
    .msg.ok{color:var(--success);}

    .footer-link{
      margin-top:18px;
      font-size:13px;
      text-align:right;
      color:var(--muted);
    }
    .footer-link a{
      color:#93c5fd;
      text-decoration:none;
    }
    .footer-link a:hover{text-decoration:underline;}

    @media (max-width:480px){
      .wrap{
        padding:22px 18px 20px;
        border-radius:18px;
      }
      h1{font-size:20px;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="logo">
      <div class="logo-left">
        <div class="logo-mark">B</div>
        <div class="logo-title">BookWide</div>
      </div>
      <div class="badge">Beta</div>
    </header>

    <h1>設定新密碼</h1>
    <p class="sub" id="intro">
      已確認你的身分，請輸入新的密碼並儲存。之後請用新密碼重新登入。
    </p>

    <form id="resetForm">
      <div class="field">
        <div class="label">新密碼</div>
        <input id="pw1" class="ipt" type="password" autocomplete="new-password"
               placeholder="請輸入新密碼（至少 6 碼）">
      </div>
      <div class="field">
        <div class="label">再輸入一次新密碼</div>
        <input id="pw2" class="ipt" type="password" autocomplete="new-password"
               placeholder="再次確認新密碼">
      </div>
      <button type="submit" class="btn-primary" id="submitBtn">
        <span id="btnText">儲存新密碼</span>
      </button>
    </form>

    <div class="msg" id="msg"></div>

    <div class="footer-link">
      密碼已更新後，請回到登入畫面：<br>
      <a href="index.html?denied=signin">返回登入</a>
    </div>
  </div>

  <!-- 共用 Supabase 客戶端 -->
  <script src="supa.js"></script>
  <script>
    (function(){
      const form = document.getElementById('resetForm');
      const pw1  = document.getElementById('pw1');
      const pw2  = document.getElementById('pw2');
      const msg  = document.getElementById('msg');
      const btn  = document.getElementById('submitBtn');
      const btnText = document.getElementById('btnText');

      let code = new URLSearchParams(location.search).get('code') || '';
      let exchanged = false; // 避免重複 exchangeCodeForSession

      if (!code) {
        // 沒有 code，連結已失效
        form.style.display = 'none';
        msg.className = 'msg error';
        msg.textContent = '此重設連結無效或已過期，請在登入畫面重新點選「忘記密碼？」再寄一次。';
        return;
      }

      function showError(text){
        msg.className = 'msg error';
        msg.textContent = text;
      }
      function showOk(text){
        msg.className = 'msg ok';
        msg.textContent = text;
      }

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();

        const p1 = pw1.value.trim();
        const p2 = pw2.value.trim();

        if (!p1 || !p2){
          showError('請輸入兩次新密碼。');
          return;
        }
        if (p1.length < 6){
          showError('新密碼至少需要 6 個字元。');
          return;
        }
        if (p1 !== p2){
          showError('兩次輸入的密碼不相同，請再確認。');
          return;
        }

        btn.disabled = true;
        btnText.textContent = '處理中…';
        showError(''); // 清空訊息

        try{
          // 1. 用 code 換取 session
          if (!exchanged){
            const { data, error } = await supa.auth.exchangeCodeForSession(code);
            if (error){
              console.error('exchangeCodeForSession error', error);
              showError('重設連結無效或已過期，請在登入畫面重新寄送重設密碼信。');
              btn.disabled = false;
              btnText.textContent = '儲存新密碼';
              return;
            }
            exchanged = true;
          }

          // 2. 更新使用者密碼
          const { error: updateError } = await supa.auth.updateUser({
            password: p1
          });

          if (updateError){
            console.error('updateUser error', updateError);
            showError('更新密碼時發生錯誤：' + (updateError.message || '請稍後再試'));
            btn.disabled = false;
            btnText.textContent = '儲存新密碼';
            return;
          }

          // 3. 登出目前 session（讓使用者用新密碼重新登入）
          await supa.auth.signOut().catch(()=>{});

          showOk('✅ 密碼已更新，請回到登入畫面使用新密碼登入。');
          btn.disabled = true;
          btnText.textContent = '已更新';
        }catch(err){
          console.error(err);
          showError('更新密碼時發生未預期錯誤，請稍後再試。');
          btn.disabled = false;
          btnText.textContent = '儲存新密碼';
        }
      });
    })();
  </script>
</body>
</html>













