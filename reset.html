<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>重設密碼｜BookWide</title>

  <style>
    :root { --ink:#0a1020; --muted:#6b7280; --accent:#2563eb; }
    * { box-sizing:border-box; }
    body {
      margin:0;
      background:#f6f7fb;
      font-family:ui-sans-serif,system-ui,"Noto Sans TC";
      color:var(--ink);
    }
    .wrap {
      max-width:520px;
      margin:8vh auto;
      padding:20px;
    }
    .card {
      background:#fff;
      border:1px solid #e1e5ed;
      border-radius:12px;
      padding:26px 24px;
      box-shadow:0 10px 28px rgba(8,12,24,.06);
    }
    .hd { font-size:20px; font-weight:800; margin-bottom:10px; }
    .ipt {
      width:100%; padding:14px 16px; font-size:16px;
      border:1px solid #d0d4dd; border-radius:8px;
      margin-bottom:16px;
    }
    .btn {
      width:100%; padding:14px 0; text-align:center;
      cursor:pointer;
      font-size:17px; color:#fff; background:var(--accent);
      border-radius:8px; border:none;
    }
    .msg { margin-top:14px; color:#b2172e; font-size:14px; }
    .ok { color:#0a7f2e; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <div class="hd">重設密碼</div>

    <input id="pw1" type="password" class="ipt" placeholder="輸入新密碼">
    <input id="pw2" type="password" class="ipt" placeholder="再輸入一次新密碼">
    <button class="btn" id="saveBtn">儲存新密碼</button>

    <div id="msg" class="msg"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="./supa.js"></script>

<script>
(async () => {

  const msg = document.getElementById("msg");

  // 1️⃣ 取得 token
  const url = new URL(window.location.href);
  const token = url.searchParams.get("token");
  const type = url.searchParams.get("type");   // rp = reset password

  if (!token || !type) {
    msg.textContent = "連結無效或已過期。";
    return;
  }

  // 2️⃣ 告訴 Supabase：這是 reset 密碼的 token → 建立 session
  const { data, error } = await supa.auth.exchangeCodeForSession(token);

  if (error) {
    msg.textContent = "重設連結已失效，請重新要求重設密碼。";
    return;
  }

  // -----------------------------
  // 3️⃣ 送出密碼
  // -----------------------------
  document.getElementById("saveBtn").onclick = async () => {

    const pw1 = document.getElementById("pw1").value.trim();
    const pw2 = document.getElementById("pw2").value.trim();

    if (!pw1 || pw1 !== pw2) {
      msg.textContent = "兩次密碼不一致";
      return;
    }

    msg.textContent = "";

    const { error: upErr } = await supa.auth.updateUser({
      password: pw1
    });

    if (upErr) {
      msg.textContent = "錯誤：" + upErr.message;
      return;
    }

    msg.classList.add("ok");
    msg.textContent = "密碼修改成功！3 秒後自動前往登入頁…";

    setTimeout(() => {
      window.location.href = "login.html";
    }, 3000);
  };

})();
</script>
</body>
</html>









