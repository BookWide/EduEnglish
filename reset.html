<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>重設密碼・BookWide</title>

  <style>
    :root{
      --ink:#0a1020; --muted:#6b7280; --accent:#2563eb;
    }
    *{box-sizing:border-box;}
    body{margin:0;font-family:ui-sans-serif,system-ui,"Noto Sans TC";color:var(--ink);background:#f6f7fb;}
    .wrap{max-width:520px;margin:8vh auto;padding:20px;}
    .card{
      background:#fff;border:1px solid #e5e7eb;
      border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.06);
      overflow:hidden;
    }
    .hd{padding:16px 18px;border-bottom:1px solid #eef1f6;font-weight:800;font-size:20px;}
    .bd{padding:16px 18px;}
    .row{margin:10px 0;}
    .ipt{
      width:100%;font-size:16px;padding:12px;border-radius:8px;
      border:1px solid #d1d5db;
    }
    button{
      width:100%;padding:12px;font-size:16px;margin-top:10px;
      background:var(--accent);border:0;border-radius:8px;color:#fff;
    }
    .msg{margin-top:12px;font-size:14px;}
    .ok{color:#0a7f2e;}
    .err{color:#b91c1c;}
  </style>

  <!-- 必須：載入 supa.js 才能使用 BW.supa -->
  <script type="module" src="./supa.js"></script>
</head>

<body>
<div class="wrap">
  <div class="card">
    <div class="hd">重設密碼</div>
    <div class="bd">

      <!-- panel1：要求寄出 reset link -->
      <div id="panelSend">
        <p>輸入你的 Email，我們會寄送一封重設密碼的連結給你。</p>
        <input id="email" class="ipt" placeholder="Email" type="email" />
        <button id="btnSend">寄送重設連結</button>
        <div id="msgSend" class="msg"></div>
      </div>

      <!-- panel2：設定新密碼 -->
      <div id="panelReset" style="display:none;">
        <p>請輸入你的新密碼。</p>
        <input id="pwd1" class="ipt" type="password" placeholder="新密碼" />
        <input id="pwd2" class="ipt" type="password" placeholder="再輸入一次新密碼" />
        <button id="btnReset">儲存新密碼</button>
        <div id="msgReset" class="msg"></div>
      </div>

    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const panelSend  = document.getElementById("panelSend");
  const panelReset = document.getElementById("panelReset");

  const btnSend    = document.getElementById("btnSend");
  const msgSend    = document.getElementById("msgSend");
  const emailInput = document.getElementById("email");

  const pwd1       = document.getElementById("pwd1");
  const pwd2       = document.getElementById("pwd2");
  const btnReset   = document.getElementById("btnReset");
  const msgReset   = document.getElementById("msgReset");

  // 判斷是否含 token=…&type=rp → 顯示設定新密碼
  const params = new URLSearchParams(location.search);
  const type = params.get("type");
  const token = params.get("token");

  if (type === "rp" && token) {
    panelSend.style.display = "none";
    panelReset.style.display = "block";
  }

  // 寄送 reset email
  btnSend.addEventListener("click", async () => {
    msgSend.textContent = "";
    const email = emailInput.value.trim();
    if (!email) {
      msgSend.textContent = "請輸入 Email";
      msgSend.className = "msg err";
      return;
    }

    const { error } = await BW.supa.auth.resetPasswordForEmail(email, {
      redirectTo: "https://bookwide.net/reset.html"
    });

    if (error) {
      msgSend.textContent = error.message;
      msgSend.className = "msg err";
    } else {
      msgSend.textContent = "重設密碼連結已寄出，請檢查信箱。";
      msgSend.className = "msg ok";
    }
  });

  // 重設密碼流程
  btnReset.addEventListener("click", async () => {
    msgReset.textContent = "";

    if (pwd1.value !== pwd2.value) {
      msgReset.textContent = "兩次密碼不一致";
      msgReset.className = "msg err";
      return;
    }

    const newPwd = pwd1.value.trim();
    if (!newPwd) {
      msgReset.textContent = "密碼不能為空";
      msgReset.className = "msg err";
      return;
    }

    const { error } = await BW.supa.auth.updateUser({ password: newPwd });

    if (error) {
      msgReset.textContent = error.message;
      msgReset.className = "msg err";
    } else {
      msgReset.textContent = "密碼已更新，請返回登入頁登入。";
      msgReset.className = "msg ok";
    }
  });

});
</script>

</body>
</html>








