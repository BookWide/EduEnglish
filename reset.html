<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>重設密碼｜BookWide</title>
  <style>
    :root{
      --ink:#0f172a;
      --muted:#6b7280;
      --brand:#2563eb;
      --danger:#b91c1c;
      --card-bg:#fff;
      --bg:#f4f6fb;
      --radius:16px;
      --shadow:0 10px 30px rgba(15,23,42,.10);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      background:var(--bg);
      color:var(--ink);
    }
    .wrap{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px 12px;
    }
    .card{
      width:100%;
      max-width:480px;
      background:var(--card-bg);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:24px 22px 28px;
    }
    .logo{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:.5rem;
      margin-bottom:12px;
      font-weight:800;
      font-size:20px;
    }<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>重設密碼｜BookWide</title>
  <script type="module" src="supa.js"></script>
  <style>
    body{margin:0;background:#f3f5fb;font-family:system-ui;}
    .wrap{
      max-width:480px;margin:60px auto;padding:32px;border-radius:18px;
      background:#fff;box-shadow:0 6px 18px rgba(0,0,0,.08);
    }
    input{
      width:100%;padding:14px;border-radius:10px;border:1px solid #d0d4e4;
      margin-bottom:12px;font-size:16px;
    }
    button{
      width:100%;padding:16px;border-radius:10px;border:0;
      background:#2563eb;color:#fff;font-size:17px;cursor:pointer;
    }
    .msg{margin-top:12px;color:#b91c1c;}
    .ok{color:#0a7f2e;}
  </style>
</head>
<body>

<div class="wrap">
  <h2>設定新密碼</h2>

  <input id="pw1" type="password" placeholder="新密碼">
  <input id="pw2" type="password" placeholder="再次輸入新密碼">

  <button id="saveBtn">儲存新密碼</button>

  <div id="msg" class="msg"></div>

  <p style="margin-top:20px;">
    密碼已更新，請使用新密碼重新登入。<br>
    <a href="index.html?denied=signin">返回登入</a>
  </p>
</div>

<script type="module">
  import { supa } from "./supa.js";

  const url = new URL(window.location.href);
  const token = url.searchParams.get("token") || url.searchParams.get("code");

  const btn = document.getElementById("saveBtn");
  const msg = document.getElementById("msg");

  btn.onclick = async () => {
    msg.textContent = "";

    const pw1 = document.getElementById("pw1").value.trim();
    const pw2 = document.getElementById("pw2").value.trim();

    if (!pw1 || !pw2) return msg.textContent = "請輸入密碼";
    if (pw1 !== pw2) return msg.textContent = "兩次密碼不一致";

    if (!token) return msg.textContent = "token 無效，請重新點擊重設連結";

    // ★ 使用 Supabase 更新密碼（官方文件方法）
    const { error } = await supa.auth.exchangeCodeForSession(token);
    if (error) return msg.textContent = "驗證失敗：" + error.message;

    const { error: updateErr } = await supa.auth.updateUser({ password: pw1 });
    if (updateErr) return msg.textContent = "更新失敗：" + updateErr.message;

    msg.classList.remove("msg");
    msg.classList.add("ok");
    msg.textContent = "密碼更新成功，3秒後返回登入頁…";

    // ★★★ 自動導向回 index.html?denied=signin ★★★
    setTimeout(() => {
      window.location.href = "https://bookwide.net/index.html?denied=signin";
    }, 3000);
  };
</script>

</body>
</html>












