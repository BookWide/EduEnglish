<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>重設密碼｜BookWide</title>

  <style>
    body{
      margin:0; background:#0b1324; color:#fff;
      font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;
    }
    .wrap{
      max-width:480px; margin:60px auto; padding:20px;
      background:#0f172a; border-radius:18px;
      box-shadow:0 10px 40px rgba(0,0,0,.4);
    }
    h2{ margin-top:0; font-size:28px; }
    .ipt{
      width:100%; padding:14px; border-radius:10px;
      border:1px solid #334155; background:#1e293b; color:#fff;
      margin:12px 0;
      font-size:16px;
    }
    .btn{
      width:100%; padding:14px; border:none; border-radius:12px;
      background:linear-gradient(90deg,#3b82f6,#22c55e);
      color:#fff; font-size:18px; cursor:pointer;
      margin-top:10px;
    }
    .btn:disabled{
      opacity:.5; cursor:not-allowed;
    }
    .err{ color:#f87171; margin-top:12px; }
    .ok{ color:#4ade80; margin-top:12px; }
  </style>
</head>

<body>
<div class="wrap">
  <h2>重設密碼</h2>

  <input id="newPwd" type="password" class="ipt" placeholder="請輸入新密碼">
  <input id="newPwd2" type="password" class="ipt" placeholder="再次確認新密碼">
  <button id="btnReset" class="btn">重設密碼</button>

  <div id="msg" class="err"></div>
</div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // 你的 Supabase 專案設定
  const supabase = createClient(
    "https://jeajrwpmrgczimmrflxo.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do"
  );

  const msg = document.getElementById("msg");
  const btn = document.getElementById("btnReset");

  // 解析 URL hash 裡的 token (#access_token=...&refresh_token=...)
  function getTokensFromHash() {
    const hash = window.location.hash.startsWith("#")
      ? window.location.hash.slice(1)
      : window.location.hash;
    const params = new URLSearchParams(hash);
    return {
      access_token: params.get("access_token"),
      refresh_token: params.get("refresh_token"),
      type: params.get("type")
    };
  }

  const tokens = getTokensFromHash();

  // 如果完全沒有 access_token，就直接判定為失效
  if (!tokens.access_token) {
    msg.textContent = "驗證連結無效或已過期，請回登入頁面重新申請重設密碼。";
    btn.disabled = true;
  } else {
    // 有 token：先把 session 設起來，後面 updateUser 才有權限
    (async () => {
      try {
        const { error } = await supabase.auth.setSession({
          access_token: tokens.access_token,
          refresh_token: tokens.refresh_token
        });
        if (error) {
          console.error(error);
          msg.textContent = "登入驗證失敗，請重新從信箱中的重設連結進入。";
          btn.disabled = true;
        }
      } catch (e) {
        console.error(e);
        msg.textContent = "系統錯誤，請稍後再試。";
        btn.disabled = true;
      }
    })();
  }

  // 點擊「重設密碼」
  document.getElementById("btnReset").addEventListener("click", async () => {
    msg.className = "err";
    msg.textContent = "";

    const p1 = document.getElementById("newPwd").value.trim();
    const p2 = document.getElementById("newPwd2").value.trim();

    if (!p1 || !p2) {
      msg.textContent = "請輸入新密碼";
      return;
    }
    if (p1 !== p2) {
      msg.textContent = "兩次密碼不一致";
      return;
    }

    btn.disabled = true;

    try {
      const { error } = await supabase.auth.updateUser({ password: p1 });
      if (error) throw error;

      msg.className = "ok";
      msg.textContent = "密碼重設成功，請重新登入。";

      // 1.5 秒後回登入頁
      setTimeout(() => {
        window.location.href = "/login.html";
      }, 1500);
    } catch (err) {
      console.error(err);
      msg.className = "err";
      msg.textContent = err.message || "操作失敗，請稍後再試。";
      btn.disabled = false;
    }
  });
</script>

</body>
</html>



