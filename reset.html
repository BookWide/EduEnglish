<script type="module">
  import { supabase as supa } from './supa.js';

  const sectionRequest = document.getElementById('sectionRequest');
  const sectionSetPwd  = document.getElementById('sectionSetPwd');
  const msgEl          = document.getElementById('msg');
  const statusPill     = document.getElementById('statusPill');
  const titleEl        = document.getElementById('title');
  const subtitleEl     = document.getElementById('subtitle');
  const timerHint      = document.getElementById('timerHint');

  const emailInput = document.getElementById('email');
  const btnSend    = document.getElementById('btnSend');
  const pwd1Input  = document.getElementById('pwd1');
  const pwd2Input  = document.getElementById('pwd2');
  const btnSave    = document.getElementById('btnSave');
  const btnSaveLabel = document.getElementById('btnSaveLabel');
  const btnBackToRequest = document.getElementById('btnBackToRequest');

  const BACK_LOGIN_URL = 'index.html?denied=signin';
  let countdownTimer = null;

  function showMessage(text, type = 'info') {
    msgEl.textContent = text;
    msgEl.classList.remove('hidden','error','success');
    if (type === 'error') msgEl.classList.add('error');
    if (type === 'success') msgEl.classList.add('success');
  }
  function clearMessage(){
    msgEl.textContent = '';
    msgEl.classList.add('hidden');
    msgEl.classList.remove('error','success');
  }

  function startCountdown(seconds){
    if (!timerHint) return;
    if (countdownTimer) clearInterval(countdownTimer);

    let remain = seconds;
    timerHint.classList.remove('hidden');
    timerHint.textContent = `建議在 ${remain} 秒內完成密碼重設（實際連結有效時間約 5 分鐘）。`;

    countdownTimer = setInterval(() => {
      remain--;
      if (remain <= 0) {
        clearInterval(countdownTimer);
        countdownTimer = null;
        timerHint.textContent = '若尚未完成，建議盡快完成重設，或重新申請新的重設連結。';
      } else {
        timerHint.textContent = `建議在 ${remain} 秒內完成密碼重設（實際連結有效時間約 5 分鐘）。`;
      }
    }, 1000);
  }

  // 判斷「寄信模式」或「真正重設密碼模式」
  const params = new URLSearchParams(window.location.search);
  const code   = params.get('code');

  if (code) {
    // 從 Email 連結進來 → 嘗試驗證
    sectionRequest.classList.add('hidden');
    sectionSetPwd.classList.remove('hidden');
    statusPill.textContent = 'Verify';
    initFromEmail(code);
  } else {
    // 從「忘記密碼？」按鈕過來 → 只顯示寄信畫面
    sectionRequest.classList.remove('hidden');
    sectionSetPwd.classList.add('hidden');
    statusPill.textContent = 'Request';
    titleEl.textContent = '寄送重設密碼連結';
    subtitleEl.textContent = '輸入你的 Email，我們會寄一封包含重設連結的郵件給你。';
  }

  // ① 寄送重設連結
  btnSend?.addEventListener('click', async () => {
    clearMessage();
    const email = emailInput.value.trim();
    if (!email) {
      showMessage('請先輸入 Email。','error');
      return;
    }
    btnSend.disabled = true;
    btnSend.textContent = '寄送中…';

    // 用目前所在網域產生 redirect URL，確保 PKCE 在同一個 origin
    const redirectUrl = `${window.location.origin}/reset.html`;

    const { error } = await supa.auth.resetPasswordForEmail(email, {
      redirectTo: redirectUrl
    });

    if (error) {
      console.error('resetPasswordForEmail error:', error);
      showMessage('寄送重設密碼連結時發生錯誤：' + (error.message || ''),'error');
    } else {
      showMessage('已寄出重設密碼連結，請在 5 分鐘內到信箱收信並點擊郵件中的「Reset Password」。','success');
    }
    btnSend.disabled = false;
    btnSend.textContent = '寄送重設密碼連結';
  });

  // ② Email 連結 → 嘗試換 session，再檢查 session 是否存在
  async function initFromEmail(code) {
    clearMessage();
    showMessage('正在驗證重設密碼連結，請稍候…');

    let fatalError = false;
    let errorMsg = '';

    // 有些情況 Supabase 會自己先換 session，
    // 這時我們呼叫 exchangeCodeForSession 會丟「code / code_verifier 為空」的錯誤，
    // 這種錯誤要當成「非致命」，只要最後真的有 session 就算成功。
    try {
      const { data, error } = await supa.auth.exchangeCodeForSession(code);
      if (error) {
        const msg = error.message || '';
        const lower = msg.toLowerCase();
        if (
          lower.includes('both auth code and code verifier should be non-empty') ||
          lower.includes('auth session missing')
        ) {
          console.warn('exchangeCodeForSession non-fatal error:', msg);
        } else {
          fatalError = true;
          errorMsg = msg;
        }
      }
    } catch (e) {
      const msg = e?.message || String(e);
      const lower = msg.toLowerCase();
      if (
        lower.includes('both auth code and code verifier should be non-empty') ||
        lower.includes('auth session missing')
      ) {
        console.warn('exchangeCodeForSession threw non-fatal error:', msg);
      } else {
        fatalError = true;
        errorMsg = msg;
      }
    }

    // 不管上面結果如何，最後以「有沒有 session」為準
    const { data: sessionCheck } = await supa.auth.getSession();

    if (!sessionCheck?.session) {
      const shown = errorMsg
        ? `驗證失敗：${errorMsg}，請回登入畫面重新申請新的重設連結。`
        : '驗證連結無效或已過期，請回登入畫面重新申請重設密碼。';
      console.error('initFromEmail final no-session:', errorMsg);
      showMessage(shown,'error');

      titleEl.textContent = '連結已失效';
      subtitleEl.textContent = '請回登入頁，使用「忘記密碼？」重新申請新的重設連結，或直接在下方重新寄送。';
      statusPill.textContent = 'Invalid';

      btnSave.disabled = true;
      btnSaveLabel.textContent = '連結已失效';
      btnBackToRequest.classList.remove('hidden');
      timerHint.classList.add('hidden');
      if (countdownTimer) clearInterval(countdownTimer);
      return;
    }

    // ✅ 有 session → 驗證成功，可以輸入新密碼
    clearMessage();
    statusPill.textContent = 'Verified';
    startCountdown(60);
  }

  // 從失效畫面 → 回到寄信畫面（同一頁重新寄信）
  btnBackToRequest?.addEventListener('click', () => {
    clearMessage();
    sectionSetPwd.classList.add('hidden');
    sectionRequest.classList.remove('hidden');
    statusPill.textContent = 'Request';
    titleEl.textContent = '寄送重設密碼連結';
    subtitleEl.textContent = '輸入你的 Email，我們會寄一封包含重設連結的郵件給你。';
    btnBackToRequest.classList.add('hidden');
    timerHint.classList.add('hidden');
    if (countdownTimer) clearInterval(countdownTimer);
  });

  // 儲存新密碼
  btnSave?.addEventListener('click', async () => {
    clearMessage();
    const p1 = pwd1Input.value;
    const p2 = pwd2Input.value;

    if (!p1 || !p2) {
      showMessage('請輸入兩次新密碼。','error');
      return;
    }
    if (p1 !== p2) {
      showMessage('兩次輸入的密碼不一致，請再確認一次。','error');
      return;
    }
    if (p1.length < 6) {
      showMessage('密碼長度至少 6 個字元。','error');
      return;
    }

    btnSave.disabled = true;
    btnSaveLabel.textContent = '儲存中…';

    // 確認 session 是否還在
    const { data: sessionCheck } = await supa.auth.getSession();
    if (!sessionCheck?.session) {
      showMessage('目前尚未通過身分驗證，請重新從信箱中的「Reset Password」連結進入，或重新申請新的連結。','error');
      btnSave.disabled = false;
      btnSaveLabel.textContent = '儲存新密碼';
      return;
    }

    const { error: updateError } = await supa.auth.updateUser({ password: p1 });

    if (updateError) {
      console.error('updateUser error:', updateError);
      showMessage(
        '更新密碼時發生錯誤：' + (updateError.message || '請稍後再試。'),
        'error'
      );
      btnSave.disabled = false;
      btnSaveLabel.textContent = '儲存新密碼';
      return;
    }

    // ✅ 更新成功
    showMessage('密碼已成功更新，請使用新密碼重新登入。','success');
    statusPill.textContent = 'Done';
    titleEl.textContent = '密碼已更新';
    subtitleEl.textContent = '你可以關閉此頁面，或點擊下方「返回登入」重新登入。';
    btnSave.disabled = true;
    btnSaveLabel.textContent = '已儲存';
  });
</script>





















