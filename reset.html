<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>é‡è¨­å¯†ç¢¼ Â· BookWide</title>
  <style>
    :root{ --ink:#0a1020; --muted:#6b7280; --accent:#2563eb; }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,"Noto Sans TC";
      color:var(--ink);
      background:#f6f7fb
    }
    .wrap{max-width:520px;margin:8vh auto;padding:20px}
    .card{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
      overflow:hidden
    }
    .hd{
      padding:16px 18px;
      border-bottom:1px solid #e5e7eb;
      display:flex;
      justify-content:space-between;
      align-items:center
    }
    .logo{font-weight:800;font-size:18px;letter-spacing:.04em}
    .logo span{color:var(--accent)}
    .body{padding:20px 18px 24px}
    h1{margin:0 0 4px;font-size:20px}
    p{margin:4px 0 10px;color:var(--muted);font-size:14px}
    .ipt-row{margin-top:14px}
    label{display:block;margin-bottom:4px;font-size:14px}
    .ipt-wrap{
      position:relative;
      display:flex;
      align-items:center
    }
    .ipt{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #d1d5db;
      font-size:15px;
      outline:none;
      transition:border-color .15s,box-shadow .15s
    }
    .ipt:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(37,99,235,.15)
    }
    .eye-btn{
      position:absolute;
      right:10px;
      border:none;
      background:transparent;
      cursor:pointer;
      font-size:16px;
      opacity:.7
    }
    .btn{
      margin-top:20px;
      width:100%;
      padding:10px 14px;
      border-radius:999px;
      border:none;
      background:var(--accent);
      color:#fff;
      font-size:15px;
      font-weight:600;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      box-shadow:0 10px 20px rgba(37,99,235,.35);
      transition:transform .1s,box-shadow .1s,background .1s
    }
    .btn:disabled{
      opacity:.6;
      cursor:not-allowed;
      box-shadow:none
    }
    .btn:not(:disabled):active{
      transform:translateY(1px);
      box-shadow:0 6px 14px rgba(37,99,235,.35)
    }
    .msg{
      margin-top:10px;
      font-size:13px;
      display:none
    }
    .ft{
      padding:10px 18px 14px;
      border-top:1px solid #e5e7eb;
      font-size:12px;
      color:#9ca3af;
      text-align:center
    }
    .back-link{
      font-size:13px;
      text-align:center;
      margin-top:10px
    }
    .back-link a{color:var(--accent);text-decoration:none}
    .back-link a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="hd">
        <div class="logo"><span>Book</span>Wide</div>
        <div style="font-size:12px;color:#9ca3af;">Reset password</div>
      </div>
      <div class="body">
        <h1>é‡è¨­å¯†ç¢¼</h1>
        <p id="msg1" class="msg" style="display:none"></p>
        <p>è«‹è¼¸å…¥æ–°çš„å¯†ç¢¼ï¼Œä¹‹å¾Œç”¨é€™çµ„å¯†ç¢¼ç™»å…¥ BookWideã€‚</p>

        <div class="ipt-row">
          <label for="pwd1">æ–°å¯†ç¢¼</label>
          <div class="ipt-wrap">
            <input id="pwd1" class="ipt" type="password" placeholder="è‡³å°‘ 6 ç¢¼"/>
            <button type="button" class="eye-btn" onclick="togglePwd('pwd1', this)">ğŸ‘</button>
          </div>
        </div>

        <div class="ipt-row">
          <label for="pwd2">å†è¼¸å…¥ä¸€æ¬¡æ–°å¯†ç¢¼</label>
          <div class="ipt-wrap">
            <input id="pwd2" class="ipt" type="password" placeholder="è«‹å†æ¬¡è¼¸å…¥ä»¥ç¢ºèª"/>
            <button type="button" class="eye-btn" onclick="togglePwd('pwd2', this)">ğŸ‘</button>
          </div>
        </div>

        <button id="btnUpdate" class="btn">
          <span>å„²å­˜æ–°å¯†ç¢¼</span>
        </button>

        <p id="msg2" class="msg"></p>

        <div class="back-link">
          <a href="/login.html">â† å›ç™»å…¥é </a>
        </div>
      </div>
      <div class="ft">
        Â© 2025 BookWide
      </div>
    </div>
  </div>

  <!-- Supabase UMD ç‰ˆæœ¬ï¼ˆåªçµ¦ reset.html ç”¨ï¼Œä¸ç‰½å‹• supa.jsï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = 'https://jeajrwpmrgczimmrflxo.supabase.co';
    const SUPABASE_ANON_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do';

    // å»ºç«‹ä¸€å€‹æ–°çš„ clientï¼›é€™ä¸€é åªç”¨ä¸€æ¬¡ï¼Œä¸éœ€è¦å…±ç”¨å…¶å®ƒé é¢çš„ supa.js
    function makeClient() {
      return window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          persistSession: true,
          detectSessionInUrl: false
        }
      });
    }

    // DOM å°å·¥å…·
    function $(id) { return document.getElementById(id); }
    function showMsg(el, text, ok) {
      if (!el) return;
      el.textContent = text || '';
      el.style.display = text ? 'block' : 'none';
      if (!text) return;
      el.style.color = ok ? '#16a34a' : '#b91c1c';
    }

    // é¡¯ç¤º / éš±è—å¯†ç¢¼çœ¼ç›
    function togglePwd(id, btn) {
      const ipt = document.getElementById(id);
      if (!ipt) return;
      const isPwd = ipt.type === 'password';
      ipt.type = isPwd ? 'text' : 'password';
      if (btn) btn.textContent = isPwd ? 'ğŸ™ˆ' : 'ğŸ‘';
    }
    window.togglePwd = togglePwd; // çµ¦ HTML onclick ç”¨

    // å¾ URL å–å¾— code åƒæ•¸ï¼ˆEmail ç”¨ {{ .RedirectTo }}?code={{ .TokenHash }} å¸¶éä¾†ï¼‰
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');

    const msg1 = $('msg1');
    const msg2 = $('msg2');
    const pwd1 = $('pwd1');
    const pwd2 = $('pwd2');
    const btnUpdate = $('btnUpdate');

    // å®Œæˆå¾Œè¦å›å»çš„ç™»å…¥é 
    const LOGIN_URL = '/login.html';

    window.addEventListener('DOMContentLoaded', () => {
      if (!code) {
        showMsg(
          msg1,
          'é‡è¨­é€£çµå·²å¤±æ•ˆï¼Œè«‹é‡æ–°åœ¨ç™»å…¥é é»ã€Œå¿˜è¨˜å¯†ç¢¼ï¼Ÿã€é‡æ–°ç”³è«‹ã€‚'
        );
        if (btnUpdate) btnUpdate.disabled = true;
        return;
      }

      if (btnUpdate) {
        btnUpdate.addEventListener('click', onSaveNewPassword);
      }
    });

    async function onSaveNewPassword() {
      const p1 = (pwd1 && pwd1.value || '').trim();
      const p2 = (pwd2 && pwd2.value || '').trim();

      if (!p1 || p1.length < 6) {
        showMsg(msg2, 'è«‹è¼¸å…¥è‡³å°‘ 6 ç¢¼çš„æ–°å¯†ç¢¼ã€‚');
        return;
      }
      if (p1 !== p2) {
        showMsg(msg2, 'å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´ï¼Œè«‹å†ç¢ºèªä¸€æ¬¡ã€‚');
        return;
      }

      showMsg(msg2, 'è™•ç†ä¸­ï¼Œè«‹ç¨å€™â€¦', true);
      const client = makeClient();

      try {
        // ç¬¬ä¸€æ­¥ï¼šç”¨ code (token_hash) å…Œæ› recovery session
        const { data, error } = await client.auth.verifyOtp({
          token_hash: code,
          type: 'recovery'
        });
        if (error) {
          console.error('verifyOtp error', error);
          showMsg(msg2, 'é©—è­‰é‡è¨­é€£çµå¤±æ•—ï¼š' + error.message);
          return;
        }

        // ç¬¬äºŒæ­¥ï¼šåœ¨é€™å€‹ session åº•ä¸‹æ›´æ–°å¯†ç¢¼
        const { error: updError } = await client.auth.updateUser({ password: p1 });
        if (updError) {
          console.error('updateUser error', updError);
          showMsg(msg2, 'æ›´æ–°å¯†ç¢¼å¤±æ•—ï¼š' + updError.message);
          return;
        }

        showMsg(msg2, 'å¯†ç¢¼å·²æ›´æ–°ï¼Œè«‹é‡æ–°ç™»å…¥ã€‚', true);

        // 1.5 ç§’å¾Œå°å›ç™»å…¥é 
        setTimeout(() => {
          window.location.href = LOGIN_URL;
        }, 1500);
      } catch (err) {
        console.error('Unhandled reset error', err);
        showMsg(
          msg2,
          'ç™¼ç”ŸéŒ¯èª¤ï¼š' + (err && err.message ? err.message : String(err))
        );
      }
    }
  </script>
</body>
</html>










