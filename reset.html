<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>重設密碼｜BookWide</title>

  <style>
    :root{
      --bg:#0b1324;
      --panel:#0f172a;
      --border:#1f2a44;
      --ink:#e6f0ff;
      --muted:#9fb0c9;
      --accent:#3c7cff;
      --danger:#f97373;
      --success:#22c55e;
      --radius-lg:18px;
      --shadow-card:0 18px 45px rgba(15,23,42,.8);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      min-height:100vh;
      background:radial-gradient(circle at top,#1e293b 0,#020617 55%,#000 100%);
      color:var(--ink);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Noto Sans TC",sans-serif;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px 12px;
    }
    .card{
      width:100%;
      max-width:440px;
      background:linear-gradient(145deg,#0f172a,#020617);
      border-radius:var(--radius-lg);
      border:1px solid rgba(148,163,184,.3);
      box-shadow:var(--shadow-card);
      padding:24px 24px 26px;
      position:relative;
      overflow:hidden;
    }
    .logo-row{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .logo-dot{
      width:32px;height:32px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 20%,#dbeafe 0,#1d4ed8 38%,#020617 100%);
      display:flex;align-items:center;justify-content:center;
      font-weight:700;
      color:#eff6ff;
      box-shadow:0 0 18px rgba(59,130,246,.9);
      font-size:18px;
    }
    .logo-text-main{font-size:20px;font-weight:700;letter-spacing:.08em;}
    .logo-badge{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.4);
      color:var(--muted);
      margin-left:4px;
    }
    h1{
      font-size:22px;
      margin:4px 0 8px;
    }
    .hint{
      font-size:14px;
      color:var(--muted);
      line-height:1.6;
      margin-bottom:8px;
    }
    label{
      display:block;
      font-size:14px;
      margin-bottom:6px;
    }
    input{
      width:100%;
      border-radius:12px;
      border:1px solid var(--border);
      background:#020617;
      color:var(--ink);
      padding:12px 14px;
      font-size:15px;
      outline:none;
      box-shadow:0 0 0 1px transparent;
      transition:.15s border,.15s box-shadow,.15s background;
    }
    input:focus{
      border-color:#60a5fa;
      box-shadow:0 0 0 1px rgba(96,165,250,.8);
      background:#020617;
    }
    .row{margin-bottom:14px;}
    .btn-primary{
      width:100%;
      margin-top:8px;
      border:none;
      border-radius:999px;
      background:linear-gradient(135deg,#2563eb,#38bdf8);
      color:#eff6ff;
      font-size:16px;
      font-weight:600;
      padding:12px 16px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      box-shadow:0 14px 30px rgba(37,99,235,.6);
      transition:.15s transform,.15s box-shadow,.15s opacity;
    }
    .btn-primary:disabled{
      opacity:.5;
      cursor:default;
      box-shadow:none;
      transform:none;
    }
    .btn-primary:not(:disabled):active{
      transform:translateY(1px);
      box-shadow:0 8px 20px rgba(37,99,235,.5);
    }
    .btn-text{
      border:none;
      background:transparent;
      color:var(--muted);
      font-size:13px;
      cursor:pointer;
      padding:0;
      margin-top:4px;
      text-decoration:underline;
      text-underline-offset:3px;
    }
    .note{
      margin-top:12px;
      font-size:13px;
      color:var(--muted);
      line-height:1.6;
    }
    .note a{color:#93c5fd;}
    .msg{
      margin-top:10px;
      font-size:13px;
      line-height:1.6;
      color:var(--muted);
    }
    .msg.error{color:var(--danger);}
    .msg.success{color:var(--success);}
    .hidden{display:none;}
    .status-pill{
      position:absolute;
      top:18px;
      right:20px;
      font-size:11px;
      padding:3px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.5);
      color:var(--muted);
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="status-pill" id="statusPill">Reset</div>

    <div class="logo-row">
      <div class="logo-dot">B</div>
      <div>
        <div>
          <span class="logo-text-main">BookWide</span>
          <span class="logo-badge">Beta</span>
        </div>
      </div>
    </div>

    <h1 id="title">設定新密碼</h1>
    <p class="hint" id="subtitle">
      已確認你的身分，請輸入新的密碼並儲存。之後請用新密碼重新登入。
    </p>
    <p class="hint hidden" id="timerHint"></p>

    <!-- ① 輸入 Email ，寄出重設連結 -->
    <section id="sectionRequest" class="hidden">
      <div class="row">
        <label for="email">Email</label>
        <input id="email" type="email" placeholder="you@example.com" autocomplete="email" />
      </div>
      <button id="btnSend" class="btn-primary">寄送重設密碼連結</button>
      <p class="note">
        系統會寄出一封「Reset Password」郵件到你的信箱，<br>
        請在幾分鐘內點擊信中的連結完成重設。
      </p>
    </section>

    <!-- ② 實際重設密碼 -->
    <section id="sectionSetPwd" class="hidden">
      <div class="row">
        <label for="pwd1">新密碼</label>
        <input id="pwd1" type="password" autocomplete="new-password" />
      </div>
      <div class="row">
        <label for="pwd2">再輸入一次新密碼</label>
        <input id="pwd2" type="password" autocomplete="new-password" />
      </div>
      <button id="btnSave" class="btn-primary">
        <span id="btnSaveLabel">儲存新密碼</span>
      </button>
      <p class="note" id="afterNote" style="margin-top:14px;">
        密碼更新成功後，會自動導向登入畫面：<br>
        <a href="index.html?denied=signin" id="linkLogin">返回登入</a>
      </p>
      <button id="btnBackToRequest" class="btn-text hidden">
        重新寄送重設密碼連結
      </button>
    </section>

    <p id="msg" class="msg hidden"></p>
  </div>

  <script type="module">
    import { supabase as supa } from './supa.js';

    const sectionRequest = document.getElementById('sectionRequest');
    const sectionSetPwd  = document.getElementById('sectionSetPwd');
    const msgEl          = document.getElementById('msg');
    const statusPill     = document.getElementById('statusPill');
    const titleEl        = document.getElementById('title');
    const subtitleEl     = document.getElementById('subtitle');
    const timerHint      = document.getElementById('timerHint');

    const emailInput = document.getElementById('email');
    const btnSend    = document.getElementById('btnSend');
    const pwd1Input  = document.getElementById('pwd1');
    const pwd2Input  = document.getElementById('pwd2');
    const btnSave    = document.getElementById('btnSave');
    const btnSaveLabel = document.getElementById('btnSaveLabel');
    const btnBackToRequest = document.getElementById('btnBackToRequest');

    const BACK_LOGIN_URL = 'index.html?denied=signin';
    let countdownTimer = null;

    function showMessage(text, type = 'info') {
      if (!msgEl) return;
      msgEl.textContent = text;
      msgEl.classList.remove('hidden','error','success');
      if (type === 'error') msgEl.classList.add('error');
      if (type === 'success') msgEl.classList.add('success');
    }
    function clearMessage(){
      if (!msgEl) return;
      msgEl.textContent = '';
      msgEl.classList.add('hidden');
      msgEl.classList.remove('error','success');
    }

    function startCountdown(seconds){
      if (!timerHint) return;
      if (countdownTimer) clearInterval(countdownTimer);

      let remain = seconds;
      timerHint.classList.remove('hidden');
      timerHint.textContent = `建議在 ${remain} 秒內完成密碼重設（實際連結有效時間約 5 分鐘）。`;

      countdownTimer = setInterval(() => {
        remain--;
        if (remain <= 0) {
          clearInterval(countdownTimer);
          countdownTimer = null;
          timerHint.textContent = '若尚未完成，建議盡快完成重設，或重新申請新的重設連結。';
        } else {
          timerHint.textContent = `建議在 ${remain} 秒內完成密碼重設（實際連結有效時間約 5 分鐘）。`;
        }
      }, 1000);
    }

    // 判斷模式：寄信 or 重設
    const params = new URLSearchParams(window.location.search);
    const code   = params.get('code');

    if (code) {
      // 從 Email 連結進來
      sectionRequest?.classList.add('hidden');
      sectionSetPwd?.classList.remove('hidden');
      if (statusPill) statusPill.textContent = 'Verify';
      initFromEmail(code);
    } else {
      // 從登入頁按「忘記密碼？」過來
      sectionRequest?.classList.remove('hidden');
      sectionSetPwd?.classList.add('hidden');
      if (statusPill) statusPill.textContent = 'Request';
      if (titleEl) titleEl.textContent = '寄送重設密碼連結';
      if (subtitleEl) subtitleEl.textContent = '輸入你的 Email，我們會寄一封包含重設連結的郵件給你。';
    }

    // ① 寄送重設連結
    btnSend?.addEventListener('click', async () => {
      clearMessage();
      const email = emailInput?.value.trim();
      if (!email) {
        showMessage('請先輸入 Email。','error');
        return;
      }
      btnSend.disabled = true;
      btnSend.textContent = '寄送中…';

      const redirectUrl = `${window.location.origin}/reset.html`;

      const { error } = await supa.auth.resetPasswordForEmail(email, {
        redirectTo: redirectUrl
      });

      if (error) {
        console.error('resetPasswordForEmail error:', error);
        showMessage('寄送重設密碼連結時發生錯誤：' + (error.message || ''),'error');
      } else {
        showMessage('已寄出重設密碼連結，請在 5 分鐘內到信箱收信並點擊郵件中的「Reset Password」。','success');
      }
      btnSend.disabled = false;
      btnSend.textContent = '寄送重設密碼連結';
    });

    // ② Email 連結 → 嘗試換 session，再檢查 session
    async function initFromEmail(code) {
      clearMessage();
      showMessage('正在驗證重設密碼連結，請稍候…');

      let errorMsg = '';

      try {
        const { data, error } = await supa.auth.exchangeCodeForSession(code);
        if (error) {
          const msg = error.message || '';
          const lower = msg.toLowerCase();
          // 常見「code / code_verifier 為空」→ 可能是 Supabase 已自動處理，暫時不當致命錯
          if (
            !lower.includes('both auth code and code verifier should be non-empty') &&
            !lower.includes('auth session missing')
          ) {
            errorMsg = msg;
          } else {
            console.warn('exchangeCodeForSession non-fatal error:', msg);
          }
        }
      } catch (e) {
        const msg = e?.message || String(e);
        const lower = msg.toLowerCase();
        if (
          !lower.includes('both auth code and code verifier should be non-empty') &&
          !lower.includes('auth session missing')
        ) {
          errorMsg = msg;
        } else {
          console.warn('exchangeCodeForSession threw non-fatal error:', msg);
        }
      }

      const { data: sessionCheck } = await supa.auth.getSession();

      if (!sessionCheck?.session) {
        console.error('initFromEmail final no-session:', errorMsg);
        const shown = errorMsg
          ? `驗證失敗：${errorMsg}，請回登入畫面重新申請新的重設連結。`
          : '驗證連結無效或已過期，請回登入畫面重新申請重設密碼。';

        showMessage(shown,'error');

        if (titleEl) titleEl.textContent = '連結已失效';
        if (subtitleEl) subtitleEl.textContent =
          '請回登入頁，使用「忘記密碼？」重新申請新的重設連結，或直接在下方重新寄送。';
        if (statusPill) statusPill.textContent = 'Invalid';

        if (btnSave) {
          btnSave.disabled = true;
          btnSaveLabel.textContent = '連結已失效';
        }
        btnBackToRequest?.classList.remove('hidden');
        if (timerHint){
          timerHint.classList.add('hidden');
        }
        if (countdownTimer) clearInterval(countdownTimer);
        return;
      }

      // ✅ 有 session → 可以改密碼
      clearMessage();
      if (statusPill) statusPill.textContent = 'Verified';
      startCountdown(60);
    }

    // 連結失效 → 同頁重新寄信
    btnBackToRequest?.addEventListener('click', () => {
      clearMessage();
      sectionSetPwd?.classList.add('hidden');
      sectionRequest?.classList.remove('hidden');
      if (statusPill) statusPill.textContent = 'Request';
      if (titleEl) titleEl.textContent = '寄送重設密碼連結';
      if (subtitleEl) subtitleEl.textContent =
        '輸入你的 Email，我們會寄一封包含重設連結的郵件給你。';
      btnBackToRequest.classList.add('hidden');
      if (timerHint){
        timerHint.classList.add('hidden');
      }
      if (countdownTimer) clearInterval(countdownTimer);
    });

    // 儲存新密碼
    btnSave?.addEventListener('click', async () => {
      clearMessage();
      const p1 = pwd1Input?.value;
      const p2 = pwd2Input?.value;

      if (!p1 || !p2) {
        showMessage('請輸入兩次新密碼。','error');
        return;
      }
      if (p1 !== p2) {
        showMessage('兩次輸入的密碼不一致，請再確認一次。','error');
        return;
      }
      if (p1.length < 6) {
        showMessage('密碼長度至少 6 個字元。','error');
        return;
      }

      btnSave.disabled = true;
      btnSaveLabel.textContent = '儲存中…';

      const { data: sessionCheck } = await supa.auth.getSession();
      if (!sessionCheck?.session) {
        showMessage('目前尚未通過身分驗證，請重新從信箱中的「Reset Password」連結進入，或重新申請新的連結。','error');
        btnSave.disabled = false;
        btnSaveLabel.textContent = '儲存新密碼';
        return;
      }

      const { error: updateError } = await supa.auth.updateUser({ password: p1 });

      if (updateError) {
        console.error('updateUser error:', updateError);
        showMessage(
          '更新密碼時發生錯誤：' + (updateError.message || '請稍後再試。'),
          'error'
        );
        btnSave.disabled = false;
        btnSaveLabel.textContent = '儲存新密碼';
        return;
      }

      // ✅ 更新成功
      showMessage('密碼已成功更新，請使用新密碼重新登入。','success');
      if (statusPill) statusPill.textContent = 'Done';
      if (titleEl) titleEl.textContent = '密碼已更新';
      if (subtitleEl) subtitleEl.textContent =
        '你可以關閉此頁面，或點擊下方「返回登入」重新登入。';
      btnSave.disabled = true;
      btnSaveLabel.textContent = '已儲存';
    });
  </script>
</body>
</html>






















