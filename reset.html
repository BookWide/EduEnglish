<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>重設密碼｜BookWide</title>
  <style>
    body{
      margin:0; background:#0b1324; color:#fff;
      font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;
    }
    .wrap{
      max-width:460px; margin:40px auto; padding:20px;
      background:#0f172a; border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.3);
    }
    h1{font-size:28px; margin-bottom:4px;}
    .ipt{
      width:100%; padding:14px; border-radius:10px;
      border:1px solid #334155; background:#1e293b; color:#fff;
      margin-bottom:14px; font-size:16px;
    }
    button{
      width:100%; padding:14px; border-radius:10px; border:none;
      background:linear-gradient(90deg,#3b82f6,#10b981);
      color:#fff; font-size:18px; cursor:pointer;
    }
    .msg{margin-top:12px; font-size:14px; color:#f87171;}
    .ok{color:#4ade80;}
  </style>
</head>

<body>
  <div class="wrap">
    <h1 id="title">重設密碼</h1>

    <!-- 密碼輸入 -->
    <div id="panel-update" style="display:none;">
      <input id="new1" type="password" class="ipt" placeholder="請輸入新密碼"/>
      <input id="new2" type="password" class="ipt" placeholder="再次確認新密碼"/>
      <button id="btnUpdate">重設密碼</button>
      <div id="msgUpdate" class="msg"></div>
    </div>

    <!-- 等信箱驗證的畫面 -->
    <div id="panel-request" style="display:none;">
      <p class="msg">尚未完成身分驗證，請從信箱中的「Reset Password」連結開啟本頁。</p>
    </div>

    <!-- 無效連結 -->
    <div id="panel-invalid" style="display:none;">
      <p class="msg">驗證連結無效或已過期，請回登入畫面重新申請重設密碼。</p>
    </div>
  </div>

<script type="module">
  /* ----------------------------------------------------
     ① 匯入 Supabase（和 index.html 完全相同）
  ---------------------------------------------------- */
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  const SUPABASE_URL =
    "https://jeajrwpmrgczimmrflxo.supabase.co";   /* ← 你的 URL */
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplYWpyd3BtcmdjemltbXJmbHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTg5MzksImV4cCI6MjA3NjI5NDkzOX0.3iFXdHH0JEuk177_R4TGFJmOxYK9V8XctON6rDe7-Do";

  const supa = window.supa ?? createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  window.supa = supa;

  /* ----------------------------------------------------
     ② DOM 物件
  ---------------------------------------------------- */
  const pReq = document.getElementById("panel-request");
  const pUpd = document.getElementById("panel-update");
  const pInv = document.getElementById("panel-invalid");
  const msgUpdate = document.getElementById("msgUpdate");

  /* ----------------------------------------------------
     ③ 從網址取 access_token
  ---------------------------------------------------- */
  const hash = window.location.hash.substring(1);
  const params = new URLSearchParams(hash);
  const accessToken = params.get("access_token");
  const type = params.get("type");

  /* ----------------------------------------------------
     ④ 如果沒有 Token → 無效連結
  ---------------------------------------------------- */
  if (!accessToken) {
    pInv.style.display = "block";
  } 
  else if (type !== "recovery") {
    pReq.style.display = "block";
  } 
  else {
    /* ----------------------------------------------------
       ⑤ 用 access_token 登入 session
    ---------------------------------------------------- */
    const { data, error } = await supa.auth.exchangeCodeForSession(accessToken);
    if (error) {
      pInv.style.display = "block";
    } else {
      pUpd.style.display = "block";
    }
  }

  /* ----------------------------------------------------
     ⑥ 修改密碼按鈕
  ---------------------------------------------------- */
  document.getElementById("btnUpdate").addEventListener("click", async () => {
    msgUpdate.textContent = "";

    const pw1 = document.getElementById("new1").value.trim();
    const pw2 = document.getElementById("new2").value.trim();

    if (!pw1 || !pw2) {
      msgUpdate.textContent = "請輸入新密碼";
      return;
    }
    if (pw1 !== pw2) {
      msgUpdate.textContent = "兩次密碼不同";
      return;
    }

    const { error } = await supa.auth.updateUser({ password: pw1 });

    if (error) {
      msgUpdate.textContent = error.message;
    } else {
      msgUpdate.classList.add("ok");
      msgUpdate.textContent = "密碼更新成功！請重新登入…";

      setTimeout(() => {
        window.location.href = "/index.html";
      }, 1800);
    }
  });
</script>
</body>
</html>


















