<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>重設密碼｜BookWide</title>

  <style>
    body{
      margin:0; background:#0b1324; color:#fff;
      font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;
    }
    .wrap{
      max-width:480px; margin:60px auto; padding:20px;
      background:#0f172a; border-radius:18px;
      box-shadow:0 10px 40px rgba(0,0,0,.4);
    }
    h2{ margin-top:0; font-size:28px; }
    .ipt{
      width:100%; padding:14px; border-radius:10px;
      border:1px solid #334155; background:#1e293b; color:#fff;
      margin:12px 0;
      font-size:16px;
    }
    .btn{
      width:100%; padding:14px; border:none; border-radius:12px;
      background:linear-gradient(90deg,#3b82f6,#22c55e);
      color:#fff; font-size:18px; cursor:pointer;
      margin-top:10px;
    }
    .err{ color:#f87171; margin-top:12px; }
    .ok{ color:#4ade80; margin-top:12px; }
  </style>
</head>

<body>
<div class="wrap">
  <h2>重設密碼</h2>

  <input id="newPwd" type="password" class="ipt" placeholder="請輸入新密碼">
  <input id="newPwd2" type="password" class="ipt" placeholder="再次確認新密碼">
  <button id="btnReset" class="btn">重設密碼</button>

  <div id="msg" class="err"></div>
</div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  const supabase = createClient(
    "https://jeajrwpmrgczimmrflxo.supabase.co",
    "你的 anon key"
  );

  const msg = document.getElementById("msg");

  // 如果 URL 裡沒有 access token，直接提示錯誤
  const hash = window.location.hash;
  if (!hash.includes("access_token")) {
    msg.textContent = "驗證連結無效或已過期，請回登入頁面重新申請重設密碼。";
  }

  // 點擊「重設密碼」
  document.getElementById("btnReset").addEventListener("click", async () => {
    msg.textContent = "";

    const p1 = document.getElementById("newPwd").value.trim();
    const p2 = document.getElementById("newPwd2").value.trim();

    if (!p1 || !p2) {
      msg.textContent = "請輸入新密碼";
      return;
    }
    if (p1 !== p2) {
      msg.textContent = "兩次密碼不一致";
      return;
    }

    try {
      const { error } = await supabase.auth.updateUser({ password: p1 });
      if (error) throw error;

      msg.className = "ok";
      msg.textContent = "密碼重設成功，請重新登入！";

      setTimeout(() => {
        window.location.href = "/login.html";
      }, 1500);
    } catch (err) {
      msg.textContent = err.message || "操作失敗，請稍後再試。";
    }
  });
</script>

</body>
</html>
