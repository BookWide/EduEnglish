<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>é‡è¨­å¯†ç¢¼ Â· BookWide</title>
  <style>
    :root{ --ink:#0a1020; --muted:#6b7280; --accent:#2563eb; }
    *{box-sizing:border-box} body{margin:0;font-family:ui-sans-serif,system-ui,"Noto Sans TC";color:var(--ink);background:#f6f7fb}
    .wrap{max-width:520px;margin:8vh auto;padding:20px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.06);overflow:hidden}
    .hd{padding:16px 18px;border-bottom:1px solid #eef1f6;font-weight:800}
    .bd{padding:18px}
    .row{display:flex;gap:8px;margin:10px 0;align-items:center}
    .ipt{width:100%;height:44px;border:1px solid #d4d9e3;border-radius:10px;padding:0 12px;font-size:15px}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #d4d9e3;background:#0f172a;color:#fff;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .msg{margin-top:8px}

    /* ğŸ‘ å°çœ¼ç›æŒ‰éˆ• */
    .eye-btn{
      cursor:pointer;
      user-select:none;
      font-size:18px;
      padding:0 8px;
      color:#6b7280;
    }
    .eye-btn:hover{
      color:#111;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="hd" id="title">é‡è¨­å¯†ç¢¼</div>
      <div class="bd">
        <div id="panel-request">
          <div class="muted">è¼¸å…¥ä½ çš„ Emailï¼Œæˆ‘å€‘æœƒå¯„é€ä¸€å°é‡è¨­å¯†ç¢¼çš„é€£çµçµ¦ä½ ã€‚</div>
          <div class="row"><input id="email" type="email" class="ipt" placeholder="Email"></div>
          <div class="row"><button id="btnSend" class="btn">å¯„é€é‡è¨­é€£çµ</button></div>
          <div class="msg" id="msg1"></div>
        </div>

        <div id="panel-update" style="display:none">
          <div class="muted">è«‹è¨­å®šæ–°çš„å¯†ç¢¼ã€‚</div>

          <!-- å¯†ç¢¼ + é¡¯ç¤ºæŒ‰éˆ• -->
          <div class="row">
            <input id="pwd" type="password" class="ipt" placeholder="æ–°å¯†ç¢¼">
            <span class="eye-btn" onclick="togglePwd('pwd', this)">ğŸ‘</span>
          </div>

          <!-- å†æ¬¡è¼¸å…¥å¯†ç¢¼ + é¡¯ç¤ºæŒ‰éˆ• -->
          <div class="row">
            <input id="pwd2" type="password" class="ipt" placeholder="å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼">
            <span class="eye-btn" onclick="togglePwd('pwd2', this)">ğŸ‘</span>
          </div>

          <div class="row"><button id="btnUpdate" class="btn">æ›´æ–°å¯†ç¢¼</button></div>
          <div class="msg" id="msg2"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- é¡¯ç¤º/éš±è—å¯†ç¢¼åŠŸèƒ½ -->
  <script>
    function togglePwd(id, el){
      const input = document.getElementById(id);
      if(input.type === "password"){
        input.type = "text";
        el.textContent = "ğŸ™ˆ";
      }else{
        input.type = "password";
        el.textContent = "ğŸ‘";
      }
    }
  </script>

  <!-- Supabase client -->
  <script type="module" src="./supa.js"></script>
  <script type="module">
    const supa = window.supa;
    const q = new URLSearchParams(location.hash.slice(1));
    const hasToken = q.get('type')==='recovery' && q.get('access_token');

    const title = document.getElementById('title');
    const pReq = document.getElementById('panel-request');
    const pUpd = document.getElementById('panel-update');
    const msg1 = document.getElementById('msg1');
    const msg2 = document.getElementById('msg2');

    const redirect = new URL(location.search, location.href).searchParams.get('redirect') || (location.origin + '/english-videos/');

    function showMsg(el, t, ok=false){ el.style.color = ok?'#065f46':'#b91c1c'; el.textContent=t; }

    if (hasToken) {
      title.textContent = 'è¨­å®šæ–°å¯†ç¢¼';
      pReq.style.display='none'; 
      pUpd.style.display='';
    }

    document.getElementById('btnSend')?.addEventListener('click', async ()=>{
      msg1.textContent='';
      const email = (document.getElementById('email').value||'').trim();
      if(!email){ showMsg(msg1,'è«‹è¼¸å…¥ Email'); return; }
      try{
        const { error } = await supa.auth.resetPasswordForEmail(email, {
          redirectTo: new URL('./reset.html', location.origin + location.pathname).toString()
        });
        if(error) return showMsg(msg1, error.message);
        showMsg(msg1,'å·²å¯„å‡ºé‡è¨­é€£çµï¼ˆè«‹æŸ¥æ”¶ä¿¡ç®±ï¼‰', true);
      }catch(e){ showMsg(msg1, String(e)); }
    });

    document.getElementById('btnUpdate')?.addEventListener('click', async ()=>{
      msg2.textContent='';
      const p1 = document.getElementById('pwd').value;
      const p2 = document.getElementById('pwd2').value;
      if(!p1 || !p2) return showMsg(msg2,'è«‹è¼¸å…¥å…©æ¬¡æ–°å¯†ç¢¼');
      if(p1 !== p2) return showMsg(msg2,'å…©æ¬¡è¼¸å…¥ä¸ä¸€è‡´');

      try{
        const { error } = await supa.auth.updateUser({ password: p1 });
        if(error) return showMsg(msg2, error.message);
        showMsg(msg2,'å·²æ›´æ–°å¯†ç¢¼ï¼Œå°‡è¿”å›é¦–é â€¦', true);
        setTimeout(()=> location.href = redirect, 1200);
      }catch(e){ showMsg(msg2, String(e)); }
    });
  </script>
</body>
</html>


