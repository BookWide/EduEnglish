<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>重設密碼｜BookWide</title>

  <style>
    body{
      margin:0; background:#0b1324; color:#fff;
      font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;
    }
    .wrap{
      max-width:480px; margin:60px auto; padding:20px;
      background:#0f172a; border-radius:18px;
      box-shadow:0 10px 40px rgba(0,0,0,.4);
    }
    h2{ margin-top:0; font-size:28px; }
    .ipt{
      width:100%; padding:14px; border-radius:10px;
      border:1px solid #334155; background:#1e293b; color:#fff;
      margin:12px 0;
      font-size:16px;
    }
    .btn{
      width:100%; padding:14px; border:none; border-radius:12px;
      background:linear-gradient(90deg,#3b82f6,#22c55e);
      color:#fff; font-size:18px; cursor:pointer;
      margin-top:10px;
    }
    .btn:disabled{
      opacity:.6; cursor:not-allowed;
    }
    .err{ color:#f87171; margin-top:12px; }
    .ok{ color:#4ade80; margin-top:12px; }
  </style>
</head>

<body>
<div class="wrap">
  <h2>重設密碼</h2>

  <input id="newPwd" type="password" class="ipt" placeholder="請輸入新密碼">
  <input id="newPwd2" type="password" class="ipt" placeholder="再次確認新密碼">
  <button id="btnReset" class="btn">重設密碼</button>

  <div id="msg" class="err"></div>
</div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  const SUPABASE_URL = "https://jeajrwpmrgczimmrflxo.supabase.co";
  const SUPABASE_ANON_KEY = "你的 anon key 換在這裡"; // ← 換成你自己的

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const msg = document.getElementById("msg");
  const btn = document.getElementById("btnReset");

  // 進頁面先檢查 session 是否存在
  (async () => {
    const { data, error } = await supabase.auth.getSession();

    if (error) {
      console.error("getSession error:", error);
    }

    if (!data || !data.session) {
      // 沒有有效的登入／驗證狀態，無法重設密碼
      msg.textContent = "驗證連結無效或已過期，請回登入頁面重新申請重設密碼。";
      btn.disabled = true;
    }
  })();

  // 點擊「重設密碼」
  btn.addEventListener("click", async () => {
    msg.className = "err";
    msg.textContent = "";

    const p1 = document.getElementById("newPwd").value.trim();
    const p2 = document.getElementById("newPwd2").value.trim();

    if (!p1 || !p2) {
      msg.textContent = "請輸入新密碼";
      return;
    }
    if (p1 !== p2) {
      msg.textContent = "兩次密碼不一致";
      return;
    }

    btn.disabled = true;

    try {
      // 再確認一次 session（避免已過期）
      const { data } = await supabase.auth.getSession();
      if (!data || !data.session) {
        msg.textContent = "驗證連結無效或已過期，請回登入頁面重新申請重設密碼。";
        return;
      }

      const { error } = await supabase.auth.updateUser({ password: p1 });
      if (error) {
        console.error("updateUser error:", error);

        // 針對常見錯誤給友善訊息
        if (
          error.message?.includes("session") ||
          error.message?.toLowerCase().includes("jwt") ||
          error.message?.toLowerCase().includes("token")
        ) {
          msg.textContent = "驗證連結無效或已過期，請回登入頁面重新申請重設密碼。";
        } else {
          msg.textContent = error.message || "操作失敗，請稍後再試。";
        }
        return;
      }

      msg.className = "ok";
      msg.textContent = "密碼重設成功，請重新登入！";

      setTimeout(() => {
        // 回到登入頁（依你之前的需求）
        window.location.href = "https://bookwide.net/index.html?denied=signin";
      }, 1500);
    } catch (err) {
      console.error(err);
      msg.textContent = err.message || "操作失敗，請稍後再試。";
    } finally {
      btn.disabled = false;
    }
  });
</script>

</body>
</html>

