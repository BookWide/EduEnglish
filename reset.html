<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>é‡è¨­å¯†ç¢¼ Â· BookWide</title>
  <style>
    :root{ --ink:#0a1020; --muted:#6b7280; --accent:#2563eb; }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,"Noto Sans TC","Microsoft JhengHei",sans-serif;
      color:var(--ink);
      background:#0b1220;
    }
    .wrap{
      max-width:520px;
      margin:8vh auto;
      padding:20px;
    }
    .card{
      background:#020617;
      border:1px solid #1e293b;
      border-radius:18px;
      box-shadow:0 20px 55px rgba(15,23,42,.9);
      overflow:hidden;
      color:#e5e7eb;
    }
    .hd{
      padding:14px 18px;
      border-bottom:1px solid #1e293b;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:.03em;
    }
    .logo-ball{
      width:30px;height:30px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 20%,#93c5fd 0,#1d4ed8 40%,#020617 100%);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#eff6ff;
      font-weight:900;
      font-size:18px;
      box-shadow:0 0 0 1px rgba(191,219,254,.4);
    }
    .brand-text{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand-main{font-size:17px;}
    .brand-beta{
      font-size:11px;
      color:#9ca3af;
    }
    .pill{
      padding:3px 10px;
      border-radius:999px;
      font-size:11px;
      border:1px solid #4b5563;
      color:#e5e7eb;
      background:rgba(15,23,42,.8);
    }

    .title-row{
      padding:14px 18px 0;
      font-size:20px;
      font-weight:700;
    }

    .bd{
      padding:6px 18px 18px;
      font-size:14px;
      color:#d1d5db;
    }
    .row{
      display:flex;
      gap:8px;
      margin:10px 0;
      align-items:center;
    }
    .ipt{
      width:100%;
      height:44px;
      border:1px solid #1f2937;
      border-radius:10px;
      padding:0 12px;
      font-size:14px;
      background:#020617;
      color:#e5e7eb;
    }
    .ipt::placeholder{color:#6b7280;}
    .btn{
      padding:11px 16px;
      border-radius:999px;
      border:none;
      background:linear-gradient(90deg,#2563eb,#22c55e);
      color:#f9fafb;
      cursor:pointer;
      font-size:14px;
      font-weight:600;
      width:100%;
      text-align:center;
    }
    .btn[disabled]{
      opacity:.45;
      cursor:not-allowed;
    }
    .btn-ghost{
      padding:9px 14px;
      border-radius:999px;
      border:1px solid #4b5563;
      background:transparent;
      color:#e5e7eb;
      cursor:pointer;
      font-size:13px;
    }
    .muted{color:#9ca3af;font-size:13px}
    .msg{margin-top:6px;font-size:13px;min-height:18px}
    a.link{color:#60a5fa;text-decoration:none}
    a.link:hover{text-decoration:underline}

    /* ğŸ‘ å°çœ¼ç›æŒ‰éˆ• */
    .eye-btn{
      cursor:pointer;
      user-select:none;
      font-size:18px;
      padding:0 8px;
      color:#6b7280;
    }
    .eye-btn:hover{
      color:#e5e7eb;
    }

    .foot-note{
      margin-top:10px;
      font-size:12px;
      color:#6b7280;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="hd">
        <div class="brand">
          <div class="logo-ball">B</div>
          <div class="brand-text">
            <div class="brand-main">BookWide</div>
            <div class="brand-beta">Beta</div>
          </div>
        </div>
        <div id="badge" class="pill">ç­‰å¾…é©—è­‰</div>
      </div>

      <div class="title-row" id="title">é‡è¨­å¯†ç¢¼</div>

      <div class="bd">
        <!-- è¼¸å…¥ Email è¦æ±‚å¯„é€é€£çµ -->
        <div id="panel-request">
          <div class="muted">è«‹è¼¸å…¥ç™»å…¥ Emailï¼Œæˆ‘å€‘æœƒå¯„é€ä¸€å°ã€Œé‡è¨­å¯†ç¢¼ã€é€£çµåˆ°ä½ çš„ä¿¡ç®±ã€‚</div>
          <div class="row">
            <input id="email" type="email" class="ipt" placeholder="Email">
          </div>
          <div class="row">
            <button id="btnSend" class="btn">å¯„é€é‡è¨­å¯†ç¢¼é€£çµ</button>
          </div>
          <div class="msg" id="msg1"></div>
        </div>

        <!-- é€£çµæœ‰æ•ˆï¼šè¨­å®šæ–°å¯†ç¢¼ -->
        <div id="panel-update" style="display:none">
          <div class="muted">è«‹è¼¸å…¥æ–°çš„å¯†ç¢¼ä¸¦å†æ¬¡ç¢ºèªã€‚</div>

          <div class="row">
            <input id="pwd" type="password" class="ipt" placeholder="æ–°å¯†ç¢¼">
            <span class="eye-btn" onclick="togglePwd('pwd', this)">ğŸ‘</span>
          </div>

          <div class="row">
            <input id="pwd2" type="password" class="ipt" placeholder="å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼">
            <span class="eye-btn" onclick="togglePwd('pwd2', this)">ğŸ‘</span>
          </div>

          <div class="row">
            <button id="btnUpdate" class="btn">æ›´æ–°å¯†ç¢¼</button>
          </div>
          <div class="msg" id="msg2"></div>

          <div class="foot-note">å¯†ç¢¼æ›´æ–°æˆåŠŸå¾Œï¼Œç³»çµ±æœƒè‡ªå‹•å°å›ç™»å…¥ç•«é¢ã€‚</div>
        </div>

        <!-- é€£çµå¤±æ•ˆ / éæœŸ -->
        <div id="panel-invalid" style="display:none">
          <div class="muted" style="margin-bottom:10px;">
            é©—è­‰é€£çµç„¡æ•ˆæˆ–å·²éæœŸï¼Œè«‹å›ç™»å…¥é é¢é‡æ–°ç”³è«‹é‡è¨­å¯†ç¢¼ã€‚
          </div>
          <div class="row">
            <a href="/index.html?denied=signin" class="btn" style="text-decoration:none;">è¿”å›ç™»å…¥é </a>
          </div>
          <div class="row">
            <button id="btnResendFromInvalid" class="btn-ghost">æ”¹ç”¨å…¶ä»– Email æˆ–é‡æ–°å¯„é€</button>
          </div>
          <div class="msg" id="msg3"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- é¡¯ç¤º/éš±è—å¯†ç¢¼åŠŸèƒ½ -->
  <script>
    function togglePwd(id, el){
      const input = document.getElementById(id);
      if(!input) return;
      if(input.type === "password"){
        input.type = "text";
        el.textContent = "ğŸ™ˆ";
      }else{
        input.type = "password";
        el.textContent = "ğŸ‘";
      }
    }
  </script>

  <!-- Supabase æ•´åˆé‚è¼¯ï¼ˆå·²ä¿®æ­£ Cloudflare æœƒåƒæ‰ hash çš„å•é¡Œï¼‰ -->
  <script type="module">
    import { supabase as supa } from './supa.js';

    const title   = document.getElementById('title');
    const badge   = document.getElementById('badge');
    const pReq    = document.getElementById('panel-request');
    const pUpd    = document.getElementById('panel-update');
    const pInv    = document.getElementById('panel-invalid');
    const msg1    = document.getElementById('msg1');
    const msg2    = document.getElementById('msg2');
    const msg3    = document.getElementById('msg3');

    const redirect =
      new URL(location.search, location.href).searchParams.get('redirect')
      || (location.origin + '/english-videos/');

    function showMsg(el, t, ok=false){
      if(!el) return;
      el.style.color = ok ? '#4ade80' : '#f97373';
      el.textContent = t;
    }

    function showState(state){
      pReq.style.display = state === 'request' ? '' : 'none';
      pUpd.style.display = state === 'update' ? '' : 'none';
      pInv.style.display = state === 'invalid' ? '' : 'none';

      if(state === 'request'){
        badge.textContent = 'è¼¸å…¥ Email';
      }else if(state === 'update'){
        badge.textContent = 'é€£çµæœ‰æ•ˆ';
      }else if(state === 'invalid'){
        badge.textContent = 'Invalid';
      }
    }

    // --- åˆå§‹åŒ–ï¼ˆå®Œæ•´ä¿®æ­£ç‰ˆï¼‰ ---
    (async () => {
      let rawHash = window.location.hash;

      // Cloudflare è½‰å€å¯èƒ½æœƒåƒæ‰ #
      if(!rawHash || rawHash.length < 10){
        const qs = new URLSearchParams(window.location.search);
        const at = qs.get('access_token');
        const tp = qs.get('type');
        if(at && tp){
          rawHash = `#access_token=${at}&type=${tp}`;
        }
      }

      const params = new URLSearchParams(rawHash.replace('#',''));
      const access_token = params.get('access_token');
      const type = params.get('type');

      if(type !== 'recovery' || !access_token){
        title.textContent = 'é‡è¨­å¯†ç¢¼';
        showState('request');
        return;
      }

      // é¡¯ç¤ºã€Œé©—è­‰ä¸­ã€
      title.textContent = 'è¨­å®šæ–°å¯†ç¢¼';
      badge.textContent = 'é©—è­‰ä¸­â€¦';

      try{
        const { error: exErr } = await supa.auth.exchangeCodeForSession(rawHash);
        if(exErr) throw exErr;

        const { data: userData, error: userErr } = await supa.auth.getUser();
        if(userErr || !userData?.user){
          throw userErr || new Error('invalid');
        }

        showState('update');

      }catch(e){
        console.error('[reset] exchange error', e);
        title.textContent = 'é€£çµå·²å¤±æ•ˆ';
        showState('invalid');
      }
    })();

    // --- å¯„é€é‡è¨­é€£çµ ---
    document.getElementById('btnSend')?.addEventListener('click', async () => {
      msg1.textContent = '';
      const email = (document.getElementById('email').value || '').trim();
      if(!email){
        showMsg(msg1, 'è«‹è¼¸å…¥ Email');
        return;
      }
      try{
        const { error } = await supa.auth.resetPasswordForEmail(email, {
          redirectTo: 'https://bookwide.net/reset.html'
        });
        if(error){
          showMsg(msg1, error.message || 'å¯„é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
          return;
        }
        showMsg(msg1, 'å·²å¯„å‡ºé‡è¨­é€£çµï¼ˆè«‹åœ¨ 5 åˆ†é˜å…§é»æ“Šï¼‰', true);
      }catch(e){
        showMsg(msg1, String(e));
      }
    });

    // --- å¾ã€Œé€£çµå¤±æ•ˆã€é‡æ–°å¯„é€ ---
    document.getElementById('btnResendFromInvalid')?.addEventListener('click', () => {
      title.textContent = 'é‡è¨­å¯†ç¢¼';
      showState('request');
      window.location.hash = '';
      msg3.textContent = '';
    });

    // --- æ›´æ–°å¯†ç¢¼ ---
    document.getElementById('btnUpdate')?.addEventListener('click', async () => {
      msg2.textContent = '';
      const p1 = document.getElementById('pwd').value;
      const p2 = document.getElementById('pwd2').value;

      if(!p1 || !p2){
        showMsg(msg2,'è«‹è¼¸å…¥å…©æ¬¡æ–°å¯†ç¢¼');
        return;
      }
      if(p1 !== p2){
        showMsg(msg2,'å…©æ¬¡è¼¸å…¥ä¸ä¸€è‡´');
        return;
      }

      try{
        const { error } = await supa.auth.updateUser({ password: p1 });
        if(error){
          showMsg(msg2,'é©—è­‰é€£çµç„¡æ•ˆæˆ–å·²éæœŸï¼Œè«‹é‡æ–°ç”³è«‹ã€‚');
          return;
        }
        showMsg(msg2,'å¯†ç¢¼æ›´æ–°æˆåŠŸï¼Œå°‡è‡ªå‹•å°å›ç™»å…¥ç•«é¢â€¦', true);
        setTimeout(() => {
          window.location.href = redirect;
        }, 1500);
      }catch(e){
        showMsg(msg2,'æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
      }
    });
  </script>
</body>
</html>













