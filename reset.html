<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>重設密碼｜BookWide</title>
  <style>
    :root{
      --ink:#0f172a;
      --muted:#6b7280;
      --brand:#2563eb;
      --danger:#b91c1c;
      --card-bg:#fff;
      --bg:#f4f6fb;
      --radius:16px;
      --shadow:0 10px 30px rgba(15,23,42,.10);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      background:var(--bg);
      color:var(--ink);
    }
    .wrap{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px 12px;
    }
    .card{
      width:100%;
      max-width:480px;
      background:var(--card-bg);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:24px 22px 28px;
    }
    .logo{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:.5rem;
      margin-bottom:12px;
      font-weight:800;
      font-size:20px;
    }
    .logo span{
      padding:4px 10px;
      border-radius:999px;
      background:rgba(37,99,235,.12);
      color:var(--brand);
      font-size:13px;
      font-weight:600;
    }
    h1{
      margin:0 0 6px;
      font-size:22px;
    }
    .hint{
      margin:0 0 20px;
      font-size:14px;
      color:var(--muted);
    }
    label{
      display:block;
      font-size:14px;
      margin-bottom:6px;
      color:var(--muted);
    }
    .ipt{
      width:100%;
      border-radius:12px;
      border:1px solid #d1d5db;
      padding:10px 12px;
      font-size:15px;
      outline:none;
    }
    .ipt:focus{
      border-color:var(--brand);
      box-shadow:0 0 0 1px rgba(37,99,235,.35);
    }
    .row{margin-bottom:16px;}
    .btn{
      width:100%;
      border-radius:999px;
      border:none;
      padding:11px 14px;
      font-size:15px;
      font-weight:600;
      cursor:pointer;
      background:var(--brand);
      color:#fff;
    }
    .btn[disabled]{
      opacity:.6;
      cursor:default;
    }
    .msg{
      margin-top:12px;
      font-size:14px;
    }
    .msg.ok{color:#047857;}
    .msg.err{color:var(--danger);}
    .link-row{
      margin-top:18px;
      font-size:14px;
      text-align:center;
    }
    .link-row a{
      color:var(--brand);
      text-decoration:none;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="logo">
      <div>BookWide</div><span>Beta</span>
    </div>

    <!-- 模式 A：輸入 email，寄出重設連結 -->
    <section id="step-request">
      <h1>重設密碼</h1>
      <p class="hint">請輸入你的 Email，我們會寄一封「重設密碼」的連結給你。</p>

      <div class="row">
        <label for="reqEmail">Email</label>
        <input id="reqEmail" class="ipt" type="email" autocomplete="email"
               placeholder="you@example.com" />
      </div>

      <button id="btnSend" class="btn">寄送重設連結</button>
      <div id="msgRequest" class="msg"></div>

      <div class="link-row">
        已有帳號？<a href="./login.html">返回登入</a>
      </div>
    </section>

    <!-- 模式 B：從信件進來，直接設定新密碼 -->
    <section id="step-change" style="display:none;">
      <h1>設定新密碼</h1>
      <p class="hint">
        已確認你的身分，請輸入新的密碼。儲存後，之後就用新密碼登入。
      </p>

      <div class="row">
        <label for="newPw1">新密碼</label>
        <input id="newPw1" class="ipt" type="password" autocomplete="new-password" />
      </div>
      <div class="row">
        <label for="newPw2">再輸入一次新密碼</label>
        <input id="newPw2" class="ipt" type="password" autocomplete="new-password" />
      </div>

      <button id="btnSave" class="btn">儲存新密碼</button>
      <div id="msgChange" class="msg"></div>

      <div class="link-row">
        返回 <a href="./login.html">登入頁</a>
      </div>
    </section>
  </div>
</div>

<!-- 先載入 supa.js（Module） -->
<script type="module" src="supa.js"></script>

<!-- 本頁邏輯 -->
<script type="module">
  import { supabase as supa } from './supa.js';

  const params = new URLSearchParams(location.search);
  // 這裡其實不用自己處理 token，Supabase 會在 verify 後幫你建立 session，
  // 我們只要偵測「有沒有 recovery 類型」就切換畫面即可
  const hasRecoveryParam =
    params.get('type') === 'recovery' ||
    params.get('type') === 'rp' ||
    params.has('token') || params.has('code');

  const stepRequest = document.getElementById('step-request');
  const stepChange  = document.getElementById('step-change');

  const iptReqEmail = document.getElementById('reqEmail');
  const btnSend     = document.getElementById('btnSend');
  const msgRequest  = document.getElementById('msgRequest');

  const iptPw1      = document.getElementById('newPw1');
  const iptPw2      = document.getElementById('newPw2');
  const btnSave     = document.getElementById('btnSave');
  const msgChange   = document.getElementById('msgChange');

  // --- 切換 Step 畫面 ---
  if (hasRecoveryParam) {
    stepRequest.style.display = 'none';
    stepChange.style.display  = 'block';
  } else {
    stepRequest.style.display = 'block';
    stepChange.style.display  = 'none';
  }

  // --- Step A：寄出重設信 ---
  btnSend.addEventListener('click', async () => {
    msgRequest.textContent = '';
    msgRequest.className = 'msg';
    const email = iptReqEmail.value.trim();

    if (!email) {
      msgRequest.textContent = '請先輸入 Email。';
      msgRequest.classList.add('err');
      return;
    }

    btnSend.disabled = true;
    try {
      // 不再傳 redirectTo，讓 email 完全由模板控制
      const { error } = await supa.auth.resetPasswordForEmail(email);
      if (error) throw error;
      msgRequest.textContent = '已寄出重設密碼信件，請到信箱收信並依照步驟操作。';
      msgRequest.classList.add('ok');
    } catch (err) {
      console.error(err);
      msgRequest.textContent = '寄送失敗：' + (err.message || err);
      msgRequest.classList.add('err');
    } finally {
      btnSend.disabled = false;
    }
  });

  // --- Step B：儲存新密碼 ---
  btnSave.addEventListener('click', async () => {
    msgChange.textContent = '';
    msgChange.className = 'msg';

    const p1 = iptPw1.value;
    const p2 = iptPw2.value;

    if (!p1 || !p2) {
      msgChange.textContent = '請輸入兩次新密碼。';
      msgChange.classList.add('err');
      return;
    }
    if (p1 !== p2) {
      msgChange.textContent = '兩次輸入的密碼不一致。';
      msgChange.classList.add('err');
      return;
    }

    btnSave.disabled = true;
    try {
      // 這裡需要已存在的 auth session（由信件連結建立）
      const { data: userRes } = await supa.auth.getUser();
      if (!userRes || !userRes.user) {
        msgChange.textContent = '驗證連結已失效或尚未登入，請回登入頁重新申請重設密碼。';
        msgChange.classList.add('err');
        return;
      }

      const { error } = await supa.auth.updateUser({ password: p1 });
      if (error) throw error;

      msgChange.textContent = '密碼已更新，請使用新密碼重新登入。';
      msgChange.classList.add('ok');
    } catch (err) {
      console.error(err);
      msgChange.textContent = '更新失敗：' + (err.message || err);
      msgChange.classList.add('err');
    } finally {
      btnSave.disabled = false;
    }
  });
</script>
</body>
</html>











